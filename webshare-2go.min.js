"use strict";
console.assert || (console.assert = function (e) {
});
var base_image2 = new Image();base_image2.src = "2.3.6.3/img/location.png";
var currentzoom = 0;
var currentradialmenu;

var base_image1 = new Image();base_image1.src = "2.3.6.3/img/flag.png";
var animation_image1 = new Image(); animation_image1.src = "2.3.6.3/img/animation/1.png";
var animation_image2 = new Image(); animation_image2.src = "2.3.6.3/img/animation/2.png";
var animation_image3 = new Image(); animation_image3.src = "2.3.6.3/img/animation/3.png";
var animation_image4 = new Image(); animation_image4.src = "2.3.6.3/img/animation/4.png";
var animation_image5 = new Image(); animation_image5.src = "2.3.6.3/img/animation/5.png";
var animation_image6 = new Image(); animation_image6.src = "2.3.6.3/img/animation/6.png";
var animation_image7 = new Image(); animation_image7.src = "2.3.6.3/img/animation/7.png";
var rootUUID = null;
var popupimage = null;
var linkTo = null;
var chiso = 0;
var numberofannotation = 0;
var indexofcanvas = 0;
var canvasselect = new Array(100);
var canvasselect2 = new Array(100);
var canvastype = new Array(100);
var imageselect = 0;
var checksetcanvas = 0;






var extendFactory = function (prefix) {
        return function (childClazz, parentClazz) {
            var oldPrototype = this[childClazz].prototype;
            if (parentClazz) {
                var namespace = this,
                    oldConstructor = this[childClazz],
                    newConstructor;
                newConstructor = oldConstructor.toString().match(new RegExp("(" + prefix.join("|") + ")." + parentClazz + ".(call|apply)"), "g") ? function () {
                    oldConstructor.apply(this, arguments)
                } : function () {
                    namespace[parentClazz].call(this), oldConstructor.apply(this, arguments)
                }, eval(String(prefix[0] + "." + childClazz + " = " + newConstructor.toString()))
            }
            var definition = {
                instanceOf: {
                    value: function (e) {
                        return this instanceof e
                    },
                    configurable: !1,
                    writable: !0
                },
                hasMixin: {
                    value: function (e) {
                        return !!(this._mixins && this._mixins.indexOf(e) >= 0)
                    },
                    configurable: !1,
                    writable: !0
                }
            };
            Object.keys(oldPrototype).forEach(function (e) {
                definition[e] = {
                    value: oldPrototype[e],
                    configurable: !1,
                    writable: !0
                }
            }), this[childClazz].prototype = Object.create(this[parentClazz] && this[parentClazz].prototype || Object.prototype, definition), this[childClazz].prototype.constructor = this[childClazz]
        }
    },
    defineMixinFactory = function (e) {
        var t = function (e) {
            for (var t = this[e], i = arguments.length, n = 1; i > n; n++) {
                for (var r = arguments[n], o = this[r], a = 0; a < o._mixins.length; a++) t._mixins.indexOf(o._mixins[a]) < 0 && (t._mixins.push(o._mixins[a]), t._mixinNames.push(o._mixinNames[a]));
                for (var s in o) o.hasOwnProperty(s) && 0 !== s.indexOf("_mixin") && void 0 === t[s] && (t[s] = o[s])
            }
        };
        return function (i) {
            var n = this[i];
            for (var r in n) ;
            n._mixinNames = [e[0] + "." + i], n._mixins = [n], arguments.length > 1 && t.apply(this, arguments)
        }
    },
    mixinFactory = function () {
        return function (e, t) {
            var i = this[e],
                n = this[t];
            for (var r in n) n.hasOwnProperty(r) && 0 !== r.indexOf("_mixin") && (n[r] === this.requiredForMixin || void 0 === i.prototype[r] && (i.prototype[r] = n[r]));
            i.prototype._mixins = (i.prototype._mixins || []).filter(function () {
                return !0
            }), i.prototype._mixinNames = (i.prototype._mixinNames || []).filter(function () {
                return !0
            });
            for (var o = 0; o < n._mixins.length; o++) i.prototype._mixins.indexOf(n._mixins[o]) < 0 && (i.prototype._mixins.push(n._mixins[o]), i.prototype._mixinNames.push(n._mixinNames[o]))
        }
    },
    createNamespace = function (e, t, i) {
        var n, r;
        "string" == typeof t ? (n = t, r = i) : "object" == typeof t && (r = t);
        var o = r || window;
        o[e] || (o[e] = Object.create(o[n] || Object.prototype)), o[e]._namespace = e;
        var a = [],
            s = o[e];
        do a.push(s._namespace), s = Object.getPrototypeOf(s); while (s._namespace);
        o[e].extend = extendFactory(a), o[e].defineMixin = defineMixinFactory(a), o[e].requiredForMixin = "required", o[e].mixin = mixinFactory(a)
    };
createNamespace("F"), F.assert = function () {
}, F.assertBoolean = function () {
}, F.assertBooleanIfDefined = function () {
}, F.assertBooleans = function (e) {
    for (var t = 0, i = e.length; i > t; ++t) ;
}, F.assertString = function () {
}, F.assertStringIfDefined = function () {
}, F.assertStrings = function (e) {
    for (var t = 0, i = e.length; i > t; ++t) ;
}, F.assertNumber = function () {
}, F.assertNumberIfDefined = function () {
}, F.assertNumbers = function (e) {
    for (var t = 0, i = e.length; i > t; ++t) ;
}, F.assertNumbersIfDefined = function (e) {
}, F.assertArray = function (e) {
    window.ArrayBuffer && e instanceof ArrayBuffer, window.Uint8Array && e instanceof Uint8Array, window.Int8Array && e instanceof Int8Array, window.Uint16Array && e instanceof Uint16Array, window.Int16Array && e instanceof Int16Array, window.Uint32Array && e instanceof Uint32Array, window.Int32Array && e instanceof Int32Array, window.Float32Array && e instanceof Float32Array, window.Float64Array && e instanceof Float64Array, window.Uint8ClampedArray && e instanceof Uint8ClampedArray
}, F.assertArrayIfDefined = function (e) {
    window.ArrayBuffer && e instanceof ArrayBuffer, window.Uint8Array && e instanceof Uint8Array, window.Int8Array && e instanceof Int8Array, window.Uint16Array && e instanceof Uint16Array, window.Int16Array && e instanceof Int16Array, window.Uint32Array && e instanceof Uint32Array, window.Int32Array && e instanceof Int32Array, window.Float32Array && e instanceof Float32Array, window.Float64Array && e instanceof Float64Array, window.Uint8ClampedArray && e instanceof Uint8ClampedArray
}, F.assertArrays = function (e) {
    for (var t = 0, i = e.length; i > t; ++t) ;
}, F.assertFunction = function () {
}, F.assertFunctionIfDefined = function () {
}, F.assertObject = function () {
}, F.assertObjectIfDefined = function () {
}, F.assertObjects = function (e) {
    for (var t = 0, i = e.length; i > t; ++t) ;
}, F.assertEnum = function () {
}, F.assertEnumIfDefined = function () {
}, F.ServiceContainer = function (e) {
    e ? (this._services = Object.create(e._services), this._serviceInstances = Object.create(e._serviceInstances), this._controllers = Object.create(e._controllers), this._parameters = Object.create(e._parameters), this._auxiliaries = Object.create(e._auxiliaries), this._auxiliaryInstances = Object.create(e._auxiliaryInstances)) : (this._services = {}, this._serviceInstances = {}, this._controllers = {}, this._parameters = {}, this._auxiliaries = {}, this._auxiliaryInstances = {}), this._parameterPattern = /^%(.+)%$/, this._servicePattern = /^@(.+)$/, this._configurations = [], this._phase = F.ServiceContainer.Phase.Define
}, F.ServiceContainer.prototype = {
    get: function (e) {
        var t = this.getAuxiliary(e);
        if (t) return t;
        var i = "?" == e.charAt(0),
            n = i ? e.substring(1) : e;
        if (this._parameterPattern.test(n)) {
            var r = this._parameterPattern.exec(n);
            return this.getParameter(r[1], i)
        }
        return this._servicePattern.test(n) ? this.getService(n.substr(1), i) : void 0
    },
    registerAuxiliary: function (e, t) {
        this._auxiliaries[e] = t
    },
    getAuxiliary: function (e) {
        return this._auxiliaries[e] ? (this._auxiliaryInstances[e] = this._auxiliaryInstances[e] || this._auxiliaries[e](), this._auxiliaryInstances[e]) : !1
    },
    registerController: function (e, t) {
        for (var i = [], n = 2; n < arguments.length; n++) i.push(arguments[n]);
        this._controllers[e] = {
            constructor: t,
            injections: i,
            instances: 0
        }
    },
    redefineController: function (e, t) {
        for (var i = [], n = 2; n < arguments.length; n++) i.push(arguments[n]);
        this._controllers[e].constructor = t, this._controllers[e].injections = i
    },
    getController: function (e) {
        var t = this;
        return function (i) {
            var n = t._controllers[e];
            n.instances++;
            var r = n.injections.map(function (e) {
                return t.get(e)
            });
            r.unshift(i);
            var o = function () {
            };
            o.prototype = n.constructor.prototype;
            var a = new o;
            return n.constructor.apply(a, r), a
        }
    },
    getAngularController: function (e) {
        return ["$scope", this.getController(e)]
    },
    registerParameter: function (e, t) {
        this._parameters[e] = t
    },
    getParameter: function (e) {
        return this._parameters[e]
    },
    registerService: function (e, t) {
        this._services[e] = {
            constructor: t,
            injections: F.sliceArguments(arguments, 2)
        }
    },
    redefineService: function (e, t) {
        this._services[e] = {
            constructor: t,
            injections: F.sliceArguments(arguments, 2)
        }
    },
    getService: function (e) {
        if (this._services[e]) {
            var t = this;
            return this._serviceInstances[e] = this._serviceInstances[e] || function () {
                var i = t._services[e],
                    n = function () {
                    };
                n.prototype = i.constructor.prototype;
                var r = [];
                i.injections.forEach(function (e) {
                    r.push(t.get(e))
                });
                var o = new n;
                return i.constructor.apply(o, r), o
            }(), this._serviceInstances[e]
        }
    },
    getServices: function (e) {
        var t = [],
            i = this,
            n = e || function () {
                return !0
            };
        return angular.forEach(this._services, function (e, r) {
            var o = i.getService(r);
            n(o) && t.push(o)
        }), t
    },
    inject: function () {
        var e = arguments[arguments.length - 1],
            t = F.sliceArguments(arguments, 0, arguments.length - 1);
        return e.apply(this, t.map(F.proxy(this.get, this)))
    },
    config: function () {
        this._configurations.push(arguments), this._phase === F.ServiceContainer.Phase.Run && this.inject.apply(this, arguments)
    },
    init: function () {
        this._phase = F.ServiceContainer.Phase.Init;
        var e = this;
        this._configurations.forEach(function (t) {
            e.inject.apply(e, t)
        }), this._phase = F.ServiceContainer.Phase.Run
    }
}, F.extend("ServiceContainer"), F.ServiceContainer.Phase = {
    Define: 1,
    Init: 2,
    Run: 3
}, F._serviceContainer = new F.ServiceContainer, F.DI = function () {
    return F._serviceContainer
}, F.NOP = function () {
}, F.log = function () {
}, F.handled = function (e) {
    e && (e._handled = !0)
}, F.proxy = function (e, t) {
    return function () {
        return e.apply(t, arguments)
    }
}, F.async = function (e, t) {
    t ? setTimeout(F.proxy(e, t), 0) : setTimeout(e, 0)
}, F.consoleOrMock = window.console || {
    error: function () {
    }
}, F.shipError = function () {
    F.consoleOrMock.error.apply(F.consoleOrMock, arguments)
}, F.unhandledErrors = [], window.onerror = function (e, t, i, n) {
    F.shipError("Uncaught exception:"), F.shipError("Message   : " + e), F.shipError("URL       : " + t + (i ? ":" + i + (n ? ":" + n : "") : ""));
    for (var r = 4; r < arguments.length; r++) F.shipError("Additional info " + r + ":"), F.shipError(arguments[r]);
    F.unhandledErrors.push({
        errorMessage: e,
        url: t,
        lineNumber: i
    })
}, window.Q && (Q.onerror = function (e) {
    if (!e || !e._handled) throw e
}), F.unknownError = new Error("EM_UNKNOWN_ERROR"), F.connectionError = new Error("EM_CONNECTION_ERROR"), angular && (angular.module("f.filter", []), angular.module("f.widget", []), angular.module("f.util", []), angular.module("f.unit", [])), F.findFirst = function (e, t) {
    if ("function" == typeof t) {
        for (var i = 0; i < e.length; i++)
            if (t(e[i])) return e[i]
    } else
        for (var n = 0; n < e.length; n++)
            if (e[n] === t) return e[n]
}, F.findIndex = function (e, t) {
    for (var i = 0; i < e.length; i++)
        if (t(e[i], i)) return i;
    return -1
}, F.removeFirst = function (e, t) {
    if ("function" == typeof t) {
        for (var i = 0; i < e.length; i++)
            if (t(e[i])) return e.splice(i, 1)[0]
    } else
        for (var n = 0; n < e.length; n++)
            if (e[n] === t) return e.splice(n, 1)[0]
}, F.clearArray = function (e) {
    for (; e.length > 0;) e.shift()
}, F.removeAll = function (e, t) {
    if ("function" == typeof t)
        for (var i = 0; i < e.length; i++) t(e[i]) && e.splice(i--, 1);
    else
        for (var n = 0; n < e.length; n++) e[n] === t && e.splice(n--, 1);
    return e
}, F.addUnique = function (e, t) {
    return -1 == e.indexOf(t) ? (e.push(t), !0) : !1
}, F.cloneArray = function (e) {
    return e.filter(function () {
        return !0
    })
}, F.sliceArguments = function (e, t, i) {
    return Array.prototype.slice.call(e, t, i)
}, F.fillArray = function (e, t) {
    for (var i = [], n = 0; e > n; ++n) i.push(t);
    return i
}, F.moveElementInArray = function (e, t, i) {
    e.splice(i, 0, e.splice(t, 1)[0])
}, F.extractComponent = function (e, t, i) {
    for (var n = Math.floor(e.length / i), r = new e.constructor(n), o = t, a = 0; n > a; o += i, a++) r[a] = e[o];
    return r
}, F.sortNumbers = function (e) {
    return e instanceof Array || !e.sort ? Array.prototype.sort.call(e, function (e, t) {
        return e - t
    }) : e.sort()
}, F.isTouch = function () {
    var e = "ontouchstart" in document.documentElement || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
    return function () {
        return e
    }
}(), document.documentElement.className += F.isTouch() ? " f_touch" : " f_noTouch", F.isMobile = function () {
    return /iPhone|iPod|iPad|Android|BlackBerry|arm|touch/i.test(navigator.userAgent)
}, F.getWindowWidth = function () {
    return window.innerWidth
}, F.getWindowHeight = function () {
    return window.innerHeight
}, F.isSmallScreen = function () {
    return window.innerWidth < 919
}, F.isIE = function () {
    var e = navigator.userAgent;
    return /Trident/i.test(e) || /Edge/i.test(e) || /msie/i.test(e)
}, F.ieVersion = function () {
    var e = navigator.userAgent;
    return /Trident\/.*rv:(\d+)\.\d+/i.test(e) || /Edge\/(\d+)\.\d+/i.test(e) || /MSIE (\d+)\.\d+/i.test(e) ? Number(RegExp.$1) : 0
}, F.isMobileSafari = function () {
    return /mobile.*safari|safari.*mobile/i.test(navigator.userAgent)
}, F.supportsFileReader = function () {
    var e;
    return function () {
        if (void 0 === e)
            if (window.FileReader) {
                var t;
                try {
                    t = new FileReader
                } catch (i) {
                }
                e = !!t
            } else e = !1;
        return e
    }
}(), F.getMaxCanvasWidth = function () {
    return F.isMobile && F.isMobile() ? 2048 : 8192
}, F.getMaxCanvasHeight = function () {
    return F.isMobile && F.isMobile() ? 1024 : 8192
}, F.getGLContext = function (e) {
    for (var t, i = ["webgl", "experimental-webgl", "webkit-3d", "moz-webgl"], n = 0; n < i.length; ++n) {
        try {
            t = e.getContext(i[n])
        } catch (r) {
        }
        if (t) break
    }
    return t
}, F.getGLExtension = function (e, t) {
    e._glExt || (e._glExt = {});
    var i = ["", "WEBKIT_", "MOZ_", "MS_", "O_"],
        n = e._glExt;
    return void 0 === n[t] && i.forEach(function (i) {
        n[t] || (n[t] = e.getExtension(i + t))
    }), n[t]
}, F.isWebGlAvailable = function () {
    if (void 0 === F.isWebGlAvailable._webGlAvailable) {
        var e = document.createElement("canvas");
        F.isWebGlAvailable._webGlAvailable = !(!window.WebGLRenderingContext || !F.getGLContext(e))
    }
    return F.isWebGlAvailable._webGlAvailable
}, window.requestAnimationFrame = function () {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function (e) {
        window.setTimeout(e, 1e3 / 60)
    }
}(), F.datestringToDateObj = function (e) {
    var t = e.split(/[- :]/);
    return new Date(t[0], t[1] - 1, t[2], t[3], t[4], t[5])
}, F.parseDateTimeStr = function (e) {
    var t = e.substr(0, 10) + "T" + e.substr(11) + "Z";
    return Date.parse(t)
}, F.ageInDays = function (e, t) {
    var i = F.parseDateTimeStr(e),
        n = t ? t : (new Date).getTime(),
        r = 864e5;
    return (n - i) / r
}, F.getDateOfDateTimeStr = function (e) {
    return e.substr(0, 10)
}, F.isDefaultDate = function (e) {
    return null === e || void 0 === e ? !0 : 0 === e.lastIndexOf("1970-01-01", 0)
}, F.dateToMySQLString = function (e, t) {
    return t ? e.toISOString().slice(0, 10) : e.toISOString().slice(0, 19).replace("T", " ")
}, F.FiniteStateMachine = function (e, t) {
    this._states = e, this._listeners = this.createListenerMap(e), this._state = t, this._meta = {}
}, F.FiniteStateMachine.prototype = {
    read: function (e) {
        var t = this._state;
        if (!this._states[t][e]) throw new Error("Invalid transition input: [" + t + ", " + e + "]");
        var i = this._states[t][e],
            n = this._listeners,
            r = function (n) {
                n(t, e, i)
            };
        n[t]._leave.forEach(r), n[t][e].forEach(r), n._global.forEach(r), this._state = i, n[i]._enter.forEach(r)
    },
    addListener: function (e) {
        var t = this._listeners._global;
        return t.push(e),
            function () {
                F.removeAll(t, function (t) {
                    return t === e
                })
            }
    },
    addEnterListener: function (e, t) {
        var i = this._listeners[e]._enter;
        return i.push(t),
            function () {
                F.removeAll(i, function (e) {
                    return e === t
                })
            }
    },
    addLeaveListener: function (e, t) {
        var i = this._listeners[e]._leave;
        return i.push(t),
            function () {
                F.removeAll(i, function (e) {
                    return e === t
                })
            }
    },
    addInputListener: function (e, t, i) {
        var n = this._listeners[e][t];
        return n.push(i),
            function () {
                F.removeAll(n, function (e) {
                    return e === i
                })
            }
    },
    createListenerMap: function (e) {
        var t = {};
        t._global = [];
        for (var i in e) {
            var n = e[i],
                r = t[i] = {};
            r._enter = [], r._leave = [];
            for (var o in n) r[o] = []
        }
        return t
    },
    validate: function (e) {
        if (!(e instanceof Object)) return !1;
        if (0 === Object.keys(e).length) return !1;
        for (var t in e) {
            if (!(e[t] instanceof Object)) return !1;
            for (var i in e[t]) {
                var n = e[t][i];
                if (!(e[n] instanceof Object)) return !1
            }
        }
        return !0
    }
}, F.extend("FiniteStateMachine"), F.curry = function (e, t, i) {
    var n = Array.prototype.slice,
        r = n.call(arguments, 3);
    return function () {
        var o = n.call(arguments, 0, t - r.length),
            a = i ? o.concat(r) : r.concat(o);
        return e.apply(this, a)
    }
}, F.returns = function (e) {
    return function () {
        return e
    }
}, F.wrapPoint = function (e, t, i, n) {
    var r = i - 1,
        o = n - 1;
    return e >= 0 && r >= e && t >= 0 && o >= t ? [e, t] : e > r && t > o ? F.wrapBottomRight(e, t, i, n) : 0 > e && t > o ? F.wrapBottomLeft(e, t, i, n) : 0 > e && 0 > t ? F.wrapTopLeft(e, t, i) : e > r && 0 > t ? F.wrapTopRight(e, t, i) : e > r && t >= 0 && o >= t ? F.wrapRight(e, t, i) : e >= 0 && r >= e && t > o ? F.wrapBottom(e, t, i, n) : 0 > e && t >= 0 && o >= t ? F.wrapLeft(e, t, i) : e >= 0 && r >= e && 0 > t ? F.wrapTop(e, t, i) : void 0
}, F.wrapLeft = function (e, t, i) {
    return [0 > e ? e + i : e, t]
}, F.wrapRight = function (e, t, i) {
    return [e >= i ? e - i : e, t]
}, F.wrapTop = function (e, t, i) {
    if (0 > t) {
        var n = Math.floor(i / 2),
            r = n > e ? e + n : e - n,
            o = -t - 1;
        return [r, o]
    }
    return [e, t]
}, F.wrapBottom = function (e, t, i, n) {
    if (t >= n) {
        var r = Math.floor(i / 2),
            o = r > e ? e + r : e - r,
            a = n + n - 1 - t;
        return [o, a]
    }
    return [e, t]
}, F.wrapTopLeft = function (e, t, i) {
    var n = F.wrapTop(e, t, i);
    return F.wrapLeft(n[0], n[1], i)
}, F.wrapTopRight = function (e, t, i) {
    var n = F.wrapTop(e, t, i);
    return F.wrapRight(n[0], n[1], i)
}, F.wrapBottomLeft = function (e, t, i, n) {
    var r = F.wrapBottom(e, t, i, n);
    return F.wrapLeft(r[0], r[1], i)
}, F.wrapBottomRight = function (e, t, i, n) {
    var r = F.wrapBottom(e, t, i, n);
    return F.wrapRight(r[0], r[1], i)
}, F.log2 = Math.log2 || function (e) {
    return Math.log(e) / Math.LN2
}, F.log10 = Math.log10 || function (e) {
    return Math.log(e) / Math.LN10
}, F.fmodSigned = function (e, t) {
    if (0 === t) return e;
    var i = e - t * Math.floor(e / t);
    if (t > 0) {
        if (i >= t) return 0;
        if (0 > i) return t + i === t ? 0 : t + i
    } else {
        if (t >= i) return 0;
        if (i > 0) return t + i === t ? 0 : t + i
    }
    return i
}, F.wrapTo_0_2PI = function (e) {
    return F.fmodSigned(e, 2 * Math.PI)
}, F.wrapTo_MinusPI_PI = function (e) {
    return F.fmodSigned(e + Math.PI, 2 * Math.PI) - Math.PI
}, F.wrapTo_Minus05PI_05PI = function (e) {
    return Math.min(Math.PI / 2, Math.max(-Math.PI / 2, e))
}, F.closeToModulo = function (e, t, i, n) {
    var r = ((e - t) % i + i) % i,
        o = i - r;
    return Math.min(r, o) <= n
}, F.closeToAngles = function (e, t, i) {
    var n, r;
    return "number" == typeof i ? (n = i, r = i) : (n = i[0], r = i[1]), F.closeToModulo(e[0], t[0], 2 * Math.PI, n) && F.closeTo(e[1], t[1], r)
}, F.closeTo = function (e, t, i) {
    return void 0 === i && (i = .001), Math.abs(e - t) <= i
}, F.closeToArray = function (e, t, i) {
    var n = e.length;
    if (n !== t.length) return !1;
    void 0 === i && (i = .001);
    for (var r = 0; n > r; ++r)
        if (i < Math.abs(e[r] - t[r])) return !1;
    return !0
}, F.roundDecimal = function (e, t) {
    var i = Math.pow(10, t);
    return Math.round(e * i) / i
}, F.calcQuantilesKd = function (e, t, i) {
    var n, r = e.constructor,
        o = Math.floor(e.length / i),
        a = new Array(t.length);
    for (n = 0; n < t.length; n++) a[n] = new r(i);
    for (var s = 0; i > s; s++) {
        var c = F.extractComponent(e, s, i);
        for (F.sortNumbers(c), n = 0; n < t.length; n++) {
            var l = Math.floor(t[n] * (o - 1));
            a[n][s] = c[l]
        }
    }
    return a
}, F.typeOf = function (e) {
    return null === e ? "null" : e instanceof Array ? "array" : typeof e
}, F.compareJSON = function (e, t) {
    if (F.typeOf(e) !== F.typeOf(t)) return !1;
    switch (F.typeOf(e)) {
        case "object":
            for (var i in e)
                if (!F.compareJSON(e[i], t[i])) return !1;
            for (var n in t)
                if (F.typeOf(e[n]) !== F.typeOf(t[n])) return !1;
            break;
        case "array":
            if (e.length !== t.length) return !1;
            for (var r = 0; r < e.length; r++)
                if (!F.compareJSON(e[r], t[r])) return !1;
            break;
        case "string":
        case "number":
        case "boolean":
            return e === t;
        case "undefined":
        case "null":
            break;
        default:
            return !1
    }
    return !0
}, F.deepAssign = function (e, t, i) {
    t = t.split(".");
    for (var n, r = e, o = 0; o < t.length; o++) n = t[o], o === t.length - 1 ? r[n] = i : r = r[n] = r[n] || {};
    return r
}, F.mergeObjects = function (e) {
    for (var t = 1, i = arguments.length; i > t; t++) {
        var n = arguments[t];
        for (var r in n) n.hasOwnProperty(r) && (e[r] = n[r])
    }
    return e
}, F.findKey = function (e, t) {
    for (var i in e)
        if (e[i] === t) return i
}, F.getFileNameFromPath = function (e) {
    if ("string" == typeof e || e instanceof String) {
        var t = e.lastIndexOf("\\"),
            i = e.lastIndexOf("/"),
            n = Math.max(t, i),
            r = n >= 0 && n !== e.length - 1;
        return r ? e.substr(n + 1) : e
    }
}, F.getExtensionFromPath = function (e) {
    var t = F.getFileNameFromPath(e);
    if (void 0 === t || 0 === t.length) return void 0;
    var i = t.lastIndexOf(".");
    return -1 !== i && i !== t.length - 1 ? t.substring(i + 1) : void 0
}, F.isFolderPath = function (e) {
    if (void 0 === e || 0 === e.length) return !1;
    var t = e[e.length - 1];
    if ("/" === t || "\\" === t) return !0;
    var i = F.getExtensionFromPath(e);
    return void 0 === i ? !0 : !1
}, F.getFolderFromPath = function (e) {
    var t = F.getExtensionFromPath(e);
    if (void 0 === t) return e;
    var i = e.lastIndexOf("\\"),
        n = e.lastIndexOf("/"),
        r = Math.max(i, n);
    return r >= 0 ? e.substr(0, r + 1) : ""
}, F.getUniqueFolderPath = function (e, t) {
    var i, n, r, o = "/" === t[t.length - 1] || "\\" === t[t.length - 1],
        a = 0,
        s = !0;
    for (n = e.map(function (e) {
        return e = F.toUnixPath(e), "/" !== e[e.length - 1] ? e + "/" : e
    }), r = F.toUnixPath(t), r = "/" !== r[r.length - 1] ? r + "/" : r, i = r; n.some(function (e) {
        return 0 === e.indexOf(i)
    });) a++, i = r.slice(0, -1) + a + "/", s = !1;
    return s ? t : o ? t.slice(0, -1) + a + t.slice(-1) : t + a
}, F.toUnixPath = function (e) {
    return e.replace(/\\/g, "/")
}, F.getDriveFromPath = function (e) {
    if ("string" == typeof e || e instanceof String) {
        var t = e.indexOf(":"),
            i = t >= 0;
        return i ? e.substr(0, t + 1) : ""
    }
}, F.generateUUID = function () {
    for (var e = "", t = 0, i = 0; 32 > i; i++) t = 16 * Math.random() | 0, (8 == i || 12 == i || 16 == i || 20 == i) && (e += "-"), e += (12 == i ? 4 : 16 == i ? 3 & t | 8 : t).toString(16);
    return e
}, F.validateNumber = function (e) {
    return isNaN(parseFloat(e)) || !isFinite(e) ? "EM_ONLY_NUMBERS" : void 0
}, F.validateIpV4Address = function (e) {
    var t = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/i;
    return "string" == typeof e && t.test(e) ? void 0 : "FE_IP_ADDRESS_INVALID"
}, F.validatePassword = function (e) {
    if (void 0 === e) return "FE_PW_TOO_SHORT";
    var t = /\d+/,
        i = /(?=\w*[A-Z])/,
        n = /(?=\w*[a-z])/,
        r = /^[\x00-\x7F]*$/;
    return t.test(e) ? i.test(e) ? n.test(e) ? r.test(e) ? e.length < 8 ? "FE_PW_TOO_SHORT" : e.length > 76 ? "FE_PW_TOO_LONG" : void 0 : "FE_PW_ASCII" : "FE_PW_LOWERCASE" : "FE_PW_UPPERCASE" : "FE_PW_NUMBER"
}, F.validateEmail = function () {
    var e = /^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9-]+(\.[a-z0-9-]+)+$/i,
        t = 255;
    return function (i) {
        return "string" == typeof i && e.test(i) ? i.length > t ? "FE_EMAIL_TOO_LONG" : void 0 : "FE_EMAIL_VALID"
    }
}(), F.validateLocation = function (e) {
    var t = /^\-?\d+(\.\d+)?,( )?\-?\d+(\.\d+)?(,( )?\-?\d+(\.\d+)?)?$/;
    if (!e.match(t)) return "FE_LOCATION_WRONG_FORMAT";
    var i = F.locationStringToArray(e);
    return i[0] < -180 || i[0] > 180 || i[1] < -90 || i[1] > 90 ? "FE_LOCATION_INVALID_VALUES" : void 0
}, F.locationArrayToString = function (e) {
    if (!e || e.length < 2) return "";
    var t = F.roundDecimal(e[1], 7) + ", " + F.roundDecimal(e[0], 7);
    return e[2] && (t = t + ", " + F.roundDecimal(e[2], 5)), t
}, F.locationStringToArray = function (e) {
    if ("" === e) return [];
    var t = e.split(","),
        i = [F.roundDecimal(parseFloat(t[1]), 7), F.roundDecimal(parseFloat(t[0]), 7)];
    return t[2] && (i[2] = F.roundDecimal(parseFloat(t[2]), 5)), i
}, F.shortenString = function (e, t, i, n) {
    void 0 === n && (n = "...");
    var r = t - i - n.length + 1;
    if (t < e.length) {
        var o = e.substr(0, i),
            a = e.substr(e.length - r);
        e = o + n + a
    }
    return e
}, F.shortenPath = function (e, t, i, n) {
    void 0 === n && (n = "...");
    var r = Math.min(i, F.getDriveFromPath(e).length) + 1,
        o = t - r - n.length;
    if (t < e.length) {
        var a = e.substr(0, r),
            s = e.substr(e.length - o),
            c = s.indexOf(-1 === s.indexOf("\\") ? "/" : "\\");
        if (-1 !== c) s = s.substr(c), e = a + n + s;
        else {
            var l = e.lastIndexOf(F.getFileNameFromPath(e)),
                h = e.length - l - o + n.length,
                d = e.substr(l - 1, Math.round((e.length - l) / 2) - Math.round(h / 2)),
                u = e.substr(l - 1 + Math.round((e.length - l) / 2) + Math.round(h / 2 + .5));
            e = a + n + d + n + u
        }
    }
    return e
}, F.containsString = function (e, t, i) {
    return e && t ? (e = i ? e : e.toLowerCase(), t = i ? t : t.toLowerCase(), e.indexOf(t) >= 0) : !1
}, F.byteLength = function (e) {
    for (var t = e.length, i = e.length - 1; i >= 0; i--) {
        var n = e.charCodeAt(i);
        n > 127 && 2047 >= n ? t++ : n > 2047 && 65535 >= n && (t += 2), n >= 56320 && 57343 >= n && i--
    }
    return t
}, F.PlugModule = function (e) {
    this._plug = e, this._id = void 0, this._femalePlugFactory = {}, this._malePlugFactory = {}, this._femalePlugs = {}, this._malePlugs = {}, this._triggers = {}, this._connectTriggers = {}, this._connectorService = e
}, F.PlugModule.prototype = {
    connect: function () {
        this._plug.connect.apply(this._plug, arguments)
    },
    getFemalePlug: function (e) {
        var t = this._femalePlugFactory[e]();
        return this._femalePlugs[e].push(t), t
    },
    getMalePlug: function (e) {
        var t = this._malePlugFactory[e]();
        if (this._malePlugs[e].push(t), this._connectTriggers[e])
            for (var i = 0; i < this._connectTriggers[e].length; i++) t.addConnectTrigger(this._connectTriggers[e][i]);
        return t
    },
    returnPlug: function (e) {
        var t = e._identifier;
        e.instanceOf(F.FemalePlug) ? this._femalePlugs[t] = this._femalePlugs[t].filter(function (t) {
            return t !== e
        }) : e.instanceOf(F.MalePlug) && (this._malePlugs[t] = this._malePlugs[t].filter(function (t) {
            return t !== e
        }))
    },
    providesMalePlug: function (e) {
        return this._malePlugFactory[e] ? !0 : !1
    },
    providesFemalePlug: function (e) {
        return this._femalePlugFactory[e] ? !0 : !1
    },
    provideFemalePlug: function (e, t) {
        this._femalePlugFactory[e] || (this._plug.addFemaleProvider(this, e, t), this._femalePlugFactory[e] = F.proxy(function () {
            return new F.FemalePlug(this, e, t)
        }, this), this._femalePlugs[e] = this._femalePlugs[e] || [])
    },
    revokeFemalePlug: function (e) {
        this._plug.removeFemaleProvider(this, e), delete this._femalePlugFactory[e]
    },
    provideMalePlug: function (e, t) {
        if (!this._malePlugFactory[e]) {
            this._plug.addMaleProvider(this, e, t), this._malePlugFactory[e] = F.proxy(function () {
                return new F.MalePlug(this, e, t)
            }, this), this._malePlugs[e] = this._malePlugs[e] || [];
            for (var i = 0; i < t.length; i++) this._triggers[t[i]] = this._triggers[t[i]] || [], this._triggers[t[i]].push(e)
        }
    },
    revokeMalePlug: function (e) {
        this._plug.removeMaleProvider(this, e), delete this._malePlugFactory[e], delete this._connectTriggers[e]
    },
    triggerInternal: function (e, t, i) {
        if (!this._triggers[t]) throw new Error("Event " + t + " is not provided in any male plug");
        F.PageBox.collect();
        for (var n = [], r = 0; r < this._triggers[t].length; r++)
            for (var o = this._triggers[t][r], a = 0; a < this._malePlugs[o].length; a++) {
                var s = this._malePlugs[o][a];
                n.push(s[e].call(s, t, i))
            }
        var c;
        return c = n.length > 0 ? Q.all(n) : Q.resolve(), c.then(function () {
            F.PageBox.commit()
        })
    },
    trigger: function (e, t) {
        return this.triggerInternal("triggerInternal", e, t)
    },
    triggerAndDisconnect: function (e, t) {
        this.triggerInternal("triggerInternalAndDisconnect", e, t)
    },
    triggerAndDestroy: function (e, t) {
        var i = this;
        return this.triggerInternal("triggerInternalAndDisconnect", e, t).then(function () {
            i.destroy()
        })
    },
    addConnectTrigger: function (e, t) {
        this._connectTriggers[e] = this._connectTriggers[e] || [], this._connectTriggers[e].push(t)
    },
    destroy: function () {
        var e;
        for (e in this._femalePlugFactory) this.revokeFemalePlug(e);
        for (e in this._malePlugFactory) this.revokeMalePlug(e);
        for (e in this._malePlugs) this._malePlugs[e].forEach(function (e) {
            e.disconnect()
        }), delete this._malePlugs[e];
        for (e in this._femalePlugs) this._femalePlugs[e].forEach(function (e) {
            e.disconnect()
        }), delete this._femalePlugs[e];
        for (var t in this._triggers) delete this._triggers[t]
    }
}, F.extend("PlugModule"), F.PlugController = function (e, t) {
    F.PlugModule.call(this, t), this._wirePlugs = {}, this._wireControllers = [], this._watches = {}, this.$scope = e, e._ctrl = this, this.autoConnect(e)
}, F.PlugController.prototype = {
    setID: function (e) {
        this._id = e, e && this._plug.registerPlugModule(e, this)
    },
    autoConnect: function (e) {
        if (e) {
            var t = this._plug,
                i = (this._wirePlugs, this._wireControllers),
                n = this;
            this._watches.auto = e.$watch("auto", function (e) {
                for (var r in i) i[r].forEach(function (e) {
                    t.withdrawPlug(e), e.disconnect()
                }), delete i[r];
                if ("string" == typeof e && /^([a-zA-Z0-9]+(,[a-zA-Z0-9]+)*)?$/.test(e)) {
                    var o = e.split(",");
                    for (var a in n._femalePlugFactory)
                        for (var s = n.getFemalePlug(a), c = 0; c < o.length; c++) i[o[c]] = i[o[c]] || [], i[o[c]].push(s), t.placePlug(o[c], s)
                }
            })
        }
    },
    autoDisconnect: function () {
        for (var e in this._watches) this._watches[e](), delete this._watches[e];
        for (var t in this._wirePlugs) {
            var i = this._wirePlugs[t];
            this._plug.withdrawPlug(i);
            var n = i._identifier;
            i.disconnect(), this._femalePlugs[n] = this._femalePlugs[n].filter(function (e) {
                return e !== i
            }), delete this._wirePlugs[t]
        }
        var r = this;
        for (var o in this._wireControllers) this._wireControllers[o].forEach(function (e) {
            r._plug.withdrawPlug(e), e.disconnect()
        }), delete this._wireControllers[o]
    },
    provideFemalePlug: function (e, t) {
        F.PlugModule.prototype.provideFemalePlug.call(this, e, t);
        var i = this;
        for (var n in this._femalePlugFactory) !function () {
            var e = n,
                t = n.toLowerCase();
            i._watches[t] || (i._watches[t] = i.$scope.$watch(t, function (n) {
                if (i._wirePlugs[t] && (i._plug.withdrawPlug(i._wirePlugs[t]), i._wirePlugs[t].disconnect()), "string" == typeof n && /^([a-zA-Z0-9]+(,[a-zA-Z0-9]+)*)?$/.test(n)) {
                    i._wirePlugs[t] = i.getFemalePlug(e);
                    for (var r = n.split(","), o = 0; o < r.length; o++) i._plug.placePlug(r[o], i._wirePlugs[t])
                }
            }))
        }()
    },
    returnPlug: function (e) {
        if (e.instanceOf(F.FemalePlug)) {
            this._plug.withdrawPlug(e);
            var t = e._identifier.toLowerCase();
            this._wirePlugs[t] && delete this._wirePlugs[t];
            for (var i in this._wireControllers) this._wireControllers[i] = this._wireControllers[i].filter(function (t) {
                return t !== e
            })
        }
        F.PlugModule.prototype.returnPlug.call(this, e)
    },
    destroy: function () {
        this.autoDisconnect(), this._id && this._plug.unregisterPlugModule(this._id), F.PlugModule.prototype.destroy.call(this)
    }
}, F.extend("PlugController", "PlugModule"), F.PlugController.createDirective = function (e) {
    var t = {
        link: function (t, i, n) {
            t._ctrl.setID(n.id), t.$on("$destroy", function () {
                t._ctrl.destroy()
            }), e.link && e.link.apply(this, arguments)
        },
        restrict: "E",
        scope: {
            id: "@",
            auto: "@"
        }
    };
    e.controller ? t.controller = e.controller : e.controllerClass && (t.controller = ["$scope", function (t) {
        this.$scope = t, t.ctrl = new e.controllerClass(t)
    }]), e.compile && (t.compile = e.compile), e.templateUrl ? t.templateUrl = e.templateUrl : e.template && (t.template = e.template), e.transclude && (t.transclude = e.transclude), e.replace && (t.replace = e.replace), e.require && (t.require = e.require);
    for (var i in e.scope) t.scope[i] = e.scope[i];
    return t
}, F.PlugDescription = function (e, t) {
    this._identifier = e, this._pins = t, this._maleProviders = [], this._femaleProviders = []
}, F.PlugDescription.prototype = {
    addMaleProvider: function (e) {
        this._maleProviders.push(e)
    },
    removeMaleProvider: function (e) {
        this._maleProviders = this._maleProviders.filter(function (t) {
            return t != e
        })
    },
    addFemaleProvider: function (e) {
        this._femaleProviders.push(e)
    },
    removeFemaleProvider: function (e) {
        this._femaleProviders = this._femaleProviders.filter(function (t) {
            return t != e
        })
    }
}, F.PlugBase = function () {
    this._plugDescriptions = {}, this._plugModules = {}
}, F.PlugBase.prototype = {
    registerPlugModule: function (e, t) {
        if (this._plugModules[e] && this._plugModules[e] !== t) throw new Error("Multiple plug modules with id " + e);
        this._plugModules[e] = t
    },
    unregisterPlugModule: function (e) {
        this._plugModules[e] && delete this._plugModules[e]
    },
    getPlugModule: function (e) {
        if (!this._plugModules[e]) throw new Error("Plug module does not exist " + e);
        return this._plugModules[e]
    },
    addMaleProvider: function (e, t, i) {
        var n = this._plugDescriptions[t];
        if (!n) throw new Error("Plug " + t + " has never been described");
        if (!i) throw new Error("Plug " + t + " provides no pins");
        if (i.sort(), i.length != n._pins.length) throw new Error("Plug " + t + " doesn't match descriptor");
        for (var r = 0; r < i.length; r++)
            if (i[r] != n._pins[r]) throw new Error("Plug " + t + " doesn't match descriptor");
        n.addMaleProvider(e)
    },
    removeMaleProvider: function (e, t) {
        if (t) this._plugDescriptions[t].removeMaleProvider(e);
        else
            for (t in this._plugDescriptions) this._plugDescriptions[t].removeMaleProvider(e)
    },
    addFemaleProvider: function (e, t, i) {
        var n = this._plugDescriptions[t];
        if (!n) throw new Error("Plug " + t + " has never been described");
        if (!i) throw new Error("Plug " + t + " provides no pins");
        if (i.sort(), i.length != n._pins.length) throw new Error("Plug " + t + " doesn't match descriptor");
        for (var r = 0; r < i.length; r++)
            if (i[r] != n._pins[r]) throw new Error("Plug " + t + " doesn't match descriptor");
        for (var o = 0; o < n._pins.length; o++)
            if (!(e[n._pins[o]] && e[n._pins[o]] instanceof Function)) throw new Error("PlugModule doesn't implement descriptor " + t + " - missing pin: " + n._pins[o]);
        n.addFemaleProvider(e)
    },
    removeFemaleProvider: function (e, t) {
        if (t) this._plugDescriptions[t].removeFemaleProvider(e);
        else
            for (t in this._plugDescriptions) this._plugDescriptions[t].removeFemaleProvider(e)
    },
    describe: function (e, t) {
        if (!(t instanceof Array && t.length)) throw new Error("Plug " + e + " has no pins in description");
        if (this._plugDescriptions[e]) {
            var i = this._plugDescriptions[e]._pins;
            if (!F.compareJSON(t, i)) throw new Error("Plug " + e + " is already described: " + t.join(","))
        }
        this._plugDescriptions[e] = new F.PlugDescription(e, t.sort())
    },
    getPlugDescription: function (e) {
        return this._plugDescriptions[e]
    },
    getPlugIdentifiers: function () {
        var e = [];
        for (var t in this._plugDescriptions) e.push(t);
        return e
    }
}, F.extend("PlugBase"), F.PlugConnectorService = function () {
    this._pendingPlugs = {}
}, F.PlugConnectorService.prototype = {
    registerPlugModule: function (e, t) {
        if (F.PlugBase.prototype.registerPlugModule.call(this, e, t), this._pendingPlugs[e]) {
            for (var i = 0; i < this._pendingPlugs[e].length; i++) this.connect(t, this._pendingPlugs[e][i], void 0, !0);
            delete this._pendingPlugs[e]
        }
    },
    connect: function (e, t, i) {
        if (e.instanceOf(F.MalePlug) && t.instanceOf(F.FemalePlug)) this.connectSingle(e, t);
        else if (e.instanceOf(F.FemalePlug) && t.instanceOf(F.MalePlug)) this.connectSingle(t, e);
        else if (e.instanceOf(F.MalePlug) && t.instanceOf(F.PlugModule)) t.providesFemalePlug(e._identifier) && this.connectSingle(e, t.getFemalePlug(e._identifier));
        else if (e.instanceOf(F.FemalePlug) && t.instanceOf(F.PlugModule)) t.providesMalePlug(e._identifier) && this.connectSingle(t.getMalePlug(e._identifier), e);
        else if (e.instanceOf(F.PlugModule) && t.instanceOf(F.Plug)) this.connect(t, e);
        else if (e.instanceOf(F.PlugModule) && t.instanceOf(F.PlugModule)) {
            if (!i || "mf" == i || "bi" == i)
                for (var n in e._malePlugFactory) t.providesFemalePlug(n) && this.connectSingle(e.getMalePlug(n), t.getFemalePlug(n));
            if (!i || "fm" == i || "bi" == i)
                for (var r in t._malePlugFactory) e.providesFemalePlug(r) && this.connectSingle(t.getMalePlug(r), e.getFemalePlug(r))
        }
    },
    connectSingle: function (e, t) {
        if (e._identifier != t._identifier) throw new Error("Plug " + e._identifier + " doesn't fit into " + t._identifier);
        e.connectInternal(t), t.connectInternal(e)
    },
    placePlug: function (e, t) {
        this._plugModules[e] ? this.connect(this._plugModules[e], t) : (this._pendingPlugs[e] = this._pendingPlugs[e] || [], this._pendingPlugs[e].push(t))
    },
    withdrawPlug: function (e) {
        for (var t in this._pendingPlugs) this._pendingPlugs[t] = this._pendingPlugs[t].filter(function (t) {
            return t !== e
        })
    },
    getMalePlugProviders: function (e) {
        return this._plugDescriptions[e]._maleProviders
    },
    getFemalePlugProviders: function (e) {
        return this._plugDescriptions[e]._femaleProviders
    },
    connectWithAll: function (e) {
        var t = this,
            i = e.instanceOf(F.MalePlug) ? this.getFemalePlugProviders(e._identifier) : this.getMalePlugProviders(e._identifier);
        i.forEach(function (i) {
            t.connect(e, i)
        })
    }
}, F.extend("PlugConnectorService", "PlugBase"), F.SelectionService = function () {
    this._selections = {}
}, F.SelectionService.prototype = {
    getSelection: function (e) {
        return this._selections[e]
    },
    registerSelection: function (e, t) {
        this._selections[e] = t
    },
    clearAll: function () {
        angular.forEach(this._selections, function (e) {
            e.clear()
        })
    }
}, F.extend("SelectionService"), F.Plug = function (e, t, i) {
    this._uid = F.Plug.UID++, this._scope = e, this._identifier = t, this._pins = i, this._connectors = []
}, F.Plug.prototype = {
    connect: function (e) {
        F.DI().getService("plug").connect(this, e)
    },
    disconnect: function () {
        this.disconnectInternal()
    },
    connectInternal: function (e) {
        if (!this._scope || !this._identifier) throw new Error("Invalid plug");
        -1 == this._connectors.indexOf(e) && this._connectors.push(e)
    },
    disconnectInternal: function (e) {
        if (e) {
            var t = this._connectors.indexOf(e);
            t > -1 && this._connectors.splice(t, 1)
        } else {
            for (var i = 0; i < this._connectors.length; i++) this._connectors[i].disconnectInternal(this);
            this._connectors = []
        }
        this.isValid() && 0 === this._connectors.length && (this._scope.returnPlug(this), delete this._scope, delete this._identifier)
    },
    isValid: function () {
        return void 0 !== this._scope && void 0 !== this._identifier
    }
}, F.Plug.UID = 0, F.extend("Plug"), F.MalePlug = function (e, t, i) {
    F.Plug.call(this, e, t, i), this._connectTriggers = []
}, F.MalePlug.prototype = {
    addConnectTrigger: function (e) {
        this._connectTriggers.push(e)
    },
    connectInternal: function (e) {
        F.Plug.prototype.connectInternal.call(this, e);
        for (var t = 0; t < this._connectTriggers.length; t++) this._connectTriggers[t].call(this._scope, this._scope, this)
    },
    trigger: function (e, t) {
        return F.PageBox.collect(), this.triggerInternal(e, t).then(function (e) {
            return F.PageBox.commit(), e
        })
    },
    triggerInternal: function (e, t) {
        var i = this,
            n = Q.defer();
        return F.async(function () {
            var r = [];
            i._connectors.forEach(function (i) {
                var n = i[e].apply(i, t);
                Q.isPromise(n) && r.push(n)
            }), r.length > 0 ? Q.allSettled(r).then(function () {
                n.resolve(i)
            }).done() : n.resolve(i)
        }), n.promise
    },
    triggerInternalAndDisconnect: function (e, t) {
        var i = this;
        return this.triggerInternal(e, t).then(function (e) {
            return i.disconnect(), e
        })
    }
}, F.extend("MalePlug", "Plug"), F.FemalePlug = function (e, t, i) {
    F.Plug.call(this, e, t, i);
    for (var n = 0; n < i.length; n++) this[i[n]] = F.proxy(e[i[n]], e)
}, F.extend("FemalePlug", "Plug"), F.Selection = function (e, t, i) {
    F.PlugModule.call(this, i);
    this._identifier = e, this._model = t, this._connectorService.describe(e + "Select", ["select", "unselect"]), this.provideFemalePlug(e + "Select", ["select", "unselect"]), this.provideMalePlug(e + "Select", ["select", "unselect"]), this.addConnectTrigger(e + "Select", function (e, t) {
        var i = this._model.filter(function (e) {
            return e._selected
        });
        i.length > 0 && t.trigger("select", [i, this._identifier])
    })
}, F.Selection.prototype = {
    contains: function (e) {
        return -1 != this._model.indexOf(e)
    },
    hasSelected: function () {
        return this._model.some(function (e) {
            return e._selected
        })
    },
    countSelected: function () {
        return this._model.reduce(function (e, t) {
            return e + t._selected
        }, 0)
    },
    select: function (e) {
        var t = !e._selected;
        e._selected = !0, t && this.trigger("select", [
            [e], this._identifier
        ])
    },
    selectMulti: function (e) {
        var t = [];
        e.forEach(function (e) {
            e._selected || t.push(e), e._selected = !0
        }), t.length > 0 && this.trigger("select", [t, this._identifier])
    },
    setSelection: function (e) {
        var t = [];
        this._model.forEach(function (i) {
            i._selected && -1 == e.indexOf(i) && (i._selected = !1, t.push(i))
        });
        var i = [];
        e.forEach(function (e) {
            e._selected || (e._selected = !0, i.push(e))
        }), t.length > 0 && this.trigger("unselect", [t, this._identifier]), i.length > 0 && this.trigger("select", [i, this._identifier])
    },
    selectAll: function () {
        var e = [];
        this._model.forEach(function (t) {
            t._selected || (t._selected = !0, e.push(t))
        }), e.length > 0 && this.trigger("select", [e, this._identifier])
    },
    unselect: function (e) {
        var t = e._selected;
        e._selected = !1, t && this.trigger("unselect", [
            [e], this._identifier
        ])
    },
    unselectMulti: function (e) {
        var t = [];
        e.forEach(function (e) {
            e._selected && t.push(e), e._selected = !1
        }), t.length > 0 && this.trigger("unselect", [t, this._identifier])
    },
    clear: function () {
        var e = [];
        this._model.forEach(function (t) {
            t._selected && (t._selected = !1, e.push(t))
        }), e.length > 0 && this.trigger("unselect", [e, this._identifier])
    }
}, F.extend("Selection", "PlugModule"), F.Selectable = {
    selection: F.requiredForMixin,
    select: function () {
        this.selection().select(this)
    },
    unselect: function () {
        this.selection().unselect(this)
    },
    toggleSelection: function () {
        this._selected ? this.selection().unselect(this) : this.selection().select(this)
    }
}, F.defineMixin("Selectable"), F.DI().config(function () {
    this.registerService("plug", F.PlugConnectorService), this.registerService("selection", F.SelectionService)
}), F.DI().config("@plug", F.crudConfig = function (e) {
    e.describe("ObjectAdd", ["addObjects"]), e.describe("ObjectUpdate", ["updateObjects"]), e.describe("ObjectRemove", ["removeObjects"]), e.describe("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"])
}), F.DI().config("@plug", F.editConfig = function (e) {
    e.describe("ObjectPick", ["pickObject"]), e.describe("ObjectShow", ["showObjects"]), e.describe("ObjectEdit", ["editObject"]), e.describe("RelationChange", ["addRelation", "removeRelation"])
}), F.DI().config("@plug", F.settingsConfig = function (e) {
    e.describe("SettingsUpdate", ["updateSettings"])
}), angular.module("f.filter").filter("selectionname", function () {
    return function (e) {
        return e ? "FE_SELECTED_" + e.toUpperCase() : void 0
    }
}), F.TaskResult = function (e, t, i, n) {
    this._infos = t || [], this._errors = e || [], this._keepOpen = i || !1, this._errorObjs = n || [], this._followupTask = void 0, this._navigateTo = void 0, this._handover = void 0, this._options = void 0
}, F.extend("TaskResult"), F.TaskContext = function () {
    this.panel = void 0, this.category = void 0, this.task = void 0, this.categories = [], this.activeCategory = void 0, this.activeTask = void 0
}, F.TaskContext.prototype = {
    set: function (e) {
        this.panel != e.panel && (this.panel = e.panel, this.categories = e.categories), this.activeCategory != e.activeCategory && (this.category = e.category, this.activeCategory = e.activeCategory, this.activeTask = void 0), this.task != e.task && (this.task = e.task, this.activeTask = void 0), e.activeTask && (this.activeTask = e.activeTask)
    }
}, F.extend("TaskContext"), F.TaskSeed = function (e, t, i, n, r) {
    this.panel = e, this.category = t, this.task = i, this.handover = n, this.options = r, this.categories = []
}, F.extend("TaskSeed"), F.TaskSection = function (e, t) {
    F.PlugModule.call(this, t);
    var i = this;
    this._id = void 0, this._task = void 0, this._source = void 0, this._index = void 0, this._caption = void 0, this._description = void 0, this._widget = void 0, this._icon = void 0, this._selectPageClass = void 0, this._pageConfiguration = void 0, this._select = void 0, this._selection = void 0, this._resetSelection = void 0, this._selectSingle = !1, this._female = void 0, this._pinBinding = void 0, this._start = void 0, this._complete = !1, this._active = !1, this._canTransitionBackwards = !1, this._alwaysVisible = !1, this._optional = !1, this._activation = 0, this._plugs = [], this._selections = {}, this._hint = void 0, e.compactPanel = !1, this.$scope = e, e.$on("collapseTaskPanel", function (e, t) {
        i.$scope.compactPanel = t
    }), e.openTaskPanel = function () {
        i.$scope.compactPanel && i.$scope.$root.$broadcast("collapseTaskPanel", !1)
    }
}, F.TaskSection.prototype = {
    activate: function () {
        var e = this._pageConfiguration;
        this._selectPageClass ? this._task.selectPageClass(this._selectPageClass, e) : this._task.configurePage(e), this._active || (this._active = !0, this._male && this._trigger && this.activateMalePlug(), this._select ? this.activateSelection() : this._female && this.activateFemale(), this._activation++)
    },
    deactivate: function () {
        this._active = !1, this._male && this.revokeMalePlug(this._male), this._select ? this.deactivateSelection() : this._female && this.revokeFemalePlug(this._female);
        for (var e = 0; e < this._plugs.length; e++) this._plugs[e].disconnect();
        this._plugs = []
    },
    activateMalePlug: function () {
        var e = this._connectorService.getPlugDescription(this._male);
        this.provideMalePlug(this._male, e._pins);
        var t = this.getMalePlug(this._male);
        if (this._connectors) {
            var i = this;
            this._connectors.forEach(function (e) {
                i._connectorService.connect(t, i._connectorService.getPlugModule(e))
            })
        } else this._connectorService.connectWithAll(t);
        this._plugs.push(t);
        var n = this.$scope,
            r = this._trigger[1].map(function (e) {
                return n.$eval(e)
            });
        this.trigger(this._trigger[0], r)
    },
    activateFemale: function () {
        for (var e = this._connectorService.getPlugDescription(this._female), t = /^([a-zA-Z0-9]+)\((.*)\)$/, i = t.exec(this._pinBinding), n = {
            pin: i[1],
            param: i[2].split(",").map(function (e) {
                return e.trim()
            })
        }, r = this.$scope, o = 0; o < e._pins.length; o++) this[e._pins[o]] = e._pins[o] == n.pin ? this[e._pins[o]] || function () {
            var e = arguments;
            r.$apply(function (t) {
                for (var i, r = n.param[0].split("."), o = t, a = 0; a < r.length; a++) i = r[a], a === r.length - 1 ? o[i] = e[0] : o = o[i] = o[i] || {}
            })
        } : this[e._pins[o]] || function () {
        };
        this.provideFemalePlug(this._female, e._pins);
        {
            var a = this.getFemalePlug(this._female);
            this._connectorService.connectWithAll(a)
        }
        this._plugs.push(a)
    },
    prepareSelections: function () {
        for (var e = this._selection.split(","), t = 0; t < e.length; t++) this.$scope.$eval(e[t] + " = []")
    },
    activateSelection: function () {
        for (var e = this._select.split(","), t = this._selection.split(","), i = 0; i < e.length; i++) {
            var n = e[i];
            this._selections[n] || (this._selections[n] = {
                selection: F.DI().getService("selection").getSelection(n),
                target: this.$scope.$eval(t[i])
            }), this._activation ? this._selections[n].selection.setSelection(this._selections[n].target) : this._resetSelection && this._selections[n].selection.setSelection(this._selections[n].target), this.provideFemalePlug(n + "Select", ["select", "unselect"]);
            var r = this.getFemalePlug(n + "Select");
            this._plugs.push(r), this._connectorService.connect(r, this._selections[n].selection)
        }
    },
    deactivateSelection: function () {
        for (; this._plugs.length;) this._plugs[0].disconnect(), this._plugs.shift();
        var e = this._select.split(","),
            t = this;
        e.forEach(function (e) {
            t.revokeFemalePlug(e + "Select")
        })
    },
    compile: function (e) {
        if (this._source = e, this._id = e.id, this._caption = e.caption, this._startCondition = e.startCondition || "true", this._completeCondition = e.completeCondition || "true", this._description = e.description, this._optional = e.optional, this._selectPageClass = e.selectPageClass, this._pageConfiguration = e.pageConfiguration || {}, this._alwaysVisible = e.alwaysVisible, this._canTransitionBackwards = e.canTransitionBackwards || !1, this._pageConfiguration.task = !0, this._select = e.select, this._selection = e.selection, this._selectionEntry = e.selectionEntry, this._selectionIcon = e.selectionIcon, this._selectionIconShow = e.selectionIconShow, this._selectSingle = e.selectSingle, this._resetSelection = e.resetSelection, this._female = e.female, this._male = e.male, this._connectors = e.connectors, this._pinBinding = e.pinBinding, this._trigger = e.trigger, this._widget = e.widget, this._icon = e.iconPath ? e.iconPath : "icons/" + e.icon, this._toolbarWidget = e.toolbarWidget, this._selection && this.prepareSelections(), this._selectionEntry && this._select && this._selection) {
            var t = this._select.split(","),
                i = this._selection.split(","),
                n = this._widget;
            this._widget = this._toolbarWidget || "";
            for (var r = "true", o = 0; o < i.length; o++) this._widget = this._widget + '<selection selection="' + i[o] + '" alerts="alerts" name="' + t[o] + '"' + (this._selectSingle ? ' single="' + r + '"' : "") + ' template="' + this._selectionEntry + '"' + (this._selectionIcon ? ' icon="' + this._selectionIcon + '" iconshow="' + this._selectionIconShow + '"' : "") + "/>", r = r + " && !" + i[o] + ".length";
            this._widget = this._widget + n
        }
    },
    select: function (e, t) {
        var i = this;
        this.$scope.$apply(function () {
            if (i._selections.hasOwnProperty(t))
                for (var n = 0; n < e.length; n++) F.addUnique(i._selections[t].target, e[n]);
            if (1 == i._index && i._selectSingle) {
                var r = 0;
                for (var o in i._selections) r += i._selections[o].target.length;
                r > 1 && i._task.setRepeat()
            }
        })
    },
    unselect: function (e, t) {
        var i = this;
        this.$scope.$apply(function () {
            if (i._selections.hasOwnProperty(t))
                for (var n = 0; n < e.length; n++) F.removeFirst(i._selections[t].target, e[n]);
            if (1 == i._index && i._selectSingle) {
                var r = 0;
                for (var o in i._selections) r += i._selections[o].target.length;
                2 > r && i._task.unsetRepeat()
            }
        })
    }
}, F.extend("TaskSection", "PlugModule"), F.Task = function (e) {
    F.PlugModule.call(this, e), this._description = void 0, this._panel = void 0, this._category = void 0, this._categoryIcon = void 0, this._categoryIconMargin = void 0, this._id = void 0, this._caption = void 0, this._icon = void 0, this._iconMargin = void 0, this._buttonDescription = void 0, this._executeButtonText = void 0, this._sections = void 0, this._activeSection = void 0, this._activeSectionPromise = void 0, this._taskProcessor = void 0, this._executed = !1, this.$scope = void 0, this._defer = Q.defer(), this._argument = {}, this._options = {}, this._result = new F.TaskResult, this.$compile = angular.injector(["ng", "f.task"]).get("$compile"), this._alertService = F.DI().getService("alert")
}, F.Task.prototype = {
    getPromise: function () {
        return this._defer.promise
    },
    setupDescription: function () {
    },
    setup: function () {
    },
    execute: function () {
        return Q.resolve()
    },
    cancel: function () {
    },
    teardown: function () {
    },
    abort: function () {
        return this._result._followupTask = void 0, this.clearSelections(), this.cancel(), this._defer.resolve(), this._defer.promise
    },
    queryTaskLaunch: function () {
        return !1
    },
    setScope: function (e) {
        e.input = {}, this.$scope = e, this.setupDescription(), this.compileDescription();
        var t = this,
            i = this.setupInternal(e);
        Q.isPromise(i) ? i.then(function () {
            t.activateInitialSection(), t.$scope.$apply()
        }).fail(function (e) {
            Q(t._alertService.error(e.message)).then(function () {
                t.abort()
            })
        }) : this.activateInitialSection()
    },
    setupInternal: function (e) {
        return this.setup(e, this._argument)
    },
    executeInternal: function () {
        var e = this,
            t = this.$scope && this.$scope.input;
        this._executed || (this.canBeExecuted() ? (this._executed = !0, this.execute(t).then(function (t) {
            return t instanceof F.TaskResult && (t._infos.forEach(function (t) {
                e._alertService.message(t, F.AlertServiceBase.DELAY_FOREVER)
            }), t._errors.forEach(function (t) {
                e._alertService.error(t)
            }), t._errorObjs.forEach(function (t) {
                e._alertService.errorObj(t)
            }), t._keepOpen) ? (e._executed = !1, void e.$scope.$apply()) : void e._defer.resolve()
        }).fail(function (t) {
            t == F.Task.LOCAL_RECOVERY ? (e._executed = !1, e.$scope.$apply()) : (e._alertService.error(t.message), e._defer.resolve())
        }).done()) : F.async(function () {
            this.setHint("EM_COMPLETE_TASK_STEPS")
        }, this))
    },
    canBeExecuted: function () {
        return !this._description || this._sections && this._sections.every(function (e) {
            return e._complete
        })
    },
    teardownInternal: function () {
        return this.teardown(this._executed, this.getPromise().isFulfilled()), this.clearSelections(), this._result
    },
    clearSelections: function () {
        if (this._sections) {
            var e = [];
            if (this._executed && this._sections.length && this._sections[0]._selectSingle) {
                for (var t = this._sections[0], i = t._select.split(","), n = 0; n < i.length; n++) {
                    var r = t._selections[i[n]];
                    if (r.target.length) {
                        r.selection.unselect(r.target[0]);
                        break
                    }
                }
                e = i
            }
            this._sections.forEach(function (t) {
                if (t._select) {
                    var i = t._select.split(",");
                    i.forEach(function (t) {
                        -1 == e.indexOf(t) && F.DI().getService("selection").getSelection(t).clear()
                    })
                }
            })
        }
    },
    setAttributes: function (e, t, i) {
        this._panel = e, this._category = t, this._id = i.id, this._caption = i.caption, this._categoryIcon = t.iconPath ? t.iconPath : "icons/im/taskbar/" + this._category.id + "/main.png", this._icon = i.iconPath ? i.iconPath : "icons/im/taskbar/" + this._category.id + "/" + i.icon, this._categoryIconMargin = t.iconMargin ? t.iconMargin : !1, this._iconMargin = i.iconMargin ? i.iconMargin : !1
    },
    compileDescription: function () {
        this._sections = [];
        for (var e = 0; e < this._description.length; e++) {
            var t = this._description[e],
                i = new F.TaskSection(this.$scope, this._connectorService);
            i._task = this, i._index = e + 1, i.compile(t), this._sections.push(i)
        }
    },
    activateInitialSection: function () {
        var e = 0,
            t = this._options.taskSection;
        if (t)
            if ("string" === F.typeOf(t)) {
                var i = F.findIndex(this._sections, function (e) {
                    return e._id === t
                });
                -1 !== i && (e = i)
            } else "number" === F.typeOf(t) && (e = this._options.taskSection - 1);
        return this.setActiveSection(this._sections[e])
    },
    getNextSection: function () {
        var e, t, i = this._sections,
            n = this._activeSection,
            r = i.indexOf(n);
        if (0 > r) return void 0;
        for (t = r + 1; t < i.length; t++)
            if (e = i[t], e._start) return e;
        return void 0
    },
    getPreviousSection: function () {
        var e = this._sections.indexOf(this._activeSection);
        if (1 > e) return void 0;
        for (var t = e - 1; t >= 0; --t) {
            var i = this._sections[t];
            if (i._start) return i
        }
        return void 0
    },
    activateNextSection: function () {
        var e = this.getNextSection();
        return e ? this.setActiveSection(e) : Q.reject()
    },
    activatePreviousSection: function () {
        var e = this.getPreviousSection();
        return e ? this.setActiveSection(e) : Q.reject()
    },
    setActiveSection: function (e) {
        var t = this;
        if (!this._activeSectionPromise) {
            var i = this._activeSectionPromise = Q.resolve(),
                n = t._activeSection && t._activeSection !== e;
            return i.then(function () {
                return n ? (t._activeSection.deactivate(), t.onLeave(t._activeSection._index, t._activeSection._id)) : void 0
            }).then(function () {
                return n ? t.onTransition(t._activeSection._index, t._activeSection._id, e._index, e._id) : void 0
            }).then(function () {
                var i = t._activeSection === e;
                return t._activeSection = e, t.$scope.$apply(function () {
                    e.activate()
                }), t.onEnter(e._index, e._id, i)
            }).fail(function (e) {
                Q(t._alertService.error(e.message)).then(function () {
                    t.abort()
                })
            }).fin(function () {
                t._activeSectionPromise = void 0
            })
        }
    },
    onEnter: function () {
    },
    onTransition: function () {
    },
    onLeave: function () {
    },
    getTaskProcessor: function () {
        return this._taskProcessor
    },
    getPageBox: function () {
        return this._taskProcessor ? this._taskProcessor.getPageBox() : void 0
    },
    selectPageClass: function (e, t) {
        this._taskProcessor && this._taskProcessor.trigger("selectPageClass", [e, t])
    },
    configurePage: function (e) {
        this._taskProcessor && this._taskProcessor.trigger("configurePage", [e])
    },
    setHint: function (e, t) {
        var i = this;
        this.$scope && (this.$scope.$apply(function (t) {
            t.hint = e
        }), setTimeout(function () {
            i.$scope.$apply("hint = undefined")
        }, t || 5e3))
    },
    setRepeat: function (e, t) {
        this._result || (this._result = new F.TaskResult), this._result._followupTask = {
            panel: this._panel,
            category: this._category.id,
            task: this._id
        }, e && (this._result._options = e), t && (this._result._handover = t)
    },
    unsetRepeat: function () {
        var e = this._result._followupTask;
        e && this._panel == e.panel && this._category.id == e.category && this._id == e.task && (this._result._followupTask = void 0, this._result._options = void 0, this._result._handover = void 0)
    }
}, F.extend("Task", "PlugModule"), F.Task.LOCAL_RECOVERY = "local_recovery", F.TaskService = function (e) {
    this._taskFactory = {}, this._validators = {}, this._taskCategories = e
}, F.TaskService.prototype = {
    getTaskCategories: function (e) {
        return this._taskCategories[e]
    },
    validate: function (e, t) {
        var i = this,
            n = [];
        return t.reduce(function (t, r) {
            return t.then(function () {
                return i.validateSingle(e, r).then(function (e) {
                    n.push(e)
                }, function () {
                })
            })
        }, Q.resolve()).then(function () {
            return n
        })
    },
    validateSingle: function (e, t) {
        var i = this;
        if (!t[e]) return Q.resolve(t);
        var n = t[e].map(function (e) {
            return i._validators[e]()
        });
        return Q.all(n).then(function (e) {
            if (e.some(function (e) {
                    return "string" == typeof e
                })) {
                var i = new Error;
                throw i.reasons = e.filter(function (e) {
                    return e
                }), i
            }
            return t
        })
    },
    getTaskInstance: function (e, t, i) {
        var n = F.findFirst(this._taskCategories[e], function (e) {
                return e.id == t
            }),
            r = F.findFirst(n.tasks, function (e) {
                return e.id == i
            });
        if (this._taskFactory[e][t] && this._taskFactory[e][t][i]) {
            var o = this._taskFactory[e][t][i],
                a = function () {
                };
            a.prototype = o.task.prototype;
            var s = [];
            o.injections.forEach(function (e) {
                s.push(F.DI().get(e))
            });
            var c = new a;
            return o.task.apply(c, s), c.setAttributes(e, n, r), c
        }
    },
    addCategory: function (e, t, i) {
        if (!(t instanceof Object) || "string" != typeof t.id || "string" != typeof t.caption || "string" != typeof t.iconPath && "string" != typeof t.icon) throw new Error("Invalid description. Must at least contain id, caption, icon.");
        var n = this._taskCategories[e];
        if (!n) throw new Error("Panel does not exist");
        if (t.name = t.caption, t.tasks && !(t.tasks instanceof Array)) throw new Error("Tasks must be an array");
        if (t.tasks = t.tasks || [], i === F.TaskService.FIRST) n.unshift(t);
        else if (i) {
            var r = F.findFirst(n, function (e) {
                return e.id === i
            });
            if (r) {
                var o = n.indexOf(r);
                n.splice(o + 1, 0, t)
            } else n.push(t)
        } else n.push(t)
    },
    addTask: function (e, t, i, n) {
        if (!(i instanceof Object) || "string" != typeof i.id || "string" != typeof i.caption || "string" != typeof i.iconPath && "string" != typeof i.icon) throw new Error("Invalid description. Must at least contain id, caption, icon.");
        if (!this._taskCategories[e]) throw new Error("Panel does not exist");
        var r = this._taskCategories[e],
            o = F.findFirst(r, function (e) {
                return e.id === t
            });
        if (!o) throw new Error("Category " + t + " does not exist in panel " + e);
        if (n === F.TaskService.FIRST) o.tasks.unshift(i);
        else if (n) {
            var a = F.findFirst(o.tasks, function (e) {
                return e.id === n
            });
            if (a) {
                var s = o.tasks.indexOf(a);
                o.tasks.splice(s + 1, 0, i)
            } else o.tasks.push(i)
        } else o.tasks.push(i)
    },
    registerTaskFactory: function (e, t, i, n) {
        this._taskFactory[e] = this._taskFactory[e] || {}, this._taskFactory[e][t] = this._taskFactory[e][t] || {}, this._taskFactory[e][t][i] = {
            task: n,
            injections: F.sliceArguments(arguments, 4)
        }
    },
    taskExists: function (e, t, i) {
        if (!this._taskCategories[e]) return !1;
        var n = this._taskCategories[e],
            r = F.findFirst(n, function (e) {
                return e.id === t
            });
        if (!r) return !1;
        var o = F.findFirst(r.tasks, function (e) {
            return e.id === i
        });
        return !!o
    },
    removeCategory: function (e, t) {
        if (this._taskCategories[e]) {
            var i = this._taskCategories[e];
            F.removeFirst(i, function (e) {
                return e.id === t
            })
        }
    },
    removeTask: function (e, t, i) {
        if (this._taskCategories[e]) {
            var n = this._taskCategories[e],
                r = F.findFirst(n, function (e) {
                    return e.id === t
                });
            r && F.removeFirst(r.tasks, function (e) {
                return e.id === i
            })
        }
    },
    addValidator: function (e, t) {
        this._validators[e] = t
    }
}, F.extend("TaskService"), F.TaskService.FIRST = "_theveryfirst_", F.TaskProcessor = function (e, t, i, n) {
    F.PlugController.call(this, e, i);
    this._task = t, this._url = n, this._context = new F.TaskContext, this._pageBox = void 0, this.provideFemalePlug("TaskLaunch", ["launchTask"]), this.provideMalePlug("PageSelect", ["selectPage", "selectPageClass"]), this.provideMalePlug("PageConfigure", ["configurePage"])
}, F.TaskProcessor.prototype = {
    launchTask: function (e, t, i, n, r) {
        var o = this,
            a = Q.defer(),
            s = r || {},
            c = n || {},
            l = this.getActiveTask();
        return l && l.queryTaskLaunch(e, t, i) ? Q.resolve() : (a.resolve(new F.TaskSeed(e, t, i, c, s)), a.promise.then(function (e) {
            return o.addCategories(e)
        }).then(function (e) {
            return e.category ? o.validateCategory(e) : e
        }).then(function (e) {
            return e.task ? o.validateTask(e).then(function () {
                return o.getTaskInstance(e)
            }) : e
        }).then(function (e) {
            if (e) {
                var t = o.getActiveTask();
                if (t) return t._result._abortedByLaunchTask = !0, t.abort().then(function () {
                    return e
                })
            }
            return e
        }).then(function (e) {
            return e && (o._context.set(e), !s.noNavigation) ? o.switchPage(o._context, e) : void 0
        }, function (e) {
            throw e && e.reasons && o.onError(e.reasons), e
        }))
    },
    getActiveTask: function () {
        return this._context.activeTask
    },
    abortActiveTask: function () {
        var e = this._context.activeTask;
        return e ? e.abort() : Q.resolve()
    },
    onError: function () {
    },
    addCategories: function (e) {
        var t = this._task.getTaskCategories(e.panel);
        return this._task.validate("visible", t).then(function (t) {
            return e.categories = t, e.category = e.category || (t ? t[0].id : void 0), e
        })
    },
    validateCategory: function (e) {
        var t = F.findFirst(e.categories, function (t) {
            return t.id == e.category
        });
        if (!t) throw void 0;
        return this._task.validateSingle("executable", t).then(function () {
            return e.activeCategory = t, e
        })
    },
    validateTask: function (e) {
        var t = F.findFirst(e.activeCategory.tasks, function (t) {
            return t.id == e.task
        });
        if (!t) throw void 0;
        return this._task.validateSingle("executable", t).then(function () {
            return e
        })
    },
    getTaskInstance: function (e) {
        var t = this._task.getTaskInstance(e.panel, e.category, e.task);
        if (!t) {
            var i = new Error;
            throw i.reasons = ["EM_TASK_NOT_IMPLEMENTED"], i
        }
        t._taskProcessor = this, t._argument = e.handover, t._options = e.options;
        var n = this;
        return t.getPromise().done(function () {
            n.onTaskComplete(t)
        }), this.isVisualTask(t) ? (e.activeTask = t, e) : (t.setupInternal(), void t.executeInternal())
    },
    onTaskComplete: function (e) {
        var t = e.teardownInternal();
        this._context.activeTask == e && (this._context.activeTask = void 0), this.handleTaskResult(t)
    },
    switchPage: function (e, t) {
        var i = e.activeCategory,
            n = t.options && t.options.pageConfiguration ? t.options.pageConfiguration : i.pageConfiguration;
        return i ? i.page ? this.trigger("selectPageClass", [i.page, n]) : this.trigger("configurePage", [n]) : Q.resolve()
    },
    isVisualTask: function (e) {
        return !!e._description
    },
    handleTaskResult: function (e) {
        if (e._followupTask) {
            var t = e._followupTask;
            this.launchTask(t.panel, t.category, t.task, e._handover, e._options)
        } else e._navigateTo ? this._url && this._url.navigateTo(e._navigateTo) : e._abortedByLaunchTask || this.launchTask(this._context.panel, this._context.category)
    },
    setPageBoxByID: function (e) {
        this._pageBox = this._plug.getPlugModule(e)
    },
    getPageBox: function () {
        return this._pageBox
    }
}, F.extend("TaskProcessor", "PlugController"), angular.module("f.task", []), F.DI().config(function () {
    this.registerService("task", F.TaskService, "%taskcategories%")
}), F.DI().config("@plug", F.taskConfig = function (e) {
    e.describe("TaskLaunch", ["launchTask"])
}), F.TaskPanel = function (e, t, i, n, r, o) {
    F.TaskProcessor.call(this, e, t, n, o);
    var a = this;
    this._alert = i, this._queryKey = "t", this._lastLaunch = void 0, this.$scope.context = this._context, e.historyViewTask = !1, e.compactPanel = !1, e.launchTask = F.proxy(this.launchTask, this), e.$on("collapseTaskPanel", function (t, i) {
        e.compactPanel = i, void 0 !== a._lastLaunch && (a._lastLaunch.m = i ? "f" : "t", a.updateURL(!0))
    }), e.$watch("pagebox", function (e) {
        e && a.setPageBoxByID(e)
    }), this.provideFemalePlug("URLChange", ["setFragment", "applyURL"]), this.connect(this, o), r && (this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.connect(this, r))
}, F.TaskPanel.prototype = {
    onError: function (e) {
        var t = this;
        e.forEach(function (e) {
            t._alert.error(e, F.AlertServiceBase.DELAY_SHORT)
        })
    },
    login: function () {
        if (this._lastLaunch) {
            var e = this._lastLaunch;
            this.launchTask(e.p, e.c, void 0, void 0, {
                noNavigation: !0
            }).fail(function () {
            }).done()
        }
    },
    logout: function () {
        this.launchTask("default")
    },
    updateAccount: function () {
    },
    launchTask: function (e, t, i, n, r) {
        var o = this;
        this._lastLaunch = {
            p: e
        }, t && (this._lastLaunch.c = t), this._lastLaunch.m = this.$scope.compactPanel ? "f" : "t", this._url.collect();
        var a = n || {};
        a._lastPage = this._url.$location.url();
        var s = r || {},
            c = [e, t, i, a, s];
        return F.TaskProcessor.prototype.launchTask.apply(this, c).then(function () {
            o.$scope.$root.$broadcast("launchTask", e, t, i), o._context.activeTask && (o.$scope.$root.$broadcast("collapseTaskPanel", !1), o._context.activeTask.getPromise().done(function () {
                o.updateURL()
            })), o.$scope.$apply(), o.updateURL()
        }).fin(function () {
            o._url.commit()
        })
    },
    updateURL: function (e) {
        this._lastLaunch && this._url.setFragment(this._queryKey, this._url.encode(this._lastLaunch), ["v"], e)
    },
    setFragment: function (e) {
        e.isUnresolved(this._queryKey) && e.resolve(this._queryKey, e.get(this._queryKey).query, ["v"])
    },
    applyURL: function (e, t) {
        if (e == this._queryKey) {
            var i = t.get(e),
                n = this._url.decode(i.query),
                r = this;
            this.launchTask(n.p, n.c, void 0, void 0, {
                noNavigation: !0
            }).fail(function () {
                r._lastLaunch = n
            }).done(), n.m && this.$scope.$root.$broadcast("collapseTaskPanel", "f" == n.m)
        }
    },
    handleTaskResult: function (e) {
        F.TaskProcessor.prototype.handleTaskResult.call(this, e), this.$scope && this.$scope.$apply()
    }
}, F.extend("TaskPanel", "TaskProcessor"), F.DI().registerController("taskpanel", F.TaskPanel, "@task", "@alert", "@plug", "?@login", "@url"), angular.module("f.task").directive("taskpanel", function () {
    return F.PlugController.createDirective({
        controllerClass: F.DI().getController("taskpanel"),
        link: function (e) {
            e.$watch("context.activeCategory", function (t, i) {
                if (e.historyViewTask = !1, i && e.context.categories.some(function (e) {
                        return e == i
                    })) {
                    var n = "#collapse" + i.id;
                    $(n).collapse("hide")
                }
                if (t) {
                    var r = "#collapse" + t.id;
                    $(r).collapse("show")
                }
            }), e.$watch("context.activeTask", function (t) {
                e.historyViewTask = void 0 !== t
            })
        },
        scope: {
            pagebox: "@"
        },
        transclude: !0,
        templateUrl: F.partialUrl("taskpanel.html")
    })
}), angular.module("f.task").directive("taskcontent", function () {
    return {
        controller: ["$scope", function (e) {
            e.$watch("task", function (t) {
                t && t.setScope(e)
            })
        }],
        restrict: "E",
        require: "^taskpanel",
        scope: {
            task: "="
        },
        templateUrl: F.partialUrl("taskcontent.html")
    }
}), angular.module("f.task").directive("widget", ["$compile", function (e) {
    return {
        link: function (t, i) {
            i.find("div").append(e(t.section._widget)(t));
            var n = t.section,
                r = n._startCondition;
            if (0 === r.indexOf("#")) {
                var o = r.substring(1),
                    a = !1;
                r = "true", t.task._sections.forEach(function (e) {
                    e._id === o && (r = e._completeCondition, a = !0)
                })
            }
            t.$watch(r, function (e) {
                n._start = !!e, n._complete = !n._start || !!t.$eval(n._completeCondition)
            }), t.$watch(n._completeCondition, function (e) {
                n._start = !!t.$eval(r), n._complete = !n._start || !!e
            })
        },
        scope: !1,
        restrict: "E",
        require: "^taskcontent",
        template: '<div style="padding: 5px 0px"></div>'
    }
}]), angular.module("f.task").directive("selection", ["$compile", function (e) {
    return {
        restrict: "E",
        compile: function (t, i) {
            var n = '<span class="f_breakAll" ng-class="{ f_textBold:(single && $index == 0), f_textItalic:(single && $index == 0), f_textInactive:(single === false || (single && $index != 0)) }" ng-bind-template="' + i.template + '"></span>';
            i.icon && (n += "<img" + (i.iconshow ? ' ng-if="' + i.iconshow + '"' : "") + ' class="f_icon24" static-src="' + i.icon + '"/>');
            var r = '<div class="col-xs-10" style="min-height:26px; padding-top:2px;"><table><tr><td><img class="f_icon20" static-src="icons/bulletpoint.png"/></td><td>' + n + '</td></tr></table></div><div class="col-xs-2"><button ng-click="entry.unselect()" class="btn btn-default" style="height:25px; width: 25px; padding:0;" title="{{\'FE_REMOVE\' | i18n}} {{entry._displayName}}"><img class="f_icon24" static-src="icons/remove.png"/></button></div>',
                o = '<alert type="warning" ng-show="hasAlert(name, entry)" class="f_taskSelAlert">{{alertText(name, entry)}}</alert>',
                a = '<div ng-show="selection.length > 0"><b>{{ name | selectionname | i18n}}</b><div class="container-fluid" style="padding-left:0px;"><div ng-if="selection.length > collapseThresh && !hasAlerts(name)"><div ng-show="single" class="row" ng-repeat="entry in [selection[0]]" style="margin-bottom:2px;">' + r + o + '</div><div class="row" style="margin-bottom:2px;"><div class="col-xs-10" style="min-height:26px; padding-top:2px;"><table><tr><td><img class="f_icon20" static-src="icons/bulletpoint.png"/></td><td>[{{selection.length - (single ? 1 : 0)}} {{(single ? "FE_MORE_OBJS" : "FE_OBJS") | i18n}}]</td></tr></table></div><div class="col-xs-2"><button ng-click="unselectCollapsed()" class="btn btn-default" style="height:25px; width: 25px; padding:0;" title="{{\'FE_REMOVE\' | i18n}}"><img class="f_icon24" static-src="icons/remove.png"/></button></div></div></div><div ng-if="selection.length <= collapseThresh || hasAlerts(name)"><div class="row" ng-repeat="entry in selection" style="margin-bottom:2px;">' + r + o + "</div></div></div></div>";
            return function (t, i, n) {
                i.append(e(a)(t)), t.$parent.$watch(n.single, function (e) {
                    void 0 !== e && (t.single = !!e)
                }), t.collapseThresh = F.DI().getParameter("selectionCollapseThresh", !0) || Number.MAX_VALUE, t.unselectCollapsed = function () {
                    var e = t.selection[0].selection();
                    t.single ? e.unselectMulti(t.selection.slice(1)) : e.clear()
                }, t.hasAlerts = function (e) {
                    return t.alerts && t.alerts[e] && 0 < Object.keys(t.alerts[e]).length
                }, t.hasAlert = function (e, i) {
                    return t.alerts && t.alerts[e] && t.alerts[e][i.getID()]
                }, t.alertText = function (e, i) {
                    return t.alerts && t.alerts[e] && t.alerts[e][i.getID()] ? t.alerts[e][i.getID()] : ""
                }
            }
        },
        scope: {
            selection: "=",
            name: "@",
            alerts: "="
        }
    }
}]), angular.module("f.task").directive("tasktoolbar", function () {
    return {
        restrict: "E",
        scope: {
            model: "=",
            onchange: "&",
            visibility: "="
        },
        link: function (e, t, i) {
            var n = F.DI().getParameter(i.toolbar);
            e.tools = n.tools, e.text = n.text, e.click = function (t) {
                e.model = t, F.async(function () {
                    e.$apply(function () {
                        e.onchange({
                            value: t
                        })
                    })
                })
            }
        },
        template: '<p ng-if="text">{{text | i18n}}</p><p class="btn-group f_taskToolbar"><button ng-repeat="tool in tools" ng-if="(visibility && visibility[tool.id] !== undefined) ? visibility[tool.id] : tool.showDefault" class="btn btn-default f_taskToolbarBtn" ng-class="{\'btn-info\': model==tool.id}" ng-click="click(tool.id)"><img class="f_icon24" static-src="icons/{{tool.icon}}"></button></p>'
    }
}), angular.module("f.task").directive("edit", function () {
    return {
        link: function (e, t, i) {
            e.$watch("source", function (t, i) {
                e.target = t, t !== i && e.onChange(void 0 !== e.target ? e.target : "")
            }), e.onChange = function (t) {
                i.validation && e.$parent[i.validation] && (e.error = e.$parent[i.validation](t))
            }, e.onNgChange = function (t) {
                e.onChange(t), i.userchange && e.$parent[i.userchange] && e.$parent[i.userchange](t)
            }
        },
        restrict: "E",
        scope: {
            source: "=",
            target: "=",
            placeholder: "@",
            disabled: "="
        },
        template: '<input type="text" class="form-control" ng-model="target" ng-disabled="disabled" ng-change="onNgChange(target)" placeholder="{{placeholder}}"/><div class="f_textBold f_textError">{{error | i18n}}</div>'
    }
}), angular.module("f.task").directive("editarea", function () {
    return {
        link: function (e, t, i) {
            e.$watch("source", function (t, i) {
                e.target = t, t !== i && e.onChange(e.target || "")
            }), e.onChange = function (t) {
                i.validation && e.$parent[i.validation] && (e.error = e.$parent[i.validation](t))
            }
        },
        restrict: "E",
        scope: {
            source: "=",
            target: "=",
            placeholder: "@"
        },
        template: '<div><textarea class="form-control" rows="3" style="resize: none;" ng-model="target" ng-change="onChange(target)"></textarea><div class="f_textBold f_textError">{{error | i18n}}</div></div>'
    }
}), angular.module("f.task").directive("checkbox", function () {
    return {
        link: function (e) {
            e.$watch("source", function (t) {
                e.target = t
            }), e.onClick = function () {
                e.target = !e.target
            }
        },
        restrict: "E",
        scope: {
            source: "=",
            target: "=",
            name: "@"
        },
        template: '<div ng-click="onClick()" style="cursor:pointer"><div style="display:inline-block;vertical-align: top;width:48px"><img class="f_icon48"  ng-src="' + F.imgUrl("icons/im/selected_{{target == true}}.png") + '"/></div><div style="display:inline-block;width:170px;vertical-align: top;padding-top:12px;"><div><p class="f_textM">{{name}}</p></div></div></div>'
    }
}), angular.module("f.task").directive("radio", function () {
    return {
        link: function (e) {
            e.onClick = function (t) {
                t == e.selected || e.options[t].disabled && void 0 !== e.options[t].disabled() || (e.selected = t, e.change({
                    key: t
                }))
            }
        },
        restrict: "E",
        scope: {
            options: "=",
            selected: "=",
            change: "&"
        },
        template: '<div ng-repeat="(key, value) in options" class="f_radio" ng-class="{ f_radioDisabled: value.disabled && value.disabled() }" ng-click="onClick(key)" title="{{ value.disabled() | i18n }}"><img class="f_icon32" ng-src="' + F.imgUrl("icons/im/radio_{{ key == selected }}.png") + '"/><span class="f_textM">{{ (value.label ? value.label : value) | i18n }}</span></div>'
    }
}), F.URLService = function (e, t, i, n, r) {
    F.PlugModule.call(this, e);
    var o = this;
    this.$location = t, this.$rootScope = i, this._defaultURL = r, this._timeout = 3e3, this._root = n, this._fragments = new F.Query, this._resolve = void 0, this._delay = 0, i.$on("$locationChangeStart", function (e) {
        o._delay && e.preventDefault()
    }), i.$on("$locationChangeSuccess", function (e, t) {
        o.navigateTo(t)
    }), this.provideMalePlug("URLChange", ["setFragment", "applyURL"]), this.addConnectTrigger("URLChange", function (e, t) {
        e._resolve && t.trigger("setFragment", [e._resolve])
    })
}, F.URLService.prototype = {
    navigateTo: function (e, t) {
        var i = new F.Query(this.isQuery(e) ? e : this._defaultURL);
        if (!i.equals(this._fragments)) {
            this._resolve = i, this.trigger("setFragment", [i]);
            var n = this;
            i.subscribe("change", function () {
                n.trigger("setFragment", [i])
            }), i.subscribe("allResolved", function () {
                if (n._resolve == i) {
                    n._resolve = void 0;
                    var e = i.getResolutionOrder();
                    e.forEach(function (e) {
                        n.trigger("applyURL", [e, i])
                    }), n._fragments.apply(i), n.updateURL(t)
                }
            })
        }
    },
    setFragment: function (e, t, i, n) {
        this._fragments.set(e, t, i), this.updateURL(n)
    },
    getFragment: function (e) {
        var t = this._fragments.get(e);
        return t ? t.query : void 0
    },
    collect: function () {
        this._delay++
    },
    commit: function () {
        this._delay = Math.max(0, this._delay - 1), this.updateURL()
    },
    encode: function (e) {
        return Object.keys(e).map(function (t) {
            var i = (e[t] + "").replace(/,/g, ",,");
            return t + (i ? ":" + i : "")
        }).join(",")
    },
    decode: function (e) {
        return e = e.replace(/,,/g, "&"), e.split(",").reduce(function (e, t) {
            var i = t.split(":");
            if (i.length <= 2 && "" !== i[0]) {
                var n = i[1] || "";
                e[i[0]] = n.replace(/&/g, ",")
            }
            return e
        }, {})
    },
    updateURL: function (e) {
        if (!this._delay) {
            var t = this._fragments.toQuery(this._root);
            this.isEmpty(t) || this.isCurrent(t) || (e ? this.$location.search(t).replace() : this.$location.search(t), F.async(this.$rootScope.$apply, this.$rootScope))
        }
    },
    isQuery: function (e) {
        return -1 != e.indexOf("?")
    },
    isEmpty: function (e) {
        return 0 === Object.keys(e).length
    },
    isCurrent: function (e) {
        var t = this.$location.search(),
            i = Object.keys(e);
        return Object.keys(t).length == i.length && i.every(function (i) {
            return t[i] == e[i]
        })
    }
}, F.extend("URLService", "PlugModule"), F.Query = function (e) {
    this._fragments = {}, this._listeners = {}, e && this.parseQuery(e)
}, F.Query.prototype = {
    set: function (e, t, i) {
        this._fragments[e] = {
            query: t || "",
            dependencies: i || [],
            resolved: !1
        }
    },
    get: function (e) {
        return this._fragments[e]
    },
    toQuery: function (e) {
        for (var t = F.cloneArray(e), i = {}; t.length > 0;) {
            var n = t.shift(),
                r = this.get(n);
            if (!r) return {};
            i[n] = r.query, r.dependencies.forEach(function (e) {
                t.push(e)
            })
        }
        return i
    },
    toString: function (e) {
        var t = this.toQuery(e);
        return Object.keys(t).map(function (e) {
            return e + "=" + t[e]
        }).join("&")
    },
    parseQuery: function (e) {
        this._fragments = {};
        var t = e.substring(Math.max(e.indexOf("?") + 1, 0), e.length),
            i = this;
        t.split("&").forEach(function (e) {
            var t = e.split("=");
            i.set(t[0], t[1] || "")
        })
    },
    resolve: function (e, t, i) {
        if (this._fragments[e] && !this._fragments[e].resolved) {
            this._fragments[e].query = t || "", this._fragments[e].dependencies = F.removeAll(i || [], ""), this._fragments[e].resolved = !0;
            var n = this,
                r = !1;
            this._fragments[e].dependencies.forEach(function (e) {
                n._fragments[e] || (n.set(e, ""), r = !0)
            }), r && this.notify("change"), this.allResolved() && this.notify("allResolved")
        }
    },
    isUnresolved: function (e) {
        return e && this._fragments[e] && !this._fragments[e].resolved
    },
    allResolved: function () {
        var e = this;
        return Object.keys(this._fragments).every(function (t) {
            return e._fragments[t].resolved
        })
    },
    getResolutionOrder: function () {
        var e = this,
            t = Object.keys(this._fragments);
        t.forEach(function (t) {
            e._fragments[t].temp = F.cloneArray(e._fragments[t].dependencies)
        });
        for (var i = []; t.some(function (t) {
            return e._fragments[t].temp
        });) {
            var n = F.removeFirst(t, function (t) {
                return 0 === e._fragments[t].temp.length
            });
            if (!n) return;
            delete e._fragments[n].temp, t.forEach(function (t) {
                F.removeAll(e._fragments[t].temp, n)
            }), i.push(n)
        }
        return i
    },
    equals: function (e) {
        var t = this;
        return Object.keys(this._fragments).every(function (i) {
            return e._fragments[i] && t._fragments[i].query == e._fragments[i].query
        })
    },
    apply: function (e) {
        var t = this;
        Object.keys(e._fragments).forEach(function (i) {
            t._fragments[i] = e._fragments[i]
        })
    },
    subscribe: function (e, t) {
        this._listeners[e] ? this._listeners[e].push(t) : this._listeners[e] = [t]
    },
    notify: function (e) {
        this._listeners[e] && this._listeners[e].forEach(function (e) {
            e.call(this)
        })
    }
}, F.extend("Query"), F.DI().registerService("url", F.URLService, "@plug", "$location", "$rootScope", "%URLroots%", "%defaultURL%"), F.DI().config("@plug", F.routeConfig = function (e) {
    e.describe("URLChange", ["setFragment", "applyURL"])
}), F.Embeddable = function (e, t, i) {
    F.PlugController.call(this, e, t);
    var n = this;
    this._url = i, this._id = void 0, this._visible = !1, this._embeddedModules = [], this._page = void 0, this._configuration = void 0, e.miniView = !1, e.trigger = F.proxy(this.trigger, this), e.$on("addEmbeddedModule", function (e, t) {
        t != n && (e.stopPropagation(), n.addModule(t))
    }), e.$on("removeEmbeddedModule", function (e, t) {
        t != n && (e.stopPropagation(), n.removeModule(t))
    }), e.$on("$destroy", function () {
        e.$emit("removeEmbeddedModule", n)
    }), this.provideFemalePlug("URLChange", ["setFragment", "applyURL"]), this.connect(this, this._url)
}, F.Embeddable.prototype = {
    visible: function (e) {
        return void 0 !== e && (this.$scope.visible = e), this.$scope.visible
    },
    miniView: function () {
        return this.$scope.miniView
    },
    setMiniView: function (e, t) {
        return this.$scope.miniView = e, Q.all(this._embeddedModules.map(function (i) {
            return Q.try(i.setMiniView.bind(i, e, t))
        }))
    },
    preparePageChange: function (e) {
        return this._embeddedModules.reduce(function (t, i) {
            return i.preparePageChange(e) || t
        }, !1)
    },
    changePage: function (e) {
        var t = this.getPage();
        t && t.changePage(e)
    },
    setID: function (e) {
        F.PlugController.prototype.setID.call(this, e), this.$scope.$emit("addEmbeddedModule", this), e && this.updateURL()
    },
    updateURL: function (e) {
        var t = this._embeddedModules.map(function (e) {
            return e._id
        });
        this._url.setFragment(this._id, t.join(","), F.cloneArray(t), e)
    },
    setFragment: function (e) {
        if (e.isUnresolved(this._id)) {
            var t = e.get(this._id);
            e.resolve(this._id, t.query, t.query.split(","))
        }
    },
    applyURL: function () {
    },
    addModule: function (e) {
        e._page = this.getPage(), F.addUnique(this._embeddedModules, e), e._page.$scope.visible ? (e.onConfigure && e.onConfigure(this._configuration), e.onShow && e.onShow()) : e.onHide && e.onHide(), this.updateURL()
    },
    removeModule: function (e) {
        this.getPage().$scope.visible && e.onHide && e.onHide(), F.removeFirst(this._embeddedModules, e), e._page = void 0, this.updateURL()
    },
    onShow: function () {
        this._visible = !0, this.$scope.visible = !0, this._embeddedModules.forEach(function (e) {
            e.onShow && e.onShow()
        })
    },
    onHide: function () {
        this._visible = !1, this.$scope.visible = !1, this._embeddedModules.forEach(function (e) {
            e.onHide && e.onHide()
        })
    },
    onConfigure: function (e) {
        this._configuration = e, this._embeddedModules.forEach(function (t) {
            t.onConfigure && t.onConfigure(e)
        })
    },
    getPage: function () {
        return this._page
    },
    getPageBox: function () {
        var e = this.getPage();
        return e ? e.getPageBox() : void 0
    },
    isTaskActive: function () {
        var e = this.getPageBox();
        return e ? e.isTaskActive() : !1
    },
    selectPageClass: function (e, t) {
        var i = this.getPageBox(),
            n = Q.defer();
        return i ? F.async(function () {
            i.selectPageClass(e, t).then(function () {
                n.resolve()
            }).done()
        }) : n.resolve(), n.promise
    },
    launchTask: function (e, t, i, n, r) {
        var o = this.getPageBox();
        return o ? o.launchTask(e, t, i, n, r) : void 0
    }
}, F.extend("Embeddable", "PlugController"), F.Page = function (e, t, i) {
    F.Embeddable.call(this, e, t, i);
    this._class = void 0, this._pageBox = void 0
}, F.Page.prototype = {
    changePage: function (e) {
        if (this._pageBox) {
            var t = e || {};
            t.page = t.page || this._id, this._pageBox.requestChange(t)
        }
    },
    getPage: function () {
        return this
    },
    getPageBox: function () {
        return this._pageBox
    }
}, F.extend("Page", "Embeddable"), F.Page.createDirective = function (e) {
    e.transclude = !0, e.require = "^pagebox";
    var t = e.link;
    e.link = function (e, i, n, r) {
        var o = r.$scope.ctrl,
            a = e.ctrl;
        a._class = n["class"], e["class"] = n["class"], o.addPage(a), t && t.apply(this, arguments)
    };
    var i = F.PlugController.createDirective(e);
    return i
}, F.PageBox = function (e, t, i) {
    F.PlugController.call(this, e, t), this._url = i, this._pageMap = {}, this._changes = [], this._miniViewLarge = !1, this._collecting = 0, this._queryKey = "v", e.displayMaximized = !1, e.taskActive = !1, e.$on("collapseTaskPanel", function (t, i) {
        e.displayMaximized = i
    }), F.PageBox.instances.push(this), this.provideMalePlug("TaskLaunch", ["launchTask"]), this.provideMalePlug("PageChanged", ["changedPage"]), this.provideFemalePlug("PageSelect", ["selectPage", "selectPageClass"]), this.provideFemalePlug("PageConfigure", ["configurePage"]), this.provideFemalePlug("URLChange", ["setFragment", "applyURL"]), this.connect(this, this._url)
}, F.PageBox.prototype = {
    addPage: function (e) {
        this._pageMap[e._id] = e, e._pageBox = this, e.visible(!1)
    },
    selectPage: function (e, t) {
        var i = this.createTarget(F.PageBox.Action.SelectPage, t);
        return this._pageMap[e] && (i.state[e] = {
            visible: !0
        }), this.update(i)
    },
    selectPageClass: function (e, t) {
        var i = this.createTarget(F.PageBox.Action.SelectPageClass, t);
        for (var n in this._pageMap) -1 !== this._pageMap[n]._class.split(" ").indexOf(e) && (i.state[n] = {
            visible: !0
        });
        return this.update(i)
    },
    configurePage: function (e) {
        var t = this.createTarget(F.PageBox.Action.ConfigurePage, e);
        for (var i in this._pageMap) this._pageMap[i].visible() && (t.state[i] = {
            visible: !0,
            miniView: this._pageMap[i].miniView()
        });
        return this.update(t)
    },
    update: function (e) {
        this._updating = !0;
        var t, i = this.prepare(e),
            n = 0;
        do {
            t = !1;
            for (var r in this._pageMap) t = this._pageMap[r].preparePageChange(i) || t;
            n++
        } while (t && 3 > n);
        return this.apply(e)
    },
    prepare: function (e) {
        for (var t in this._pageMap) e.state[t] || (e.state[t] = {
            visible: !1
        }), e.state[t].config = e.config;
        return e
    },
    apply: function (e) {
        var t = this,
            i = Q.defer();
        t._url.collect();
        var n = Object.keys(e.state),
            r = n.map(function (i) {
                return Q.try(function () {
                    var n = e.state[i],
                        r = t._pageMap[i];
                    return n.visible ? Q.try(function () {
                        return !r.miniView() && n.miniView ? r.setMiniView(!0, F.PageBox.MiniViewTransition.Open) : r.miniView() && !n.miniView ? r.setMiniView(!1, F.PageBox.MiniViewTransition.Main) : void 0
                    }).then(function () {
                        return n.config !== !1 ? r.onConfigure(n.config) : void 0
                    }).then(function () {
                        return t.showPage(r)
                    }) : Q.try(function () {
                        return r.visible() && r.miniView() ? r.setMiniView(!1, F.PageBox.MiniViewTransition.Close) : void 0
                    }).then(function () {
                        return t.hidePage(r)
                    }).then(function () {
                        return n.config !== !1 ? r.onConfigure(n.config) : void 0
                    })
                })
            });
        return Q.allSettled(r).then(function () {
            t._url.commit(), t.updateURL(), i.resolve(), t.$scope.$apply(function () {
                t.$scope.taskActive = e.config && e.config.task
            })
        }), i.promise.then(F.proxy(function () {
            this.trigger("changedPage", [e]), this._updating = !1
        }, this))
    },
    isPageVisible: function (e) {
        return this._pageMap[e] && this._pageMap[e].visible()
    },
    isTaskActive: function () {
        return !!this.$scope.taskActive
    },
    showPage: function (e) {
        var t = !e.visible();
        return e.visible(!0), t ? e.onShow() : void 0
    },
    hidePage: function (e) {
        var t = e.visible();
        return e.visible(!1), t ? e.onHide() : void 0
    },
    swapMiniView: function () {
        var e = this.createTarget(F.PageBox.Action.SwapMiniView);
        e.config = !1;
        var t, i;
        for (var n in this._pageMap) this._pageMap[n].visible() && !this._pageMap[n].miniView() && (t = n), this._pageMap[n].visible() && this._pageMap[n].miniView() && (i = n);
        return t && i ? (e.state[i] = {
            visible: !0
        }, e.state[t] = {
            visible: !0,
            miniView: !0
        }, this.update(e)) : Q.resolve()
    },
    closeMiniView: function () {
        var e = this.createTarget(F.PageBox.Action.CloseMiniView);
        e.config = !1;
        for (var t in this._pageMap) this._pageMap[t].visible() && !this._pageMap[t].miniView() && (e.state[t] = {
            visible: !0
        });
        return this.update(e)
    },
    collect: function () {
        this._collecting++
    },
    isCollecting: function () {
        return this._collecting > 0
    },
    requestChange: function (e) {
        this._collecting && this._changes.push(e)
    },
    commit: function () {
        if (0 === --this._collecting && this._changes.length > 0) {
            var e = this.createTarget(F.PageBox.Action.ChangeRequest);
            if (e.config = !1, this._changes.forEach(function (t) {
                    var i = t.page;
                    e.state[i] = {
                        visible: !0
                    }, t.miniView && (e.state[i].miniView = t.miniView, e.miniView = i)
                }), e.miniView && 1 === Object.keys(e.state).length)
                for (var t in this._pageMap) !e.state[t] && this._pageMap[t].visible() && (e.state[t] = {
                    visible: !0
                });
            return this._changes = [], this.update(e)
        }
        return Q.resolve()
    },
    createTarget: function (e, t) {
        return {
            action: e,
            state: {},
            config: t
        }
    },
    updateURL: function () {
        var e = [];
        for (var t in this._pageMap) this._pageMap[t].visible() && !this._pageMap[t].miniView() && e.push(t);
        this._url.setFragment(this._queryKey, e.join(","), F.cloneArray(e))
    },
    setFragment: function (e) {
        if (e.isUnresolved(this._queryKey)) {
            var t = e.get(this._queryKey),
                i = this._url.decode(t.query),
                n = Object.keys(i);
            e.resolve(this._queryKey, t.query, n)
        }
    },
    applyURL: function (e, t) {
        if (e == this._queryKey) {
            var i = t.get(this._queryKey),
                n = this._url.decode(i.query),
                r = this.createTarget(F.PageBox.Action.ApplyURL);
            for (var o in n) r.state[o] = {
                visible: !0
            }, "mv" === n[o] && (r.state[o].miniView = !0);
            return this.update(r)
        }
        return Q.resolve()
    },
    launchTask: function (e, t, i, n, r) {
        return this.trigger("launchTask", [e, t, i, n, r])
    }
}, F.extend("PageBox", "PlugController"), F.PageBox.instances = [], F.PageBox.collect = function () {
    for (var e = 0; e < F.PageBox.instances.length; e++) F.PageBox.instances[e].collect()
}, F.PageBox.commit = function () {
    for (var e = 0; e < F.PageBox.instances.length; e++) F.PageBox.instances[e].commit()
}, F.PageBox.Action = {
    SelectPage: "selectpage",
    SelectPageClass: "selectpageclass",
    ConfigurePage: "configurePage",
    SwapMiniView: "swapminiview",
    CloseMiniView: "closeminiview",
    ChangeRequest: "changerequest",
    ApplyURL: "applyurl"
}, F.PageBox.MiniViewTransition = {
    Open: "open",
    Main: "main",
    Close: "close"
}, F.DI().registerController("pagebox", F.PageBox, "@plug", "@url"), F.DI().registerController("page", F.Page, "@plug", "@url"), F.DI().config("@plug", F.pageboxConfig = function (e) {
    e.describe("PageSelect", ["selectPage", "selectPageClass"]), e.describe("PageChanged", ["changedPage"]), e.describe("PageConfigure", ["configurePage"]), e.describe("TaskLaunch", ["launchTask"])
}), angular.module("f.widget").directive("pagebox", function () {
    return F.PlugController.createDirective({
        controllerClass: F.DI().getController("pagebox"),
        scope: {
            haveTaskpanel: "@",
            maximizeWhenNoTask: "@"
        },
        transclude: !0,
        template: '<div class="f_pagebox" ng-class="{f_pageboxFullWidth: (displayMaximized && haveTaskpanel), f_pageboxNoTaskPanel: (!haveTaskpanel || (!taskActive && maximizeWhenNoTask))}" style="overflow-y:hidden;" ng-transclude></div>'
    })
}), angular.module("f.widget").directive("page", function () {
    return F.PlugController.createDirective({
        controllerClass: F.DI().getController("page"),
        link: function (e, t, i, n, r) {
            var o = n.$scope.ctrl,
                a = e.ctrl;
            a._class = i["class"], e["class"] = i["class"], e.pageBox = o, e.swapMiniView = F.async.bind(this, o.swapMiniView, o), e.closeMiniView = F.async.bind(this, o.closeMiniView, o), o.addPage(a);
            var s = t.find("div.f_page"),
                c = e.$new();
            r(c, function (e) {
                s.append(e)
            }), e.$on("f_scroll", function (e, t) {
                e.stopPropagation(), s[0].addEventListener("scroll", t)
            })
        },
        require: "^pagebox",
        transclude: !0,
        template: '<div class="{{class}} f_page" ng-class="{ f_miniView: miniView, f_miniViewSmall: !pageBox._miniViewLarge, f_miniViewLarge: pageBox._miniViewLarge }" ng-show="visible"></div><div ng-if="miniView" class="f_miniViewTools"><div class="btn-group-vertical f_actionBarVertical"><button class="btn btn-default f_actionBarBtn" style="pointer-events: auto;"  ng-click="swapMiniView()" title="{{ \'FE_SWAP_VIEW\' | i18n }}"><img class="f_actionBarIconLarge" static-src="icons/viewswap.png" /></button><button class="btn btn-default f_actionBarBtn" style="pointer-events: auto;" ng-switch="pageBox._miniViewLarge" ng-click="pageBox._miniViewLarge = !pageBox._miniViewLarge" title="{{ \'FE_CHANGE_VIEW_SIZE\' | i18n }}"><img ng-switch-when="true" class="f_actionBarIconLarge" static-src="icons/viewcollapse.png" /><img ng-switch-when="false" class="f_actionBarIconLarge" static-src="icons/viewexpand.png" /></button><button class="btn btn-default f_actionBarBtn" style="pointer-events: auto;"  ng-click="closeMiniView()" title="{{ \'FE_CLOSE_VIEW\' | i18n }}"><img class="f_actionBarIconLarge" static-src="icons/viewclose.png" /></button></div></div>'
    })
}), F.CookieService = function (e) {
    this._localStorage = e, this._namespace = "ws", this._versionNo = "1", this._separator = "$", this._prefix = this._namespace + this._separator + this._versionNo + this._separator, this._cache = {}, this.cleanupOldVersion()
}, F.CookieService.prototype = {
    cleanupOldVersion: function () {
        for (var e in this._localStorage) {
            var t = e.split("$");
            "ws" === t[0] && t[1] !== this._versionNo && this.removeItemWrapper(e)
        }
    },
    prefixKey: function (e) {
        return this._prefix + e
    },
    setLocalStorageItem: function (e, t) {
        this.setItemWrapper(this.prefixKey(e), t)
    },
    getLocalStorageItem: function (e) {
        return this.getItemWrapper(this.prefixKey(e))
    },
    getLocalStorageItemAsArray: function (e) {
        var t = this.getItemWrapper(this.prefixKey(e));
        return t ? t.split(",") : []
    },
    removeLocalStorageItem: function (e) {
        this.removeItemWrapper(this.prefixKey(e))
    },
    appendLocalStorageItem: function (e, t, i) {
        var n = this.getLocalStorageItem(e);
        if (n) {
            var r = n.split(","),
                o = r.indexOf(t);
            i && o >= 0 && r.splice(o, 1), r.push(t), this.setLocalStorageItem(e, r)
        } else this.setLocalStorageItem(e, t)
    },
    getItemWrapper: function (e) {
        return void 0 !== this._cache[e] ? this._cache[e] : this._localStorage.getItem(e)
    },
    setItemWrapper: function (e, t) {
        this._cache[e] = "" + t;
        try {
            this._localStorage.setItem(e, t)
        } catch (i) {
        }
    },
    removeItemWrapper: function (e) {
        delete this._cache[e];
        try {
            this._localStorage.removeItem(e)
        } catch (t) {
        }
    }
}, F.extend("CookieService"), F.ErrorService = function () {
}, F.ErrorService.prototype = {
    httpHandler: function (e) {
        var t = this;
        return function (i, n, r, o) {
            var a = t.parseException(i, o, n);
            e instanceof Function ? e(a, n) : e.reject(a)
        }
    },
    restHandler: function (e) {
        var t = this;
        return function (i) {
            var n = t.parseException(i.data, i.config, i.status);
            e instanceof Function ? e(n, i.status) : e.reject(n)
        }
    },
    isCustomException: function (e) {
        return e instanceof Array
    },
    parseException: function (e, t, i) {
        var n;
        if (this.isCustomException(e)) {
            n = e.map(function (e) {
                var t = new Error;
                return t._api = !0, t._code = i, t._type = e.Type, t.message = e.Message, t._infos = e.Infos, t._callstack = e.CallStack, t
            });
            for (var r = 0; r < n.length - 1; r++) n[r]._previous = n[r + 1]
        } else n = 0 === i ? [F.connectionError] : [F.unknownError];
        return n[0]
    },
    isExceptionType: function (e, t) {
        return e._type == t
    },
    hasExceptionType: function (e, t) {
        var i = e;
        do {
            if (i._type == t) return !0;
            i = e._previous
        } while (i);
        return !1
    }
}, F.extend("ErrorService"), F.Script = function (e, t, i) {
    this._scriptloader = e, this._id = t, this._url = i, this._promise = void 0
}, F.Script.prototype = {
    requireOnce: function (e) {
        var t = this.isFailed();
        return (!this._promise || t) && (this._promise = this._scriptloader.loadAndEvalScript(this._url, void 0, e)), this._promise.fail(function () {
            var e = new Error;
            throw e._repeated = t, e
        })
    },
    isPending: function () {
        return this._promise && this._promise.isPending()
    },
    isLoaded: function () {
        return this._promise && this._promise.isFulfilled()
    },
    isFailed: function () {
        return this._promise && this._promise.isRejected()
    }
}, F.extend("Script"), F.ScriptLoaderService = function () {
    this._jQuery = $
}, F.ScriptLoaderService.prototype = {
    loadAndEvalScript: function (e, t, i) {
        var n = Q.defer();
        if (t = this._jQuery.extend(t || {}, {
                dataType: "script",
                cache: !0,
                url: e
            }), this._jQuery.ajax(t).done(function () {
                n.resolve()
            }).fail(function () {
                n.reject()
            }), void 0 !== i) {
            setTimeout(function () {
                n.reject()
            }, i)
        }
        return n.promise
    }
}, F.extend("ScriptLoaderService"), F.ScriptService = function (e) {
    this._scriptloader = e, this._registeredScripts = {}
}, F.ScriptService.prototype = {
    registerScript: function (e, t) {
        this._registeredScripts[e] = new F.Script(this._scriptloader, e, t)
    },
    getScript: function (e) {
        return this._registeredScripts[e]
    }
}, F.extend("ScriptService"), void 0 === window.F_WEB_ROOT && (window.F_WEB_ROOT = "/"), void 0 === window.F_WEB_ROOT_LOCAL && (window.F_WEB_ROOT_LOCAL = "/"), void 0 === window.F_WEB_PREFIX && (window.F_WEB_PREFIX = "/"), void 0 === window.F_WEB_PREFIX_LOCAL && (window.F_WEB_PREFIX_LOCAL = "/"), void 0 === window.APP && (window.APP = {}), F.appAssetSchema = /^app:\/\/([a-z0-9][a-z0-9_-]*[a-z0-9])\/(.+)$/, F.appResource = function (e) {
    var t = e.match(F.appAssetSchema);
    if (t) {
        var i = t[1],
            n = window.APP,
            r = n[i] && n[i].Version || "0.0.0.0",
            o = t[2];
        return "app/" + i + "/" + r + "/" + o
    }
}, F.isImgCrossOriginAvailable = function () {
    var e = "crossOrigin" in new Image;
    return function () {
        return e
    }
}(), F.createObjectURL = void 0, window.URL && window.URL.createObjectURL ? F.createObjectURL = window.URL.createObjectURL : window.webkitURL && window.webkitURL.createObjectURL && (F.createObjectURL = window.webkitURL.createObjectURL), F.imgUrl = function (e) {
    var t = F.appResource(e);
    return t ? window.F_WEB_ROOT + t : window.F_WEB_PREFIX + "img/" + e
},
function () {
    var e = F.isImgCrossOriginAvailable(),
        t = (e ? window.F_WEB_PREFIX : window.F_WEB_PREFIX_LOCAL) + "img/";
    F.imgUrlCanvasSafe = function (e) {
        return t + e
    }
}(), F.partialUrlFactory = function () {
    var e = F.isIE() && F.ieVersion() < 12,
        t = e ? window.F_WEB_ROOT_LOCAL : window.F_WEB_ROOT,
        i = (e ? window.F_WEB_PREFIX_LOCAL : window.F_WEB_PREFIX) + "partials/";
    return function (e) {
        var n = F.appResource(e);
        return n ? t + n : i + e
    }
}, F.partialUrl = F.partialUrlFactory(), F.jsAssetUrl = function (e) {
    return window.F_WEB_PREFIX + "js/assets/" + e
}, F.Hyperlink = function (e, t, i) {
    this._url = e || "", this._description = t || e || "", this._provider = i || this.extractProvider()
}, F.Hyperlink.prototype = {
    extractProvider: function () {
        var e = F.Hyperlink._providers;
        for (var t in e) {
            var i = e[t].apiConfig;
            if (i.ownsUrl(this._url)) return i.provider_id
        }
        return "extlink"
    }
}, F.extend("Hyperlink"), F.Hyperlink.registerProvider = function (e) {
    var t = e.apiConfig.provider_id;
    F.Hyperlink._providers[t] = e
}, F.Hyperlink._providers = {}, void 0 === window.F_CDN && (window.F_CDN = ""), F.SignedURLService = function (e, t, i) {
    this.$http = e, this._error = t, this._URL = i, this._signatures = {}, this._promises = {}
}, F.SignedURLService.prototype = {
    hasCDN: function () {
        return !!window.F_CDN
    },
    getSignature: function (e, t) {
        return t && this.isExpired(e) && delete this._signatures[e], this._signatures[e] ? this._signatures[e] : this.loadSignature(e)
    },
    loadSignature: function (e) {
        if (this._promises[e]) return this._promises[e];
        var t = this,
            i = Q.defer();
        this._promises[e] = i.promise;
        var n = {
            method: "GET",
            url: this._URL + e
        };
        return this.$http(n).success(function (n) {
            delete t._promises[e], n.Signatures.forEach(function (e) {
                e.Query = "?Policy=" + e.Policy + "&Signature=" + e.Signature + "&Key-Pair-Id=" + n.KeyPairID
            }), t._signatures[e] = n, i.resolve(n)
        }).error(this._error.httpHandler(function (n) {
            delete t._promises[e], i.reject(n)
        })), i.promise
    },
    isExpired: function (e, t) {
        var i = this._signatures[e],
            n = void 0 === t ? 30 : t;
        if (i) {
            var r = i.Expires - n - Date.now() / 1e3;
            return 0 > r
        }
        return !0
    },
    getSource: function (e, t) {
        var i = e.Signatures;
        return i[t % i.length]
    }
}, F.extend("SignedURLService"), F.DI().config(function () {
    this.registerService("cookie", F.CookieService, "$localStorage"), this.registerService("error", F.ErrorService), this.registerService("scriptloader", F.ScriptLoaderService), this.registerService("script", F.ScriptService, "@scriptloader")
}), F.linkifyWeb = function (e) {
    return e ? "http:" === e.substr(0, 5) || "https:" === e.substr(0, 6) || "mailto:" === e.substr(0, 7) || "ftp:" === e.substr(0, 4) ? e : 0 <= e.indexOf("@") ? "mailto:" + e : "http://" + e : ""
}, F.linkifyLocal = function (e, t) {
    if (!e) return "";
    if ("www." === e.substr(0, 4)) return "http://" + e;
    if ("http:" === e.substr(0, 5) || "https:" === e.substr(0, 6) || "mailto:" === e.substr(0, 7) || "ftp:" === e.substr(0, 4)) return e;
    if (0 <= e.indexOf("@")) return "mailto:" + e;
    var i = e.length - 1,
        n = e[i];
    ("/" === n || "\\" === n) && (e = e.substr(0, i));
    var r = e.lastIndexOf("\\");
    return 0 > r && (r = e.lastIndexOf("/")), r >= 0 ? t + e.substr(r + 1) : t + e
}, angular.module("f.filter").filter("linkify", function () {
    var e = F.DI().getParameter("linkifyDocsRoot", !0);
    return e ? function (t) {
        return F.linkifyLocal(t, e)
    } : F.linkifyWeb
}), angular.module("f.util").directive("backImg", function () {
    return function (e, t, i) {
        i.$observe("backImg", function (e) {
            e ? t.css({
                "background-image": "url('" + e + "')"
            }) : t.css("background-image", "")
        })
    }
}), angular.module("f.util").directive("staticBackImg", function () {
    return function (e, t, i) {
        i.$observe("staticBackImg", function (e) {
            e ? t.css({
                "background-image": "url('" + F.imgUrl(e) + "')"
            }) : t.css("background-image", "")
        })
    }
}), angular.module("f.util").directive("staticSrc", function () {
    return function (e, t, i) {
        i.$observe("staticSrc", function (e) {
            i.$set("src", F.imgUrl(e))
        })
    }
}), angular.module("f.util").directive("staticHref", function () {
    return function (e, t, i) {
        i.$observe("staticHref", function (e) {
            i.$set("href", window.F_WEB_PREFIX + e)
        })
    }
}), angular.module("f.util").directive("asyncpartial", ["$compile", function (e) {
    return {
        link: function (t, i, n) {
            var r = t.$watch(n.firstload, function (o) {
                if (o) {
                    var a = e("<notag ng-include=\"'" + F.partialUrl(n.partial) + "'\"></notag>")(t);
                    i.replaceWith(a), r()
                }
            })
        },
        restrict: "E",
        template: "<div/>"
    }
}]), angular.module("f.util").directive("fallbackSrc", function () {
    return {
        link: function (e, t, i) {
            t.bind("error", function () {
                angular.element(this).attr("src", F.imgUrl(i.fallbackSrc))
            })
        }
    }
}), F.LocalizedStrings = F.LocalizedStrings || {}, F.LocaleService = function (e, t) {
    F.PlugModule.call(this, t);
    this._script = e;
    var i = [];
    F.LocaleService.Languages.forEach(function (t) {
        var n = t.resource.toLowerCase();
        i.indexOf(n) < 0 && (e.registerScript("fe_strings_" + t.resource, F.jsAssetUrl("webshare-strings." + n + ".js")), i.push(n))
    }), this._activeLanguage = F.LocaleService.Languages[0], this._activeLanguageToSet = F.LocaleService.Languages[0], this._defaultLanguage = F.LocaleService.Languages[0], this._activeLanguageStrings = {
        IM_STRING_NOT_FOUND: ""
    }, this._defaultLanguageStrings = this._activeLanguageStrings, this._haveAnyStrings = !1, this._pendingAddition = {}, this.setLanguage(this._defaultLanguage.id, !0), this.provideMalePlug("SettingsUpdate", ["updateSettings"])
}, F.LocaleService.prototype = {
    translate: function (e) {
        return e ? this._activeLanguageStrings[e] || this._defaultLanguageStrings[e] || (this._haveAnyStrings ? this._activeLanguageStrings.IM_STRING_NOT_FOUND + " (" + e + ")" : "") : ""
    },
    addStrings: function (e, t) {
        if (this.isLoaded(e)) {
            for (var i in t) F.LocalizedStrings[e][i] = t[i];
            this.digestAllScopes()
        } else this._pendingAddition[e] = this._pendingAddition[e] || [], this._pendingAddition[e].push(t)
    },
    addResourceScript: function (e, t) {
        if (this.isLoaded(e)) {
            var i = F.appResource(t);
            i || (i = t), this._script.registerScript(t, i), this._script.getScript(t).requireOnce().fail(function () {
            }).done()
        } else this._pendingAddition[e] = this._pendingAddition[e] || [], this._pendingAddition[e].push(t)
    },
    setDefaultLanguage: function () {
        this.setLanguage(this._defaultLanguage.id, !0)
    },
    setLanguage: function (e) {
        var t = this.getLanguages(),
            i = F.findFirst(t, function (t) {
                return t.id === e
            }),
            n = this;
        if (!i) return Q.reject();
        this._activeLanguageToSet = i;
        var r = Q.defer(),
            o = function () {
                i.id === n._defaultLanguage.id && (n._defaultLanguageStrings = F.LocalizedStrings[i.resource]), i.id === n._activeLanguageToSet.id && (n._activeLanguage = i, n._activeLanguageStrings = F.LocalizedStrings[i.resource]), n._haveAnyStrings = !0, n.digestAllScopes(), n.trigger("updateSettings", ["language", []]), r.resolve()
            };
        return this.isLoaded(i.resource) ? F.async(o) : this._script.getScript("fe_strings_" + i.resource).requireOnce().then(function () {
            var e = n._pendingAddition[i.resource];
            e && (e.forEach(function (e) {
                "string" == typeof e ? n.addResourceScript(i.resource, e) : n.addStrings(i.resource, e)
            }), n._pendingAddition[i.resource] = void 0), o()
        }, function (e) {
            r.reject(e)
        }).done(), r.promise
    },
    getLanguages: function () {
        return F.LocaleService.Languages
    },
    getActiveLanguage: function () {
        return this._activeLanguage
    },
    isLoaded: function (e) {
        return !!F.LocalizedStrings[e]
    },
    composeMessage: function (e, t) {
        for (var i = "", n = e.split("%VAR%"), r = 0; r < t.length; r++) i += n[r] + t[r];
        return n.length > t.length && (i += n[r]), i
    },
    translateAndCompose: function (e, t) {
        var i = this.translate(e);
        return i && t && t.length > 0 && (i = this.composeMessage(i, t)), i
    },
    getOccurences: function (e, t) {
        for (var i, n = new RegExp(t, "g"), r = []; i = n.exec(e);) r.push(i.index);
        return r
    },
    digestAllScopes: function () {
        var e = document.getElementsByClassName("ng-scope");
        Array.prototype.forEach.call(e, function (e) {
            angular.element(e).scope().$digest()
        })
    }
}, F.extend("LocaleService", "PlugModule"), F.LocaleService.Languages = [{
    id: "vn_VN",
    resource: "vn_VN",
    caption: "Ting Vit",
    icon: "vn_VN.png"
}, {
    id: "en_US",
    resource: "en_US",
    caption: "English (UK)",
    icon: "en_UK.png"
}, {
    id: "ja_JP",
    resource: "ja_JP",
    caption: "",
    icon: "ja_JP.png"
}, {
    id: "zh_CN",
    resource: "zh_CN",
    caption: "",
    icon: "zh_CN.png"
}], F.DI().config(function () {
    this.registerService("locale", F.LocaleService, "@script", "@plug")
}), angular.module("f.filter").filter("i18n", function () {
    var e = F.DI().getService("locale");
    return function (t, i) {
        return e.translateAndCompose(t, i)
    }
}), angular.module("f.filter").filter("date", function () {
    var e = F.DI().getService("locale");
    return function (t, i) {
        return F.isDefaultDate(t) ? e.translate("FE_UNKNOWN") : i ? F.getDateOfDateTimeStr(t) : t
    }
}), angular.module("f.filter").filter("dateperiod", function () {
    var e = F.DI().getService("locale");
    return function (t, i) {
        var n = F.isDefaultDate(t[0]),
            r = F.isDefaultDate(t[1]);
        if (n && r) return e.translate("FE_UNKNOWN");
        var o = i ? F.getDateOfDateTimeStr(t[0]) : t[0],
            a = i ? F.getDateOfDateTimeStr(t[1]) : t[1];
        return n ? a : r || o === a ? o : o + "  " + a
    }
}), F.makeCRCTable = function () {
    for (var e, t = [], i = 0; 256 > i; i++) {
        e = i;
        for (var n = 0; 8 > n; n++) e = 1 & e ? 3988292384 ^ e >>> 1 : e >>> 1;
        t[i] = e
    }
    return t
}, F.crc32 = function (e) {
    for (var t = F.crc32._crcTable || (F.crc32._crcTable = F.makeCRCTable()), i = -1, n = 0; n < e.length; n++) i = i >>> 8 ^ t[255 & (i ^ e.charCodeAt(n))];
    return (-1 ^ i) >>> 0
}, F.EncryptionService = function () {
}, F.EncryptionService.prototype = {
    encrypt: function (e) {
        return this.base64_encode(e)
    },
    base64_encode: function (e) {
        var t, i, n, r, o, a, s, c, l = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
            h = 0,
            d = 0,
            u = "",
            _ = [];
        if (!e) return e;
        do t = e.charCodeAt(h++), i = e.charCodeAt(h++), n = e.charCodeAt(h++), c = t << 16 | i << 8 | n, r = c >> 18 & 63, o = c >> 12 & 63, a = c >> 6 & 63, s = 63 & c, _[d++] = l.charAt(r) + l.charAt(o) + l.charAt(a) + l.charAt(s); while (h < e.length);
        u = _.join("");
        var p = e.length % 3;
        return (p ? u.slice(0, p - 3) : u) + "===".slice(p || 3)
    },
    base64_decode: function (e) {
        var t, i, n, r, o, a, s, c, l = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
            h = 0,
            d = 0,
            u = "",
            _ = [];
        if (!e) return e;
        e += "";
        do r = l.indexOf(e.charAt(h++)), o = l.indexOf(e.charAt(h++)), a = l.indexOf(e.charAt(h++)), s = l.indexOf(e.charAt(h++)), c = r << 18 | o << 12 | a << 6 | s, t = c >> 16 & 255, i = c >> 8 & 255, n = 255 & c, _[d++] = 64 == a ? String.fromCharCode(t) : 64 == s ? String.fromCharCode(t, i) : String.fromCharCode(t, i, n); while (h < e.length);
        return u = _.join("")
    },
    crc32: function (e) {
        return F.crc32(e)
    }
}, F.extend("EncryptionService"), F.DI().config(function () {
    this.registerService("encryption", F.EncryptionService)
}), F.ChangeObject = function () {
    this._changes = Object.create(this)
}, F.ChangeObject.prototype = {
    cleanUpChanges: function () {
        var e = this,
            t = this._changes;
        Object.keys(t).forEach(function (i) {
            t[i] instanceof Function || t[i] != e[i] || delete t[i]
        })
    },
    hasUnsavedChanges: function () {
        return this.cleanUpChanges(), Object.keys(this._changes).length > 0
    },
    applyChanges: function () {
        this.copyChangesToOrigin(), this.discardChanges()
    },
    discardChanges: function () {
        var e = this;
        Object.keys(this._changes).forEach(function (t) {
            delete e._changes[t]
        })
    },
    copyChangesToOrigin: function () {
        this.cleanUpChanges();
        var e = this,
            t = this._changes;
        Object.keys(t).forEach(function (i) {
            t[i] instanceof Function || t[i] == e[i] || (e[i] = t[i])
        })
    },
    matchesJson: function () {
    },
    readJson: function () {
    },
    writeJson: function () {
    },
    writeChanges: function () {
        this.cleanUpChanges();
        var e = this._changes.writeJson(),
            t = {};
        return Object.keys(this._changes).forEach(function (i) {
            var n = i.charAt(1).toUpperCase() + i.substr(2);
            e.hasOwnProperty(n) && (t[n] = e[n])
        }), t.Class = e.Class, t
    },
    applyUpdate: function (e) {
        e ? (this.readJson(e), this.discardChanges()) : this.applyChanges()
    }
}, F.extend("ChangeObject"), F.Serializer = function () {
    this._classes = {}
}, F.Serializer.prototype = {
    read: function (e) {
        if (e instanceof Array) {
            for (var t = 0; t < e.length; t++) e[t] = this.read(e[t]);
            return e
        }
        if (e instanceof Object) {
            if (e.Class && this._classes[e.Class]) {
                var i = this._classes[e.Class]();
                return i.readJson(e), i
            }
            return e
        }
        return e
    },
    registerClass: function (e, t) {
        this._classes[e] = t
    }
}, F.extend("Serializer"), F.CRUDService = function (e, t, i, n, r, o, a, s, c) {
    F.PlugModule.call(this, s), this._serializer = r, this._error = o, this._constructor = t, this._entities = [], this._resource = c, this._restClient = this._resource(i + "/:id", n, {
        create: {
            method: "POST",
            params: {}
        },
        read: {
            method: "GET",
            params: {}
        },
        readAll: {
            method: "GET",
            params: {},
            isArray: !0
        },
        edit: {
            method: "PUT",
            params: {}
        },
        remove: {
            method: "DELETE",
            params: {},
            isArray: !0
        },
        action: {
            method: "POST",
            params: {}
        },
        arrayAction: {
            method: "POST",
            params: {},
            isArray: !0
        }
    }), this._selection = new F.Selection(e, this._entities, s), this._filter = function () {
        return !0
    }, a.registerSelection(e, this._selection), this.provideMalePlug("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"])
}, F.CRUDService.prototype = {
    getNew: function (e) {
        var t = new this._constructor(this);
        return e && t.readJson(e), t
    },
    getAll: function (e, t) {
        var i = this,
            n = Q.defer();
        return this._restClient.readAll(e || {}, function (e) {
            Q.try(i.updateInternalMultiple.bind(i, e)).then(function () {
                var e = t || function () {
                    return !0
                };
                n.resolve(i._entities.filter(e))
            }, n.reject)
        }, this._error.restHandler(n)), n.promise
    },
    getAllFromServer: function (e, t) {
        var i = this,
            n = Q.defer();
        return this._restClient.readAll(e || {}, function (e) {
            var r = i._serializer.read(e);
            t && (r = r.filter(t)), n.resolve(r)
        }, this._error.restHandler(n)), n.promise
    },
    getAllWith: function (e, t, i) {
        var n = t || {};
        return n["with"] = e, this.getAll(n, i)
    },
    getByIDs: function (e, t, i) {
        var n = F.curry(this.getByID, 3, !0, t || {}, i);
        return Q.all(e.map(F.proxy(n, this)))
    },
    getByID: function (e, t, i, n) {
        var r = Q.defer(),
            o = F.findFirst(this._entities, function (t) {
                return t.getID() === e
            });
        if (o) Q.try(this.handleSingleEntity.bind(this, o)).then(r.resolve.bind(r, o), r.reject.bind(r));
        else {
            if (!i) return this.getSingle(e, t, n);
            this.getAll(t).then(function (t) {
                var i = F.findFirst(t, function (t) {
                    return t.getID() === e
                });
                i ? r.resolve(i) : r.reject(new Error("EM_RESOURCE_NOT_FOUND"))
            }).done()
        }
        return r.promise
    },
    create: function (e, t) {
        var i = Q.defer(),
            n = this;
        return this._restClient.create(t || {}, e.writeJson(), function (t) {
            e.readJson(t), Q.try(n.handleSingleEntity.bind(n, e)).then(function () {
                n._filter(e) ? (n._entities.push(e), Q.try(n.handleEntityChanges.bind(n, [e], [], [])).then(i.resolve.bind(i, e), i.reject.bind(i))) : i.resolve()
            })
        }, this._error.restHandler(i)), i.promise
    },
    update: function (e, t) {
        var i = Q.defer(),
            n = t || {};
        n.id = e.getID();
        var r = this;
        return this._restClient.edit(n, e.writeChanges(), function (t) {
            e.applyUpdate(t), Q.try(r.handleSingleEntity.bind(r, e)).then(r.postUpdate.bind(r, e)).then(i.resolve.bind(i, e), i.reject)
        }, this._error.restHandler(function (t) {
            r._error.isExceptionType(t, "FindObjectException") && r.removeSingleInternal(e), i.reject(t)
        })), i.promise
    },
    remove: function (e, t, i) {
        var n = Q.defer(),
            r = t || {};
        r.id = e.getID();
        var o = this,
            a = i || null;
        return this._restClient.remove(r, a, function () {
            o.removeSingleInternal(e), n.resolve()
        }, this._error.restHandler(function (t) {
            o._error.isExceptionType(t, "FindObjectException") ? (o.removeSingleInternal(e), n.resolve()) : n.reject(t)
        })), n.promise
    },
    action: function (e, t) {
        var i = Q.defer();
        return this._restClient.action(t || {}, e, function (e) {
            i.resolve(e)
        }, this._error.restHandler(i)), i.promise
    },
    arrayAction: function (e, t) {
        var i = Q.defer();
        return this._restClient.arrayAction(t || {}, e, function (e) {
            i.resolve(e)
        }, this._error.restHandler(i)), i.promise
    },
    entityAction: function (e, t, i) {
        var n = i || {};
        n.id = e.getID();
        var r = this;
        return this.action(t, n).then(function (t) {
            e.readJson(t);
            var i = r._entities.indexOf(e);
            !r._filter(e) && i > -1 && (F.removeFirst(this._entities, e), r.trigger("removeObject", [e]))
        })
    },
    getSingle: function (e, t, i) {
        var n = this,
            r = Q.defer(),
            o = t || {};
        return o.id = e, this._restClient.read(o, function (e) {
            n.updateInternalSingle(e, i).then(function (e) {
                e ? r.resolve(e) : r.reject(new Error("EM_RESOURCE_NOT_FOUND"))
            })
        }, this._error.restHandler(r)), r.promise
    },
    updateInternalSingle: function (e, t) {
        var i, n = F.findFirst(this._entities, function (t) {
                return t.matchesJson(e)
            }),
            r = [],
            o = [],
            a = [];
        n ? (n.readJson(e), this._filter(n) ? (o.push(n), i = n) : (F.removeFirst(this._entities, n), a.push(n), i = t ? void 0 : n)) : (n = this._serializer.read(e), this._filter(n) ? (this._entities.push(n), r.push(n), i = n) : i = t ? void 0 : n);
        var s = Q.resolve();
        return i && (s = s.then(this.handleSingleEntity.bind(this, i))), s.then(this.handleEntityChanges.bind(this, r, o, a)).thenResolve(i)
    },
    updateInternalMultiple: function (e) {
        for (var t = []; this._entities.length;) t.push(this._entities.shift());
        var i = [],
            n = [],
            r = this;
        return e.forEach(function (e) {
            var o = F.removeFirst(t, function (t) {
                return t.matchesJson(e)
            });
            if (o) o.readJson(e), r._filter(o) ? (r._entities.push(o), n.push(o)) : t.push(o);
            else {
                var a = r._serializer.read(e);
                r._filter(a) && (r._entities.push(a), i.push(a))
            }
        }), this.handleEntityChanges(i, n, t)
    },
    handleSingleEntity: function () {
    },
    handleEntityChanges: function (e, t, i) {
        i.length > 0 && (this._selection.unselectMulti(i), this.trigger("removeObjects", [i])), t.length > 0 && this.trigger("updateObjects", [t]), e.length > 0 && this.trigger("addObjects", [e])
    },
    removeSingleInternal: function (e) {
        var t = this._entities.indexOf(e);
        t > -1 && (this._entities.splice(t, 1), this._selection.unselect(e), this.trigger("removeObjects", [
            [e]
        ]))
    },
    removeInternal: function () {
        for (this._selection.unselectMulti(this._entities), this.trigger("removeObjects", [F.cloneArray(this._entities)]); this._entities.length;) this._entities.shift()
    },
    postUpdate: function (e) {
        var t = -1 !== this._entities.indexOf(e),
            i = this._filter(e);
        t && i ? this.handleEntityChanges([], [e], []) : i ? (this._entities.push(e), this.handleEntityChanges([e], [], [])) : t && (F.removeFirst(this._entities, e), this.handleEntityChanges([], [], [e]))
    }
}, F.extend("CRUDService", "PlugModule"), F.CRUDObject = function (e) {
    this._service = e, this._selected = !1
}, F.CRUDObject.prototype = {
    create: function () {
        return this._service.create instanceof Function && this._service.create(this)
    },
    update: function (e) {
        return this._service.update instanceof Function && this._service.update(this, e)
    },
    remove: function (e) {
        return this._service.remove instanceof Function && this._service.remove(this, void 0, e)
    },
    getID: function () {
    },
    selection: function () {
        return this._service._selection
    }
}, F.extend("CRUDObject", "ChangeObject"), F.mixin("CRUDObject", "Selectable"), F.DI().registerService("serializer", F.Serializer), F.addObjectsByID = function (e, t) {
    var i = !1,
        n = {};
    e.forEach(function (e) {
        n[e.getID()] = !0
    });
    for (var r = 0; r < t.length; r++) n.hasOwnProperty(t[r].getID()) || (e.push(t[r]), i = !0);
    return i
}, F.removeObjectsByID = function (e, t) {
    for (var i = !1, n = {}; e.length;) {
        var r = e.pop();
        n[r.getID()] = r
    }
    for (var o = 0; o < t.length; o++) n.hasOwnProperty(t[o].getID()) && (delete n[t[o].getID()], i = !0);
    for (var a in n) e.push(n[a]);
    return i
}, F.AccountService = function (e, t, i) {
    this.$http = e, this._encryption = t, this._error = i
}, F.AccountService.prototype = {
    create: function (e, t, i, n, r) {
        var o = Q.defer();
        return this.$http({
            method: "POST",
            url: "/user/createuser",
            data: {
                firstname: e,
                middlename: t,
                lastname: i,
                username: n,
                password: this._encryption.encrypt(r)
            }
        }).success(function () {
            o.resolve()
        }).error(this._error.httpHandler(o)), o.promise
    },
    validateAccount: function (e) {
        var t = Q.defer();
        return this.$http({
            method: "POST",
            url: "/user/validateaccount",
            data: {
                token: e
            }
        }).success(function () {
            t.resolve()
        }).error(this._error.httpHandler(t)), t.promise
    },
    changePassword: function (e, t) {
        var i = Q.defer();
        return this.$http({
            method: "POST",
            url: "/user/applynewpassword",
            data: {
                token: e,
                password: this._encryption.encrypt(t)
            }
        }).success(function () {
            i.resolve()
        }).error(this._error.httpHandler(i)), i.promise
    },
    resetPassword: function (e) {
        var t = Q.defer();
        return this.$http({
            method: "POST",
            url: "/user/resetpassword",
            data: {
                email: e
            }
        }).success(function () {
            t.resolve()
        }).error(this._error.httpHandler(t)), t.promise
    },
    sanitizeToken: function (e) {
        var t = decodeURIComponent(e.replace(/\+/g, "%20"));
        return t.replace(/\s/g, "")
    },
    updateSettings: function (e) {
        var t = Q.defer();
        return this.$http({
            method: "PUT",
            url: "/user/settings/" + e.getID(),
            data: e.writeChanges()
        }).success(function (i) {
            e.applyUpdate(i), t.resolve()
        }).error(this._error.httpHandler(t)), t.promise
    },
    updateMe: function (e) {
        var t = Q.defer();
        return this.$http({
            method: "PUT",
            url: "/domain/updateme",
            data: e.writeChanges()
        }).success(function (i) {
            e.applyUpdate(i), t.resolve()
        }).error(this._error.httpHandler(t)), t.promise
    }
}, F.extend("AccountService"), F.LoginServiceBase = function (e, t, i, n) {
    F.PlugModule.call(this, n), this._error = e, this._http = t, this._encryption = i, this._listeners = {}, this._me = void 0, this._meDefer = void 0, this.provideMalePlug("Login", ["login", "logout", "updateAccount"])
}, F.LoginServiceBase.prototype = {
    setMe: function (e) {
        var t = void 0 !== this._me;
        this._me = e, this._meDefer.resolve(), t ? (this.notify("update"), this.trigger("updateAccount")) : (this.notify("login"), this.trigger("login"))
    },
    resetMe: function () {
        var e = !!this._me;
        this._me = void 0, e && (this.notify("logout"), this.trigger("logout")), this._meDefer && this._meDefer.resolve()
    },
    login: function (e, t) {
        var i = this._encryption.encrypt(e),
            n = this._encryption.encrypt(t);
        this._meDefer = Q.defer();
        var r = Q.defer(),
            o = {
                method: "POST",
                url: "/login_user_info?_username=" + encodeURIComponent(i) + "&_password=" + encodeURIComponent(n)
            },
            a = this;
        return this._http(o).success(function (e) {
            a.setMe(e), r.resolve()
        }).error(this._error.httpHandler(function (e) {
            a.resetMe(), r.reject(e)
        })), r.promise
    },
    logout: function () {
        var e = Q.defer(),
            t = {
                method: "POST",
                url: "/logout"
            },
            i = this;
        return this._http(t).success(function () {
            i._meDefer = Q.defer(), i.resetMe(), e.resolve()
        }).error(this._error.httpHandler(e)), e.promise
    },
    isLoggedIn: function () {
        var e = this;
        return this.getMe().then(function () {
            return void 0 !== e._me
        })
    },
    getUserID: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me ? e._me.Id : null
        })
    },
    getUsername: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me ? e._me.Username : null
        })
    },
    getFirstname: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me ? e._me.Firstname : null
        })
    },
    getMiddlename: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me ? e._me.Middlename : null
        })
    },
    getLastname: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me ? e._me.Lastname : null
        })
    },
    getSettings: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me ? e._me.UserSettings : null
        })
    },
    getMe: function (e) {
        if (!e && this._meDefer) return this._meDefer.promise;
        this._meDefer = Q.defer();
        var t = {
                method: "GET",
                url: "/domain/whoami"
            },
            i = this;
        return this._http(t).success(function (e) {
            i.setMe(e)
        }).error(this._error.httpHandler(function (e) {
            i._error.isExceptionType(e, "AuthenticationException") ? i.resetMe() : i._meDefer.reject(e)
        })), this._meDefer.promise
    },
    refresh: function () {
        return this.getMe(!0)
    },
    subscribe: function (e, t) {
        this._listeners[e] ? this._listeners[e].push(t) : this._listeners[e] = [t]
    },
    notify: function (e) {
        this._listeners[e] && this._listeners[e].forEach(function (e) {
            e.call(this)
        })
    }
}, F.extend("LoginServiceBase", "PlugModule"), F.UserLocaleService = function (e, t, i) {
    F.LocaleService.call(this, e, t);
    var n = this,
        r = function () {
            i.getSettings().then(function (e) {
                n.updateLanguageBySettings(e)
            }).done()
        },
        o = function () {
            n.setDefaultLanguage(!0)
        };
    i.subscribe("login", r), i.subscribe("logout", o), i.subscribe("update", r)
}, F.UserLocaleService.prototype = {
    updateLanguageBySettings: function (e) {
        e && e.Language && this.setLanguage(e.Language)
    }
}, F.extend("UserLocaleService", "LocaleService"), F.UserBase = function (e) {
    F.CRUDObject.call(this, e), this._ID = void 0, this._firstname = "", this._middlename = "", this._lastname = "", this._username = ""
}, F.UserBase.prototype = {
    getID: function () {
        return this._ID
    },
    matchesJson: function (e) {
        return this._ID === e.Id
    },
    getUsername: function () {
        return this._username
    },
    readJson: function (e) {
        this._ID = e.Id, this._firstname = e.Firstname, this._middlename = e.Middlename, this._lastname = e.Lastname, this._username = e.Username
    },
    writeJson: function () {
        var e = {};
        return e.Class = "UserBase", e.Id = this._ID, e.Firstname = this._firstname, e.Middlename = this._middlename, e.Lastname = this._lastname, e.Username = this._username, e
    },
    getName: function () {
        var e = [];
        return "string" == typeof this._firstname && this._firstname.length > 0 && e.push(this._firstname), "string" == typeof this._lastname && this._lastname.length > 0 && e.push(this._lastname), e.join(" ")
    },
    getNameAndUsername: function () {
        var e = this.getName();
        return e.length > 0 ? e + " <" + this._username + ">" : this._username
    }
}, F.extend("UserBase", "CRUDObject"), F.UserServiceBase = function (e, t, i, n, r, o, a, s) {
    a = a || F.UserBase, s = s || "/admin/user", F.CRUDService.call(this, "User", a, s, {}, e, t, n, r, o);
    var c = this;
    i.subscribe("logout", function () {
        c.removeInternal()
    })
}, F.UserServiceBase.prototype = {}, F.extend("UserServiceBase", "CRUDService"), F.UserSettingsBase = function () {
    F.ChangeObject.call(this), this._ID = void 0, this._units = "", this._areaunit = "", this._angleUnit = "", this._language = "", this._currency = "", this._timezone = null, this._coordSystem = ""
}, F.UserSettingsBase.prototype = {
    getID: function () {
        return this._ID
    },
    matchesJson: function (e) {
        return this._ID === e.Id
    },
    readJson: function (e) {
        this._ID = e.Userid, this._units = e.Units, this._areaunit = e.Areaunit, this._angleUnit = e.AngleUnit, this._language = e.Language, this._currency = e.Currency, this._timezone = e.Timezone, this._coordSystem = e.CoordSystem
    },
    writeJson: function () {
        var e = {};
        return e.Class = "UserSettingsBase", e.Userid = this._ID, e.Units = this._units, e.Areaunit = this._areaunit, e.AngleUnit = this._angleUnit, e.Language = this._language, e.Currency = this._currency, e.Timezone = this._timezone, e.CoordSystem = this._coordSystem, e
    }
}, F.extend("UserSettingsBase", "ChangeObject"), angular.module("f.user", []), void 0 === window.F_USER_DIRECTORY && (window.F_USER_DIRECTORY = ""), F.DI().registerService("user", F.UserServiceBase, "@serializer", "@error", "@login", "@selection", "@plug", "$resource"), F.DI().registerService("account", F.AccountService, "$http", "@encryption", "@error"), F.DI().registerService("login", F.LoginServiceBase, "@error", "$http", "@encryption", "@plug"), F.DI().config(function () {
    this.redefineService("locale", F.UserLocaleService, "@script", "@plug", "@login")
}), F.userBaseConfigSerializer = function (e, t) {
    e.registerClass("UserBase", function () {
        return t.getNew()
    })
}, F.authenticationException = new Error("EXCEPTION_MESSAGE_AUTHENTICATION"), F.authenticationException._type = "AuthenticationException", F.DI().config("@plug", F.userConfig = function (e) {
    e.describe("Login", ["login", "logout", "updateAccount"])
}), F.DI().config("?@task", "@login", F.userConfigValidators = function (e, t) {
    e && e.addValidator("login", function () {
        var e = "EM_NO_LOGIN";
        return t.isLoggedIn().then(function (t) {
            return t ? void 0 : e
        }, function () {
            return e
        })
    })
}), angular.module("f.user").filter("userfilter", function () {
    return function (e, t) {
        return e.filter(function (e) {
            return t ? e._firstname && -1 !== e._firstname.toLowerCase().indexOf(t.toLowerCase()) || e._lastname && -1 !== e._lastname.toLowerCase().indexOf(t.toLowerCase()) || e._username && -1 !== e._username.toLowerCase().indexOf(t.toLowerCase()) ? e : void 0 : e
        })
    }
}), F.CreateAccountBox = function (e, t, i, n) {
    F.Embeddable.call(this, e, i, n);
    var r = this;
    e.formData = {}, this._promise = void 0, e.getPromise = function () {
        return r._promise
    }, e.submit = function (i) {
        var n = e.formData;
        e.canSubmit() && (r._promise = t.create(n.firstname, n.middlename || "", n.lastname, n.username, n.password), r._promise.then(function () {
            r.$scope.$apply(function () {
                r.$scope.formData = {}, i.$setPristine()
            })
        }).done())
    }, e.notValidNames = /^[a-z A-Z]+$/, e.validatePassword = function () {
        if (void 0 === e.formData.password) return !1;
        var t = F.validatePassword(e.formData.password);
        return e.passwordsEqual() && void 0 === t
    }, e.passwordsEqual = function () {
        return e.formData.confirmPassword === e.formData.password
    }, e.canSubmit = function () {
        var t = e.getPromise();
        return e.validatePassword() && e.formData.termsAccepted && e.formData.firstname && e.formData.lastname && e.formData.username && (void 0 === t || !t.isPending())
    }
}, F.CreateAccountBox.prototype = {
    onShow: function () {
        F.Embeddable.prototype.onShow.call(this), this.$scope.formData = {}
    }
}, F.extend("CreateAccountBox", "Embeddable"), F.LoginBox = function (e, t, i, n, r, o) {
    F.Embeddable.call(this, e, n, r);
    var a = this;
    this._login = t, this._cookie = i, this._nextURL = void 0, this._cookieID = o, this._promise = void 0, e.getPromise = function () {
        return a._promise
    }, this._loginPromise = void 0, this._logoutPromise = void 0, e.getLoginPromise = function () {
        return a._loginPromise
    }, e.getLogoutPromise = function () {
        return a._logoutPromise
    }, e.usernameList = this._cookie.getLocalStorageItemAsArray(this._cookieID), e.credentials = {
        username: e.usernameList[e.usernameList.length - 1],
        password: ""
    }, e.userDirectory = window.F_USER_DIRECTORY, e.login = function (t, i, n) {
        t && i && (a._loginPromise = a._login.login(t, i), a._loginPromise.then(function () {
            a.setCookie(t), a.refresh(), a._nextURL && a._url.navigateTo(a._nextURL)
        }, function () {
        }).done(), e.credentials.password = "", n.$setPristine())
    }, e.logout = function () {
        a._logoutPromise = a._login.logout(), a._logoutPromise.then(function () {
            a.refresh(), a.$scope.$apply()
        }, function () {
        }).done()
    }, e.loadLostPassword = function () {
        a.selectPageClass("lostpassword", {
            username: e.credentials.username
        })
    }, e.createAccount = function () {
        a.selectPageClass("createaccount")
    }
}, F.LoginBox.prototype = {
    setCookie: function (e) {
        this._cookie.appendLocalStorageItem(this._cookieID, e, !0);
        var t = this;
        this.$scope.$apply(function (e) {
            e.usernameList = t._cookie.getLocalStorageItemAsArray(t._cookieID)
        })
    },
    refresh: function () {
        this._promise = this._login.getUsername(), this._loginPromise = void 0, this._logoutPromise = void 0
    },
    onShow: function () {
        F.Embeddable.prototype.onShow.call(this), this.refresh()
    },
    onConfigure: function (e) {
        this._nextURL = void 0, e && (this._nextURL = e.nextURL)
    }
}, F.extend("LoginBox", "Embeddable"), F.LostPasswordBox = function (e, t, i) {
    F.Embeddable.call(this, e, t, i);
    e.username = ""
}, F.LostPasswordBox.prototype = {
    onConfigure: function (e) {
        this.$scope.username = "", e && e.username && (this.$scope.username = e.username)
    }
}, F.extend("LostPasswordBox", "Embeddable"), F.DI().config(function () {
    this.registerParameter("lastusercookieid", "lastuser"), this.registerController("createaccount", F.CreateAccountBox, "@account", "@plug", "@url"), this.registerController("login", F.LoginBox, "@login", "@cookie", "@plug", "@url", "%lastusercookieid%"), this.registerController("lostpassword", F.LostPasswordBox, "@plug", "@url")
});
var fWidget = angular.module("f.widget");
fWidget.directive("login", function () {
    return F.PlugController.createDirective({
        controllerClass: F.DI().getController("login"),
        template: '<asyncpartial firstload="visible" partial="login.html"></asyncpartial>'
    })
}), fWidget.directive("createaccount", function () {
    return F.PlugController.createDirective({
        controllerClass: F.DI().getController("createaccount"),
        template: '<asyncpartial firstload="visible" partial="createaccount.html"></asyncpartial>'
    })
}), fWidget.directive("lostpassword", function () {
    return F.PlugController.createDirective({
        controllerClass: F.DI().getController("lostpassword"),
        template: '<asyncpartial firstload="visible" partial="lostpasswordpage.html"></asyncpartial>'
    })
}), fWidget.directive("lostpasswordform", function () {
    var e = F.DI().getService("account"),
        t = F.DI().getService("cookie"),
        i = F.DI().getParameter("lastusercookieid");
    return {
        restrict: "E",
        scope: {},
        link: function (n, r, o) {
            n.usernameList = t.getLocalStorageItemAsArray(i), n.credentials = {
                username: ""
            }, o.username ? n.credentials.username = o.username : n.usernameList.length > 0 && (n.credentials.username = n.usernameList[n.usernameList.length - 1]), n.dots = "", n.resetPassword = function (t) {
                var i = /.+@.+[.].+/;
                t && t.match(i) ? (n.isError = !1, n.message = "FE_SENDING_EMAIL", n.dots = "...", e.resetPassword(t).then(function () {
                    n.$apply(function (e) {
                        e.isError = !1, e.message = "IM_EMAIL_SENT", e.dots = ""
                    })
                }, function (e) {
                    n.$apply(function (t) {
                        t.isError = !0, t.message = e.message || "EM_UNDEFINED", t.dots = ""
                    })
                }).done()) : (n.isError = !0, n.message = "EM_INSERT_USERNAME", n.dots = "")
            }
        },
        templateUrl: F.partialUrl("lostpasswordform.html")
    }
}), F.ProjectBase = function (e) {
    F.CRUDObject.call(this, e), this._name = void 0, this._displayName = void 0, this._projectUUID = void 0
}, F.ProjectBase.prototype = {
    getID: function () {
        return this._name
    },
    matchesJson: function (e) {
        return this._name === e.Name
    },
    readJson: function (e) {
        this._name = e.Name, this._displayName = e.DisplayName, this._projectUUID = e.ProjectUUID
    },
    writeJson: function () {
        var e = {};
        return e.Class = "ProjectBase", e.Name = this._name, e.DisplayName = this._displayName, e.ProjectUUID = this._projectUUID, e
    }
}, F.extend("ProjectBase", "CRUDObject"), F.ProjectServiceBase = function (e, t, i, n, r, o, a, s, c, l) {
    c = c || F.ProjectBase, l = l || "/project";
    var h = "Project";
    F.CRUDService.call(this, h, c, l, {}, e, t, n, r, o);
    var d = this;
    this.$http = a, this._url = s, this._currentProject = void 0, this._queryKey = "p", this._listeners = {}, i.subscribe("logout", function () {
        d.removeInternal(), d._currentProject = void 0
    }), this.provideMalePlug("ProjectChange", ["changeProject"]), this.provideFemalePlug("URLChange", ["setFragment", "applyURL"]), this.connect(this, this._url)
}, F.ProjectServiceBase.prototype = {
    changeProject: function (e) {
        return this._currentProject = e, this.updateURL(), this.notify("change"), this.trigger("changeProject", [e])
    },
    getCurrent: function () {
        if (!this._currentProject) throw new Error("EM_NO_PROJECT");
        return this._currentProject
    },
    hasCurrent: function () {
        return void 0 !== this._currentProject
    },
    isCurrent: function (e) {
        return void 0 !== this._currentProject && this._currentProject === e
    },
    subscribe: function (e, t) {
        this._listeners[e] ? this._listeners[e].push(t) : this._listeners[e] = [t]
    },
    notify: function (e) {
        this._listeners[e] && this._listeners[e].forEach(function (e) {
            e.call(this)
        })
    },
    updateURL: function () {
        this._url.setFragment(this._queryKey, this._currentProject)
    },
    setFragment: function (e) {
        e.isUnresolved(this._queryKey) && e.resolve(this._queryKey, e.get(this._queryKey).query)
    },
    applyURL: function (e, t) {
        if (e == this._queryKey) {
            var i = this._currentProject,
                n = t.get(this._queryKey).query;
            this._currentProject = n, n !== i && (this.notify("change"), this.trigger("changeProject", [n]))
        }
    }
}, F.extend("ProjectServiceBase", "CRUDService"), F.DI().registerService("project", F.ProjectServiceBase, "@serializer", "@error", "@login", "@selection", "@plug", "$resource", "$http", "@url"), F.DI().config("@plug", F.projectPlug = function (e) {
    e.describe("ProjectChange", ["changeProject"])
}), F.projectBaseConfigSerializer = function (e, t) {
    e.registerClass("ProjectBase", function () {
        return t.getNew()
    })
}, F.DI().config("@task", "@project", function (e, t) {
    e.addValidator("project", function () {
        return t.hasCurrent() ? Q.resolve() : Q.resolve("EM_NO_PROJECT")
    })
}), F.RevisionService = function (e, t, i, n) {
    this._http = e, this._error = t, this._project = i, this._cookie = n, this._lastRead = {}
}, F.RevisionService.prototype = {
    getCurrent: function () {
        var e = Q.defer(),
            t = this._project.getCurrent(),
            i = {
                method: "GET",
                url: "/revision/control/" + t
            };
        return this._http(i).success(function (t) {
            e.resolve(t.revision)
        }).error(this._error.httpHandler(e)), e.promise
    },
    getLastRead: function (e) {
        return this._lastRead[e] = this._lastRead[e] || parseInt(this._cookie.getLocalStorageItem("rev/" + e)) || Number.MAX_VALUE, this._lastRead[e]
    },
    touch: function (e, t, i) {
        this._lastRead[e] || this.getLastRead(e), this._lastRead[e] == Number.MAX_VALUE && i && (this._lastRead[e] = t - 1);
        var n = parseInt(this._cookie.getLocalStorageItem("rev/" + e) || 0);
        this._cookie.setLocalStorageItem("rev/" + e, Math.max(t, n))
    }
}, F.extend("RevisionService"), F.DataFilter = function () {
    this._categories = void 0, this._tags = void 0, this._root = void 0, this._createdBy = void 0
}, F.DataFilter.prototype = {
    setCategories: function (e) {
        this._categories = e
    },
    setTags: function (e) {
        this._tags = e
    },
    setCreatedBy: function (e) {
        this._createdBy = e
    },
    setRoot: function (e) {
        this._root = e ? "" : void 0
    },
    hasRoot: function () {
        return "" === this._root
    },
    filter: function (e) {
        return !(this._categories && -1 == this._categories.indexOf(e._category) || this._tags && !this._tags.some(function (t) {
            return -1 != e._tags.indexOf(t)
        }) || this._createdBy && -1 == this._createdBy.indexOf(e._createdBy))
    },
    enhanceRead: function (e) {
        this._categories && (e.category = this._categories.join(",")), this._tags && (e.tags = this._tags.join(",")), this._createdBy && (e.createdby = this._createdBy.join(",")), "" === this._root && (e.root = this._root)
    },
    enhanceUpdate: function (e) {
        "" === this._root && (e.root = this._root)
    },
    enhanceRemove: function (e) {
        "" === this._root && (e.root = this._root)
    }
}, F.extend("DataFilter", "ChangeObject"), F.WorkspaceService = function (e, t, i, n) {
    F.PlugModule.call(this, i);
    var r = this;
    this._error = e, this._project = t, this._http = n, this._root = !1, this._promiseAncestors = void 0, this._promiseProject = void 0, t.subscribe("change", function () {
        r._promiseAncestors = void 0, r._promiseProject = void 0
    })
}, F.WorkspaceService.prototype = {
    addCustomAttributes: function (e) {
        return Q.all([this.getAncestorMap(), this.getProject()]).spread(function (t, i) {
            var n = i._trafo;
            return e.forEach(function (e) {
                e._ancestors = t[e._parentUUID] || [], e instanceof WS.Measurement && e.setCustomTrafo(n)
            }), e
        })
    },
    getAncestorMap: function (e) {
        return !e && this._promiseAncestors ? this._promiseAncestors : (this._promiseAncestors = this.loadAncestors(), this._promiseAncestors)
    },
    getProject: function (e) {
        return !e && this._promiseProject ? this._promiseProject : (this._promiseProject = this._project.getCurrentProject(), this._promiseProject)
    },
    loadAncestors: function () {
        var e = this,
            t = Q.defer(),
            i = this._project.getCurrent(),
            n = {
                method: "GET",
                url: "/workspaceskeleton/" + i + (this._root ? "?root" : "")
            };
        return this._http(n).success(function (i) {
            t.resolve(e.listToAncestorMap(i))
        }).error(this._error.httpHandler(t)), t.promise
    },
    listToAncestorMap: function (e) {
        return e.reduce(function (e, t) {
            var i = e[t.ParentUUID] || [];
            return e[t.UUID] = i.concat([t]), e
        }, {})
    },
    root: function (e) {
        e !== this._root && (this._promiseAncestors = void 0, this._promiseProject = void 0), this._root = e
    }
}, F.extend("WorkspaceService", "PlugModule"), F.ProjectCRUDService = function (e, t, i, n, r, o, a, s, c, l, h, d, u) {
    F.CRUDService.call(this, e, t, i + "/:project", n, r, o, s, c, u);
    var _ = this;
    this._project = a, this._login = l, this._revision = h, this._workspace = d, this._dataFilter = new F.DataFilter, this._className = e, a.subscribe("change", function () {
        _.clearCache(), _.removeInternal(), _.setDataFilter(new F.DataFilter)
    });
    var p = function () {
        _.clearCache(), a.hasCurrent() || _.removeInternal()
    };
    l.subscribe("login", p), l.subscribe("update", p), l.subscribe("logout", p), this._pendingSync = void 0, this._lastSync = void 0
}, F.ProjectCRUDService.prototype = {
    setDataFilter: function (e) {
        return this._dataFilter = e, this._filter = F.proxy(e.filter, e), this.getAll(void 0, void 0, 0)
    },
    getNew: function () {
        var e = F.CRUDService.prototype.getNew.call(this);
        return this._project.hasCurrent() && (e._project = this._project.getCurrent()), e
    },
    getAll: function (e, t, i) {
        var n = this,
            r = e && e.project,
            o = r ? 0 : void 0 === i ? 60 : i,
            a = t || function () {
                return !0
            };
        if (this._lastSync && (new Date - this._lastSync) / 1e3 < o) return Q.resolve(this._entities.filter(a));
        var s = r || this._project.getCurrent();
        if (!this._pendingSync) {
            if (WS._2GO) this._pendingSync = this._workspace.getAll(this._className).then(function (e) {
                return e
            });
            else {
                var c = {
                    project: s
                };
                this._dataFilter.enhanceRead(c);
                var l = Q.defer();
                this._restClient.readAll(c, l.resolve, this._error.restHandler(l)), this._pendingSync = l.promise
            }
            this._pendingSync = this._pendingSync.then(function (e) {
                return n._pendingSync = void 0, n.updateInternalMultiple(e)
            }).then(function () {
                var e = n._entities,
                    t = 0;
                return e.forEach(function (e) {
                    e._project = s, t = Math.max(t, e._revision)
                }), t && n._revision.touch(s, t), n.setFlags(e), n._lastSync = r ? void 0 : new Date, e
            }, function (e) {
                throw n._pendingSync = void 0, e
            })
        }
        return this._pendingSync.then(function (e) {
            return e.filter(a)
        })
    },
    handleSingleEntity: function (e) {
        return this._workspace.addCustomAttributes([e])
    },
    handleEntityChanges: function (e, t, i) {
        return this._workspace.addCustomAttributes(e.concat(t)).then(F.CRUDService.prototype.handleEntityChanges.bind(this, e, t, i))
    },
    getAllFromServer: function (e) {
        if (WS._2GO) {
            var t = this;
            return this._workspace.getAll(this._className).then(function (e) {
                return t._serializer.read(e)
            })
        }
        var i = e && e.project || this._project.getCurrent(),
            n = {
                project: i
            };
        return F.CRUDService.prototype.getAllFromServer.call(this, n).then(function (e) {
            return e.forEach(function (e) {
                e._project = i
            }), e
        })
    },
    getByID: function (e, t, i) {
        var n = this,
            r = this._project.getCurrent(),
            o = t || {};
        this._dataFilter.enhanceRead(o), o.project = r;
        var a = WS._2GO;
        return F.CRUDService.prototype.getByID.call(this, e, o, a, i).then(function (e) {
            return e._project = r, n._revision.touch(r, e._revision), n.setFlags([e]), e
        })
    },
    create: function (e, t) {
        var i = t || {};
        i.project = e._project;
        var n = this;
        return F.CRUDService.prototype.create.call(this, e, i).then(function () {
            return n._revision.touch(e._project, e._revision, !0), n.setFlags([e]), e
        })
    },
    update: function (e, t) {
        var i = t || {};
        i.project = e._project, this._dataFilter.enhanceUpdate(i);
        var n = this;
        return F.CRUDService.prototype.update.call(this, e, i).then(function () {
            n._revision.touch(e._project, e._revision, !0), n.setFlags([e])
        }, function (t) {
            throw n._error.isExceptionType(t, "RevisionUnreadException") && (e.readJson(t._infos.Object), n._revision.touch(e._project, e._revision, !0), n.postUpdate(e), n.setFlags([e])), t
        })
    },
    remove: function (e, t) {
        var i = t || {};
        i.project = e._project, i.revision = e._revision, this._dataFilter.enhanceRemove(i);
        var n = this;
        return F.CRUDService.prototype.remove.call(this, e, i).fail(function (t) {
            throw n._error.isExceptionType(t, "RevisionUnreadException") && (e.readJson(t._infos.Object), n._revision.touch(e._project, e._revision, !0), n.postUpdate(e), n.setFlags([e])), t
        })
    },
    setFlags: function (e) {
        if (e.length) {
            var t = this,
                i = this._revision.getLastRead(e[0]._project),
                n = this._dataFilter.hasRoot();
            Q.all([this._login.getUsername(), this._login.isUser()]).spread(function (r, o) {
                var a = [];
                e.forEach(function (e) {
                    var t = e._hot,
                        s = e._writeLock;
                    e._hot = e._revision > i;
                    var c = o && (e._createdBy === r || e._writePublic),
                        l = e._temporary;
                    e._writeLock = !n && !c && !l, (t != e._hot || s != e._writeLock) && a.push(e)
                }), a.length > 0 && t.trigger("updateObjects", [a])
            }).done()
        }
    },
    clearCache: function () {
        this._lastSync = void 0, this._pendingSync = void 0
    }
}, F.extend("ProjectCRUDService", "CRUDService"), F.TransformationService = function (e, t, i, n, r, o, a, s, c) {
    F.ProjectCRUDService.call(this, "Transformation", F.Transformation, "/transformation", {}, e, t, i, n, r, o, a, s, c)
}, F.TransformationService.prototype = {
    inquireGlobalFolder: function (e) {
        var t = this;
        return this._workspace.inquireGlobalFolder(e).then(function (e) {
            return t.getAll(void 0, void 0, 0).then(function (t) {
                return F.findFirst(t, function (t) {
                    return t._UUID === e.UUID
                })
            })
        })
    }
}, F.extend("TransformationService", "ProjectCRUDService"), F.RootService = function (e, t, i, n, r, o, a, s, c) {
    F.ProjectCRUDService.call(this, "Workspace", F.Root, "/workspaceroot", {}, e, t, i, n, r, o, a, s, c)
}, F.extend("RootService", "ProjectCRUDService"), F.ProjectCRUDObject = function (e) {
    F.CRUDObject.call(this, e), this._exportVersion = void 0, this._class = void 0, this._createdBy = void 0, this._UUID = void 0, this._parentUUID = void 0, this._name = void 0, this._displayName = void 0, this._revision = void 0, this._category = void 0, this._tags = void 0, this._readPublic = void 0, this._readGroups = void 0, this._writePublic = void 0, this._writeGroups = void 0, this._project = void 0, this._writeLock = !1, this._hot = !1, this._ancestors = void 0
}, F.ProjectCRUDObject.prototype = {
    getID: function () {
        return this._UUID
    },
    readJson: function (e) {
        this._exportVersion = e.ExportVersion, this._class = e.Class, this._createdBy = e.CreatedBy, this._UUID = e.UUID, this._parentUUID = e.ParentUUID, this._name = e.Name, this._displayName = e.DisplayName, this._revision = e.Revision, this._category = e.Category, this._tags = e.Tags, this._readPublic = e.ReadPublic, this._readGroups = e.ReadGroups, this._writePublic = e.WritePublic, this._writeGroups = e.WriteGroups, WS._2GO && (this._revision = this._revision || 1, this._category = this._category || "", this._tags = this._tags || [], this._readPublic = this._readPublic || !1, this._readGroups = this._readGroups || [], this._writePublic = this._writePublic || !1, this._writeGroups = this._writeGroups || [])
    },
    writeJson: function () {
        var e = {};
        return e.ExportVersion = this._exportVersion, e.Class = this._class, e.CreatedBy = this._createdBy, e.UUID = this._UUID, e.ParentUUID = this._parentUUID, e.Name = this._name, e.DisplayName = this._displayName, e.Revision = this._revision, e.Category = this._category, e.Tags = this._tags, e.ReadPublic = this._readPublic, e.ReadGroups = this._readGroups, e.WritePublic = this._writePublic, e.WriteGroups = this._writeGroups, e
    },
    writeChanges: function () {
        var e = F.CRUDObject.prototype.writeChanges.call(this);
        return e.Revision = this._revision, e
    },
    matchesJson: function (e) {
        return this._UUID === e.UUID
    },
    canBeShownInView: function () {
        return !1
    }
}, F.extend("ProjectCRUDObject", "CRUDObject"), F.Transformation = function (e) {
    F.ProjectCRUDObject.call(this, e), this._trafoLocal = void 0, this._trafoGlobal = void 0, this._class = "Transformation"
}, F.Transformation.prototype = {
    readJson: function (e) {
        F.ProjectCRUDObject.prototype.readJson.call(this, e), this._trafoLocal = e.TransformationLocal, this._trafoGlobal = e.TransformationGlobal
    },
    writeJson: function () {
        var e = F.ProjectCRUDObject.prototype.writeJson.call(this);
        return e.Class = this._class, e.TransformationLocal = this._trafoLocal, e.TransformationGlobal = this._trafoGlobal, e
    },
    getTranslationGlobal: function () {
        return this._trafoGlobal ? mat4.getTranslation(this._trafoGlobal) : [0 / 0, 0 / 0, 0 / 0]
    },
    getTranslationLocal: function () {
        return this._trafoLocal ? mat4.getTranslation(this._trafoLocal) : [0 / 0, 0 / 0, 0 / 0]
    },
    getGlobalX: function () {
        return this._trafoGlobal ? this._trafoGlobal[12] : 0 / 0
    },
    getGlobalY: function () {
        return this._trafoGlobal ? this._trafoGlobal[13] : 0 / 0
    },
    getGlobalZ: function () {
        return this._trafoGlobal ? this._trafoGlobal[14] : 0 / 0
    },
    getLocalX: function () {
        return this._trafoLocal ? this._trafoLocal[12] : 0 / 0
    },
    getLocalY: function () {
        return this._trafoLocal ? this._trafoLocal[13] : 0 / 0
    },
    getLocalZ: function () {
        return this._trafoLocal ? this._trafoLocal[14] : 0 / 0
    },
    calcPositionInRefSystem: function (e, t) {
        return mat4.posInRefSystem(t || this.getTranslationGlobal(), e)
    },
    calcTrafoInRefSystem: function (e, t) {
        return mat4.trafoInRefSystem(t || this._trafoGlobal, e)
    },
    showLocalCoords: function () {
        return !mat4.equal(this._trafoGlobal, this._trafoLocal)
    }
}, F.extend("Transformation", "ProjectCRUDObject"), F.Root = function (e) {
    F.Transformation.call(this, e), this._class = "Workspace"
}, F.Root.prototype = {
    writeJson: function () {
        var e = F.Transformation.prototype.writeJson.call(this);
        return e.Class = "Workspace", e
    }
}, F.extend("Root", "Transformation"), F.HyperlinkedObject = {
    readHyperlinksJson: function (e) {
        var t = e.Hyperlinks,
            i = e.HyperlinksDescriptions,
            n = t.length;
        if (!i || i.length !== t.length) {
            i = [];
            for (var r = 0; n > r; r++) i.push(t[r])
        }
        this._hyperlinks = [];
        for (var o = 0; n > o; o++) this._hyperlinks.push(new F.Hyperlink(t[o], i[o]))
    },
    writeHyperlinksJson: function (e) {
        return e.Hyperlinks = [], e.HyperlinksDescriptions = [], this._hyperlinks.forEach(function (t) {
            e.Hyperlinks.push(t._url), e.HyperlinksDescriptions.push(t._description)
        }), e
    },
    writeHyperlinksChanges: function (e) {
        return void 0 !== this._changes._hyperlinks && (e.Hyperlinks = [], e.HyperlinksDescriptions = [], this._changes._hyperlinks.forEach(function (t) {
            e.Hyperlinks.push(t._url), e.HyperlinksDescriptions.push(t._description)
        })), e
    }
}, F.defineMixin("HyperlinkedObject"), F.DI().registerService("revision", F.RevisionService, "$http", "@error", "@project", "@cookie"), F.DI().registerService("workspace", F.WorkspaceService, "@error", "@project", "@plug", "$http"), F.isLocked = function (e) {
    return e._writeLock
}, F.isUnlocked = function (e) {
    return !e._writeLock
}, F.Unit = function (e, t, i, n, r) {
    this._conversionFactors = e, this._precisionOffsets = t, this._strings = i, this._unit = n, this._inverse = r || !1
}, F.Unit.prototype = {
    getExactValue: function (e) {
        return this.convertFromBaseUnit(e)
    },
    getValue: function (e, t, i) {
        if (0 === e) return "0";
        var n = this.determinePrecision(t, i),
            r = this.convertFromBaseUnit(e, i);
        return n >= 1 ? r.toFixed(n) : Math.round(r).toString()
    },
    getValueAndUnitString: function (e, t, i) {
        return this.getValue(e, t, i) + " " + this.getUnitString(i)
    },
    getUnitString: function (e) {
        var t = e !== !0 ? this._unit : this.getSmallestUnit();
        return (this._inverse ? "/" : "") + this._strings[t]
    },
    convertToBaseUnit: function (e) {
        var t = this._conversionFactors[this._unit];
        return this._inverse ? e * t : e / t
    },
    convertFromBaseUnit: function (e, t) {
        var i = t !== !0 ? this._unit : this.getSmallestUnit(),
            n = this._conversionFactors[i];
        return this._inverse ? e / n : e * n
    },
    determinePrecision: function (e, t) {
        var i = t !== !0 ? this._unit : this.getSmallestUnit(),
            n = this._precisionOffsets[i],
            r = this._inverse ? e - n : e + n;
        return Math.max(0, r)
    },
    setUnit: function (e) {
        "number" == typeof this._conversionFactors[e] && (this._unit = e)
    },
    getSmallestUnit: function () {
        return this._unit
    }
}, F.extend("Unit"), F.Unit.calcPrecisionOffsets = function (e) {
    var t = {};
    for (var i in e) t[i] = Math.round(-F.log10(e[i]));
    return t
}, F.LengthUnit = function (e, t) {
    var i = e ? e : F.LengthUnit.m;
    F.Unit.call(this, F.LengthUnit.ConversionFactors, F.LengthUnit.PrecisionOffsets, F.LengthUnit.Strings, i, t || !1)
}, F.LengthUnit.prototype = {
    getSmallestUnit: function () {
        switch (this._unit) {
            case "km":
            case "m":
            case "dm":
            case "cm":
            case "mm":
                return "mm";
            case "mi":
            case "yd":
            case "ft":
            case "in":
                return "in";
            case "ydUS":
            case "ftUS":
            case "inUS":
                return "inUS";
            default:
                return this._unit
        }
    }
}, F.extend("LengthUnit", "Unit"), F.LengthUnit.km = "km", F.LengthUnit.m = "m", F.LengthUnit.dm = "dm", F.LengthUnit.cm = "cm", F.LengthUnit.mm = "mm", F.LengthUnit.mi = "mi", F.LengthUnit.yd = "yd", F.LengthUnit.ft = "ft", F.LengthUnit["in"] = "in", F.LengthUnit.ydUS = "ydUS", F.LengthUnit.ftUS = "ftUS", F.LengthUnit.inUS = "inUS", F.LengthUnit.Strings = {
    km: "km",
    m: "m",
    dm: "dm",
    cm: "cm",
    mm: "mm",
    mi: "mi",
    yd: "yd",
    ft: "ft",
    "in": "in",
    ydUS: "yd US",
    ftUS: "ft US",
    inUS: "in US"
}, F.LengthUnit.ConversionFactors = {
    km: .001,
    m: 1,
    dm: 10,
    cm: 100,
    mm: 1e3,
    mi: 1 / 1609.344,
    yd: 1 / .9144,
    ft: 1 / .3048,
    "in": 1 / .0254,
    ydUS: 1 / (3600 / 3937),
    ftUS: 1 / (1200 / 3937),
    inUS: 39.37
}, F.LengthUnit.PrecisionOffsets = F.Unit.calcPrecisionOffsets(F.LengthUnit.ConversionFactors), F.LengthUnit.PrecisionOffsets.ft = F.LengthUnit.PrecisionOffsets.ftUS = 0, F.LengthUnit.PrecisionOffsets.in = F.LengthUnit.PrecisionOffsets.inUS = -1, F.AreaUnit = function (e, t) {
    var i = e ? e : F.AreaUnit.m;
    F.Unit.call(this, F.AreaUnit.ConversionFactors, F.AreaUnit.PrecisionOffsets, F.AreaUnit.Strings, i, t || !1)
}, F.extend("AreaUnit", "Unit"), F.AreaUnit.km = "km", F.AreaUnit.ha = "ha", F.AreaUnit.a = "a", F.AreaUnit.m = "m", F.AreaUnit.dm = "dm", F.AreaUnit.cm = "cm", F.AreaUnit.mm = "mm", F.AreaUnit.mi = "mi", F.AreaUnit.ac = "ac", F.AreaUnit.yd = "yd", F.AreaUnit.ft = "ft", F.AreaUnit["in"] = "in", F.AreaUnit.ydUS = "ydUS", F.AreaUnit.ftUS = "ftUS", F.AreaUnit.inUS = "inUS", F.AreaUnit.Strings = {
    km: "km",
    ha: "ha",
    a: "a",
    m: "m",
    dm: "dm",
    cm: "cm",
    mm: "mm",
    mi: "mi",
    ac: "ac",
    yd: "yd",
    ft: "ft",
    "in": "in",
    ydUS: "yd US",
    ftUS: "ft US",
    inUS: "in US"
}, F.AreaUnit.ConversionFactors = {
    km: 1e-6,
    ha: 1e-4,
    a: .01,
    m: 1,
    dm: 100,
    cm: 1e4,
    mm: 1e6,
    mi: 1 / 2589988.11034,
    ac: 1 / 4046.8564224,
    yd: 1 / .83612736,
    ft: 1 / .09290304,
    "in": 1 / 64516e-8,
    ydUS: 1 / Math.pow(3600 / 3937, 2),
    ftUS: 1 / Math.pow(1200 / 3937, 2),
    inUS: 1 / Math.pow(1200 / 3937 / 12, 2)
}, F.AreaUnit.PrecisionOffsets = F.Unit.calcPrecisionOffsets(F.AreaUnit.ConversionFactors), F.AngleUnit = function (e, t) {
    var i = e || F.AngleUnit.rad;
    F.Unit.call(this, F.AngleUnit.ConversionFactors, F.AngleUnit.PrecisionOffsets, F.AngleUnit.Strings, i, t || !1)
}, F.extend("AngleUnit", "Unit"), F.AngleUnit.rad = "rad", F.AngleUnit.deg = "deg", F.AngleUnit.gon = "gon", F.AngleUnit.Strings = {
    rad: "rad",
    deg: "deg",
    gon: "gon"
}, F.AngleUnit.ConversionFactors = {
    rad: 1,
    deg: 180 / Math.PI,
    gon: 200 / Math.PI
}, F.AngleUnit.PrecisionOffsets = F.Unit.calcPrecisionOffsets(F.AngleUnit.ConversionFactors), F.UnitServiceBase = function (e) {
    F.PlugModule.call(this, e);
    this._lengthUnit = new F.LengthUnit, this._inverseLengthUnit = new F.LengthUnit, this._inverseLengthUnit._inverse = !0, this._areaUnit = new F.AreaUnit, this._angleUnit = new F.AngleUnit, this.provideMalePlug("SettingsUpdate", ["updateSettings"])
}, F.UnitServiceBase.prototype = {
    getLengthUnit: function () {
        return this._lengthUnit._unit
    },
    getLengthUnitString: function (e, t) {
        return e ? "[" + this._lengthUnit.getUnitString(t) + "]" : this._lengthUnit.getUnitString(t)
    },
    getAreaUnit: function () {
        return this._areaUnit._unit
    },
    getAreaUnitString: function (e) {
        return e ? "[" + this._areaUnit.getUnitString() + "]" : this._areaUnit.getUnitString()
    },
    getAngleUnit: function () {
        return this._angleUnit._unit
    },
    getAngleUnitString: function (e) {
        return e ? "[" + this._angleUnit.getUnitString() + "]" : this._angleUnit.getUnitString()
    },
    getExactLength: function (e) {
        return this._lengthUnit.getExactValue(e)
    },
    getExactArea: function (e) {
        return this._areaUnit.getExactValue(e)
    },
    getExactAngle: function (e) {
        return this._angleUnit.getExactValue(e)
    },
    getLength: function (e, t, i) {
        return this._lengthUnit.getValue(e, t, i)
    },
    getArea: function (e, t) {
        return this._areaUnit.getValue(e, t)
    },
    getAngle: function (e, t) {
        return this._angleUnit.getValue(e, t)
    },
    getLengthAndUnit: function (e, t, i) {
        return this._lengthUnit.getValueAndUnitString(e, t, i)
    },
    getAreaAndUnit: function (e, t) {
        return this._areaUnit.getValueAndUnitString(e, t)
    },
    getAngleAndUnit: function (e, t) {
        return this._angleUnit.getValueAndUnitString(e, t)
    },
    removeInternal: function () {
        this.setLengthUnit(F.LengthUnit.m), this.setAreaUnit(F.AreaUnit.m), this.setAngleUnit(F.AngleUnit.deg)
    },
    setLengthUnit: function (e) {
        this._lengthUnit.setUnit(e), this._inverseLengthUnit.setUnit(e)
    },
    setAreaUnit: function (e) {
        this._areaUnit.setUnit(e)
    },
    setAngleUnit: function (e) {
        this._angleUnit.setUnit(e)
    },
    getResolution: function (e, t, i) {
        var n = this._inverseLengthUnit.getValue(e, t) + " " + i + this._inverseLengthUnit.getUnitString();
        return n
    }
}, F.extend("UnitServiceBase", "PlugModule"), F.DI().registerService("unit", F.UnitServiceBase, "@plug"), angular.module("f.unit").filter("unit", function () {
    var e = F.DI().getService("unit");
    return function (t, i, n, r, o) {
        if (void 0 === t) return "";
        if (i = void 0 === i ? 3 : i, n = void 0 === n ? !0 : n, o = void 0 === o ? !1 : o, r) return e.getLength(t, i, o);
        var a = e.getLengthAndUnit(t, i, o);
        return n && (a = a.replace(/ /g, "")), a
    }
}), angular.module("f.unit").filter("resolution", function () {
    var e = F.DI().getService("unit");
    return function (t, i, n, r) {
        if (void 0 === t) return "";
        i = void 0 === i ? 2 : i, n = void 0 === n ? "px" : n, r = void 0 === r ? !0 : r;
        var o = e.getResolution(t, i, n);
        return r && (o = o.replace(/ /g, "")), o
    }
}), angular.module("f.unit").filter("areaunit", function () {
    var e = F.DI().getService("unit");
    return function (t, i, n, r) {
        if (void 0 === t) return "";
        if (void 0 === n && (n = !0), i = void 0 !== i ? i : 4, r) return e.getArea(t, i);
        var o = e.getAreaAndUnit(t, i);
        return n && (o = o.replace(/ /g, "")), o
    }
}), angular.module("f.unit").filter("angleunit", function () {
    var e = F.DI().getService("unit");
    return function (t, i, n, r) {
        if (void 0 === t) return "";
        if (void 0 === n && (n = !0), i = void 0 !== i ? i : 4, r) return e.getAngle(t, i);
        var o = e.getAngleAndUnit(t, i);
        return n && (o = o.replace(/ /g, "")), o
    }
}),
function () {
    var e = function (e, t, i, n, r) {
        if ("undefined" == typeof t) return "";
        void 0 === n && (n = !0), i = "undefined" != typeof i ? i : 3;
        for (var o, a = "", s = t.length, c = 0; s > c; c++) o = r ? e.getLengthAndUnit(t[c], i) : e.getLength(t[c], i), n && (o = o.replace(/ /g, "")), a += o, c !== s - 1 && (a += ", ");
        return a
    };
    angular.module("f.unit").filter("pos", function () {
        var t = F.DI().getService("unit");
        return function (i, n, r) {
            return e(t, i, n, r, !0)
        }
    }), angular.module("f.unit").filter("pos2d", function () {
        var t = F.DI().getService("unit");
        return function (i, n, r) {
            return i ? e(t, [i[0], i[1]], n, r, !0) : void 0
        }
    }), angular.module("f.unit").filter("pos_short", function () {
        var t = F.DI().getService("unit");
        return function (i, n) {
            return e(t, i, n, !1, !1)
        }
    }), angular.module("f.unit").filter("pos_short_multi", function () {
        var t = F.DI().getService("unit");
        return function (i, n) {
            if ("undefined" == typeof i) return "";
            for (var r = "", o = i.length, a = o - 1, s = 0; o > s; ++s) r += e(t, i[s], n, !1, !1), s !== a && (r += "\n");
            return r
        }
    })
}(), angular.module("f.unit").filter("addlengthunit", function () {
    var e = F.DI().getService("unit");
    return function (t) {
        var i = t;
        return void 0 !== e && (i = i + " (" + e.getLengthUnit() + ")"), i
    }
}), F.ColorGenerator = function () {
}, F.extend("ColorGenerator"), F.hexChars = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F"], F.ColorGenerator.hexColorFromInt = function (e) {
    if (!e) return "#000000";
    for (var t = 16777215 & e, i = "", n = 0; 6 > n; n++) i = F.hexChars[15 & t] + i, t >>= 4;
    return "#" + i
}, F.ColorGenerator.intColorFromString = function (e) {
    return e ? 16777215 & F.crc32(e) : 0
}, F.ColorGenerator.hexColorFromString = function (e) {
    var t = F.ColorGenerator.intColorFromString(e);
    return F.ColorGenerator.hexColorFromInt(t)
}, F.ColorGenerator.rgbColorFromInt = function (e) {
    var t = F.ColorGenerator.hexColorFromInt(e),
        i = F.ColorGenerator.hexToRGBA(t),
        n = F.ColorGenerator.intColorToDbl(i);
    return n
}, F.ColorGenerator.isHexColor = function (e, t) {
    return 9 !== e.length || t ? /(^#[0-9A-F]{6}$)/i.test(e) : /(^#[0-9A-F]{8}$)|(^#[0-9A-F]{6}$)/i.test(e)
}, F.ColorGenerator.hexToRGBA = function (e, t) {
    e = e.substr(1);
    var i, n, r, o, a = parseInt(e, 16);
    return 8 === e.length ? (i = a >> 24 & 255, n = a >> 16 & 255, r = a >> 8 & 255, o = 255 & a) : (i = a >> 16 & 255, n = a >> 8 & 255, r = 255 & a, o = 255), t ? [i, n, r, o] : [i, n, r]
}, F.ColorGenerator.rgbaToHex = function (e, t) {
    var i, n = function (e) {
            var t = e.toString(16);
            return 1 === t.length ? "0" + t : t
        },
        r = n(e[0]),
        o = n(e[1]),
        a = n(e[2]);
    return i = t ? 4 === e.length ? n(e[3]) : "FF" : "", "#" + r + o + a + i
}, F.ColorGenerator.intColorToDbl = function (e) {
    for (var t = [], i = 0, n = e.length; n > i; ++i) t[i] = e[i] / 255;
    return t
}, F.ImageResolution = function (e, t, i, n) {
    this._width = e, this._height = t, this._id = i, this._resourceKeyForName = n
}, F.ImageResolution.prototype = {
    getName: function () {
        return this._resourceKeyForName
    },
    getId: function () {
        return this._id
    }
}, F.extend("ImageResolution"), F.ColorMode = function (e, t) {
    this._id = e, this._resourceKeyForName = t
}, F.ColorMode.prototype = {
    getName: function () {
        return this._resourceKeyForName
    }
}, F.extend("ColorMode"), F.BaseAdapter = function (e, t) {
    this._node = e, this._handlerStack = t, this._onEventProxied = F.proxy(this.onEvent, this)
}, F.BaseAdapter.prototype = {
    setHandlerStack: function (e) {
        this._handlerStack = e
    },
    callHandlerStack: function (e, t, i) {
        for (var n = !1, r = this._handlerStack.length - 1; r >= 0 && !n; r--) {
            var o = this._handlerStack[r];
            o[t] && (n = o[t].apply(o, i))
        }
        n && e.stopPropagation()
    }
}, F.MouseAdapter = function (e, t, i) {
    F.BaseAdapter.call(this, e, t), this._captureConfig = i, this._capture = i === F.MouseAdapter.Capture.On, this._state = F.MouseAdapter.States.initial, this._button = void 0, this._dragStart = void 0, this._dragLast = void 0, this._scrollLast = 0, this._scrollInitDistance = 100, this._timeLastClick = 0, this._timeLastDown = 0, this._lastClick = void 0, this._holdFirst = void 0, this._holdLast = void 0, this._holdClose = !0, this._holdTimeout = void 0, this._isTouchScrolling = !1, this._isTouchPanning = !1, this._preventClick = !1, this._pickDuration = 0, this.listenersOnOff("on")
}, F.MouseAdapter.prototype = {
    initState: function () {
        this._state = F.MouseAdapter.States.initial, this._button = void 0, this._dragStart = void 0, this._dragLast = void 0, this._scrollLast = 0, this._scrollInitDistance = 100, this._timeLastClick = 0, this._timeLastDown = 0, this._lastClick = void 0, this._holdFirst = void 0, this._holdLast = void 0, this._holdClose = !0, this._holdTimeout = void 0, this._isTouchScrolling = !1, this._isTouchPanning = !1, this._preventClick = !1
    },
    initial: function () {
        this._state = F.MouseAdapter.States.initial, this._button = void 0, this._dragStart = void 0, this._dragLast = void 0, this._scrollLast = void 0, this._holdFirst = void 0, this._holdLast = void 0, this._holdClose = !0, this._holdTimeout = void 0, this._isTouchScrolling = !1, this._isTouchPanning = !1, this._preventClick = !1, this.updateCaptureMode()
    },
    setNode: function (e) {
        this.listenersOnOff("off"), this.initState(), this._node = e, this.listenersOnOff("on")
    },
    updateCaptureMode: function () {
        var e, t = this._capture;
        switch (this._captureConfig) {
            case F.MouseAdapter.Capture.Off:
                e = !1;
                break;
            case F.MouseAdapter.Capture.On:
                e = !0;
                break;
            case F.MouseAdapter.Capture.DragOnly:
                e = this._state === F.MouseAdapter.States.drag
        }
        e !== t && (this.listenersOnOff("off"), this._capture = e, this.listenersOnOff("on"))
    },
    pageToNodeX: function (e) {
        var t = this._node,
            i = 0;
        do i += t.offsetLeft, t = t.offsetParent; while (t);
        return e - i
    },
    pageToNodeY: function (e) {
        var t = this._node,
            i = 0;
        do i += t.offsetTop, t = t.offsetParent; while (t);
        return e - i
    },
    listenersOnOff: function (e) {
        var t = this._onEventProxied,
            i = $(this._capture ? window : this._node);
        i[e]("touchstart touchmove touchend", t), i[e]("mousedown mousemove mouseup", t), this._capture || $(this._node)[e]("mouseleave", t), $(this._node)[e]("mousewheel DOMMouseScroll", t)
    },
    toEventEnum: function (e) {
        var t = e.button,
            i = e.originalEvent.touches ? e.originalEvent.touches.length : 0;
        switch (e.type) {
            case "mousemove":
                return F.MouseAdapter.Events.mouseMove;
            case "touchmove":
                return 1 === i || 2 === i ? F.MouseAdapter.Events.touchMove : F.MouseAdapter.Events.unknown;
            case "mousedown":
                return 0 === t || 1 === t || 2 === t ? F.MouseAdapter.Events.mouseDown : F.MouseAdapter.Events.unknown;
            case "mouseup":
                return 0 === t || 1 === t || 2 === t ? F.MouseAdapter.Events.mouseUp : F.MouseAdapter.Events.unknown;
            case "touchstart":
                return 1 === i ? F.MouseAdapter.Events.touchStartOneFinger : 2 === i ? F.MouseAdapter.Events.touchStartTwoFinger : F.MouseAdapter.Events.unknown;
            case "touchend":
                return 1 === i ? F.MouseAdapter.Events.touchEndTwoFinger : i ? F.MouseAdapter.Events.unknown : F.MouseAdapter.Events.touchEndOneFinger;
            case "mousewheel":
            case "DOMMouseScroll":
                return F.MouseAdapter.Events.mouseScroll;
            case "mouseleave":
                return F.MouseAdapter.Events.mouseLeave;
            default:
                return F.MouseAdapter.Events.unknown
        }
    },
    isTouchEvent: function (e) {
        return e.type.indexOf("touch") > -1
    },
    getPositionOfFingers: function (e) {
        var t, i, n = e.originalEvent.touches;
        if (!n) return [t, i];
        var r = e.originalEvent.changedTouches;
        if (0 === n.length && r) 1 <= r.length && (t = {
            x: this.pageToNodeX(r[0].pageX),
            y: this.pageToNodeY(r[0].pageY)
        }), 2 <= r.length && (i = {
            x: this.pageToNodeX(r[1].pageX),
            y: this.pageToNodeY(r[1].pageY)
        });
        else if (1 === n.length) {
            if (t = {
                    x: this.pageToNodeX(n[0].pageX),
                    y: this.pageToNodeY(n[0].pageY)
                }, r && 1 <= r.length) {
                var o = n[0],
                    a = r[0];
                (o.identifier !== a.identifier || o.pageX !== a.pageX || o.pageY !== a.pageY || o.screenX !== a.screenX || o.screenY !== a.screenY) && (i = {
                    x: this.pageToNodeX(r[0].pageX),
                    y: this.pageToNodeY(r[0].pageY)
                })
            }
        } else 2 <= n.length && (t = {
            x: this.pageToNodeX(n[0].pageX),
            y: this.pageToNodeY(n[0].pageY)
        }, i = {
            x: this.pageToNodeX(n[1].pageX),
            y: this.pageToNodeY(n[1].pageY)
        });
        return [t, i]
    },
    getDistanceBetweenFingers: function (e, t, i) {
        var n = 1;
        if (t && i) {
            var r = t.x - i.x,
                o = t.y - i.y;
            n = Math.max(1, Math.sqrt(r * r + o * o))
        }
        return n
    },
    getMousePosition: function (e) {
        return void 0 !== e.pageX && void 0 !== e.pageY ? {
            x: this.pageToNodeX(e.pageX),
            y: this.pageToNodeY(e.pageY)
        } : void 0
    },
    getScrollCurrent: function (e, t, i) {
        var n = this.getDistanceBetweenFingers(e, t, i),
            r = n / this._scrollInitDistance;
        return r = 1 > r ? -1 / r + 1 : r - 1, r = -20 * r
    },
    onEvent: function (e) {
        e.preventDefault();
        {
            var t = this.getNowMillis(),
                i = this.toEventEnum(e),
                n = this._state,
                r = e.button,
                o = F.MouseAdapter.Events.mouseDown,
                a = F.MouseAdapter.Events.mouseMove,
                s = F.MouseAdapter.Events.mouseUp,
                c = F.MouseAdapter.Events.mouseScroll,
                l = F.MouseAdapter.Events.touchStartOneFinger,
                h = F.MouseAdapter.Events.touchStartTwoFinger,
                d = F.MouseAdapter.Events.touchMove,
                u = F.MouseAdapter.Events.touchEndOneFinger,
                _ = F.MouseAdapter.Events.touchEndTwoFinger;
            F.MouseAdapter.Events.mouseLeave, F.MouseAdapter.Events.unknown
        }
        if (i === c) return void this.mouseScroll(e);
        var p = this.getPositionOfFingers(e),
            g = p[0],
            f = p[1],
            m = g && f ? {
                x: (g.x + f.x) / 2,
                y: (g.y + f.y) / 2
            } : void 0,
            v = this.getMousePosition(e),
            S = v || g,
            b = r === F.MouseAdapter.Button.Left || void 0 === r,
            y = i === o || i === l,
            P = i === a || i === d,
            M = i === s || i === u,
            w = i === l,
            C = i === d,
            T = i === h,
            W = i === _;
        switch (n) {
            case F.MouseAdapter.States.initial:
                y ? (this._preventClick = !1, this.startDrag(e, S), w && b && this.holdTimeout(e, S)) : T && (this.startScroll(e, g, f), this.startDragTwoFingers(e, m));
                break;
            case F.MouseAdapter.States.drag:
                y ? void 0 === this._button && (this._preventClick = !1, this.startDrag(e, S), w && b && this.holdTimeout(e, S)) : P ? C && b && !this._preventClick && this.isHold(e, S, this._dragStart, t, this._timeLastDown) ? this.startHold(e, S) : (this.moveDrag(e, S), C && b && !this._preventClick && this.isHoldByDist(e, S, this._dragStart) ? this.holdTimeout(e, S) : this._holdTimeout = void 0) : M ? (this._button === r || void 0 === this._button) && (!this._preventClick && this.isClick(e, S, this._dragStart) && this.click(e, S), this.stopDrag(e, S)) : T ? (this.stopDrag(e, S), this.startScroll(e, g, f), this.startDragTwoFingers(e, m)) : this.stopDrag(e, S);
                break;
            case F.MouseAdapter.States.scrollDrag:
                if (y) this.stopDragTwoFingers(e, m), this.stopScroll(e), void 0 === this._button && (this._preventClick = !0, this.startDrag(e, S));
                else if (T) this.startScroll(e, g, f), this.startDragTwoFingers(e, m);
                else if (C) {
                    var I = this.getDistanceBetweenFingers(e, g, f);
                    if (this.isTouchScrolling(I, this._scrollInitDistance)) {
                        var L = this.getScrollCurrent(e, g, f);
                        this.moveScroll(e, L)
                    }
                    this.isTouchPanning(m, this._dragStart) && this.moveDragTwoFingers(e, m)
                } else this.stopDragTwoFingers(e, m), this.stopScroll(e);
                break;
            case F.MouseAdapter.States.stopScrollDrag:
                y ? void 0 === this._button && (this._preventClick = !0, this.startDrag(e, S)) : P ? (this._preventClick = !0, this.startDrag(e, S)) : this.initial();
                break;
            case F.MouseAdapter.States.hold:
                P ? this.moveHold(e, S) : T ? this.startHoldDrag(e, f) : y || this.stopHold(e, S);
                break;
            case F.MouseAdapter.States.holdDrag:
                W || g && !f ? this.stopHoldDrag(e) : M ? (this.stopHoldDrag(e), this.stopHold(e, S)) : C ? (this.moveHold(e, g), this.moveHoldDrag(e, f)) : y || T || (this.stopHoldDrag(e), this.stopHold(e, S))
        }
    },
    startDrag: function (e, t) {
		//disable chuot phai
        this._state = F.MouseAdapter.States.drag, this._button = e.button, this._dragStart = t, this._dragLast = t, this._timeLastDown = this.getNowMillis();
        var i = this._button || F.MouseAdapter.Button.Left;
        this.callHandlerStack(e, "onDragStart", [t.x, t.y, i]), this.updateCaptureMode(), this._node && $(this._node).focus()
    },
    moveDrag: function (e, t) {
        if (t.x !== this._dragLast.x || t.y !== this._dragLast.y) {
            var i = this._button || F.MouseAdapter.Button.Left;
            this.callHandlerStack(e, "onDragMove", [t.x, t.y, this._dragLast.x, this._dragLast.y, i]), this._dragLast = t
        }
    },
    stopDrag: function (e, t) {
        var i = this._button || F.MouseAdapter.Button.Left;
        this.callHandlerStack(e, "onDragStop", [t.x, t.y, i]), this._button = void 0, this.initial()
    },
    click: function (e, t) {
        var i = this._button || F.MouseAdapter.Button.Left,
            n = this.getNowMillis(),
            r = this.isTouchEvent(e),
            o = this.isDblClick(e, t, this._lastClick, n, this._timeLastClick);
        this._pickDuration = 0, o ? (this.callHandlerStack(e, "onDblClick", [this._lastClick.x, this._lastClick.y, i, r]), this._timeLastClick = 0, this._lastClick = void 0) : (this.callHandlerStack(e, "onClick", [t.x, t.y, i, r]), this._timeLastClick = n, this._lastClick = t)
	},
    mouseScroll: function (e) {
        var t = e.originalEvent.wheelDelta / 60 || -e.originalEvent.detail,
            i = this._state;
        this.startScroll(e), this.moveScroll(e, -t), this.stopScroll(e), this._state = i
    },
    startScroll: function (e, t, i) {
        this._state = F.MouseAdapter.States.scrollDrag, this._scrollLast = 0, this._scrollInitDistance = this.getDistanceBetweenFingers(e, t, i), this.callHandlerStack(e, "onScrollStart")
    },
    moveScroll: function (e, t) {
        var i = t - this._scrollLast;
        i && this.callHandlerStack(e, "onScroll", [i, this.isTouchEvent(e)]), this._scrollLast = t
    },
    stopScroll: function (e) {
        this._state = F.MouseAdapter.States.stopScrollDrag, this.callHandlerStack(e, "onScrollStop"), this._scrollLast = 0
    },
    startDragTwoFingers: function (e, t) {
        this._dragStart = t, this._dragLast = t, this.callHandlerStack(e, "onDragStart", [t.x, t.y, F.MouseAdapter.Button.Middle])
    },
    moveDragTwoFingers: function (e, t) {
        (t.x !== this._dragLast.x || t.y !== this._dragLast.y) && (this.callHandlerStack(e, "onDragMove", [t.x, t.y, this._dragLast.x, this._dragLast.y, F.MouseAdapter.Button.Middle]), this._dragLast = t)
    },
    stopDragTwoFingers: function (e, t) {
        this.callHandlerStack(e, "onDragStop", [t.x, t.y, F.MouseAdapter.Button.Middle])
    },
    startHold: function (e, t) {
        this._state = F.MouseAdapter.States.hold, this._holdFirst = t, this._holdLast = t;
        var i = F.MouseAdapter.Button.Left;
        this.callHandlerStack(e, "onHoldStart", [t.x, t.y, i])
    },
    moveHold: function (e, t) {
        if (t.x !== this._holdLast.x || t.y !== this._holdLast.y) {
            var i = F.MouseAdapter.Button.Left;
            this.callHandlerStack(e, "onHoldMove", [t.x, t.y, this._holdLast.x, this._holdLast.y, this._holdFirst.x, this._holdFirst.y, i]), this._holdLast = t
        }
    },
    stopHold: function (e, t) {
        this._state = F.MouseAdapter.States.drag;
        var i = F.MouseAdapter.Button.Left;
        this.callHandlerStack(e, "onHoldStop", [t.x, t.y, i]), this.stopDrag(e, t)
    },
    startHoldDrag: function (e, t) {
        this._state = F.MouseAdapter.States.holdDrag, this._dragStart = t, this._dragLast = t;
        var i = F.MouseAdapter.Button.Left;
        this.callHandlerStack(e, "onDragStart", [t.x, t.y, i])
    },
    moveHoldDrag: function (e, t) {
        if (t.x !== this._dragLast.x || t.y !== this._dragLast.y) {
            var i = F.MouseAdapter.Button.Left;
            this.callHandlerStack(e, "onDragMove", [t.x, t.y, this._dragLast.x, this._dragLast.y, i]), this._dragLast = t
        }
    },
    stopHoldDrag: function (e) {
        this._state = F.MouseAdapter.States.hold;
        var t = F.MouseAdapter.Button.Left;
        this.callHandlerStack(e, "onDragStop", [this._dragLast.x, this._dragLast.y, t])
    },
    holdTimeout: function (e, t) {
        var i = F.MouseAdapter.HOLD_WAITTIME_TOUCH,
            n = this,
            r = setTimeout(function () {
                n._holdTimeout === r && n._state === F.MouseAdapter.States.drag && n.startHold(e, t)
            }, i);
        this._holdTimeout = r
    },
    isClick: function (e, t, i) {
        var n = t.x - i.x,
            r = t.y - i.y,
            o = n * n + r * r;
        return o < (this.isTouchEvent(e) ? F.MouseAdapter.CLICK_SQDIST_TOUCH : F.MouseAdapter.CLICK_SQDIST)
    },
    isDblClick: function (e, t, i, n, r) {
        return this.isDblClickByTime(e, n, r) && i && this.isDblClickByDist(e, t, i)
    },
    isDblClickByTime: function (e, t, i) {
        var n = t - i,
            r = this.getDblClickWaitTime(e);
        return r > n
    },
    getDblClickWaitTime: function (e) {
        return Math.max(this.getDefaultDblClickWaitTime(e), this._pickDuration + F.MouseAdapter.DBLCLICK_PICK_TIME_ADDITION)
    },
    getDefaultDblClickWaitTime: function (e) {
        return "boolean" == typeof e ? e ? F.MouseAdapter.DBLCLICK_WAITTIME_TOUCH : F.MouseAdapter.DBLCLICK_WAITTIME : this.isTouchEvent(e) ? F.MouseAdapter.DBLCLICK_WAITTIME_TOUCH : F.MouseAdapter.DBLCLICK_WAITTIME
    },
    setPickDuration: function (e) {
        this._pickDuration = e
    },
    isDblClickByDist: function (e, t, i) {
        var n = t.x - i.x,
            r = t.y - i.y,
            o = n * n + r * r;
        return o < (this.isTouchEvent(e) ? F.MouseAdapter.DBLCLICK_SQDIST_TOUCH : F.MouseAdapter.DBLCLICK_SQDIST)
    },
    isHold: function (e, t, i, n, r) {
        return this.isHoldByDist(e, t, i) && this.isHoldByTime(e, n, r)
    },
    isHoldByDist: function (e, t, i) {
        var n = t.x - i.x,
            r = t.y - i.y,
            o = n * n + r * r;
        return this._holdClose = this._holdClose && o < (this.isTouchEvent(e) ? F.MouseAdapter.HOLD_SQDIST_TOUCH : F.MouseAdapter.HOLD_SQDIST), this._holdClose
    },
    isHoldByTime: function (e, t, i) {
        return F.MouseAdapter.HOLD_WAITTIME_TOUCH < t - i
    },
    isTouchScrolling: function (e, t) {
        return this._isTouchScrolling = !this._isTouchPanning && (this._isTouchScrolling || F.MouseAdapter.SCROLL_DIST_TOUCH <= Math.abs(e - t)), this._isTouchScrolling
    },
    isTouchPanning: function (e, t) {
        if (e) {
            var i = e.x - t.x,
                n = e.y - t.y,
                r = i * i + n * n;
            this._isTouchPanning = !this._isTouchScrolling && (this._isTouchPanning || F.MouseAdapter.PAN_SQDIST_TOUCH <= r)
        } else this._isTouchPanning = !1;
        return this._isTouchPanning
    },
    getNowMillis: function () {
        return Date.now()
    }
}, F.extend("MouseAdapter", "BaseAdapter"), F.MouseAdapter.Button = {
    Left: 0,
    Middle: 1,
    Right: 2
}, F.MouseAdapter.Capture = {
    Off: 0,
    On: 1,
    DragOnly: 2
}, F.MouseAdapter.Events = {
    mouseDown: 1,
    mouseMove: 2,
    mouseUp: 3,
    mouseScroll: 4,
    touchStartOneFinger: 5,
    touchStartTwoFinger: 6,
    touchMove: 7,
    touchEndOneFinger: 8,
    touchEndTwoFinger: 9,
    mouseLeave: 10,
    unknown: 11
}, F.MouseAdapter.States = {
    initial: 1,
    drag: 2,
    scrollDrag: 3,
    stopScrollDrag: 4,
    hold: 5,
    holdDrag: 6
}, F.MouseAdapter.CLICK_SQDIST = 16, F.MouseAdapter.CLICK_SQDIST_TOUCH = 36, F.MouseAdapter.DBLCLICK_WAITTIME = 400, F.MouseAdapter.DBLCLICK_WAITTIME_TOUCH = 800, F.MouseAdapter.DBLCLICK_PICK_TIME_ADDITION = 100, F.MouseAdapter.DBLCLICK_SQDIST = 25, F.MouseAdapter.DBLCLICK_SQDIST_TOUCH = 2500, F.MouseAdapter.HOLD_WAITTIME_TOUCH = 400, F.MouseAdapter.HOLD_SQDIST = 25, F.MouseAdapter.HOLD_SQDIST_TOUCH = 225, F.MouseAdapter.PAN_SQDIST_TOUCH = 64, F.MouseAdapter.SCROLL_DIST_TOUCH = 8, F.MouseHandler = function () {
}, F.MouseHandler.prototype = {
    onClick: function () {
    },
    onDblClick: function () {
    },
    onDragStart: function () {
    },
    onDragMove: function () {
    },
    onDragStop: function () {
    },
    onScrollStart: function () {
    },
    onScroll: function () {
    },
    onScrollStop: function () {
    },
    onHoldStart: function () {
    },
    onHoldMove: function () {
    },
    onHoldStop: function () {
    }
}, F.extend("MouseHandler"), F.MouseAdapterExt = function (e, t, i) {
    this._usePointerEvents = !!(window.PointerEvent && navigator.pointerEnabled || !window.PointerEvent && window.MSPointerEvent), this._peTouches = [], F.MouseAdapter.call(this, e, t, i)
}, F.MouseAdapterExt.prototype = {
    listenersOnOff: function (e) {
        var t = F.MouseAdapterExt.PEvent,
            i = this._onEventProxied,
            n = $(this._capture ? window : this._node);
        this._usePointerEvents ? (n[e](t.POINTER_DOWN + " " + t.POINTER_MOVE + " " + t.POINTER_UP, i), this._capture || $(this._node)[e](t.POINTER_LEAVE, i), $(this._node)[e]("mousewheel DOMMouseScroll", i)) : F.MouseAdapter.prototype.listenersOnOff.call(this, e)
    },
    onEvent: function (e) {
        var t = F.MouseAdapterExt.PEvent;
        if (e.preventDefault(), this._usePointerEvents && e.type.lastIndexOf(t.POINTER_PREFIX, 0) >= 0) {
            if (e = this.transformPointerEvent(e), e === t.IGNORE) return;
            if (e === t.UNKNOWN) return this.pointerResetTouchState(), void this.initial()
        }
        F.MouseAdapter.prototype.onEvent.call(this, e)
    },
    transformPointerEvent: function (e) {
        var t = F.MouseAdapterExt.PEvent,
            i = e.originalEvent.pointerType,
            n = (e.originalEvent.pointerId, e.originalEvent.button, e.originalEvent.pageX),
            r = e.originalEvent.pageY;
        return "mouse" !== i && "touch" !== i && 4 !== i && 2 !== i ? t.IGNORE : "touch" === i || 2 === i ? this.transformPointerTouchEvent(e, n, r) : 0 === this._peTouches.length ? this.pointerToMouseEvent(e, n, r) : e.type === t.POINTER_MOVE || e.type === t.POINTER_LEAVE ? t.IGNORE : (this.pointerResetTouchState(), t.UNKNOWN)
    },
    pointerToMouseEvent: function (e, t, i) {
        var n, r = F.MouseAdapterExt.PEvent;
        switch (e.type) {
            case r.POINTER_MOVE:
                n = "mousemove";
                break;
            case r.POINTER_DOWN:
                n = "mousedown";
                break;
            case r.POINTER_UP:
                n = "mouseup";
                break;
            case r.POINTER_LEAVE:
                n = "mouseleave"
        }
        return {
            type: n,
            button: e.originalEvent.button,
            pageX: t,
            pageY: i,
            originalEvent: {},
            preventDefault: function () {
                e.preventDefault()
            },
            stopPropagation: function () {
                e.stopPropagation()
            }
        }
    },
    transformPointerTouchEvent: function (e, t, i) {
        var n, r = F.MouseAdapterExt.PEvent,
            o = e.originalEvent.pointerId,
            a = r.UNKNOWN;
        switch (e.type) {
            case r.POINTER_MOVE:
                n = this.findTouchPointerId(o), n >= 0 && (this._peTouches[n].pageX = t, this._peTouches[n].pageY = i, a = this.pointerToTouchEvent(e, "touchmove", n));
                break;
            case r.POINTER_DOWN:
                this._peTouches.push({
                    pointerId: o,
                    pageX: t,
                    pageY: i
                }), a = this.pointerToTouchEvent(e, "touchstart", this._peTouches.length - 1);
                break;
            case r.POINTER_UP:
                n = this.findTouchPointerId(o), n >= 0 && (this._peTouches[n].pageX = t, this._peTouches[n].pageY = i, a = this.pointerToTouchEvent(e, "touchend", n));
                break;
            case r.POINTER_LEAVE:
                a = r.IGNORE
        }
        return a
    },
    pointerResetTouchState: function () {
        F.clearArray(this._peTouches)
    },
    findTouchPointerId: function (e) {
        for (var t = this._peTouches, i = 0; i < t.length; i++)
            if (t[i].pointerId === e) return i;
        return -1
    },
    pointerToTouchEvent: function (e, t, i) {
        var n = this._peTouches.map(function (e) {
                return {
                    pageX: e.pageX,
                    pageY: e.pageY
                }
            }),
            r = {
                type: t,
                originalEvent: {
                    changedTouches: [n[i]]
                },
                preventDefault: function () {
                    e.preventDefault()
                },
                stopPropagation: function () {
                    e.stopPropagation()
                }
            };
        return "touchend" === t && (this._peTouches.splice(i, 1), n.splice(i, 1)), r.originalEvent.touches = n, r
    }
}, F.extend("MouseAdapterExt", "MouseAdapter"), F.MouseAdapterExt.PEvent = function () {
    var e = !window.PointerEvent;
    return {
        IGNORE: "ignore",
        UNKNOWN: "unknown",
        POINTER_DOWN: e ? "MSPointerDown" : "pointerdown",
        POINTER_UP: e ? "MSPointerUp" : "pointerup",
        POINTER_MOVE: e ? "MSPointerMove" : "pointermove",
        POINTER_LEAVE: e ? "mouseleave" : "pointerleave",
        POINTER_PREFIX: e ? "MSPointer" : "pointer"
    }
}(), F.KeyboardAdapter = function (e, t) {
    F.BaseAdapter.call(this, e, t), this.listenersOnOff("on")
}, F.KeyboardAdapter.prototype = {
    onEvent: function (e) {
        var t = document.activeElement;
        if (t) {
            var i = t.nodeName.toLowerCase();
            if ("input" === i || "textarea" === i || "select" === i) return
        }
        if ("keydown" === e.handleObj.type || "keyup" === e.handleObj.type) {
            var n = "keydown" === e.handleObj.type ? "Press" : "Release";
            switch (e.keyCode) {
                case 38:
                case 87:
                    this.callHandlerStack(e, "onForward" + n);
                    break;
                case 40:
                case 83:
                    this.callHandlerStack(e, "onBackward" + n);
                    break;
                case 37:
                case 65:
                    this.callHandlerStack(e, "onLeft" + n);
                    break;
                case 39:
                case 68:
                    this.callHandlerStack(e, "onRight" + n);
                    break;
                case 33:
                case 82:
                    this.callHandlerStack(e, "onUp" + n);
                    break;
                case 34:
                case 70:
                    this.callHandlerStack(e, "onDown" + n);
                    break;
                case 73:
                    this.callHandlerStack(e, "onI" + n);
                    break;
                case 74:
                    this.callHandlerStack(e, "onJ" + n);
                    break;
                case 75:
                    this.callHandlerStack(e, "onK" + n);
                    break;
                case 76:
                    this.callHandlerStack(e, "onL" + n);
                    break;
                case 107:
                    this.callHandlerStack(e, "onPlus" + n);
                    break;
                case 109:
                    this.callHandlerStack(e, "onMinus" + n);
                    break;
                case 16:
                    this.callHandlerStack(e, "onShift" + n)
            }
        }
    },
    listenersOnOff: function (e) {
        var t = this._onEventProxied,
            i = $(this._capture ? window : this._node);
        i[e]("keydown", t), i[e]("keyup", t)
    }
}, F.extend("KeyboardAdapter", "BaseAdapter"), F.AlertServiceBase = function () {
}, F.AlertServiceBase.prototype = {
    error: function () {
    },
    errorObj: function () {
    },
    message: function () {
    },
    debugMessage: function () {
    },
    tip: function () {
    }
}, F.extend("AlertServiceBase"), F.AlertServiceBase.DELAY_SHORT = 5e3, F.AlertServiceBase.DELAY_MEDIUM = 1e4, F.AlertServiceBase.DELAY_FOREVER = 0, angular.module("f.alert", []), F.DI().registerService("alert", F.AlertServiceBase), angular.module("f.alert").directive("alert", function () {
    return {
        transclude: !0,
        restrict: "E",
        scope: {
            type: "@"
        },
        template: '<div class="alert alert-{{type}} f_alert f_alert-{{type}} f_textM f_textDark" style="margin-bottom:5px; position:relative;" ng-transclude></div>'
    }
}), angular.module("f.alert").directive("errorbox", function () {
    return {
        scope: {
            error: "="
        },
        template: '<asyncpartial firstload="error" partial="errorbox.html"></asyncpartial>',
        restrict: "E",
        link: function (e) {
            e.$watch("error", function (t) {
                t ? (e.errorinfo = JSON.stringify(t, void 0, 2), e.showErrorInfo = !1) : e.errorinfo = ""
            }), e.toggleInfo = function () {
                e.showErrorInfo = !e.showErrorInfo
            }
        }
    }
}), angular.module("f.component", []), F.PLACEHOLD_EMPTY = "", angular.module("f.component").filter("int2rgb", function () {
    return function (e) {
        return F.ColorGenerator.hexColorFromInt(e)
    }
}), angular.module("f.component").filter("bgcolor", function () {
    return function (e) {
        return {
            "background-color": e
        }
    }
}), angular.module("f.component").filter("startFrom", function () {
    return function (e, t) {
        return t = +t, e.slice(t)
    }
}), angular.module("f.component").filter("paginate", function () {
    return function (e, t, i) {
        return e ? (t = +t, i = +i, e.slice(t * i, t * i + i)) : void 0
    }
}), angular.module("f.component").directive("pagination", function () {
    return {
        restrict: "E",
        scope: {
            length: "=",
            index: "=",
            limit: "="
        },
        link: function (e) {
            e.Math = window.Math, e.pages = 0, e.collapsed = !1, e.indexes = [], e.setIndex = function (t) {
                e.index = t
            }, e.$watch('index + "|" + limit + "|" + length', function (t) {
                var i = t.split("|"),
                    n = i[0],
                    r = i[1],
                    o = i[2];
                if (e.pages = Math.ceil(o / r), e.index = Math.max(0, Math.min(e.pages - 1, n || 0)), e.collapsed = e.pages > 7, F.clearArray(e.indexes), e.collapsed) {
                    var a;
                    e.index <= 3 ? e.indexes.push(2, 3, 4, 5) : e.index >= e.pages - 4 ? (a = e.pages - 4, e.indexes.push(a, a + 1, a + 2, a + 3)) : (a = e.index, e.indexes.push(a, a + 1, a + 2))
                } else
                    for (var s = 1; s <= e.pages; s++) e.indexes.push(s)
            })
        },
        template: '<a ng-show="collapsed" class="f_paginationitem f_cursorPointer f_unselectable" ng-class="{ f_selected : index === 0 }" ng-click="setIndex(0)">1</a><span class="f_paginationitem f_unselectable" ng-show="collapsed && indexes[0] != 2">...</span><a class="f_paginationitem f_cursorPointer f_unselectable" ng-class="{ f_selected: index == i - 1 }" ng-repeat="i in indexes" ng-click="setIndex(i - 1)">{{ i }}</a><span class="f_paginationitem f_unselectable" ng-show="collapsed && indexes[indexes.length - 1] != pages - 1">...</span><a ng-show="collapsed" class="f_paginationitem f_cursorPointer f_unselectable" ng-show="pages > 1" ng-class="{ f_selected: index == pages - 1 }" ng-click="setIndex(pages - 1)">{{ pages }}</a>'
    }
}), angular.module("f.component").directive("collapsibleblock", function () {
    return {
        scope: {
            caption: "@",
            collapsed: "@",
            line: "@",
            toggle: "&"
        },
        templateUrl: F.partialUrl("collapsibleblock.html"),
        replace: !0,
        restrict: "E",
        transclude: !0,
        link: function (e, t, i, n, r) {
            var o = t.children("div");
            r(e.$parent, function (e) {
                o.append(e)
            }), e.toggleCollapsed = function () {
                var t = "true" == e.collapsed;
                e.collapsed = t ? "false" : "true", F.async(function () {
                    e.$apply(function () {
                        e.toggle({
                            collapsed: !t
                        })
                    })
                })
            }
        }
    }
}), angular.module("f.component").directive("chart", function () {
    return {
        replace: !0,
        restrict: "E",
        transclude: !1,
        scope: {
            scalelabel: "@",
            type: "@",
            draw: "@",
            data: "=",
            tooltipTempl: "@"
        },
        link: function (e, t) {
            var i, n, r = t.find(".f_chartCanvasWrapper");
            e.createCanvas = function () {
                r.empty(), i = document.createElement("canvas"), r[0].appendChild(i), i.width = r.width(), i.height = r.height(), n = i.getContext("2d")
            }, e.updateChart = function (t, i) {
                e.createCanvas();
                var r;
                if (1 < t.max) {
                    var o = Math.pow(10, Math.floor(F.log10(t.max)));
                    r = Math.ceil(t.max / o) * o
                } else r = 0 < t.max ? t.max : 0;
                var a = 10,
                    s = 1;
                1 >= r && (s = 10);
                var c = {
                        scaleOverride: !0,
                        bezierCurve: !1,
                        animation: i,
                        animationSteps: F.isMobile() ? 40 : 100,
                        scaleSteps: a,
                        scaleStepWidth: Math.ceil(r / a) / s,
                        scaleStartValue: 0,
                        tooltipTemplate: "<%if (label){%><%=label%>: <%}%><%= value.toFixed(3)%>"
                    },
                    l = e.tooltipTempl;
                l && (l = l.replace(/\[/g, "<%"), l = l.replace(/\]/g, "%>"), c.tooltipTemplate = l), "2d" === e.type && ("bar" === e.draw ? new Chart(n).Bar(t, c) : "line" === e.draw ? new Chart(n).Line(t, c) : "radar" === e.draw && new Chart(n).Radar(t, c)), "1d" === e.type && ("polararea" === e.draw ? new Chart(n).PolarArea(t, c) : "pie" === e.draw ? new Chart(n).Pie(t, c) : "donut" === e.draw && new Chart(n).Doughnut(t, c))
            }, e.$watch("data", function (t) {
                e.updateChart(t, !0)
            }), $(window).resize(function () {
                e.updateChart(e.data, !1)
            }), e.$on("redrawchart", function (t, i) {
                e.updateChart(e.data, !!i && i.animate)
            })
        },
        template: '<div><div class="f_chartCanvasWrapper" style="width:100%; height:100%; text-align:center;"></div></div>'
    }
}), angular.module("f.component").directive("chartlegend", function () {
    return {
        replace: !0,
        restrict: "E",
        transclude: !1,
        scope: {
            data: "="
        },
        template: '<table class="table"><tr ng-repeat="d in data" style="width:auto"><td class="f_chartLabelColor"><div class="f_chartLabelColor" ng-style="{\'background-color\': d.color}" /> </td><td ng-repeat="col in d.legendLabels track by $index" style="white-space:nowrap; width:auto">{{col}}</td></tr></table>'
    }
}), angular.module("f.component").directive("formrow", function () {
    return {
        transclude: !0,
        restrict: "E",
        scope: {
            label: "@"
        },
        link: function (e, t, i) {
            e.label = i.label;
            var n = e.$eval(i.validation);
            e.rules = [], n.forEach(function (t) {
                var i = {
                    message: t.message
                };
                e.$parent.$watch(t.show, function (e) {
                    i.show = e
                }), e.rules.push(i)
            })
        },
        template: '<div class="control-group"><label class="f_textM f_alignLeft" style="padding-top:5px">{{label}}</label><div class="controls" ng-transclude></div><ul><li class="f_textError f_textM" ng-repeat="rule in rules" ng-show="rule.show">{{rule.message | i18n}}</li></ul></div>'
    }
}), angular.module("f.component").directive("promise", function () {
    return {
        controller: function () {
            this.thens = [], this.fails = [], this.progress = []
        },
        link: function (e, t, i, n) {
            function r(t) {
                t.forEach(function (t) {
                    var i = e.$new();
                    c.push(i), t.transclude(i, function (e) {
                        s.push(e), t.element.after(e)
                    })
                })
            }

            function o() {
                for (; c.length;) c[0].$destroy(), c.shift();
                for (; s.length;) s[0].remove(), s.shift()
            }

            function a() {
                i.progress && e.$eval(i.progress + " = undefined")
            }

            var s = [],
                c = [];
            e.$watch(function (e) {
                return e.$eval(i.promise)
            }, function (t) {
                if (o(), i.then) {
                    var s = i.defaultvalue;
                    "string" == typeof s && (s = e.$eval(s)), F.deepAssign(e, i.then, s)
                }
                i.fail && F.deepAssign(e, i.fail, void 0), Q.isPromise(t) && (r(n.progress), t.progress(function (t) {
                    e.$apply(function () {
                        a(t)
                    })
                }).then(function (t) {
                    o(), e.$apply(function () {
                        a(), i.then && F.deepAssign(e, i.then, t), r(n.thens)
                    })
                }, function (t) {
                    o(), e.$apply(function () {
                        a(), i.fail && F.deepAssign(e, i.fail, t), r(n.fails)
                    })
                }).done())
            })
        },
        restrict: "EA"
    }
}), angular.module("f.component").directive("promisethen", function () {
    return {
        transclude: "element",
        require: "^promise",
        priority: 500,
        compile: function (e, t, i) {
            return function (e, t, n, r) {
                r.thens.push({
                    transclude: i,
                    element: t
                })
            }
        }
    }
}), angular.module("f.component").directive("promisefail", function () {
    return {
        transclude: "element",
        require: "^promise",
        priority: 500,
        compile: function (e, t, i) {
            return function (e, t, n, r) {
                r.fails.push({
                    transclude: i,
                    element: t
                })
            }
        }
    }
}), angular.module("f.component").directive("promiseprogress", function () {
    return {
        transclude: "element",
        require: "^promise",
        priority: 500,
        compile: function (e, t, i) {
            return function (e, t, n, r) {
                r.progress.push({
                    transclude: i,
                    element: t
                })
            }
        }
    }
}), angular.module("f.component").directive("unitedit", function () {
    return {
        link: function (e) {
            var t, i = function () {
                    if (t)
                        if (F.validateNumber(e.model)) e.internalModel = void 0;
                        else {
                            var i = e.precision || 0;
                            e.internalModel = +t.getValue(e.model, i)
                        }
                },
                n = function () {
                    var n = e.unitclass || F.LengthUnit;
                    t = new n(e.unit, e.inverse), i()
                };
            e.$watch("unitclass", n), e.$watch("unit", n), e.$watch("precision", i);
            var r = !1;
            e.$watch("model", function () {
                r || i(), r = !1
            }), e.focusLost = i, e.internalModelChange = function () {
                var i = e.internalModel;
                r = !0, e.model = !e.validateNumber(i) && t ? t.convertToBaseUnit(parseFloat(i)) : void 0, F.async(function () {
                    e.$apply(function () {
                        e.change({
                            newValue: e.model
                        })
                    })
                })
            }, e.formatUnit = function () {
                return t ? t.getUnitString() : ""
            }, e.validateNumber = F.validateNumber
        },
        restrict: "E",
        scope: {
            model: "=",
            unitclass: "=",
            unit: "=",
            change: "&",
            precision: "=",
            inverse: "=",
            unitcaption: "@",
            icon: "@",
            disabled: "="
        },
        template: '<div class="input-group"><div ng-if="icon" class="input-group-addon" style="max-width: 50px;padding-left: 8px;"><img class="f_icon32" static-src="icons/{{icon}}"/></div><input class="form-control" type="number" ng-model="internalModel" ng-change="internalModelChange()" ng-blur="focusLost()" ng-disabled="disabled" id="appendedInput"><div class="input-group-addon f_textSM"><span ng-if="unitcaption">{{unitcaption}}</span>{{formatUnit(unit)}}</div></div><div class="f_textBold f_textM f_textError" style="overflow:visible">{{validateNumber(internalModel) | i18n}}</div>'
    }
}), angular.module("f.component").directive("ngEnter", function () {
    return function (e, t, i) {
        t.bind("keydown keypress", function (t) {
            13 === t.which && (e.$apply(function () {
                e.$eval(i.ngEnter)
            }), t.preventDefault())
        })
    }
}), angular.module("f.component").directive("markdown", function () {
    var e = F.DI().get("$sanitize"),
        t = new Showdown.converter;
    return {
        restrict: "E",
        link: function (i, n, r) {
            var o = !1;
            i.$watch(r.source, function (i) {
                o = o || !!i, n.html(o ? e(t.makeHtml(i || "")) : t.makeHtml(n.text()))
            })
        }
    }
}), angular.module("f.component").directive("tasktagpicker", function () {
    return {
        restrict: "E",
        replace: !0,
        scope: {
            input: "=",
            tags: "="
        },
        link: function (e) {
            e.addTag = function (t) {
                if (t) F.addUnique(e.input.tags, t);
                else if (e.input.tagToAdd) {
                    var i = e.input.tagToAdd.split(/[\s]+/);
                    i.forEach(function (t) {
                        F.addUnique(e.input.tags, t)
                    })
                }
                e.input.tagToAdd = ""
            }, e.removeTag = function (t) {
                F.removeFirst(e.input.tags, t)
            }
        },
        template: '<div><div style="padding: 5px;"><p ng-show="input.operation === \'add\'">{{\'FE_TAGS_TO_ADD\'|i18n}}:<p/><p ng-show="input.operation ===\'remove\'">{{\'FE_TAGS_TO_REMOVE\'|i18n}}:<p/><alert type="info" ng-show="input.tags.length === 0">{{ \'FE_SELECT_TAGS_NONE\' | i18n }}</alert><span ng-repeat="tag in input.tags"><span style="cursor:pointer;margin-bottom:5px;" title="{{\'FE_REMOVE_TAG\'|i18n}}" ng-click="removeTag(tag)" class="f_label f_labelInteractive">{{tag}} <img style="margin-bottom:2px" class="f_icon16" static-src="icons/im/checked_false.png"></span></span></div><div ng-show="tags" class="f_taskSubContainer"><p ng-show="input.operation === \'add\'">{{\'FE_SELECT_TAGS_ADD\'|i18n}}:<p/><p ng-show="input.operation === \'remove\'">{{\'FE_SELECT_TAGS_REMOVE\'|i18n}}:<p/><div style="width:100%;max-height:200px;overflow-y:auto;"><div ng-repeat="tag in tags" class="f_hover" ng-click="addTag(tag.Tag)" style="width:100%;height:40px;padding-top:6px;" title="{{\'FE_ADD_TAG\'|i18n}}"><span style="cursor:pointer;margin:5px;padding: 5px 20px 5px 20px; margin: 1px 0px 0px 5px;" class="f_label f_labelInteractive">{{tag.Tag}} </span></div></div></div><form  ng-show="input.operation != \'remove\'" style="margin-top:10px; margin-bottom:5px; width:230px !important"><div class="input-group"><input class="form-control" type="text" ng-model="input.tagToAdd" style="width:140px !important" placeholder="{{\'FE_NEW_TAG\'|i18n}}"/><button ng-click="addTag()" title="{{\'FE_ADD_TAG\'|i18n}}" class="btn btn-default input-group-addon" style="width:90px !important; height:34px;">{{\'FE_PUSH\'|i18n}}</button></div></form></div>'
    }
}), angular.module("f.component").directive("taskcategorypicker", function () {
    return {
        restrict: "E",
        replace: !0,
        scope: {
            input: "=",
            categories: "="
        },
        link: function (e) {
            e.setCategory = function (t) {
                t ? e.input.category = t : (e.input.category = e.input.catToSet, e.input.catToSet = void 0)
            }, e.removeCategory = function () {
                e.input.category = ""
            }
        },
        template: '<div><div ng-if="input.category" style="padding: 5px;"><p>{{\'FE_CURRENT_CATEGORY\'|i18n}}:<p/><category class="f_catWrapper f_textM" text="input.category" interactive="true" title="{{\'FE_REMOVE_CATEGORY\'|i18n}}" ng-click="removeCategory()"/><br><br></div><div ng-show="categories" class="f_taskSubContainer"><p>{{\'FE_EXIST_CATEGORY\'|i18n}}:<p/><div style="width:100%;max-height:200px;overflow-y:auto;"><div ng-repeat="cat in categories" class="f_hover" ng-click="setCategory(cat.Category)" style="width:100%;height:40px;padding-top:6px;"><category class="f_catWrapper f_textM" text="cat.Category" interactive="false"/></div></div></div><form  style="margin-top:10px; margin-bottom:5px; width:230px !important"><div class="input-group"><input class="form-control" type="text" ng-model="input.catToSet" style="width:140px !important;" placeholder="{{\'FE_NEW_CATEGORY\'|i18n}}"/><button ng-click="setCategory()" title="{{\'FE_SET_CATEGORY\'|i18n}}" class="btn btn-default input-group-addon" style="width:90px !important; height:34px;">{{\'FE_SET\'|i18n}}</button></div></form></div>'
    }
}), angular.module("f.component").directive("actionbar", function () {
    return {
        replace: !0,
        restrict: "E",
        transclude: !0,
        link: function () {
        },
        template: '<div><div ng-if="page.actionBarActive === true" unselectable="off" class="f_actionBarWrapper"><div ng-transclude></div></div><div class="f_actionBarTrigger" ng-click="page.actionBarActive = !page.actionBarActive"></div></div>'
    }
}), angular.module("f.component").directive("actionbarextension", function () {
    return {
        require: "?^actionbar",
        replace: !0,
        restrict: "E",
        transclude: !0,
        link: function () {
        },
        template: '<div ng-transclude unselectable="off" class="f_actionBarWrapper f_actionBarExtensionCtrlWrapper"></div>'
    }
}), angular.module("f.component").directive("buttongroup", function () {
    return {
        require: "?^actionbar",
        scope: {
            vertical: "@"
        },
        replace: !0,
        restrict: "E",
        transclude: !0,
        link: function () {
        },
        template: '<div ng-transclude class="f_actionBarVertical" ng-class="{\'btn-group-vertical\': vertical == true}" style="margin-bottom:5px;"></div>'
    }
}), angular.module("f.component").directive("validatepassword", function () {
    return {
        require: "ngModel",
        link: function (e, t, i, n) {
            n.$parsers.unshift(function (t) {
                return e.validatePassword(t)
            }), e.validatePassword = function (e) {
                var t = F.validatePassword(e);
                return void 0 === t ? (n.$setValidity("validatepassword", !0), e) : void n.$setValidity("validatepassword", !1)
            }
        }
    }
}), angular.module("f.component").directive("passwordsequal", function () {
    return {
        require: "ngModel",
        link: function (e, t, i, n) {
            n.$parsers.unshift(function (t) {
                return t === e.formData.password ? (n.$setValidity("passwordsequal", !0), t) : void n.$setValidity("passwordsequal", !1)
            })
        }
    }
}), angular.module("f.component").directive("emailvalid", function () {
    return {
        require: "ngModel",
        link: function (e, t, i, n) {
            n.$parsers.unshift(function (t) {
                return e.validateEmail(t)
            }), n.$formatters.unshift(function (t) {
                return e.validateEmail(t)
            }), e.validateEmail = function (e) {
                return void 0 === F.validateEmail(e) ? (n.$setValidity("emailvalid", !0), e) : void n.$setValidity("emailvalid", !1)
            }
        }
    }
}), angular.module("f.component").directive("locationvalid", function () {
    return {
        require: "ngModel",
        link: function (e, t, i, n) {
            n.$parsers.unshift(function (t) {
                return e.validateLocation(t)
            }), n.$formatters.unshift(function (t) {
                return e.validateLocation(t)
            }), e.validateLocation = function (e) {
                return !e || e && !F.validateLocation(e.toString()) ? (n.$setValidity("locationvalid", !0), e) : void n.$setValidity("locationvalid", !1)
            }
        }
    }
}), angular.module("f.component").directive("filenamevalid", function () {
    return {
        require: "ngModel",
        link: function (e, t, i, n) {
            var r = /^(?!(?:CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])(?:\.[^.]*)?$)[^<>:"/\\|?*\x00-\x1F]*[^<>:"/\\|?*\x00-\x1F\ .]$/i;
            n.$parsers.unshift(function (t) {
                return e.validateFilename(t)
            }), n.$formatters.unshift(function (t) {
                return e.validateFilename(t)
            }), e.validateFilename = function (e) {
                return e && e.toString().match(r) ? (n.$setValidity("filenamevalid", !0), e) : void n.$setValidity("filenamevalid", !1)
            }
        }
    }
}), angular.module("f.component").directive("numbervalid", function () {
    return {
        require: "ngModel",
        link: function (e, t, i, n) {
            n.$parsers.unshift(function (t) {
                return e.validateNumber(t)
            }), n.$formatters.unshift(function (t) {
                return e.validateNumber(t)
            }), e.validateNumber = function (e) {
                var t = F.validateNumber(e);
                return void 0 === t || void 0 === e || "" === e ? (n.$setValidity("numbervalid", !0), e) : void n.$setValidity("numbervalid", !1)
            }
        }
    }
}), angular.module("f.component").directive("ipv4valid", function () {
    return {
        require: "ngModel",
        link: function (e, t, i, n) {
            n.$parsers.unshift(function (t) {
                return e.validateIpAddress(t)
            }), n.$formatters.unshift(function (t) {
                return e.validateIpAddress(t)
            }), e.validateIpAddress = function (e) {
                var t = F.validateIpV4Address(e);
                return void 0 === t ? (n.$setValidity("ipv4valid", !0), e) : void n.$setValidity("ipv4valid", !1)
            }
        }
    }
}), angular.module("f.component").directive("focusMe", ["$parse", function (e) {
    return {
        link: function (t, i, n) {
            var r = e(n.focusMe);
            t.$watch(r, function (e) {
                e && (F.isMobile() || F.async(function () {
                    $(i[0]).find(".form-control").focus()
                }))
            })
        }
    }
}]), angular.module("f.component").directive("scrollChange", [function () {
    return {
        scope: {
            scrollChange: "="
        },
        link: function (e, t, i) {
            var n = 0;
            i.scrollThreshold && (n = parseInt(i.scrollThreshold)), e.$emit("f_scroll", function (t) {
                var i = t.target || t.srcElement;
                e.$apply(function (e) {
                    e.scrollChange = i.scrollTop > n
                })
            })
        }
    }
}]), angular.module("f.component").directive("spinner", function () {
    return {
        scope: {},
        replace: !0,
        restrict: "E",
        transclude: !0,
        link: function () {
        },
        template: '<div class="f_spinnerWrapper"><div class="f_spinnerRotator"></div><div ng-transclude></div></div>'
    }
}), F.ApiWrapperBoxcom = function (e) {
    this._script = e
}, F.ApiWrapperBoxcom.prototype = {
    load: function () {
        return this._script.getScript(F.ApiWrapperBoxcom.apiConfig.script_id).requireOnce()
    },
    getLinks: function () {
        if (!window.BoxSelect) return Q.reject();
        var e = Q.defer(),
            t = {
                clientId: F.ApiWrapperBoxcom.apiConfig.api_key,
                linkType: "direct",
                multiselect: !0
            };
        try {
            var i = new BoxSelect(t);
            i.success(function (t) {
                var i = t.map(function (e) {
                    return new F.Hyperlink(e.url, e.name, F.ApiWrapperBoxcom.apiConfig.provider_id)
                });
                e.resolve(i)
            }), i.cancel(function () {
                e.resolve([])
            }), i.launchPopup()
        } catch (n) {
            e.reject(n)
        }
        return e.promise
    }
}, F.ApiWrapperBoxcom.apiConfig = {
    script_url: "https://app.box.com/js/static/select.js",
    script_id: "boxcomAPI",
    api_key: "spbpd479cawgqvxvtoqbm2xnt6k9hc32",
    dev_id: void 0,
    provider_caption: "Box.com",
    provider_id: "boxcom",
    ownsUrl: function (e) {
        return e.indexOf("boxcloud") >= 0
    }
}, F.ApiWrapperDropbox = function (e) {
    this._script = e
}, F.ApiWrapperDropbox.prototype = {
    load: function () {
        return this._script.getScript(F.ApiWrapperDropbox.apiConfig.script_id).requireOnce()
    },
    getLinks: function () {
        if (!window.Dropbox) return Q.reject();
        var e = Q.defer(),
            t = {
                success: function (t) {
                    var i = t.map(function (e) {
                        return new F.Hyperlink(e.link, e.name, F.ApiWrapperDropbox.apiConfig.provider_id)
                    });
                    e.resolve(i)
                },
                cancel: function () {
                    e.resolve([])
                },
                linkType: "preview",
                multiselect: !0
            };
        try {
            Dropbox.appKey = F.ApiWrapperDropbox.apiConfig.api_key, Dropbox.choose(t)
        } catch (i) {
            e.reject(i)
        }
        return e.promise
    }
}, F.ApiWrapperDropbox.apiConfig = {
    script_url: "https://www.dropbox.com/static/api/2/dropins.js",
    script_id: "dropboxAPI",
    api_key: "u2oqlz503my0cdw",
    dev_id: void 0,
    provider_caption: "Dropbox",
    provider_id: "dropbox",
    ownsUrl: function (e) {
        return e.indexOf("dropbox") >= 0
    }
}, F.HyperlinkEditor = function (e, t, i, n, r) {
    F.PlugController.call(this, e, t);
    var o = this;
    this._script = i, this._alert = n, this._apis = {};
    var a = "cloudstorage_on";
    e.cloudStorageOn = "1" === r.getLocalStorageItem(a), e.input.cloudStorageLinks = [], e.providerClick = function (t) {
        var i = e.providers[t];
        i.loaded ? o.filesFrom(t) : o.loadProvider(t)
    }, e.cloudStorageChanged = function () {
        if (e.cloudStorageOn)
            for (var t in e.providers) o.loadProvider(t);
        r.setLocalStorageItem(a, e.cloudStorageOn ? "1" : "0")
    }, e.addLink = function () {
        if (e.input.linkToAdd) {
            var t = e.input.linkToAdd.split(/[\s]+/);
            t.forEach(function (t) {
                e.input.hyperlinkObjects.push(new F.Hyperlink(t))
            })
        }
        e.input.linkToAdd = ""
    }, e.removeLink = function (e, t) {
        F.removeFirst(t, e)
    }, e.providers = {};
    for (var s in F.Hyperlink._providers) this.addProvider(s);
    e.cloudStorageOn && e.cloudStorageChanged()
}, F.HyperlinkEditor.prototype = {
    addProvider: function (e) {
        var t = F.Hyperlink._providers[e];
        this.$scope.providers[e] = {
            conf: t.apiConfig,
            loading: !1,
            loaded: void 0
        }, this._apis[e] = new t(this._script, this._alert)
    },
    loadProvider: function (e) {
        var t = this,
            i = this.$scope,
            n = i.providers[e];
        n.loaded || n.loading || (n.loading = !0, n.loaded = void 0, this._apis[e].load().then(function () {
            i.$apply(function () {
                n.loading = !1, n.loaded = !0
            })
        }, function (e) {
            i.$apply(function () {
                n.loading = !1, n.loaded = !1
            }), e && e._repeated || t._alert.error("EM_CONN_API_ERROR", void 0, void 0, [n.conf.provider_caption])
        }).done())
    },
    filesFrom: function (e) {
        var t = this,
            i = this._apis[e],
            n = this.$scope.providers[e].conf,
            r = n.provider_caption;
        i.getLinks().then(function (e) {
            t.$scope.$apply(function () {
                e.forEach(function (e) {
                    t.$scope.input.hyperlinkObjects.push(e)
                })
            })
        }, function () {
            t._alert.error("EM_CONN_API_ERROR", void 0, void 0, [r])
        }).done()
    }
}, F.extend("HyperlinkEditor", "PlugController"), F.DI().registerController("hyperlinkeditor", F.HyperlinkEditor, "@plug", "@script", "@alert", "@cookie"), angular.module("f.component").directive("hyperlinkeditor", function () {
    return F.PlugController.createDirective({
        controllerClass: F.DI().getController("hyperlinkeditor"),
        scope: {
            input: "="
        },
        template: '<div><div style="margin-bottom:15px; width:230px !important"><p>{{\'TD_CREATE_HLINK\'|i18n}}</p><div class="input-group" style="margin-top: -5px;"><input class="form-control" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model="input.linkToAdd" style="width:140px !important" placeholder="{{\'FE_NEW_LINK\'|i18n}}"/><button ng-click="addLink()" title="{{\'FE_ADD_LINK\'|i18n}}" class="btn btn-default input-group-addon" style="width:90px !important; height:34px;">{{\'FE_PUSH\'|i18n}}</button></div></div><div class="f_taskSubContainer" style="margin-bottom:25px; position: relative;"><p>{{\'FE_DROPBOX_FILES\'|i18n}}</p><div class="checkbox"><label><input type="checkbox" class="large" ng-model="cloudStorageOn" ng-change="cloudStorageChanged()">{{\'FE_ENABLE\'|i18n}}</label></div><div ng-if="!cloudStorageOn" style="position: absolute; right: 0px; bottom: -4px;"><img ng-if="!cloudStorageOn" ng-repeat="p in providers" class="f_icon28" static-src="icons/{{p.conf.provider_id}}.png"/></div><div ng-if="cloudStorageOn" class="btn-group centered" style="margin-left: 24px;"><button ng-repeat="p in providers" ng-disabled="p.loading" class="btn btn-default" ng-click="providerClick(p.conf.provider_id)" title="{{p.conf.provider_caption}}" style="width:85px;"><img class="f_icon32" static-src="icons/{{p.conf.provider_id}}.png"/><img ng-show="p.loading" class="f_icon16" static-src="icons/im/spinner.gif" style="position: absolute; right: 5px; top: 5px;" /><img ng-show="p.loaded === false" class="f_icon24" static-src="icons/im/alerts/warning.png" style="position: absolute; right: 0px; top: 0px;" /></button></div></div><div><alert type="info" ng-show="input.hyperlinkObjects.length === 0 && input.hyperlinkObjects.length===0">{{ \'FE_LINKS_NONE\' | i18n }}</alert><div ng-repeat="link in input.hyperlinkObjects" style="width:100%; margin-bottom:2px;" class="btn-group"><a href="{{link._url | linkify}}" target="_blank" title="{{\'FE_OPEN_LINK\'|i18n}}: {{link._url}}" class="f_textS btn btn-default" style="width: 79%;overflow: hidden;height: 35px; text-align:left;"><img class="f_icon20" static-src="icons/{{link._provider}}.png" ><div style="margin-left:3px; display:inline-block;" >{{link._description}}</div><div style="width:3px;display:inline-block;"></div></a><button ng-click="removeLink(link, input.hyperlinkObjects)" class="btn btn-default" title="{{\'FE_CLICK_TO_REMOVE\'|i18n}}: {{link._filename}}"><img class="f_icon20" static-src="icons/im/checked_false.png" ></button></div><div ng-repeat="link in input.hyperlinks" style="width:100%; margin-bottom:2px;" class="btn-group"><a href="{{link | linkify}}" target="_blank" title="{{\'FE_OPEN_LINK\'|i18n}}: {{link | linkify}}" class="f_textS btn btn-default" style="width: 79%;overflow: hidden;height: 35px; text-align:left;"><img class="f_icon20" static-src="icons/extlink.png" style="vertical-align: bottom;"><div style="margin-left:3px; display:inline-block;" >{{link}}</div><div style="width:3px;display:inline-block;"></div></a><button ng-click="removeLink(link, input.hyperlinks)" class="btn btn-default" title="{{\'FE_CLICK_TO_REMOVE\'|i18n}}: {{link | linkify}}"><img class="f_icon20" static-src="icons/im/checked_false.png" ></button></div></div></div>'
    })
}), F.DI().config("@script", F.hyperlinkConfig = function (e) {
    [F.ApiWrapperBoxcom, F.ApiWrapperDropbox].forEach(function (t) {
        e.registerScript(t.apiConfig.script_id, t.apiConfig.script_url), F.Hyperlink.registerProvider(t)
    })
}), F.RadialMenuItem = function (e, t) {
    F.PlugController.call(this, e, t), this.$scope = e;
    var i = this;
    e.visible = !1, e.enabled = !0, e.x = 0, e.y = 0, e.icon = "", e.type = "", e.menu = void 0, e.checkbox = {
        show: !1,
        checked: !1,
        x: 0,
        y: 0
    }, e.title = "", e.setPosition = function (e, t) {
        var n = i.$scope;
        n.x = e, n.y = t
    }, e.execute = function () {
        var e = i.$scope;
        if (e.enabled) {
            var t = i.getSubMenuType();
            "OkCancel" == t ? e.menu.showSubMenuOkCancel(e).then(function (t) {
                t && i.execute(), e.menu.closeMenu()
            }, function () {
                e.menu.closeMenu()
            }) : (i.execute(), e.menu.closeMenu())
        }
    }
}, F.RadialMenuItem.prototype = {
    getSubMenuType: function () {
        return "remove" == this.$scope.type ? "OkCancel" : ""
    },
    execute: function () {
        var e, t = this.$scope.menu.object,
            i = this.$scope.type,
            n = F.DI().getParameter(this.$scope.menu.impl);
        try {
            e = n.execute[i](t)
        } catch (r) {
            e = Q.reject(r)
        }
        e && n.error && e.fail(function (e) {
            n.error(e, i, t)
        }).done()
    }
}, F.extend("RadialMenuItem", "PlugController"), F.RadialMenu = function (e, t) {
    F.PlugController.call(this, e, t), this.$scope = e;
    var i = this;
    e.object = void 0, e.visible = !1, e.x = 0, e.y = 0, e.impl = "", e.items = [], e.subItems = [], e.q = void 0, e.defer = void 0, e.showMenu = function () {
        var e = i.$scope;
        if (void 0 !== e.object) {
            i.hideAll();
            var t = e.object,
                n = F.DI().getParameter(e.impl),
                r = e.items.map(function (e) {
                    var i = e.type,
                        r = n.evaluate[i](t);
                    return Q.when(r, function (o) {
                        var a;
                        return o && n.options && n.options[i] && (a = n.options[i](t)), Q.all([Q.resolve(e), r, Q(a)])
                    })
                }),
                o = i._promiseEval = Q.all(r);
            o.then(function (n) {
                if (i._promiseEval === o && e.object === t) {
                    i._promiseEval = void 0;
                    var r = [];
                    n.forEach(function (e) {
                        var t = e[0],
                            i = e[1],
                            n = e[2];
                        i && (r.push(t), n && (t.checkbox = n.checkbox, t.title = n.title))
                    }), 1 <= r.length && e.$apply(function () {
                        i.showItems(r), i.arrangeItems(r), e.visible = !0
                    })
                }
            })
        }
    }, e.showSubMenu = function (e, t) {
        var n = i.$scope;
        if (void 0 !== n.object) {
            i.hideAll();
            var r = [];
            "OkCancel" == e && n.subItems.forEach(function (e) {
                ("ok" == e.type || "cancel" == e.type) && r.push(e)
            }), 1 <= r.length && (t.enabled = !1, t.visible = !0, i.showSubItems(r), i.arrangeSubItems(r, t), n.visible = !0)
        }
    }, e.showSubMenuOkCancel = function (e) {
        var t = i.$scope;
        return t.showSubMenu("OkCancel", e), t.defer = t.q.defer(), t.defer.promise
    }, e.closeMenu = function () {
        var e = i.$scope;
        e.defer && e.defer.resolve(!1), e.defer = void 0, i.hideAll();
        var t = F.DI().getParameter(e.impl);
        t.execute.unhighlight && t.execute.unhighlight(e.object), e.visible = !1, e.object = void 0
    }
}, F.RadialMenu.prototype = {
    hideItems: function () {
        this.$scope.items.forEach(function (e) {
            e.visible = !1
        })
    },
    hideSubItems: function () {
        this.$scope.subItems.forEach(function (e) {
            e.visible = !1
        })
    },
    hideAll: function () {
        this.hideItems(), this.hideSubItems()
    },
    showItems: function (e) {
        e.forEach(function (e) {
            e.enabled = !0, e.visible = !0
        })
    },
    showSubItems: function (e) {
        e.forEach(function (e) {
            e.visible = !0
        })
    },
    arrangeItems: function (e) {
        for (var t = e.length, i = 8 >= t ? 90 : 90 + 10 * (t - 8), n = 2 * Math.PI / t, r = 0; t > r; ++r) {
            var o = n * (r - 1 * t / 4),
                a = Math.floor(Math.cos(o) * i) - 30,
                s = Math.floor(Math.sin(o) * i) - 30;
            e[r].setPosition(a, s)
        }
    },
    arrangeSubItems: function (e, t) {
        for (var i = e.length, n = 4 >= i ? 75 : 75 + 10 * (i - 4), r = 2 * Math.PI / i, o = 0; i > o; ++o) {
            var a = r * (o - 1 * i / 2),
                s = t.x + Math.floor(Math.cos(a) * n),
                c = t.y + Math.floor(Math.sin(a) * n);
            e[o].setPosition(s, c)
        }
    }
}, F.extend("RadialMenu", "PlugController"), F.RadialSubMenuItem = function (e, t) {
    F.PlugController.call(this, e, t), this.$scope = e;
    var i = this;
    e.visible = !1, e.x = 0, e.Y = 0, e.icon = "", e.type = "", e.menu = void 0, e.setPosition = function (e, t) {
        var n = i.$scope;
        n.x = e, n.y = t
    }, e.resolve = function () {
        var e = i.$scope;
        e.menu.defer.resolve("ok" == e.type ? !0 : "cancel" == e.type ? !1 : !1)
    }
}, F.RadialSubMenuItem.prototype = {}, F.extend("RadialSubMenuItem", "PlugController"), angular.module("f.component.radialmenu", []), F.DI().registerController("radialsubmenuitem", F.RadialSubMenuItem, "@plug"), F.DI().registerController("radialmenuitem", F.RadialMenuItem, "@plug"), F.DI().registerController("radialmenu", F.RadialMenu, "@plug"), angular.module("f.component.radialmenu").directive("radialmenu", ["$q", function (e) {
    return F.PlugController.createDirective({
        link: function (t) {
            t.$watch("object", function (i, n) {
                if (void 0 !== n && i != n) {
                    var r = F.DI().getParameter(t.impl);
                    r.execute.unhighlight && r.execute.unhighlight(n)
                }
                void 0 !== i && i != n && (t.q = e, t.showMenu())
            })
        },
        controllerClass: F.DI().getController("radialmenu"),
        restrict: "E",
        scope: {
            x: "=",
            y: "=",
            visible: "=",
            object: "=",
            impl: "@",
            auto: "@"
        },
        transclude: !0,
        template: '<div class="f_rmRm" ng-show="visible" ng-style="{left: x, top: y}"><radialsubmenuitem icon="icons/im/checked_true.png" type="ok" title="{{\'FE_OK\'|i18n}}"></radialsubmenuitem><radialsubmenuitem icon="icons/im/checked_false.png" type="cancel" title="{{\'FE_CANCEL\'|i18n}}"></radialsubmenuitem><div ng-transclude></div></div>'
    })
}]), angular.module("f.component.radialmenu").directive("radialmenuitem", function () {
    return F.PlugController.createDirective({
        link: function (e, t, i, n) {
            var r = F.DI().getService("locale");
            n.$scope.items.push(e), e.menu = n.$scope, e.$watch("title", function (e) {
                e && i.$set("title", r.translate(e))
            })
        },
        controllerClass: F.DI().getController("radialmenuitem"),
        require: "^radialmenu",
        restrict: "E",
        scope: {
            type: "@",
            icon: "@"
        },
        template: '<div class="f_rmCircle" ng-show="visible" ng-click="execute()" ng-class="{f_rmDisabled: !enabled}" ng-style="{marginLeft: x + \'px\', marginTop: y + \'px\'}"><span class="f_rmMiddle"></span><img static-src="{{icon}}" /><img ng-show="checkbox.show" static-src="icons/im/checked_{{checkbox.checked}}.png" class="f_rmCheckbox" ng-style="{left: checkbox.x + \'px\', top: checkbox.y + \'px\'}" /></div>'
    })
}), angular.module("f.component.radialmenu").directive("radialsubmenuitem", function () {
    return F.PlugController.createDirective({
        link: function (e, t, i, n) {
            n.$scope.subItems.push(e), e.menu = n.$scope
        },
        controllerClass: F.DI().getController("radialsubmenuitem"),
        require: "^radialmenu",
        restrict: "E",
        scope: {
            type: "@",
            icon: "@"
        },
        template: '<div class="f_rmCircle" ng-show="visible" ng-click="resolve()" ng-style="{marginLeft: x + \'px\', marginTop: y + \'px\'}"><span class="f_rmMiddle"></span><img static-src="{{icon}}" /></div>'
    })
}), createNamespace("WS", "F"), WS.Version = {
    _version: "@version 2.3.6.3"
}, WS.Version.getVersion = function () {
    return WS.Version._version.substr(8)
}, WS._2GO = window.WS2GO, angular.module("ws.filter", []), angular.module("ws.widget", []), WS.Layer = function (e, t, i, n, r, o, a, s, c) {
    WS.CRUDObject.call(this, e), this._id = t, this._resourceKeyForName = i, this._viewType = n, this._viewId = r, this._visible = void 0 !== o ? o : !0, this._render = !0, this._zIndex = void 0 !== a ? a : 0, this._visibleDistanceThres = void 0 !== s ? s : 1e3, this._visibleDistanceThresEnabled = void 0 !== c ? c : !1, this._forcedMaxDistance = void 0, this._cookieId = "layer." + this._id + "." + this._viewType
}, WS.Layer.prototype = {
    renderLayer: function () {
        return this._visible && this._render
    },
    clone: function () {
        return new WS.Layer(this._service, this._id, this._resourceKeyForName, this._viewType, this._viewId, this._visible, this._zIndex, this._visibleDistanceThres, this._visibleDistanceThresEnabled)
    },
    getName: function () {
        return this._resourceKeyForName
    },
    writeToLocalStorage: function () {
        var e = {
            visible: this._visible,
            visibleDistanceThresEnabled: this._visibleDistanceThresEnabled,
            visibleDistanceThres: this._visibleDistanceThres
        };
        this._service._cookie.setLocalStorageItem(this._cookieId, JSON.stringify(e))
    },
    getFromLocalStorage: function () {
        var e = JSON.parse(this._service._cookie.getLocalStorageItem(this._cookieId));
        e && (this._visible = e.visible, this._visibleDistanceThresEnabled = e.visibleDistanceThresEnabled, this._visibleDistanceThres = e.visibleDistanceThres)
    },
    removeLocalStorageItem: function () {
        this._service._cookie.removeLocalStorageItem(this._cookieId)
    }
}, WS.extend("Layer", "CRUDObject"), WS.Layer.LayerIDs = {
    DEFAULT: "Default",
    ANNOTATIONS: "Annotation",
    MEASUREMENTS: "Measurements",
    SCANS: "Scans",
    ORTHOPHOTOS: "Orthophoto",
    TEMP: "Temp",
    PANO: "Pano",
    POINT_CLOUD: "PtCloud",
    VIEW_CAM: "ViewCamera",
    DYNAMIC: "Dynamic"
}, WS.Layer.ViewTypes = {
    PANO_VIEW: "PanoramaView",
    OVERVIEW_MAP: "OverviewMap"
}, WS.LayerService = function (e, t) {
    WS.PlugModule.call(this, e), this._cookie = t, this._entities = [], this._tempEntities = [], this.getNew(WS.Layer.LayerIDs.VIEW_CAM, "FE_PANO_VIEW_CAM", WS.Layer.ViewTypes.OVERVIEW_MAP, !0, 0).create(), this.getNew(WS.Layer.LayerIDs.ORTHOPHOTOS, "FE_ORTHOPHOTO", WS.Layer.ViewTypes.OVERVIEW_MAP, !0, 0).create(), this.getNew(WS.Layer.LayerIDs.MEASUREMENTS, "FE_MEASUREMENT", WS.Layer.ViewTypes.OVERVIEW_MAP, !0, 1).create(), this.getNew(WS.Layer.LayerIDs.ANNOTATIONS, "FE_ANNOTATION", WS.Layer.ViewTypes.OVERVIEW_MAP, !0, 2).create(), this.getNew(WS.Layer.LayerIDs.SCANS, "FE_SCANPOSITION", WS.Layer.ViewTypes.OVERVIEW_MAP, !0, 3).create(), this.getNew(WS.Layer.LayerIDs.TEMP, "FE_TEMP_OBJECT", WS.Layer.ViewTypes.OVERVIEW_MAP, !0, 4).create(), this.getNew(WS.Layer.LayerIDs.DYNAMIC, "FE_TEMP_OBJECT", WS.Layer.ViewTypes.OVERVIEW_MAP, !0, 5, 100, !1).create(), this.getNew(WS.Layer.LayerIDs.PANO, "FE_PANO_IMAGE", WS.Layer.ViewTypes.PANO_VIEW, !0, 0, 100, !1).create(), this.getNew(WS.Layer.LayerIDs.POINT_CLOUD, "FE_POINT_CLOUD", WS.Layer.ViewTypes.PANO_VIEW, !0, 1, 100, !1).create(), this.getNew(WS.Layer.LayerIDs.ORTHOPHOTOS, "FE_ORTHOPHOTO", WS.Layer.ViewTypes.PANO_VIEW, !0, 2, 100, !1).create(), this.getNew(WS.Layer.LayerIDs.SCANS, "FE_SCANPOSITION", WS.Layer.ViewTypes.PANO_VIEW, !0, 3, 50, !0).create(), this.getNew(WS.Layer.LayerIDs.MEASUREMENTS, "FE_MEASUREMENT", WS.Layer.ViewTypes.PANO_VIEW, !0, 3, 100, !1).create(), this.getNew(WS.Layer.LayerIDs.ANNOTATIONS, "FE_ANNOTATION", WS.Layer.ViewTypes.PANO_VIEW, !0, 3, 100, !1).create(), this.getNew(WS.Layer.LayerIDs.TEMP, "FE_TEMP_OBJECT", WS.Layer.ViewTypes.PANO_VIEW, !0, 3, 100, !1).create(), this.getNew(WS.Layer.LayerIDs.DYNAMIC, "FE_TEMP_OBJECT", WS.Layer.ViewTypes.PANO_VIEW, !0, 4, 100, !1).create(), this.provideMalePlug("ObjectUpdate", ["updateObjects"])
}, WS.LayerService.prototype = {
    getNew: function (e, t, i, n, r, o, a) {
        var s = this.viewType(i),
            c = this.viewInstance(i),
            l = new WS.Layer(this, e, t, s, c, n, r, o, a);
        return l.getFromLocalStorage(), l
    },
    getAll: function (e, t) {
        var i = [],
            n = Q.defer();
        if (e) {
            var r = this.viewType(e),
                o = this.viewInstance(e);
            o ? this._tempEntities.forEach(function (e) {
                e._viewType === r && e._viewId === o && i.push(e.clone())
            }) : this._entities.forEach(function (e) {
                e._viewType === r && i.push(e.clone())
            })
        } else this._entities.forEach(function (e) {
            i.push(e.clone())
        }), this._tempEntities.forEach(function (e) {
            i.push(e.clone())
        });
        return t && (i = i.filter(t)), n.resolve(i), n.promise
    },
    getByID: function (e) {
        var t, i = Q.defer();
        if (e._viewId) t = this.getOrCreateLayer(e._id, e._viewType, e._viewId);
        else {
            var n = this.getArrayIndex(e);
            n >= 0 && (t = this._entities[n])
        }
        return t ? i.resolve(t) : i.reject(new Error("EM_RESOURCE_NOT_FOUND")), i.promise
    },
    removeAll: function () {
        this._entities = [], this._tempEntities = []
    },
    remove: function (e) {
        var t, i = Q.defer();
        return e._viewId ? (t = this.getTempArrayIndex(e), t >= 0 ? (this._tempEntities.splice(t, 1), i.resolve()) : i.reject(new Error("EM_RESOURCE_NOT_FOUND"))) : (t = this.getArrayIndex(e), t >= 0 ? (this._entities.splice(t, 1), i.resolve()) : i.reject(new Error("EM_RESOURCE_NOT_FOUND"))), i.promise
    },
    create: function (e) {
        var t, i = Q.defer(),
            n = (e._id, e._viewType, e._viewId);
        return n ? (t = this.getTempArrayIndex(e), 0 > t ? (this._tempEntities.push(e), i.resolve()) : i.reject(new Error)) : (t = this.getArrayIndex(e), 0 > t ? (this._entities.push(e), i.resolve()) : i.reject(new Error)), i.promise
    },
    update: function (e) {
        var t = Q.defer();
        e.applyUpdate();
        var i, n = e.clone(),
            r = n._id,
            o = n._viewType;
        if (n._viewId) i = this.getTempArrayIndex(n), i >= 0 ? this._tempEntities[i] = n : this._tempEntities.push(n), t.resolve();
        else if (i = this.getArrayIndex(n), i >= 0) {
            this._entities[i] = n, t.resolve();
            for (var a = 0; a < this._tempEntities.length;) this._tempEntities[a]._id === r && this._tempEntities[a]._viewType === o ? this._tempEntities.splice(a, 1) : a++
        } else t.reject(new Error("EM_RESOURCE_NOT_FOUND"));
        return this.trigger("updateObjects", [
            [e]
        ]), void 0 === e._viewId && e.writeToLocalStorage(), t.resolve(), t.promise
    },
    isLayerVisible: function (e, t) {
        var i = this.viewType(t),
            n = this.viewInstance(t),
            r = this.getLayer(e, i, n);
        return r ? r._visible : !1
    },
    setLayerVisibility: function (e, t, i) {
        var n = this.viewType(t),
            r = this.viewInstance(t);
        if (void 0 === e || void 0 === n) return !1;
        var o;
        o = r ? this.getOrCreateLayer(e, n, r) : this.getLayer(e, n, r), o && (o._visible = i, this.update(o))
    },
    getZIndexOfLayer: function (e, t) {
        var i = this.viewType(t),
            n = this.viewInstance(t);
        if (void 0 === e || void 0 === i) return !1;
        var r = this.getLayer(e, i, n);
        return r ? r._zIndex : -1
    },
    getObjectsVisbleUpToDistance: function (e, t) {
        var i = this.viewType(t),
            n = this.viewInstance(t);
        if (void 0 === e || void 0 === i) return Number.POSITIVE_INFINITY;
        var r = this.getLayer(e, i, n);
        if (!r) return Number.POSITIVE_INFINITY;
        var o = r._visibleDistanceThresEnabled ? r._visibleDistanceThres : Number.POSITIVE_INFINITY,
            a = r._forcedMaxDistance;
        return void 0 !== a ? Math.min(o, a) : o
    },
    forceMaxDistance: function (e, t, i) {
        var n = this.viewType(t),
            r = this.viewInstance(t),
            o = this.getLayer(e, n, r);
        o && (o._forcedMaxDistance = i)
    },
    layerExists: function (e, t) {
        var i = this.viewType(t),
            n = this.viewInstance(t),
            r = this.getLayer(e, i, n);
        return void 0 !== r
    },
    getArrayIndex: function (e) {
        for (var t = 0, i = this._entities.length; i > t; t++) {
            var n = this._entities[t];
            if (n._id === e._id && n._viewType === e._viewType) return t
        }
        return -1
    },
    getTempArrayIndex: function (e) {
        for (var t = 0, i = this._tempEntities.length; i > t; t++) {
            var n = this._tempEntities[t];
            if (n._id === e._id && n._viewType === e._viewType && n._viewId === e._viewId) return t
        }
        return -1
    },
    getLayer: function (e, t, i) {
        if (void 0 === e || void 0 === t) return void 0;
        var n, r, o = {
            _id: e,
            _viewType: t,
            _viewId: i
        };
        return i && (r = this.getTempArrayIndex(o), r >= 0 && (n = this._tempEntities[r])), n || (r = this.getArrayIndex(o), r >= 0 && (n = this._entities[r])), n
    },
    getOrCreateLayer: function (e, t, i) {
        var n, r = {
                _id: e,
                _viewType: t,
                _viewId: i
            },
            o = this.getTempArrayIndex(r);
        return o >= 0 ? n = this._tempEntities[o] : (o = this.getArrayIndex(r), o >= 0 && (n = this._entities[o].clone(), n._viewId = i, this.create(n))), n
    },
    viewType: function (e) {
        return "string" == typeof e ? e : e ? e._type : void 0
    },
    viewInstance: function (e) {
        return "string" == typeof e ? void 0 : e ? e._id : void 0
    }
}, WS.extend("LayerService", "PlugModule"), F.DI().registerService("layer", WS.LayerService, "@plug", "@cookie"), WS.PickPointListener = function (e) {
    this._view = e
}, WS.PickPointListener.prototype = {
    onPickPoint: function (e, t, i, n) {
        var r = new WS.Point3d(i, [e, t], this.getRefSystem(), this._view, n);
        this._view.trigger("pickPoint", [r])
    },
    getRefSystem: function () {
        var e = this._view;
        return e.instanceOf(WS.PanoramaView) ? e._root : e.instanceOf(WS.OverviewMap) ? e._mapObject : void 0
    }
}, WS.extend("PickPointListener"), WS.Object = function () {
    this._id = WS.Object.Id++
}, WS.extend("Object"), WS.Object.Id = 1, WS.Observable = function () {
    this._listener = []
}, WS.Observable.prototype = {
    addListener: function (e) {
        this._listener.push(e)
    },
    removeListener: function (e) {
        var t = this._listener.indexOf(e);
        t >= 0 && this._listener.splice(t, 1)
    },
    informListener: function (e, t) {
        for (var i, n = 0, r = this._listener.length; r > n; n++) i = this._listener[n], i && i[e] && i[e].apply(i, t)
    }
}, WS.extend("Observable", "Object"), WS.Buffer = function (e, t, i, n, r, o) {
    this._bufferData = void 0, this._bufferType = t, this._itemSize = void 0 !== i ? i : this._bufferType == WS.Buffer.Type.ARRAY ? 3 : 1, this._itemDataType = void 0 !== n ? n : this.getItemDataTypeFromBufferType(this._bufferType), this._offset = void 0 !== r ? r : 0, this._stride = void 0 !== o ? o : 0, this.setBufferData(e)
}, WS.Buffer.prototype = {
    addListener: function (e) {
        WS.Observable.prototype.addListener.call(this, e), e[WS.Buffer.OnDataChangeFuncName] && e[WS.Buffer.OnDataChangeFuncName]()
    },
    setBufferData: function (e) {
        this._bufferData = e, this.informListener(WS.Buffer.OnDataChangeFuncName, [])
    },
    getItemDataTypeFromBufferType: function (e) {
        return e === WS.Buffer.Type.ARRAY ? WS.Buffer.ItemDataType.FLOAT : e === WS.Buffer.Type.ELEMENT ? WS.Buffer.ItemDataType.USHORT : void 0
    },
    hasData: function () {
        return !!(this._bufferData && this._bufferData.length && this._bufferData.length > 0)
    },
    addItem: function (e) {
        if (this._bufferData instanceof Array)
            for (var t = 0; t < this._itemSize; t++) this._bufferData.push(e[t]);
        else {
            var i = this._bufferData.constructor,
                n = this._bufferData.length,
                r = n + this._itemSize,
                o = new i(r);
            o.set(this._bufferData);
            for (var a = 0; a < this._itemSize; a++) o[a + n] = e[a];
            this._bufferData = o
        }
        this.informListener(WS.Buffer.OnDataChangeFuncName, [])
    },
    getItem: function (e, t) {
        var i = this._bufferData,
            n = this._itemSize;
        if (i && n) {
            for (var r = e * n, o = 0; n > o; o++) t[o] = i[r + o];
            return n
        }
    },
    setItem: function (e, t, i) {
        var n = this._bufferData,
            r = this._itemSize;
        if (n && r) {
            for (var o = e * r, a = 0; r > a; a++) n[o + a] = t[a];
            i || this.informListener(WS.Buffer.OnDataChangeFuncName, [])
        }
    },
    setComponentOfAllItems: function (e, t) {
        for (var i = this._bufferData, n = i.length, r = e; n > r; r += this._itemSize) i[r] = t;
        this.informListener(WS.Buffer.OnDataChangeFuncName, [])
    },
    getCountItems: function () {
        return this._bufferData && this._itemSize > 0 ? this._bufferData.length / this._itemSize : 0
    },
    setComponent: function (e, t, i, n) {
        this._bufferData[this._itemSize * e + t] = i, n || this.informListener(WS.Buffer.OnDataChangeFuncName, [])
    }
}, WS.extend("Buffer", "Observable"), WS.Buffer.Type = {
    ARRAY: "ARRAY_BUFFER",
    ELEMENT: "ELEMENT_ARRAY_BUFFER"
}, WS.Buffer.ItemDataType = {
    FLOAT: "FLOAT",
    USHORT: "UNSIGNED_SHORT",
    UBYTE: "UNSIGNED_BYTE"
}, WS.Buffer.OnDataChangeFuncName = "onDataChange", WS.ArrayBuffer = function (e, t, i, n, r) {
    WS.Buffer.call(this, e, WS.Buffer.Type.ARRAY, t, i, n, r)
}, WS.extend("ArrayBuffer", "Buffer"), WS.IndexBuffer = function (e, t, i, n) {
    WS.Buffer.call(this, e, WS.Buffer.Type.ELEMENT, 1, t, i, n)
}, WS.extend("IndexBuffer", "Buffer"), WS.Geometry = function () {
    this._indexBuffer = void 0, this._indicesToUse = void 0, this._positionBuffer = void 0, this._positionItemsToUse = void 0, this._primitiveType = WS.Geometry.PrimitiveType.Triangles
}, WS.Geometry.prototype = {
    getPosition: function (e, t) {
        return this._positionBuffer.getItem(e, t)
    },
    getCountPositions: function () {
        var e = this._positionBuffer ? this._positionBuffer.getCountItems() : 0;
        return Math.min(e, this._positionItemsToUse || Number.MAX_VALUE)
    },
    getCountIndices: function () {
        var e = this._indexBuffer ? this._indexBuffer.getCountItems() : 0;
        return Math.min(e, this._indicesToUse || Number.MAX_VALUE)
    }
}, WS.extend("Geometry", "Object"), WS.Geometry.PrimitiveType = {
    Points: "POINTS",
    Triangles: "TRIANGLES",
    TriangleStrip: "TRIANGLE_STRIP",
    LineStrip: "LINE_STRIP",
    Lines: "LINES",
    PolyCircuit: "POLY_CIRCUIT"
}, WS.CenteredQuadGeometry = function () {
    WS.Geometry.call(this), this._positionBuffer = WS.CenteredQuadGeometry.PositionBuffer, this._primitiveType = WS.Geometry.PrimitiveType.TriangleStrip
}, WS.extend("CenteredQuadGeometry", "Geometry"), WS.CenteredQuadGeometry.PositionBuffer = new WS.ArrayBuffer([-1, -1, -1, 1, 1, -1, 1, 1], 2), WS.ObjectLabeler = function (e, t) {
    this._interval = void 0 === e ? WS.ObjectLabeler.DEFAULT_INTERVAL : e, this._delta = 2 * this._interval + 1, this._numChannels = void 0 === t ? 4 : t, this._numValues = Math.floor(256 / this._delta) - 1, this._numValuesTotal = Math.pow(this._numValues, this._numChannels), this._minValue = this._delta + this._interval, this._maxValue = this._numValues * this._delta + this._interval, this._colorToRenderable = {};
    var i = this._maxValue;
    this._nextColor = [i, i, i, 4 === this._numChannels ? i : 255]
}, WS.ObjectLabeler.prototype = {
    assignColorToRenderable: function (e, t) {
        var i = this.getColor(),
            n = {
                color: i.rgb,
                renderable: e,
                memberRenderable: t
            };
        return this._colorToRenderable[i.key] = n, i.rgb
    },
    fillPickColorBuffer: function (e, t) {
        for (var i = this._numChannels - 1, n = this._minValue, r = this._maxValue, o = this._delta, a = 4 * t, s = new Uint8Array(a), c = new Uint8Array([r, r, r, r]), l = 0; a > l;) {
            s[l++] = c[0], s[l++] = c[1], s[l++] = c[2], s[l++] = c[3];
            for (var h = i; h >= 0 && (c[h] -= o, !(c[h] >= n)); h--) c[h] = r
        }
        e.setBufferData(s)
    },
    lookupRenderable: function (e) {
        if (0 === e[3]) return void 0;
        var t = this.adjustColor(e),
            i = this.colorToKey(t);
        return this._colorToRenderable[i]
    },
    lookupIndex: function (e) {
        return 0 === e[3] ? void 0 : this.colorToIdx(e)
    },
    getColor: function () {
        for (var e = this._nextColor, t = F.cloneArray(e), i = this.colorToKey(t), n = this._minValue, r = this._maxValue, o = this._delta, a = this._numChannels - 1; a >= 0 && (e[a] -= o, !(e[a] >= n)); a--) e[a] = r;
        return {
            key: i,
            rgb: t
        }
    },
    adjustColor: function (e) {
        for (var t = this._numChannels, i = [], n = 0; t > n; n++) {
            var r = Math.floor(e[n] / this._delta);
            i[n] = r * this._delta + this._interval
        }
        3 === t && (i[3] = 255);
        vec4.subtract(e, i, []);
        return i
    },
    colorToIdx: function (e) {
        for (var t = this._numChannels, i = this._numValues, n = [], r = 0; t > r; r++) {
            var o = Math.floor(e[r] / this._delta);
            n[r] = i - o
        }
        return 3 === t ? n[2] + i * n[1] + i * i * n[0] : n[3] + i * n[2] + i * i * n[1] + i * i * i * n[0]
    },
    colorToKey: function (e) {
        return e[0] + "," + e[1] + "," + e[2] + "," + e[3]
    }
}, WS.extend("ObjectLabeler"), WS.ObjectLabeler.DEFAULT_INTERVAL = 1, WS.Rectangle = function (e, t, i, n) {
    this._topLeftX = e, this._topLeftY = t, this._width = i, this._height = n
}, WS.Rectangle.prototype = {
    containsPt: function (e, t) {
        return e >= this._topLeftX && e <= this._topLeftX + this._width && t >= this._topLeftY && t <= this._topLeftY + this._height
    },
    containsRect: function (e) {
        return this.containsPt(e._topLeftX, e._topLeftY) && this.containsPt(e._topLeftX + e._width, e._topLeftY + e._height)
    }
}, WS.extend("Rectangle"), WS.Rectangle.fromCorners = function (e, t, i, n) {
    var r = Math.min(e, i),
        o = Math.max(e, i),
        a = Math.min(t, n),
        s = Math.max(t, n);
    return new WS.Rectangle(r, a, o - r, s - a)
}, WS.DownCenteredQuadGeometry = function () {
    WS.Geometry.call(this), this._positionBuffer = WS.DownCenteredQuadGeometry.PositionBuffer, this._primitiveType = WS.Geometry.PrimitiveType.TriangleStrip
}, WS.extend("DownCenteredQuadGeometry", "Geometry"), WS.DownCenteredQuadGeometry.PositionBuffer = new WS.ArrayBuffer([-1, 0, -1, 2, 1, 0, 1, 2], 2), WS.ShaderUniform = function (e, t, i) {
    this._name = e, this._type = t, this._id = i, this._value = void 0
}, WS.extend("ShaderUniform"), WS.ShaderUniforms = function () {
    this._elements = {}
}, WS.ShaderUniforms.prototype = {
    addUniform: function (e) {
        this._elements[e._name] = e
    },
    getUniform: function (e) {
        return this._elements[e]
    },
    getUniforms: function () {
        return this._elements
    }
}, WS.extend("ShaderUniforms"), WS.Material = function (e, t, i, n, r, o, a) {
    this._transparent = void 0 !== e ? e : !1, this._depthTest = void 0 !== t ? t : !0, this._depthWrite = void 0 !== i ? i : !0, this._rgbDepthTestSupport = !1, this._cullFace = void 0 !== a ? a : WS.Material.Cull.OFF, this._images = n, this._canvas = void 0, this._coordBuffer = r, this._colorBuffer = o
}, WS.Material.prototype = {
    setTextureImgUrls: function (e) {
        this._images = [];
        for (var t = 0, i = e.length; i > t; t++) this._images[t] = new WS.Image(e[t])
    },
    setTextureImages: function (e) {
        this._images = e
    },
    clearTextureImages: function () {
        this._images = []
    },
    setTextureImgFilter: function (e, t) {
        if (void 0 !== t && t < this._images.length) this._images[t].setImageFilter(e);
        else
            for (var i = 0, n = this._images.length; n > i; i++) this._images[i].setImageFilter(e)
    },
    getColor: function (e, t) {
        var i = this._colorBuffer,
            n = i ? i.getCountItems() : 0;
        if (!(0 >= n)) {
            var r = Math.min(n - 1, e);
            return i.getItem(r, t)
        }
    },
    getColorCount: function () {
        return this._colorBuffer ? this._colorBuffer.getCountItems() : 0
    },
    hasImages: function () {
        return 0 < this._images.length
    },
    areImagesLoaded: function () {
        for (var e = 0, t = this._images.length; t > e; e++)
            if (!this._images[e].isLoaded()) return !1;
        return !0
    },
    getImage: function (e) {
        return e < this._images.length ? this._images[e] : void 0
    }
}, WS.extend("Material", "Object"), WS.Material.Cull = {
    OFF: 0,
    BACK: 1,
    FRONT: 2
}, WS.ShaderMaterial = function (e, t, i, n, r, o, a, s) {
    WS.Material.call(this, t, i, n, r, o, a, s), this._shaderProgramDesc = e, this._pickColor = void 0
}, WS.ShaderMaterial.prototype = {
    configureShader: function () {
        return !0
    },
    configureRenderer2d: function () {
        return !0
    }
}, WS.extend("ShaderMaterial", "Material"), WS.SpriteMaterial = function (e, t, i) {
    var n = void 0 !== e ? [e] : [];
    WS.ShaderMaterial.call(this, WS.SpriteShaderDesc, !0, !1, !1, n, WS.SpriteMaterial.TextureCoords), this._spriteSize = t, this._scaleByDepth = void 0 !== i ? i : !0
}, WS.SpriteMaterial.prototype = {
    configureShader: function (e) {
        var t = e._camera,
            i = e._viewport,
            n = e._geometry,
            r = e.getShaderProgram(this);
        r.setAttributeValue("aVertexPosition", e.getGlBuffer(n._positionBuffer)), r.setAttributeValue("aVertexTextureCoords", e.getGlBuffer(this._coordBuffer));
        var o = e.getMaterialTextures(this),
            a = void 0 !== o && o.length > 0 ? o[0] : void 0;
        return a && !a.isImageUploaded() ? !1 : (r.setUniformValue("uTex0", new WS.TextureValue(a, 0)), r.setUniformValue("uModelMatrix", e.getModelMatrix()), r.setUniformValue("uViewMatrix", t._transform), r.setUniformValue("uInverseViewMatrix", t._inverseTransform), r.setUniformValue("uProjectionMatrix", t._projMatrix), r.setUniformValue("uSpriteSize", this._spriteSize), r.setUniformValue("uScaleByDepth", this._scaleByDepth), r.setUniformValue("uViewPort", i._dimensions), !0)
    }
}, WS.extend("SpriteMaterial", "ShaderMaterial"), WS.SpriteMaterial.TextureCoords = new WS.ArrayBuffer([0, 0, 0, 1, 1, 0, 1, 1], 2), WS.SceneNode = function () {
    this._children = [], this._parent = void 0
}, WS.SceneNode.prototype = {
    addChild: function (e) {
        this._children.push(e), e._parent && e._parent.removeChild(e), e._parent = this
    },
    removeChild: function (e) {
        var t = this._children.indexOf(e);
        -1 != t && (this._children.splice(t, 1), e._parent = void 0)
    },
    hasChildren: function () {
        return 0 < this._children.length
    },
    getRootNode: function () {
        for (var e = this; e._parent;) e = e._parent;
        return e
    },
    traverse: function (e) {
        e.prepare(), this.traverseInternal(e.preVisit.bind(e), e.visit.bind(e), e.postVisit.bind(e))
    },
    traverseInternal: function (e, t, i) {
        var n;
        if (n = e(this), !n) return !1;
        if (n = t(this), !n) return !1;
        for (var r = 0, o = this._children.length; o > r && n; r++) n = this._children[r].traverseInternal(e, t, i);
        return i(this)
    }
}, WS.extend("SceneNode", "Object"), mat4.isIdentity = function (e) {
    var t = 1e-6;
    return Math.abs(e[0] - 1) < t && Math.abs(e[1] - 0) < t && Math.abs(e[2] - 0) < t && Math.abs(e[3] - 0) < t && Math.abs(e[4] - 0) < t && Math.abs(e[5] - 1) < t && Math.abs(e[6] - 0) < t && Math.abs(e[7] - 0) < t && Math.abs(e[8] - 0) < t && Math.abs(e[9] - 0) < t && Math.abs(e[10] - 1) < t && Math.abs(e[11] - 0) < t && Math.abs(e[12] - 0) < t && Math.abs(e[13] - 0) < t && Math.abs(e[14] - 0) < t && Math.abs(e[15] - 1) < t
}, mat4.setTranslation = function (e, t) {
    e[12] = t[0], e[13] = t[1], e[14] = t[2]
}, mat4.getTranslation = function (e) {
    return [e[12], e[13], e[14]]
}, mat4.getColumn = function (e, t, i) {
    var n = 4 * t;
    return i[0] = e[n], i[1] = e[n + 1], i[2] = e[n + 2], i[3] = e[n + 3], i
}, mat4.transpose3x3 = function (e, t) {
    t || (t = e);
    var i = e[0],
        n = e[1],
        r = e[2],
        o = e[4],
        a = e[5],
        s = e[6],
        c = e[8],
        l = e[9],
        h = e[10];
    return t[0] = i, t[1] = o, t[2] = c, t[4] = n, t[5] = a, t[6] = l, t[8] = r, t[9] = s, t[10] = h, t !== e && (t[12] = e[12], t[13] = e[13], t[14] = e[14], t[3] = e[3], t[7] = e[7], t[11] = e[11], t[15] = e[15]), t
}, mat4.invertOrtho = function (e, t) {
    t || (t = e);
    var i = mat4.getTranslation(e);
    mat4.transpose3x3(e, t), t[12] = t[13] = t[14] = 0;
    var n = mat4.multiplyVec3(t, i);
    return t[12] = -n[0], t[13] = -n[1], t[14] = -n[2], t
}, mat4.getXYZRotation = function (e, t, i) {
    var n, r, o = vec3.create([1, 0, 0]),
        a = mat4.mult33(e, o);
    if (F.closeTo(a[0], 0) && F.closeTo(a[1], 0) && F.closeTo(1 - Math.abs(a[2]), 0)) t[0] = 0, i[0] = 0, a[2] > 0 ? (t[1] = 1.5 * Math.PI, i[1] = t[1]) : (t[1] = .5 * Math.PI, i[1] = t[1]), o = vec3.create([0, 1, 0]), a = mat4.mult33(e, o), n = vec3.dot(o, a), -1 > n ? n = -1 : n > 1 && (n = 1), r = Math.acos(n), 0 !== r && a[0] * o[1] - a[1] * o[0] > 0 && (r = 2 * Math.PI - r), t[2] = r, i[2] = r;
    else {
        var s = vec3.create([a[0], a[1], 0]);
        vec3.normalize(s), n = vec3.dot(s, o), -1 > n ? n = -1 : n > 1 && (n = 1), r = Math.acos(n), 0 !== r && s[0] * o[1] - s[1] * o[0] > 0 && (r = 2 * Math.PI - r), i[2] = r + Math.PI, r > Math.PI && (i[2] = r - Math.PI), t[2] = r;
        var c = mat4.identity();
        mat4.rotate(c, -t[2], [0, 0, 1]);
        var l = mat4.mult33(c, a);
        n = vec3.dot(l, o), -1 > n ? n = -1 : n > 1 && (n = 1);
        var h = Math.acos(n);
        0 !== h && l[0] * o[2] - l[2] * o[0] < 0 && (h = 2 * Math.PI - h), t[1] = h, c = mat4.identity(), mat4.rotate(c, -i[2], [0, 0, 1]), l = mat4.mult33(c, a), n = vec3.dot(l, o), -1 > n ? n = -1 : n > 1 && (n = 1);
        var d = Math.acos(n);
        0 !== d && l[0] * o[2] - l[2] * o[0] < 0 && (d = 2 * Math.PI - d), i[1] = d;
        var u = vec3.create([0, 0, 1]),
            _ = mat4.create(e);
        mat4.invertOrtho(_);
        var p = mat4.mult33(_, u),
            g = vec3.create([0, p[1], p[2]]);
        vec3.normalize(g), n = vec3.dot(g, u), -1 > n ? n = -1 : n > 1 && (n = 1);
        var f = Math.acos(n);
        0 !== f && g[1] * u[2] - g[2] * u[1] < 0 && (f = 2 * Math.PI - f), t[0] = f, i[0] = f + Math.PI, f > Math.PI && (i[0] = f - Math.PI)
    }
}, mat4.mult33 = function (e, t) {
    for (var i = vec3.create([0, 0, 0]), n = 3; n--;)
        for (var r = 3; r--;) i[r] += t[n] * e[4 * n + r];
    return i
}, mat4.trafoInRefSystem = function (e, t) {
    var i = mat4.invertOrtho(t, mat4.create());
    return mat4.multiply(i, e, mat4.create())
}, mat4.posInRefSystem = function (e, t) {
    var i = mat4.invertOrtho(t, mat4.create());
    return mat4.multiplyVec3(i, e, vec3.create())
}, mat4.positionsInRefSystem = function (e, t) {
    for (var i = [], n = e.length, r = 0; n > r; ++r) i.push(mat4.posInRefSystem(e[r], t));
    return i
}, vec2.distToLine = function (e, t, i) {
    var n, r, o = vec2.create(),
        a = vec2.create();
    return vec2.subtract(t, e, o), r = 0 === o[0] ? (i[1] - e[1]) / o[1] : (o[1] / o[0] * (i[1] - e[1]) + (i[0] - e[0])) / (o[1] * o[1] / o[0] + o[0]), r >= 0 && 1 >= r ? 0 === o[0] ? (a[0] = e[0], a[1] = i[1]) : (vec2.scale(o, r, o), vec2.add(e, o, a)) : a = r > 1 ? t : e, n = vec2.subtract(i, a, n), vec2.length(n)
}, vec3.angle = function (e, t) {
    var i = vec3.cross(e, t, vec3.create()),
        n = vec3.length(i),
        r = vec3.dot(e, t),
        o = Math.atan2(n, r);
    return o
}, vec3.dist2 = function (e, t) {
    var i = t[0] - e[0],
        n = t[1] - e[1],
        r = t[2] - e[2];
    return i * i + n * n + r * r
}, vec3.fromPolar = function (e, t, i, n) {
    n || (n = vec3.create()), i += .5 * Math.PI;
    var r = Math.sin(i);
    return n[0] = e * Math.cos(-t) * r, n[1] = e * Math.sin(-t) * r, n[2] = -e * Math.cos(i), n
}, vec3.fromCartesianToSpherical = function (e, t) {
    var i = e[0],
        n = e[1],
        r = e[2],
        o = i * i + n * n,
        a = r * r,
        s = Math.atan2(n, i);
    s = (s + 2 * Math.PI) % (2 * Math.PI);
    var c;
    c = 0 !== o ? -Math.atan(r / Math.sqrt(o)) : r >= 0 ? -.5 * Math.PI : .5 * Math.PI;
    var l = Math.sqrt(o + a);
    return t[0] = s, t[1] = c, t[2] = l, t
}, vec3.intersectLineWithXYPlane = function (e, t, i) {
    var n = vec3.create();
    if (vec3.subtract(t, e, n), 0 === n[2]) return void 0;
    var r = (i - e[2]) / n[2];
    return 0 > r || r > 1 || isNaN(r) ? null : (vec3.scale(n, r), vec3.add(n, e, n))
}, vec3.intersectLineWithYZPlane = function (e, t, i) {
    var n = vec3.create();
    if (vec3.subtract(t, e, n), 0 === n[0]) return void 0;
    var r = (i - e[0]) / n[0];
    return 0 > r || r > 1 || isNaN(r) ? null : (vec3.scale(n, r), vec3.add(n, e, n))
}, vec3.intersectLineWithXZPlane = function (e, t, i) {
    var n = vec3.create();
    if (vec3.subtract(t, e, n), 0 === n[1]) return void 0;
    var r = (i - e[1]) / n[1];
    return 0 > r || r > 1 || isNaN(r) ? null : (vec3.scale(n, r), vec3.add(n, e, n))
}, vec3.intersectLineWithAxisAlignedPlane = function (e, t, i, n) {
    switch (i) {
        case 0:
            return vec3.intersectLineWithYZPlane(e, t, n);
        case 1:
            return vec3.intersectLineWithXZPlane(e, t, n);
        case 2:
            return vec3.intersectLineWithXYPlane(e, t, n)
    }
}, vec3.intersectAABoxWithFrustum = function (e, t, i) {
    for (var n = e[0], r = e[1], o = e[2], a = t[0], s = t[1], c = t[2], l = 1, h = 0; 6 > h; h++) {
        var d = i[h],
            u = d[0],
            _ = u[0],
            p = u[1],
            g = u[2],
            f = d[1],
            m = 0 > _ ? n : a,
            v = 0 > p ? r : s,
            S = 0 > g ? o : c,
            b = _ >= 0 ? n : a,
            y = p >= 0 ? r : s,
            P = g >= 0 ? o : c,
            M = m * _ + v * p + S * g + f;
        if (0 > M) return -1;
        var w = b * _ + y * p + P * g + f;
        0 > w && (l = 0)
    }
    return l
}, vec4.intersectLineWithXYZHyperPlane = function (e, t, i) {
    var n = new MatrixArray(4);
    if (vec4.subtract(t, e, n), 0 === n[3]) return void 0;
    var r = (i - e[3]) / n[3];
    return 0 > r || r > 1 || isNaN(r) ? null : (vec4.scale(n, r, n), vec4.add(n, e, n))
}, vec3.clipLineToAxisAlignedPlane = function (e, t, i, n, r) {
    var o = vec3.intersectLineWithAxisAlignedPlane(e, t, i, n);
    return o ? (e[i] < n && r || e[i] > n && !r ? (e[0] = o[0], e[1] = o[1], e[2] = o[2]) : (t[i] < n && r || t[i] > n && !r) && (t[0] = o[0], t[1] = o[1], t[2] = o[2]), !0) : !1
}, vec3.clipLineToUniformCube = function (e, t) {
    var i = 0;
    return vec3.clipLineToAxisAlignedPlane(e, t, 0, -1, !0) && i++, 2 >= i && vec3.clipLineToAxisAlignedPlane(e, t, 0, 1, !1) && i++, 2 >= i && vec3.clipLineToAxisAlignedPlane(e, t, 1, -1, !0) && i++, 2 >= i && vec3.clipLineToAxisAlignedPlane(e, t, 1, 1, !1) && i++, 2 >= i && vec3.clipLineToAxisAlignedPlane(e, t, 2, -1, !0) && i++, 2 >= i && vec3.clipLineToAxisAlignedPlane(e, t, 2, 1, !1) && i++, i > 0
}, vec4.clipLineToXYZHyperPlane = function (e, t, i, n) {
    var r = vec4.intersectLineWithXYZHyperPlane(e, t, i);
    return r ? (e[3] < i && n || e[3] > i && !n ? (e[0] = r[0], e[1] = r[1], e[2] = r[2], e[3] = r[3]) : (t[3] < i && n || t[3] > i && !n) && (t[0] = r[0], t[1] = r[1], t[2] = r[2], t[3] = r[3]), !0) : !1
}, vec2.isTriangleVisible = function (e, t, i, n, r) {
    return (e[0] >= 0 || t[0] >= 0 || i[0] >= 0) && (e[1] >= 0 || t[1] >= 0 || i[1] >= 0) && (e[0] < n || t[0] < n || i[0] < n) && (e[1] < r || t[1] < r || i[1] < r)
}, window.Float64Array && (setMatrixArrayType(Float64Array), MatrixArray = Float64Array), WS.BoundingBox3d = function (e) {
    this._min = void 0, this._max = void 0, e && this.addPoints(e)
}, WS.BoundingBox3d.prototype = {
    isValid: function () {
        return !!this._min && !!this._max
    },
    addPoint: function (e) {
        this.isValid() ? (e[0] < this._min[0] ? this._min[0] = e[0] : this._max[0] < e[0] && (this._max[0] = e[0]), e[1] < this._min[1] ? this._min[1] = e[1] : this._max[1] < e[1] && (this._max[1] = e[1]), e[2] < this._min[2] ? this._min[2] = e[2] : this._max[2] < e[2] && (this._max[2] = e[2])) : (this._min = [e[0], e[1], e[2]], this._max = [e[0], e[1], e[2]])
    },
    addPoints: function (e) {
        for (var t = 0, i = e.length; i > t; ++t) this.addPoint(e[t])
    },
    getCenter: function () {
        return [(this._min[0] + this._max[0]) / 2, (this._min[1] + this._max[1]) / 2, (this._min[2] + this._max[2]) / 2]
    },
    getLongestLength: function () {
        return Math.max(this._max[0] - this._min[0], this._max[1] - this._min[1], this._max[2] - this._min[2])
    },
    determineOrientation: function (e) {
        for (var t = this.getLongestLength(), i = [this._min[0] + t / 2, this._min[1] + t / 2, this._min[2] + t / 2], n = i[0], r = i[1], o = i[2], a = {
            id: 1,
            m: []
        }, s = {
            id: 2,
            m: []
        }, c = {
            id: 3,
            m: []
        }, l = {
            id: 4,
            m: []
        }, h = {
            id: 5,
            m: []
        }, d = {
            id: 6,
            m: []
        }, u = {
            id: 7,
            m: []
        }, _ = {
            id: 8,
            m: []
        }, p = [a, s, c, l, h, d, u, _], g = 0, f = e.length; f > g; ++g) {
            var m = e[g],
                v = m[0],
                S = m[1],
                b = m[2];
            n >= v && r >= S && o >= b ? a.m.push(m) : v > n && r >= S && o >= b ? s.m.push(m) : n >= v && S > r && o >= b ? c.m.push(m) : v > n && S > r && o >= b ? l.m.push(m) : n >= v && r >= S && b > o ? h.m.push(m) : v > n && r >= S && b > o ? d.m.push(m) : n >= v && S > r && b > o ? u.m.push(m) : _.m.push(m)
        }
        p.sort(function (e, t) {
            return t.m.length - e.m.length
        });
        var y = p[0].id,
            P = p[1].id;
        if (y > P) {
            var M = y;
            y = P, P = M
        }
        return 1 === y && 2 === P || 1 === y && 6 === P || 3 === y && 4 === P || 3 === y && 8 === P || 5 === y && 6 === P || 2 === y && 5 === P || 7 === y && 8 === P || 4 === y && 7 === P ? "x" : 1 === y && 3 === P || 1 === y && 7 === P || 2 === y && 4 === P || 2 === y && 8 === P || 5 === y && 7 === P || 3 === y && 5 === P || 6 === y && 8 === P || 4 === y && 6 === P ? "y" : 1 === y && 5 === P || 2 === y && 6 === P || 3 === y && 7 === P || 4 === y && 8 === P ? "z" : 1 === y && 4 === P || 1 === y && 8 === P || 5 === y && 8 === P || 4 === y && 5 === P ? "y+" : "y-"
    }
}, WS.extend("BoundingBox3d"), WS.Transform = function () {
    this._transform = mat4.identity()
}, WS.Transform.prototype = {
    rotate: function (e, t) {
        mat4.rotate(this._transform, e, t)
    },
    rotateX: function (e) {
        mat4.rotateX(this._transform, e)
    },
    rotateY: function (e) {
        mat4.rotateY(this._transform, e)
    },
    rotateZ: function (e) {
        mat4.rotateZ(this._transform, e)
    },
    translate: function (e) {
        var t = this.getTranslation();
        vec3.add(t, e, t), this.setTranslation(t)
    },
    setTranslation: function (e) {
        mat4.setTranslation(this._transform, e)
    },
    getTranslation: function () {
        return mat4.getTranslation(this._transform)
    },
    getX: function () {
        return this._transform[12]
    },
    getY: function () {
        return this._transform[13]
    },
    getZ: function () {
        return this._transform[14]
    }
}, WS.extend("Transform", "SceneNode"), WS.Renderable = function () {
    this._layerId = WS.Layer.LayerIDs.DEFAULT, this._viewingMode = WS.Renderable.ViewingMode.Normal, this._dataObject = void 0, this._UUID = void 0, this._layerService = F.DI().getService("layer"), this._pickable3d = !1
}, WS.Renderable.prototype = {
    assignPickColors: function (e) {
        var t = e.assignColorToRenderable(this),
            i = [t[0] / 255, t[1] / 255, t[2] / 255, t[3] / 255];
        this.setPickColor(i)
    },
    setPickColor: function (e) {
        this._material._pickColor = e
    },
    addToLayer: function (e, t, i) {
		//chi add Pano va Scans layer
        if (this._layerId = e, t) {
            var n = this.getMemberRenderables();
            n.forEach(function (i) {
                i.addToLayer(e, t, !1)
            })
        }
        if (i) {
            var r = function () {
                    return !0
                },
                o = function (i) {
                    return i.instanceOf(WS.Renderable) && i.addToLayer(e, t, !1), !0
                };
            this.traverseInternal(r, o, r)
        }
    },
    draw3d: function () {
    },
    draw2d: function () {
    },
    setViewingMode: function (e) {
        e !== this._viewingMode && (this._viewingMode = e, this.onViewingModeChange())
    },
    update: function () {
    },
    onViewingModeChange: function () {
    },
    drawMemberRenderables: function (e, t, i, n) {
		
        for (var r = this.getVisibleMemberRenderables(), o = e._modelMatrixStack, a = 0, s = r.length; s > a; a++) {
            var c = r[a];
            if (c && c[t]) {
                var l = o.addOrthoMatrix(c._transform, !0);
                c[t](e, i, t), l && o.popMatrix()
            }
        }
    },
    drawMemberRenderables2d: function (e, t, i) {
        this.drawMemberRenderables(e, "draw2d", t, i)
    },
    drawMemberRenderables3d: function (e, t, i) {
		//ve diem scan trong panoramaview
        this.drawMemberRenderables(e, "draw3d", t, i)
    },
    getPickInfoOfMemberRenderable: function (e, t, i, n, r) {
        var o, a, s = mat4.create();
        for (o = i.length - 1; o >= 0; --o) {
            var c = i[o];
            if (c && c.getPickInfo && (mat4.multiply(t, c._transform, s), a = c.getPickInfo(e, s, n, r), void 0 !== a)) return a
        }
        return a
    },
    getPickInfo: function () {
        return void 0
    },
    getRegionPickInfo: function () {
        return void 0
    },
    supportsDragging: function () {
        return !1
    },
    dragStart: function () {
    },
    dragMove: function () {
    },
    dragStop: function () {
    },
    getVisibleMemberRenderables: function () {
        return this.getMemberRenderables()
    },
    getMemberRenderables: function () {
        return []
    },
    setDirect: function () {
    },
    setDataObject: function (e) {
        this._dataObject = e, this._categoryLabel && this._categoryLabel.setDataObject(e)
    },
    getUuid: function () {
        return this._UUID || this._dataObject._UUID
    }
}, WS.extend("Renderable", "Transform"), WS.Renderable.ViewingMode = {
    Inconsiderable: 1,
    Normal: 2,
    Selected: 3,
    Highlighted: 4,
    Displayed: 5
}, WS.Mesh = function (e, t) {
    this._material = t, this._geometry = e
}, WS.Mesh.prototype = {
    draw3d: function (e, t, i) {
        if (i || t(this)) {
            e.setAndPrepareGeometry(this._geometry);
            var n = e.setAndPrepareMaterial(this._material);
            n && e.drawGeometry()
        }
    },
    draw2d: function (e, t, i) {
        if (i || t(this)) {
            e.setAndPrepareGeometry(this._geometry);
            var n = e.setAndPrepareMaterial(this._material);
            n && e.drawGeometry()
        }
    }
}, WS.extend("Mesh", "Renderable"), WS.SpinnerRenderable = function (e, t) {
    this._text = e, this._position = t, this._fullOpSpinnerElementIndex = 0, this._spinElementWidth = WS.SpinnerRenderable.SpinElementWidth, this._spinElementHeight = WS.SpinnerRenderable.SpinElementHeight, this._countSpinElements = WS.SpinnerRenderable.CountSpinElements, this._rotationSpeed = WS.SpinnerRenderable.RotationSpeed, this._fontStyle = WS.SpinnerRenderable.FontStyle, this._spinnerColor = WS.SpinnerRenderable.SpinnerColor, this._timeLastIndexChange = 0, this._extractFontSizeRegEx = /\D*(\d*)\D*/, this.addToLayer(WS.Layer.LayerIDs.TEMP)
}, WS.SpinnerRenderable.prototype = {
    draw2d: function (e, t) {
		if (t(this)) {
            var i = e._ctx,
                n = this._spinElementWidth - this._spinElementHeight,
                r = n / 2,
                o = this._spinElementHeight,
                a = o / 2;
            i.font = this._fontStyle;
            var s = i.measureText(this._text).width,
                c = parseInt(this._extractFontSizeRegEx.exec(this._fontStyle)[1]),
                l = s / 2 + 20,
                h = 1,
                d = (new Date).getTime(),
                u = d - this._timeLastIndexChange;
            u > 1e3 / (this._rotationSpeed * this._countSpinElements) && (this._fullOpSpinnerElementIndex = (this._fullOpSpinnerElementIndex + 1) % this._countSpinElements, this._timeLastIndexChange = d), i.translate(this._position[0], this._position[1]), i.beginPath(), i.arc(0, 0, l + 30, 0, 2 * Math.PI, !1), i.fillStyle = "rgba(255,255,255,0.5)", i.fill(), i.save(), i.rotate(2 * this._fullOpSpinnerElementIndex * Math.PI / this._countSpinElements);
            for (var _ = 0; _ < this._countSpinElements; _++) this._spinnerColor[3] = h, i.fillStyle = WS.Renderer2D.colorToStyle(this._spinnerColor), i.rotate(2 * Math.PI / this._countSpinElements), i.save(), i.translate(l, 0), i.beginPath(), i.moveTo(-r, -a), i.lineTo(r, -a), i.arc(r, 0, a, 1.5 * Math.PI, .5 * Math.PI, !1), i.lineTo(-r, a), i.arc(-r, 0, a, .5 * Math.PI, 1.5 * Math.PI, !1), i.fill(), i.restore(), h -= 1 / this._countSpinElements;
            i.restore(), this._spinnerColor[3] = 1, i.fillStyle = WS.Renderer2D.colorToStyle(this._spinnerColor), i.fillText(this._text, -s / 2, c / 2 - 2), i.setTransform(1, 0, 0, 1, 0, 0)
        }
    },
    draw3d: function () {
    }
}, WS.extend("SpinnerRenderable", "Renderable"), WS.SpinnerRenderable.SpinElementWidth = 30, WS.SpinnerRenderable.SpinElementHeight = 12, WS.SpinnerRenderable.CountSpinElements = 12, WS.SpinnerRenderable.RotationSpeed = 1, WS.SpinnerRenderable.FontStyle = "bold 15px Arial", WS.SpinnerRenderable.SpinnerColor = [0, 0, 0, 1], WS.CompassRenderable = function (e) {
    e = e ? parseInt(e) : WS.CompassRenderable.CompassModes.Degree, this._compassMode = e, this._image = new WS.Image(this._compassMode === WS.CompassRenderable.CompassModes.Gon ? WS.CompassRenderable.IMG_URL_GON : WS.CompassRenderable.IMG_URL_DEG), this._steps = this._compassMode === WS.CompassRenderable.CompassModes.Gon ? WS.CompassRenderable.STEPS_GON : WS.CompassRenderable.STEPS_DEG, this._bg = new WS.Image(WS.CompassRenderable.BG_URL), this._backgroundColor = WS.CompassRenderable.BackgroundColor, this._componentWidth = WS.CompassRenderable.COMPASS_WIDTH, this._componentHeight = WS.CompassRenderable.COMPASS_HEIGHT, this._pixelPerStep = WS.CompassRenderable.PIX_PER_STEP, this._marginBottom = WS.CompassRenderable.MARGIN_BOTTOM, this._imgWidth = this._pixelPerStep * this._steps, this._imgHeight = WS.CompassRenderable.IMAGE_HEIGHT, this.addToLayer(WS.Layer.LayerIDs.TEMP), this._image.loadImage(), this._bg.loadImage()
}, WS.CompassRenderable.prototype = {
    setCompassMode: function (e) {
        e = parseInt(e), e !== this._compassMode && (this._compassMode = e, this._image = new WS.Image(e === WS.CompassRenderable.CompassModes.Gon ? WS.CompassRenderable.IMG_URL_GON : WS.CompassRenderable.IMG_URL_DEG), this._image.loadImage(), this._steps = e === WS.CompassRenderable.CompassModes.Gon ? WS.CompassRenderable.STEPS_GON : WS.CompassRenderable.STEPS_DEG, this._imgWidth = this._pixelPerStep * this._steps)
    },
    draw2d: function (e, t, i, n) {
        if (t(this)) {
            var r = e._ctx;
            if (r) {
                var o = .5 * (e._canvasWidth - this._componentWidth),
                    a = e._canvasHeight - this._marginBottom;
                r.drawImage(this._bg.getRawImage(), o, a, this._componentWidth, this._componentHeight);
                var s, c = this.getBearing(e._camera, n),
                    l = c * this._pixelPerStep - .5 * this._componentWidth;
                if (0 > l) s = Math.abs(l), r.drawImage(this._image.getRawImage(), this._imgWidth - s, 0, s, this._imgHeight, o, a, s, this._componentHeight), r.drawImage(this._image.getRawImage(), 0, 0, this._componentWidth - s, this._imgHeight, o + s, a, this._componentWidth - s, this._componentHeight);
                else {
                    s = this._imgWidth - l;
                    var h = Math.min(s, this._componentWidth);
                    if (r.drawImage(this._image.getRawImage(), l, 0, h, this._imgHeight, o, a, h, this._componentHeight), s < this._componentWidth) {
                        var d = this._componentWidth - (this._imgWidth - l),
                            u = Math.abs(d),
                            _ = o + this._componentWidth - u;
                        r.drawImage(this._image.getRawImage(), 0, 0, u, this._imgHeight, _, a, u, this._componentHeight)
                    }
                }
                r.beginPath(), r.rect(o - 1 + .5 * this._componentWidth, a - 2, 2, this._componentHeight + 4), r.fillStyle = WS.CompassRenderable.NeedleColor, r.fill()
            }
        }
    },
    draw3d: function () {
    },
    getBearing: function (e, t) {
        var i = e.createCameraObject(t),
            n = i.getAxisGlobal();
        vec3.scale(n, -1), n[2] = 0, vec3.normalize(n, n);
        var r = vec3.create([0, 1, 0]),
            o = Math.acos(vec3.dot(r, n)) * (this._steps / 2 / Math.PI);
        return n[0] < 0 && (o = this._steps - o), o
    }
}, WS.extend("CompassRenderable", "Renderable"), WS.CompassRenderable.BackgroundColor = "rgba(0,0,0,0.4)", WS.CompassRenderable.NeedleColor = "rgba(250,181,2,0.85)", WS.CompassRenderable.IMG_URL_GON = WS.imgUrlCanvasSafe("assets/bearinggon.png"), WS.CompassRenderable.IMG_URL_DEG = WS.imgUrlCanvasSafe("assets/bearing.png"), WS.CompassRenderable.BG_URL = WS.imgUrlCanvasSafe("assets/bearing_bg.png"), WS.CompassRenderable.COMPASS_WIDTH = 180, WS.CompassRenderable.COMPASS_HEIGHT = 33, WS.CompassRenderable.IMAGE_HEIGHT = 33, WS.CompassRenderable.PIX_PER_STEP = 3, WS.CompassRenderable.MARGIN_BOTTOM = 60, WS.CompassRenderable.STEPS_DEG = 360, WS.CompassRenderable.STEPS_GON = 400, WS.CompassRenderable.CompassModes = {
    Degree: 0,
    Gon: 1
}, WS.RectangleRenderable = function () {
    this._corners = void 0, this._fillStyle = void 0, this._strokeStyle = void 0, this._lineWidth = 1, this._lineDash = void 0
}, WS.RectangleRenderable.prototype = {
    setFillStyle: function (e) {
        this._fillStyle = e
    },
    setStrokeStyle: function (e) {
        this._strokeStyle = e
    },
    setLineWidth: function (e) {
        this._lineWidth = e
    },
    setLineDash: function (e) {
        this._lineDash = e
    },
    setCorners: function (e) {
        this._corners = e
    },
    draw2d: function (e, t, i) {
        if (i || t(this)) {
            var n = this._corners,
                r = e._ctx;
            n && r && (r.beginPath(), r.rect(n[0], n[1], n[2] - n[0], n[3] - n[1]), r.fillStyle = this._fillStyle, r.fill(), this._lineDash && r.setLineDash && r.setLineDash(this._lineDash), r.lineWidth = this._lineWidth, r.strokeStyle = this._strokeStyle, r.stroke())
        }
    },
    draw3d: function () {
    }
}, WS.extend("RectangleRenderable", "Renderable"), WS.SelectionRenderable = function () {
    this.setStrokeStyle("#000"), this.setLineDash([5]), this.addToLayer(WS.Layer.LayerIDs.TEMP)
}, WS.SelectionRenderable.prototype = {
    setAppearance: function (e) {
        this.setFillStyle(e ? WS.SelectionRenderable.FillStyleAdd : WS.SelectionRenderable.FillStyleSub)
    }
}, WS.extend("SelectionRenderable", "RectangleRenderable"), WS.SelectionRenderable.FillStyleAdd = "rgba(110,243,110,0.5)", WS.SelectionRenderable.FillStyleSub = "rgba(223,130,130,0.5)", WS.PickInfo = function (e) {
    this._list = [e]
}, WS.PickInfo.prototype = {
    add: function (e) {
        this._list.push(e)
    }
}, WS.extend("PickInfo"), WS.Image = function (e, t) {
    var i = this;
    this._imageSrc = e, this._image = new Image, this._isCrossOrigin = 0 === e.indexOf("//") || 0 === e.indexOf("http://") || 0 === e.indexOf("https://"), this._isCrossOrigin && F.isImgCrossOriginAvailable() && (this._image.crossOrigin = "anonymous"), this._filter = void 0 !== t ? t : WS.Image.Filter.Linear, this._isLoaded = !1, this._isLoading = !1, this._image.onload = function () {
        i._isLoaded = !0, i._isLoading = !1, i.informListener(WS.Image.OnLoadFuncName, [])
    }
}, WS.Image.prototype = {
    getWidth: function () {
        return this._image ? this._image.width : 0
    },
    getHeight: function () {
        return this._image ? this._image.height : 0
    },
    addListener: function (e) {
        WS.Observable.prototype.addListener.call(this, e), this.loadImage(), this.isLoaded() && e[WS.Image.OnLoadFuncName] && e[WS.Image.OnLoadFuncName]()
    },
    loadImage: function () {
        this._isLoaded || this._isLoading || (this._isLoading = !0, this._image.src = this._imageSrc)
    },
    isLoaded: function () {
        return this._isLoaded
    },
    setImageFilter: function (e) {
        this._filter = e, this.informListener(WS.Image.OnParameterChangeFuncName, [])
    },
    getRawImage: function () {
        return this._image
    },
    getDownSampleFactor: function () {
        var e = this.getSize();
        return F.isMobileSafari() && this.getSize() > 2097152 ? Math.ceil(Math.sqrt(e / 2097152)) : 1
    },
    isJPG: function () {
        if (this._imageSrc) {
            var e = this._imageSrc;
            return -1 != e.indexOf(".jpg") || -1 != e.indexOf(".JPG")
        }
        return !1
    },
    getSize: function () {
        return this.getWidth() * this.getHeight()
    }
}, WS.extend("Image", "Observable"), WS.Image.Filter = {
    Linear: "LINEAR",
    Nearest: "NEAREST"
}, WS.Image.OnLoadFuncName = "onImageLoad", WS.Image.OnParameterChangeFuncName = "onParameterChange", WS.SpriteRenderable = function (e, t) {
    this._savedOriginalLayer = void 0, WS.Mesh.call(this, e, t)
}, WS.SpriteRenderable.prototype = {
    setDirect: function (e) {
        e ? (this._savedOriginalLayer = this._layerId, this.addToLayer(WS.Layer.LayerIDs.DYNAMIC, !0)) : (this._layerId === WS.Layer.LayerIDs.DYNAMIC && void 0 !== this._savedOriginalLayer && this.addToLayer(this._savedOriginalLayer, !0), this._savedOriginalLayer = void 0)
    },
    draw2d: function (e, t, i) {
        (i || t(this)) && (this._layerId === WS.Layer.LayerIDs.DYNAMIC ? this.drawCanvas(e) : this.drawImage(e))
    },
    drawCanvas: function (e) {
        var t = this._material._canvas;
        if (t) {
            var i = this.getRectOnScreen(e._camera, e.getModelMatrix(), e._viewport.getWidth(), e._viewport.getHeight());
            i && e._ctx.drawImage(t, i._topLeftX, i._topLeftY, i._width, i._height)
        }
    },
    drawImage: function (e) {
        var t = this._material.getImage(0);
        if (t)
            if (t.isLoaded()) {
                var i = this.getRectOnScreen(e._camera, e.getModelMatrix(), e._viewport.getWidth(), e._viewport.getHeight());
                if (!i) return;
                e._ctx.drawImage(t.getRawImage(), i._topLeftX, i._topLeftY, i._width, i._height)
            } else t.loadImage()
    },
    drawPick: function (e, t) {
        var i, n, r = this._material;
        this._canvas || (this._canvas = document.createElement("canvas")), n = this._canvas, i = n.getContext("2d");
        var o = r.getImage(0);
        if (o)
            if (o.isLoaded()) {
                var a = this.getRectOnScreen(e, t);
                a && (a._topLeftX = 0, a._topLeftY = 0, n.width = a._width, n.height = a._height, i.clearRect(0, 0, a._width, a._height), i.drawImage(o.getRawImage(), a._topLeftX, a._topLeftY, a._width, a._height))
            } else o.loadImage()
    },
    getPickColor: function (e, t) {
        var i = this._canvas.getContext("2d");
        return i.getImageData(e, t, 1, 1).data
    },
    getRectOnScreen: function (e, t, i, n) {
        var r = i || e._width,
            o = n || e._height,
            a = this._material,
            s = a._spriteSize[0],
            c = a._spriteSize[1],
            l = new MatrixArray(4),
            h = new MatrixArray(4);
        h[3] = 1;
        var d, u = e._inverseTransform,
            _ = vec3.create(),
            p = vec3.create(),
            g = new MatrixArray(4),
            f = new MatrixArray(4),
            m = this._geometry,
            v = [0, 0, 0, 1];
        if (mat4.multiplyVec3(t, v, h), d = e.projectPoint(h, l, !0, r, o), !d) return void 0;
        var S = m._positionBuffer._bufferData;
        return a._scaleByDepth ? (p[0] = u[0], p[1] = u[1], p[2] = u[2], _[0] = u[4], _[1] = u[5], _[2] = u[6], g[0] = p[0], g[1] = p[1], g[2] = p[2], g[3] = 1, vec3.add(vec3.add(vec3.scale(g, a._spriteSize[0] * S[2]), vec3.scale(vec3.create(_), a._spriteSize[1] * S[3])), h), e.projectPoint(g, g, !0, r, o), f[0] = p[0], f[1] = p[1], f[2] = p[2], f[3] = 1, vec3.add(vec3.add(vec3.scale(f, a._spriteSize[0] * S[4]), vec3.scale(_, a._spriteSize[1] * S[5])), h), e.projectPoint(f, f, !0, r, o), s = f[0] - g[0], c = g[1] - f[1]) : (g[0] = l[0] + .5 * s * S[2], g[1] = l[1] + .5 * c * S[3]), new WS.Rectangle(Math.round(g[0]), Math.round(o - g[1]), Math.round(s), Math.round(c))
    },
    getPickInfo: function (e, t, i, n) {
        var r = this.getRectOnScreen(e, t);
        if (!r) return void 0;
        if (r.containsPt(i, n)) {
            this.drawPick(e, t);
            var o = this.getPickColor(i - r._topLeftX, n - r._topLeftY);
            if (o[3] > 0) return new WS.PickInfo(this)
        }
        return void 0
    },
    getRegionPickInfo: function (e, t, i) {
        var n = this.getRectOnScreen(e, t);
        if (n) return i.containsRect(n) ? new WS.PickInfo(this) : void 0
    }
}, WS.extend("SpriteRenderable", "Mesh"), WS.ClickableSpriteRenderable = function (e, t, i, n, r) {
    WS.SpriteRenderable.call(this, e, t), this._type = i, this.setDataObject(n), this._clickId = r
}, WS.extend("ClickableSpriteRenderable", "SpriteRenderable"), WS.ClickableSpriteRenderable.Type = {
    MEASUREMENT_POINT: "measurementPt"
}, WS.DynamicQuadGeometry = function () {
    WS.Geometry.call(this), this._positionBuffer = new WS.ArrayBuffer([0, 0, 0, 2, 2, 0, 2, 2], 2), this._primitiveType = WS.Geometry.PrimitiveType.TriangleStrip
}, WS.DynamicQuadGeometry.prototype = {
    setPosition: function (e, t, i, n) {
        if (0 === e && 0 === t) this._positionBuffer.setBufferData([0, 0, 0, 2, 2, 0, 2, 2]);
        else {
            var r = 2 * e / i,
                o = 2 * t / n;
            this._positionBuffer.setComponent(0, 0, 0 - r, !0), this._positionBuffer.setComponent(0, 1, 0 - o, !0), this._positionBuffer.setComponent(1, 0, 0 - r, !0), this._positionBuffer.setComponent(1, 1, 2 - o, !0), this._positionBuffer.setComponent(2, 0, 2 - r, !0), this._positionBuffer.setComponent(2, 1, 0 - o, !0), this._positionBuffer.setComponent(3, 0, 2 - r, !0), this._positionBuffer.setComponent(3, 1, 2 - o, !1)
        }
    }
}, WS.extend("DynamicQuadGeometry", "Geometry"), WS.LabelRenderable = function () {
    this._text = void 0, this._textHeight = WS.LabelRenderable.TEXT_HEIGHT, this._borderAddWidth = WS.LabelRenderable.BORDER_ADD_WIDTH, this._borderAddHeight = this._textHeight - 2, this._lineBreakHeight = WS.LabelRenderable.LINE_BREAK_HEIGHT, this._font = WS.LabelRenderable.FONT, this._backgroundColor = vec4.create(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL), this._shadowColor = vec4.create(WS.LabelRenderable.SHADOW_COLOR), this._shadowOffsetX = WS.LabelRenderable.SHADOW_OFFSET_X, this._shadowOffsetY = WS.LabelRenderable.SHADOW_OFFSET_Y, this._shadowBlur = WS.LabelRenderable.SHADOW_BLUR, this._textColor = vec4.create(WS.LabelRenderable.TEXT_COLOR), this._textColorCustom = void 0, this._minBorderWidth = WS.LabelRenderable.MIN_BORDER_WIDTH, this._canvas = document.createElement("canvas"), this._icon = void 0, this._occluded = !1, this._categoryColor = void 0, this._iconMode = WS.LabelRenderable.ICON_MODES.Category;
    var e = new WS.DynamicQuadGeometry,
        t = new WS.SpriteMaterial(void 0, vec2.create([0, 0]), !1, WS.Image.Filter.Nearest);
    WS.SpriteRenderable.call(this, e, t), this.addToLayer(WS.Layer.LayerIDs.ANNOTATIONS)
}, WS.LabelRenderable.prototype = {
	updateanimation: function(){
		this.animateme(),  this._material.setTextureImgUrls([this._canvas.toDataURL()]);

	},
	animateme: function() {
		
	},
    updateImage: function () {
        this.renderToCanvas(), this._material._spriteSize = vec2.createFrom(this._canvas.width, this._canvas.height), this._layerId === WS.Layer.LayerIDs.DYNAMIC ? (this._material._canvas = this._canvas, this._material.clearTextureImages()) : (this._material._canvas = void 0, this._material.setTextureImgUrls([this._canvas.toDataURL()]), this._material.setTextureImgFilter(WS.Image.Filter.Nearest))
    },
    setText: function (e, t) {
        this._text !== e && (this._text = e, t || this.updateImage())
    },
    setTextSize: function (e, t) {
        this._textHeight !== e && (this._textHeight = e, this._borderAddHeight = this._textHeight - 2, t || this.updateImage())
    },
    setTextColor: function (e, t) {
        vec4.equal(e, this._textColor) || (this._textColor = vec4.create(e), t || this.updateImage())
    },
    setCustomTextColor: function (e) {
        this._textColorCustom = vec4.create(e)
    },
    setBackgroundColor: function (e, t) {
        vec4.equal(e, this._backgroundColor) || (this._backgroundColor = vec4.create(e), t || this.updateImage())
    },
    setShadowColor: function (e, t) {
        vec4.equal(e, this._shadowColor) || (this._shadowColor = vec4.create(e), t || this.updateImage())
    },
    setTransparency: function (e, t) {
        this._backgroundColor[3] = e, this._shadowColor[3] = e, this._textColor[3] = e, t || this.updateImage()
    },
    setOcclusion: function (e) {
        this._occluded !== e && (this._occluded = e, this.onViewingModeChange())
    },
    setIconMode: function (e, t) {
        this._iconMode !== e && (this._iconMode = e, this.onIconModeChange(t))
    },
    setCategoryColor: function (e) {
        this._categoryColor = e
    },
    removeIcon: function (e) {
        void 0 !== this._icon && (this._icon = void 0, e || this.updateImage())
    },
    onIconModeChange: function (e) {
        switch (this._iconMode) {
            case WS.LabelRenderable.ICON_MODES.None:
                this.removeIcon(!0);
                break;
            case WS.LabelRenderable.ICON_MODES.Category:
                this.removeIcon(!0), this._categoryColor && (this._icon = new WS.CategoryGraphics2d(this._categoryColor));
                break;
            case WS.LabelRenderable.ICON_MODES.Lockstatus:
                if (this.removeIcon(!0), this._dataObject._writeLock) {
                    var t = new WS.Image(WS.LabelRenderable.ICON_LOCK_URL);
                    t.addListener(this), this._icon = new WS.ImageGraphics2d(t)
                }
        }
        e || this.updateImage()
    },
    onImageLoad: function () {
        this.updateImage()
    },
    onViewingModeChange: function () {
        switch (this._viewingMode) {
            case WS.Renderable.ViewingMode.Normal:
                this.setNormalColors();
                break;
            case WS.Renderable.ViewingMode.Highlighted:
                this.setHighlightedColors();
                break;
            case WS.Renderable.ViewingMode.Selected:
                this.setSelectedColors();
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
                this.setInconsiderableColors();
                break;
            case WS.Renderable.ViewingMode.Displayed:
                this.setDisplayedColors()
        }
        this.updateImage()
    },
    redraw: function () {
        this.updateImage()
    },
    renderToCanvas: function () {
    },
    supportsDragging: function () {
        return !0
    },
    dragStart: function () {
        this.updateImage()
    },
    dragMove: function () {
    },
    dragStop: function () {
        this.updateImage()
    },
    drawShadow: function (e) {
        e.shadowColor = WS.Renderer2D.colorToStyle(this._shadowColor), e.shadowOffsetX = this._shadowOffsetX, e.shadowOffsetY = this._shadowOffsetY, e.shadowBlur = this._shadowBlur, e.fill(), e.shadowOffsetX = e.shadowOffsetY = 0, e.shadowBlur = 0
    },
    setHighlightedColors: function () {
        this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_HIGHLIGHTED, !0), this.setTextColor(WS.LabelRenderable.TEXT_COLOR, !0), this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR, !0), this.setTransparency(WS.LabelRenderable.TRANSPARENCY_SELECTED, !0)
    },
    setSelectedColors: function () {
        this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_SELECTED, !0), this.setTextColor(WS.LabelRenderable.TEXT_COLOR, !0), this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR, !0), this.setTransparency(WS.LabelRenderable.TRANSPARENCY_SELECTED, !0)
    },
    setInconsiderableColors: function () {
        this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL, !0), this.setTextColor(this._textColorCustom ? this._textColorCustom : WS.LabelRenderable.TEXT_COLOR, !0), this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR, !0), this.setTransparency(WS.LabelRenderable.TRANSPARENCY_INCONSIDERABLE, !0)
    },
    setNormalColors: function () {
        this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL, !0), this.setTextColor(this._textColorCustom ? this._textColorCustom : WS.LabelRenderable.TEXT_COLOR, !0), this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR, !0), this.setTransparency(this._occluded ? WS.LabelRenderable.TRANSPARENCY_OCCLUDED : WS.LabelRenderable.TRANSPARENCY_NORMAL, !0)
    },
    setDisplayedColors: function () {
        this.setNormalColors(), this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_DISPLAYED, !0)
    }
}, WS.extend("LabelRenderable", "SpriteRenderable"), WS.LabelRenderable.TEXT_HEIGHT = 12, WS.LabelRenderable.LINE_BREAK_HEIGHT = 5, WS.LabelRenderable.BORDER_ADD_WIDTH = 10, WS.LabelRenderable.FONT = "arial", WS.LabelRenderable.BACKGROUND_COLOR_NORMAL = [.86, .86, .86, .85], WS.LabelRenderable.BACKGROUND_COLOR_DISPLAYED = [.9803921568627451, .7098039215686275, .007843137254902, 1], WS.LabelRenderable.BACKGROUND_COLOR_SELECTED = [.47, .804, .95, 1], WS.LabelRenderable.BACKGROUND_COLOR_HIGHLIGHTED = [.98, .875, .08, 1], WS.LabelRenderable.SHADOW_COLOR = [.25, .25, .25, .85], WS.LabelRenderable.SHADOW_OFFSET_X = 2, WS.LabelRenderable.SHADOW_OFFSET_Y = 2, WS.LabelRenderable.SHADOW_BLUR = 1, WS.LabelRenderable.TEXT_COLOR = [0, 0, 0, .8], WS.LabelRenderable.TRANSPARENCY_SELECTED = 1, WS.LabelRenderable.TRANSPARENCY_NORMAL = .85, WS.LabelRenderable.TRANSPARENCY_OCCLUDED = .5, WS.LabelRenderable.TRANSPARENCY_INCONSIDERABLE = .5, WS.LabelRenderable.MIN_BORDER_WIDTH = 30, WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP = [.25, .25, .25, .85], WS.LabelRenderable.SHADOW_COLOR_MAP = [.86, .86, .86, .85], WS.LabelRenderable.TEXT_COLOR_MAP = [1, 1, 1, .8], WS.LabelRenderable.ICON_LOCK_URL = WS.imgUrlCanvasSafe("icons/lock.png"), WS.LabelRenderable.ICON_CATEGORY = 0, WS.LabelRenderable.ICON_LOCK = 1, WS.LabelRenderable.ICON_MODES = {
    None: 0,
    Category: 1,
    Lockstatus: 2
}, WS.LabelRenderable.ICON_HEIGHT = 24, WS.LabelRenderable.ICON_WIDTH = 24, WS.AnnotationRenderable = function (e) {
    WS.LabelRenderable.call(this), this._hasMapType = "undefined" != typeof e ? e : !1, this._tailOffsetX = 0, this._tailOffsetY = WS.AnnotationRenderable.TAIL_Y_OFFSET_DEFAULT, this._tailWidthX = WS.AnnotationRenderable.TAIL_WIDTH_X, this._tailWidthY = WS.AnnotationRenderable.TAIL_WIDTH_Y, this._tailXGapToEdge = WS.AnnotationRenderable.TAIL_X_GAP_TO_EDGE, this._tailYGapToEdge = WS.AnnotationRenderable.TAIL_Y_GAP_TO_EDGE, this._backgroundColor = vec4.create(this._hasMapType ? WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP : WS.LabelRenderable.BACKGROUND_COLOR_NORMAL), this._shadowColor = vec4.create(this._hasMapType ? WS.LabelRenderable.SHADOW_COLOR_MAP : WS.LabelRenderable.SHADOW_COLOR), this._textColor = vec4.create(this._hasMapType ? WS.LabelRenderable.TEXT_COLOR_MAP : WS.LabelRenderable.TEXT_COLOR)
},
WS.AnnotationRenderable.prototype = {
    setNormalColors: function () {
        var e;
        e = this._hasMapType ? WS.LabelRenderable.TEXT_COLOR_MAP : this._textColorCustom ? this._textColorCustom : WS.LabelRenderable.TEXT_COLOR, this.setBackgroundColor(this._hasMapType ? WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP : WS.LabelRenderable.BACKGROUND_COLOR_NORMAL, !0), this.setTextColor(e, !0), this.setShadowColor(this._hasMapType ? WS.LabelRenderable.SHADOW_COLOR_MAP : WS.LabelRenderable.SHADOW_COLOR, !0), this.setTransparency(this._occluded ? WS.LabelRenderable.TRANSPARENCY_OCCLUDED : WS.LabelRenderable.TRANSPARENCY_NORMAL, !0)
    },
    renderToCanvas: function () {
        this._canvas || (this._canvas = document.createElement("canvas"));
		
        var e = this._canvas.getContext("2d"),
            t = this._textHeight + "px Arial";
        e.font = t;
		//lay dia chi canvas hien thi annotation
						
						

	try{        		

			
			var _obj = mapping2[this._text];
		
		if (_obj != null && _obj != 'undefined') {    
				
				var _uid = _obj.uidparent;
				var _type = _obj.type;
				var _des = _obj.displayname;
        			
			if (_uid == rootUUID) {
				
				
					var i = e.measureText(_des).width;
					i = Math.max(this._minBorderWidth, i);
					var n = i + this._borderAddWidth;
					this._icon && (n += WS.LabelRenderable.ICON_WIDTH);
					var r = this._textHeight + this._borderAddHeight + 50,
					o = this._shadowOffsetX + this._shadowBlur,
					a = this._shadowOffsetY + this._shadowBlur,
					s = .5 * n,
					c = .5 * r + 50,
					l = vec2.createFrom(0, 50),
					h = vec2.createFrom(s, 50),
					d = vec2.createFrom(n, 50),
					u = vec2.createFrom(n, c),
					_ = vec2.createFrom(n, r),
					p = vec2.createFrom(s, r),
					g = vec2.createFrom(0, r),
					f = vec2.createFrom(0, c);
					e.canvas.width = n + o, e.canvas.height = r + a +25, e.clearRect(0, 0, e.canvas.width, e.canvas.height);
					var m = 5;
					e.fillStyle = WS.Renderer2D.colorToStyle(this._backgroundColor), e.beginPath(), e.moveTo(h[0], h[1]), e.arcTo(d[0], d[1], d[0], d[1] + m, m), e.lineTo(u[0], u[1]), e.arcTo(_[0], _[1], _[0] - m, _[1], m), e.lineTo(p[0], p[1]), e.arcTo(g[0], g[1], g[0], g[1] - m, m), e.lineTo(f[0], f[1]), e.arcTo(l[0], l[1], l[0] + m, l[1], m), e.closePath(), this.drawShadow(e), e.font = t, e.fillStyle = WS.Renderer2D.colorToStyle(this._textColor);
					var v = .5 * this._borderAddWidth,
					S = .5 * this._borderAddHeight + this._textHeight - 1;
					e.fillText(_des, v, S + 50), S += this._textHeight + this._lineBreakHeight, this._icon && this._icon.draw(e, d[0] - WS.LabelRenderable.ICON_WIDTH, d[1] - 2, WS.LabelRenderable.ICON_WIDTH, WS.LabelRenderable.ICON_HEIGHT);
					var b = s,
					y = r + 8;
					this._geometry.setPosition(b, y, e.canvas.width, e.canvas.height);
					var temp;
					
				if (indexofcanvas < 84){
					canvasselect[indexofcanvas] =  this;
					//canvasselect[indexofcanvas] =  Object.create(this);
					//temp = Object.create(this._material);
					//canvasselect[indexofcanvas]._material = new WS.Material;
					//canvasselect[indexofcanvas]._material = temp;
					//canvasselect[indexofcanvas]._material = Object.create(this._material);
					//canvasselect[indexofcanvas]._canvas = document.createElement("canvas");
					//canvasselect[indexofcanvas]._canvas.width = this._canvas.width;
					//canvasselect[indexofcanvas]._canvas.height = 50;
					//debugger;
					//canvasselect[indexofcanvas]._canvas = Object.create(this._canvas);
					//canvasselect[indexofcanvas]._canvas = JSON.parse(JSON.stringify(this._canvas));
					//canvasselect[indexofcanvas] = this;
					canvastype[indexofcanvas] = _type;
					indexofcanvas +=1;
				}
					
					if (_type == 0){
						
					}
					else if(_type == 2){
						e.drawImage(base_image2, e.canvas.width/2 - 17, 0);
					}
					else{
						e.drawImage(base_image1, e.canvas.width/2 -17, 0);
					}
				}
			else{
				e.clear()
			}
			
		}
		
    }
	catch{}
},
	animateme: function(){
	//this._canvas || (this._canvas = document.createElement("canvas"));
        var e = this._canvas.getContext("2d");
		e.clearRect(0,0,e.canvas.width,50);
		var d = e.canvas.width/2 - 25;
		if (imageselect == 0) e.drawImage(animation_image1, d, 0); 
		if (imageselect == 1) e.drawImage(animation_image2, d, 0); 
		if (imageselect == 2) e.drawImage(animation_image3, d, 0);
		if (imageselect == 3) e.drawImage(animation_image4, d, 0);
		if (imageselect == 4) e.drawImage(animation_image5, d, 0);
		if (imageselect == 5) e.drawImage(animation_image6, d, 0);
		if (imageselect == 6) e.drawImage(animation_image7, d, 0);
},
    changeTailOffsets: function (e, t, i) {
        if (0 !== e || 0 !== t) {
            if (this._tailOffsetX += -e, this._tailOffsetY += -t, i) return;
            this.updateImage()
        }
    },
    dragMove: function (e, t) {
        this.changeTailOffsets(e, t, !1)
    },
    updateIcon: function (e) {
        var t = this._dataObject ? this._dataObject._category : void 0;
        if (t) {
            var i = WS.ColorGenerator.intColorFromString(t),
                n = WS.ColorGenerator.rgbColorFromInt(i);
            this.setCategoryColor(n)
        } else this.setCategoryColor(void 0);
        this.onIconModeChange(e)
    }
}, WS.extend("AnnotationRenderable", "LabelRenderable"), WS.AnnotationRenderable.TAIL_WIDTH_X = 10, WS.AnnotationRenderable.TAIL_WIDTH_Y = 8, WS.AnnotationRenderable.TAIL_X_GAP_TO_EDGE = 12, WS.AnnotationRenderable.TAIL_Y_GAP_TO_EDGE = 6, WS.AnnotationRenderable.TAIL_Y_OFFSET_DEFAULT = 15, WS.MatrixStack = function () {
    this._top = mat4.identity(), this._stack = []
}, WS.MatrixStack.prototype = {
    addOrthoMatrix: function (e, t) {
        var i = 0 === e[12] && 0 === e[13] && 0 === e[14] && 1 === e[0] && 1 === e[5];
        return i && t ? !1 : (this._stack.push(this._top), i || (this._top = mat4.create(this._top), mat4.multiply(this._top, e)), !0)
    },
    popMatrix: function () {
        this._top = this._stack.pop()
    }
}, WS.extend("MatrixStack"), WS.Viewport = function (e, t) {
    this._dimensions = vec2.create([e, t])
}, WS.Viewport.prototype = {
    setDimensions: function (e, t) {
        this._dimensions = vec2.create([e, t])
    },
    use: function () {
    },
    isValid: function () {
        return this._dimensions[0] > 0 && this._dimensions[1] > 0
    },
    getWidth: function () {
        return this._dimensions[0]
    },
    getHeight: function () {
        return this._dimensions[1]
    }
}, WS.extend("Viewport"), WS.VisitorBase = function () {
}, WS.VisitorBase.prototype = {
    prepare: function () {
    },
    preVisit: function () {
        return !0
    },
    visit: function () {
        return !0
    },
    postVisit: function () {
        return !0
    }
}, WS.extend("VisitorBase"), WS.SceneVisitorBase = function () {
    this._modelMatrixStack = void 0
}, WS.SceneVisitorBase.prototype = {
    preVisit: function (e) {
        return e._transform && this._modelMatrixStack.addOrthoMatrix(e._transform), !0
    },
    postVisit: function (e) {
        return e._transform && this._modelMatrixStack.popMatrix(), !0
    }
}, WS.extend("SceneVisitorBase", "VisitorBase"), WS.RenderVisitor = function (e, t, i, n) {
    this._layerService = F.DI().getService("layer"), this._zIndex = i, this._view = n, this._cameraObject = void 0, this._camPosGlobal = void 0, this._filterFunc = void 0, this._renderer = e, this._modelMatrixStack = this._renderer._modelMatrixStack, this._renderFuncName = t, this._isVisible = F.proxy(this.isVisible, this)
}, WS.RenderVisitor.prototype = {
    prepare: function () {
        var e = this._renderer._camera;
        e && (this._cameraObject = e.createCameraObject(mat4.identity()), this._camPosGlobal = this._cameraObject.getGlobalPosition())
    },
    visit: function (e) {
        if (!(e instanceof WS.Renderable)) return !0;
        if (this._renderer instanceof WS.Renderer3D && this._renderer._renderColorMode === WS.RendererBase.RenderMode.PICK_3D && !e._pickable3d) return !0;
        if (e[this._renderFuncName]) {
            var t = this._layerService.getObjectsVisbleUpToDistance(e._layerId, this._view);
            (t === Number.POSITIVE_INFINITY || vec3.dist2(this._camPosGlobal, mat4.getTranslation(this._modelMatrixStack._top)) < t * t) && e[this._renderFuncName](this._renderer, this._isVisible, !1)
        }
        return !0
    },
    isVisible: function (e) {
        var t = this._filterFunc ? this._filterFunc(e) : !0;
        return t && this._layerService.isLayerVisible(e._layerId, this._view) && (void 0 === this._zIndex || this._layerService.getZIndexOfLayer(e._layerId, this._view) === this._zIndex)
    }
}, WS.extend("RenderVisitor", "SceneVisitorBase"), WS.RendererBase = function (e, t) {
    this._clearColor = void 0, this._camera = void 0, this._view = t, this._viewport = void 0, this._canvasScaleFactor = 1, this._canvasWidth = void 0, this._canvasHeight = void 0, this._modelMatrixStack = new WS.MatrixStack, this._material = void 0, this._geometry = void 0, this._drawVisitor = void 0, this._ctx = void 0, this._zIndices = e
}, WS.RendererBase.prototype = {
    setAndPrepareGeometry: function () {
    },
    setAndPrepareMaterial: function () {
    },
    drawGeometry: function () {
    },
    getModelMatrix: function () {
        return this._modelMatrixStack._top
    },
    setCamera: function (e) {
        this._camera = e
    },
    setViewPort: function (e) {
        this._viewport = e
    },
    setViewPortDimensions: function (e, t) {
        this._viewport.setDimensions(e, t), this._viewport.use()
    },
    drawScene: function (e, t, i, n, r) {
        var o = this._drawVisitor;
        o._filterFunc = n, this.setCamera(e), i || this.clear();
        for (var a = r && r.zIndices ? r.zIndices : this._zIndices, s = a.length, c = 0; s > c; c++) o._zIndex = a[c], t.traverse(o);
        o._filterFunc = void 0
    },
    setClearColor: function (e) {
        this._clearColor = e
    },
    clear: function () {
    },
    setCanvasScaleFactor: function (e) {
        this._canvasScaleFactor !== e && (this._canvasScaleFactor = e, this.updateCanvasObjectDimensions())
    },
    setCanvasDimensions: function (e, t) {
        var i = this._ctx ? this._ctx.canvas : void 0;
        i && (this._canvasWidth = e, this._canvasHeight = t), this.updateCanvasObjectDimensions()
    },
    updateCanvasObjectDimensions: function () {
        var e = this._canvasWidth,
            t = this._canvasHeight,
            i = this._ctx ? this._ctx.canvas : void 0;
        e = Math.floor(e / this._canvasScaleFactor), t = Math.floor(t / this._canvasScaleFactor), i && (i.width = e, i.height = t)
    },
    getTexture: function () {
        return void 0
    },
    deleteStorageForRenderableAndMembers: function (e) {
        for (var t = e.getMemberRenderables(), i = 0, n = t.length; n > i; ++i) this.deleteStorageForRenderable(t[i]);
        this.deleteStorageForRenderable(e)
    },
    deleteStorageForRenderable: function (e) {
        this.deleteTexturesForRenderable(e)
    },
    deleteTexturesForRenderable: function (e) {
        if (e._material && e._material._images && 0 !== e._material._images.length)
            for (var t = e._material._images, i = 0, n = t.length; n > i; i++) this._textureStorage.deleteTexture(t[i])
    },
    getMaterialTextures: function (e) {
        if (!e || !e._images) return void 0;
        for (var t = [], i = 0, n = e._images.length; n > i; i++) t[i] = this.getTexture(e._images[i]);
        return t
    },
    areAllTexturesUploaded: function (e) {
        if (!e._images) return !0;
        for (var t, i = 0, n = e._images.length; n > i; i++)
            if (t = this.getTexture(e._images[i]), t && !t.isImageUploaded()) return !1;
        return !0
    }
}, WS.extend("RendererBase"), WS.RendererBase.RenderMode = {
    DEFAULT: 0,
    DEPTH: 1,
    PICK_2D: 2,
    PICK_3D: 3,
    PICK_3D_POINT: 4,
    NODE: 5
}, WS.PolyCircuitGeometry = function (e) {
    WS.Geometry.call(this), this._positionBuffer = e, this._positionItemSize = 3, this._primitiveType = WS.Geometry.PrimitiveType.PolyCircuit
}, WS.extend("PolyCircuitGeometry", "Geometry"), WS.CanvasTexture = function (e) {
    this._imageUploaded = !1, this._canvasData = [], this._canvasElementWidth = WS.CanvasTexture.ElementWidth, this._canvasElementHeight = WS.CanvasTexture.ElementHeight, this._image = e, this._defer = Q.defer(), this._image.addListener(this)
}, WS.CanvasTexture.prototype = {
    getPromise: function () {
        return this._defer.promise
    },
    getWidth: function () {
        return this._image.getWidth()
    },
    getHeight: function () {
        return this._image.getHeight()
    },
    onImageLoad: function () {
        this.uploadImage()
    },
    uploadImage: function () {
        var e = this._image;
        e.isLoaded() && (e.getWidth() > this._canvasElementWidth && e.getHeight() > this._canvasElementHeight ? this.uploadImageTiled() : this.uploadImageSingle(), this._defer.resolve())
    },
    uploadImageSingle: function () {
        var e, t = this._image;
        if (t.isLoaded()) {
            var i = document.createElement("canvas"),
                n = i.getContext("2d"),
                r = 1 / t.getDownSampleFactor();
            i.width = this.getWidth(), i.height = this.getHeight(), n.drawImage(t.getRawImage(), 0, 0, Math.round(t.getWidth() * r), Math.round(t.getHeight() * r), 0, 0, i.width, i.height), e = n.getImageData(0, 0, i.width, i.height), this._canvasData = e.data, this._imageUploaded = !0
        }
    },
    uploadImageTiled: function () {
        var e, t, i, n, r, o, a, s, c, l, h, d, u, _, p, g, f = this._image,
            m = 0,
            v = 0,
            S = [],
            b = [],
            y = [],
            P = this.getWidth(),
            M = this.getHeight(),
            w = this._canvasElementHeight,
            C = this._canvasElementWidth;
        if (f && f.isLoaded()) {
            for (_ = Math.ceil(f.getWidth() / C), p = Math.ceil(f.getHeight() / w), g = _ * p, t = 0; g > t; t++) S[t] = document.createElement("canvas"), b[t] = S[t].getContext("2d");
            for (u = 1 / f.getDownSampleFactor(), i = 0; p > i; i++)
                for (t = 0; _ > t; t++) n = t === _ - 1 ? P % C : C, r = i === p - 1 ? M % w : w, n = 0 === n ? C : n, r = 0 === r ? w : r, S[m].width = n, S[m].height = r, b[m].drawImage(f.getRawImage(), Math.round(t * n * u), Math.round(i * r * u), Math.round(n * u), Math.round(r * u), 0, 0, n, r), e = b[m].getImageData(0, 0, n, r), y[m] = e.data, m++;
            var T;
            T = "undefined" != typeof Uint8ClampedArray ? Uint8ClampedArray : "undefined" != typeof Uint8Array ? Uint8Array : Array, this._canvasData = new T(P * M * 4);
            var W = this._canvasData;
            for (i = 0; M > i; i++)
                for (t = 0; P > t; t++) s = Math.floor(t / C), c = Math.floor(i / w), l = s + _ * c, n = s === _ - 1 ? P % C : C, n = 0 === n ? C : n, o = t % C, a = i % w, h = 4 * (n * a + o), d = y[l], W[v] = d[h], W[v + 1] = d[h + 1], W[v + 2] = d[h + 2], W[v + 3] = d[h + 3], v += 4;
            this._imageUploaded = !0
        }
    },
    isImageUploaded: function () {
        return this._imageUploaded
    },
    destroy: function () {
        this._image && this._image.removeListener(this), this._imageUploaded = !1, this._canvasData = void 0, this._image = void 0, this._defer = void 0
    },
    getPixel: function (e, t, i) {
        var n, r = this.getWidth(),
            o = this.getHeight();
        e = e >= 0 ? e : r + e, t = t >= 0 ? t : o + t, e = Math.min(e, r - 1), t = Math.min(t, o - 1);
        var a = 4 * (r * t + e);
        n = this._canvasData, i[0] = n[a], i[1] = n[a + 1], i[2] = n[a + 2], i[3] = n[a + 3]
    }
}, WS.extend("CanvasTexture", "Object"), WS.CanvasTexture.ElementWidth = F.getMaxCanvasWidth(), WS.CanvasTexture.ElementHeight = F.getMaxCanvasHeight(), WS.CanvasTexture.getMaxWidth = function () {
    return F.getMaxCanvasWidth()
}, WS.CanvasTexture.getMaxHeight = function () {
    return F.getMaxCanvasHeight()
}, WS.Renderer2D = function (e, t, i, n) {
    WS.RendererBase.call(this, t, i), this._ctx = e, this._pointSize = 1, this._lineWidth = 1, this._textureStorage = new WS.TextureStorage(this._ctx), this._drawVisitor = new WS.RenderVisitor(this, "draw2d", void 0, this._view), this._subdivQuality = WS.Renderer2D.SubdivQuality.HIGH, this._subdiv = n || WS.Renderer2D.SubdivOptions, this._subdivTemp2 = void 0, this._subdivTemp3 = void 0, this.setViewPort(new WS.Viewport(e.canvas.width, e.canvas.height)), this.setClearColor([1, 1, 1, 0]), this.clear()
}, WS.Renderer2D.prototype = {
    clearStorage: function () {
        this._textureStorage.deleteAllTextures()
    },
    getTexture: function (e) {
        if (!e) return void 0;
        var t = this._textureStorage.inquireTexture(e, WS.CanvasTexture);
        return t
    },
    setAndPrepareGeometry: function (e) {
        this._geometry = e
    },
    setAndPrepareMaterial: function (e) {
        return this._material = e, this._material.configureRenderer2d(this)
    },
    setFillColor: function (e) {
        var t = this._ctx,
            i = WS.Renderer2D.colorToStyle(e);
        t.fillStyle = i
    },
    setStrokeColor: function (e) {
        var t = this._ctx,
            i = WS.Renderer2D.colorToStyle(e);
        t.strokeStyle = i
    },
    configureRenderer2d: function () {
        return this._material.configureRenderer2d(this)
    },
    clear: function () {
        var e = this._viewport;
        this._ctx.clearRect(0, 0, e.getWidth(), e.getHeight()), this.setFillColor(this._clearColor), this._ctx.fillRect(0, 0, e.getWidth(), e.getHeight())
    },
    setPointSize: function (e) {
        this._pointSize = e
    },
    setLineWidth: function (e) {
        e !== this._lineWidth && (this._lineWidth = e, this._ctx.lineWidth = e)
    },
    setSubdivQuality: function (e) {
        this._subdivQuality = e
    },
    drawPoints: function (e, t, i) {
        for (var n, r, o = this._camera._height, a = this._ctx, s = e.length, c = this._pointSize, l = c / 2, h = 0; s > h; ++h) {
            var d = e[h];
            d && (this.setFillColor(t[h]), i ? (n = d[0] - l, r = o - d[1] - l, a.fillRect(n, r, c, c)) : (n = d[0], r = o - d[1], a.beginPath(), a.arc(n, r, l, 0, 2 * Math.PI, !1), a.fill()))
        }
    },
    drawTexturedTriangleNoSubdiv: function (e, t, i, n, r, o, a, s) {
        var c, l, h, d, u, _, p, g, f = this._ctx,
            m = i[0],
            v = i[1],
            S = n[0],
            b = n[1],
            y = r[0],
            P = r[1],
            M = o[0],
            w = o[1],
            C = a[0] - M,
            T = a[1] - w,
            W = s[0] - M,
            I = s[1] - w;
        f.save(), f.beginPath(), f.moveTo(m, v), f.lineTo(S, b), f.lineTo(y, P), f.closePath(), f.clip(), S -= m, b -= v, y -= m, P -= v, p = C * I - W * T, 0 !== p && (g = 1 / p, c = (I * S - T * y) * g, l = (I * b - T * P) * g, h = (C * y - W * S) * g, d = (C * P - W * b) * g, u = m - c * M - h * w, _ = v - l * M - d * w, f.transform(c, l, h, d, u, _), f.globalAlpha = t, f.drawImage(e, 0, 0)), f.restore()
    },
    subdivAllocTemp: function () {
        if (!this._subdivTemp2) {
            var e = 3 * (this._subdiv.high.maxDepth + 1);
            this._subdivTemp2 = new Array(e), this._subdivTemp3 = new Array(e);
            for (var t = 0; e > t; t++) this._subdivTemp2[t] = vec2.create(), this._subdivTemp3[t] = vec3.create()
        }
    },
    drawTexturedTriangleSubdiv: function (e, t, i, n, r, o, a, s, c) {
        if (vec2.isTriangleVisible(i, n, r, this._viewport.getWidth(), this._viewport.getHeight())) {
            var l, h = this._subdiv[this._subdivQuality];
            if (c++, c > h.maxDepth) l = 0;
            else if (h.mode === WS.Renderer2D.Subdiv.FIXED) l = 7;
            else {
                var d = Math.abs(i[0] - n[0]) + Math.abs(i[1] - n[1]),
                    u = Math.abs(n[0] - r[0]) + Math.abs(n[1] - r[1]),
                    _ = Math.abs(r[0] - i[0]) + Math.abs(r[1] - i[1]),
                    p = Math.abs(1 / i[2] - 1 / n[2]),
                    g = Math.abs(1 / n[2] - 1 / r[2]),
                    f = Math.abs(1 / r[2] - 1 / i[2]),
                    m = h.minArea2dDepth;
                l = (d * p > m ? 1 : 0) + (u * g > m ? 2 : 0) + (_ * f > m ? 4 : 0)
            }
            if (0 === l) return void this.drawTexturedTriangleNoSubdiv(e, t, i, n, r, o, a, s);
            var v, S, b, y, P, M, w = 3 * c;
            switch (1 & l && (v = this._subdivTemp3[w], y = this._subdivTemp2[w], vec3.lerp(i, n, .5, v), vec2.lerp(o, a, n[2] / (i[2] + n[2]), y)), 2 & l && (S = this._subdivTemp3[w + 1], P = this._subdivTemp2[w + 1], vec3.lerp(n, r, .5, S), vec2.lerp(a, s, r[2] / (n[2] + r[2]), P)), 4 & l && (b = this._subdivTemp3[w + 2], M = this._subdivTemp2[w + 2], vec3.lerp(r, i, .5, b), vec2.lerp(s, o, i[2] / (r[2] + i[2]), M)), l) {
                case 1:
                    this.drawTexturedTriangleSubdiv(e, t, i, v, r, o, y, s, c), this.drawTexturedTriangleSubdiv(e, t, v, n, r, y, a, s, c);
                    break;
                case 2:
                    this.drawTexturedTriangleSubdiv(e, t, i, n, S, o, a, P, c), this.drawTexturedTriangleSubdiv(e, t, i, S, r, o, P, s, c);
                    break;
                case 3:
                    this.drawTexturedTriangleSubdiv(e, t, i, v, S, o, y, P, c), this.drawTexturedTriangleSubdiv(e, t, i, S, r, o, P, s, c), this.drawTexturedTriangleSubdiv(e, t, v, n, S, y, a, P, c);
                    break;
                case 4:
                    this.drawTexturedTriangleSubdiv(e, t, i, n, b, o, a, M, c), this.drawTexturedTriangleSubdiv(e, t, n, r, b, a, s, M, c);
                    break;
                case 5:
                    this.drawTexturedTriangleSubdiv(e, t, i, v, b, o, y, M, c), this.drawTexturedTriangleSubdiv(e, t, n, r, v, a, s, y, c), this.drawTexturedTriangleSubdiv(e, t, r, b, v, s, M, y, c);
                    break;
                case 6:
                    this.drawTexturedTriangleSubdiv(e, t, i, n, b, o, a, M, c), this.drawTexturedTriangleSubdiv(e, t, n, S, b, a, P, M, c), this.drawTexturedTriangleSubdiv(e, t, S, r, b, P, s, M, c);
                    break;
                case 7:
                    this.drawTexturedTriangleSubdiv(e, t, i, v, b, o, y, M, c), this.drawTexturedTriangleSubdiv(e, t, n, S, v, a, P, y, c), this.drawTexturedTriangleSubdiv(e, t, r, b, S, s, M, P, c), this.drawTexturedTriangleSubdiv(e, t, v, S, b, y, P, M, c)
            }
        }
    },
    drawTexturedTriangle: function (e, t, i, n, r, o, a, s, c) {
        var l = this._camera._height,
            h = e.width - 1,
            d = e.height - 1,
            u = vec3.createFrom(i[0], l - i[1], i[4]),
            _ = vec3.createFrom(n[0], l - n[1], n[4]),
            p = vec3.createFrom(r[0], l - r[1], r[4]),
            g = vec2.createFrom(o[0] * h, (1 - o[1]) * d),
            f = vec2.createFrom(a[0] * h, (1 - a[1]) * d),
            m = vec2.createFrom(s[0] * h, (1 - s[1]) * d);
        c ? (this.subdivAllocTemp(), this.drawTexturedTriangleSubdiv(e, t, u, _, p, g, f, m, 0)) : this.drawTexturedTriangleNoSubdiv(e, t, u, _, p, g, f, m)
    },
    drawTexturedTriangles: function (e, t, i, n) {
        if (!i.isLoaded()) return void i.loadImage();
        for (var r, o, a, s = e.length, c = vec2.create(), l = vec2.create(), h = vec2.create(), d = this._subdiv[this._subdivQuality], u = !this._camera.instanceOf(WS.OrthoCamera) && d.mode !== WS.Renderer2D.Subdiv.NONE, _ = i.getRawImage(), p = 0; s > p; p += 3) r = e[p], o = e[p + 1], a = e[p + 2], r && o && a && (t.getItem(p, c), t.getItem(p + 1, l), t.getItem(p + 2, h), this.drawTexturedTriangle(_, n, r, o, a, c, l, h, u))
    },
    fillTriangle: function (e, t, i, n) {
        var r = this._ctx,
            o = this._camera._height;
        this.setFillColor(n), r.beginPath(), r.moveTo(e[0], o - e[1]), r.lineTo(t[0], o - t[1]), r.lineTo(i[0], o - i[1]), r.closePath(), r.fill()
    },
    drawTriangles: function (e, t) {
        for (var i, n, r, o = e.length, a = 0; o > a; a += 3) i = e[a], n = e[a + 1], r = e[a + 2], i && n && r && this.fillTriangle(i, n, r, t[a])
    },
    drawTrianglesIndexed: function (e, t, i, n, r) {
        for (var o, a, s, c = this._viewport.getWidth(), l = this._viewport.getHeight(), h = 0; i > h; h += 3) {
            var d = t[h],
                u = t[h + 1],
                _ = t[h + 2];
            o = e[d], a = e[u], s = e[_], o && a && s && vec2.isTriangleVisible(o, a, s, c, l) && !WS.GeometryProjector.isCulled(o, a, s, r) && this.fillTriangle(o, a, s, n[d])
        }
    },
    drawTriangleStrip: function (e, t, i) {
        for (var n, r, o, a = e.length, s = (this._ctx, this._viewport.getWidth()), c = this._viewport.getHeight(), l = !0, h = 0; a > h; h++) n = r, r = o, o = e[h], n && r && o && vec2.isTriangleVisible(n, r, o, s, c) && !WS.GeometryProjector.isCulled(n, l ? r : o, l ? o : r, i) && this.fillTriangle(n, r, o, t[h]), l = !l
    },
    drawPolyCircuit: function (e, t) {
        var i = e.length;
        if (i >= 3) {
            var n = this._camera._height,
                r = !0,
                o = this._ctx;
            o.beginPath(), this.setFillColor(t[0]);
            for (var a = 0; i > a; ++a) {
                var s = e[a][0],
                    c = n - e[a][1];
                r ? (o.moveTo(s, c), r = !1) : o.lineTo(s, c)
            }
            o.closePath(), o.fill()
        }
    },
    drawLineSegments: function (e, t, i) {
        for (var n = this._camera._height, r = this._ctx, o = i ? 1 : 2, a = 0, s = e.length - 1; s > a; a += o) e[a] && e[a + 1] && (this.setStrokeColor(t[a]), r.beginPath(), r.moveTo(e[a][0], n - e[a][1]), r.lineTo(e[a + 1][0], n - e[a + 1][1]), r.stroke())
    },
    drawLineStrip: function (e, t) {
        this.drawLineSegments(e, t, !0)
    },
    drawLines: function (e, t) {
		this.drawLineSegments(e, t, !1)
    },
    drawGeometry: function () {
        var e, t, i, n, r = this._geometry,
            o = this._material,
            a = this._viewport.getWidth(),
            s = this._viewport.getHeight(),
            c = WS.GeometryProjector.projectGeometry(this._camera, this._geometry, this.getModelMatrix(), a, s, o._cullFace);
        switch (o.instanceOf(WS.TextureMaterial) ? (t = o._images[0], i = o._coordBuffer, n = o._alpha) : e = this.getColorsForGeometry(), r._primitiveType) {
            case WS.Geometry.PrimitiveType.Points:
                this.drawPoints(c, e);
                break;
            case WS.Geometry.PrimitiveType.Lines:
                this.drawLines(c, e);
                break;
            case WS.Geometry.PrimitiveType.LineStrip:
                this.drawLineStrip(c, e);
                break;
            case WS.Geometry.PrimitiveType.Triangles:
                i ? this.drawTexturedTriangles(c, i, t, n) : r._indexBuffer ? this.drawTrianglesIndexed(c, r._indexBuffer._bufferData, r.getCountIndices(), e, o._cullFace) : this.drawTriangles(c, e);
                break;
            case WS.Geometry.PrimitiveType.TriangleStrip:
                this.drawTriangleStrip(c, e, o._cullFace);
                break;
            case WS.Geometry.PrimitiveType.PolyCircuit:
                this.drawPolyCircuit(c, e)
        }
    },
    getColorsForGeometry: function () {
        for (var e = this._material, t = (e.getColorCount(), this._geometry.getCountPositions()), i = new Array(t), n = 0; t > n; n++) {
            {
                var r = new MatrixArray(4);
                e.getColor(n, r)
            }
            i[n] = r
        }
        return i
    }
}, WS.extend("Renderer2D", "RendererBase"), WS.Renderer2D.SubdivQuality = {
    HIGH: "high",
    LOW: "low"
}, WS.Renderer2D.Subdiv = {
    NONE: 0,
    FIXED: 1,
    ADAPTIVE: 2
}, WS.Renderer2D.SubdivOptions = {
    high: {
        mode: WS.Renderer2D.Subdiv.ADAPTIVE,
        maxDepth: 10,
        minArea2dDepth: 150
    },
    low: {
        mode: WS.Renderer2D.Subdiv.ADAPTIVE,
        maxDepth: 10,
        minArea2dDepth: 400
    }
}, WS.Renderer2D.colorToStyle = function (e) {
    var t = Math.round(255 * e[0]),
        i = Math.round(255 * e[1]),
        n = Math.round(255 * e[2]),
        r = e[3];
    return "rgba(" + t + "," + i + "," + n + "," + r + ")"
}, F.shaderSrc = {
    color_vs: "attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;attribute vec4 aColor;varying vec4 v_c;void main(){gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_c=aColor;}",
    color_fs: "precision mediump float;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvarying vec4 v_c;void main(void){\n#ifndef FAILSAFE\nif(uDepthTest){vec2 n=vec2(gl_FragCoord.x*uInvViewX,gl_FragCoord.y*uInvViewY);vec4 k=texture2D(uTexDepth,n);if(!i(gl_FragCoord,k.rgb)){discard;}}\n#endif\ngl_FragColor=v_c;}",
    dynamicpoint_vs: "const float c=8.0;const float d=5.0;const float e=(c-d);const float f=0.75;const float h=1.001;const float i=(h-f);attribute vec3 aVertexPosition;attribute vec4 aColor;uniform mat4 uModelViewMatrix;uniform mat4 uProjectionMatrix;uniform bool uDynamicPointSize;uniform mat4 uTransform;uniform float uPointSizeFactor;uniform float uMinPointSize,uMaxPointSize;uniform float uAlpha;uniform bool uColor8Bit;uniform int uColorMode;uniform vec4 uFixedColor;uniform bool uQuadPoint;varying vec4 v_c;varying float v_d;\n#ifdef VORONOI\nvarying float v_e;varying float v_f;varying vec3 v_h;\n#endif\nconst float j=4.0;const float k=256.0*j;const float l=1.0/j;vec3 m(float n){vec3 o;n*=l;o.r=floor(n);n-=o.r;o.g=floor(n*256.0);n-=o.g*0.00390625;o.b=n*65536.0;o*=0.00390625;return o;}void main(){float p;vec4 q=uModelViewMatrix*vec4(aVertexPosition,1.0);gl_Position=uProjectionMatrix*q;float s=(-1.0/q.z);if(uDynamicPointSize){p=uPointSizeFactor*s;p=min(uMaxPointSize,max(p,uMinPointSize));p+=(p*abs(gl_Position.x)/gl_Position.w)*0.25;}else{p=uMinPointSize;}gl_PointSize=p;\n#ifdef VORONOI\nv_h=q.xyz;v_f=p;v_e=p/s;\n#endif\nif(uColorMode==0){if(uColor8Bit){v_c=aColor/255.0;}else{v_c=aColor;}}else if(uColorMode==1){v_c=uFixedColor;}else{v_c=vec4(m(-q.z),1.0);}v_c.a*=uAlpha;if(uQuadPoint){v_d=h;}else{v_d=min(h,max(f,(1.0-((p-d)/e))*i+f));}}",
    dynamicpoint_fs: "#ifdef VORONOI\n#extension GL_EXT_frag_depth : enable\n#endif\nprecision mediump float;varying vec4 v_c;varying float v_d;\n#ifdef VORONOI\nconst float c=2.1;const float d=0.0085;uniform mat4 uProjectionMatrixFS;varying vec3 v_h;varying float v_e;varying float v_f;\n#endif\nconst float e=4.0;const float f=256.0*e;const float h=1.0/e;vec3 i(float j){vec3 k;j*=h;k.r=floor(j);j-=k.r;k.g=floor(j*256.0);j-=k.g*0.00390625;k.b=j*65536.0;k*=0.00390625;return k;}void main(void){float l=2.0*((gl_PointCoord.x-0.5)*(gl_PointCoord.x-0.5)+(gl_PointCoord.y-0.5)*(gl_PointCoord.y-0.5));if(l>=v_d){discard;}\n#ifdef VORONOI\nfloat r=sqrt(l);r=max(0.0,r-c/v_f);vec4 m=vec4(v_h,1.0);m.z-=d*r*v_e;m=uProjectionMatrixFS*m;float n=m.z/m.w;gl_FragDepthEXT=(n+1.0)/2.0;\n#endif\ngl_FragColor=v_c;}",
    fx_vs: "attribute vec2 aVertexPosition;attribute vec2 aVertexTextureCoords;varying vec2 v_i;void main(){v_i=aVertexTextureCoords;gl_Position=vec4(aVertexPosition,0.0,1.0);}",
    fx_fs: "precision mediump float;varying vec2 v_i;uniform sampler2D uTex0;void main(void){gl_FragColor=texture2D(uTex0,v_i);}",
    fxgapfiller_op2_fs: "precision mediump float;const float c=4.0;const float d=256.0*c;const float e=1.0/c;vec3 f(float h){vec3 i;h*=e;i.r=floor(h);h-=i.r;i.g=floor(h*256.0);h-=i.g*0.00390625;i.b=h*65536.0;i*=0.00390625;return i;}float j(vec3 k){return c*(256.0*k.r+k.g+0.00390625*k.b);}const int l=7;const int m=2;varying vec2 v_i;uniform vec2 uTexSize;uniform vec2 uInvTexSize;uniform vec2 uDepthToFrustumSize;uniform sampler2D uTex0;uniform sampler2D uTexDepth;uniform bool uDepthColor;uniform bool uInterpolate;const float n=0.99;bool o(vec3 p){return (p.r>n);}const float q=0.2;const float s=0.5*q;const float t=q*q;const float u=s*s;bool v(out vec2 cc,vec2 cd,float ce){const int cf=3;float ch=ce;int ci=0;for(int cj=1;cj<=l;cj++){if(ci<cf){vec2 ck=(float(cj)*cd)+v_i;vec4 p=texture2D(uTexDepth,ck);float h=j(p.rgb);if((!o(p.rgb))&&h<ch){cc=ck;ci++;ch=h-0.05;}}}return (ci!=0);}bool cl(out vec2 cc,vec2 cd,float ce){for(int cj=1;cj<=m;cj++){vec2 ck=(float(cj)*cd)+v_i;vec4 p=texture2D(uTexDepth,ck);float h=j(p.rgb);if((!o(p.rgb))&&h<ce){cc=ck;return true;}}return false;}vec3 cm(vec2 ck){vec4 cn=texture2D(uTexDepth,ck);float h=j(cn.rgb);ck.xy-=vec2(0.5,0.5);return vec3(ck.x*h*uDepthToFrustumSize.x,ck.y*h*uDepthToFrustumSize.y,h);}bool co(vec3 cp,vec3 cq){vec3 cs=cq-cp;float ct=dot(cs,cs);return ct<t;}bool cu(vec3 cp,vec3 cq){vec3 cs=cq-cp;float ct=dot(cs,cs);return ct<u;}bool cv(out vec3 dc,vec2 dd,vec2 de,vec2 df){vec2 dh=v_i.xy;vec2 r=uTexSize*(dh-df);vec2 di=uTexSize*(dd-df);vec2 dj=uTexSize*(de-df);float dk=di.x*dj.y-dj.x*di.y;if(dk<0.0001){return false;}dc[0]=(dj.y*r.x-dj.x*r.y)/dk;dc[1]=(di.x*r.y-di.y*r.x)/dk;dc[2]=1.0-dc[0]-dc[1];return (dc[0]>=0.0);}vec2 dl(vec2 dd,vec2 de){vec2 dm=uTexSize*(v_i-dd);vec2 dn=uTexSize*(v_i-de);float dp=length(dm);float dq=length(dn);return vec2(dq/(dp+dq),dp/(dp+dq));}bool ds(out vec4 dt,vec2 dd,vec2 de){vec3 du=cm(dd);vec3 dv=cm(de);if(!cu(du,dv)){return false;}else{vec4 ec=texture2D(uTex0,dd);vec4 ed=texture2D(uTex0,de);vec2 dc=dl(dd,de);if(uDepthColor){float ee=dc[0]*du.z+dc[1]*dv.z;dt=vec4(f(ee),1.0);}else if(!uInterpolate){dt=(dc[0]>dc[1])?ec:ed;}else{dt=dc[0]*ec+dc[1]*ed;}return true;}}void ef(out vec4 dt,vec2 dd,vec2 de){vec3 du=cm(dd);vec3 dv=cm(de);vec4 ec=texture2D(uTex0,dd);vec4 ed=texture2D(uTex0,de);if(!cu(du,dv)){bool eh=du.z>dv.z;if(uDepthColor){dt=vec4(f(eh?du.z:dv.z),1.0);}else{dt=eh?ec:ed;}}else{vec2 dc=dl(dd,de);if(uDepthColor){float ee=dc[0]*du.z+dc[1]*dv.z;dt=vec4(f(ee),1.0);}else if(!uInterpolate){dt=(dc[0]>dc[1])?ec:ed;}else{dt=dc[0]*ec+dc[1]*ed;}}}bool ei(out vec4 dt,vec2 dd,vec2 de,vec2 df){vec3 du=cm(dd);vec3 dv=cm(de);if(!co(du,dv)){return false;}vec3 ej=cm(df);if(!co(du,ej)){return false;}if(!co(dv,ej)){return false;}vec4 ec=texture2D(uTex0,dd);vec4 ed=texture2D(uTex0,de);vec4 ek=texture2D(uTex0,df);vec3 dc;if(!cv(dc,dd,de,df)){return false;}if(uDepthColor){float ee=dc[0]*du.z+dc[1]*dv.z+dc[2]*ej.z;dt=vec4(f(ee),1.0);}else{if(!uInterpolate){dt=(dc[0]>max(dc[1],dc[2]))?ec:((dc[1]>dc[2])?ed:ek);}else{dt=dc[0]*ec+dc[1]*ed+dc[2]*ek;}}return true;}void main(void){vec4 el=texture2D(uTexDepth,v_i);float h=j(el.rgb);float em=h-0.05;vec4 en;float eo=uInvTexSize.x;float ep=uInvTexSize.y;vec2 eq,es,et,eu,ev,fc,fd,fe;bool ff,fh,fi,fj,fk,fl,fm,fn;ff=v(eq,vec2(0,-ep),em);fh=v(es,vec2(eo,-ep),em);fi=v(et,vec2(eo,0),em);fj=v(eu,vec2(eo,ep),em);fk=v(ev,vec2(0,ep),em);fl=v(fc,vec2(-eo,ep),em);fm=v(fd,vec2(-eo,0),em);fn=v(fe,vec2(-eo,-ep),em);bool ci=false;if(ff&&fj&&fl){ci=ei(en,eq,eu,fc);}if(!ci&&fh&&fk&&fm){ci=ei(en,es,ev,fd);}if(!ci&&fi&&fl&&fn){ci=ei(en,et,fc,fe);}if(!ci&&fj&&fm&&ff){ci=ei(en,eu,fd,eq);}if(!ci&&ff&&fk){ci=ds(en,eq,ev);}if(!ci&&fh&&fl){ci=ds(en,es,fc);}if(!ci&&fi&&fm){ci=ds(en,et,fd);}if(!ci&&fj&&fn){ci=ds(en,eu,fe);}if(!ci){ff=cl(eq,vec2(0,-ep),em);fi=cl(et,vec2(eo,0),em);fk=cl(ev,vec2(0,ep),em);fm=cl(fd,vec2(-eo,0),em);if(ff&&fk){ef(en,eq,ev);ci=true;}else if(fi&&fm){ef(en,et,fd);ci=true;}}if(!ci){if(uDepthColor){en=el;}else{en=texture2D(uTex0,v_i);}}gl_FragColor=en;}",
    fxgapfiller_scene_fs: "precision mediump float;const float c=4.0;const float d=256.0*c;const float e=1.0/c;vec3 f(float h){vec3 i;h*=e;i.r=floor(h);h-=i.r;i.g=floor(h*256.0);h-=i.g*0.00390625;i.b=h*65536.0;i*=0.00390625;return i;}float j(vec3 k){return c*(256.0*k.r+k.g+0.00390625*k.b);}varying vec2 v_i;uniform vec2 uPixOffset;uniform vec2 uTexSize;uniform vec2 uDepthToFrustumSize;uniform sampler2D uTex0;uniform sampler2D uTexDepth;uniform bool uDepthColor;uniform bool uInterpolate;const float l=0.07;const int m=9;const float n=float(m);const float o=0.99*d;float p(float h){float q=h*uDepthToFrustumSize.y;float s=l*uTexSize.y/q;return max(2.0,s+1.0);}float t(float u){return 1.0/(u*u);}void main(void){vec2 v=v_i+uPixOffset;vec2 cc=v_i-uPixOffset;vec4 cd=texture2D(uTexDepth,v_i);float h=j(cd.rgb);vec4 k=uDepthColor?cd:texture2D(uTex0,v_i);vec2 ce;float cf;float ch;vec4 ci;bool cj=false;float u=0.0;float ck=n;for(int cl=0;cl<m;cl++){if(!cj){u=u+1.0;ce=v_i+uPixOffset*u;cd=texture2D(uTexDepth,ce);cf=j(cd.rgb);if(cf<o&&cf<h){ci=texture2D(uTex0,ce);ch=t(u);cj=true;}}}if(cj){ck=p(cf);if(u>ck){cj=false;}}if(!cj){cd=texture2D(uTexDepth,v);cf=j(cd.rgb);ci=texture2D(uTex0,v);ch=t(u);}if(cf<o&&cf<h){float cm;float cn;vec4 co;vec2 cp;cj=false;u=0.0;for(int cl=0;cl<m;cl++){if(!cj){u=u+1.0;cp=v_i-uPixOffset*u;cd=texture2D(uTexDepth,cp);cm=j(cd.rgb);if(cm<o&&cm<h){co=texture2D(uTex0,cp);cn=t(u);cj=true;}}}if(cj){ck=p(cm);if(u>ck){cj=false;}}if(!cj){cd=texture2D(uTexDepth,cc);cm=j(cd.rgb);co=texture2D(uTex0,cc);cn=t(u);}if(cm<o&&cm<h){if((h-cf)>0.025){if(abs(cf-cm)<0.1){float cq=cn+ch;if(uDepthColor){h=(cf*ch+cm*cn)/cq;k=vec4(f(h),1.0);}else if(!uInterpolate){k=(ch>cn)?ci:co;}else{k=(ci*ch+co*cn)/cq;}}else{if(cm>cf){if(uDepthColor){k=vec4(f(cm),1.0);}else{k=co;}}else{if(uDepthColor){k=vec4(f(cf),1.0);}else{k=ci;}}}}}}gl_FragColor=k;}",
    line_vs: "attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;attribute vec4 aColor;varying vec4 v_c;attribute float aDist;varying float v_j;void main(){v_j=aDist;gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_c=aColor;}",
    line_fs: "precision mediump float;varying vec4 v_c;varying float v_j;uniform float uDashLength;uniform vec4 uDashColor;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvoid main(void){\n#ifndef FAILSAFE\nif(uDepthTest){bool n=false;vec4 o=gl_FragCoord;for(int y=-1;y<=1;y++){for(int x=-1;x<=1;x++){if(!n&&(x==0||y==0)){o.x=gl_FragCoord.x+float(x);o.y=gl_FragCoord.y+float(y);vec2 p=vec2(o.x*uInvViewX,o.y*uInvViewY);vec4 k=texture2D(uTexDepth,p);if(i(o,k.rgb)){n=true;}}}}if(!n){discard;}}\n#endif\nif(mod(v_j,2.0*uDashLength)>uDashLength){gl_FragColor=uDashColor;}else{gl_FragColor=v_c;}}",
    pano_vs: "attribute vec2 aVertexPosition;void main(){gl_Position=vec4(aVertexPosition.x,aVertexPosition.y,0.0,1.0);}",
    pano_fs: "precision mediump float;const float c=3.141592654;uniform vec2 uViewport;uniform mat4 uProjMatrix;uniform sampler2D uTex0;uniform sampler2D uTex1;uniform float uBlendFactor0;uniform float uBlendFactor1;uniform bool uCircleVisible;void main(void){vec3 d=vec3(gl_FragCoord.x,gl_FragCoord.y,0.0);vec4 e;e.x=d.x*2.0/uViewport.x-1.0;e.y=d.y*2.0/uViewport.y-1.0;e.z=-1.0;e.w=1.0;e=uProjMatrix*e;e.x=e.x/e.w;e.y=e.y/e.w;e.z=-e.z/e.w;float f=-atan(e.z,sqrt(e.x*e.x+e.y*e.y));if(uCircleVisible&&f<-1.0908307824980232){discard;}float h=atan(e.y,e.x);float i=mod(h/(2.0*c)+1.0,1.0);float j=f/c+0.5;gl_FragColor=uBlendFactor0*texture2D(uTex0,vec2(1.0-i,j))+uBlendFactor1*texture2D(uTex1,vec2(1.0-i,j));}",
    point_vs: "attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;uniform float uPointSize;attribute vec4 aColor;varying vec4 v_c;void main(){gl_PointSize=uPointSize;gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_c=aColor;}",
    point_fs: "precision mediump float;varying vec4 v_c;uniform bool uQuadPoint;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvoid main(void){bool n=false;if((!uQuadPoint&&(gl_PointCoord.x-0.5)*(gl_PointCoord.x-0.5)+(gl_PointCoord.y-0.5)*(gl_PointCoord.y-0.5)>=0.25)){n=true;}else{\n#ifndef FAILSAFE\nif(uDepthTest){vec2 o=vec2(gl_FragCoord.x*uInvViewX,gl_FragCoord.y*uInvViewY);vec4 k=texture2D(uTexDepth,o);if(!i(gl_FragCoord,k.rgb)){n=true;}}\n#endif\n}if(n){discard;}gl_FragColor=v_c;}",
    skybox_fs: "precision mediump float;const float c=3.141592654;uniform vec2 uViewport;uniform mat4 uProjMatrix;uniform sampler2D uTex;uniform float uAlpha;void main(void){vec3 d=vec3(gl_FragCoord.x,gl_FragCoord.y,0.0);vec4 e;e.x=d.x*2.0/uViewport.x-1.0;e.y=d.y*2.0/uViewport.y-1.0;e.z=-1.0;e.w=1.0;e=uProjMatrix*e;e.x=e.x/e.w;e.y=e.y/e.w;e.z=-e.z/e.w;float f=-atan(e.z,sqrt(e.x*e.x+e.y*e.y));float h=atan(e.y,e.x);float i=mod(h/(2.0*c)+1.0,1.0);float j=f/c+0.5;gl_FragColor=uAlpha*texture2D(uTex,vec2(1.0-i,j));}",
    sprite_vs: "attribute vec2 aVertexPosition;attribute vec2 aVertexTextureCoords;uniform mat4 uModelMatrix;uniform mat4 uViewMatrix;uniform mat4 uInverseViewMatrix;uniform mat4 uProjectionMatrix;uniform vec2 uSpriteSize;uniform bool uScaleByDepth;uniform vec2 uViewPort;varying vec2 v_i;void main(){if(uScaleByDepth){vec4 c=uInverseViewMatrix[1];c=normalize(c);vec4 d=uInverseViewMatrix[0];d=normalize(d);vec4 e=aVertexPosition.x*uSpriteSize.x*d+aVertexPosition.y*uSpriteSize.y*c;vec4 f=uModelMatrix*vec4(0.0,0.0,0.0,1.0)+e;vec4 h=uProjectionMatrix*uViewMatrix*f;float w=abs(h.w);if(h.z>-w&&h.z<w){h.x=h.x/h.w;h.y=h.y/h.w;gl_Position=vec4(h.x,h.y,0,1);}else{gl_Position=vec4(0,0,0,0);}}else{vec4 h=uProjectionMatrix*uViewMatrix*uModelMatrix*vec4(0.0,0.0,0.0,1.0);float w=abs(h.w);if(h.z>-w&&h.z<w){h.x=h.x/h.w;h.y=h.y/h.w;gl_Position=vec4(h.x+uSpriteSize.x/uViewPort.x*aVertexPosition.x,h.y+uSpriteSize.y/uViewPort.y*aVertexPosition.y,0,1);}else{gl_Position=vec4(0,0,0,0);}}v_i=aVertexTextureCoords;}",
    sprite_fs: "precision mediump float;uniform sampler2D uTex0;varying vec2 v_i;void main(void){gl_FragColor=texture2D(uTex0,v_i);}",
    texture_vs: "attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;attribute vec2 aVertexTextureCoords;varying vec2 v_i;void main(){gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_i=aVertexTextureCoords;}",
    texture_fs: "precision mediump float;varying vec2 v_i;uniform sampler2D uTex0;uniform float uAlpha;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvoid main(void){\n#ifndef FAILSAFE\nif(uDepthTest){vec2 n=vec2(gl_FragCoord.x*uInvViewX,gl_FragCoord.y*uInvViewY);vec4 k=texture2D(uTexDepth,n);if(!i(gl_FragCoord,k.rgb)){discard;}}\n#endif\nvec4 o=texture2D(uTex0,v_i);gl_FragColor=vec4(o.rgb,o.a*uAlpha);}"
}, WS.BasicShaderDesc = function (e, t) {
    this._vertexShader = e, this._fragmentShader = t
}, WS.BasicShaderDesc.prototype = {
    getDefines: function () {
        return []
    }
}, WS.extend("BasicShaderDesc"), WS.BasicShaderDesc.ID = void 0, WS.BasicShaderDesc.EXT_DEPTH_RANGE = 4, WS.PointShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.point_vs, WS.shaderSrc.point_fs)
}, WS.extend("PointShaderDesc", "BasicShaderDesc"), WS.PointShaderDesc.ID = "PointShader", WS.DynamicPointShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.dynamicpoint_vs, WS.shaderSrc.dynamicpoint_fs)
}, WS.extend("DynamicPointShaderDesc", "BasicShaderDesc"), WS.DynamicPointShaderDesc.ID = "DynamicPointShader", WS.VoronoiPointShaderDesc = function () {
}, WS.VoronoiPointShaderDesc.prototype = {
    getDefines: function (e) {
        {
            var t = WS.DynamicPointShaderDesc.prototype.getDefines.call(this, e);
            F.getGLExtension(e, "EXT_frag_depth")
        }
        return t.concat(["#define VORONOI"])
    }
}, WS.extend("VoronoiPointShaderDesc", "DynamicPointShaderDesc"), WS.VoronoiPointShaderDesc.ID = "VoronoiPointShader", WS.PointMaterial = function (e, t, i) {
    WS.ShaderMaterial.call(this, WS.PointShaderDesc, !0, !0, !1, void 0, void 0, e), this._rgbDepthTestSupport = !0, this._pointSize = void 0 !== t ? t : 1, this._quadPoint = void 0 !== i ? i : !1
}, WS.PointMaterial.prototype = {
    configureShader: function (e) {
        var t = e._geometry,
            i = e.getShaderProgram(this);
        return i.setAttributeValue("aVertexPosition", e.getGlBuffer(t._positionBuffer)), i.setUniformValue("uModelMatrix", e.getModelMatrix()), i.setUniformValue("uViewProjectionMatrix", e._camera._camMatrix), i.setUniformValue("uPointSize", this._pointSize), i.setAttributeValue("aColor", e.getGlBuffer(this._colorBuffer)), i.setUniformValue("uQuadPoint", this._quadPoint), !0
    },
    configureRenderer2d: function (e) {
        return e.setPointSize(this._pointSize), !0
    }
}, WS.extend("PointMaterial", "ShaderMaterial"), WS.DynamicPointMaterial = function (e, t, i, n, r) {
    WS.ShaderMaterial.call(this, r ? WS.VoronoiPointShaderDesc : WS.DynamicPointShaderDesc, !0, !0, !0, void 0, void 0, e), this._dynamicPointSize = n, this._pointSize = t, this._quadPoint = i, this._alpha = 1, this._useFixedColor = !1, this._fixedColor = WS.DynamicPointMaterial.BLACK, this._mvMatrix = void 0
}, WS.DynamicPointMaterial.prototype = {
    configureShader: function (e) {
        var t, i = e._camera,
            n = e.getShaderProgram(this),
            r = this._colorBuffer,
            o = this._fixedColor;
        switch (e._renderColorMode) {
            case WS.RendererBase.RenderMode.DEPTH:
                t = 2;
                break;
            case WS.RendererBase.RenderMode.PICK_3D:
            case WS.RendererBase.RenderMode.NODE:
                t = 1, o = this._pickColor;
                break;
            case WS.RendererBase.RenderMode.PICK_3D_POINT:
                t = 0, r = e._pickColorBuffer;
                break;
            default:
                t = this._useFixedColor ? 1 : 0
        }
        n.setAttributeValue("aVertexPosition", e.getGlBuffer(e._geometry._positionBuffer, !0)), n.setAttributeValue("aColor", e.getGlBuffer(r, !0)), r === this._colorBuffer && r._bufferData && (r._bufferData = void 0), n.setUniformValue("uColorMode", t), n.setUniformValue("uFixedColor", o);
        var a = this._mvMatrix;
        a || (a = mat4.multiply(i._transform, e.getModelMatrix(), mat4.create())), n.setUniformValue("uModelViewMatrix", a), n.setUniformValue("uProjectionMatrix", i._projMatrix), this._shaderProgramDesc === WS.VoronoiPointShaderDesc && n.setUniformValue("uProjectionMatrixFS", i._projMatrix), n.setUniformValue("uAlpha", this._alpha), n.setUniformValue("uColor8Bit", !0), n.setUniformValue("uQuadPoint", this._quadPoint);
        var s = 0,
            c = 0,
            l = 0;
        if (this._dynamicPointSize) {
            var h = e._camera._fovY * Math.PI / 180;
            s = this._pointSize.physical * e._canvasHeight / (2 * Math.tan(h / 2)), c = this._pointSize.minPixel, l = this._pointSize.maxPixel
        } else c = this._pointSize;
        return n.setUniformValue("uDynamicPointSize", this._dynamicPointSize), n.setUniformValue("uPointSizeFactor", s), n.setUniformValue("uMinPointSize", c), n.setUniformValue("uMaxPointSize", l), !0
    },
    configureRenderer2d: function () {
    }
}, WS.extend("DynamicPointMaterial", "ShaderMaterial"), WS.DynamicPointMaterial.BLACK = [0, 0, 0, 0], WS.PointRenderable = function (e, t, i, n) {
    n = n || new WS.PointMaterial(t, i);
    var r = new WS.Geometry;
    r._primitiveType = WS.Geometry.PrimitiveType.Points, r._positionBuffer = e, WS.Mesh.call(this, r, n)
}, WS.PointRenderable.prototype = {
    setPointPositions: function (e) {
        this._geometry._positionBuffer.setBufferData(e)
    },
    setColors: function (e) {
        this._material._colorBuffer.setBufferData(e)
    },
    setPointSize: function (e) {
        this._material._pointSize = e
    }
}, WS.extend("PointRenderable", "Mesh"), WS.DynamicPointRenderable = function (e, t, i, n, r, o) {
    var a = "object" == typeof i;
    n = n || !1, r = r || !1, o && (this._shortID = o), WS.PointRenderable.call(this, e, void 0, void 0, new WS.DynamicPointMaterial(t, i, n, a, r))
}, WS.DynamicPointRenderable.prototype = {
    draw2d: function () {
    },
    setPointSize: function (e) {
        this._material._dynamicPointSize = "object" == typeof e, this._material._pointSize = e
    },
    enableVoronoi: function (e) {
        this._material._shaderProgramDesc = e ? WS.VoronoiPointShaderDesc : WS.DynamicPointShaderDesc
    },
    setAlpha: function (e) {
        this._material._alpha = e
    },
    getAlpha: function () {
        return this._material._alpha
    }
}, WS.extend("DynamicPointRenderable", "PointRenderable"), WS.LineShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.line_vs, WS.shaderSrc.line_fs)
}, WS.extend("LineShaderDesc", "BasicShaderDesc"), WS.LineShaderDesc.ID = "LineShader", WS.LineMaterial = function (e, t, i, n, r) {
    WS.ShaderMaterial.call(this, WS.LineShaderDesc, !0, !0, !1, void 0, void 0, e), this._rgbDepthTestSupport = !0, this._dashLine = void 0 !== t ? t : WS.LineMaterial.Dash.None, this._dashLineColor = void 0 !== i ? i : [0, 0, 0, 1], this._dashLength = void 0 !== n ? n : 1, this._lineWidth = void 0 !== r ? r : 1
}, WS.LineMaterial.prototype = {
    configureShader: function (e) {
        var t = e ? e._camera : void 0;
        if (t) {
            var i = e._geometry,
                n = e.getShaderProgram(this),
                r = e.getModelMatrix(),
                o = t._camMatrix;
            e.setLineWidth(this._lineWidth), n.setAttributeValue("aVertexPosition", e.getGlBuffer(i._positionBuffer)), n.setUniformValue("uModelMatrix", r), n.setUniformValue("uViewProjectionMatrix", o), n.setAttributeValue("aColor", e.getGlBuffer(this._colorBuffer));
            var a = this._dashLine ? e.getGlBuffer(i._distanceBuffer) : 0;
            return n.setAttributeValue("aDist", a), n.setUniformValue("uDashLength", this._dashLength), n.setUniformValue("uDashColor", this._dashLineColor), !0
        }
    },
    configureRenderer2d: function (e) {
        return e.setLineWidth(this._lineWidth), !0
    }
}, WS.extend("LineMaterial", "ShaderMaterial"), WS.LineMaterial.Dash = {
    None: 0,
    Fixed: 1,
    Adaptive: 2
}, WS.GeometryProjector = {}, WS.GeometryProjector.projectLineGeometry = function (e, t, i, n, r) {
    var o = [],
        a = new MatrixArray(4);
    a[3] = 1;
    var s = new MatrixArray(4);
    s[3] = 1;
    for (var c, l, h, d = 0, u = t.getCountPositions(); u - 1 > d;) {
        if (h = t.getPosition(d, a), h = t.getPosition(d + 1, s), h > 2) {
            i && (mat4.multiplyVec3(i, a), mat4.multiplyVec3(i, s)), a[3] = 1, s[3] = 1, c = new MatrixArray(4), l = new MatrixArray(4);
            var _ = e.projectLine(a, s, c, l, n, r);
            _ || (c = void 0, l = void 0)
        } else c = [a[0], a[1]], l = [s[0], s[1]];
        o.push(c), (t._primitiveType === WS.Geometry.PrimitiveType.Lines || d === u - 2) && o.push(l), t._primitiveType === WS.Geometry.PrimitiveType.LineStrip ? d++ : d += 2
    }
    return o
}, WS.GeometryProjector.projectPoints = function (e, t, i, n, r, o) {
    for (var a = [], s = 0, c = t.getCountPositions(); c > s; s++) {
        var l = new MatrixArray(4);
        l[3] = 1, t.getPosition(s, l), i && mat4.multiplyVec3(i, l);
        var h = e.projectPoint(l, l, o, n, r);
        h || (l = void 0), a.push(l)
    }
    return a
}, WS.GeometryProjector.projectPointGeometry = function (e, t, i, n, r) {
    return WS.GeometryProjector.projectPoints(e, t, i, n, r, !1)
}, WS.GeometryProjector.projectTriangleStripGeometry = function (e, t, i, n, r) {
    return WS.GeometryProjector.projectPoints(e, t, i, n, r, !0)
}, WS.GeometryProjector.projectTriangleGeometry = function (e, t, i, n, r, o) {
    if (t._indexBuffer) return WS.GeometryProjector.projectPoints(e, t, i, n, r, !0);
    for (var a = [], s = t.getCountPositions(), c = 0; s > c; c += 3) {
        for (var l = [], h = !0, d = 0; 3 > d; d++) {
            var u = new MatrixArray(5);
            if (u[3] = 1, t.getPosition(c + d, u), i && mat4.multiplyVec3(i, u), h = e.projectPoint(u, u, !0, n, r, !1), !h) break;
            l.push(u)
        }
        h = h && vec2.isTriangleVisible(l[0], l[1], l[2], n, r) && !WS.GeometryProjector.isCulled(l[0], l[1], l[2], o), h ? (a.push(l[0]), a.push(l[1]), a.push(l[2])) : (a.push(void 0), a.push(void 0), a.push(void 0))
    }
    return a
}, WS.GeometryProjector.projectPolyCircuitGeometry = function (e, t, i, n, r) {
    for (var o = 0, a = 0, s = 0, c = 0, l = [], h = t.getCountPositions(), d = 0; h > d; ++d) {
        var u = new MatrixArray(4);
        u[3] = 1, t.getPosition(d, u), i && mat4.multiplyVec3(i, u);
        {
            e.projectPoint(u, u, !1, n, r, !0)
        }
        u[0] < 0 && c++, n <= u[0] && a++, u[1] < 0 && o++, r <= u[1] && s++, l.push(u)
    }
    return o === h || a === h || s === h || c === h ? [] : l
}, WS.GeometryProjector.projectGeometry = function (e, t, i, n, r, o) {
    switch (t._primitiveType) {
        case WS.Geometry.PrimitiveType.Points:
            return WS.GeometryProjector.projectPointGeometry(e, t, i, n, r);
        case WS.Geometry.PrimitiveType.Lines:
        case WS.Geometry.PrimitiveType.LineStrip:
            return WS.GeometryProjector.projectLineGeometry(e, t, i, n, r);
        case WS.Geometry.PrimitiveType.Triangles:
            return WS.GeometryProjector.projectTriangleGeometry(e, t, i, n, r, o);
        case WS.Geometry.PrimitiveType.TriangleStrip:
            return WS.GeometryProjector.projectTriangleStripGeometry(e, t, i, n, r);
        case WS.Geometry.PrimitiveType.PolyCircuit:
            return WS.GeometryProjector.projectPolyCircuitGeometry(e, t, i, n, r)
    }
}, WS.GeometryProjector.isCulled = function (e, t, i, n) {
    if (n === WS.Material.Cull.OFF) return !1;
    var r = vec2.subtract(t, e, vec2.create()),
        o = vec2.subtract(i, e, vec2.create()),
        a = vec2.cross(r, o),
        s = 0 > a;
    return s ? n === WS.Material.Cull.BACK : n === WS.Material.Cull.FRONT
}, WS.LineGeometry = function (e, t) {
    WS.Geometry.call(this), this._positionBuffer = e, this._positionItemSize = 3, this._primitiveType = t ? WS.Geometry.PrimitiveType.LineStrip : WS.Geometry.PrimitiveType.Lines, this._distanceBuffer = new WS.ArrayBuffer([], 1), this._positionBuffer.addListener(this)
}, WS.LineGeometry.prototype = {
    onDataChange: function () {
        this.updateDistances()
    },
    updateDistances: function () {
        var e, t = this.getCountPositions(),
            i = vec3.create(),
            n = vec3.create(),
            r = [];
        if (this._primitiveType === WS.Geometry.PrimitiveType.Lines)
            for (e = 1; t > e; e += 2) this.getPosition(e, i), this.getPosition(e - 1, n), r[e - 1] = 0, r[e] = vec3.dist(i, n);
        else
            for (r[0] = 0, e = 1; t > e; e++) this.getPosition(e, i), this.getPosition(e - 1, n), r[e] = r[e - 1] + vec3.dist(i, n);
        this._distanceBuffer.setBufferData(r)
    },
    getDistance: function (e) {
        var t = [0];
        return this._distanceBuffer.getItem(e, t), t[0]
    }
}, WS.extend("LineGeometry", "Geometry"), WS.LinesGeometry = function (e) {
    WS.LineGeometry.call(this, e, !1)
}, WS.extend("LinesGeometry", "LineGeometry"), WS.LinestripGeometry = function (e) {
    WS.LineGeometry.call(this, e, !1)
}, WS.extend("LinestripGeometry", "LineGeometry"), WS.LineRenderable = function (e, t, i, n, r, o, a) {
    var s = new WS.LineGeometry(e, o);
    this._dashLength = r, WS.Mesh.call(this, s, new WS.LineMaterial(t, i, n, 1, a)), this.updateDashedLine(), this._geometry._distanceBuffer.addListener(this), this._material._colorBuffer.addListener(this)
}, WS.LineRenderable.prototype = {
    onDataChange: function () {
        this.updateDashedLine()
    },
    setEndPointPositions: function (e) {
        this._geometry._positionBuffer.setBufferData(e)
    },
    setColors: function (e) {
        this._material._colorBuffer.setBufferData(e)
    },
    setDashLength: function (e) {
        this._dashLength = e, this.updateDashedLine()
    },
    getCurrentDashLength: function () {
        return this.isDashed() ? this._material._dashLength : void 0
    },
    isDashed: function () {
        return this._material._dashLine !== WS.LineMaterial.Dash.None
    },
    getPickInfo: function (e, t, i, n) {
        var r, o, a, s, c = 0,
            l = this._geometry,
            h = WS.GeometryProjector.projectGeometry(e, this._geometry, t),
            d = l._primitiveType == WS.Geometry.PrimitiveType.Lines ? 2 : 1;
        for (c = 0, a = h.length - 1; a > c; c += d)
            if (r = h[c], o = h[c + 1], r && o && (s = vec2.distToLine(r, o, [i, e._height - n]), s < WS.LineRenderable.pickEpsilon)) return new WS.PickInfo(this);
        return void 0
    },
    getRegionPickInfo: function (e, t, i) {
        var n = WS.GeometryProjector.projectGeometry(e, this._geometry, t),
            r = n.length;
        if (0 === r) return void 0;
        for (var o = 0; r > o; o++) {
            var a = n[o];
            if (!a || !i.containsPt(a[0], e._height - a[1])) return void 0
        }
        return new WS.PickInfo(this)
    },
    draw2d: function (e, t, i) {
        (i || t(this)) && (this._geometry.getCountPositions() < 2 || WS.Mesh.prototype.draw2d.call(this.isDashed() ? this._dashedLineRenderable : this, e, t, !0))
    },
    draw3d: function (e, t, i) {
        (i || t(this)) && (this._geometry.getCountPositions() < 2 || WS.Mesh.prototype.draw3d.call(this, e, t, !0))
    },
    calcAdaptiveDashLength: function (e) {
        for (var t = WS.LineRenderable.adaptiveDashLengthFactors[0], i = WS.LineRenderable.adaptiveDashLengthFactors[1], n = [i, t], r = [1 / t, 1 / i], o = WS.LineRenderable.maxNumOfAdaptiveDashes, a = WS.LineRenderable.maxNumOfAdaptiveDashes / i, s = this._dashLength, c = 0; a > e / s;) s *= r[c++ % 2];
        if (0 === c)
            for (; e / s > o;) s *= n[c++ % 2];
        return s
    },
    updateDashedLine: function () {
        if (this.isDashed()) {
            var e, t, i, n, r = this._geometry,
                o = this._material,
                a = [],
                s = [],
                c = r.getCountPositions() - 1,
                l = r._primitiveType === WS.Geometry.PrimitiveType.Lines ? 2 : 1,
                h = new MatrixArray(4),
                d = new MatrixArray(4);
            if (o._dashLine === WS.LineMaterial.Dash.Fixed) n = this._dashLength;
            else {
                for (var u = 0, _ = 0; c > _; _ += l) e = r.getDistance(_), t = r.getDistance(_ + 1), u = Math.max(u, t - e);
                n = u > 0 ? this.calcAdaptiveDashLength(u) : 1
            }
            o._dashLength = n;
            for (var p, g, f, m, v = vec3.create(), S = vec3.create(), b = new MatrixArray(4), y = o._dashLineColor, P = !1, M = 0; c > M; M += l) {
                for (r.getPosition(M, h), r.getPosition(M + 1, d), o.getColor(M, b), e = r.getDistance(M), t = r.getDistance(M + 1), i = t - e, vec3.subtract(d, h, v), p = n / i, a.push(h[0], h[1], h[2]), s.push(b[0], b[1], b[2], b[3]), P = !1, g = p; 1 >= g; g += p) vec3.scale(v, g, S), vec3.add(h, S, S), a.push(S[0], S[1], S[2]), a.push(S[0], S[1], S[2]), f = P ? y : b, m = P ? b : y, s.push(f[0], f[1], f[2], f[3]), s.push(m[0], m[1], m[2], m[3]), P = !P;
                if (a.length % 2 !== 0) {
                    a.push(d[0], d[1], d[2]);
                    var w = s.length - 4;
                    s.push(s[w], s[w + 1], s[w + 2], s[w + 3])
                }
            }
            this._dashedLineRenderable ? (this._dashedLineRenderable.setEndPointPositions(a), this._dashedLineRenderable.setColors(s)) : (this._dashedLineRenderable = new WS.LinesRenderable(new WS.ArrayBuffer(a, 3), new WS.ArrayBuffer(s, 4), WS.LineMaterial.Dash.None), this._dashedLineRenderable.addToLayer(this._layerId, !0))
        }
    },
    getMemberRenderables: function () {
        return this._dashedLineRenderable ? [this._dashedLineRenderable] : []
    }
}, WS.extend("LineRenderable", "Mesh"), WS.LineRenderable.pickEpsilon = 5, WS.LineRenderable.dashColor = [0, 0, 0, 0], WS.LineRenderable.adaptiveDashLengthFactors = [2, 5], WS.LineRenderable.maxNumOfAdaptiveDashes = 25, WS.LinesRenderable = function (e, t, i, n, r, o) {
    WS.LineRenderable.call(this, e, t, i, n, r, !1, o)
}, WS.extend("LinesRenderable", "LineRenderable"), WS.LinestripRenderable = function (e, t, i, n, r, o) {
    WS.LineRenderable.call(this, e, t, i, n, r, !0, o)
}, WS.extend("LinestripRenderable", "LineRenderable"), WS.DottedLinesRenderable = function (e, t, i, n, r, o, a, s, c, l) {
    this._pointPositionBuffer = void 0 !== e ? e : new WS.ArrayBuffer([], 3), this._colorBufferPointsSmall = void 0 !== t ? t : WS.DottedLinesRenderable.colorPointSmall, this._colorBufferPointsLarge = void 0 !== i ? i : WS.DottedLinesRenderable.colorPointLarge, this._colorBufferLines = void 0 !== n ? n : WS.DottedLinesRenderable.colorLine;
    var h = void 0 !== r ? r : WS.LineMaterial.Dash.None,
        d = void 0 !== o ? o : WS.DottedLinesRenderable.sizePointSmall,
        u = void 0 !== a ? a : WS.DottedLinesRenderable.sizePointLarge;
    this._lineRenderable = new WS.LinesRenderable(this._pointPositionBuffer, this._colorBufferLines, h, s, c, l), this._pointLargeRenderable = new WS.PointRenderable(this._pointPositionBuffer, this._colorBufferPointsLarge, u), this._pointSmallRenderable = new WS.PointRenderable(this._pointPositionBuffer, this._colorBufferPointsSmall, d)
}, WS.DottedLinesRenderable.prototype = {
    setTransparency: function (e) {
        this._colorBufferPointsSmall.setComponentOfAllItems(3, e), this._colorBufferPointsLarge.setComponentOfAllItems(3, e), this._colorBufferLines.setComponentOfAllItems(3, e)
    },
    enableDepthTest: function (e) {
        this._lineRenderable._material._depthTest = e, this._pointLargeRenderable._material._depthTest = e, this._pointSmallRenderable._material._depthTest = e
    },
    setPointSizes: function (e, t) {
        this._pointLargeRenderable.setPointSize(t), this._pointSmallRenderable.setPointSize(e)
    },
    setPoints: function (e) {
        this._pointPositionBuffer.setBufferData(e)
    },
    setCornerPointsFrom2dArray: function (e) {
        for (var t = [], i = 0, n = e.length; n > i; i++) t.push.apply(t, e[i]), (0 !== i && i !== n - 1 || 1 === n) && t.push.apply(t, e[i]);
        this.setPoints(t)
    },
    setColorPointsSmall: function (e) {
        this._colorBufferPointsSmall.setBufferData(e)
    },
    setColorPointsLarge: function (e) {
        this._colorBufferPointsLarge.setBufferData(e)
    },
    setColorLines: function (e) {
        this._colorBufferLines.setBufferData(e)
    },
    setDashLength: function (e) {
        this._lineRenderable.setDashLength(e)
    },
    getCurrentDashLength: function () {
        return this._lineRenderable.getCurrentDashLength()
    },
    addPoint: function (e) {
        if (e) {
            var t = this._pointPositionBuffer.getCountItems() - 1;
            if (t > 0) {
                var i = vec3.create();
                this._pointPositionBuffer.getItem(t, i), this._pointPositionBuffer.addItem(i)
            }
            this._pointPositionBuffer.addItem(e)
        }
    },
    draw3d: function (e, t, i) {
        (i || t(this)) && this.drawMemberRenderables3d(e, t, !0)
    },
    draw2d: function (e, t, i) {
        (i || t(this)) && this.drawMemberRenderables2d(e, t, !0)
    },
    getPickInfo: function (e, t, i, n) {
        return this._lineRenderable.getPickInfo(e, t, i, n)
    },
    getRegionPickInfo: function (e, t, i) {
        return this._lineRenderable.getRegionPickInfo(e, t, i)
    },
    getMemberRenderables: function () {
        return [this._lineRenderable, this._pointLargeRenderable, this._pointSmallRenderable]
    }
}, WS.extend("DottedLinesRenderable", "Renderable"), WS.DottedLinesRenderable.sizePointSmall = 4, WS.DottedLinesRenderable.sizePointLarge = 6, WS.DottedLinesRenderable.colorPointSmall = new WS.ArrayBuffer([0, 0, 0, 1], 4), WS.DottedLinesRenderable.colorPointLarge = new WS.ArrayBuffer([1, .7, .078, 1], 4), WS.DottedLinesRenderable.colorLine = new WS.ArrayBuffer([1, .7, .078, 1], 4), WS.BaseHandler = function (e, t) {
    this._camera = e, this._view = t, this._dblClickHappened = !1
}, WS.BaseHandler.prototype = {
    activate: function () {
    },
    deactivate: function () {
    },
    pickPoint: function (e, t, i) {
        if (this._view.instanceOf(WS.MapLeaflet)) {
            var n = this._view.containerPointToXYZ(e, t);
            return [0, 0, n, !1]
        }
        var r, o, a, s = this._view.isRootCloud();
        if (s) {
            if (r = this._view.pick3d(e, this._camera._height - t, !1, !0, i), !r) return void 0;
            o = 0, a = 0
        } else {
            var c = new WS.PerspectiveCamera;
            c.copyFrom(this._camera);
            var l = this._view.getGlobalTrafoOfRoot(),
                h = mat4.inverse(l, mat4.create()),
                d = c.getGlobalTrafo(this._view._trafoView),
                u = mat4.multiply(h, d, mat4.create());
            c.setFromGlobalTrafo(u, mat4.identity());
            var _ = c.unprojectPoint([e, c._height - t, .99]);
            r = mat4.multiplyVec3(l, _);
            var p = c.getAnglesForScreenCoordinates(e, c._height - t);
            o = p[0], a = p[1]
        }
        return [o, a, r, s]
    }
}, WS.extend("BaseHandler", "Observable"), WS.MoveHandler = function (e, t, i) {
    WS.BaseHandler.call(this, e, t), this._settingService = i
}, WS.MoveHandler.prototype = {
    startMove: function () {
        this._view._isMoving++, this._view.hideRadialMenu()
    },
    endMove: function () {
        this._view._isMoving = 0 < this._view._isMoving ? this._view._isMoving - 1 : 0, 0 === this._view._isMoving && this._view.triggerCameraChange()
    },
    onDragStart: function () {
        return this.startMove(), !0
    },
    onDragStop: function () {
        return this.endMove(), !0
    },
    onScroll: function (e, t) {
        return this._camera.changeFOVY(e, t ? 3 : 1), this._view.hideRadialMenu(), !0
    },
    determineRotationDeltas: function (e, t) {
        var i = this._settingService.getMovementSpeed(),
            n = (i - WS.PanoSettings.MinMovementSpeed) / (WS.PanoSettings.MaxMovementSpeed - WS.PanoSettings.MinMovementSpeed);
        n = Math.max(4 * n, 1);
        var r = this._camera._fovY / 180 * Math.PI,
            o = r * this._camera._width / this._camera._height,
            a = e * n / this._camera._width * o,
            s = t * n / this._camera._height * r;
        return [a, s]
    }
}, WS.extend("MoveHandler", "BaseHandler"), WS.PickObjectHandler = function (e, t, i) {
    WS.BaseHandler.call(this, e, i), this._scene = t, this._pickInfo = void 0
}, WS.PickObjectHandler.prototype = {
    onDragStart: function (e, t, i) {
        if (i !== WS.MouseAdapter.Button.Left) return !1;
        void 0 !== this._pickInfo && this.onDragStop(e, t);
        var n = this.pickRenderableInfo(e, t, !0);
        return void 0 !== n && n._list[0].supportsDragging() ? (this._pickInfo = n, this.informListener("onObjectDragStart", [this._pickInfo, e, t]), !0) : !1
    },
    onDragMove: function (e, t, i, n, r) {
        return r !== WS.MouseAdapter.Button.Left ? !1 : void 0 !== this._pickInfo ? (this.informListener("onObjectDragMove", [this._pickInfo, e, t, i, n]), !0) : !1
    },
    onDragStop: function (e, t, i) {
        if (i !== WS.MouseAdapter.Button.Left) return !1;
        var n = !1;
        return void 0 !== this._pickInfo && (this.informListener("onObjectDragStop", [this._pickInfo, e, t]), n = !0), this._pickInfo = void 0, n
    },
    onDblClick: function (e, t, i) {
        if (i !== F.MouseAdapter.Button.Left) return !this._view.instanceOf(WS.MapLeaflet);
        this._dblClickHappened = !0;
        var n, r = this.pickRenderableInfo(e, t);
        if (r) {
            var o = r._list;
            o.length > 0 && (n = o[o.length - 1])
        }
        return n ? (this.informListener("onObjectDblClick", [n, e, t, r]), this._view.instanceOf(WS.MapLeaflet) ? !1 : !0) : !1
    },
    onClick: function (e, t, i) {
        if (i !== WS.MouseAdapter.Button.Left) return !this._view.instanceOf(WS.MapLeaflet);
        this._dblClickHappened = !1;
        var n = this.pickRenderable(e, t);
        return this.informListener("onObjectClick", [n, e, t, r]), this._view.instanceOf(WS.MapLeaflet) ? !1 : !!n
    },
    pickRenderable: function (e, t) {
        var i = this.pickRenderableInfo(e, t);
        return i && i._list.length ? i._list[i._list.length - 1] : void 0
    },
    pickRenderableInfo: function (e, t, i) {
        var n = (this._view instanceof WS.PanoramaView && this._view.isRootCloud(), new WS.PickObjectVisitor(this._camera, e, t, this._view));
        return this._scene.traverse(n), n._pickInfo ? n._pickInfo : void 0
    }
}, WS.extend("PickObjectHandler", "BaseHandler"), WS.SelectRegionHandler = function (e, t, i, n, r) {
    WS.BaseHandler.call(this, e, i), this._scene = t, this._renderable = n, this._rect = [0, 0, 0, 0], this._addToSelection = r
}, WS.SelectRegionHandler.prototype = {
    onDragStart: function (e, t, i) {
        return i !== WS.MouseAdapter.Button.Left ? !1 : (this._rect[0] = this._rect[2] = e, this._rect[1] = this._rect[3] = t, this._renderable.setCorners(this._rect), !0)
    },
    onDragMove: function (e, t, i, n, r) {
        return r !== WS.MouseAdapter.Button.Left ? !1 : (this._rect[2] = e, this._rect[3] = t, this._renderable.setCorners(this._rect), !0)
    },
    onDragStop: function (e, t, i) {
        if (i !== WS.MouseAdapter.Button.Left) return !1;
        this._rect[2] = e, this._rect[3] = t;
        var n = WS.Rectangle.fromCorners(this._rect[0], this._rect[1], this._rect[2], this._rect[3]),
            r = new WS.SelectRegionVisitor(this._camera, n, this._view);
        if (this._scene.traverse(r), r._pickedRenderables.length > 0) {
            var o = this._addToSelection ? "onObjectsSelect" : "onObjectsUnselect";
            this.informListener(o, [r._pickedRenderables])
        }
        return this._renderable.setCorners(void 0), !0
    },
    deactivate: function () {
        this._renderable.setCorners(void 0)
    }
}, WS.extend("SelectRegionHandler", "BaseHandler"), WS.PickObjectVisitor = function (e, t, i, n) {
    this._pickedRenderable = void 0, this._pickInfo = void 0, this._modelMatrixStack = new WS.MatrixStack, this._view = n, this._layerService = F.DI().getService("layer"), this._cameraObject = void 0, this._camera = e, this._x = t, this._y = i, this._is3dView = n instanceof WS.PanoramaView && n.isRootCloud()
}, WS.PickObjectVisitor.prototype = {
    prepare: function () {
        this._camera && (this._cameraObject = this._camera.createCameraObject(mat4.identity())), this._pickedRenderable = void 0, this._pickInfo = void 0
    },
    visit: function (e) {
        var t = this._modelMatrixStack._top;
        if (e.instanceOf(WS.Renderable) && e.getPickInfo && this._layerService.isLayerVisible(e._layerId, this._view)) {
            var i = mat4.getTranslation(t);
            if (this._cameraObject && this._cameraObject.calcDistToPoint(i) < this._layerService.getObjectsVisbleUpToDistance(e._layerId, this._view)) {
                var n = e.getPickInfo(this._camera, t, this._x, this._y, this._is3dView);
                if (void 0 !== n) return this._pickedRenderable = e, this._pickInfo = n, !1
            }
        }
        return !0
    }
}, WS.extend("PickObjectVisitor", "SceneVisitorBase"), WS.SelectRegionVisitor = function (e, t, i) {
    this._pickedRenderables = [], this._modelMatrixStack = new WS.MatrixStack, this._view = i, this._layerService = F.DI().getService("layer"), this._cameraObject = void 0, this._camera = e, this._rectangle = t
}, WS.SelectRegionVisitor.prototype = {
    prepare: function () {
        this._camera && (this._cameraObject = this._camera.createCameraObject(mat4.identity())), this._pickedRenderables = []
    },
    visit: function (e) {
        var t = this._modelMatrixStack._top;
        if (e.instanceOf(WS.Renderable) && this._layerService.isLayerVisible(e._layerId, this._view)) {
            var i = mat4.getTranslation(t);
            if (this._cameraObject && this._cameraObject.calcDistToPoint(i) < this._layerService.getObjectsVisbleUpToDistance(e._layerId, this._view)) {
                var n = e.getRegionPickInfo(this._camera, t, this._rectangle);
                n && this._pickedRenderables.push(e)
            }
        }
        return !0
    }
}, WS.extend("SelectRegionVisitor", "SceneVisitorBase"), WS.Camera = function (e, t, i, n) {
    this._width = void 0 !== e ? e : 300, this._height = void 0 !== t ? t : 150, this._near = void 0 !== i ? i : .1, this._far = void 0 !== n ? n : 500, this._inverseTransform = mat4.identity(), this._projMatrix = mat4.identity(), this._camMatrix = mat4.identity(), this._camMatrixOrigin = mat4.identity(), this._dirty = !1, this._changesToTrigger = !1, this._projPoint = vec4.create()
}, WS.Camera.prototype = {
    copyFrom: function (e) {
        this._children = [];
        for (var t = 0, i = e._children.length; i > t; ++t) this._children.push(e._children[t]);
        this._parent = e._parent, this._transform = mat4.create(e._transform), this._width = e._width, this._height = e._height, this._near = e._near, this._far = e._far, this._inverseTransform = mat4.create(e._inverseTransform), this._projMatrix = mat4.create(e._projMatrix), this._camMatrix = mat4.create(e._camMatrix), this._camMatrixOrigin = mat4.create(e._camMatrixOrigin), this._dirty = e._dirty, this._changesToTrigger = e._changesToTrigger, this._projPoint = vec4.create(e._projPoint)
    },
    setDimensions: function (e, t) {
        (e !== this._width || this._height !== t) && (this._width = e, this._height = t, this.updateCameraMatrix())
    },
    setNearAndFarPlane: function (e, t) {
        e && (this._near = e), t && (this._far = t), this.updateCameraMatrix()
    },
    updateProjectionMatrix: function () {
    },
    updateCameraMatrix: function () {
        this.updateProjectionMatrix(), mat4.inverse(this._transform, this._inverseTransform), mat4.multiply(this._projMatrix, this._transform, this._camMatrix), mat4.set(this._transform, this._camMatrixOrigin), mat4.setTranslation(this._camMatrixOrigin, [0, 0, 0]), mat4.multiply(this._projMatrix, this._camMatrixOrigin, this._camMatrixOrigin), this._dirty = !0, this._changesToTrigger = !0
    },
    rotate: function (e, t) {
        WS.Transform.prototype.rotate.call(this, e, t), this.updateCameraMatrix()
    },
    rotateX: function (e) {
        WS.Transform.prototype.rotateX.call(this, e), this.updateCameraMatrix()
    },
    rotateY: function (e) {
        WS.Transform.prototype.rotateY.call(this, e), this.updateCameraMatrix()
    },
    rotateZ: function (e) {
        WS.Transform.prototype.rotateZ.call(this, e), this.updateCameraMatrix()
    },
    projectPoint: function (e, t, i, n, r, o) {
        t = t || e;
        var a = this._projPoint,
            s = n || this._width,
            c = r || this._height;
        mat4.multiplyVec4(this._camMatrix, e, a);
        var l = Math.abs(a[3]),
            h = !0;
        return ((a[0] <= -l || a[0] >= l || a[1] <= -l || a[1] >= l) && !i || a[2] <= -l || a[2] >= l) && (h = !1, !o) ? h : (t[0] = a[0] / a[3], t[1] = a[1] / a[3], t[2] = a[2] / a[3], t[0] = (t[0] + 1) / 2 * s, t[1] = (t[1] + 1) / 2 * c, t[2] = (t[2] + 1) / 2, t.length >= 4 && (t[3] = 1), t.length >= 5 && (t[4] = 1 / a[3]), h)
    },
    projectLine: function (e, t, i, n, r, o, a) {
        var s, c = 1e-5,
            l = r || this._width,
            h = o || this._height;
        i = i || e, n = n || t, mat4.multiplyVec4(this._camMatrix, e, i), mat4.multiplyVec4(this._camMatrix, t, n);
        var d = [];
        if (i[3] >= c && n[3] >= c || i[3] <= -c && n[3] <= -c) d.push(i), d.push(n);
        else {
            for (var u = new MatrixArray(4), _ = new MatrixArray(4), p = 0; 4 > p; p++) u[p] = i[p], _[p] = n[p];
            s = vec4.clipLineToXYZHyperPlane(i, n, -c, !1), s && (d.push(i), d.push(n)), s = vec4.clipLineToXYZHyperPlane(u, _, c, !0), s && (d.push(u), d.push(_))
        }
        var g, f, m;
        for (g = 0, f = d.length; f > g; g++) m = d[g], m[0] = m[0] / m[3], m[1] = m[1] / m[3], m[2] = m[2] / m[3];
        for (g = 0, f = d.length; f > g; g += 2) {
            var v = d[g],
                S = d[g + 1];
            vec3.clipLineToUniformCube(v, S)
        }
        for (g = d.length - 1; g >= 0; g -= 1) {
            var b = d[g];
            ((b[0] < -1 || b[0] > 1 || b[1] < -1 || b[1] > 1) && !a || b[2] < -1 || b[2] > 1) && d.splice(g, 1)
        }
        for (g = 0, f = d.length; f > g; g++) m = d[g], m[0] = (m[0] + 1) / 2 * l, m[1] = (m[1] + 1) / 2 * h, m[2] = (m[2] + 1) / 2;
        if (2 === d.length) {
            for (var y = 0; 4 > y; y++) i[y] = d[0][y], n[y] = d[1][y];
            return !0
        }
        return !1
    },
    unprojectPoint: function (e, t) {
        var i = t || e;
        return vec3.unproject(e, this._transform, this._projMatrix, [0, 0, this._width, this._height], i), i
    },
    getAnglesForScreenCoordinates: function (e, t) {
        var i = this.getPosInView(),
            n = this.unprojectPoint([e, t, .99]),
            r = vec3.create();
        vec3.subtract(n, i, r);
        var o = vec3.create();
        return vec3.fromCartesianToSpherical(r, o), [2 * Math.PI - o[0], -o[1]]
    },
    getGlobalTrafo: function (e) {
        if (!e) return this._inverseTransform;
        var t = mat4.multiply(e, this._inverseTransform, mat4.create());
        return t
    },
    getGlobalPos: function (e) {
        return mat4.getTranslation(e ? this.getGlobalTrafo(e) : this._inverseTransform)
    },
    getTrafoInView: function () {
        return this._inverseTransform
    },
    getPosInView: function () {
        return mat4.getTranslation(this._inverseTransform)
    },
    setFromGlobalTrafo: function (e, t) {
        this._transform = this.calcTrafoInCameraRef(e, t), this.updateCameraMatrix()
    },
    setFromGlobalPos: function (e, t) {
        var i = this.getGlobalTrafo(t);
        mat4.setTranslation(i, e), this.setFromGlobalTrafo(i, t)
    },
    calcTrafoInCameraRef: function (e, t) {
        var i = mat4.inverse(e, mat4.create()),
            n = mat4.multiply(i, t, mat4.create());
        return n
    },
    calcPosInCameraRef: function (e, t) {
        var i = this.getGlobalTrafo(t);
        mat4.setTranslation(i, e);
        var n = this.calcTrafoInCameraRef(i, t);
        return mat4.getTranslation(n)
    },
    createCameraObject: function (e) {
        return new WS.CameraObject(this.getGlobalTrafo(e))
    },
    translate: function (e) {
        WS.Transform.prototype.translate.call(this, e), this.updateCameraMatrix()
    },
    setTranslation: function (e) {
        WS.Transform.prototype.setTranslation.call(this, e), this.updateCameraMatrix()
    }
}, WS.extend("Camera", "Transform"), WS.PerspectiveCamera = function (e, t, i, n, r) {
    WS.Camera.call(this, e, t, i, n), this._fovY = void 0 !== r ? r : WS.PerspectiveCamera.DefaultFov, this._mode = WS.PerspectiveCamera.Mode._3D, this.initCameraTransform(), this.updateCameraMatrix()
}, WS.PerspectiveCamera.prototype = {
    copyFrom: function (e) {
        WS.Camera.prototype.copyFrom.call(this, e), e.instanceOf(WS.PerspectiveCamera) && (this._fovY = e._fovY, this._mode = e._mode)
    },
    initCameraTransform: function () {
        mat4.identity(this._transform), mat4.rotateX(this._transform, Math.PI * -.5), mat4.rotateZ(this._transform, .5 * Math.PI)
    },
    updateProjectionMatrix: function () {
        this._projMatrix = mat4.perspective(this._fovY, this._width / this._height, this._near, this._far)
    },
    set3dMode: function () {
        this._mode = WS.PerspectiveCamera.Mode._3D
    },
    setPanoMode: function () {
        this._mode = WS.PerspectiveCamera.Mode.PANO
    },
    isIn3dMode: function () {
        return this._mode === WS.PerspectiveCamera.Mode._3D
    },
    isInPanoMode: function () {
        return this._mode === WS.PerspectiveCamera.Mode.PANO
    },
    createCameraObject: function (e) {
        return new WS.PerspectiveCameraObject(this.getGlobalTrafo(e), this._width / this._height, this._fovY)
    },
    setFOVY: function (e) {
        this.changeFOVY(e - this._fovY, 0)
    },
    changeFOVY: function (e, t) {
        if (this._fovY <= 45 && t > 0) {
            var i;
            i = 1 === t ? .25 : 2 === t ? .1 : 0;
            var n = Math.sin(this._fovY * (Math.PI / 180)),
                r = 1 / Math.sqrt(2),
                o = Math.min(1, i + n / r);
            e *= o
        }
        this._fovY = Math.min(WS.PerspectiveCamera.MaxFov, Math.max(WS.PerspectiveCamera.MinFov, this._fovY + e)), this.updateCameraMatrix()
    },
    getFOVX: function () {
        var e = this._fovY * Math.PI / 180,
            t = 2 * Math.atan(Math.tan(.5 * e) * this._width / this._height);
        return 180 * t / Math.PI
    },
    calcFrustum: function (e, t) {
        var i = this;
        t && (i = new WS.PerspectiveCamera, i.copyFrom(this), i.setNearAndFarPlane(void 0, t));
        var n, r = [];
        n = e ? mat4.multiply(i._camMatrix, e, mat4.create()) : i._camMatrix, r[0] = [vec3.createFrom(n[0] + n[3], n[4] + n[7], n[8] + n[11]), n[12] + n[15]], r[1] = [vec3.createFrom(-n[0] + n[3], -n[4] + n[7], -n[8] + n[11]), -n[12] + n[15]], r[2] = [vec3.createFrom(n[1] + n[3], n[5] + n[7], n[9] + n[11]), n[13] + n[15]], r[3] = [vec3.createFrom(-n[1] + n[3], -n[5] + n[7], -n[9] + n[11]), -n[13] + n[15]], r[4] = [vec3.createFrom(n[2] + n[3], n[6] + n[7], n[10] + n[11]), n[14] + n[15]], r[5] = [vec3.createFrom(-n[2] + n[3], -n[6] + n[7], -n[10] + n[11]), -n[14] + n[15]];
        for (var o = 0; 6 > o; o++) {
            var a = r[o],
                s = a[0],
                c = 1 / vec3.length(s);
            a[0] = vec3.scale(s, c), a[1] *= c
        }
        return r
    },
    calcViewingDistance: function (e, t) {
        var i = this._fovY * Math.PI / 180,
            n = this.getFOVX() * Math.PI / 180,
            r = e / (2 * Math.tan(.5 * n)),
            o = t / (2 * Math.tan(.5 * i));
        return Math.max(r, o)
    },
    getAnglesForCenter: function () {
        return this.getAnglesForScreenCoordinates(this._width / 2, this._height / 2)
    },
    rotateVertically: function (e) {
        var t = this.getAnglesForCenter(),
            i = t[1] + e,
            n = .000174532925,
            r = Math.min(.5 * Math.PI - n, Math.max(Math.PI * -.5 + n, i));
        e -= i - r;
        var o = mat4.identity();
        mat4.rotateX(o, -e), mat4.multiply(o, this._transform, this._transform), this.updateCameraMatrix()
    },
    rotateHorizontally: function (e) {
		
        var t = mat4.identity(),
            i = [0, 0, 1, 0];
        mat4.multiplyVec4(this._transform, i, i), mat4.rotate(t, -e, i, t), mat4.multiply(t, this._transform, this._transform), this.updateCameraMatrix();
    
	},
    lookAt: function (e, t) {
        var i = this.getGlobalPos(t);
        i[0].toFixed(3) === e[0].toFixed(3) && i[1].toFixed(3) === e[1].toFixed(3) && (e[1] += .000174532925);
        var n = mat4.lookAt(i, e, [0, 0, 1], mat4.create()),
            r = mat4.inverse(n, mat4.create());
        this.setFromGlobalTrafo(r, t)
    },
    moveForward: function (e) {
        this.translate([0, 0, e])
    },
    moveSideways: function (e) {
        this.translate([-e, 0, 0])
    },
    moveVertical: function (e) {
        this.translate([0, e, 0])
    },
    setTheta: function (e) {
        var t = this.getAnglesForCenter(),
            i = e - t[1];
        0 !== i && this.rotateVertically(i)
    },
    getTheta: function () {
        var e = this.getAnglesForCenter();
        return e[1]
    },
    setPhi: function (e) {
        var t = this.getAnglesForCenter(),
            i = t[0] - e;
        0 !== i && this.rotateHorizontally(i)
    },
    getPhi: function () {
        var e = this.getAnglesForCenter();
        return e[0]
    },
    isLookingAtPole: function () {
        var e = this.getTheta(),
            t = .0174532925;
        return e < -Math.PI / 2 + t ? -1 : Math.PI / 2 - t < e ? 1 : 0
    }
}, WS.extend("PerspectiveCamera", "Camera"), WS.PerspectiveCamera.DefaultFov = 65, WS.PerspectiveCamera.MinFov = 2, WS.PerspectiveCamera.MaxFov = 140, WS.PerspectiveCamera.FrustumBoxIntersection = {
    OUTSIDE: -1,
    INTERSECT: 0,
    INSIDE: 1
}, WS.PerspectiveCamera.Mode = {
    _3D: 0,
    PANO: 1
}, WS.CameraAnimator = function () {
    this._camera = void 0, this._duration = void 0, this._endTime = void 0, this._targetPos = void 0, this._targetPhi = void 0, this._targetTheta = void 0, this._targetFov = void 0, this._viewTrafo = void 0, this._diffPos = void 0, this._diffPhi = void 0, this._diffTheta = void 0, this._diffFov = void 0
}, WS.CameraAnimator.prototype = {
    reset: function () {
        this._camera = void 0, this._duration = void 0, this._endTime = void 0, this._targetPos = void 0, this._targetPhi = void 0, this._targetTheta = void 0, this._targetFov = void 0, this._viewTrafo = void 0, this._diffPos = void 0, this._diffPhi = void 0, this._diffTheta = void 0, this._diffFov = void 0
    },
    isAnimating: function () {
        return void 0 !== this._camera
    },
    getNowMillis: function () {
        return Date.now()
    },
    startAnimation: function (e, t, i, n, r, o, a) {
        this.isAnimating() && this.reset(), this._camera = e, this._duration = t, this._viewTrafo = i, this._targetPos = n, this._targetPhi = r, this._targetTheta = o, this._targetFov = a, this._endTime = this.getNowMillis() + t, this._diffPos = n ? vec3.subtract(n, e.getGlobalPos(i), vec3.create()) : void 0, this._diffPhi = this.calcPhiDiff(e.getPhi(), r), this._diffTheta = this.calcThetaDiff(e.getTheta(), o), this._diffFov = this.calcFovDiff(e._fovY, a)
    },
    calcPhiDiff: function (e, t) {
        return void 0 !== t ? F.wrapTo_MinusPI_PI(t - e) : void 0
    },
    calcThetaDiff: function (e, t) {
        return void 0 !== t ? F.wrapTo_MinusPI_PI(t - e) : void 0
    },
    calcFovDiff: function (e, t) {
        return void 0 !== t ? (t = Math.min(WS.PerspectiveCamera.MaxFov, Math.max(WS.PerspectiveCamera.MinFov, t)), t - e) : void 0
    },
    animate: function () {
        if (this.isAnimating()) {
            var e = Math.max(0, this._endTime - this.getNowMillis()),
                t = e / this._duration;
            if (void 0 !== this._targetPos) {
                var i = this._targetPos[0] - t * this._diffPos[0],
                    n = this._targetPos[1] - t * this._diffPos[1],
                    r = this._targetPos[2] - t * this._diffPos[2];
                this._camera.setFromGlobalPos([i, n, r], this._viewTrafo)
            }
            if (void 0 !== this._targetPhi) {
                var o = this._targetPhi - t * this._diffPhi;
                this._camera.setPhi(o)
            }
            if (void 0 !== this._targetTheta) {
                var a = this._targetTheta - t * this._diffTheta;
                this._camera.setTheta(a)
            }
            if (void 0 !== this._targetFov) {
                var s = this._targetFov - t * this._diffFov;
                this._camera.setFOVY(s)
            }
            var c = 0 === e;
            return c && this.reset(), c
        }
    },
    calcGoodDuration: function (e, t, i, n, r, o, a, s) {
        var c = 0;
        if (void 0 !== e && void 0 !== t && !F.closeToArray(e, t, .00999)) {
            var l = vec3.dist(t, e),
                h = 1 / Math.pow(50, 1 / 3) * 1e3;
            c = Math.min(2e3, Math.pow(l, 1 / 3) * h)
        }
        var d = 0,
            u = 0,
            _ = 0,
            p = .00174532925;
        if (void 0 === i || void 0 === n || F.closeTo(i, n, p) || (u = Math.abs(this.calcPhiDiff(i, n))), void 0 === r || void 0 === o || F.closeTo(r, o, p) || (_ = Math.abs(this.calcThetaDiff(r, o))), 0 !== u || 0 !== _) {
            var g = u + _,
                f = g / (2 * Math.PI),
                m = Math.pow(f, .75);
            d = 2e3 * m
        }
        var v = 0;
        if (void 0 !== a && void 0 !== s && !F.closeTo(a, s, .0999)) {
            var S = Math.abs(this.calcFovDiff(a, s));
            v = 1500 * S / (WS.PerspectiveCamera.MaxFov - WS.PerspectiveCamera.MinFov)
        }
        return Math.max(c, d, v)
    }
}, WS.extend("CameraAnimator"), WS.Scene = function () {
}, WS.Scene.prototype = {
    add: function (e, t) {
        e && (t ? t.addChild(e) : this.addChild(e))
    },
    remove: function (e, t) {
        var i, n, r, o;
        if (e.getRootNode() === this && (i = e._parent, i.removeChild(e), t))
            for (r = e._children.length, n = 0; e._children.length > 0 && r > n;) n++, o = e._children[0], i.addChild(o);
        this.removeChild(e)
    },
    removeAll: function () {
        for (var e = this._children.slice(), t = 0, i = e.length; i > t; t++) this.remove(e[t])
    }
}, WS.extend("Scene", "SceneNode"), WS.PickPointHandler = function (e, t) {
    WS.BaseHandler.call(this, e, t)
}, WS.PickPointHandler.prototype = {
    onClick: function (e, t, i, n) {
        if (i !== WS.MouseAdapter.Button.Left) return !this._view.instanceOf(WS.MapLeaflet);
        var r = this.pickPoint(e, t, n ? 7 : 5);
        return r ? (this.informListener("onPickPoint", r), this._view.instanceOf(WS.MapLeaflet) ? !1 : !!r) : !1
    },
    onDblClick: function () {
        return this._view.instanceOf(WS.MapLeaflet) ? !1 : !0
    }
}, WS.extend("PickPointHandler", "BaseHandler"), WS.PickPointsHandler = function (e, t) {
    WS.PickPointHandler.call(this, e, t)
}, WS.PickPointsHandler.prototype = {
    onClick: function (e, t, i, n) {
        if (i !== WS.MouseAdapter.Button.Left) return !this._view.instanceOf(WS.MapLeaflet);
        var r = this.pickPoint(e, t, n ? 7 : 5);
        return r ? (this.informListener("onPickPoint", r), this._view.instanceOf(WS.MapLeaflet) ? !1 : !0) : !1
    }
}, WS.extend("PickPointsHandler", "PickPointHandler"), WS.MeasurementLabelRenderable = function (e) {
    WS.AnnotationRenderable.call(this, e)
}, WS.MeasurementLabelRenderable.prototype = {
    setProperties: function (e, t, i) {
        this.setTranslation(t), this.setText(e, !0), this._hasMapType || (this.setCustomTextColor(i), this.setTextColor(i, !0)), this.updateImage()
    },
	renderToCanvas: function() {
   this._canvas || (this._canvas = document.createElement("canvas"));
   var e = this._canvas.getContext("2d"),
    t = this._textHeight + "px Arial";
   e.font = t;
   for (var i = (this._text || "").split("\n"), n = i.length, r = this._minBorderWidth, o = 0; n > o; o++) {
    var a = e.measureText(i[o]).width;
    a > r && (r = a)
   }
   var s = r + this._borderAddWidth;
   this._icon && (s += WS.LabelRenderable.ICON_WIDTH);
   var c, l, h = n * this._textHeight + (n - 1) * this._lineBreakHeight + this._borderAddHeight,
    d = this._shadowOffsetX + this._shadowBlur,
    u = this._shadowOffsetY + this._shadowBlur,
    _ = Math.max(0, -this._tailOffsetX),
    p = Math.max(0, -h - this._tailOffsetY),
    g = _ + s,
    f = p + h,
    m = .5 * (_ + g),
    v = .5 * (p + f),
    S = vec2.createFrom(_, p),
    b = vec2.createFrom(m, p),
    y = vec2.createFrom(g, p),
    P = vec2.createFrom(g, v),
    M = vec2.createFrom(g, f),
    w = vec2.createFrom(m, f),
    C = vec2.createFrom(_, f),
    T = vec2.createFrom(_, v),
    W = vec2.createFrom(Math.max(0, this._tailOffsetX), f + this._tailOffsetY),
    I = 0;
   if (e.canvas.width = Math.max(g + d, W[0]) - Math.min(_, W[0]), e.canvas.height = Math.max(f + u, W[1]) - Math.min(p, W[1]), _ <= W[0] && W[0] <= g && p <= W[1] && W[1] <= f) I = 6;
   else if (W[0] <= m) {
    var L = Math.atan2(f - W[1], _),
     R = Math.atan2(p - W[1], _); - .523598776 >= L ? (c = vec2.createFrom(_ + this._tailXGapToEdge + this._tailWidthX, f), l = vec2.createFrom(_ + this._tailXGapToEdge, f)) : R >= .523598776 ? (I = 2, c = vec2.createFrom(_ + this._tailXGapToEdge, p), l = vec2.createFrom(_ + this._tailXGapToEdge + this._tailWidthX, p)) : (I = 1, c = vec2.createFrom(_, f - this._tailYGapToEdge), l = vec2.createFrom(_, f - this._tailYGapToEdge - this._tailWidthY))
   } else {
    var F = g - W[0],
     O = f - W[1],
     D = p - W[1],
     A = Math.atan2(O, F),
     E = Math.atan2(D, F);
    0 > O && A >= -2.61799388 ? (I = 5, c = vec2.createFrom(g - this._tailXGapToEdge, f), l = vec2.createFrom(g - this._tailXGapToEdge - this._tailWidthX, f)) : D >= 0 && 2.61799388 >= E ? (I = 3, c = vec2.createFrom(g - this._tailXGapToEdge - this._tailWidthX, p), l = vec2.createFrom(g - this._tailXGapToEdge, p)) : (I = 4, c = vec2.createFrom(g, f - this._tailYGapToEdge), l = vec2.createFrom(g, f - this._tailYGapToEdge - this._tailWidthY))
   }
   e.clearRect(0, 0, e.canvas.width, e.canvas.height);
   var x = 5;
   e.fillStyle = WS.Renderer2D.colorToStyle(this._backgroundColor), e.beginPath(), e.moveTo(b[0], b[1]), 3 === I && (e.lineTo(c[0], c[1]), e.lineTo(W[0], W[1]), e.lineTo(l[0], l[1])), e.arcTo(y[0], y[1], y[0], y[1] + x, x), 4 === I ? (e.lineTo(c[0], c[1]), e.lineTo(W[0], W[1]), e.lineTo(l[0], l[1])) : e.lineTo(P[0], P[1]), e.arcTo(M[0], M[1], M[0] - x, M[1], x), 5 === I && (e.lineTo(c[0], c[1]), e.lineTo(W[0], W[1]), e.lineTo(l[0], l[1])), e.lineTo(w[0], w[1]), 0 === I && (e.lineTo(c[0], c[1]), e.lineTo(W[0], W[1]), e.lineTo(l[0], l[1])), e.arcTo(C[0], C[1], C[0], C[1] - x, x), 1 === I ? (e.lineTo(c[0], c[1]), e.lineTo(W[0], W[1]), e.lineTo(l[0], l[1])) : e.lineTo(T[0], T[1]), e.arcTo(S[0], S[1], S[0] + x, S[1], x), 2 === I && (e.lineTo(c[0], c[1]), e.lineTo(W[0], W[1]), e.lineTo(l[0], l[1])), e.closePath(), this.drawShadow(e), e.font = t, e.fillStyle = WS.Renderer2D.colorToStyle(this._textColor);
   var k = _ + .5 * this._borderAddWidth,
    U = p + .5 * this._borderAddHeight + this._textHeight - 1;
   for (o = 0; n > o; ++o) e.fillText(i[o], k, U), U += this._textHeight + this._lineBreakHeight;
   this._icon && this._icon.draw(e, y[0] - 24, y[1], WS.LabelRenderable.ICON_WIDTH, WS.LabelRenderable.ICON_HEIGHT);
   var N = Math.max(W[0] - _, 0),
    j = Math.max(f + u - W[1], 0);
   this._geometry.setPosition(N, j, e.canvas.width, e.canvas.height)
  }
	
}, WS.extend("MeasurementLabelRenderable", "AnnotationRenderable"), WS.PolylineMixin = {
    setViewScanUuids: function (e) {
        if (e) {
            var t = this;
            t._viewScanUuids = {}, e.forEach(function (e) {
                t._viewScanUuids[e] = !0
            })
        } else this._viewScanUuids = void 0
    },
    updateSegmentLines: function () {
        var e = [],
            t = [],
            i = [],
            n = this._pointsLocal.length;
        if (1 === n) {
            var r = this.getColorForState(this._pointStates ? this._pointStates[0] : 0);
            t.push.apply(t, r), e.push.apply(e, this.getPointInView(0))
        } else
            for (var o = n - 1, a = 0; o > a; ++a) {
                e.push.apply(e, this.getPointInView(a)), e.push.apply(e, this.getPointInView(a + 1));
                var s = this.getColorForState(this._pointStates ? this._pointStates[a] : 0);
                t.push.apply(t, s);
                var c = this.getColorForState(this._pointStates ? this._pointStates[a + 1] : 0);
                t.push.apply(t, c);
                var l = this.isSegmentInOtherScan(a),
                    h = this.getColorForState(this._segmentStates ? this._segmentStates[a] : 0, l);
                i.push.apply(i, h), i.push.apply(i, h)
            }
        this._segmentLines.setColorLines(i), this._segmentLines.setColorPointsLarge(t), this._segmentLines.setPoints(e), this._segmentLinesSelected.setPoints(e), this._segmentLinesHighlighted.setPoints(e)
    },
    updateIconMixin: function (e) {
        if (this._categoryLabel) {
            var t = this._dataObject ? this._dataObject._category : void 0;
            if (t) {
                var i = WS.ColorGenerator.intColorFromString(t),
                    n = WS.ColorGenerator.rgbColorFromInt(i);
                this._categoryLabel.setCategoryColor(n)
            } else this._categoryLabel.setCategoryColor(void 0);
            this._categoryLabel.onIconModeChange(e)
        }
    },
    isPointInOtherScan: function (e) {
        return !(!this._pointScans || !this._viewScanUuids || this._viewScanUuids[this._pointScans[e]])
    },
    isSegmentInOtherScan: function (e) {
        return !(!this._pointScans || !this._viewScanUuids || this._viewScanUuids[this._pointScans[e]] && this._viewScanUuids[this._pointScans[e + 1]])
    },
    updateDashLength: function () {
        var e = 1 / this._unit.getExactLength(1);
        this._segmentLines.setDashLength(e), this._segmentLinesSelected.setDashLength(e), this._segmentLinesHighlighted.setDashLength(e), this._axis && this._axis.setDashLength(this._segmentLines.getCurrentDashLength())
    },
    getPickInfoMixin: function (e, t, i, n) {
        var r;
        if (this._pointIcons && (r = this.getPickInfoOfMemberRenderable(e, t, this._pointIcons, i, n)), void 0 === r) {
            var o = this.getVisibleMemberRenderables();
            r = this.getPickInfoOfMemberRenderable(e, t, o, i, n)
        }
        return void 0 !== r && r.add(this), r
    },
    getRegionPickInfoMixin: function (e, t, i) {
        var n = this._segmentLines.getRegionPickInfo(e, t, i);
        return n && n.add(this), n
    }
}, WS.defineMixin("PolylineMixin"), WS.PolylineMixin.ColorSelected = new WS.ArrayBuffer([.47, .804, .95, 1], 4), WS.PolylineMixin.ColorHighlighted = new WS.ArrayBuffer([.98, .875, .08, 1], 4), WS.PolylineMixin.ColorPtsSmall = new WS.ArrayBuffer([0, 0, 0, 1], 4), WS.MeasurementRenderable = function (e, t, i, n, r, o, a) {
    this._unit = i, this._locale = n, this._viewScanUuids = void 0, this.setViewScanUuids(o), this._trafoToRefsystem = t, this._trafoView = a, this._temporary = e.instanceOf(WS.TempMeasurement), this._type = e._type, this._distance = e._distance, this._distances = e._distances, this._pointsGlobal = e._pointsGlobal, this._pointsLocal = e._pointsLocal, this._pointScans = e._pointScans, this._pointStates = e._pointStates, this._segmentStates = e._segmentStates, this._distanceStartEnd = e._distanceStartEnd, this._distanceHorizontalGlobal = e._distanceHorizontalGlobal, this._distanceVerticalGlobal = e._distanceVerticalGlobal, this._distanceXGlobal = e._distanceXGlobal, this._distanceYGlobal = e._distanceYGlobal, this._trafoCustomOfProj = e._trafoCustomOfProj, this._pointsCustom = e._pointsCustom, this._distXCustom = e._distXCustom, this._distYCustom = e._distYCustom, this._distZCustom = e._distZCustom, this._distHCustom = e._distHCustom, this._useCustomTrafo = void 0, this.updateUseCustomTrafo(), this._mode = WS.MeasurementRenderable.MODE_SEGMENT;
    var s = this;
    r.get().then(function (e) {
        switch (e._distState) {
            case "axis":
                s._mode = WS.MeasurementRenderable.MODE_AXIS;
                break;
            case "angle":
                s._mode = WS.MeasurementRenderable.MODE_ANGLE;
                break;
            default:
                s._mode = WS.MeasurementRenderable.MODE_SEGMENT
        }
    }).done(), this._objectUUIDs = e._objectUUIDs, this._objectClasses = e._objectClasses, this._labelsModeSegment = [], this._labelsModeAxis = new Array(new WS.MeasurementLabelRenderable(this._type === WS.Measurement.Type.Map), new WS.MeasurementLabelRenderable(this._type === WS.Measurement.Type.Map), new WS.MeasurementLabelRenderable(this._type === WS.Measurement.Type.Map));
    var c = 1 / i.getExactLength(1);
    this._segmentLines = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), WS.PolylineMixin.ColorPtsSmall, new WS.ArrayBuffer([], 4), new WS.ArrayBuffer([], 4), WS.LineMaterial.Dash.Adaptive, void 0, void 0, void 0, c), this._segmentLinesSelected = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), WS.PolylineMixin.ColorPtsSmall, WS.PolylineMixin.ColorSelected, WS.PolylineMixin.ColorSelected, WS.LineMaterial.Dash.Adaptive, 6, 8, void 0, c), this._segmentLinesHighlighted = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), WS.PolylineMixin.ColorPtsSmall, WS.PolylineMixin.ColorHighlighted, WS.PolylineMixin.ColorHighlighted, WS.LineMaterial.Dash.Adaptive, 6, 8, void 0, c), this._segmentLinesSelected.enableDepthTest(!1), this._segmentLinesHighlighted.enableDepthTest(!1), this._axis = new WS.LinesRenderable(new WS.ArrayBuffer([], 3), WS.MeasurementRenderable.ColorAxis, WS.LineMaterial.Dash.Fixed, void 0, c), this._categoryLabel = void 0, this._pointIcons = [], this._objectIcons = [], this._multiPointsBuffer = new WS.ArrayBuffer([], 3), this._multiPointsPoint = new WS.PointRenderable(this._multiPointsBuffer, new WS.ArrayBuffer([0, 0, 0, 0], 4), 10)
}, WS.MeasurementRenderable.prototype = {
    updateUseCustomTrafo: function () {
        this._useCustomTrafo = void 0 !== this._trafoCustomOfProj && this._unit.isCustomCS()
    },
    getPointInView: function (e) {
        return mat4.multiplyVec3(this._trafoToRefsystem, this._pointsLocal[e], vec3.create())
    },
    getAxisPointInView: function () {
        var e, t, i = this._type === WS.Measurement.Type.Map;
        if (this._useCustomTrafo) {
            e = this._pointsCustom[0], t = this._pointsCustom[this._pointsCustom.length - 1];
            var n = i ? [t[0], e[1], e[2]] : [t[0], t[1], e[2]],
                r = mat4.multiplyVec3(this._trafoCustomOfProj, n, vec3.create());
            return mat4.posInRefSystem(r, this._trafoView)
        }
        return e = this.getPointInView(0), t = this.getPointInView(this._pointsLocal.length - 1), i ? [t[0], e[1], e[2]] : [t[0], t[1], e[2]]
    },
    getImagePathForObjectClass: function (e) {
        switch (e) {
            case WS.Measurement.ObjectClasses.Scan:
            case WS.Measurement.ObjectClasses.PointCloud:
                return WS.MeasurementRenderable.ObjectClassImagePaths.Scan;
            case WS.Measurement.ObjectClasses.Sphere:
                return WS.MeasurementRenderable.ObjectClassImagePaths.Sphere;
            case WS.Measurement.ObjectClasses.Plane:
            case WS.Measurement.ObjectClasses.PlanEx:
            case WS.Measurement.ObjectClasses.Rectangle:
                return WS.MeasurementRenderable.ObjectClassImagePaths.Plane;
            case WS.Measurement.ObjectClasses.Slab:
                return WS.MeasurementRenderable.ObjectClassImagePaths.Slab;
            case WS.Measurement.ObjectClasses.Pipe:
                return WS.MeasurementRenderable.ObjectClassImagePaths.Pipe;
            default:
                return WS.MeasurementRenderable.ObjectClassImagePaths.Point
        }
    },
    setSegmentMode: function (e) {
        this._mode = e
    },
    switchSegmentMode: function () {
        this.setSegmentMode(this._mode === WS.MeasurementRenderable.MODE_SEGMENT ? WS.MeasurementRenderable.MODE_AXIS : WS.MeasurementRenderable.MODE_SEGMENT)
    },
    setViewingModeOfLabels: function () {
        for (var e = this._viewingMode, t = 0, i = this._labelsModeAxis.length; i > t; t++) this._labelsModeAxis[t] && this._labelsModeAxis[t].setViewingMode(e);
        for (var n = 0, r = this._labelsModeSegment.length; r > n; n++) this._labelsModeSegment[n] && this._labelsModeSegment[n].setViewingMode(e)
    },
    onViewingModeChange: function () {
        switch (this._viewingMode) {
            case WS.Renderable.ViewingMode.Selected:
            case WS.Renderable.ViewingMode.Highlighted:
                this._segmentLines.setTransparency(1), this._axis._material._depthTest = !1;
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
                this._segmentLines.setTransparency(WS.LabelRenderable.TRANSPARENCY_INCONSIDERABLE), this._axis._material._depthTest = !0;
                break;
            case WS.Renderable.ViewingMode.Normal:
                this._segmentLines.setTransparency(this._occluded ? WS.LabelRenderable.TRANSPARENCY_OCCLUDED : 1), this._axis._material._depthTest = !0
        }
        this.setViewingModeOfLabels()
    },
    areSegmentsValid: function () {
        if (!this._segmentStates) return !0;
        for (var e = this._segmentStates.length, t = 0; e > t; t++)
            if (0 !== this._segmentStates[t]) return !1;
        return !0
    },
    isPointValid: function (e) {
        return !this._pointStates || e < this._pointStates.length && 0 === this._pointStates[e]
    },
    isStartEndValid: function () {
        return !this._pointStates || this.isPointValid(0) && this.isPointValid(this._pointStates.length - 1)
    },
    updateObjectIcons: function () {
        var e, t, i, n, r, o;
        if (this._objectIcons = [], this._type === WS.Measurement.Type.Object && this._objectClasses)
            for (var a = 0, s = this._objectClasses.length; s > a; a++) t = this.getImagePathForObjectClass(this._objectClasses[a]), t && t.length > 0 && (e = this.getPointInView(a), i = new WS.Image(t), n = new WS.CenteredQuadGeometry, r = new WS.SpriteMaterial(i, vec2.create([32, 32]), !1, WS.Image.Filter.Nearest), o = new WS.SpriteRenderable(n, r), o.setTranslation(e), this._objectIcons[a] = o)
    },
    updatePointIcons: function () {
        var e, t, i;
        if (this._pointIcons = [], this._type === WS.Measurement.Type.MultiScanPoint) {
            i = new WS.SpriteMaterial(WS.MeasurementRenderable.RemoteScanPtImage, vec2.create([20, 20]), !1), t = new WS.DynamicQuadGeometry, t.setPosition(14, 14, 20, 20);
            for (var n = [], r = [], o = 0, a = this._pointsLocal.length; a > o; o++)
                if (this.isPointInOtherScan(o)) {
                    e = this.getPointInView(o);
                    var s = new WS.ClickableSpriteRenderable(t, i, WS.ClickableSpriteRenderable.Type.MEASUREMENT_POINT, this._dataObject, o);
                    s.setTranslation(e), this._pointIcons.push(s);
                    var c = this.getColorForState(this._pointStates ? this._pointStates[o] : 0);
                    r.push.apply(r, c), n.push(e[0], e[1], e[2])
                }
            this._multiPointsBuffer.setBufferData(n), this._multiPointsPoint.setColors(r)
        }
    },
    updateAxis: function () {
        var e = this.getPointInView(0),
            t = this.getPointInView(this._pointsLocal.length - 1),
            i = this.getAxisPointInView(),
            n = [];
        n.push.apply(n, e), n.push.apply(n, i), n.push.apply(n, i), n.push.apply(n, t), n.push.apply(n, t), n.push.apply(n, e), this._axis.setEndPointPositions(n)
    },
    updateSegmentLabels: function () {
        var e, t, i = this._pointsLocal.length - 1,
            n = i >= 2 ? i + 1 : 1;
        this._labelsModeSegment.slice(0, n);
        for (var r = 0; i > r; r++) {
            var o = WS.MeasurementRenderable.SegmentLabelConfForState[this._segmentStates ? this._segmentStates[r] : 0];
            if (o._show) {
                var a = vec3.create();
                vec3.lerp(this.getPointInView(r), this.getPointInView(r + 1), .5, a), e = o._valid ? this._unit.getLengthAndUnit(this._distances[r], 3) : this._locale.translate("FE_INVALID"), t = o._valid ? WS.MeasurementRenderable.ColorValid : WS.MeasurementRenderable.ColorInvalid, this._labelsModeSegment[r] || (this._labelsModeSegment[r] = new WS.MeasurementLabelRenderable(this._type === WS.Measurement.Type.Map)), this._labelsModeSegment[r].setProperties(e, a, t), this._labelsModeSegment[r].setOcclusion(this.isSegmentInOtherScan(r))
            } else this._labelsModeSegment[r] = void 0
        }
        if (n >= 2) {
            var s = this.areSegmentsValid();
            e = " = " + (s ? this._unit.getLengthAndUnit(this._distance, 3) : this._locale.translate("FE_INVALID")), t = s ? WS.MeasurementRenderable.ColorValid : WS.MeasurementRenderable.ColorInvalid, this._labelsModeSegment[n - 1] || (this._labelsModeSegment[n - 1] = new WS.MeasurementLabelRenderable(this._type === WS.Measurement.Type.Map)), this._labelsModeSegment[n - 1].setProperties(e, this.getPointInView(this._pointsLocal.length - 1), t)
        }
    },
    updateCategoryLabel: function () {
        var e = this._pointsLocal.length - 1,
            t = e >= 2 ? e + 1 : 1;
        this._categoryLabel = this._labelsModeSegment[t - 1], this._categoryLabel.setDataObject(this._dataObject)
    },
    updateAxisLabels: function () {
        this._type === WS.Measurement.Type.Map ? this.updateAxisLabelsMap() : this.updateAxisLabelsScan()
    },
    updateAxisLabelsScan: function () {
        var e, t, i, n = this.isStartEndValid(),
            r = n ? WS.MeasurementRenderable.ColorValid : WS.MeasurementRenderable.ColorInvalid,
            o = this.getPointInView(0),
            a = this.getPointInView(this._pointsLocal.length - 1),
            s = this.getAxisPointInView();
        if (e = vec3.create(), vec3.lerp(a, s, .5, e), t = n ? this._unit.getLengthAndUnit(this._useCustomTrafo ? this._distZCustom : this._distanceVerticalGlobal, 3) : this._locale.translate("FE_INVALID"), i = this._locale.translateAndCompose("FE_MEASUREMENT_AXIS", [t]), this._labelsModeAxis[0].setProperties(i, e, r), e = vec3.create(), vec3.lerp(o, s, .5, e), n) i = this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_TOTAL", [this._unit.getLengthAndUnit(this._useCustomTrafo ? this._distHCustom : this._distanceHorizontalGlobal, 3), this._unit.getLengthAndUnit(this._useCustomTrafo ? this._distXCustom : this._distanceXGlobal, 3), this._unit.getLengthAndUnit(this._useCustomTrafo ? this._distYCustom : this._distanceYGlobal, 3)]);
        else {
            var c = this._locale.translate("FE_INVALID");
            i = this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_TOTAL", [c, c, c])
        }
        this._labelsModeAxis[1].setProperties(i, e, r), e = vec3.create(), vec3.lerp(a, o, .5, e), t = n ? this._unit.getLengthAndUnit(this._distanceStartEnd, 3) : this._locale.translate("FE_INVALID"), i = this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_STARTEND", [t]), this._labelsModeAxis[2].setProperties(i, e, r)
    },
    updateAxisLabelsMap: function () {
        var e, t, i, n = WS.MeasurementRenderable.ColorValid,
            r = this.getPointInView(0),
            o = this.getPointInView(this._pointsLocal.length - 1),
            a = this.getAxisPointInView();
        e = vec3.create(), vec3.lerp(r, a, .5, e), t = this._unit.getLengthAndUnit(this._useCustomTrafo ? this._distXCustom : this._distanceXGlobal, 3), i = this._locale.translateAndCompose("FE_MEASUREMENT_ALONG_X", [t]), this._labelsModeAxis[0].setProperties(i, e, n), e = vec3.create(), vec3.lerp(o, a, .67, e), t = this._unit.getLengthAndUnit(this._useCustomTrafo ? this._distYCustom : this._distanceYGlobal, 3), i = this._locale.translateAndCompose("FE_MEASUREMENT_ALONG_Y", [t]), this._labelsModeAxis[1].setProperties(i, e, n), e = vec3.create(), vec3.lerp(o, r, .33, e), t = this._unit.getLengthAndUnit(this._distanceStartEnd, 3), i = this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_STARTEND", [t]), this._labelsModeAxis[2].setProperties(i, e, n)
    },
    setIconMode: function (e, t) {
        this._categoryLabel && this._categoryLabel.setIconMode(e, t)
    },
    updateAppearance: function () {
        this.updateUseCustomTrafo(), this.updateSegmentLines(), this.updateAxis(), this.updateSegmentLabels(), this.updateAxisLabels(), this.updateObjectIcons(), this.updatePointIcons(), this.updateCategoryLabel(), this.updateIcon(), this.updateDashLength(), this.addToLayer(WS.Layer.LayerIDs.MEASUREMENTS, !0)
    },
    updateMSMPoints: function () {
        this.updateSegmentLines(), this.updatePointIcons(), this.addToLayer(WS.Layer.LayerIDs.MEASUREMENTS, !0)
    },
    updateUnit: function () {
        this.updateUseCustomTrafo(), this.updateSegmentLabels(), this.updateAxis(), this.updateAxisLabels()
    },
    updateLanguage: function () {
        this.updateAxisLabels()
    },
    getVisibleMemberRenderables: function () {
        var e = [];
        return e.push(this._viewingMode === WS.Renderable.ViewingMode.Highlighted ? this._segmentLinesHighlighted : this._viewingMode === WS.Renderable.ViewingMode.Selected ? this._segmentLinesSelected : this._segmentLines), this._type === WS.Measurement.Type.MultiScanPoint && e.push(this._multiPointsPoint), e.push.apply(e, this._objectIcons), e.push.apply(e, this._pointIcons), this._mode === WS.MeasurementRenderable.MODE_SEGMENT ? this._labelsModeSegment.forEach(function (t) {
            void 0 !== t && e.push(t)
        }) : this._mode === WS.MeasurementRenderable.MODE_AXIS && (e.push(this._axis), e.push.apply(e, this._labelsModeAxis)), e
    },
    getMemberRenderables: function () {
        var e = [];
        return e.push(this._segmentLinesHighlighted), e.push(this._segmentLinesSelected), e.push(this._segmentLines), e.push(this._multiPointsPoint), e.push.apply(e, this._objectIcons), e.push.apply(e, this._pointIcons), this._labelsModeSegment.forEach(function (t) {
            void 0 !== t && e.push(t)
        }), e.push(this._axis), e.push.apply(e, this._labelsModeAxis), e
    },
    draw3d: function (e, t) {
       t(this) && this.drawMemberRenderables3d(e, t, !1)
    },
    draw2d: function (e, t) {
        this.drawMemberRenderables2d(e, t, !1)
    },
    getColorForState: function (e, t) {
        var i = t ? 1 : 0;
        return this._temporary ? WS.MeasurementRenderable.ColorForStateTemp[i][e] : WS.MeasurementRenderable.ColorForState[i][e]
    },
    updateIcon: function (e) {
        this.updateIconMixin(e)
    },
    getPickInfo: function (e, t, i, n) {
        return this.getPickInfoMixin(e, t, i, n)
    },
    getRegionPickInfo: function (e, t, i) {
        return this.getRegionPickInfoMixin(e, t, i)
    }
}, WS.extend("MeasurementRenderable", "Renderable"), WS.mixin("MeasurementRenderable", "PolylineMixin"), WS.MeasurementRenderable.ColorForState = {
    0: {
        0: [1, 1, 0, 1],
        1: [1, 0, 0, 1],
        2: [1, .7, .078, 1]
    },
    1: {
        0: [.5, .5, 0, 1],
        1: [.5, 0, 0, 1],
        2: [.5, .35, .04, 1]
    }
}, WS.MeasurementRenderable.ColorForStateTemp = {
    0: {
        0: [1, .7, .078, 1],
        1: [1, 0, 0, 1],
        2: [1, .7, .078, 1]
    },
    1: {
        0: [.5, .35, .04, 1],
        1: [.5, 0, 0, 1],
        2: [.5, .35, .04, 1]
    }
}, WS.MeasurementRenderable.SegmentLabelConfForState = {
    0: {
        _show: !0,
        _valid: !0
    },
    1: {
        _show: !0,
        _valid: !1
    },
    2: {
        _show: !1,
        _valid: !1
    }
}, WS.MeasurementRenderable.ColorAxis = new WS.ArrayBuffer([0, .6666, .9333, 1], 4), WS.MeasurementRenderable.ColorValid = [0, 0, 0, 1], WS.MeasurementRenderable.ColorInvalid = [1, 0, 0, 1], WS.MeasurementRenderable.MODE_AXIS = 1, WS.MeasurementRenderable.MODE_SEGMENT = 2, WS.MeasurementRenderable.MODE_ANGLE = 3, WS.MeasurementRenderable.ObjectClassImagePaths = {
    Plane: WS.imgUrlCanvasSafe("obj_picto_plane.png"),
    Pipe: WS.imgUrlCanvasSafe("obj_picto_cylinder.png"),
    Sphere: WS.imgUrlCanvasSafe("obj_picto_sphere.png"),
    Slab: WS.imgUrlCanvasSafe("obj_picto_slab.png"),
    Scan: WS.imgUrlCanvasSafe("obj_picto_scanner.png"),
    Point: WS.imgUrlCanvasSafe("obj_picto_point.png")
}, WS.MeasurementRenderable.RemoteScanPtImage = new WS.Image(WS.imgUrlCanvasSafe("icons/msm-icon.png"), WS.Image.Filter.Nearest), WS.BlendMaterial = function (e, t, i, n, r, o, a, s) {
    this._blendFactor = o, this._images = r, WS.ShaderMaterial.call(this, e, t, i, n, this._images, a, s)
}, WS.BlendMaterial.prototype = {
    setTextureImgUrls: function (e) {
        if (this._images.length === e.length) {
            for (var t = !0, i = 0; i < this._images.length; i++) this._images[i]._imageSrc !== e[i] && (t = !1);
            if (t) return
        }
        WS.ShaderMaterial.prototype.setTextureImgUrls.call(this, e)
    },
    setBlendFactor: function (e) {
        this._blendFactor = e
    }
}, WS.extend("BlendMaterial", "ShaderMaterial"), WS.PolygonRenderable = function (e, t) {
    var i = new WS.PolyCircuitGeometry(e),
        n = new WS.PolygonMaterial(t);
    WS.Mesh.call(this, i, n)
}, WS.PolygonRenderable.prototype = {
    setTransparency: function (e) {
        this._material._colorBuffer.setComponentOfAllItems(3, e)
    },
    setColor: function (e) {
        this._material._colorBuffer.setBufferData(vec4.create(e))
    },
    setPoints: function (e) {
        this._geometry._positionBuffer.setBufferData(e)
    },
    draw2d: function (e, t, i) {
        (i || t(this)) && (this._geometry.getCountPositions() < 3 || WS.Mesh.prototype.draw2d.call(this, e, t, !0))
    },
    draw3d: function (e, t, i) {
        (i || t(this)) && this._geometry.getCountPositions() < 3
    }
}, WS.extend("PolygonRenderable", "Mesh"), WS.PickAllHandler = function (e, t, i) {
    WS.PickObjectHandler.call(this, e, t, i), this._waitForDblClick = i.instanceOf(WS.PanoramaView) && i.isRootCloud()
}, WS.PickAllHandler.prototype = {
    onClick: function (e, t, i, n) {
        if (i !== WS.MouseAdapter.Button.Left) return !0;
        this._dblClickHappened = !1;
        var r, o = this.pickRenderableInfo(e, t);
        if (o) {
            var a = o._list;
            a.length > 0 && (r = a[a.length - 1])
        }
        if (r) this.informListener("onObjectClick", [r, e, t, o]);
        else {
            var s = Date.now(),
                c = this.pickPoint(e, t, n ? 7 : 5);
            if (c)
                if (this._waitForDblClick) {
                    var l = Math.max(0, Date.now() - s);
                    this._view._mouseAdapter.setPickDuration(l);
                    var h = this._view._mouseAdapter.getDblClickWaitTime(n),
                        d = h - l,
                        u = this;
                    setTimeout(function () {
                        u._dblClickHappened || u.informListener("onPickPoint", c)
                    }, d)
                } else this.informListener("onPickPoint", c)
        }
        return !0
    }
}, WS.extend("PickAllHandler", "PickObjectHandler"), WS.OrthoCamera = function (e, t, i, n, r, o, a, s) {
    WS.Camera.call(this, e, t, i, n), this._left = void 0 !== r ? r : 0, this._right = void 0 !== o ? o : 200, this._bottom = void 0 !== a ? a : 0, this._top = void 0 !== s ? s : 100, this.updateCameraMatrix()
}, WS.OrthoCamera.prototype = {
    copyFrom: function (e) {
        WS.Camera.prototype.copyFrom.call(this, e), e.instanceOf(WS.OrthoCamera) && (this._left = e._left, this._right = e._right, this._bottom = e._bottom, this._top = e._top), this.updateCameraMatrix()
    },
    setLeftRightBottomTop: function (e, t, i, n) {
        this._left = e, this._right = t, this._bottom = i, this._top = n, this.updateCameraMatrix()
    },
    updateProjectionMatrix: function () {
        this._projMatrix = mat4.ortho(this._left, this._right, this._bottom, this._top, this._near, this._far)
    },
    createCameraObject: function () {
        var e = vec3.create();
        return {
            calcDistToPoint: function () {
                return 0
            },
            getGlobalPosition: function () {
                return e
            }
        }
    }
}, WS.extend("OrthoCamera", "Camera"), WS.SetViewingModeVisitor = function (e) {
    this._selectedObject = e
}, WS.SetViewingModeVisitor.prototype = {
    visit: function (e) {
        if (!e.instanceOf(WS.Renderable)) return !0;
        if (this._selectedObject) {
            var t = this._selectedObject === e ? WS.Renderable.ViewingMode.Selected : WS.Renderable.ViewingMode.Inconsiderable;
            e.setViewingMode(t)
        } else e.setViewingMode(WS.Renderable.ViewingMode.Normal);
        return !0
    }
}, WS.extend("SetViewingModeVisitor", "VisitorBase"), WS.Box3dRenderable = function (e, t) {
    t = t || {}, this._alwaysHighlight = e, this._faceColors = t.faces || WS.Box3dRenderable.FACE_COLORS, this._wireframeColors = t.wireframe || WS.Box3dRenderable.WIREFRAME_COLORS;
    var i = e ? WS.Renderable.ViewingMode.Selected : WS.Renderable.ViewingMode.Normal;
    this._offsetZ = void 0, this._sizeX = void 0, this._sizeY = void 0, this._sizeZ = void 0, this._boxVertices = [];
    var n;
    for (n = 0; 8 > n; n++) this._boxVertices[n] = vec3.create();
    this._lines = new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(72), 3), this._wireframeColors[i]);
    var r = new WS.ColorMaterial(this._faceColors[i]),
        o = new WS.Geometry;
    o._positionBuffer = new WS.ArrayBuffer(new MatrixArray(24), 3), o._indexBuffer = WS.Box3dRenderable.FACE_INDEXBUFFER, o._primitiveType = WS.Geometry.PrimitiveType.Triangles, this._boxFaces = new WS.Mesh(o, r)
}, WS.Box3dRenderable.prototype = {
    valid: function () {
        return void 0 !== this._sizeX && void 0 !== this._sizeY && void 0 !== this._sizeZ && void 0 !== this._offsetZ
    },
    setSize: function (e, t, i, n, r) {
        this._sizeX = t, this._sizeY = i, this._sizeZ = n, this._offsetZ = r || 0, e || this.updateAppearance()
    },
    updateAppearance: function () {
        if (this.valid()) {
            var e = this._sizeX,
                t = this._sizeY,
                i = this._offsetZ,
                n = this._offsetZ + this._sizeZ,
                r = this._boxVertices;
            vec3.set([0, 0, i], r[0]), vec3.set([e, 0, i], r[1]), vec3.set([0, t, i], r[2]), vec3.set([e, t, i], r[3]), vec3.set([0, 0, n], r[4]), vec3.set([e, 0, n], r[5]), vec3.set([0, t, n], r[6]), vec3.set([e, t, n], r[7]);
            var o, a, s = this._lines._geometry._positionBuffer,
                c = WS.Box3dRenderable.WIREFRAME_INDICES;
            for (o = c.length - 1; o >= 0; o--) {
                var l = c[o];
                a = o > 0, s.setItem(o, r[l], a)
            }
            var h = this._boxFaces._geometry._positionBuffer;
            for (o = 7; o >= 0; o--) a = o > 0, h.setItem(o, r[o], a)
        }
    },
    getMemberRenderables: function () {
        return [this._lines, this._boxFaces]
    },
    getVisibleMemberRenderables: function () {
        return this.valid() ? this.getMemberRenderables() : []
    },
    draw3d: function (e, t, i) {
        (i || t(this)) && this.drawMemberRenderables3d(e, t, !1)
    },
    draw2d: function (e, t) {
        this.drawMemberRenderables2d(e, t, !1)
    },
    onViewingModeChange: function () {
        var e, t, i = this._alwaysHighlight ? WS.Renderable.ViewingMode.Selected : this._viewingMode;
        switch (i) {
            case WS.Renderable.ViewingMode.Selected:
            case WS.Renderable.ViewingMode.Highlighted:
                e = this._faceColors[WS.Renderable.ViewingMode.Selected], t = this._wireframeColors[WS.Renderable.ViewingMode.Selected];
                break;
            default:
                e = this._faceColors[WS.Renderable.ViewingMode.Normal], t = this._wireframeColors[WS.Renderable.ViewingMode.Normal]
        }
        this._boxFaces._material._colorBuffer = e, this._lines._material._colorBuffer = t
    }
}, WS.extend("Box3dRenderable", "Renderable"), WS.Box3dRenderable.FACE_COLORS = {}, WS.Box3dRenderable.FACE_COLORS[WS.Renderable.ViewingMode.Normal] = new WS.ArrayBuffer([.1, .52, .93, .05], 4), WS.Box3dRenderable.FACE_COLORS[WS.Renderable.ViewingMode.Selected] = new WS.ArrayBuffer([.1, .52, .93, .1], 4), WS.Box3dRenderable.WIREFRAME_COLORS = {}, WS.Box3dRenderable.WIREFRAME_COLORS[WS.Renderable.ViewingMode.Normal] = new WS.ArrayBuffer([0, 0, 0, .5], 4), WS.Box3dRenderable.WIREFRAME_COLORS[WS.Renderable.ViewingMode.Selected] = new WS.ArrayBuffer([0, 0, 0, 1], 4), WS.Box3dRenderable.WIREFRAME_INDICES = [0, 1, 1, 3, 3, 2, 2, 0, 4, 5, 5, 7, 7, 6, 6, 4, 0, 4, 1, 5, 2, 6, 3, 7], WS.Box3dRenderable.FACE_INDEXBUFFER = new WS.IndexBuffer([0, 1, 2, 1, 2, 3, 4, 5, 6, 5, 6, 7, 0, 1, 5, 0, 4, 5, 2, 3, 7, 2, 6, 7, 0, 2, 6, 0, 4, 6, 1, 3, 7, 1, 5, 7]),WS.OrthophotoLabelRenderable = function () {
    WS.AnnotationRenderable.call(this, !1), this._backgroundColor = vec4.create(WS.OrthophotoLabelRenderable.BG_COLOR), this._shadowColor = vec4.create(WS.OrthophotoLabelRenderable.SHADOW_COLOR)
}, WS.OrthophotoLabelRenderable.prototype = {
    setNormalColors: function () {
        WS.LabelRenderable.prototype.setNormalColors.call(this), this.setBackgroundColor(WS.OrthophotoLabelRenderable.BG_COLOR, !0), this.setShadowColor(WS.OrthophotoLabelRenderable.SHADOW_COLOR, !0)
    }
}, WS.extend("OrthophotoLabelRenderable", "AnnotationRenderable"), WS.OrthophotoLabelRenderable.BG_COLOR = [.882, .941, .969, .85], WS.OrthophotoLabelRenderable.SHADOW_COLOR = [.004, .184, .271, .85], WS.OrthoBox3dRenderable = function (e, t, i, n, r) {
    WS.Box3dRenderable.call(this, e, t), t = t || {}, this._imagePlaneAlphas = t.imagePlaneAlphas || WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS;
    var o = e ? WS.Renderable.ViewingMode.Selected : WS.Renderable.ViewingMode.Normal;
    this._alwaysShowBox = r || !1, this._showBox = this._alwaysShowBox, this._imageOffsetZ = 0, this._quadVertices = [];
    for (var a = 0; 4 > a; a++) this._quadVertices[a] = vec3.create();
    var s = WS.OrthoBox3dRenderable.QUAD_TEX_COORDS,
        c = this._imagePlaneAlphas[o],
        l = new WS.TextureMaterial(WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_FRONT, s, !0, c, WS.Material.Cull.BACK),
        h = new WS.TextureMaterial(WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_BACK, s, !0, c, WS.Material.Cull.FRONT),
        d = new WS.Geometry;
    if (d._positionBuffer = new WS.ArrayBuffer(new MatrixArray(18), 3), d._primitiveType = WS.Geometry.PrimitiveType.Triangles, this._imagePlaneFront = new WS.Mesh(d, l), this._imagePlaneBack = new WS.Mesh(d, h), this._imagePlaneLines = new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(24), 3), this._wireframeColors[o]), this._camVis = void 0, i) {
        var u = new WS.Geometry;
        u._positionBuffer = new WS.ArrayBuffer(new MatrixArray(18), 3), u._primitiveType = WS.Geometry.PrimitiveType.Triangles;
        var _ = new WS.TextureMaterial(WS.OrthoBox3dRenderable.CAMERA_TEX, s, !0);
        this._camVis = new WS.Mesh(u, _)
    }
    this._nameLabel = void 0, n && (this._nameLabel = new WS.OrthophotoLabelRenderable), this._categoryLabel = this._nameLabel
}, WS.OrthoBox3dRenderable.prototype = {
    setSize: function (e, t, i, n, r, o) {
        WS.Box3dRenderable.prototype.setSize.call(this, !0, t, i, n, r), this._imageOffsetZ = o || 0, e || this.updateAppearance()
    },
    setCaption: function (e, t) {
        this._nameLabel && (e = F.shortenString(e, 18, 4), this._nameLabel.setText(e, t))
    },
    setShowBox: function (e) {
        this._showBox = e || this._alwaysShowBox
    },
    updateIcon: function (e) {
        if (this._categoryLabel) {
            var t = this._dataObject ? this._dataObject._category : void 0;
            if (t) {
                var i = F.ColorGenerator.intColorFromString(t),
                    n = F.ColorGenerator.rgbColorFromInt(i);
                this._categoryLabel.setCategoryColor(n)
            } else this._categoryLabel.setCategoryColor(void 0);
            this._categoryLabel.onIconModeChange(e)
        }
    },
    updateAppearance: function (e) {
        if (this.valid()) {
            WS.Box3dRenderable.prototype.updateAppearance.call(this);
            var t = this._imagePlaneFront._geometry._positionBuffer,
                i = this._sizeX,
                n = this._sizeY,
                r = this._imageOffsetZ,
                o = [.5 * i, .5 * n, r],
                a = [0, 0, r],
                s = [0, n, r],
                c = [i, 0, r],
                l = [i, n, r];
            t.setItem(0, a, !0), t.setItem(1, s, !0), t.setItem(2, c, !0), t.setItem(3, c, !0), t.setItem(4, s, !0), t.setItem(5, l, !1);
            var h = this._imagePlaneLines._geometry._positionBuffer;
            if (h.setItem(0, a, !0), h.setItem(1, s, !0), h.setItem(2, s, !0), h.setItem(3, l, !0), h.setItem(4, l, !0), h.setItem(5, c, !0), h.setItem(6, c, !0), h.setItem(7, a, !1), this._camVis) {
                var d = .1,
                    u = (.5 - d) * i,
                    _ = (.5 + d) * i,
                    p = _ - u,
                    g = this._offsetZ,
                    f = this._offsetZ + this._sizeZ,
                    m = -1 * Math.max(.1, Math.min(Math.abs(this._sizeZ), 1)),
                    v = Math.min(g, f) + m,
                    S = v - p,
                    b = this._camVis._geometry._positionBuffer;
                b.setItem(0, [_, 0, v], !0), b.setItem(1, [u, 0, v], !0), b.setItem(2, [_, 0, S], !0), b.setItem(3, [_, 0, S], !0), b.setItem(4, [u, 0, v], !0), b.setItem(5, [u, 0, S], !1)
            }
            this._dataObject && this.setCaption(this._dataObject._displayName, !0), this.updateCategoryLabel(), this.updateIcon(e), this._nameLabel && this._nameLabel.setTranslation(o)
        }
    },
    setViewingModeOfLabels: function () {
        this._nameLabel && this._nameLabel.setViewingMode(this._viewingMode)
    },
    onViewingModeChange: function () {
        WS.Box3dRenderable.prototype.onViewingModeChange.call(this);
        var e, t = this._alwaysHighlight ? WS.Renderable.ViewingMode.Selected : this._viewingMode;
        switch (t) {
            case WS.Renderable.ViewingMode.Selected:
            case WS.Renderable.ViewingMode.Highlighted:
                e = this._imagePlaneAlphas[WS.Renderable.ViewingMode.Selected];
                break;
            default:
                e = this._imagePlaneAlphas[WS.Renderable.ViewingMode.Normal]
        }
        [this._imagePlaneFront, this._imagePlaneBack].forEach(function (t) {
            t._material._alpha = e
        }), this.setViewingModeOfLabels()
    },
    getMemberRenderables: function (e) {
        var t = e ? [] : WS.Box3dRenderable.prototype.getMemberRenderables.call(this);
        return t.push(this._imagePlaneFront), t.push(this._imagePlaneBack), t.push(this._imagePlaneLines), this._camVis && t.push(this._camVis), this._nameLabel && t.push(this._nameLabel), t
    },
    getVisibleMemberRenderables: function () {
        return this.valid() ? this.getMemberRenderables(!this._showBox) : []
    },
    getPickInfo: function (e, t, i, n) {
        var r = this.getVisibleMemberRenderables(),
            o = this.getPickInfoOfMemberRenderable(e, t, r, i, n);
        return void 0 !== o && o.add(this), o
    },
    getRegionPickInfo: function (e, t, i) {
        var n;
        if (this._nameLabel) {
            var r = mat4.multiply(t, this._nameLabel._transform, mat4.create());
            n = this._nameLabel.getRegionPickInfo(e, r, i), n && n.add(this)
        }
        return n
    },
    setIconMode: function (e, t) {
        this._categoryLabel && this._categoryLabel.setIconMode(e, t)
    },
    updateCategoryLabel: function () {
        this._categoryLabel && this._categoryLabel.setDataObject(this._dataObject)
    },
    redraw: function () {
        this._nameLabel && this._nameLabel.redraw()
    }
}, WS.extend("OrthoBox3dRenderable", "Box3dRenderable"), WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_FRONT = new WS.Image(WS.imgUrlCanvasSafe("image_nature.png")), WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_BACK = new WS.Image(WS.imgUrlCanvasSafe("image_nature_hatch.png")), WS.OrthoBox3dRenderable.CAMERA_TEX = new WS.Image(WS.imgUrlCanvasSafe("camera.png")), WS.OrthoBox3dRenderable.QUAD_TEX_COORDS = new WS.ArrayBuffer([0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 0], 2), WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS = {}, WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS[WS.Renderable.ViewingMode.Normal] = .2, WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS[WS.Renderable.ViewingMode.Selected] = .4, WS.CameraRenderable = function (e) {
    var t = e._camera,
        i = t.getGlobalPos(e._trafoView),
        n = e._width,
        r = e._height,
        o = t.unprojectPoint([n, r, 1], vec3.create()),
        a = t.unprojectPoint([0, r, 1], vec3.create()),
        s = t.unprojectPoint([n, 0, 1], vec3.create()),
        c = t.unprojectPoint([0, 0, 1], vec3.create()),
        l = t.unprojectPoint([n, r, -1], vec3.create()),
        h = t.unprojectPoint([0, r, -1], vec3.create()),
        d = t.unprojectPoint([n, 0, -1], vec3.create()),
        u = t.unprojectPoint([0, 0, -1], vec3.create()),
        _ = t.unprojectPoint([n / 2, r / 2, 1], vec3.create()),
        p = [o, a, s, c, l, h, d, u],
        g = 8,
        f = new WS.Geometry,
        m = f._positionBuffer = new WS.ArrayBuffer(new MatrixArray(3 * g), 3);
    f._indexBuffer = WS.CameraRenderable.INDEX_BUFFER, f._primitiveType = WS.Geometry.PrimitiveType.Triangles;
    for (var v = [i[0] - .025, i[1] - .025, i[2] - .025], S = [i[0] + .025, i[1] + .025, i[2] + .025], b = g - 1; b >= 0; --b) {
        var y = b % 2 >= 1 ? S[0] : v[0],
            P = b % 4 >= 2 ? S[1] : v[1],
            M = b % 8 >= 4 ? S[2] : v[2];
        m.setItem(b, [y, P, M], !0)
    }
    var w = new WS.ColorMaterial(new WS.ArrayBuffer([.33, 0, 0, 1], 4));
    w._depthTest = !0, w._depthWrite = !0, w._cullFace = WS.Material.Cull.BACK, this._box = new WS.Mesh(f, w);
    var C = new WS.Geometry,
        T = C._positionBuffer = new WS.ArrayBuffer(new MatrixArray(3 * g), 3);
    C._indexBuffer = WS.CameraRenderable.INDEX_BUFFER, C._primitiveType = WS.Geometry.PrimitiveType.Triangles;
    for (var W = 0; 8 > W; ++W) T.setItem(7 - W, p[W], !0);
    var I = new WS.ColorMaterial(new WS.ArrayBuffer([.33, .33, .67, .4], 4));
    I._depthTest = !0, I._depthWrite = !0, I._cullFace = WS.Material.Cull.BACK, this._faces = new WS.Mesh(C, I), this._lines = new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(3 * g * 3), 3), new WS.ArrayBuffer([.33, .33, .67, 1], 4));
    for (var L = this._lines._geometry._positionBuffer, R = WS.Box3dRenderable.WIREFRAME_INDICES, O = R.length - 1; O >= 0; O--) L.setItem(O, p[R[O]], O > 0);
    this._centerLine = new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(6), 3), new WS.ArrayBuffer([.67, .33, .33, 1], 4));
    var D = this._centerLine._geometry._positionBuffer;
    D.setItem(0, _, !0), D.setItem(1, i), this._UUID = F.generateUUID(), this.addToLayer(WS.Layer.LayerIDs.TEMP, !0)
}, WS.CameraRenderable.prototype = {
    getMemberRenderables: function () {
        return [this._box, this._faces, this._lines, this._centerLine]
    },
    draw3d: function (e, t) {
        t(this) && this.drawMemberRenderables3d(e, t, !0)
    },
    draw2d: function () {
    }
}, WS.extend("CameraRenderable", "Renderable"), WS.CameraRenderable.INDEX_BUFFER = new WS.IndexBuffer([0, 1, 3, 0, 3, 2, 5, 4, 6, 5, 6, 7, 4, 5, 1, 4, 1, 0, 2, 3, 7, 2, 7, 6, 4, 0, 2, 4, 2, 6, 1, 5, 7, 1, 7, 3]), WS.PickPositionRenderable = function (e) {
    this._forMap = e, this._pointState = WS.Point3d.PointState.Unknown;
    var t = new WS.QuadGeometry,
        i = new WS.SpriteMaterial(WS.PickPositionRenderable.ImageUnknown, vec2.create([32, 32]), !1, WS.Image.Filter.Linear);
    WS.SpriteRenderable.call(this, t, i)
}, WS.PickPositionRenderable.prototype = {
    draw2d: function () {
        this.isVisible() && WS.SpriteRenderable.prototype.draw2d.apply(this, arguments)
    },
    draw3d: function () {
        this.isVisible() && WS.SpriteRenderable.prototype.draw3d.apply(this, arguments)
    },
    isVisible: function () {
        var e = this._pointState,
            t = WS.Point3d.PointState;
        return this._forMap && (e === t.Valid || e === t.ValidXY || e === t.Free) || !this._forMap && e !== t.ValidXY
    },
    setPointState: function (e) {
        this._pointState = e;
        var t = this._material,
            i = WS.Point3d.PointState,
            n = WS.PickPositionRenderable;
        switch (e) {
            case i.Valid:
            case i.ValidXY:
                t.setTextureImages([n.ImageValid]);
                break;
            case i.Invalid:
                t.setTextureImages([n.ImageInvalid]);
                break;
            case i.Unknown:
            case i.Free:
                t.setTextureImages([n.ImageUnknown])
        }
    },
    getPickInfo: function () {
        return void 0
    },
    getRegionPickInfo: function () {
        return void 0
    }
}, WS.extend("PickPositionRenderable", "SpriteRenderable"), WS.PickPositionRenderable.ImageUnknown = new WS.Image(WS.imgUrlCanvasSafe("icons/pin_gray.png")), WS.PickPositionRenderable.ImageValid = new WS.Image(WS.imgUrlCanvasSafe("icons/pin_yellow.png")), WS.PickPositionRenderable.ImageInvalid = new WS.Image(WS.imgUrlCanvasSafe("icons/pin_red.png")), WS.ColorShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.color_vs, WS.shaderSrc.color_fs)
}, WS.extend("ColorShaderDesc", "BasicShaderDesc"), WS.ColorShaderDesc.ID = "ColorShader", WS.AreaLabelRenderable = function () {
    WS.MeasurementLabelRenderable.call(this, !1), this._backgroundColor = vec4.create(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP), this._shadowColor = vec4.create(WS.LabelRenderable.SHADOW_COLOR_MAP), this._textColor = vec4.create(WS.AreaLabelRenderable.TEXT_COLOR)
}, WS.AreaLabelRenderable.prototype = {
    setNormalColors: function () {
        var e = this._textColorCustom ? this._textColorCustom : WS.AreaLabelRenderable.TEXT_COLOR;
        this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP, !0), this.setTextColor(e, !0), this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR_MAP, !0), this.setTransparency(this._occluded ? WS.LabelRenderable.TRANSPARENCY_OCCLUDED : WS.LabelRenderable.TRANSPARENCY_NORMAL, !0)
    }
}, WS.extend("AreaLabelRenderable", "MeasurementLabelRenderable"), WS.AreaLabelRenderable.TEXT_COLOR = [1, 1, 0, .8], WS.AreaLabelRenderable.TEXT_COLOR_INVALID = [1, .67, .67, .8], WS.AreaMeasurementRenderable = function (e, t, i, n, r, o) {
    WS.MeasurementRenderable.call(this, e, t, i, n, r, void 0, o), this._area = e._area, this._centroidLocal = e._centroidLocal, this._areaValid = e.isAreaValid(), this._areaLabel = new WS.AreaLabelRenderable, this._areaPolygon = new WS.PolygonRenderable(new WS.ArrayBuffer([], 3), WS.AreaMeasurementRenderable.COLOR_POLYGON), this._mode = WS.AreaMeasurementRenderable.MODE_AREA;
    var a = this;
    r.get().then(function (e) {
        switch (e._areaState) {
            case "show":
                a._mode = WS.MeasurementRenderable.MODE_SEGMENT;
                break;
            default:
                a._mode = WS.AreaMeasurementRenderable.MODE_AREA
        }
    }).done()
}, WS.AreaMeasurementRenderable.prototype = {
    getCentroidInView: function () {
        return mat4.multiplyVec3(this._trafoToRefsystem, this._centroidLocal, vec3.create())
    },
    setSegmentMode: function (e) {
        this._mode = e
    },
    switchSegmentMode: function () {
        this.setSegmentMode(this._mode === WS.MeasurementRenderable.MODE_SEGMENT ? WS.AreaMeasurementRenderable.MODE_AREA : WS.MeasurementRenderable.MODE_SEGMENT)
    },
    isShowingDistanceLabels: function () {
        return this._mode === WS.MeasurementRenderable.MODE_SEGMENT
    },
    setViewingModeOfLabels: function () {
        WS.MeasurementRenderable.prototype.setViewingModeOfLabels.call(this), this._areaLabel.setViewingMode(this._viewingMode)
    },
    onViewingModeChange: function () {
        switch (this._viewingMode) {
            case WS.Renderable.ViewingMode.Selected:
                this._areaPolygon.setColor(WS.AreaMeasurementRenderable.COLOR_POLYGON_SELECTED);
                break;
            case WS.Renderable.ViewingMode.Highlighted:
                this._areaPolygon.setColor(WS.AreaMeasurementRenderable.COLOR_POLYGON_HIGHLIGHTED);
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
                this._areaPolygon.setColor(WS.AreaMeasurementRenderable.COLOR_POLYGON), this._areaPolygon.setTransparency(WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_INCONSIDERABLE);
                break;
            case WS.Renderable.ViewingMode.Normal:
                var e = this.determineColorOfArea();
                this._areaPolygon.setColor(e), this._areaPolygon.setTransparency(this._occluded ? WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_OCCLUDED : WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_NORMAL)
        }
        WS.MeasurementRenderable.prototype.onViewingModeChange.call(this)
    },
    updateUnit: function () {
        WS.MeasurementRenderable.prototype.updateUnit.call(this), this.updateAreaLabel()
    },
    updateAreaLabel: function () {
        var e = this._areaValid ? this._unit.getAreaAndUnit(this._area, 4) : this._locale.translate("FE_INVALID"),
            t = this._areaValid ? this.getCentroidInView() : this.getPointInView(1),
            i = this._areaValid ? WS.AreaLabelRenderable.TEXT_COLOR : WS.AreaLabelRenderable.TEXT_COLOR_INVALID;
        this._areaLabel.setProperties(e, t, i)
    },
    updateAreaPolygon: function () {
        for (var e = [], t = 0, i = this._pointsLocal.length; i > t; ++t) e.push.apply(e, this.getPointInView(t));
        this._areaPolygon.setPoints(e);
        var n = this.determineColorOfArea();
        this._areaPolygon.setColor(n), this._areaPolygon.setTransparency(this._occluded ? WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_OCCLUDED : WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_NORMAL)
    },
    updateCategoryLabel: function () {
        this._categoryLabel = this._areaLabel, this._categoryLabel.setDataObject(this._dataObject)
    },
    updateAppearance: function () {
        this.updateAreaLabel(), this.updateAreaPolygon(), WS.MeasurementRenderable.prototype.updateAppearance.call(this)
    },
    determineColorOfArea: function () {
        return this._areaValid ? this._temporary ? WS.AreaMeasurementRenderable.COLOR_POLYGON_TEMPORARY : WS.AreaMeasurementRenderable.COLOR_POLYGON : WS.AreaMeasurementRenderable.COLOR_POLYGON_INVALID
    },
    getVisibleMemberRenderables: function () {
        var e = [];
        return e.push(this._areaPolygon), e.push(this._viewingMode === WS.Renderable.ViewingMode.Highlighted ? this._segmentLinesHighlighted : this._viewingMode === WS.Renderable.ViewingMode.Selected ? this._segmentLinesSelected : this._segmentLines), this._mode === WS.MeasurementRenderable.MODE_SEGMENT && this._labelsModeSegment.forEach(function (t) {
            void 0 !== t && e.push(t)
        }), e.push(this._areaLabel), e
    },
    getMemberRenderables: function () {
        var e = [];
        return e.push(this._areaPolygon), e.push(this._segmentLinesHighlighted), e.push(this._segmentLinesSelected), e.push(this._segmentLines), this._labelsModeSegment.forEach(function (t) {
            void 0 !== t && e.push(t)
        }), e.push(this._areaLabel), e
    }
}, WS.extend("AreaMeasurementRenderable", "MeasurementRenderable"), WS.AreaMeasurementRenderable.MODE_AREA = 3, WS.AreaMeasurementRenderable.COLOR_POLYGON = [1, 1, 0, .25], WS.AreaMeasurementRenderable.COLOR_POLYGON_TEMPORARY = [1, .7, .078, .25], WS.AreaMeasurementRenderable.COLOR_POLYGON_INVALID = [1, 0, 0, .25], WS.AreaMeasurementRenderable.COLOR_POLYGON_SELECTED = [.47, .804, .95, .4], WS.AreaMeasurementRenderable.COLOR_POLYGON_HIGHLIGHTED = [.98, .875, .08, .4], WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_NORMAL = .25, WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_OCCLUDED = .1, WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_INCONSIDERABLE = .1, WS.PolylineAnnotationRenderable = function (e, t, i, n) {
    this._lineColor = F.ColorGenerator.intColorToDbl(e._displayColor), this._transform = t, this._unit = n, this._viewScanUuids = void 0, this.setViewScanUuids(i), this._pointsLocal = e._pointsLocal, this._pointScans = e._pointScans, this._pointStates = F.fillArray(this._pointsLocal.length, 0), this._segmentStates = F.fillArray(this._pointsLocal.length, 0);
    var r = 1 / n.getExactLength(1);
    this._segmentLines = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), WS.PolylineMixin.ColorPtsSmall, new WS.ArrayBuffer([], 4), new WS.ArrayBuffer([], 4), WS.LineMaterial.Dash.None, void 0, void 0, void 0, r, 2), this._segmentLinesSelected = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), WS.PolylineMixin.ColorPtsSmall, WS.PolylineMixin.ColorSelected, WS.PolylineMixin.ColorSelected, WS.LineMaterial.Dash.None, 6, 8, void 0, r, 2), this._segmentLinesHighlighted = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), WS.PolylineMixin.ColorPtsSmall, WS.PolylineMixin.ColorHighlighted, WS.PolylineMixin.ColorHighlighted, WS.LineMaterial.Dash.None, 6, 8, void 0, r, 2), this._segmentLinesSelected.enableDepthTest(!1), this._segmentLinesHighlighted.enableDepthTest(!1), this._areaPolygon = e.isClosedMapPolyline() ? new WS.PolygonRenderable(new WS.ArrayBuffer([], 3), this._lineColor) : void 0, this._label = new WS.AnnotationRenderable(e.hasMapType()), this._label.setTranslation(this.getPointInView(0)), this._categoryLabel = this._label, this._showPolyline = !0
}, WS.PolylineAnnotationRenderable.prototype = {
    getPointInView: function (e) {
        return this._pointsLocal[e]
    },
    setShowPolyline: function (e) {
        this._showPolyline = e
    },
    onViewingModeChange: function () {
        switch (this._viewingMode) {
            case WS.Renderable.ViewingMode.Selected:
                this._areaPolygon && this._areaPolygon.setColor(WS.PolylineAnnotationRenderable.COLOR_POLYGON_SELECTED);
                break;
            case WS.Renderable.ViewingMode.Highlighted:
                this._areaPolygon && this._areaPolygon.setColor(WS.PolylineAnnotationRenderable.COLOR_POLYGON_HIGHLIGHTED), this._segmentLines.setTransparency(1);
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
                this._areaPolygon && this._areaPolygon.setColor(this._lineColor), this._segmentLines.setTransparency(WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED);
                break;
            case WS.Renderable.ViewingMode.Normal:
                this._areaPolygon && (this._areaPolygon.setColor(this._lineColor), this._areaPolygon.setTransparency(this._occluded ? WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED : WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_NORMAL)), this._segmentLines.setTransparency(this._occluded ? WS.LabelRenderable.TRANSPARENCY_OCCLUDED : 1)
        }
        this._label.setViewingMode(this._viewingMode)
    },
    getColorForState: function () {
        return this._lineColor
    },
    setText: function (e, t) {
        this._label.setText(e, t)
    },
    setIconMode: function (e, t) {
        this._categoryLabel.setIconMode(e, t)
    },
    updateAreaPolygon: function () {
        if (this._areaPolygon) {
            for (var e = [], t = 0, i = this._pointsLocal.length; i > t; ++t) e.push.apply(e, this.getPointInView(t));
            this._areaPolygon.setPoints(e), this._areaPolygon.setColor(this._lineColor), this._areaPolygon.setTransparency(this._occluded ? WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED : WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_NORMAL)
        }
    },
    getVisibleMemberRenderables: function () {
        var e = [];
        return this._showPolyline && (this._areaPolygon && e.push(this._areaPolygon), e.push(this._viewingMode === WS.Renderable.ViewingMode.Highlighted ? this._segmentLinesHighlighted : this._viewingMode === WS.Renderable.ViewingMode.Selected ? this._segmentLinesSelected : this._segmentLines)), e.push(this._label), e
    },
    getMemberRenderables: function () {
        var e = [];
        return this._areaPolygon && e.push(this._areaPolygon), e.push(this._segmentLinesHighlighted), e.push(this._segmentLinesSelected), e.push(this._segmentLines), e.push(this._label), e
    },
    draw3d: function (e, t) {
        t(this) && this.drawMemberRenderables3d(e, t, !1)
    },
    draw2d: function (e, t) {
        this.drawMemberRenderables2d(e, t, !1)
    },
    updateIcon: function (e) {
        this.updateIconMixin(e)
    },
    getPickInfo: function (e, t, i, n) {
        return this.getPickInfoMixin(e, t, i, n)
    },
    getRegionPickInfo: function (e, t, i) {
        return this.getRegionPickInfoMixin(e, t, i)
    }
}, WS.extend("PolylineAnnotationRenderable", "Renderable"), WS.mixin("PolylineAnnotationRenderable", "PolylineMixin"), WS.PolylineAnnotationRenderable.COLOR_POLYGON_SELECTED = [.47, .804, .95, .3], WS.PolylineAnnotationRenderable.COLOR_POLYGON_HIGHLIGHTED = [.98, .875, .08, .3], WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_NORMAL = .2, WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED = .1, WS.QuadGeometry = function () {
    WS.Geometry.call(this), this._positionBuffer = WS.QuadGeometry.PositionBuffer, this._primitiveType = WS.Geometry.PrimitiveType.TriangleStrip
}, WS.extend("QuadGeometry", "Geometry"), WS.QuadGeometry.PositionBuffer = new WS.ArrayBuffer([0, 0, 0, 2, 2, 0, 2, 2], 2), WS.TextureValue = function (e, t) {
    this._texture = e, this._textureUnit = void 0 !== t ? t : 0
}, WS.extend("TextureValue"), WS.ScanLabelRenderable = function () {
    WS.LabelRenderable.call(this), this._borderAddWidth = WS.ScanLabelRenderable.BORDER_ADD_WIDTH, this._borderAddHeight = this._textHeight - 4, this._backgroundColor = vec4.create(WS.ScanLabelRenderable.BACKGROUND_COLOR_NORMAL), this.addToLayer(WS.Layer.LayerIDs.SCANS)
}, WS.ScanLabelRenderable.prototype = {
    setNormalColors: function () {
        this.setBackgroundColor(WS.ScanLabelRenderable.BACKGROUND_COLOR_NORMAL, !0), this.setTextColor(this._textColorCustom ? this._textColorCustom : WS.LabelRenderable.TEXT_COLOR, !0), this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR, !0), this.setTransparency(this._occluded ? WS.ScanLabelRenderable.TRANSPARENCY_OCCLUDED : WS.ScanLabelRenderable.TRANSPARENCY_NORMAL, !0)
    },
    renderToCanvas: function () {
        this._canvas || (this._canvas = document.createElement("canvas"));
        var e = this._canvas.getContext("2d"),
            t = this._textHeight + "px Arial";
        e.font = t;
        var i = e.measureText(this._text).width;
        i = Math.max(this._minBorderWidth, i);
        var n = i + this._borderAddWidth;
        this._icon && (n += WS.LabelRenderable.ICON_WIDTH);
        var r = this._textHeight + this._borderAddHeight,
            o = this._shadowOffsetX + this._shadowBlur,
            a = this._shadowOffsetY + this._shadowBlur,
            s = .5 * n,
            c = .5 * r,
            l = vec2.createFrom(0, 0),
            h = vec2.createFrom(s, 0),
            d = vec2.createFrom(n, 0),
            u = vec2.createFrom(n, c),
            _ = vec2.createFrom(n, r),
            p = vec2.createFrom(s, r),
            g = vec2.createFrom(0, r),
            f = vec2.createFrom(0, c);
        e.canvas.width = n + o, e.canvas.height = r + a, e.clearRect(0, 0, e.canvas.width, e.canvas.height);
        var m = 5;
        e.fillStyle = WS.Renderer2D.colorToStyle(this._backgroundColor), e.beginPath(), e.moveTo(h[0], h[1]), e.arcTo(d[0], d[1], d[0], d[1] + m, m), e.lineTo(u[0], u[1]), e.arcTo(_[0], _[1], _[0] - m, _[1], m), e.lineTo(p[0], p[1]), e.arcTo(g[0], g[1], g[0], g[1] - m, m), e.lineTo(f[0], f[1]), e.arcTo(l[0], l[1], l[0] + m, l[1], m), e.closePath(), this.drawShadow(e), e.font = t, e.fillStyle = WS.Renderer2D.colorToStyle(this._textColor);
        var v = .5 * this._borderAddWidth,
            S = .5 * this._borderAddHeight + this._textHeight - 1;
        e.fillText(this._text, v, S), S += this._textHeight + this._lineBreakHeight, this._icon && this._icon.draw(e, d[0] - WS.LabelRenderable.ICON_WIDTH, d[1] - 2, WS.LabelRenderable.ICON_WIDTH, WS.LabelRenderable.ICON_HEIGHT);
        var b = s,
            y = r + 8;
        this._geometry.setPosition(b, y, e.canvas.width, e.canvas.height)
    },
    supportsDragging: function () {
        return !1
    }
}, WS.extend("ScanLabelRenderable", "LabelRenderable"), WS.ScanLabelRenderable.BORDER_ADD_WIDTH = 8, WS.ScanLabelRenderable.BACKGROUND_COLOR_NORMAL = [1, 1, 1, .8], WS.ScanLabelRenderable.TRANSPARENCY_NORMAL = .8, WS.ScanLabelRenderable.TRANSPARENCY_OCCLUDED = .45, WS.ScanRenderable = function (e, t, i) {
    this._scanColorizer = e, this._label = new WS.ScanLabelRenderable, this._categoryLabel = this._label, this._hideLabelBySetting = !1, this._displayed = void 0, WS.SpriteRenderable.call(this, t, i)
}, WS.ScanRenderable.prototype = {
    setViewingModeOfLabels: function () {
        this._label.setViewingMode(this._viewingMode)
    },
    onViewingModeChange: function () {
        this.setViewingModeOfLabels()
    },
    getMemberRenderables: function () {
        return [this._label]
    },
    setCaption: function (e, t) {
        e = F.shortenString(e, 14, 4), this._label.setText(e, t)
    },
    getPickInfo: function (e, t, i, n) {
        var r = this.getVisibleMemberRenderables(),
            o = this.getPickInfoOfMemberRenderable(e, t, r, i, n);
        return void 0 !== o ? (o.add(this), o) : WS.SpriteRenderable.prototype.getPickInfo.apply(this, arguments)
    },
    setIconMode: function (e, t) {
        this._categoryLabel.setIconMode(e, t)
    },
    updateAppearance: function (e) {
        this._dataObject && this.setCaption(this._dataObject._displayName, !0), this.updateCategoryLabel(), this.updateIcon(e), this.addToLayer(WS.Layer.LayerIDs.SCANS, !0)
    },
    updateCategoryLabel: function () {
        this._categoryLabel.setDataObject(this._dataObject)
    },
    updateIcon: function (e) {
        if (this._categoryLabel) {
            var t = this._dataObject ? this._dataObject._category : void 0;
            if (t) {
                var i = WS.ColorGenerator.intColorFromString(t),
                    n = WS.ColorGenerator.rgbColorFromInt(i);
                this._categoryLabel.setCategoryColor(n)
            } else this._categoryLabel.setCategoryColor(void 0);
            this._categoryLabel.onIconModeChange(e)
        }
    },
    redraw: function () {
        this._label.redraw()
    },
    setHideLabelBySetting: function (e) {
        this._hideLabelBySetting = e
    }
}, WS.extend("ScanRenderable", "SpriteRenderable"), WS.ScanPanoRenderable = function (e) {
    this._occluded = !1;
    var t = WS.ScanPanoRenderable.OFFSET_PX,
        i = WS.ScanPanoRenderable.SIZE_PX_STANDARD,
        n = new WS.DynamicQuadGeometry;
    n.setPosition(t[0], t[1], i[0], i[1]);
    var r = new WS.SpriteMaterial(WS.ScanPanoRenderable.IMAGES.NORMAL, WS.ScanPanoRenderable.SIZE_M_STANDARD, !0);
    WS.ScanRenderable.call(this, e, n, r)
}, WS.ScanPanoRenderable.prototype = {
    onViewingModeChange: function () {
        switch (this._viewingMode) {
            case WS.Renderable.ViewingMode.Normal:
                this._material.setTextureImages([this._occluded ? WS.ScanPanoRenderable.IMAGES.INCONSIDERABLE : WS.ScanPanoRenderable.IMAGES.NORMAL]), this._material._spriteSize = WS.ScanPanoRenderable.SIZE_M_STANDARD;
                break;
            case WS.Renderable.ViewingMode.Highlighted:
                this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.HIGHLIGHTED]), this._material._spriteSize = WS.ScanPanoRenderable.SIZE_M_STANDARD;
                break;
            case WS.Renderable.ViewingMode.Selected:
                this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.SELECTED]), this._material._spriteSize = WS.ScanPanoRenderable.SIZE_M_INCREASED;
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
                this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.INCONSIDERABLE]), this._material._spriteSize = WS.ScanPanoRenderable.SIZE_M_STANDARD;
                break;
            case WS.Renderable.ViewingMode.Displayed:
                this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.DISPLAYED]), this._material._spriteSize = WS.ScanPanoRenderable.SIZE_M_STANDARD
        }
        WS.ScanRenderable.prototype.onViewingModeChange.call(this)
    },
    getVisibleMemberRenderables: function () {
        var e = [];
        return this._hideLabelBySetting || e.push(this._label), e
    },
    draw3d: function (e, t) {
		//ve cac diem scan trong panoramaview
		t(this) && (WS.Mesh.prototype.draw3d.call(this, e, t, !0), this._hideLabelBySetting || this.drawMemberRenderables3d(e, t, !0))
    },
    draw2d: function (e, t) {
        t(this) && (WS.SpriteRenderable.prototype.draw2d.call(this, e, t, !0), this._hideLabelBySetting || this.drawMemberRenderables2d(e, t, !0))
    },
    setOcclusion: function (e) {
        this._label.setOcclusion(e), this._occluded !== e && (this._occluded = e, this._viewingMode === WS.Renderable.ViewingMode.Normal && this._material.setTextureImages([this._occluded ? WS.ScanPanoRenderable.IMAGES.INCONSIDERABLE : WS.ScanPanoRenderable.IMAGES.NORMAL]))
    }
}, WS.extend("ScanPanoRenderable", "ScanRenderable"), WS.ScanPanoRenderable.IMAGES = {
    NORMAL: new WS.Image(WS.imgUrlCanvasSafe("pano_marker_white.png")),
    INCONSIDERABLE: new WS.Image(WS.imgUrlCanvasSafe("pano_marker_white_tr.png")),
    SELECTED: new WS.Image(WS.imgUrlCanvasSafe("pano_marker_active.png")),
    HIGHLIGHTED: new WS.Image(WS.imgUrlCanvasSafe("pano_marker_ye.png")),
    DISPLAYED: new WS.Image(WS.imgUrlCanvasSafe("pano_marker_orange.png"))
}, WS.ScanPanoRenderable.SIZE_M_STANDARD = vec2.create([.34, .5]), WS.ScanPanoRenderable.SIZE_M_INCREASED = vec2.create([.408, .6]), WS.ScanPanoRenderable.SIZE_PX_STANDARD = vec2.create([170, 250]), WS.ScanPanoRenderable.OFFSET_PX = vec2.create([85, 9]), WS.ScanMapRenderable = function (e) {
    this._color = [1, 1, 1, 1], this._canvas = document.createElement("canvas"), this._hideLabelByCluster = !0, this._marker = void 0, this.setImage(WS.ScanMapRenderable.IMAGES.NORMAL);
    var t = WS.ScanMapRenderable.OFFSET,
        i = WS.ScanMapRenderable.SIZE,
        n = new WS.DynamicQuadGeometry;
    n.setPosition(t[0], t[1], i[0], i[1]);
    var r = new WS.SpriteMaterial(void 0, i, !1);
    WS.ScanRenderable.call(this, e, n, r)
}, WS.ScanMapRenderable.prototype = {
    onViewingModeChange: function () {
        switch (this._viewingMode) {
            case WS.Renderable.ViewingMode.Normal:
                this.setImage(WS.ScanMapRenderable.IMAGES.NORMAL);
                break;
            case WS.Renderable.ViewingMode.Highlighted:
                this.setImage(WS.ScanMapRenderable.IMAGES.HIGHLIGHTED);
                break;
            case WS.Renderable.ViewingMode.Selected:
                this.setImage(WS.ScanMapRenderable.IMAGES.SELECTED);
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
                this.setImage(WS.ScanMapRenderable.IMAGES.INCONSIDERABLE);
                break;
            case WS.Renderable.ViewingMode.Displayed:
                this.setImage(WS.ScanMapRenderable.IMAGES.DISPLAYED);
                break;
            default:
                this.setImage(WS.ScanMapRenderable.IMAGES.NORMAL)
        }
        WS.ScanRenderable.prototype.onViewingModeChange.call(this), this.updateImage()
    },
    onImageLoad: function () {
        this.updateImage()
    },
    setImage: function (e) {
        this._image = e, e.isLoaded() || e.addListener(this)
    },
    getVisibleMemberRenderables: function () {
        var e = [];
        return this._hideLabelBySetting || this._hideLabelByCluster || e.push(this._label), e
    },
    updateImage: function () {
        this.renderToCanvas();
        var e = this._canvas.toDataURL();
        this._marker && this._marker.setIconByUrl(e);
    },
    draw3d: function (e, t) {
        t(this) && (this._hideLabelBySetting || this._hideLabelByCluster || this.drawMemberRenderables3d(e, t, !0))
    },
    draw2d: function (e, t) {
        t(this) && (this._hideLabelBySetting || this._hideLabelByCluster || this.drawMemberRenderables2d(e, t, !0))
    },
    renderToCanvas: function () {
        var e = this._canvas.getContext("2d"),
            t = WS.ScanMapRenderable.SIZE[0],
            i = WS.ScanMapRenderable.SIZE[1];
        e.canvas.width = t, e.canvas.height = i;
        var n = 16,
            r = 14,
            o = 9,
            a = e.createLinearGradient(n - 2 * o, r - 2 * o, n + o, r + o);
        a.addColorStop(0, "white"), a.addColorStop(1, WS.Renderer2D.colorToStyle(this._color)), e.fillStyle = a, e.beginPath(), e.arc(n, r, o, 0, 2 * Math.PI, !1), e.fill(), e.strokeStyle = WS.Renderer2D.colorToStyle([.33, .33, .33, 1]), e.lineWidth = 2, e.stroke();
        var s = this._image.getRawImage();
        s && e.drawImage(s, 0, 0, t, i)
    },
    getPickInfo: function (e, t, i, n) {
        var r = this.getVisibleMemberRenderables(),
            o = this.getPickInfoOfMemberRenderable(e, t, r, i, n);
        return void 0 !== o ? (o.add(this), o) : void 0
    },
    updateAppearance: function (e) {
        WS.ScanRenderable.prototype.updateAppearance.call(this, e), this.updateColor(!0), e || this.updateImage()
    },
    updateColor: function (e) {
        if (this._dataObject) {
            var t = this._scanColorizer.getScanTileColor(this._dataObject._UUID);
            if (this._color = [t.r / 255, t.g / 255, t.b / 255, 1], e) return;
            this.updateImage()
        }
    },
    redraw: function () {
        WS.ScanRenderable.prototype.redraw.call(this), this.updateImage()
    },
    setHideLabelByCluster: function (e) {
        this._hideLabelByCluster = e
    },
    setMarker: function (e) {
        this._marker = e
    }
}, WS.extend("ScanMapRenderable", "ScanRenderable"), WS.ScanMapRenderable.SIZE = vec2.create([32, 45]), WS.ScanMapRenderable.OFFSET = vec2.create([16, 3]), WS.ScanMapRenderable.IMAGES = {
    NORMAL: new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_white.png")),
    INCONSIDERABLE: new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_white.png")),
    SELECTED: new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_bl.png")),
    HIGHLIGHTED: new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_ye.png")),
    DISPLAYED: new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_or.png"))
}, WS.ScanMapRenderable.prefetchIcons = function () {
    var e = [WS.ScanMapRenderable.IMAGES.NORMAL, WS.ScanMapRenderable.IMAGES.INCONSIDERABLE, WS.ScanMapRenderable.IMAGES.SELECTED, WS.ScanMapRenderable.IMAGES.HIGHLIGHTED, WS.ScanMapRenderable.IMAGES.DISPLAYED];
    e.forEach(function (e) {
        e.addListener({
            onImageLoad: function () {
            }
        })
    })
}, WS.GlBuffer = function (e, t) {
    this._ctx = t, this._buffer = e, this._bufferID = -1, this.createBuffer(), this._buffer.addListener(this)
}, WS.GlBuffer.prototype = {
    onDataChange: function () {
        this.uploadData()
    },
    getArrayConstructorFromDataType: function (e) {
        return e === WS.Buffer.ItemDataType.FLOAT ? Float32Array : e === WS.Buffer.ItemDataType.USHORT ? Uint16Array : e === WS.Buffer.ItemDataType.UBYTE ? Uint8Array : void 0
    },
    createBuffer: function () {
        -1 === this._bufferID && (this._bufferID = this._ctx.createBuffer())
    },
    uploadData: function () {
        var e = this._ctx,
            t = this._buffer;
        if (t) {
            var i = this.getArrayConstructorFromDataType(t._itemDataType);
            if (-1 !== this._bufferID) {
                var n;
                return n = t._bufferData instanceof i ? t._bufferData : new i(t._bufferData), this.bindBuffer(), e.bufferData(e[t._bufferType], n, e.STATIC_DRAW), this.unbindBuffer(), !0
            }
            return !1
        }
    },
    destroy: function () {
        this._buffer && this._buffer.removeListener(this), -1 !== this._bufferID && (this._ctx.deleteBuffer(this._bufferID), this._bufferID = -1)
    },
    bindBuffer: function () {
        this._ctx.bindBuffer(this._ctx[this._buffer._bufferType], this._bufferID)
    },
    unbindBuffer: function () {
        this._ctx.bindBuffer(this._ctx[this._buffer._bufferType], null)
    },
    useBufferAsAttribInput: function (e) {
        var t = this._ctx,
            i = this._buffer;
        i && t && (this.bindBuffer(), t.vertexAttribPointer(e, i._itemSize, t[i._itemDataType], !1, i._stride, i._offset), t.enableVertexAttribArray(e))
    }
}, WS.extend("GlBuffer", "Object"), WS.GlTexture = function (e, t, i) {
    this._magFilter = WS.Image.Filter.Linear, this._minFilter = WS.Image.Filter.Linear, this._wrapS = "CLAMP_TO_EDGE", this._wrapT = "CLAMP_TO_EDGE", this._format = t || "RGBA", this._type = i || "UNSIGNED_BYTE", this._flipY = !0, this._ctx = e, this._textureID = -1, this.createTexture()
}, WS.GlTexture.prototype = {
    createTexture: function () {
        -1 === this._textureID && (this._textureID = this._ctx.createTexture())
    },
    uploadParameter: function () {
        var e = this._ctx;
        -1 !== this._textureID && (e.bindTexture(e.TEXTURE_2D, this._textureID), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MAG_FILTER, e[this._magFilter]), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MIN_FILTER, e[this._minFilter]), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_S, e[this._wrapS]), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_T, e[this._wrapT]), e.bindTexture(e.TEXTURE_2D, null))
    },
    activateTexture: function (e) {
        var t = this._ctx;
        return -1 !== this._textureID ? (t.activeTexture(t.TEXTURE0 + e), t.bindTexture(t.TEXTURE_2D, this._textureID), !0) : !1
    },
    destroy: function () {
        var e = this._ctx;
        -1 !== this._textureID && (e.deleteTexture(this._textureID), this._textureID = -1)
    },
    getWidth: function () {
    },
    getHeight: function () {
    }
}, WS.extend("GlTexture", "Object"), WS.GlTexture.getMaxSize = function () {
    if ("undefined" == typeof WS.GlTexture.getMaxSize._value) {
        var e = document.createElement("canvas"),
            t = F.getGLContext(e);
        WS.GlTexture.getMaxSize._value = t ? t.getParameter(t.MAX_TEXTURE_SIZE) : 0
    }
    return WS.GlTexture.getMaxSize._value
}, WS.GlTexture.getMaxWidth = function () {
    return WS.GlTexture.getMaxSize()
}, WS.GlTexture.getMaxHeight = function () {
    return WS.GlTexture.getMaxSize()
}, WS.GlBlankTexture = function (e, t, i, n) {
    WS.GlTexture.call(this, i, n ? "DEPTH_COMPONENT" : "RGBA", n ? "UNSIGNED_SHORT" : "UNSIGNED_BYTE"), this._width = e, this._height = t, this.uploadParameter(), this.upload()
}, WS.GlBlankTexture.prototype = {
    upload: function () {
        var e = this._ctx;
        return 0 < this.getWidth() && 0 < this.getHeight() && -1 !== this._textureID ? (e.bindTexture(e.TEXTURE_2D, this._textureID), e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL, this._flipY), e.texImage2D(e.TEXTURE_2D, 0, e[this._format], this.getWidth(), this.getHeight(), 0, e[this._format], e[this._type], null), e.bindTexture(e.TEXTURE_2D, null), !0) : !1
    },
    getWidth: function () {
        return this._width
    },
    getHeight: function () {
        return this._height
    },
    resize: function (e, t) {
        this._width = e, this._height = t, this.upload()
    }
}, WS.extend("GlBlankTexture", "GlTexture"), WS.GlImageTexture = function (e, t) {
    WS.GlTexture.call(this, t), this._image = e, this._imageUploaded = !1, this.extractParameterFromImage(), this.uploadParameter(), this._image.addListener(this)
}, WS.GlImageTexture.prototype = {
    isImageUploaded: function () {
        return this._imageUploaded
    },
    uploadImage: function () {
        var e = this._image ? this._image.getRawImage() : void 0,
            t = this._ctx;
        return e && e.complete && -1 !== this._textureID ? (t.bindTexture(t.TEXTURE_2D, this._textureID), t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL, this._flipY), t.texImage2D(t.TEXTURE_2D, 0, t[this._format], t[this._format], t[this._type], e), t.bindTexture(t.TEXTURE_2D, null), this._imageUploaded = !0, !0) : !1
    },
    onImageLoad: function () {
        this.uploadImage()
    },
    onParameterChange: function () {
        this.extractParameterFromImage(), this.uploadParameter()
    },
    extractParameterFromImage: function () {
        var e = this._image;
        e && (this._magFilter = e._filter, this._minFilter = e._filter)
    },
    getWidth: function () {
        return this._image ? this._image.getWidth() : 0
    },
    getHeight: function () {
        return this._image ? this._image.getHeight() : 0
    },
    destroy: function () {
        this._image && this._image.removeListener(this), WS.GlTexture.prototype.destroy.call(this), this._imageUploaded = !1
    }
}, WS.extend("GlImageTexture", "GlTexture"), WS.FrameBuffer = function (e, t, i) {
    if (t = t || 1, i = i || !1, t > 1) {
        F.getGLExtension(e, "EXT_draw_buffers")
    }
    if (i) {
        F.getGLExtension(e, "WEBGL_depth_texture")
    }
    var n = e.canvas.width || 64,
        r = e.canvas.height || 64,
        o = e.createFramebuffer();
    e.bindFramebuffer(e.FRAMEBUFFER, o);
    for (var a = [], s = 0; t > s; s++) {
        var c = new WS.GlBlankTexture(n, r, e);
        c._magFilter = c._minFilter = WS.Image.Filter.Nearest, c.uploadParameter(), a[s] = c, e.framebufferTexture2D(e.FRAMEBUFFER, e.COLOR_ATTACHMENT0 + s, e.TEXTURE_2D, a[s]._textureID, 0)
    }
    e.bindTexture(e.TEXTURE_2D, null);
    var l, h;
    i ? (l = new WS.GlBlankTexture(n, r, e, !0), l._magFilter = l._minFilter = WS.Image.Filter.Nearest, l.uploadParameter(), e.bindTexture(e.TEXTURE_2D, l._textureID), e.framebufferTexture2D(e.FRAMEBUFFER, e.DEPTH_ATTACHMENT, e.TEXTURE_2D, l._textureID, 0), e.bindTexture(e.TEXTURE_2D, null)) : (h = e.createRenderbuffer(), e.bindRenderbuffer(e.RENDERBUFFER, h), e.renderbufferStorage(e.RENDERBUFFER, e.DEPTH_COMPONENT16, n, r), e.framebufferRenderbuffer(e.FRAMEBUFFER, e.DEPTH_ATTACHMENT, e.RENDERBUFFER, h)), e.bindRenderbuffer(e.RENDERBUFFER, null), e.bindFramebuffer(e.FRAMEBUFFER, null), this._ctx = e, this._width = n, this._height = r, this._textures = a, this._depthTexture = l, this._depthBufferID = h, this._framebufferID = o, this._camMatrix = void 0
}, WS.FrameBuffer.prototype = {
    bind: function () {
        this._ctx.bindFramebuffer(this._ctx.FRAMEBUFFER, this._framebufferID)
    },
    unbind: function () {
        this._ctx.bindFramebuffer(this._ctx.FRAMEBUFFER, null)
    },
    destroy: function () {
        var e = this._ctx;
        e.bindFramebuffer(e.FRAMEBUFFER, null), e.bindRenderbuffer(e.RENDERBUFFER, null), this._textures.forEach(function (e) {
            e.destroy()
        }), this._textures = [], this._depthTexture && this._depthTexture.destroy(), this._depthTexture = void 0, this._depthBufferID && e.deleteRenderbuffer(this._depthBufferID), this._depthBufferID = void 0, this._framebufferID && e.deleteFramebuffer(this._framebufferID), this._framebufferID = void 0
    },
    updateSize: function (e, t) {
        if (!(0 >= e || 0 >= t) && (this._width = e, this._height = t, this._textures.forEach(function (i) {
                i.resize(e, t)
            }), this._depthTexture && this._depthTexture.resize(e, t), this._depthBufferID)) {
            var i = this._ctx;
            i.bindRenderbuffer(i.RENDERBUFFER, this._depthBufferID), i.renderbufferStorage(i.RENDERBUFFER, i.DEPTH_COMPONENT16, e, t), i.bindRenderbuffer(i.RENDERBUFFER, null)
        }
    },
    readTexture: function (e, t, i, n, r) {
        return i = i || 1, n = n || 1, r = r || new Uint8Array(i * n * 4), this.bind(), this._ctx.readPixels(e, t, i, n, this._ctx.RGBA, this._ctx.UNSIGNED_BYTE, r), this.unbind(), r
    },
    readClosestOpaquePixel: function (e, t, i, n) {
        n = n || function () {
            return !0
        };
        for (var r, o = 2 * i + 1, a = this.readTexture(e - i, t - i, o, o), s = Number.MAX_VALUE, c = 0; o > c; c++)
            for (var l = (c - i) * (c - i), h = 0; o > h; h++) {
                var d = 4 * (h * o + c),
                    u = a.subarray(d, d + 4),
                    _ = l + (h - i) * (h - i);
                0 < u[3] && s > _ && n(u) && (r = u, s = _)
            }
        return r || new Uint8Array([0, 0, 0, 0])
    }
}, WS.extend("FrameBuffer", "Object"), WS.TextureStorage = function (e) {
    this._textures = {}, this._ctx = e
}, WS.TextureStorage.prototype = {
    inquireTexture: function (e, t) {
        if (!e) return void 0;
        var i = this._textures[e._id];
        return i || (i = new t(e, this._ctx), this._textures[e._id] = i), i
    },
    deleteTexture: function (e) {
        if (e) {
            var t = this._textures[e._id];
            t && (t.destroy(), delete this._textures[e._id])
        }
    },
    deleteAllTextures: function () {
        for (var e in this._textures) this._textures.hasOwnProperty(e) && this._textures[e].destroy();
        this._textures = {}
    },
    isEmpty: function () {
        return 0 === Object.keys(this._textures).length
    }
}, WS.extend("TextureStorage"), WS.Shader = function (e, t, i, n) {
    var r = "boolean" == typeof n ? n : !0;
    this._shaderID = -1, this._ctx = e, this._type = t, this._shaderSrc = i, this._compiled = void 0, r && this.compileShader()
}, WS.Shader.prototype = {
    compileShader: function () {
        var e = this._ctx;
        this._shaderID = e.createShader(this._type === WS.Shader.Type.Fragment ? e.FRAGMENT_SHADER : e.VERTEX_SHADER), e.shaderSource(this._shaderID, this._shaderSrc), e.compileShader(this._shaderID);
        var t = e.getShaderParameter(this._shaderID, e.COMPILE_STATUS);
        if (this._compiled = !!t, !t) {
            var i = console;
            i.log(e.getShaderInfoLog(this._shaderID))
        }
    },
    isValid: function () {
        return -1 !== this._shaderID
    },
    deleteShader: function () {
        this.isValid() && (this._ctx.deleteShader(this._shaderID), this._shaderID = -1)
    }
}, WS.extend("Shader"), WS.Shader.Type = {
    Vertex: "VERTEX",
    Fragment: "FRAGMENT"
}, WS.VertexShader = function (e, t, i) {
    WS.Shader.call(this, e, WS.Shader.Type.Vertex, t, i)
}, WS.extend("VertexShader", "Shader"), WS.FragmentShader = function (e, t, i) {
    WS.Shader.call(this, e, WS.Shader.Type.Fragment, t, i)
}, WS.extend("FragmentShader", "Shader"), WS.ShaderAttribute = function (e, t, i) {
    this._name = e, this._type = t, this._id = i, this._value = void 0
}, WS.extend("ShaderAttribute"), WS.ShaderAttributes = function () {
    this._elements = {}
}, WS.ShaderAttributes.prototype = {
    addAttribute: function (e) {
        this._elements[e._name] = e
    },
    getAttribute: function (e) {
        return this._elements[e]
    },
    getAttributes: function () {
        return this._elements
    }
}, WS.extend("ShaderAttributes"), WS.ShaderProgram = function (e, t, i, n) {
    var r, o;
    this._vertexShader = void 0, this._fragmentShader = void 0, this._programID = void 0, this._attributes = void 0, this._uniforms = void 0, this._name = t, this._failSafe = !!n, this._ctx = e;
    var a = console,
        s = i.getDefines(e);
    n && (s = ["#define FAILSAFE"].concat(s)), r = s.concat([i._vertexShader]).join("\n"), o = s.concat([i._fragmentShader]).join("\n"), this._vertexShader = new WS.VertexShader(e, r, !0), this._fragmentShader = new WS.FragmentShader(e, o, !0), this._vertexShader._compiled || a.error("VS compile error:", t), this._fragmentShader._compiled || a.error("FS compile error:", t), this._compiled = this.compileProgram(), n && a.log("tried failsafe mode:", t, "success:", this._compiled), this._compiled && (this.extractAttributes(), this.extractUniforms())
}, WS.ShaderProgram.prototype = {
    invalidateValues: function () {
        if (this._compiled) {
            var e = this._uniforms.getUniforms();
            for (var t in e) this._uniforms.getUniform(t)._value = void 0
        }
    },
    compileProgram: function () {
        this._programID = this._ctx.createProgram(), this._ctx.attachShader(this._programID, this._vertexShader._shaderID), this._ctx.attachShader(this._programID, this._fragmentShader._shaderID), this._ctx.linkProgram(this._programID);
        var e = this._ctx.getProgramParameter(this._programID, this._ctx.LINK_STATUS);
        if (!e) {
            var t = console;
            t.log(this._ctx.getProgramInfoLog(this._programID)), t.error("Shader link error:", this._name)
        }
        return !!e
    },
    setAttributeValue: function (e, t) {
        var i = this._attributes.getAttribute(e);
        return i._value = t, this.uploadAttributeValue(i), !0
    },
    setUniformValue: function (e, t) {
        var i = this._uniforms.getUniform(e);
        return i._value !== t && (i._value = t, this.uploadUniformValue(i)), !0
    },
    uploadAttributeValue: function (e) {
        var t, i, n, r = this._ctx;
        i = e._value, void 0 !== i && (i.instanceOf && i.instanceOf(WS.GlBuffer) ? (n = i, n.useBufferAsAttribInput(e._id)) : (i instanceof Array || "number" == typeof i) && (t = WS.ShaderProgram._attributeFunctions[e._type], r.disableVertexAttribArray(e._id), r[t](e._id, i)))
    },
    uploadUniformValue: function (e) {
        var t, i, n, r, o = this._ctx;
        t = e._value, i = WS.ShaderProgram._uniformFunctions[e._type], void 0 !== t && (t.instanceOf && t.instanceOf(WS.TextureValue) ? (n = t._texture, r = t._textureUnit, n.activateTexture(r), o[i](e._id, r)) : e._type === o.FLOAT_MAT2 || e._type === o.FLOAT_MAT3 || e._type === o.FLOAT_MAT4 ? o[i](e._id, !1, new Float32Array(t)) : e._type === o.FLOAT_VEC2 || e._type === o.FLOAT_VEC3 || e._type === o.FLOAT_VEC4 ? o[i](e._id, new Float32Array(t)) : o[i](e._id, t))
    },
    disableAttributeArrays: function () {
        if (this._compiled) {
            var e = this._ctx,
                t = this._attributes.getAttributes();
            for (var i in t) {
                var n = this._attributes.getAttribute(i),
                    r = n._value;
                r && r.instanceOf && r.instanceOf(WS.GlBuffer) && e.disableVertexAttribArray(n._id)
            }
        }
    },
    activateProgram: function () {
        return this.isActive() || (this.setActive(), this._ctx.useProgram(this._programID)), this
    },
    deactivateProgram: function () {
        this.setInactive(), this.disableAttributeArrays()
    },
    destroy: function () {
        this.deactivateProgram(), -1 != this._programID && (this._ctx.deleteProgram(this._programID), this._vertexShader.deleteShader(), this._fragmentShader.deleteShader())
    },
    isActive: function () {
        return WS.ShaderProgram._activeProgram === this
    },
    setActive: function () {
        WS.ShaderProgram._activeProgram = this
    },
    setInactive: function () {
        this.isActive() && (WS.ShaderProgram._activeProgram = void 0)
    },
    extractAttributes: function () {
        var e, t, i, n, r, o = this._ctx;
        for (this._attributes = new WS.ShaderAttributes, n = o.getProgramParameter(this._programID, o.ACTIVE_ATTRIBUTES), r = 0; n > r; r++) e = o.getActiveAttrib(this._programID, r), t = o.getAttribLocation(this._programID, e.name), i = new WS.ShaderAttribute(e.name, e.type, t), this._attributes.addAttribute(i)
    },
    extractUniforms: function () {
        var e, t, i, n, r = this._ctx;
        this._uniforms = new WS.ShaderUniforms, n = r.getProgramParameter(this._programID, r.ACTIVE_UNIFORMS);
        for (var o = 0; n > o; o++) e = r.getActiveUniform(this._programID, o), t = r.getUniformLocation(this._programID, e.name), i = new WS.ShaderUniform(e.name, e.type, t), this._uniforms.addUniform(i)
    }
}, WS.extend("ShaderProgram"), WS.ShaderProgram._activeProgram = void 0, WS.ShaderProgram._uniformFunctions = {
    5126: "uniform1f",
    5124: "uniform1i",
    35664: "uniform2fv",
    35665: "uniform3fv",
    35666: "uniform4fv",
    35667: "uniform2iv",
    35668: "uniform3iv",
    35669: "uniform4iv",
    35674: "uniformMatrix2fv",
    35675: "uniformMatrix3fv",
    35676: "uniformMatrix4fv",
    35678: "uniform1i",
    35670: "uniform1i",
    35671: "uniform2i",
    35672: "uniform3i",
    35673: "uniform4i"
}, WS.ShaderProgram._attributeFunctions = {
    5126: "vertexAttrib1f",
    35664: "vertexAttrib2fv",
    35665: "vertexAttrib3fv",
    35666: "vertexAttrib4fv"
}, WS.ShaderProgramStorage = function (e) {
    this._compiledShaderPrograms = {}, this._ctx = e
}, WS.ShaderProgramStorage.prototype = {
    inquireShaderProgram: function (e) {
        var t = e.ID,
            i = this._compiledShaderPrograms[t];
        if (!i) {
            var n = new e;
            i = new WS.ShaderProgram(this._ctx, t, n), i._compiled || (i = new WS.ShaderProgram(this._ctx, t, n, !0)), this._compiledShaderPrograms[t] = i
        }
        return i
    },
    deleteAllShaderPrograms: function () {
        for (var e in this._compiledShaderPrograms) this._compiledShaderPrograms[e] && this._compiledShaderPrograms[e].destroy();
        this._compiledShaderPrograms = {}
    },
    isEmpty: function () {
        return 0 === Object.keys(this._compiledShaderPrograms).length
    }
}, WS.extend("ShaderProgramStorage"), WS.BufferStorage = function (e) {
    this._buffers = {}, this._ctx = e
}, WS.BufferStorage.prototype = {
    inquireBuffer: function (e) {
        var t;
        return t = this._buffers[e._id], t || (t = new WS.GlBuffer(e, this._ctx), this._buffers[e._id] = t), t
    },
    deleteAllBuffers: function () {
        var e, t;
        for (e in this._buffers) t = this._buffers[e], t && t.destroy();
        this._buffers = {}
    },
    deleteBuffer: function (e) {
        var t = this._buffers[e._id];
        t && (t.destroy(), delete this._buffers[e._id])
    },
    isEmpty: function () {
        return 0 === Object.keys(this._buffers).length
    }
}, WS.extend("BufferStorage"), WS.FrameBufferStorage = function (e) {
    this._ctx = e, this._buffers = {}
}, WS.FrameBufferStorage.prototype = {
    get: function (e, t) {
        return this._buffers[e] || (t = t || WS.FrameBuffer, this._buffers[e] = new t(this._ctx)), this._buffers[e]
    },
    getIDs: function () {
        return Object.keys(this._buffers)
    },
    destroy: function (e) {
        this._buffers[e] && (this._buffers[e].destroy(), delete this._buffers[e])
    },
    destroyAll: function () {
        Object.keys(this._buffers).forEach(F.proxy(this.destroy, this))
    },
    updateSizes: function () {
        var e = this._ctx.canvas.width,
            t = this._ctx.canvas.height;
        if (!(0 >= e || 0 >= t))
            for (var i in this._buffers) {
                var n = this._buffers[i];
                n.updateSize(e, t)
            }
    }
}, WS.extend("FrameBufferStorage"), WS.GlViewport = function (e, t, i) {
    WS.Viewport.call(this, t, i), this._ctx = e
}, WS.GlViewport.prototype = {
    use: function () {
        this._ctx.viewport(0, 0, this.getWidth(), this.getHeight())
    }
}, WS.extend("GlViewport", "Viewport"), WS.Renderer3D = function (e, t, i, n) {
    WS.RendererBase.call(this, t, i), this._errorHandler = n, this._depthTest = void 0, this._depthWrite = void 0, this._enableVertexPointSize = void 0, this._enableBlending = void 0, this._cullFace = void 0, this._ctx = e, this._activeShaderProgram = void 0, this._shaderProgramStorage = new WS.ShaderProgramStorage(this._ctx), this._textureStorage = new WS.TextureStorage(this._ctx), this._bufferStorage = new WS.BufferStorage(this._ctx), this._drawVisitor = new WS.RenderVisitor(this, "draw3d", void 0, this._view), this._shaderPrograms = {}, this._frameBufferStorage = new WS.FrameBufferStorage(e), this._dummyTexture = new WS.GlBlankTexture(16, 16, e), this._rgbDepthTest = !1, this._rgbDepthTexture = this._dummyTexture, this._renderColorMode = WS.RendererBase.RenderMode.DEFAULT, this._pickColorBuffer = new WS.ArrayBuffer([], 4, WS.Buffer.ItemDataType.UBYTE), this._gapfiller = void 0, this._gfRenderables = {}, this._gfResultRenderables = {}, this._dbgGapFillAll = !1, this.setEnableDepthTest(!0), this.setEnableDepthWrite(!0), this.setEnableBlending(!1), this.setDefaultBlendFunc(), this.setViewPort(new WS.GlViewport(this._ctx, e.canvas.width, e.canvas.height)), this.setClearColor([1, 1, 1, 0]), this.clear()
}, WS.Renderer3D.prototype = {
    destroy: function () {
        this.clearStorage()
    },
    clearStorage: function () {
        this._textureStorage.deleteAllTextures(), this._bufferStorage.deleteAllBuffers(), this._frameBufferStorage.destroyAll(), this._gfRenderables = {}, this._gfResultRenderables = {}, this._shaderProgramStorage.deleteAllShaderPrograms(), this._shaderPrograms = {}
    },
    invalidateShaderValues: function () {
        for (var e in this._shaderPrograms) this._shaderPrograms[e].invalidateValues()
    },
    drawScene: function (e, t, i, n, r) {
        r = r || {};
        var o, a = r.destFB,
            s = r.bufferPrefix || "";
        r.rgbDepthTest && (o = this._frameBufferStorage.get(s + "post_gf_depth")._textures[0]);
        var c = r.colorMode;
        a && a.bind();
        var l;
        c && (this.setRenderColorMode(c), c === WS.RendererBase.RenderMode.DEPTH && (l = F.cloneArray(this._clearColor), this.setClearColor(WS.Renderer3D.DEPTH_CLEARCOLOR))), o && this.enableRGBDepthTest(!0, o), this.invalidateShaderValues(), WS.RendererBase.prototype.drawScene.apply(this, arguments), a && a.unbind(), c && this.setRenderColorMode(WS.RendererBase.RenderMode.DEFAULT), l && this.setClearColor(l), o && this.enableRGBDepthTest(!1)
    },
    drawSceneIncremental: function (e, t, i, n, r) {
        void 0 === this._gapfiller && this.testGFSupport(), void 0 === i && (i = WS.PointCloudRenderable.Draw.ALL), r = r || {};
        var o, a = r.bufferPrefix || "",
            s = r.colorMode,
            c = s === WS.RendererBase.RenderMode.PICK_3D || s === WS.RendererBase.RenderMode.PICK_3D_POINT,
            l = r.reuseDepth,
            h = this._drawVisitor._layerService.getZIndexOfLayer(WS.Layer.LayerIDs.POINT_CLOUD, this._view),
            d = [h],
            u = this._zIndices.filter(function (e) {
                return h > e
            }),
            _ = this._zIndices.filter(function (e) {
                return e > h
            }),
            p = this._gapfiller ? "pre_gf_" : "post_gf_",
            g = this._frameBufferStorage.get(a + p + "color"),
            f = this._frameBufferStorage.get(a + p + "depth");
        if (i !== WS.PointCloudRenderable.Draw.KEEP && (o = i === WS.PointCloudRenderable.Draw.ADD, this.drawScene(e, t, o, n, {
                zIndices: d,
                destFB: g,
                colorMode: s
            })), l || i === WS.PointCloudRenderable.Draw.KEEP || (o = i === WS.PointCloudRenderable.Draw.ADD, this.drawScene(e, t, o, n, {
                zIndices: d,
                destFB: f,
                colorMode: WS.RendererBase.RenderMode.DEPTH
            })), (i !== WS.PointCloudRenderable.Draw.KEEP || this._dbgGapFillAll) && (this._gapfiller ? this.fillGaps(a, s) : f._camMatrix = mat4.create(this._camera._camMatrix)), !c) {
            this.drawScene(e, t, !1, n, {
                zIndices: u
            });
            var m = this.getGFResultRenderable(a);
            this.applyEffect(m), this.drawScene(e, t, !0, n, {
                bufferPrefix: a,
                zIndices: _,
                rgbDepthTest: !0
            })
        }
    },
    applyEffect: function (e, t) {
        t = t || {};
        var i = t.destFB,
            n = t.colorMode;
        i && i.bind(), n && this.setRenderColorMode(n), e.draw3d(this, function () {
            return !0
        }, !0), i && i.unbind(), n && this.setRenderColorMode(WS.RendererBase.RenderMode.DEFAULT)
    },
    updateDetailLevel: function (e) {
        var t = e === WS.PanoSettings.Detail3d.MEDIUM || e === WS.PanoSettings.Detail3d.HIGH || e === WS.PanoSettings.Detail3d.VERY_HIGH;
        if (this._gapfiller = t ? void 0 : "", !t) {
            var i = this._frameBufferStorage;
            i.getIDs().forEach(function (e) {
                (e.indexOf("pre_gf_") >= 0 || e.indexOf("tmp_") >= 0) && i.destroy(e)
            }), this._gfRenderables = {}
        }
    },
    getGFShader: function () {
        switch (WS.Renderer3D.GAPFILLER) {
            case "s":
                return WS.FXGapFillerScene;
            case "op2":
                return WS.FXGapFillerOP2
        }
    },
    gapFillerEnabled: function () {
        return void 0 === this._gapfiller && this.testGFSupport(), !!this._gapfiller
    },
    testGFSupport: function () {
        if (WS.Renderer3D.GAPFILLER) {
            var e = this._shaderProgramStorage.inquireShaderProgram(this.getGFShader());
            this._gapfiller = e._compiled ? WS.Renderer3D.GAPFILLER : ""
        } else this._gapfiller = ""
    },
    getGFRenderable: function (e, t, i) {
        var n;
        switch (i) {
            case -1:
                n = e + "pre_gf_";
                break;
            case 0:
                n = e + "post_gf_";
                break;
            default:
                n = "tmp_post_gf_"
        }
        var r = n + "color",
            o = n + "depth";
        if (!this._gfRenderables[r]) {
            var a = this._frameBufferStorage.get(r),
                s = this._frameBufferStorage.get(o),
                c = new WS.CenteredQuadGeometry,
                l = new WS.FXGapFillMaterial(this.getGFShader(), a._textures[0], s._textures[0], t);
            this._gfRenderables[r] = new WS.Mesh(c, l)
        }
        return this._gfRenderables[r]
    },
    getGFResultRenderable: function (e) {
        if (!this._gfResultRenderables[e]) {
            var t = this._frameBufferStorage.get(e + "post_gf_color"),
                i = new WS.CenteredQuadGeometry,
                n = new WS.FXMaterial(WS.FXShaderDesc, !0, t._textures[0]);
            this._gfResultRenderables[e] = new WS.Mesh(i, n)
        }
        return this._gfResultRenderables[e]
    },
    fillGaps: function (e, t) {
        for (var i = WS.Renderer3D.GAPFILL_PASSES[this._gapfiller], n = 0; i > n; n++) {
            var r = (i - n) % 2 === 0 ? 1 : 0,
                o = n > 0 ? 1 - r : -1,
                a = this.getGFRenderable(e, n, o),
                s = r ? "tmp_post_gf_" : e + "post_gf_",
                c = this._frameBufferStorage.get(s + "color"),
                l = this._frameBufferStorage.get(s + "depth");
            l._camMatrix = mat4.create(this._camera._camMatrix), c.bind(), this.clear(!0, !0), this.applyEffect(a, {
                colorMode: t
            }), c.unbind(), l.bind(), this.clear(!0, !0, WS.Renderer3D.DEPTH_CLEARCOLOR), this.applyEffect(a, {
                colorMode: WS.RendererBase.RenderMode.DEPTH
            }), l.unbind()
        }
    },
    updateCanvasObjectDimensions: function () {
        WS.RendererBase.prototype.updateCanvasObjectDimensions.apply(this, arguments), this._frameBufferStorage.updateSizes()
    },
    enableRGBDepthTest: function (e, t) {
        this._rgbDepthTest = e, this._rgbDepthTexture = e ? t : this._dummyTexture
    },
    setRenderColorMode: function (e) {
        this._renderColorMode = e
    },
    setLineWidth: function (e) {
        e === this._lineWidth || F.isIE() || (this._lineWidth = e, this._ctx.lineWidth(e))
    },
    setAndPrepareMaterial: function (e) {
        var t = this._renderColorMode === WS.RendererBase.RenderMode.PICK_3D;
        if (this.setEnableDepthTest(e._depthTest || t), this.setEnableDepthWrite(e._depthWrite || t), this.setEnableBlending(e._transparent && this._renderColorMode === WS.RendererBase.RenderMode.DEFAULT), this.setCullFace(e._cullFace), !this.areAllTexturesUploaded(e)) return !1;
        var i = this.getShaderProgram(e);
        if (!i._compiled) return this._errorHandler && this._errorHandler(), !1;
        this.setShaderProgram(i), this._material = e;
        var n = this._material.configureShader(this);
        return n && this._material._rgbDepthTestSupport && !i._failSafe && this.configureRGBDepthTest(this._material, i), n
    },
    configureRGBDepthTest: function (e, t) {
        t.setUniformValue("uDepthTest", this._rgbDepthTest && e._depthTest), t.setUniformValue("uTexDepth", new WS.TextureValue(this._rgbDepthTexture, 1)), t.setUniformValue("uInvViewX", 1 / this._camera._width), t.setUniformValue("uInvViewY", 1 / this._camera._height)
    },
    setShaderProgram: function (e) {
        this._activeShaderProgram && this._activeShaderProgram !== e && this._activeShaderProgram.deactivateProgram(), this._activeShaderProgram = e.activateProgram()
    },
    setAndPrepareGeometry: function (e) {
        this._geometry = e
    },
    getGlBuffer: function (e, t) {
        return t || 1 !== e.getCountItems() ? this._bufferStorage.inquireBuffer(e) : e._bufferData
    },
    getTexture: function (e) {
        if (!e) return void 0;
        var t = this._textureStorage.inquireTexture(e, WS.GlImageTexture);
        return t
    },
    deleteStorageForRenderable: function (e) {
        WS.RendererBase.prototype.deleteStorageForRenderable.call(this, e), e instanceof WS.Mesh && this.deleteGlBuffersForMesh(e)
    },
    deleteGlBuffersForMesh: function (e) {
        this.deleteGlBuffer(e._geometry._positionBuffer), this.deleteGlBuffer(e._geometry._distanceBuffer), this.deleteGlBuffer(e._material._colorBuffer), this.deleteGlBuffer(e._material._coordBuffer), this.deleteGlBuffer(e._material._indexBuffer)
    },
    deleteGlBuffer: function (e) {
        e && this._bufferStorage.deleteBuffer(e)
    },
    getShaderProgram: function (e) {
        var t = e._shaderProgramDesc,
            i = t.ID;
        return this._shaderPrograms[i] || (this._shaderPrograms[i] = this._shaderProgramStorage.inquireShaderProgram(t)), this._shaderPrograms[i]
    },
    drawGeometry: function () {
        var e, t = this._geometry,
            i = t._indexBuffer,
            n = t._positionBuffer,
            r = this._ctx;
        if (i && n) {
            if (e = t.getCountIndices()) {
                var o = this.getGlBuffer(i);
                o && (o.bindBuffer(), r.drawElements(r[t._primitiveType], e, r[i._itemDataType], 0), o.unbindBuffer())
            }
        } else n && (e = t.getCountPositions(), e && r.drawArrays(r[t._primitiveType], 0, e))
    },
    uploadBoolCapability: function (e, t) {
        var i = this._ctx;
        t ? i.enable(i[e]) : i.disable(i[e])
    },
    setEnableDepthTest: function (e) {
        e !== this._depthTest && (this._depthTest = e, this.uploadBoolCapability("DEPTH_TEST", this._depthTest))
    },
    setEnableDepthWrite: function (e) {
        e !== this._depthWrite && (this._depthWrite = e, this._ctx.depthMask(this._depthWrite))
    },
    setEnableVertexPointSize: function (e) {
        e !== this._enableVertexPointSize && (this._enableVertexPointSize = e)
    },
    setEnableBlending: function (e) {
        e !== this._enableBlending && (this._enableBlending = e, this.uploadBoolCapability("BLEND", this._enableBlending))
    },
    setCullFace: function (e) {
        if (e !== this._cullFace) {
            this._cullFace = e;
            var t = this._ctx;
            if (e === WS.Material.Cull.OFF) t.disable(t.CULL_FACE);
            else switch (t.enable(t.CULL_FACE), t.frontFace(t.CCW), e) {
                case WS.Material.Cull.BACK:
                    t.cullFace(t.BACK);
                    break;
                case WS.Material.Cull.FRONT:
                    t.cullFace(t.FRONT)
            }
        }
    },
    setDefaultBlendFunc: function () {
        var e = this._ctx;
        e.blendFuncSeparate(e.SRC_ALPHA, e.ONE_MINUS_SRC_ALPHA, e.ONE, e.ONE_MINUS_SRC_ALPHA)
    },
    setClearColor: function (e) {
        this._clearColor = e, this._ctx && this._ctx.clearColor(this._clearColor[0], this._clearColor[1], this._clearColor[2], this._clearColor[3])
    },
    clear: function (e, t, i) {
        var n = this._ctx,
            r = void 0 !== e ? e : !0,
            o = void 0 !== t ? t : !0,
            a = r ? n.COLOR_BUFFER_BIT : 0;
        a |= o ? n.DEPTH_BUFFER_BIT : 0, o && this.setEnableDepthWrite(!0);
        var s;
        i && (s = this._clearColor, this.setClearColor(i)), n.clear(a), s && this.setClearColor(s)
    }
}, WS.extend("Renderer3D", "RendererBase"), WS.Renderer3D.DEPTH_CLEARCOLOR = [1, 1, 1, 1], WS.Renderer3D.GAPFILLER = "op2", WS.Renderer3D.GAPFILL_PASSES = {
    op2: 3,
    s: 10
}, WS.PolygonMaterial = function (e) {
    var t = new WS.ArrayBuffer(e, 4);
    WS.ShaderMaterial.call(this, WS.ColorShaderDesc, !0, !1, !1, void 0, void 0, t)
}, WS.PolygonMaterial.prototype = {
    configureShader: function () {
        return !1
    }
}, WS.extend("PolygonMaterial", "ShaderMaterial"), WS.SpriteShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.sprite_vs, WS.shaderSrc.sprite_fs)
}, WS.extend("SpriteShaderDesc", "BasicShaderDesc"), WS.SpriteShaderDesc.ID = "SpriteShader", WS.PickObjectListener = function (e, t, i, n) {
    this._view = e, this._selectionMode = t, this._selection = i, this._alert = n, this._lastSelectedObject = void 0
}, WS.PickObjectListener.prototype = {
    onObjectClick: function (e, t, i, n) {
        var r = void 0 !== e ? e._dataObject : void 0;
        this.onDataObjectClick(r, t, i)
    },
    onObjectHower: function (e, t, i) {
        var n = void 0 !== e ? e._dataObject : void 0;
        this.onDataObjectHower(n, t, i)
    },
    onDataObjectHower: function (e, t, i) {

    },
    onDataObjectClick: function (e, t, i) {
		if (!e) return this._selectionMode === WS.PickObjectListener.SelectionMode.Single && this._lastSelectedObject && (this._lastSelectedObject.unselect(), this._lastSelectedObject = void 0), void this._view.hideRadialMenu();
        if (this._selectionMode === WS.PickObjectListener.SelectionMode.None) return void this._alert.tip("IM_NOT_IN_SELECTIONMODE");
        if (this.isSelectionAllowed(e)) switch (this._selectionMode) {
            case WS.PickObjectListener.SelectionMode.Multi:
                e.toggleSelection();
                break;
            case WS.PickObjectListener.SelectionMode.Single:
                this._lastSelectedObject && this._lastSelectedObject.unselect(), e.select(), this._lastSelectedObject = e;
                break;
            case WS.PickObjectListener.SelectionMode.Menu:
                //
                var _obj = null;
                var _link = null;
                var _type = null;
                var linkTo = null;
                var popupimage = null;
                var _des = null;
                var _uid = null;
				var showname = null;
                var _cst_link_1 = "ws2go.html?v=pv&t=p:default,c:panoramaview,m:t&pv=pv1&pv1=vt:p,u:";
                var _cst_link_2 = ",p:6.28319,t:0.00000&p=lhc-full-revision";
                
				if (e._class == "Scan"){
					_uid = e._UUID;
                    popupimage = "ws2go-data/project/lhc-full-revision/scans/" + _uid + "-color-512.jpg";
                    _link = "ws2go.html?v=pv&t=p:default,c:panoramaview,m:t&pv=pv1&pv1=vt:p,u:" + _uid + ",p:6.28319,t:0.00000&p=lhc-full-revision";
                    linkTo = _link;
                    $("._t_description").html(e._displayName);
                    $(".myimage").attr("src", popupimage);
                    $(".mlink").attr("href", linkTo);
					this._view.showRadialMenu(e, t, i);
					//document.getElementById("overviewpopup").style.display = "block";


				}else if (e._class == "Annotation"){				

                $("#myimage").attr("src", null);
                $("#mlink").attr("href", null);
                try {
                    //_obj = JSON.parse(mapping[e._UUID]);
                    _obj = mapping[e._UUID];
					_link = _obj.link_to_target;
					_type = _obj.type;
                    _des = _obj.description;
                    _uid = _obj.uid_chua_annotation;
					showname = _obj.displayname;
                    popupimage = "ws2go-data/project/lhc-full-revision/scans/" + _obj.image_link + ".jpg";
                    if (_link != null && _link != 'undefined') {
                        linkTo = _link;
                    } else {
                        linkTo = _cst_link_1 + _uid + _cst_link_2;
                    }
                    if (_obj.image_link == null || _obj.image_link == "") {
                        popupimage = "ws2go-data/project/lhc-full-revision/scans/" + _uid + "-color-512.jpg";
                    }
					$("._t_title").html(showname);
					$("._t_description").html(_des);
                    $(".myimage").attr("src", popupimage);
                    $(".mlink").attr("href", linkTo);
					//document.getElementById("panoramapopup").style.display = "block";
					currentradialmenu = this._view;
                    this._view.showRadialMenu(e, t, i);
					if (showname =='Khu lu tr'){
						document.getElementById("vertical-menu").style.display = "block";

						document.getElementById("panoramapopup").style.display = "none";
					}else
					{
						document.getElementById("vertical-menu").style.display = "none";
						document.getElementById("panoramapopup").style.display = "block";
					}						
					
                }
                catch (err) {

                    console.log("note::view", "Description is not json format");
                    _uid = e._UUID;
                    popupimage = "ws2go-data/project/lhc-full-revision/scans/" + _uid + "-color-512.jpg";
                    _link = "ws2go.html?v=pv&t=p:default,c:panoramaview,m:t&pv=pv1&pv1=vt:p,u:" + _uid + ",p:6.28319,t:0.00000&p=lhc-full-revision";
                    linkTo = _link;
                    $("._t_description").html(e._displayName);
                    $(".myimage").attr("src", popupimage);
                    $(".mlink").attr("href", linkTo);
					//document.getElementById("panoramapopup").style.display = "block";

                    this._view.showRadialMenu(e, t, i);
                }
				}else{}

        }
    },
    isSelectionAllowed: function (e) {
        var t = ["Scan", "Annotation", "Measurement", "TempMeasurement", "Orthophoto"],
            i = this,
            n = t.some(function (t) {
                var n = t.toLowerCase();
                return i._view._allowedSelections && -1 !== i._view._allowedSelections.indexOf(n) && i._selection.getSelection(t).contains(e)
            });
        return n
    },
    onObjectsSetSelected: function (e, t) {
        var i = {};
        e.forEach(F.proxy(function (e) {
            var t = e._dataObject;
            if (this.isSelectionAllowed(t)) {
                var n = t.selection()._identifier;
                i[n] = i[n] || [], i[n].push(t)
            }
        }, this));
        for (var n in i) {
            var r = i[n],
                o = this._selection.getSelection(n);
            t ? o.selectMulti(r) : o.unselectMulti(r)
        }
    },
    onObjectsSelect: function (e) {
        this.onObjectsSetSelected(e, !0)
    },
    onObjectsUnselect: function (e) {
        this.onObjectsSetSelected(e, !1)
    },
    onObjectDblClick: function (e, t, i, n) {
        var r = void 0 !== e ? e._dataObject : void 0;
        this.onDataObjectDblClick(r, t, i, n)
    },
    onDataObjectDblClick: function (e, t, i, n) {

        if (this._view.hideRadialMenu(), e)
            if (e instanceof WS.Scan && this._view._changeScanAllowed && (this._view instanceof WS.OverviewMap || !this._view.isObjectRoot(e))) this._view.trigger("showObjects", [
                [e], "pano/3d"
            ]);
            else if (e instanceof WS.Measurement && n && n._list[0] instanceof WS.ClickableSpriteRenderable) {
                var r = n._list[0]._clickId,
                    o = {
                        object: e,
                        root: e._pointScans[r],
                        rootType: "scan",
                        lookAt: e._pointsGlobal[r]
                    };
                this._view.trigger("focusOn", [o, "pano/3d"])
            } else if (this._view._type === WS.PanoramaView.type && this._view._changeScanAllowed) {
                var a = {
                    object: e
                };
                this._view.trigger("focusOn", [a, "pano/3d"])
            }

    },
    onObjectDragStart: function (e, t, i) {
        this._view.hideRadialMenu(), e._list[0].setDirect(!0), e._list[0].dragStart(t, i)
    },
    onObjectDragMove: function (e, t, i, n, r) {
        e._list[0].dragMove(t - n, i - r)
    },
    onObjectDragStop: function (e, t, i) {
        e._list[0].setDirect(!1), e._list[0].dragStop(t, i)
    },
    getRefSystem: function () {
        var e = this._view;
        return e.instanceOf(WS.PanoramaView) ? e._root : e.instanceOf(WS.OverviewMap) ? e._mapObject : void 0
    }
}, WS.extend("PickObjectListener"), WS.PickObjectListener.SelectionMode = {
    None: 0,
    Single: 1,
    Multi: 2,
    Menu: 3
}, WS.TextureShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.texture_vs, WS.shaderSrc.texture_fs)
}, WS.extend("TextureShaderDesc", "BasicShaderDesc"), WS.TextureShaderDesc.ID = "TextureShader", WS.FXShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.fx_vs, WS.shaderSrc.fx_fs)
}, WS.extend("FXShaderDesc", "BasicShaderDesc"), WS.FXShaderDesc.ID = "FXShader", WS.FXGapFiller = function (e) {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.fx_vs, e)
}, WS.extend("FXGapFiller", "BasicShaderDesc"), WS.FXGapFillerScene = function () {
    WS.FXGapFiller.call(this, WS.shaderSrc.fxgapfiller_scene_fs)
}, WS.extend("FXGapFillerScene", "FXGapFiller"), WS.FXGapFillerScene.ID = "FXGapFillerScene", WS.FXGapFillerOP2 = function () {
    WS.FXGapFiller.call(this, WS.shaderSrc.fxgapfiller_op2_fs)
}, WS.extend("FXGapFillerOP2", "FXGapFiller"), WS.FXGapFillerOP2.ID = "FXGapFillerOP2", WS.Point3d = function (e, t, i, n, r) {
    this._class = "Point3d", this._UUID = F.generateUUID(), this._estimatedPosition = e, this._localAngles = t, this._refSystem = i, this._takenInView = n, this._3d = r || !1;
    var o = n._type === WS.OverviewMap.type;
    this._positionLocal = void 0, this._positionGlobal = r || o ? vec3.create(e) : void 0, this._pointState = r ? WS.Point3d.PointState.Valid : o ? WS.Point3d.PointState.ValidXY : WS.Point3d.PointState.Unknown
}, WS.Point3d.prototype = {
    createRenderable: function (e) {
        switch (e._type) {
            case WS.PanoramaView.type:
            case WS.OverviewMap.type:
                return this.createRenderableForView(e)
        }
    },
    createRenderableForView: function (e) {
        var t = e._type === WS.OverviewMap.type,
            i = new WS.PickPositionRenderable(t);
        i.setDataObject(this), i.addToLayer(WS.Layer.LayerIDs.TEMP);
        var n = this;
        return i.update = function () {
            var t = n.calcPositionInRefSystem(e._trafoView, !0);
            i.setTranslation(t), i.setPointState(n._pointState)
        }, i.update(), i
    },
    getTrafoGlobal: function () {
        return [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, this._positionGlobal[0], this._positionGlobal[1], this._positionGlobal[2], 1]
    },
    getTrafoLocal: function () {
        return [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, this._positionLocal[0], this._positionLocal[1], this._positionLocal[2], 1]
    },
    calcPositionInRefSystem: function (e, t) {
        var i = this._positionGlobal || t && this._estimatedPosition || [];
        return mat4.posInRefSystem(i, e)
    }
}, WS.extend("Point3d"), WS.Point3d.PointState = {
    Valid: 0,
    Invalid: 1,
    Unknown: 2,
    Free: 3,
    ValidXY: 4
}, WS.TextureMaterial = function (e, t, i, n, r) {
    this._alpha = void 0 !== n ? n : 1, i = void 0 !== i ? i : this._alpha < 1, WS.ShaderMaterial.call(this, WS.TextureShaderDesc, i, !0, !1, [e], t, void 0, r), this._rgbDepthTestSupport = !0
}, WS.TextureMaterial.prototype = {
    configureShader: function (e) {
        var t = e._geometry,
            i = e.getShaderProgram(this);
        i.setAttributeValue("aVertexPosition", e.getGlBuffer(t._positionBuffer)), i.setUniformValue("uModelMatrix", e.getModelMatrix()), i.setUniformValue("uViewProjectionMatrix", e._camera._camMatrix), i.setUniformValue("uAlpha", this._alpha), i.setAttributeValue("aVertexTextureCoords", e.getGlBuffer(this._coordBuffer));
        var n = e.getMaterialTextures(this),
            r = void 0 !== n && n.length > 0 ? n[0] : void 0;
        return r && !r.isImageUploaded() ? !1 : (i.setUniformValue("uTex0", new WS.TextureValue(r, 0)), !0)
    }
}, WS.extend("TextureMaterial", "ShaderMaterial"), WS.SetIconModeVisitor = function (e) {
    this._iconMode = e
}, WS.SetIconModeVisitor.prototype = {
    visit: function (e) {
        return e.setIconMode && e.setIconMode(this._iconMode), !0
    }
}, WS.extend("SetIconModeVisitor", "VisitorBase"), WS.ShowBoxVisitor = function (e) {
    this._show = e
}, WS.ShowBoxVisitor.prototype = {
    visit: function (e) {
        return e.setShowBox && e.setShowBox(this._show), !0
    }
}, WS.extend("ShowBoxVisitor", "VisitorBase"), WS.ShowPolylineVisitor = function (e) {
    this._show = e
}, WS.ShowPolylineVisitor.prototype = {
    visit: function (e) {
        return e.setShowPolyline && e.setShowPolyline(this._show), !0
    }
}, WS.extend("ShowPolylineVisitor", "VisitorBase"), WS.ScanColorVisitor = function () {
}, WS.ScanColorVisitor.prototype = {
    visit: function (e) {
        return e instanceof WS.ScanMapRenderable && e.updateColor(), !0
    }
}, WS.extend("ScanColorVisitor", "VisitorBase"), WS.ScanLabelsVisitor = function (e) {
    this._show = e
}, WS.ScanLabelsVisitor.prototype = {
    visit: function (e) {
        return e.setHideLabelBySetting && e.setHideLabelBySetting(!this._show), !0
    }
}, WS.extend("ScanLabelsVisitor", "VisitorBase"), WS.UpdateLanguageVisitor = function () {
}, WS.UpdateLanguageVisitor.prototype = {
    visit: function (e) {
        return e.updateLanguage && e.updateLanguage(), !0
    }
}, WS.extend("UpdateLanguageVisitor", "VisitorBase"), WS.UpdateUnitVisitor = function () {
}, WS.UpdateUnitVisitor.prototype = {
    visit: function (e) {
        return e.updateUnit && e.updateUnit(), !0
    }
}, WS.extend("UpdateUnitVisitor", "VisitorBase"), WS.ColorMaterial = function (e) {
    var t = e._bufferData[3],
        i = 1 > t;
    WS.ShaderMaterial.call(this, WS.ColorShaderDesc, i, !0, !1, void 0, void 0, e), this._rgbDepthTestSupport = !0
}, WS.ColorMaterial.prototype = {
    configureShader: function (e) {
        var t = e._camera,
            i = e._geometry,
            n = e.getShaderProgram(this),
            r = e.getModelMatrix(),
            o = t._camMatrix;
        return n.setAttributeValue("aVertexPosition", e.getGlBuffer(i._positionBuffer)), n.setAttributeValue("aColor", e.getGlBuffer(this._colorBuffer)), n.setUniformValue("uModelMatrix", r), n.setUniformValue("uViewProjectionMatrix", o), !0
    }
}, WS.extend("ColorMaterial", "ShaderMaterial"), WS.FXMaterial = function (e, t, i, n) {
    WS.ShaderMaterial.call(this, e, t, !1, !1, void 0, WS.FXMaterial.TexBuffer), this._colorTexValue = new WS.TextureValue(i, 0), this._depthTexValue = n ? new WS.TextureValue(n, 1) : void 0
}, WS.FXMaterial.prototype = {
    configureShader: function (e) {
        {
            var t = e._geometry,
                i = e.getShaderProgram(this);
            this._colorTexValue._texture
        }
        return i.setAttributeValue("aVertexPosition", e.getGlBuffer(t._positionBuffer, !0)), i.setAttributeValue("aVertexTextureCoords", e.getGlBuffer(this._coordBuffer)), i.setUniformValue("uTex0", this._colorTexValue), !0
    },
    configureRenderer2d: function () {
    }
}, WS.extend("FXMaterial", "ShaderMaterial"), WS.FXMaterial.TexBuffer = new WS.ArrayBuffer([0, 0, 0, 1, 1, 0, 1, 1], 2), WS.FXGapFillMaterial = function (e, t, i, n) {
    WS.FXMaterial.call(this, e, !1, t, i), this._gfPass = n
}, WS.FXGapFillMaterial.prototype = {
    configureShader: function (e) {
        if (!WS.FXMaterial.prototype.configureShader.call(this, e)) return !1;
        var t = e.getShaderProgram(this),
            i = this._colorTexValue._texture,
            n = e._camera,
            r = n._fovY * Math.PI / 180,
            o = 2 * Math.tan(.5 * r),
            a = o * n._width / n._height;
        t.setUniformValue("uDepthToFrustumSize", [a, o]);
        var s = i.getWidth(),
            c = i.getHeight(),
            l = 1 / s,
            h = 1 / c;
        if (t.setUniformValue("uTexSize", [s, c]), t.setUniformValue("uTexDepth", this._depthTexValue), t.setUniformValue("uInterpolate", e._renderColorMode === WS.RendererBase.RenderMode.DEFAULT), t.setUniformValue("uDepthColor", e._renderColorMode === WS.RendererBase.RenderMode.DEPTH), this._shaderProgramDesc === WS.FXGapFillerScene) {
            var d = this._gfPass % 2 === 0;
            t.setUniformValue("uPixOffset", d ? [l, 0] : [0, h])
        } else t.setUniformValue("uInvTexSize", [l, h]);
        return !0
    }
}, WS.extend("FXGapFillMaterial", "FXMaterial"), WS.LoginService = function (e, t, i, n, r, o) {
    F.LoginServiceBase.call(this, e, t, i, n), this._localStorage = r;
    var a = this;
    o.addEventListener("storage", function (e) {
        "logout" === e.key && a.resetMe()
    }, !1)
}, WS.LoginService.prototype = {
    logout: function () {
        var e = this,
            t = F.LoginServiceBase.prototype.logout.call(this);
        return t.then(function () {
            var t = 1 - parseInt(e._localStorage.getItem("logout") || 0);
            e._localStorage.setItem("logout", t)
        }), t
    },
    getDomain: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me ? e._me.Domain : null
        })
    },
    isUser: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me && e._me.Roles ? e._me.Roles.some(function (e) {
                return 3 === e.Id
            }) : !1
        })
    },
    isProjectManager: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me && e._me.Roles ? e._me.Roles.some(function (e) {
                return 1 === e.Id
            }) : !1
        })
    },
    isDomainAdmin: function () {
        var e = this;
        return this.getMe().then(function () {
            return e._me && e._me.Roles ? e._me.Roles.some(function (e) {
                return 2 === e.Id
            }) : !1
        })
    },
    isProjectManagerorDomainAdmin: function () {
        return Q.all([this.isProjectManager(), this.isDomainAdmin()]).then(function (e) {
            return e.some(function (e) {
                return e
            })
        })
    },
    getMe: function (e) {
        return WS._2GO ? (this._me = void 0, this._meDefer || (this._meDefer = Q.defer(), this._meDefer.resolve()), this._meDefer.promise) : F.LoginServiceBase.prototype.getMe.call(this, e)
    }
}, WS.extend("LoginService", "LoginServiceBase"), WS.UserService = function (e, t, i, n, r, o) {
    F.UserServiceBase.call(this, e, t, i, n, r, o, WS.User), this._filter = function (e) {
        return e._active
    }
}, WS.extend("UserService", "UserServiceBase"), WS.User = function (e) {
    F.UserBase.call(this, e), this._groups = [], this._roles = [], this._groupids = null, this._roleids = null
}, WS.User.prototype = {
    readJson: function (e) {
        F.UserBase.prototype.readJson.call(this, e), this._active = e.Active, null !== e.GroupIds && (this._groupids = e.GroupIds), null !== e.RoleIds && (this._roleids = e.RoleIds)
    },
    writeJson: function () {
        var e = F.UserBase.prototype.writeJson.call(this);
        return e.Class = "User", e
    }
}, WS.extend("User", "UserBase"), WS.User.getStringIDForKey = function (e) {
    switch (e) {
        case "_firstname":
        case "_lastname":
        case "_middlename":
        case "_units":
        case "_language":
            return "FE" + e.toUpperCase();
        case "_areaunit":
            return "FE_AREA_UNIT";
        case "_angleUnit":
            return "FE_ANGLE_UNIT";
        case "_coordSystem":
            return "FE_CS"
    }
    return ""
}, WS.Usersettings = function () {
    F.UserSettingsBase.call(this)
}, WS.Usersettings.prototype = {
    writeJson: function () {
        var e = F.UserSettingsBase.prototype.writeJson.call(this);
        return e.Class = "Usersettings", e
    }
}, WS.extend("Usersettings", "UserSettingsBase"), WS.UserSettingsTask = function (e, t, i, n, r, o, a, s, c) {
    WS.Task.call(this, e), this._userService = t, this._accountService = i, this._unitService = n, this._loginService = r, this._localeService = o, this._error = a, this._alert = s, this._localUserSettings = c, this._plugHandle = void 0, this._description = [{
        caption: "TC_EDIT_SETTINGS",
        optional: !0,
        description: "TD_EDIT_SETTINGS",
        selectPageClass: "useraccount",
        widget: '<p ng-show="changesAvailable()" style="font-weight: bold;">{{\'TD_CHANGES\' | i18n}}</p><ul><li ng-repeat="(key, value) in input.user._changes">{{getKey(key)}}: {{value}}</li><li ng-repeat="(key, value) in input.settings._changes">{{getKey(key)}}: {{mapValue(value)}}</li><li ng-show="input.requestPassword">{{\'FE_REQUEST_PWD_RESET\' | i18n}}</li></ul>',
        icon: WS.Icons.TaskSection.configure
    }]
}, WS.UserSettingsTask.prototype = {
    setup: function (e) {
        this.$scope = e;
        var t = this;
        this.provideFemalePlug("ObjectEdit", ["editObject"]), this._plugHandle = this.getFemalePlug("ObjectEdit"), this._connectorService.getMalePlugProviders("ObjectEdit").forEach(function (e) {
            t.connect(t._plugHandle, e)
        }), e.changesAvailable = function () {
            return t.changedUser() || t.changedSettings() || t.changedPassword()
        }, e.getKey = function (e) {
            return t._localeService.translate(WS.User.getStringIDForKey(e))
        }, e.mapValue = function (e) {
            for (var i = t._localeService.getLanguages(), n = 0, r = i.length; r > n; n++)
                if (i[n].id === e) return i[n].caption;
            switch (e) {
                case "gon":
                    return t._localeService.translate("FE_GON");
                case "deg":
                    return t._localeService.translate("FE_DEGREE")
            }
            return e
        }
    },
    execute: function (e) {
        if (WS._2GO) return this._localUserSettings.update(e.settings._changes._language, e.settings._changes._units, e.settings._changes._areaunit, e.settings._changes._angleUnit, e.settings._changes._coordSystem), Q.resolve();
        var t = [],
            i = this;
        if (void 0 !== e.settings._changes._language && this._localeService.setLanguage(e.settings._changes._language), void 0 !== e.settings._changes._units && this._unitService.setLengthUnit(e.settings._changes._units), void 0 !== e.settings._changes._areaunit && this._unitService.setAreaUnit(e.settings._changes._areaunit), void 0 !== e.settings._changes._angleUnit && this._unitService.setAngleUnit(e.settings._changes._angleUnit), void 0 !== e.settings._changes._coordSystem && this._unitService.setCS(e.settings._changes._coordSystem), this.changedUser()) {
            var n = this._accountService.updateMe(e.user).then(function () {
                i._loginService.refresh()
            }).fail(function (e) {
                i._error.isExceptionType(e, "InvalidRequestParameterException") && i._alert.errorObj(e, F.AlertServiceBase.DELAY_SHORT)
            });
            t.push(n)
        }
        if (this.changedSettings()) {
            var r = this._accountService.updateSettings(e.settings).then(function () {
                i._loginService.refresh()
            }).fail(function (e) {
                i._error.isExceptionType(e, "InvalidRequestParameterException") && i._alert.errorObj(e, F.AlertServiceBase.DELAY_SHORT)
            });
            t.push(r)
        }
        if (this.changedPassword()) {
            var o = this._accountService.resetPassword(e.user._username).then(function () {
                i._alert.message("IM_EMAIL_SENT")
            });
            t.push(o)
        }
        return Q.all(t)
    },
    teardown: function () {
        this._plugHandle.disconnect(), this._result._navigateTo = this._argument._lastPage
    },
    editObject: function (e) {
        var t = this.$scope;
        e instanceof WS.User ? t.input.user = e : e instanceof WS.Usersettings ? t.input.settings = e : void 0 !== e.requestPassword && t.$apply(function () {
            t.input.requestPassword = e.requestPassword
        })
    },
    queryTaskLaunch: function (e, t, i) {
        return e === this._panel && t === this._category.id && i === this._id
    },
    changedUser: function () {
        var e = this.$scope.input.user;
        return e && e._changes instanceof Object && Object.keys(e._changes).length
    },
    changedSettings: function () {
        var e = this.$scope.input.settings;
        return e && e._changes instanceof Object && Object.keys(e._changes).length
    },
    changedPassword: function () {
        return this.$scope.input.requestPassword
    }
}, WS.extend("UserSettingsTask", "Task"), WS.WSUserLocaleService = function (e, t, i, n) {
    this._domainSettings = n, this._hasSet = !1, F.UserLocaleService.call(this, e, t, i), this.setDefaultLanguage(!1)
}, WS.WSUserLocaleService.prototype = {
    setDefaultLanguage: function (e) {
        var t = this;
        this._domainSettings.get(!0).then(function (i) {
            (e || !t._hasSet) && t.setLanguage(i._language, !0)
        }, function () {
            (e || !t._hasSet) && F.UserLocaleService.prototype.setDefaultLanguage.call(t, !1)
        }).done()
    },
    setLanguage: function (e, t) {
        t || (this._hasSet = !0), F.UserLocaleService.prototype.setLanguage.call(this, e, t)
    }
}, WS.extend("WSUserLocaleService", "UserLocaleService"), F.DI().redefineService("user", WS.UserService, "@serializer", "@error", "@login", "@selection", "@plug", "$resource"), F.DI().redefineService("login", WS.LoginService, "@error", "$http", "@encryption", "@plug", "$localStorage", "$window"), F.DI().config(function () {
    this.redefineService("locale", WS.WSUserLocaleService, "@script", "@plug", "@login", "@domainsettings")
}), F.DI().config("@serializer", "@user", WS.userConfigSerializer = function (e, t) {
    e.registerClass("User", function () {
        return t.getNew()
    })
}), F.DI().config("@task", "@login", WS.userRoleConfigValidators = function (e, t) {
    e.addValidator("user", function () {
        var e = "EM_NO_USER";
        return t.isUser().then(function (t) {
            return t ? void 0 : e
        }, function () {
            return e
        })
    }), e.addValidator("admin", function () {
        var e = "EM_NO_ADMIN";
        return t.isProjectManager().then(function (t) {
            return t ? void 0 : e
        }, function () {
            return e
        })
    }), e.addValidator("superuser", function () {
        var e = "EM_NO_SUPERUSER";
        return t.isDomainAdmin().then(function (t) {
            return t ? void 0 : e
        }, function () {
            return e
        })
    })
}), F.DI().config("@task", function (e) {
    e.registerTaskFactory("default", "settings", "myaccount", WS.UserSettingsTask, "@plug", "@user", "@account", "@unit", "@login", "@locale", "@error", "@alert", "?@localusersettings")
}), WS.PMException = new Error("EM_NO_ADMIN"), WS.PMException._type = "AuthorizationException", WS.DAException = new Error("EM_NO_SUPERUSER"), WS.DAException._type = "AuthorizationException", WS.UnitService = function (e, t, i) {
    this._domainSettings = i, this._hasSet = !1, this._coordSystem = WS.UnitService.CS.PROJECT, F.UnitServiceBase.call(this, t), this.setDefaultUnits(!1);
    var n = this;
    if (e) {
        var r = function () {
                e.getSettings().then(function (e) {
                    i.get(!0).then(function (t) {
                        n.updateUnitsBySettings(e, t)
                    }, function () {
                        n.updateUnitsBySettings(e, void 0)
                    }).done()
                }).done()
            },
            o = function () {
                n.setDefaultUnits(!0)
            };
        e.subscribe("login", r), e.subscribe("logout", o), e.subscribe("update", r)
    }
}, WS.UnitService.prototype = {
    updateUnitsBySettings: function (e, t) {
        e && (t && t._overrideLengthUnit ? this.setLengthUnit(t._lengthUnit) : e.Units && this.setLengthUnit(e.Units), t && t._overrideAreaUnit ? this.setAreaUnit(t._areaUnit) : e.Areaunit && this.setAreaUnit(e.Areaunit), t && t._overrideAngleUnit ? this.setAngleUnit(t._angleUnit) : e.AngleUnit && this.setAngleUnit(e.AngleUnit), e.CoordSystem && this.setCS(e.CoordSystem), this.trigger("updateSettings", ["unit", [this._lengthUnit, this._areaUnit, this._angleUnit, this._coordSystem]]))
    },
    setDefaultUnits: function (e) {
        var t = this;
        this._domainSettings.get(!0).then(function (i) {
            var n = e || !t._hasSet;
            (n || i._overrideLengthUnit) && t.setLengthUnit(i._lengthUnit), (n || i._overrideAreaUnit) && t.setAreaUnit(i._areaUnit), (n || i._overrideAngleUnit) && t.setAngleUnit(i._angleUnit), n && t.setCS(WS.UnitService.CS.PROJECT), t.trigger("updateSettings", ["unit", [t._lengthUnit, t._areaUnit, t._angleUnit, t._coordSystem]])
        }, function () {
            (e || !t._hasSet) && (t.removeInternal(), t.trigger("updateSettings", ["unit", [t._lengthUnit, t._areaUnit, t._angleUnit, t._coordSystem]]))
        }).done()
    },
    setLengthUnit: function (e) {
        this._hasSet = !0, F.UnitServiceBase.prototype.setLengthUnit.call(this, e)
    },
    setAreaUnit: function (e) {
        this._hasSet = !0, F.UnitServiceBase.prototype.setAreaUnit.call(this, e)
    },
    setAngleUnit: function (e) {
        this._hasSet = !0, F.UnitServiceBase.prototype.setAngleUnit.call(this, e)
    },
    setCS: function (e) {
        this._hasSet = !0, this._coordSystem = e
    },
    isCustomCS: function () {
        return this._coordSystem === WS.UnitService.CS.PROJECT
    },
    removeInternal: function () {
        F.UnitServiceBase.prototype.removeInternal.call(this), this.setCS(WS.UnitService.CS.PROJECT)
    }
}, WS.extend("UnitService", "UnitServiceBase"), WS.UnitService.SupportedLengthUnitsMetric = [
    ["m", "m"],
    ["dm", "dm"],
    ["cm", "cm"],
    ["mm", "mm"]
], WS.UnitService.SupportedLengthUnitsImperial = [
    ["yd", "yd"],
    ["ft", "ft"],
    ["in", "in"]
], WS.UnitService.SupportedLengthUnitsSurvey = [
    ["ydUS", "yd US"],
    ["ftUS", "ft US"],
    ["inUS", "in US"]
], WS.UnitService.SupportedAreaUnitsMetric = [
    ["ha", "ha"],
    ["a", "a"],
    ["m", "m"],
    ["dm", "dm"],
    ["cm", "cm"],
    ["mm", "mm"]
], WS.UnitService.SupportedAreaUnitsImperial = [
    ["ac", "ac"],
    ["yd", "yd"],
    ["ft", "ft"],
    ["in", "in"]
], WS.UnitService.SupportedAreaUnitsSurvey = [
    ["ydUS", "yd US"],
    ["ftUS", "ft US"],
    ["inUS", "in US"]
], WS.UnitService.SupportedAngleUnits = [
    ["deg", "FE_DEGREE"],
    ["gon", "FE_GON"]
], WS.UnitService.CS = {
    PROJECT: "project",
    GLOBAL: "global",
    LOCAL: "local"
}, WS.UnitService.SupportedCSs = [
    [WS.UnitService.CS.PROJECT, "FE_PROJ_COORDS_IF"],
    [WS.UnitService.CS.GLOBAL, "FE_GLOBAL_COORDS"]
], F.DI().redefineService("unit", WS.UnitService, "?@login", "@plug", "@domainsettings"), WS.ProjectService = function (e, t, i, n, r, o, a, s) {
    F.ProjectServiceBase.call(this, e, t, i, n, r, o, a, s, WS.Project), WS._2GO && (this._clientSingle = this._resource("ws2go-data/project/:id/project.json", {}, {
        read: {
            method: "GET",
            params: {}
        }
    }), this._clientList = this._resource("ws2go-data/project/projects.json", {}, {
        read: {
            method: "GET",
            params: {},
            isArray: !0
        }
    })), this._projectCache = {};
    var c = this;
    i.subscribe("login", function () {
        c.removeInternal()
    })
}, WS.ProjectService.prototype = {
    getAll: function (e, t) {
        if (WS._2GO) {
            var i = this,
                n = Q.defer();
            return this._clientList.read({}, function (e) {
                var r = e.map(function (e) {
                    var t = Q.defer();
                    return i._clientSingle.read({
                        id: e
                    }, function (i) {
                        i.Name = e, t.resolve(i)
                    }, function () {
                        t.resolve(void 0)
                    }), t.promise
                });
                Q.all(r).then(function (e) {
                    e = e.filter(function (e) {
                        return !!e
                    }), i.updateInternalMultiple(e);
                    var r = t || function () {
                        return !0
                    };
                    n.resolve(i._entities.filter(r))
                })
            }, this._error.restHandler(n)), n.promise
        }
        return F.ProjectServiceBase.prototype.getAll.call(this, e, t)
    },
    getByID: function (e, t, i, n) {
        return i = i || WS._2GO, F.ProjectServiceBase.prototype.getByID.call(this, e, t, i, n)
    },
    updateImage: function (e, t, i) {
        var n = Q.defer(),
            r = WS.getMimeType(t),
            o = "/data/project/" + e._name + "/project-image/" + t;
        return this.$http({
            method: "PUT",
            url: o,
            data: i,
            headers: {
                "Content-Type": r
            }
        }).success(function () {
            n.resolve()
        }).error(this._error.httpHandler(n)), n.promise
    },
    remove: function (e, t) {
        return F.ProjectServiceBase.prototype.remove.call(this, e, t).fail(function (e) {
            throw "IntegrityViolationException" === e._type && (e.message = "EM_JOB_DEL_PROJ"), e
        })
    },
    getAllWithStates: function (e, t) {
        return this.getAll(t, function (t) {
            return !!F.findFirst(e, t._uploadState) || !!F.findFirst(e, t._state)
        })
    },
    getCurrentProject: function () {
        var e = this._currentProject;
        return e ? (this._projectCache[e] || (this._projectCache = {}, this._projectCache[e] = this.getByID(e)), this._projectCache[e]) : Q.reject(new Error("EM_NO_PROJECT"))
    },
    isCurrentProject: function (e) {
        return this.isCurrent(e._name)
    },
    removeInternal: function () {
        F.ProjectServiceBase.prototype.removeInternal.call(this), this._projectCache = {}
    },
    canShowObjectInPano: function (e) {
        return e.canBeShownInView("panorama") ? this.getCurrentProject().then(function (e) {
            return e.hasScan()
        }, function () {
            return !1
        }) : Q.resolve(!1)
    },
    canShowObjectInMap: function (e) {
        return e.canBeShownInView("map") ? this.getCurrentProject().then(function (e) {
            return e.hasOverviewMap()
        }, function () {
            return !1
        }) : Q.resolve(!1)
    },
    getUsedProjectIds: function () {
        var e = Q.defer(),
            t = {
                method: "GET",
                url: "/projectname/"
            };
        return this.$http(t).success(function (t) {
            e.resolve(t)
        }).error(this._error.httpHandler(e)), e.promise
    }
}, WS.extend("ProjectService", "ProjectServiceBase"), WS.Project = function (e) {
    F.ProjectBase.call(this, e), this._description = void 0, this._keywords = void 0, this._latitude = void 0, this._longitude = void 0, this._image = void 0, this._public = void 0, this._featured = void 0, this._exportVersion = void 0, this._enable3D = void 0, this._type = void 0, this._trafo = void 0, this._trafoName = void 0, this._uploadState = void 0, this._numberOfScans = void 0, this._oldestScanRecordingTime = void 0, this._newestScanRecordingTime = void 0, this._newestScanModificationTime = void 0, this._workspaceModificationTime = void 0, this._uploader = void 0, this._simple3DEnabled = void 0, this._uploadDate = void 0, this._creator = void 0, this._creationDate = void 0, this._state = void 0, this._groupids = null, this._pointClouds = void 0, this._imageUrl = void 0, this._newImage = void 0, this._storageSize = void 0
}, WS.Project.prototype = {
    readJson: function (e) {
        F.ProjectBase.prototype.readJson.call(this, e), this._description = e.Description, this._keywords = e.Keywords, this._latitude = e.Latitude, this._longitude = e.Longitude, this._image = e.Image, this._public = e.Public, this._featured = e.Featured, this._exportVersion = e.ExportVersion, this._enable3D = e.Enable3D, this._type = e.Type, this._trafo = !e.Trafo || mat4.equal(e.Trafo, [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]) ? void 0 : e.Trafo, this._trafoName = e.TrafoName, this._uploadState = e.UploadState, this._numberOfScans = e.NumberOfScans, this._oldestScanRecordingTime = e.OldestScanRecordingTime, this._newestScanRecordingTime = e.NewestScanRecordingTime, this._newestScanModificationTime = e.NewestScanModificationTime, this._workspaceModificationTime = e.WorkspaceModificationTime, this._uploader = e.Uploader, this._simple3DEnabled = e.Simple3DEnabled, this._uploadDate = e.UploadDate, this._creator = e.Creator, this._creationDate = e.CreationDate, this._state = e.State, this._pointClouds = e.PointClouds, null !== e.GroupIds && (this._groupids = e.GroupIds), WS._2GO && (this._type === WS.Project.Type.INC ? this._state = "Published" : (this._type = WS.Project.Type.WSC, this._uploadState = "Completed", this._simple3DEnabled = !0), this._enable3D = !0, this._pointClouds = {}), this.setImgUrl()
    },
    writeJson: function () {
        var e = F.ProjectBase.prototype.writeJson.call(this);
        return e.Class = "Project", e.Description = this._description, e.Keywords = this._keywords, e.Latitude = this._latitude, e.Longitude = this._longitude, e.Image = this._image, e.Public = this._public, e.Featured = this._featured, e.ExportVersion = this._exportVersion, e.Enable3D = this._enable3D, e.Type = this._type, e.Trafo = this._trafo ? this._trafo : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], e.TrafoName = this._trafoName, e.UploadState = this._uploadState, e.NumberOfScans = this._numberOfScans, e.OldestScanRecordingTime = this._oldestScanRecordingTime, e.NewestScanRecordingTime = this._newestScanRecordingTime, e.NewestScanModificationTime = this._newestScanModificationTime, e.WorkspaceModificationTime = this._workspaceModificationTime, e.Uploader = this._uploader, e.Simple3DEnabled = this._simple3DEnabled, e.UploadDate = this._uploadDate, e.Creator = this._creator, e.CreationDate = this._creationDate, e.State = this._state, e
    },
    getTrimmedDescription: function (e) {
        if (this._description.length <= e) return this._description;
        var t = this._description.substring(0, e),
            i = t.lastIndexOf(" ");
        return t = t.substring(0, i + 1), t += "[...]"
    },
    setImgUrl: function () {
        this._imageUrl = WS._2GO ? "ws2go-data/project/" + this._name + "/project.jpg" : "data/project/" + this._name + "/project-image?r=" + this._image
    },
    getImage: function () {
        return this._imageUrl
    },
    addGroups: function (e) {
        return F.DI().getService("admin").addRelatedGroups(this, e)
    },
    removeGroups: function (e) {
        return F.DI().getService("admin").removeRelatedGroups(this, e)
    },
    getGroups: function () {
        return F.DI().getService("project").getRelatedGroups(this)
    },
    updateImage: function (e, t) {
        return this._service.updateImage(this, e, t)
    },
    hasPendingPointCloud: function () {
        return this.hasPendingProjectPointCloud() || this.hasPendingScanPointCloud()
    },
    hasPendingProjectPointCloud: function () {
        var e = this._pointClouds;
        return !(!e || !(e.Project && 0 < e.Project.pending || e.EntityPC && 0 < e.EntityPC.pending))
    },
    hasPendingScanPointCloud: function () {
        var e = this._pointClouds;
        return !!(e && e.Scan && 0 < e.Scan.pending)
    },
    hasPointCloud: function () {
        return this.hasProjectPointCloud() || this.hasScanPointCloud()
    },
    hasProjectPointCloud: function () {
        var e = this._pointClouds;
        return !(!e || !(e.Project && 0 < e.Project.complete || e.EntityPC && 0 < e.EntityPC.complete))
    },
    hasScanPointCloud: function () {
        var e = this._pointClouds;
        return !!(e && e.Scan && 0 < e.Scan.complete)
    },
    getPointCloudState: function () {
        return this.hasPendingPointCloud() ? 0 : this.hasProjectPointCloud() && this.hasScanPointCloud() ? 1 : this.hasProjectPointCloud() ? 2 : this.hasScanPointCloud() ? 3 : this._simple3DEnabled ? 4 : 5
    },
    hasScan: function () {
        return this._numberOfScans > 0
    },
    hasOverviewMap: function () {
        return this._type === WS.Project.Type.WSC
    }
}, WS.extend("Project", "ProjectBase"), WS.Project.Type = {
    WSC: "wsc",
    INC: "inc"
}, WS.Project.State = {
    DRAFT: "Draft",
    PUBLISHED: "Published"
}, WS.Project.UploadState = {
    STARTED: "Started",
    COMPLETED: "Completed"
}, WS.Project.DISPLAYNAME_MAX_CHARS = 60, WS.Project.DISPLAYNAME_MAX_BYTES = 128, F.DI().registerService("root", F.RootService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), F.DI().redefineService("project", WS.ProjectService, "@serializer", "@error", "@login", "@selection", "@plug", "$resource", "$http", "@url"), F.DI().config("@serializer", "@project", "@root", function (e, t, i) {
    e.registerClass("Project", function () {
        return t.getNew()
    }), e.registerClass("Workspace", function () {
        return i.getNew()
    })
}), F.DI().config("@task", "@project", WS.projectValidators = function (e, t) {
    e.addValidator("map", function () {
        return t.hasCurrent() ? t.getCurrentProject().then(function (e) {
            return e.hasOverviewMap() ? void 0 : "EM_NO_MAP"
        }, function () {
        }) : Q.resolve("EM_NO_PROJECT")
    }), e.addValidator("canconfiguremap", function () {
        return t.hasCurrent() ? t.getCurrentProject().then(function (e) {
            return e.hasOverviewMap() ? e._exportVersion < 10 ? "EM_NO_LAYERMAP" : void 0 : "EM_NO_MAP"
        }, function (e) {
            return e.message || "EM_UNKNOWN_ERROR"
        }) : Q.resolve("EM_NO_PROJECT")
    })
}), angular.module("ws.filter").filter("projectfilter", function () {
    return function (e, t, i, n) {
        if (!t && !i && void 0 === n) return e;
        var r = (t || "").toLowerCase(),
            o = r.match(/^>(\d+)$/),
            a = o && 2 === o.length ? (new Date).getTime() - 24 * parseInt(o[1]) * 60 * 60 * 1e3 : void 0;
        return e.filter(function (e) {
            return (-1 !== e._displayName.toLowerCase().indexOf(r) || -1 !== e._name.toLowerCase().indexOf(r) || -1 !== e._description.toLowerCase().indexOf(r) || -1 !== e._keywords.toLowerCase().indexOf(r) || ("3" === r || "3d" === r) && e._enable3D && e.hasProjectPointCloud() || a && F.datestringToDateObj(e._uploadDate || e._creationDate).getTime() < a) && (!i || i <= e._exportVersion) && (void 0 === n || e.hasOverviewMap() === n)
        })
    }
}), WS.DataFilterCtrl = function (e, t, i, n, r, o, a, s, c, l, h, d) {
    WS.PlugController.call(this, e, t);
    var u = this;
    this._plug = t, this._login = i, this._project = n, this._alert = r, this._measurement = o, this._annotation = a, this._scan = s, this._category = c, this._tag = l, this._orthophoto = h, this._workspace = d, this.$scope = e, this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.provideFemalePlug("ProjectChange", ["changeProject"]), this._plug.connect(this, this._login), this._plug.connect(this, this._project), e.filter = new WS.ChangeObject, e.filter._categories = [], e.filter._tags = [], e.filter._ignoreShared = !1, e.filter._root = !1, window.filter = e.filter, e.categories = [], e.tags = [], e.isAdmin = !1, e.drawer = !1, e.userName = void 0, this.checkUser(), e.getKnown = function () {
        u._category.getAll().then(function (t) {
            e.$apply(function (e) {
                e.categories = t.map(function (e) {
                    return e.Category
                }).sort(function (e, t) {
                    return e.localeCompare(t)
                })
            })
        }, function () {
        }).done(), u._tag.getAll().then(function (t) {
            e.$apply(function (e) {
                e.tags = t.map(function (e) {
                    return e.Tag
                }).sort(function (e, t) {
                    return e.localeCompare(t)
                })
            })
        }, function () {
        }).done()
    }, e.toggleOpen = function () {
        e.drawer ? e.cancel() : e.open()
    }, e.tooltipToggleBtn = function () {
        return e.drawer ? "FE_CANCEL" : "FE_OPEN_FILTER_PANEL"
    }, e.open = function () {
        try {
            u._project.getCurrent()
        } catch (t) {
            return void u._alert.message(t.message)
        }
        e.getKnown(), e.drawer = !0, e.filter._changes._categories = F.cloneArray(e.filter._categories), e.filter._changes._tags = F.cloneArray(e.filter._tags)
    }, e.cancel = function () {
        e.drawer = !1, e.filter.discardChanges()
    }, e.resetFilters = function () {
        var t = e.filter._changes;
        t._categories = [], t._tags = [], t._ignoreShared = !1, t._root = !1
    }, e.apply = function () {
        e.filter.applyChanges(), e.drawer = !1;
        var t = new F.DataFilter,
            i = new F.DataFilter;
        e.filter._categories.length > 0 && t.setCategories(e.filter._categories), e.filter._tags.length > 0 && t.setTags(e.filter._tags), e.filter._root && (t.setRoot(e.filter._root), i.setRoot(e.filter._root)), u._workspace.root(e.filter._root), e.filter._ignoreShared && e.userName && (t.setCreatedBy([e.userName, ""]), i.setCreatedBy([e.userName, ""]));
        try {
            u._project.getCurrent()
        } catch (n) {
            return void u._alert.message(n.message)
        }
        var r = [u._category.setDataFilter(i), u._tag.setDataFilter(i), u._annotation.setDataFilter(t), u._measurement.setDataFilter(t), u._orthophoto.setDataFilter(t), u._scan.setDataFilter(t)];
        Q.allSettled(r).then(function () {
            e.userName && (u._login.notify("update"), u._login.trigger("updateAccount"))
        })
    }, e.remove = function (e, t) {
        F.removeFirst(e, t)
    }, e.addOrRemove = function (e, t) {
        var i = e.indexOf(t);
        -1 == i ? e.push(t) : e.splice(i, 1)
    }
}, WS.DataFilterCtrl.prototype = {
    checkUser: function () {
        var e = this;
        this._login.isProjectManager().then(function (t) {
            e.$scope.$apply("isAdmin = " + t)
        }).done(), this._login.getUsername().then(function (t) {
            e.$scope.$apply(function (e) {
                e.userName = t
            })
        }).done()
    },
    changeProject: function () {
        this.$scope.$apply(function (e) {
            e.resetFilters(), e.filter.applyChanges()
        })
    },
    login: function () {
        this.checkUser()
    },
    logout: function () {
        this.checkUser()
    },
    updateAccount: function () {
        this.checkUser()
    }
}, WS.extend("DataFilterCtrl", "PlugController"), WS.TagService = function (e, t, i, n) {
    this._resource = e, this._project = t, this._error = i, this._workspace = n, this._dataFilter = new F.DataFilter, this._restClient = this._resource("/tag/:project", {}, {
        readAll: {
            method: "GET",
            params: {},
            isArray: !0
        }
    })
}, WS.TagService.prototype = {
    setDataFilter: function (e) {
        return this._dataFilter = e, this.getAll()
    },
    getAll: function () {
        if (WS._2GO) return this._workspace.getAll("_tags");
        var e = Q.defer(),
            t = {
                project: this._project.getCurrent()
            };
        return this._dataFilter.enhanceRead(t), this._restClient.readAll(t, function (t) {
            e.resolve(t)
        }, this._error.restHandler(e)), e.promise
    }
}, WS.extend("TagService"), WS.CategoryService = function (e, t, i, n) {
    this._resource = e, this._project = t, this._error = i, this._workspace = n, this._dataFilter = new F.DataFilter, this._restClient = this._resource("/category/:project", {}, {
        readAll: {
            method: "GET",
            params: {},
            isArray: !0
        }
    })
}, WS.CategoryService.prototype = {
    setDataFilter: function (e) {
        return this._dataFilter = e, this.getAll()
    },
    getAll: function () {
        if (WS._2GO) return this._workspace.getAll("_categories");
        var e = Q.defer(),
            t = {
                project: this._project.getCurrent()
            };
        return this._dataFilter.enhanceRead(t), this._restClient.readAll(t, function (t) {
            e.resolve(t)
        }, this._error.restHandler(e)), e.promise
    },
    getAllWithoutEmpty: function () {
        return this.getAll().then(function (e) {
            return F.removeFirst(e, function (e) {
                return "" === e.Category
            }), e
        })
    }
}, WS.extend("CategoryService"), WS.SelectionTask = {
    getSelectionStep: function (e) {
        return F.mergeObjects({
            caption: "TC_DELETE_OBJECT",
            description: void 0,
            selectionEntry: "{{entry._displayName}}",
            selectionIcon: "icons/lock.png",
            selectionIconShow: "entry._writeLock",
            toolbarWidget: '<tasktoolbar ng-if="task._category.id != \'object\'" toolbar="viewselectiontoolbar" model="section._pageConfiguration.mode" onchange="setSelectionTool(value, section)"></tasktoolbar>',
            icon: WS.Icons.TaskSection.selectobject
        }, e || {})
    },
    getSelectionStepDescription: function () {
        var e = this._category && "object" === this._category.id;
        return e ? "TD_DELETE_OBJECT" : "TD_SELECT_OBJECTS_W_TOOLS"
    },
    setupSelectionStep: function () {
        var e = this;
        this.$scope.setSelectionTool = function (t, i) {
            e.setActiveSection(i)
        }
    }
}, WS.defineMixin("SelectionTask"), WS.ModelTask = {
    getNameStep: function (e) {
        return F.mergeObjects({
            caption: "TC_ENTER_NAME",
            optional: !0,
            widget: '<edit target="input.name" validation="validateName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/>',
            icon: WS.Icons.TaskSection.textinput,
            pageConfiguration: {
                mode: WS.ViewBase.Mode.Move,
                changeScanAllowed: !1
            },
            completeCondition: "input.name.length == 0 || !validateName(input.name)"
        }, e || {})
    },
    getDescriptionStep: function (e) {
        return F.mergeObjects({
            caption: "TC_ENTER_DESCR",
            optional: !0,
            widget: '<div><markdownhint></markdownhint><br><br><editarea target="input.description" focus-me="section._active" placeholder="{{\'FE_ENTER_DESCR\'|i18n}}"/></div>',
            icon: WS.Icons.TaskSection.textinput,
            pageConfiguration: {
                mode: WS.ViewBase.Mode.Move,
                changeScanAllowed: !1
            }
        }, e || {})
    },
    getHyperlinkStep: function (e) {
        return F.mergeObjects({
            caption: "TC_CREATE_ANNOTATION_HYPERLINK",
            optional: !0,
            description: "TD_CREATE_HLINK_CLOUD_STORAGE",
            widget: '<hyperlinkeditor input="input" focus-me="section._active"></hyperlinkeditor>',
            icon: WS.Icons.TaskSection.hyperlink,
            pageConfiguration: {
                mode: WS.ViewBase.Mode.Move,
                changeScanAllowed: !1
            }
        }, e || {})
    },
    getCategoryStep: function (e) {
        return F.mergeObjects({
            caption: "TC_ENTER_CATEGORY",
            optional: !0,
            widget: '<taskcategorypicker input="input" categories="categories" focus-me="section._active"></taskcategorypicker>',
            icon: WS.Icons.TaskSection.category,
            pageConfiguration: {
                mode: WS.ViewBase.Mode.Move,
                changeScanAllowed: !1
            }
        }, e || {})
    },
    getTagStep: function (e) {
        return F.mergeObjects({
            caption: "TC_ENTER_TAGS",
            optional: !0,
            widget: '<tasktagpicker input="input" tags="tags" focus-me="section._active"></tasktagpicker>',
            icon: WS.Icons.TaskSection.tags,
            pageConfiguration: {
                mode: WS.ViewBase.Mode.Move,
                changeScanAllowed: !1
            }
        }, e || {})
    },
    getColorStep: function (e) {
        return F.mergeObjects({
            caption: "TC_SET_COLOR",
            optional: !0,
            widget: '<wscolorpicker color="input.color" focus-me="section._active"></wscolorpicker>',
            icon: WS.Icons.TaskSection.colormode,
            pageConfiguration: {
                mode: WS.ViewBase.Mode.Move,
                changeScanAllowed: !1
            },
            completeCondition: "isColorValid()"
        }, e || {})
    },
    setupNameStep: function () {
        this.$scope.validateName = function (e) {
            return e && e.length && e.length > 255 ? "EM_NAME_TOO_LONG" : void 0
        }
    },
    setupHyperlinkStep: function () {
        this.$scope.input.hyperlinkObjects = []
    },
    setupCategoryStep: function () {
        var e = this.$scope;
        e.input.category = "", this._cat.getAll().then(function (t) {
            e.$apply(e.categories = t)
        }).done()
    },
    setupTagStep: function () {
        var e = this.$scope;
        e.input.tags = [], this._tag.getAll().then(function (t) {
            e.$apply(e.tags = t)
        }).done()
    },
    setupCategoryTagSteps: function () {
        this.setupCategoryStep(), this.setupTagStep()
    },
    setupColorStep: function () {
        var e = this.$scope;
        e.input.color = "#00e500", e.isColorValid = function () {
            return F.ColorGenerator.isHexColor(e.input.color, !0)
        }
    }
}, WS.defineMixin("ModelTask"), WS.RemoveTask = function (e) {
    WS.Task.call(this, e), this._description = [this.getSelectionStep({
        pageConfiguration: {
            selection: "annotation,measurement,tempmeasurement,orthophoto",
            mode: WS.ViewBase.Mode.SelectObjects,
            name: "RemoveTask"
        },
        select: "Annotation,Measurement,TempMeasurement,Orthophoto",
        selection: "input.annotations,input.measurements,input.tempMeasurements,input.orthophotos",
        widget: '<alert type="warning" ng-show="hasUnlocked() && hasLocked()">{{ \'FE_WARN_WRITELOCKED\' | i18n }}</alert><alert type="error" ng-show="length() > 0 && !hasUnlocked()">{{ \'FE_ERROR_ALLWRITELOCKED\' | i18n }}</alert>',
        completeCondition: "hasUnlocked()"
    })]
}, WS.RemoveTask.prototype = {
    setupDescription: function () {
        this._description[0].description = this.getSelectionStepDescription()
    },
    setup: function (e) {
        this.$scope = e, this.setupSelectionStep(), e.hasLocked = function () {
            return e.input.annotations.some(F.isLocked) || e.input.measurements.some(F.isLocked) || e.input.orthophotos.some(F.isLocked)
        }, e.length = function () {
            return e.input.tempMeasurements.length + e.input.annotations.length + e.input.measurements.length + e.input.orthophotos.length
        }, e.hasUnlocked = function () {
            return e.input.tempMeasurements.length > 0 || e.input.annotations.some(F.isUnlocked) || e.input.measurements.some(F.isUnlocked) || e.input.orthophotos.some(F.isUnlocked)
        }
    },
    execute: function (e) {
        var t = e.annotations.concat(e.measurements, e.tempMeasurements, e.orthophotos);
        return Q.allSettled(t.filter(F.isUnlocked).map(function (e) {
            return e.remove()
        })).then(function (e) {
            var t = {};
            return e.forEach(function (e) {
                "rejected" === e.state && (t[e.reason.message] = !0)
            }), new WS.TaskResult(Object.keys(t))
        })
    }
}, WS.extend("RemoveTask", "Task"), WS.mixin("RemoveTask", "SelectionTask"), WS.EditTask = function (e, t, i) {
    WS.Task.call(this, e), this._cat = t, this._tag = i, this._description = [this.getSelectionStep({
        pageConfiguration: {
            selection: "annotation,measurement,orthophoto,scan",
            mode: WS.ViewBase.Mode.SelectObjects
        },
        select: "Annotation,Measurement,Orthophoto,Scan",
        selection: "input.annotations,input.measurements,input.orthophotos, input.scans",
        selectSingle: !0,
        widget: '<alert type="error" ng-show="first() && first()._writeLock">{{ \'FE_ERROR_WRITELOCKED\' | i18n }}</alert>',
        completeCondition: "first() && !first()._writeLock"
    }), this.getColorStep({
        caption: "TC_EDIT_COLOR",
        startCondition: 'first()._class === "Annotation" && first().isPolyline()'
    }), {
        caption: "TC_EDIT_NAME",
        optional: !0,
        widget: '<edit target="input.name" source="first()._displayName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/>',
        icon: WS.Icons.TaskSection.textinput,
        pageConfiguration: {
            mode: WS.ViewBase.Mode.Move,
            changeScanAllowed: !1
        },
        startCondition: "first()",
        completeCondition: "input.name.length > 0"
    }, {
        caption: "TC_EDIT_DESCR",
        optional: !0,
        widget: '<div><markdownhint></markdownhint><br><br><editarea target="input.description" source="first()._description" focus-me="section._active" placeholder="{{\'FE_ENTER_DESCR\'|i18n}}"/></div>',
        icon: WS.Icons.TaskSection.textinput,
        pageConfiguration: {
            mode: WS.ViewBase.Mode.Move,
            changeScanAllowed: !1
        },
        startCondition: 'first()._class == "Annotation" || first()._class == "Orthophoto"'
    }, this.getHyperlinkStep({
        caption: "TC_EDIT_HYPERLINKS",
        startCondition: 'first()._class == "Annotation" || first()._class == "Orthophoto"'
    }), this.getCategoryStep({
        caption: "TC_EDIT_CATEGORY",
        startCondition: "first()"
    }), this.getTagStep({
        caption: "TC_EDIT_TAGS",
        startCondition: "first()"
    })]
}, WS.EditTask.prototype = {
    setupDescription: function () {
        this._description[0].description = this.getSelectionStepDescription()
    },
    setup: function (e) {
        var t = this;
        t.$scope = e, e.first = function () {
            return e.input.annotations[0] || e.input.measurements[0] || e.input.orthophotos[0] || e.input.scans[0]
        }, this.setupSelectionStep(), this.setupHyperlinkStep(), this.setupCategoryTagSteps(), this.setupColorStep(), e.$watch("first()", function (t) {
            t && (e.input.tags = F.cloneArray(t._tags), e.input.category = t._category, e.input.hyperlinkObjects = F.cloneArray(t._hyperlinks || []), "Annotation" === t._class && t.isPolyline() && (e.input.color = F.ColorGenerator.rgbaToHex(t._displayColor, !1)))
        })
    },
    execute: function (e) {
        var t = e.annotations[0] || e.measurements[0] || e.orthophotos[0] || e.scans[0];
        return t._changes._displayName = e.name, t._changes._category = e.category, t._changes._tags = e.tags, ("Annotation" === t._class || "Orthophoto" === t._class) && (t._changes._description = e.description, t._changes._hyperlinks = e.hyperlinkObjects), "Annotation" === t._class && t.isPolyline() && (t._changes._displayColor = F.ColorGenerator.hexToRGBA(e.color, !0)), t.update().then(function () {
            return t._service._filter(t) ? void 0 : new WS.TaskResult([], ["IM_FILTERED_OBJECT_EDIT"])
        })
    }
}, WS.extend("EditTask", "Task"), WS.mixin("EditTask", "SelectionTask"), WS.mixin("EditTask", "ModelTask"), WS.PickPointsTask = {
    getPointListDesc: function () {
        return '<div class="f_textS" ng-repeat="point in input.pickedPoints" ng-switch="point._pointState"><div class="btn-group" style="margin-bottom: 10px;"><button ng-click="focusPoint(point)" class="btn btn-default f_textS" style="height: 25px; padding-top: 0px; width: 200px;" title="{{focusPointWhere(point) | i18n}}"><div style="text-align: center; display: inline-block;"><img class="f_icon16" style="margin: 4px;" static-src="{{ isRemotePoint(point) ? \'icons/colordot-msm-arrow.png\' : \'icons/colordot-msm.png\' }}"/><span ng-switch-when="0">{{ getPosInCS(point._positionGlobal) | pos_short }}</span><span ng-switch-when="1">{{ \'FE_INVALID_POINT\' | i18n }}</span><span ng-switch-when="2">{{ \'FE_LOADING\' | i18n }}</span></div></button><button ng-click="removePoint(point)" class="btn btn-default" style="height: 25px; width: 25px; padding: 0;" title="{{\'FE_REMOVE\' | i18n}}"><img class="f_icon24" static-src="icons/remove.png"/></button></div></div>'
    },
    setupMixin: function (e) {
        var t = this;
        this._finished = !1, this.setupCategoryTagSteps(), this._projectService.getCurrentProject().then(function (e) {
            t._project = e
        }), e.input.pickedPoint = void 0, e.input.pickedPoints = [], e.pointsReady = function () {
            return e.input.pickedPoints.every(function (e) {
                return e._positionGlobal
            })
        }, e.isRemotePoint = function (e) {
            return t._pano ? !t._pano._visible || !t._pano.isObjectRoot(e._refSystem) && !t._pano.isRootPointCloud() : !1
        }, e.focusPoint = function (e) {
            var i = e._refSystem;
            if (e._positionGlobal) {
                var n = i instanceof WS.Scan ? i : void 0,
                    r = {
                        lookAt: e._positionGlobal,
                        picker: !1,
                        root: n
                    };
                t.trigger("focusOn", [r, i instanceof WS.PointCloud ? "3d" : n ? "pano/3d" : "map"])
            }
        }, e.focusPointWhere = function (e) {
            var i = e._refSystem;
            return i instanceof WS.MapObject ? "FE_SHOW_IN_MAP" : i instanceof WS.PointCloud ? "FE_SHOW_IN_3D" : t._pano.isRootCloud() ? "FE_SHOW_IN_3D" : "FE_SHOW_IN_PANO"
        }, e.removePoint = function (i) {
            t.removePoint(e.input.pickedPoints, i, e.input.close)
        }, e.getPosInCS = function (e) {
            return t._project._trafo && t._unit.isCustomCS() ? mat4.posInRefSystem(e, t._project._trafo) : e
        }, this.provideMalePlug("PointPick3DControl", ["setPickedPoints"]), this.provideMalePlug("ViewFocus", ["focusOn"]), this._connectorService.connectWithAll(this.getMalePlug("PointPick3DControl")), this._connectorService.connectWithAll(this.getMalePlug("ViewFocus"))
    },
    teardownMixin: function () {
        this.triggerAndDestroy("setPickedPoints", [
            []
        ]), this._finished = !0
    },
    removePoint: function (e, t, i) {
        F.removeFirst(e, t) && this.trigger("setPickedPoints", [e, i, this.getLineColor(), void 0, this.getLineColor()])
    },
    removeDuplicates: function (e) {
        for (var t = 0, i = 1; i < e.length;) {
            var n = e[t],
                r = e[i];
            if (n._positionGlobal && r._positionGlobal) {
                var o = n._positionGlobal[0],
                    a = n._positionGlobal[1],
                    s = n._positionGlobal[2],
                    c = r._positionGlobal[0],
                    l = r._positionGlobal[1],
                    h = r._positionGlobal[2];
                o === c && a === l && s === h ? this.$scope.removePoint(r) : (t++, i++)
            } else t++, i++
        }
    },
    applyPickedPointInScanView: function (e, t, i, n) {
        this.trigger("setPickedPoints", [t, n, this.getLineColor(), void 0, this.getLineColor()]);
        var r = this;
        this._point3d.determine3DCoords(i).then(function () {
            r._finished || e.$apply(function () {
                r.removeDuplicates(t), r.trigger("setPickedPoints", [t, n, r.getLineColor(), void 0, r.getLineColor()])
            })
        }, function () {
            e.$apply(function () {
                i._pointState = WS.Point3d.PointState.Invalid, r.removeDuplicates(t), r.trigger("setPickedPoints", [t, n, r.getLineColor(), void 0, r.getLineColor()])
            })
        }).done()
    },
    applyPickedPointInMap: function (e, t, i, n) {
        i._pointState = WS.Point3d.PointState.Valid, i._positionGlobal = i._estimatedPosition, this.removeDuplicates(t), this.trigger("setPickedPoints", [t, n, this.getLineColor(), void 0, this.getLineColor()])
    },
    getTypeInfo: function (e) {
        var t = e.some(function (e) {
                return e._3d
            }),
            i = t ? 0 : Object.keys(e.reduce(function (e, t) {
                return e[t._refSystem._UUID] = !0, e
            }, {})).length;
        return [t, i]
    },
    setPointsAttributes: function (e, t, i, n) {
        var r, o = e instanceof WS.Measurement;
        i[0] ? (e._pointsGlobal = [], t.forEach(function (t) {
            e._pointsGlobal.push(vec3.create(t._positionGlobal))
        }), n && this.closeArea(e._pointsGlobal)) : 1 === i[1] ? (e._pointsLocal = [], o && (e._pointStates = []), t.forEach(function (t) {
            e._pointsLocal.push(vec3.create(t._positionLocal)), o && e._pointStates.push(t._pointState)
        }), r = n ? this.closeArea(e._pointsLocal) : !1, r && o && e._pointStates.push(e._pointStates[0]), e._parentUUID = t[0]._refSystem._UUID) : (e._pointsGlobal = [], o && (e._pointStates = []), e._pointScans = [], t.forEach(function (t) {
            e._pointsGlobal.push(vec3.create(t._positionGlobal)), o && e._pointStates.push(t._pointState), e._pointScans.push(t._refSystem._UUID)
        }), r = n ? this.closeArea(e._pointsGlobal) : !1, r && (o && e._pointStates.push(e._pointStates[0]), e._pointScans.push(e._pointScans[0])))
    },
    closeArea: function (e) {
        if (e.length < 3) return !1;
        var t = e[0],
            i = e[e.length - 1];
        return (t[0] !== i[0] || t[1] !== i[1] || t[2] !== i[2]) && e.push(vec3.create(e[0])), !0
    },
    watchClose: function (e, t) {
        var i = this;
        e.$watch("input.close", function (n) {
            var r = e.input.pickedPoints;
            0 < r.length && (t ? i.applyPickedPointInMap(e, r, r[r.length - 1], n) : i.applyPickedPointInScanView(e, r, r[r.length - 1], n))
        })
    }
}, WS.defineMixin("PickPointsTask"), F.DI().config("@task", function (e) {
    this.registerController("datafilter", WS.DataFilterCtrl, "@plug", "@login", "@project", "@alert", "@measurement", "@annotation", "@scan", "@category", "@tag", "@orthophoto", "@workspace"), this.registerService("category", WS.CategoryService, "$resource", "@project", "@error", "?@workspace"), this.registerService("tag", WS.TagService, "$resource", "@project", "@error", "?@workspace"), this.registerService("transformation", F.TransformationService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), e.registerTaskFactory("default", "object", "editcategory", WS.EditCategoryTask, "@plug", "@category"), e.registerTaskFactory("default", "panoramaview", "editcategory", WS.EditCategoryTask, "@plug", "@category"), e.registerTaskFactory("default", "overviewmap", "editcategory", WS.EditCategoryTask, "@plug", "@category"), e.registerTaskFactory("default", "object", "edittag", WS.EditTagTask, "@plug", "@tag"), e.registerTaskFactory("default", "panoramaview", "edittag", WS.EditTagTask, "@plug", "@tag"), e.registerTaskFactory("default", "overviewmap", "edittag", WS.EditTagTask, "@plug", "@tag"), e.registerTaskFactory("default", "object", "edit", WS.EditTask, "@plug", "@category", "@tag"), e.registerTaskFactory("default", "panoramaview", "edit", WS.EditTask, "@plug", "@category", "@tag"), e.registerTaskFactory("default", "overviewmap", "edit", WS.EditTask, "@plug", "@category", "@tag"), e.registerTaskFactory("default", "object", "remove", WS.RemoveTask, "@plug"), e.registerTaskFactory("default", "panoramaview", "remove", WS.RemoveTask, "@plug"), e.registerTaskFactory("default", "overviewmap", "remove", WS.RemoveTask, "@plug")
}), F.DI().config("@serializer", "@transformation", WS.modelConfig = function (e, t) {
    e.registerClass("Transformation", function () {
        return t.getNew()
    })
}), angular.module("ws.filter").filter("objectfilter", function () {
    return function (e, t, i) {
        return e.filter(function (e) {
            if (!t) return e;
            var n = t.toLowerCase();
            if (-1 !== e._displayName.toLowerCase().indexOf(n)) return !0;
            if (i) {
                if (i.category && -1 !== e._category.toLowerCase().indexOf(n)) return !0;
                if (i.recordingTime && e instanceof WS.Scan && -1 !== e._recordingTime.toLowerCase().indexOf(n)) return !0;
                if (i.tags && e._tags.some(function (e) {
                        return -1 !== e.toLowerCase().indexOf(n)
                    })) return !0
            }
        })
    }
}), angular.module("ws.widget").directive("category", function () {
    return F.DI().inject("$filter", "@encryption", function (e, t) {
        return {
            restrict: "E",
            scope: !0,
            link: function (i, n, r) {
                var o = 0,
                    a = !1,
                    s = function () {
                        i.style = e("bgcolor")(e("int2rgb")(16777215 & o))
                    };
                i.$watch(r.text, function (e) {
                    void 0 !== e && (i.text = e, a || (o = t.crc32(e), s()))
                }), i.$watch(r.text, function (e) {
                    void 0 !== e && (i.text = e, a || (o = t.crc32(e), s()))
                }), i.$watch(r.interactive, function (e) {
                    i.interactive = e
                })
            },
            template: '<span style="float:left; margin-right:5px; margin-bottom:5px; height:26px; padding-left:5px; padding-right:5px; padding-bottom:3px; padding-top:3px; border-radius:3px; " ng-class="{ws_interactive: interactive, ws_categoryItem: interactive}" ><div ng-show="text" ng-style="style" class="f_category"></div><p ng-show="text" style="display: inline-block; vertical-align: 2px">&nbsp;&nbsp;&nbsp;{{text}}</p><p ng-show="!text" style="display: inline-block; vertical-align: 2px; font-style: italic">&mdash;{{ \'FE_NONE\' | i18n }}&mdash;</p><img ng-show="interactive" style="display: inline; vertical-align: top;" class="f_icon16" static-src="icons/im/checked_false.png"/></span>'
        }
    })
}), angular.module("ws.widget").directive("datafilter", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("datafilter"),
        templateUrl: WS.partialUrl("datafilters.html")
    })
}), WS.EditCategoryTask = function (e, t) {
    WS.Task.call(this, e), this._cat = t, this._description = [this.getSelectionStep({
        pageConfiguration: {
            selection: "annotation,measurement,orthophoto,scan",
            mode: WS.ViewBase.Mode.SelectObjects
        },
        select: "Annotation,Measurement,Orthophoto,Scan",
        selection: "input.annotations,input.measurements,input.orthophotos,input.scans",
        widget: '<alert type="warning" ng-show="hasUnlocked() && hasLocked()">{{ \'FE_WARN_WRITELOCKED\' | i18n }}</alert><alert type="error" ng-show="length() > 0 && !hasUnlocked()">{{ \'FE_ERROR_ALLWRITELOCKED\' | i18n }}</alert>',
        completeCondition: "hasUnlocked()"
    }), {
        caption: "TC_SELECT_CATEGORY",
        widget: '<radio options="operations" selected="input.operation"></radio>',
        icon: WS.Icons.TaskSection.category,
        pageConfiguration: {
            mode: WS.ViewBase.Mode.Move,
            changeScanAllowed: !1
        },
        completeCondition: "input.operation"
    }, {
        caption: "TC_ENTER_CATEGORY",
        startCondition: 'input.operation === "add" && (input.annotations.length || input.measurements.length || input.orthophotos.length || input.scans.length)',
        widget: '<taskcategorypicker input="input" categories="categories" focus-me="section._active"></taskcategorypicker>',
        icon: WS.Icons.TaskSection.category,
        pageConfiguration: {
            mode: WS.ViewBase.Mode.Move,
            changeScanAllowed: !1
        },
        completeCondition: "input.category !== undefined"
    }]
}, WS.EditCategoryTask.prototype = {
    setupDescription: function () {
        this._description[0].description = this.getSelectionStepDescription()
    },
    setup: function (e) {
        this.$scope = e;
        var t = this;
        this.setupSelectionStep(), e.operations = {
            add: "FE_SET_CATEGORY",
            remove: "FE_REMOVE_CATEGORY"
        }, e.input.category = void 0, e.hasLocked = function () {
            return e.input.annotations.some(F.isLocked) || e.input.measurements.some(F.isLocked) || e.input.orthophotos.some(F.isLocked) || e.input.scans.some(F.isLocked)
        }, e.hasUnlocked = function () {
            return e.input.annotations.some(F.isUnlocked) || e.input.measurements.some(F.isUnlocked) || e.input.orthophotos.some(F.isUnlocked) || e.input.scans.some(F.isUnlocked)
        }, e.length = function () {
            return e.input.annotations.length + e.input.measurements.length + e.input.orthophotos.length + e.input.scans.length
        }, this._cat.getAllWithoutEmpty().then(function (e) {
            t.$scope.$apply(t.$scope.categories = e)
        }).done()
    },
    execute: function (e) {
        var t = e.annotations.concat(e.measurements, e.orthophotos, e.scans),
            i = "add" == e.operation ? e.category : "";
        return Q.allSettled(t.filter(F.isUnlocked).map(function (e) {
            return e._changes._category = i, e.hasUnsavedChanges() ? e.update().then(function () {
                return e
            }) : Q.resolve(e)
        })).then(function (e) {
            var t = {},
                i = {};
            return e.forEach(function (e) {
                if ("rejected" == e.state) i[e.reason.message] = !0;
                else if ("fulfilled" == e.state) {
                    var n = e.value;
                    n._service._filter(n) || (t.IM_FILTERED_OBJECT_EDIT = !0)
                }
            }), new WS.TaskResult(Object.keys(i), Object.keys(t))
        })
    }
}, WS.extend("EditCategoryTask", "Task"), WS.mixin("EditCategoryTask", "SelectionTask"), WS.EditTagTask = function (e, t) {
    WS.Task.call(this, e), this._tag = t, this._description = [this.getSelectionStep({
        pageConfiguration: {
            selection: "annotation,measurement,orthophoto,scan",
            mode: WS.ViewBase.Mode.SelectObjects
        },
        select: "Annotation,Measurement,Orthophoto,Scan",
        selection: "input.annotations,input.measurements,input.orthophotos,input.scans",
        widget: '<alert type="warning" ng-show="hasUnlocked() && hasLocked()">{{ \'FE_WARN_WRITELOCKED\' | i18n }}</alert><alert type="error" ng-show="length() > 0 && !hasUnlocked()">{{ \'FE_ERROR_ALLWRITELOCKED\' | i18n }}</alert>',
        completeCondition: "hasUnlocked()"
    }), {
        caption: "TC_SELECT_TAGS",
        widget: '<radio options="operations" selected="input.operation"></radio>',
        icon: WS.Icons.TaskSection.selectobject,
        pageConfiguration: {
            mode: WS.ViewBase.Mode.Move,
            changeScanAllowed: !1
        },
        completeCondition: "input.operation"
    }, {
        caption: "FE_SELECT_TAGS",
        widget: '<tasktagpicker input="input" tags="tags" focus-me="section._active"></tasktagpicker>',
        icon: WS.Icons.TaskSection.tags,
        pageConfiguration: {
            mode: WS.ViewBase.Mode.Move,
            changeScanAllowed: !1
        },
        startCondition: 'tags && input.operation && input.operation != "removeall" && (input.annotations.length || input.measurements.length || input.orthophotos.length || input.scans.length)',
        completeCondition: "input.tags.length > 0"
    }]
}, WS.EditTagTask.prototype = {
    setupDescription: function () {
        this._description[0].description = this.getSelectionStepDescription()
    },
    setup: function (e) {
        this.$scope = e;
        var t = this;
        this.setupSelectionStep(), this.setupTagStep(), e.operations = {
            add: "FE_ADD_TAGS",
            remove: "FE_REMOVE_TAGS",
            removeall: "FE_REMOVE_ALL_TAGS"
        }, e.hasLocked = function () {
            return e.input.annotations.some(F.isLocked) || e.input.measurements.some(F.isLocked) || e.input.orthophotos.some(F.isLocked) || e.input.scans.some(F.isLocked)
        }, e.hasUnlocked = function () {
            return e.input.annotations.some(F.isUnlocked) || e.input.measurements.some(F.isUnlocked) || e.input.orthophotos.some(F.isUnlocked) || e.input.scans.some(F.isUnlocked)
        }, e.length = function () {
            return e.input.annotations.length + e.input.measurements.length + e.input.orthophotos.length + e.input.scans.length
        }, e.$watch("input.operation", function () {
            t.$scope.input.tags = []
        })
    },
    execute: function (e) {
        var t = e.annotations.concat(e.measurements, e.orthophotos, e.scans);
        return Q.allSettled(t.filter(F.isUnlocked).map(function (t) {
            "removeall" == e.operation ? t._changes._tags = [] : (t._changes._tags = F.cloneArray(t._tags), e.tags.forEach(function (i) {
                "add" === e.operation ? F.addUnique(t._changes._tags, i) : "remove" === e.operation && F.removeFirst(t._changes._tags, i)
            }));
            var i = F.cloneArray(t._tags).sort();
            return t._changes._tags.sort(), F.compareJSON(i, t._changes._tags) ? (t.discardChanges(), Q.resolve(t)) : t.update().then(function () {
                return t
            })
        })).then(function (e) {
            var t = {},
                i = {};
            return e.forEach(function (e) {
                if ("rejected" == e.state) i[e.reason.message] = !0;
                else if ("fulfilled" == e.state) {
                    var n = e.value;
                    n._service._filter(n) || (t.IM_FILTERED_OBJECT_EDIT = !0)
                }
            }), new WS.TaskResult(Object.keys(i), Object.keys(t))
        })
    }
}, WS.extend("EditTagTask", "Task"), WS.mixin("EditTagTask", "SelectionTask"), WS.mixin("EditTagTask", "ModelTask"), WS.Scan = function (e) {
    WS.Transformation.call(this, e), this._class = "Scan", this._writeLock = !0, this._recordingTime = void 0, this._modificationTime = void 0, this._panoramaColorWidths = void 0, this._panoramaGrayWidths = void 0, this._distanceImageWidths = void 0, this._type = void 0, this._scanPointsShown = !1, this._distanceImages = {}, this._imagePathCache = {}
}, WS.Scan.prototype = {
    getID: function () {
        return this._UUID
    },
    matchesJson: function (e) {
        return this._UUID === e.UUID
    },
    getBestFittingImage: function (e, t) {
        var i = this._imagePathCache[t] || (this._imagePathCache[t] = {});
        return i[e] || (i[e] = this.getImagePath(this.getSimilarAvailablePanoImage(e, t)))
    },
    getSimilarAvailablePanoImage: function (e, t) {
        if (WS.Scan.PanoImageColorModes.hasOwnProperty(t)) {
            var i = {
                    width: e,
                    colorModeId: t
                },
                n = this.arePanoImagesAvailableForMode(t);
            if (!n)
                for (var r in WS.Scan.PanoImageColorModes)
                    if (r != t && (n = this.arePanoImagesAvailableForMode(r))) {
                        i.colorModeId = r;
                        break
                    }
            if (n) return i.width = this.getSimilarAvailablePanoImageWidth(e, i.colorModeId), i
        }
    },
    getSimilarAvailableImagesForBlending: function (e) {
        var t = [];
        return t[0] = this.getSimilarAvailablePanoImage(e, "color"), t[1] = this.getSimilarAvailablePanoImage(e, "gray"), t
    },
    getSimilarAvailableDistanceImage: function (e) {
        var t, i = F.cloneArray(this._distanceImageWidths).sort(function (e, t) {
            return e - t
        });
        if (i[0] >= e) t = i[0];
        else
            for (var n = 1, r = i.length; r > n; n++)
                if (i[n] > e) {
                    t = i[n - 1];
                    break
                }
        return t || (t = i[i.length - 1]), t
    },
    getImagePath: function (e) {
        if (e) {
            var t = e.width,
                i = e.colorModeId;
            return WS._2GO ? "ws2go-data/project/" + this._project + "/scans/" + this._UUID + "-" + i + "-" + t + ".jpg" : "/data/project/" + this._project + "/scan/" + this._UUID + "/" + i + "/" + t
        }
    },
    getDistanceImagePath: function (e) {
        return WS._2GO ? "ws2go-data/project/" + this._project + "/distances/" + this._UUID + "-" + e + ".dist" : "/data/project/" + this._project + "/distance/" + this._UUID + "/" + e
    },
    getPanoImageDescByPath: function (e) {
        var t = WS._2GO ? /.*\/scans\/.*-.*-(.*)\.jpg/ : /.*\/scan\/.*\/.*\/(.*)/,
            i = WS._2GO ? /.*\/scans\/.*-(.*)-.*\.jpg/ : /.*\/scan\/.*\/(.*)\/.*/,
            n = t.exec(e),
            r = i.exec(e);
        if (r && 2 === r.length && n && 2 === n.length) {
            var o = parseInt(n[1]),
                a = r[1];
            return {
                width: o,
                colorModeId: a
            }
        }
        return void 0
    },
    getImageResolutionByPath: function (e) {
        var t = this.getPanoImageDescByPath(e);
        if (t) return WS.Scan.getResolutionByWidth(t.width)
    },
    arePanoImagesAvailableForMode: function (e) {
        if (!WS.Scan.PanoImageColorModes.hasOwnProperty(e)) return !1;
        switch (e) {
            case "gray":
                return this._panoramaGrayWidths ? this._panoramaGrayWidths.length > 0 : !1;
            case "color":
                return this._panoramaColorWidths ? this._panoramaColorWidths.length > 0 : !1;
            case "blend":
                return (this._panoramaColorWidths ? this._panoramaColorWidths.length > 0 : !1) && (this._panoramaGrayWidths ? this._panoramaGrayWidths.length > 0 : !1)
        }
    },
    getSimilarAvailablePanoImageWidth: function (e, t) {
        var i, n = "color" == t ? this._panoramaColorWidths : this._panoramaGrayWidths;
        if (0 !== n.length) {
            e = Math.min(e, WS.Scan.DeviceMaxResolutionPx);
            var r = F.cloneArray(n);
            if (r.sort(function (e, t) {
                    return e - t
                }), r[0] >= e) i = r[0];
            else
                for (var o = 1, a = n.length; a > o; o++)
                    if (r[o] > e) {
                        i = r[o - 1];
                        break
                    }
            return i || (i = r[n.length - 1]), i
        }
    },
    showScanPoints: function () {
        this._scanPointsShown = !0, this._service.showScanPoints(this)
    },
    hideScanPoints: function () {
        this._scanPointsShown = !1, this._service.hideScanPoints(this)
    },
    readJson: function (e) {
        WS.Transformation.prototype.readJson.call(this, e), this._recordingTime = e.RecordingTime, this._modificationTime = e.ModificationTime, this._panoramaColorWidths = e.PanoramaColorWidths, this._panoramaGrayWidths = e.PanoramaGrayWidths, this._distanceImageWidths = e.DistanceImageWidths, this._type = e.Type
    },
    writeJson: function () {
        var e = WS.Transformation.prototype.writeJson.call(this);
        return e.RecordingTime = this._recordingTime, e.ModificationTime = this._modificationTime, e.PanoramaColorWidths = this._panoramaColorWidths, e.PanoramaGrayWidths = this._panoramaGrayWidths, e.DistanceImageWidths = this._distanceImageWidths, e.Type = this._type, e
    },
    getWeightedDistance: function (e, t, i) {
        var n = this;
        return this._service.loadDistanceImage(this, this.getSimilarAvailableDistanceImage(i)).then(function (r) {
            return n.lookupWeightedDistance(r, e, t, i)
        })
    },
    lookupWeightedDistance: function (e, t, i, n) {
        var r = F.wrapTo_0_2PI(t),
            o = F.wrapTo_Minus05PI_05PI(i),
            a = .5 * n,
            s = n - n * r / (2 * Math.PI);
        s === n && (s = 0);
        var c = (o + .5 * Math.PI) * a / Math.PI;
        c === a && (c = 0);
        var l, h, d, u, _, p, g, f, m = Math.floor(s),
            v = Math.floor(c),
            S = .5 > s - m,
            b = .5 > c - v;
        S && b ? (l = 1 - (s - (m - 1 + .5)), d = 1 - (c - (v - 1 + .5)), _ = F.wrapPoint(m - 1, v - 1, n, a), p = F.wrapPoint(m, v - 1, n, a), g = F.wrapPoint(m - 1, v, n, a), f = [m, v]) : S && !b ? (l = 1 - (s - (m - 1 + .5)), d = 1 - (c - (v + .5)), _ = F.wrapPoint(m - 1, v, n, a), p = [m, v], g = F.wrapPoint(m - 1, v + 1, n, a), f = F.wrapPoint(m, v + 1, n, a)) : !S && b ? (l = 1 - (s - (m + .5)), d = 1 - (c - (v - 1 + .5)), _ = F.wrapPoint(m, v - 1, n, a), p = F.wrapPoint(m + 1, v - 1, n, a), g = [m, v], f = F.wrapPoint(m + 1, v, n, a)) : (l = 1 - (s - (m + .5)), d = 1 - (c - (v + .5)), _ = [m, v], p = F.wrapPoint(m + 1, v, n, a), g = F.wrapPoint(m, v + 1, n, a), f = F.wrapPoint(m + 1, v + 1, n, a)), h = 1 - l, u = 1 - d;
        var y, P = l * d,
            M = h * d,
            w = l * u,
            C = h * u,
            T = e[_[1] * n + _[0]],
            W = e[p[1] * n + p[0]],
            I = e[g[1] * n + g[0]],
            L = e[f[1] * n + f[0]];
        if (P > .99) return T;
        if (0 === T && (y = 1 / (1 - P), M *= y, w *= y, C *= y, P = 0), M > .99) return W;
        if (0 === W && (y = 1 / (1 - M), P *= y, w *= y, C *= y, M = 0), w > .99) return I;
        if (0 === I && (y = 1 / (1 - w), P *= y, M *= y, C *= y, w = 0), C > .99) return L;
        if (0 === L && (y = 1 / (1 - C), P *= y, M *= y, w *= y, C = 0), 0 === P && 0 === M && 0 === w && 0 === C) return 0;
        var R = T * P,
            O = W * M,
            D = I * w,
            A = L * C,
            E = R + O + D + A;
        return E
    },
    createRenderable: function (e) {
        if (e._type !== WS.PanoramaView.type && e._type !== WS.OverviewMap.type) return void 0;
        var t = F.DI().getService("scancolorizer"),
            i = e._type === WS.OverviewMap.type ? new WS.ScanMapRenderable(t) : new WS.ScanPanoRenderable(t);
        i.setDataObject(this);
        var n = this;
        return i.update = function (t) {
            var r = n.calcPositionInRefSystem(e._trafoView);
            i.setTranslation(r), i.updateAppearance(t)
        }, i
    },
    createScanCloudRenderable: function (e, t) {
        var i = WS.ScanCloudRenderable.DetailWidth[t.details3d()],
            n = t.getPrefferedColorMode();
        return new WS.ScanCloudRenderable(this, this._service, i, n._id, e)
    },
    canBeShownInView: function () {
        return !0
    },
    isVirtual: function () {
        return "Virtual" === this._type || "Photo" === this._type
    }
}, WS.extend("Scan", "Transformation"), WS.Scan.PanoImageResolutions = [new WS.ImageResolution(1024, 512, "low", "FE_RESOLUTION_LOW"), new WS.ImageResolution(2048, 1024, "medium", "FE_RESOLUTION_MEDIUM"), new WS.ImageResolution(4096, 2048, "high", "FE_RESOLUTION_HIGH"), new WS.ImageResolution(8192, 4096, "ultrahigh", "FE_RESOLUTION_VERYHIGH")], WS.Scan.DeviceMaxResolutionIdx = F.isMobileSafari() ? 1 : 3, WS.Scan.DeviceMaxResolutionPx = F.isMobileSafari() ? 2048 : 8192, WS.Scan.getResolutionByWidth = function (e) {
    for (var t = 0, i = WS.Scan.PanoImageResolutions.length; i > t; t++)
        if (WS.Scan.PanoImageResolutions[t]._width === e) return WS.Scan.PanoImageResolutions[t];
    return void 0
}, WS.Scan.PanoImageColorModes = {
    gray: new WS.ColorMode("gray", "FE_GRAY"),
    color: new WS.ColorMode("color", "FE_COLOR"),
    blend: new WS.ColorMode("blend", "FE_BLEND")
}, WS.ScanService = function (e, t, i, n, r, o, a, s, c) {
    WS.ProjectCRUDService.call(this, "Scan", WS.Scan, "/scan", {}, e, t, i, n, r, o, a, s, c), this.provideMalePlug("ScanPointsShow", ["showScanPoints", "hideScanPoints"]), this._rootScan = void 0, this._scanToCache = void 0
}, WS.ScanService.prototype = {
    showScanPoints: function (e) {
        //this.trigger("showScanPoints", [e])
    },
    hideScanPoints: function (e) {
        this.trigger("hideScanPoints", [e])
    },
    loadDistanceImage: function (e, t) {
        var i = this,
            n = WS.ScanService.BIG_SIZE;
        if (t >= n) {
            var r = this._scanToCache;
            if (r && r !== e)
                for (var o = n; 8192 >= o; o *= 2) delete r._distanceImages[o];
            this._scanToCache = e
        }
        if (!e._distanceImages[t]) {
            var a = Q.defer();
            e._distanceImages[t] = a.promise;
            var s = F.DI().get("$http");
            s.get(e.getDistanceImagePath(t), {
                responseType: "arraybuffer"
            }).success(function (r) {
                t >= n && e !== i._scanToCache && (e._distanceImages[t] = void 0), a.resolve(new Float32Array(r))
            }).error(function () {
                e._distanceImages[t] = void 0, a.reject()
            })
        }
        return e._distanceImages[t]
    },
    getNearestScan: function (e, t, i, n) {
		alert("nearest");
        return this.getAll().then(function (r) {
            if (0 === r.length) throw new Error("EM_NO_SCAN_AVAILABLE");
            "center" === e && (e = vec3.create(), r.forEach(function (t) {
                vec3.add(e, t.getTranslationGlobal())
            }), vec3.scale(e, 1 / r.length));
            var o = 2 === e.length ? vec2.length : vec3.length;
            if (e.length < 16) {
                var a = mat4.identity();
                mat4.setTranslation(a, [e[0], e[1], e[2] || 0]), e = a
            }
            var s = r.map(function (t) {
                    return {
                        distance: o(t.calcPositionInRefSystem(e)),
                        scan: t
                    }
                }).sort(function (e, t) {
                    return e.distance - t.distance
                }),
                c = s[0].scan,
                l = s.filter(function (e) {
                    return (!t || -1 === t.indexOf(e.scan._UUID)) && (!i || i.indexOf(e.scan._UUID) >= 0)
                });
            if (0 === l.length) {
                if (n) return c;
                throw new Error("EM_NO_SCAN_AVAILABLE")
            }
            return l[0].scan
        })
    },
    handleEntityChanges: function (e, t, i) {
        return this._rootScan && (F.findFirst(t, this._rootScan) || t.push(this._rootScan), F.findFirst(this._entities, this._rootScan) || this._entities.push(this._rootScan), F.removeFirst(i, this._rootScan)), F.ProjectCRUDService.prototype.handleEntityChanges.call(this, e, t, i)
    }
}, WS.extend("ScanService", "ProjectCRUDService"), WS.ScanService.BIG_SIZE = 1024, angular.module("ws.scanlist", []), F.DI().registerService("scan", WS.ScanService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), F.DI().config("@plug", WS.scanPointPlug = function (e) {
    e.describe("ScanPointsShow", ["showScanPoints", "hideScanPoints"])
}), F.DI().config("@serializer", "@scan", function (e, t) {
    e.registerClass("Scan", function () {
        return t.getNew()
    })
}), WS.Annotation = function (e) {
    WS.Transformation.call(this, e), this._class = "Annotation", this._description = void 0, this._hyperlinks = [], this._type = void 0, this._pointsLocal = void 0, this._pointsGlobal = void 0, this._pointScans = void 0, this._displayColor = void 0, this._displayLineWidth = void 0, this._displayLineType = void 0, this._displayAreaType = void 0, this._angle = void 0
}, WS.Annotation.prototype = {
    readJson: function (e) {
        F.Transformation.prototype.readJson.call(this, e), this.readHyperlinksJson(e), this._description = e.Description, this._type = e.Type, this._pointsLocal = e.PointsLocal, this._pointsGlobal = e.PointsGlobal, this._pointScans = e.PointScans, this._displayColor = e.DisplayColor, this._displayLineWidth = e.DisplayLineWidth, this._displayLineType = e.DisplayLineType, this._displayAreaType = e.DisplayAreaType, delete this._angle, WS._2GO && (this._type = this._type || "")
    },
    writeJson: function () {
        var e = F.Transformation.prototype.writeJson.call(this);
        return this.writeHyperlinksJson(e), e.Class = "Annotation", e.Description = this._description, e.Type = this._type, e.PointsLocal = this._pointsLocal, e.PointsGlobal = this._pointsGlobal, e.PointScans = this._pointScans, e.DisplayColor = this._displayColor, e.DisplayLineWidth = this._displayLineWidth, e.DisplayLineType = this._displayLineType, e.DisplayAreaType = this._displayAreaType, e.Angle = this._angle, e
    },
    writeChanges: function () {
        var e = WS.Transformation.prototype.writeChanges.call(this);
        return this.writeHyperlinksChanges(e)
    },
    createRenderable: function (e) {
        if (this.isPolyline()) {
            if (this._type === WS.Annotation.Type.POLYLINE_MAP) {
                var t = e._mapObject ? e._mapObject._trafoGlobal : mat4.identity();
                return this.createRenderableInternal(e, t)
            }
            var i, n, r = F.DI().getService("scan"),
                o = F.DI().getService("transformation"),
                a = this._ancestors && this._ancestors.length && this._ancestors[this._ancestors.length - 1];
            a && "Transformation" === a.Class ? i = o : a && "Scan" === a.Class ? i = r : this._type === WS.Annotation.Type.POLYLINE_SCAN ? (i = r, n = o) : (i = o, n = r);
            var s = this;
            return i.getByID(s._parentUUID).fail(function (e) {
                if (n) return n.getByID(s._parentUUID);
                throw e
            }).then(function (t) {
                return s.createRenderableInternal(e, t._trafoGlobal)
            })
        }
        return this.createRenderableInternal(e, void 0)
    },
    createRenderableInternal: function (e, t) {
        var i;
        if (this.isPolyline()) {
            var n = this.calcTrafoInRefSystem(e._trafoView, t),
                r = this._type !== WS.Annotation.Type.POLYLINE_MAP && e.getRelatedScanUUIDs ? e.getRelatedScanUUIDs() : void 0;
            i = new WS.PolylineAnnotationRenderable(this, n, r, F.DI().getService("unit"))
        } else i = new WS.AnnotationRenderable(this.hasMapType());
        i.setDataObject(this);
        var o = this;
        return i.update = function () {
            if (!o.isPolyline()) {
                var t = o.calcPositionInRefSystem(e._trafoView);
                i.setTranslation(t)
            }
            i.setText(o._displayName, !0), i.updateIcon(), o.isPolyline() && (i._lineColor = F.ColorGenerator.intColorToDbl(o._displayColor), i.updateSegmentLines(), i.updateDashLength(), i.updateAreaPolygon()), i.addToLayer(WS.Layer.LayerIDs.ANNOTATIONS, !0)
        }, i
		
    },
    canBeShownInView: function (e) {
		return "map" !== e && ("panorama" !== e && "3d" !== e || this.hasMapType()) ? !1 : !0
    },
    hasMapType: function () {
        return this._type === WS.Annotation.Type.MAP || this._type === WS.Annotation.Type.POLYLINE_MAP
    },
    isPolyline: function () {
        return this._type === WS.Annotation.Type.POLYLINE_MAP || this._type === WS.Annotation.Type.POLYLINE_SCAN || this._type === WS.Annotation.Type.POLYLINE_MULTI || this._type === WS.Annotation.Type.POLYLINE_SPACE
    },
    isClosedMapPolyline: function () {
        var e = this._pointsGlobal;
        return this._type === WS.Annotation.Type.POLYLINE_MAP && 3 < e.length && F.closeToArray(e[0], e[e.length - 1])
    },
    getBoundingBox: function () {
        var e = this.isPolyline() ? this._pointsGlobal : [this.getTranslationGlobal()];
        return new WS.BoundingBox3d(e)
    },
    determineOrientation: function () {
        if (!this.isPolyline()) return "x";
        var e = this.getBoundingBox();
        return e.determineOrientation(this._pointsGlobal)
    },
    getGlobalOrLocalPoints: function (e) {
        return e === WS.UnitService.CS.LOCAL ? this._pointsLocal : this._pointsGlobal
    }
}, WS.extend("Annotation", "Transformation"), WS.mixin("Annotation", "HyperlinkedObject"), WS.Annotation.Type = {
    DEFAULT: "",
    POINT_VALID: "PointValid",
    POINT_INVALID: "PointInvalid",
    MAP: "Map",
    OBJECT: "Object",
    SPACE: "Space",
    POLYLINE_MAP: "PolylineMap",
    POLYLINE_SCAN: "PolylineScan",
    POLYLINE_MULTI: "PolylineMulti",
    POLYLINE_SPACE: "PolylineSpace"
}, WS.AnnotationService = function (e, t, i, n, r, o, a, s, c) {
    WS.ProjectCRUDService.call(this, "Annotation", WS.Annotation, "/annotation", {}, e, t, i, n, r, o, a, s, c)
}, WS.extend("AnnotationService", "ProjectCRUDService"), angular.module("ws.annotation", []), F.DI().registerService("annotation", WS.AnnotationService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), F.DI().config("@serializer", "@annotation", function (e, t) {
    e.registerClass("Annotation", function () {
        return t.getNew()
    })
}), F.DI().config("@task", function (e) {
    e.registerTaskFactory("default", "overviewmap", "annotate", WS.AnnotateMapTask, "@plug", "@annotation", "@locale", "@point3d", "@unit", "@category", "@tag", "@layer", "@project"), e.registerTaskFactory("default", "panoramaview", "annotate", WS.AnnotatePanoTask, "@plug", "@annotation", "@locale", "@point3d", "@unit", "@category", "@tag", "@layer", "@project", "@alert")
}), WS.AnnotateTask = function (e, t, i, n, r, o, a, s, c, l) {
    F.Task.call(this, e), this._annotation = t, this._locale = i, this._point3d = n, this._unit = r, this._cat = o, this._tag = a, this._layer = s, this._projectService = c, this._project = void 0, this._viewType = l, this._description = [{
        caption: "TD_CREATE_ANNOTATION_PICK",
        description: "TC_CREATE_ANNOTATION_PICK",
        widget: '<div ng-show="0 < input.pickedPoints.length"><p style="font-weight: bold;">{{"FE_SELECTED_POINTS_1" | i18n | addlengthunit}}:</p>' + this.getPointListDesc() + '<checkbox ng-show="2 < input.pickedPoints.length" target="input.close" source="input.close" name="{{ \'FE_CONNECT_END_POINTS\' | i18n }}"></checkbox></div><alert type="info" ng-show="!hasEnoughPoints()" style="margin-bottom: 10px !important;">{{ \'FE_PTS_REQUIRED\' | i18n }}: {{stillRequiredPoints()}}</alert><button ng-show="!input.pickPolyline" ng-click="pickPolyline()" class="btn btn-default f_btnAutoWidth" style="width: 224px; margin-top: 5px;" title="{{\'FE_SELECT_AREA\'|i18n}}"><div style="margin-left: -28px;"><img class="f_icon24" static-src="icons/im/taskbar/overviewmap/measurearea.png"/> {{\'FE_SELECT_AREA\'|i18n}}</div></button>',
        icon: WS.Icons.TaskSection.point3d,
        female: "PointPick3D",
        pinBinding: "pickPoint(input.pickedPoint)",
        pageConfiguration: {
            mode: this._viewType === WS.Layer.ViewTypes.PANO_VIEW ? WS.ViewBase.Mode.PickPointOpenScans : WS.ViewBase.Mode.PickPolygon
        },
        completeCondition: "hasEnoughPoints() && pointsReady()"
    }, this.getColorStep({
        startCondition: "input.pickPolyline"
    }), this.getNameStep({
        optional: !1,
        completeCondition: "input.name.length > 0 && !validateName(input.name)"
    }), this.getDescriptionStep(), this.getHyperlinkStep(), this.getCategoryStep(), this.getTagStep()]
}, WS.AnnotateTask.prototype = {
    setup: function (e) {
        var t = this;
        this.$scope = e, this.setupNameStep(), this.setupHyperlinkStep(), this.setupMixin(e), this.setupColorStep(), e.input.pickPolyline = !1, e.input.close = !0, e.hasEnoughPoints = function () {
            return e.input.pickPolyline ? 1 < e.input.pickedPoints.length : 0 < e.input.pickedPoints.length
        }, e.stillRequiredPoints = function () {
            return Math.max(0, (e.input.pickPolyline ? 2 : 1) - e.input.pickedPoints.length)
        }, e.pickPolyline = function () {
            e.input.pickPolyline = !0, t.trigger("setPickedPoints", [e.input.pickedPoints, e.input.close, t.getLineColor(), void 0, t.getLineColor()])
        }, e.$watch("input.color", function (i) {
            if (F.ColorGenerator.isHexColor(i)) {
                var n = e.input.pickedPoints;
                0 < n.length && t.trigger("setPickedPoints", [n, e.input.close, t.getLineColor(), void 0, t.getLineColor()])
            }
        })
    },
    teardown: function () {
        this.teardownMixin()
    },
    executeBase: function (e, t) {
        return t._description = e.description, t._displayName = e.name, t._category = e.category, t._tags = e.tags, e.hyperlinkObjects && (t._hyperlinks = e.hyperlinkObjects), t.isPolyline() && (t._displayColor = F.ColorGenerator.hexToRGBA(e.color, !0)), t.create().then(F.proxy(function () {
            return t._service._filter(t) ? this.isVisible(e.pickedPoints[0]) ? void 0 : new WS.TaskResult([], ["IM_HIDDEN_OBJECT"]) : new WS.TaskResult([], ["IM_FILTERED_OBJECT"])
        }, this))
    },
    isVisible: function () {
        return this._layer.isLayerVisible(WS.Layer.LayerIDs.ANNOTATIONS, this._viewType)
    },
    getLineColor: function () {
        return this.$scope.input.pickPolyline ? F.ColorGenerator.intColorToDbl(F.ColorGenerator.hexToRGBA(this.$scope.input.color, !0)) : void 0
    }
}, WS.extend("AnnotateTask", "Task"), WS.mixin("AnnotateTask", "ModelTask"), WS.mixin("AnnotateTask", "PickPointsTask"), WS.AnnotatePanoTask = function (e, t, i, n, r, o, a, s, c, l) {
    WS.AnnotateTask.call(this, e, t, i, n, r, o, a, s, c, WS.Layer.ViewTypes.PANO_VIEW), this._pano = e.getPlugModule("pv1"), this._alert = l
}, WS.AnnotatePanoTask.prototype = {
    queryTaskLaunch: function (e, t) {
        return "default" === e && "panoramaview" === t
    },
    setup: function (e) {
        WS.AnnotateTask.prototype.setup.call(this, e);
        var t = this;
        e.$watch("input.pickedPoint", function (i) {
            if (i && i._takenInView._type === WS.PanoramaView.type) {
                var n = e.input.pickedPoints;
                e.input.pickPolyline || 0 === n.length ? n.push(i) : n[0] = i, t.applyPickedPointInScanView(e, n, i, e.input.close)
            }
        }), this.watchClose(e, !1)
    },
    isVisible: function (e) {
	    var t = WS.Layer.LayerIDs.ANNOTATIONS,
            i = this._layer.isLayerVisible(t, this._viewType),
            n = this._layer.getObjectsVisbleUpToDistance(t, this._viewType),
            r = e._positionLocal ? vec3.length(e._positionLocal) : vec3.dist(e._positionGlobal, e._takenInView.getCamGlobalPos());
			return i && n > r
    },
    execute: function (e) {
        var t = e.pickedPoints,
            i = this._annotation.getNew(),
            n = this.getTypeInfo(t);
        if (1 < t.length) this.setPointsAttributes(i, t, n, e.close), i._type = n[0] ? WS.Annotation.Type.POLYLINE_SPACE : 1 === n[1] ? WS.Annotation.Type.POLYLINE_SCAN : WS.Annotation.Type.POLYLINE_MULTI;
        else {
            var r = t[0];
            n[0] ? (i._trafoGlobal = r.getTrafoGlobal(), i._type = WS.Annotation.Type.SPACE) : (i._trafoLocal = r.getTrafoLocal(), i._type = r._pointState === WS.Point3d.PointState.Valid ? WS.Annotation.Type.POINT_VALID : WS.Annotation.Type.POINT_INVALID, i._parentUUID = r._refSystem._UUID)
        }
        return this.executeBase(e, i)
    }
}, WS.extend("AnnotatePanoTask", "AnnotateTask"), WS.AnnotateMapTask = function (e, t, i, n, r, o, a, s, c) {
    WS.AnnotateTask.call(this, e, t, i, n, r, o, a, s, c, WS.Layer.ViewTypes.OVERVIEW_MAP)
}, WS.AnnotateMapTask.prototype = {
    queryTaskLaunch: function (e, t) {
        return "default" === e && "overviewmap" === t
    },
    setup: function (e) {
        WS.AnnotateTask.prototype.setup.call(this, e);
        var t = this;
        e.$watch("input.pickedPoint", function (i) {
            if (i && i._takenInView instanceof WS.OverviewMap) {
                var n = e.input.pickedPoints;
                e.input.pickPolyline || 0 === n.length ? n.push(i) : n[0] = i, t.applyPickedPointInMap(e, n, i, e.input.close)
            }
        }), this.watchClose(e, !0)
    },
    execute: function (e) {
        var t = e.pickedPoints,
            i = this._annotation.getNew();
        return i._parentUUID = t[0]._refSystem._UUID, 1 < t.length ? (i._type = WS.Annotation.Type.POLYLINE_MAP, i._pointsGlobal = [], t.forEach(function (e) {
            i._pointsGlobal.push(e._positionGlobal)
        }), e.close && this.closeArea(i._pointsGlobal)) : (i._type = WS.Annotation.Type.MAP, i._trafoGlobal = t[0].getTrafoGlobal()), this.executeBase(e, i)
    }
}, WS.extend("AnnotateMapTask", "AnnotateTask"), WS.Measurement = function (e) {
    WS.Transformation.call(this, e), this._class = "Measurement", this._type = void 0, this._displayType = void 0, this._distance = void 0, this._pointsLocal = void 0, this._pointsGlobal = void 0, this._pointScans = void 0, this._pointStates = void 0, this._segmentStates = void 0, this._distances = void 0, this._distanceStartEnd = void 0, this._distanceHorizontalLocal = void 0, this._distanceHorizontalGlobal = void 0, this._distanceVerticalLocal = void 0, this._distanceVerticalGlobal = void 0, this._distanceXLocal = void 0, this._distanceXGlobal = void 0, this._distanceYLocal = void 0, this._distanceYGlobal = void 0, this._axisPointLocal = void 0, this._axisPointGlobal = void 0, this._objectUUIDs = void 0, this._objectClasses = void 0, this._objectPaths = void 0, this._area = void 0, this._centroidLocal = void 0, this._centroidGlobal = void 0, this._areaValid = void 0, this._angles = void 0, this._trafoCustomOfProj = void 0, this._pointsCustom = void 0, this._distXCustom = void 0, this._distYCustom = void 0, this._distZCustom = void 0, this._distHCustom = void 0, this._centroidCustom = void 0
}, WS.Measurement.prototype = {
    readJson: function (e) {
        WS.Transformation.prototype.readJson.call(this, e), this._type = e.Type, this._displayType = e.DisplayType, this._distance = e.Distance, this._pointsLocal = e.PointsLocal, this._pointsGlobal = e.PointsGlobal, this._pointScans = e.PointScans, this._pointStates = e.PointStates, this._segmentStates = e.SegmentStates, this._distances = e.Distances, this._distanceStartEnd = e.DistanceStartEnd, this._distanceHorizontalLocal = e.DistanceHorizontalLocal, this._distanceHorizontalGlobal = e.DistanceHorizontalGlobal, this._distanceVerticalLocal = e.DistanceVerticalLocal, this._distanceVerticalGlobal = e.DistanceVerticalGlobal, this._distanceXLocal = e.DistanceXLocal, this._distanceXGlobal = e.DistanceXGlobal, this._distanceYLocal = e.DistanceYLocal, this._distanceYGlobal = e.DistanceYGlobal, this._axisPointLocal = e.AxisPointLocal, this._axisPointGlobal = e.AxisPointGlobal, this._objectUUIDs = e.ObjectUUIDs, this._objectClasses = e.ObjectClasses, this._objectPaths = e.ObjectPaths, this._area = e.Area, this._centroidLocal = e.CentroidLocal, this._centroidGlobal = e.CentroidGlobal, this._areaValid = e.AreaValid, delete this._angles, WS._2GO && (this._areaValid = this._areaValid || (this._type === WS.Measurement.Type.Map ? !0 : void 0))
    },
    writeJson: function () {
        var e = WS.Transformation.prototype.writeJson.call(this);
        return e.Class = "Measurement", e.Type = this._type, e.DisplayType = this._displayType, e.Distance = this._distance, e.PointsLocal = this._pointsLocal, e.PointsGlobal = this._pointsGlobal, e.PointScans = this._pointScans, e.PointStates = this._pointStates, e.SegmentStates = this._segmentStates, e.Distances = this._distances, e.DistanceStartEnd = this._distanceStartEnd, e.DistanceHorizontalLocal = this._distanceHorizontalLocal, e.DistanceHorizontalGlobal = this._distanceHorizontalGlobal, e.DistanceVerticalLocal = this._distanceVerticalLocal, e.DistanceVerticalGlobal = this._distanceVerticalGlobal, e.DistanceXLocal = this._distanceXLocal, e.DistanceXGlobal = this._distanceXGlobal, e.DistanceYLocal = this._distanceYLocal, e.DistanceYGlobal = this._distanceYGlobal, e.AxisPointLocal = this._axisPointLocal, e.AxisPointGlobal = this._axisPointGlobal, e.ObjectUUIDs = this._objectUUIDs, e.ObjectClasses = this._objectClasses, e.ObjectPaths = this._objectPaths, e.Area = this._area, e.CentroidLocal = this._centroidLocal, e.CentroidGlobal = this._centroidGlobal, e.Angles = this._angles, e.AreaValid = this._areaValid, e
    },
    createRenderable: function (e) {
        if (e._type === WS.PanoramaView.type) {
            var t, i, n = F.DI().getService("scan"),
                r = F.DI().getService("transformation"),
                o = this._ancestors && this._ancestors.length && this._ancestors[this._ancestors.length - 1];
            o && "Transformation" === o.Class ? t = r : o && "Scan" === o.Class ? t = n : this._type === WS.Measurement.Type.ScanPoint ? (t = n, i = r) : (t = r, i = n);
            var a = this;
            return t.getByID(a._parentUUID).fail(function (e) {
                if (i) return i.getByID(a._parentUUID);
                throw e
            }).then(function (t) {
                return a.createRenderableForPanoView(e, t._trafoGlobal)
            })
        }
        return this.createRenderableForMap(e, e._mapObject ? e._mapObject._trafoGlobal : mat4.identity())
    },
    createRenderableForPanoView: function (e, t) {
        var i = this.calcTrafoInRefSystem(e._trafoView, t),
            n = new WS.MeasurementRenderable(this, i, F.DI().getService("unit"), F.DI().getService("locale"), F.DI().getService("domainsettings"), e.getRelatedScanUUIDs(), e._trafoView);
        return n.setDataObject(this), this.addUpdateMethodToRenderable(n), n
    },
    createRenderableForMap: function (e, t) {
        var i = this.calcTrafoInRefSystem(mat4.identity(), t),
            n = this._displayType === WS.Measurement.DisplayType.Distance ? new WS.MeasurementRenderable(this, i, F.DI().getService("unit"), F.DI().getService("locale"), F.DI().getService("domainsettings"), void 0, e._trafoView) : new WS.AreaMeasurementRenderable(this, i, F.DI().getService("unit"), F.DI().getService("locale"), F.DI().getService("domainsettings"), e._trafoView);
        return n.setDataObject(this), this.addUpdateMethodToRenderable(n), n
    },
    addUpdateMethodToRenderable: function (e) {
        var t = this;
        e.update = function () {
            this._temporary = t.instanceOf(WS.TempMeasurement), this._type = t._type, this._distance = t._distance, this._distances = t._distances, this._pointsLocal = t._pointsLocal, this._pointScans = t._pointScans, this._pointStates = t._pointStates, this._segmentStates = t._segmentStates, this._axisPointLocal = t._axisPointLocal, this._distanceStartEnd = t._distanceStartEnd, this._distanceHorizontalGlobal = t._distanceHorizontalGlobal, this._distanceVerticalGlobal = t._distanceVerticalGlobal, this._distanceXGlobal = t._distanceXGlobal, this._distanceYGlobal = t._distanceYGlobal, this._objectUUIDs = t._objectUUIDs, this._objectClasses = t._objectClasses, t._type === WS.Measurement.Type.Map && (this._area = t._area, this._centroidLocal = t._centroidLocal, this._areaValid = t.isAreaValid()), this.updateAppearance()
        }
    },
    areSegmentsValid: function () {
        if (!this._segmentStates) return !0;
        for (var e = this._segmentStates.length, t = 0; e > t; t++)
            if (0 !== this._segmentStates[t]) return !1;
        return !0
    },
    isSegmentValid: function (e) {
        return !this._segmentStates || 0 === this._segmentStates[e]
    },
    isPointValid: function (e) {
        return void 0 === this._pointStates || 0 === this._pointStates[e]
    },
    isStartEndValid: function () {
        return !this._pointStates || this.isPointValid(0) && this.isPointValid(this._pointStates.length - 1)
    },
    canBeShownInView: function (e) {
        var t = WS.Measurement.Type;
        switch (e) {
            case "map":
                return this._type === t.Map;
            case "panorama":
                return this._type === t.MultiScanPoint || (this._type === t.ScanPoint || this._type === t.SpacePoint || this._type === t.Object) && this._ancestors.some(function (e) {
                    return "Scan" === e.Class
                });
            case "3d":
                return this._type !== t.Map
        }
        return !1
    },
    isAreaValid: function () {
        return this._exportVersion < 4 || this._areaValid
    },
    getBoundingBox: function () {
        return new WS.BoundingBox3d(this._pointsGlobal)
    },
    determineOrientation: function () {
        var e = this.getBoundingBox();
        return e.determineOrientation(this._pointsGlobal)
    },
    setCustomTrafo: function (e) {
        if (void 0 === e) this._trafoCustomOfProj = void 0, this._pointsCustom = void 0, this._distXCustom = void 0, this._distYCustom = void 0, this._distZCustom = void 0, this._distHCustom = void 0, this._centroidCustom = void 0;
        else {
            this._trafoCustomOfProj = e, this._pointsCustom = mat4.positionsInRefSystem(this._pointsGlobal, this._trafoCustomOfProj);
            var t = this._pointsCustom.length,
                i = this._pointsCustom[0],
                n = this._pointsCustom[t - 1];
            this._distXCustom = Math.abs(n[0] - i[0]), this._distYCustom = Math.abs(n[1] - i[1]), this._distZCustom = Math.abs(n[2] - i[2]), this._distHCustom = Math.sqrt(this._distXCustom * this._distXCustom + this._distYCustom * this._distYCustom), this._centroidGlobal && (this._centroidCustom = this.calcPositionInRefSystem(this._trafoCustomOfProj, this._centroidGlobal))
        }
    },
    getGlobalOrLocalPoints: function (e) {
        return e === WS.UnitService.CS.LOCAL ? this._pointsLocal : this._pointsGlobal
    }
}, WS.extend("Measurement", "Transformation"), WS.Measurement.ObjectClasses = {
    Scan: "Scan",
    PointCloud: "PointCloud",
    Sphere: "Sphere",
    Plane: "Plane",
    PlanEx: "PlaneWithBorder",
    Rectangle: "Rectangle",
    Slab: "Slab",
    Pipe: "Pipe"
}, WS.Measurement.Type = {
    ScanPoint: "ScanPointMeasurement",
    MultiScanPoint: "MultiScanPointMeasurement",
    Object: "ObjectMeasurement",
    SpacePoint: "SpacePointMeasurement",
    Map: "MapMeasurement"
}, WS.Measurement.DisplayType = {
    Distance: "Distance",
    Area: "Area"
}, WS.Measurement.SegmentState = {
    VALID: 0,
    INVALID: 1,
    UNLOADED: 2
}, WS.MeasurementService = function (e, t, i, n, r, o, a, s, c) {
    WS.ProjectCRUDService.call(this, "Measurement", WS.Measurement, "/measurement", {}, e, t, i, n, r, o, a, s, c)
}, WS.extend("MeasurementService", "ProjectCRUDService"), WS.TempMeasurement = function (e) {
    WS.Measurement.call(this, e), this._temporary = !0
}, WS.extend("TempMeasurement", "Measurement"), WS.TempMeasurementService = function (e, t, i, n, r, o, a, s, c, l) {
    WS.ProjectCRUDService.call(this, "TempMeasurement", WS.TempMeasurement, "/measurement", {}, e, t, i, n, r, o, a, s, l), this._mapObject = c
}, WS.TempMeasurementService.prototype = {
    generateName: function () {
        var e = this._entities.length,
            t = 9 > e ? "0" + (e + 1) : e + 1;
        return "TemporaryMeasurement" + t
    },
    getNew: function () {
        var e = WS.ProjectCRUDService.prototype.getNew.call(this);
        return e._name = this.generateName(), e
    },
    create: function (e, t) {
        var i = t || {};
        return i.temporary = !0, WS.ProjectCRUDService.prototype.create.call(this, e, i)
    },
    remove: function (e) {
        return F.removeFirst(this._entities, e) && (e.unselect(), this.trigger("removeObjects", [
            [e]
        ])), Q.resolve()
    },
    update: function () {
    },
    getAll: function (e, t) {
        var i = t || function () {
            return !0
        };
        return Q.resolve(this._entities.filter(i))
    }
}, WS.extend("TempMeasurementService", "ProjectCRUDService"), WS.DistanceService = function (e, t) {
    this.$http = e, this._error = t
}, WS.DistanceService.prototype = {
    get: function (e, t, i, n, r) {
        var o = Q.defer();
        return this.$http({
            method: "GET",
            url: "/measurement/distance/" + e + "/" + t + "/" + i + "/" + n + "/" + r
        }).success(function (e) {
            o.resolve(e)
        }).error(this._error.httpHandler(o)), o.promise
    }
}, WS.extend("DistanceService"), F.DI().registerService("measurement", WS.MeasurementService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), F.DI().registerService("tempmeasurement", WS.TempMeasurementService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "@mapobject", "$resource"), F.DI().registerService("distance", WS.DistanceService, "$http", "@error"), F.DI().config("@serializer", "@measurement", function (e, t) {
    e.registerClass("Measurement", function () {
        return t.getNew()
    })
}), F.DI().config("@serializer", "@tempmeasurement", function (e, t) {
    e.registerClass("TempMeasurement", function () {
        return t.getNew()
    })
}), F.DI().config("@task", function (e) {
    e.registerTaskFactory("default", "overviewmap", "measuredistance", WS.MeasureMapTask, "@plug", "@point3d", "@measurement", "@tempmeasurement", "@unit", "@locale", "@login", "@category", "@tag", "@layer", "@domainsettings", "@project"), e.registerTaskFactory("default", "overviewmap", "measurearea", WS.MeasureAreaTask, "@plug", "@point3d", "@measurement", "@tempmeasurement", "@unit", "@locale", "@login", "@category", "@tag", "@layer", "@domainsettings", "@project"), e.registerTaskFactory("default", "panoramaview", "measuredistance", WS.MeasurePanoTask, "@plug", "@point3d", "@measurement", "@tempmeasurement", "@unit", "@locale", "@login", "@category", "@tag", "@layer", "@alert", "@domainsettings", "@project")
}), WS.MeasureTask = function (e, t, i, n, r, o, a, s, c, l, h, d, u) {
    F.Task.call(this, e), this._point3d = t, this._locale = o, this._measurement = i, this._tempmeasurement = n, this._unit = r, this._login = a, this._cat = s, this._tag = c, this._layer = l, this._domainSettings = h, this._projectService = d, this._project = void 0, this._viewType = u;
    var _ = {
        startCondition: "input.persist"
    };
    this._description = [{
        caption: "TC_CREATE_MEASUREMENT",
        description: "TD_CREATE_MEASUREMENT",
        widget: '<alert type="info" ng-show="!hasEnoughPoints()">{{ \'FE_PTS_REQUIRED\' | i18n }}: {{stillRequiredPoints()}}</alert><alert type="info" ng-show="viewType == \'PanoramaView\' && input.pickedPoints.length > 0">{{ \'FE_NAVIGATE_TO_PICK\' | i18n }}</alert><p ng-show="input.pickedPoints.length > 0" style="font-weight: bold;">{{"FE_SELECTED_POINTS_1" | i18n | addlengthunit}}:</p>' + this.getPointListDesc() + '<checkbox ng-show="2 < input.pickedPoints.length && !isForArea" target="input.close" source="input.close" name="{{ \'FE_CONNECT_END_POINTS\' | i18n }}"></checkbox>',
        icon: WS.Icons.TaskSection.point3d,
        female: "PointPick3D",
        pinBinding: "pickPoint(input.pickedPoint)",
        pageConfiguration: {
            mode: this._viewType === WS.Layer.ViewTypes.PANO_VIEW ? WS.ViewBase.Mode.PickPointOpenScans : WS.ViewBase.Mode.PickPolygon
        },
        completeCondition: "hasEnoughPoints() && pointsReady()"
    }, this.getNameStep()], WS._2GO || this._description.push({
        caption: "TC_SAVE_MEASUREMENT",
        optional: !0,
        widget: '<checkbox target="input.persist" source="input.checkPersist" ng-show="input.isUser" name="{{\'TD_PERSIST_MEASUREMENT\' | i18n}}"></checkbox><div ng-show="!input.loggedIn"><img class="f_icon32" static-src="icons/im/alerts/info.png"/> {{"FE_ONLY_TEMP_MEASUREMENT" | i18n}}</div><div ng-show="input.loggedIn && !input.isUser"><img class="f_icon32" static-src="icons/im/alerts/info.png"/> {{"FE_MEASUREMENT_NO_USER" | i18n}}</div>',
        icon: WS.Icons.TaskSection.check,
        pageConfiguration: {
            mode: WS.ViewBase.Mode.Move,
            changeScanAllowed: !1
        }
    }, this.getCategoryStep(_), this.getTagStep(_))
}, WS.MeasureTask.prototype = {
    setup: function (e) {
        var t = this;
        t.$scope = e, this.setupNameStep(), this.setupMixin(e), e.viewType = this._viewType, e.input.loggedIn = !1, e.input.isUser = !1, e.input.checkPersist = !1, e.input.close = !1, e.hasEnoughPoints = function () {
            return 1 < e.input.pickedPoints.length
        }, e.stillRequiredPoints = function () {
            return Math.max(0, 2 - e.input.pickedPoints.length)
        }, this.preallocatePersist(e.input)
    },
    teardown: function () {
        this.teardownMixin()
    },
    executeBase: function (e, t) {
        return "" !== e.name && (t._displayName = e.name), e.persist && (t._category = e.category, t._tags = e.tags), t.create().then(F.proxy(function () {
            return e.persist && !t._service._filter(t) ? new WS.TaskResult([], ["IM_FILTERED_OBJECT"]) : this._layer.isLayerVisible(WS.Layer.LayerIDs.MEASUREMENTS, this._viewType) ? void 0 : new WS.TaskResult([], ["IM_HIDDEN_OBJECT"])
        }, this))
    },
    preallocatePersist: function (e) {
        var t = this;
        this._login.isLoggedIn().then(function (i) {
            e.loggedIn = i, i && t._login.isUser().then(function (i) {
                e.isUser = i, i && t._domainSettings.get().then(function (t) {
                    e.checkPersist = t._persistMeasurements
                }).done()
            }).done()
        }).done()
    },
    getLineColor: function () {
        return void 0
    }
}, WS.extend("MeasureTask", "Task"), WS.mixin("MeasureTask", "ModelTask"), WS.mixin("MeasureTask", "PickPointsTask"), WS.MeasurePanoTask = function (e, t, i, n, r, o, a, s, c, l, h, d, u) {
    WS.MeasureTask.call(this, e, t, i, n, r, o, a, s, c, l, d, u, WS.Layer.ViewTypes.PANO_VIEW), this._pano = this._plug.getPlugModule("pv1"), this._alert = h
}, WS.MeasurePanoTask.prototype = {
    queryTaskLaunch: function (e, t) {
        return "default" === e && ("panoramaview" === t || "overviewmap" === t || "object" === t)
    },
    setup: function (e) {
        WS.MeasureTask.prototype.setup.call(this, e);
        var t = this;
        e.$watch("input.pickedPoint", function (i) {
            if (i && i._takenInView instanceof WS.PanoramaView) {
                var n = e.input.pickedPoints;
                n.push(i), t.applyPickedPointInScanView(e, n, i, e.input.close)
            }
        }), this.watchClose(e, !1)
    },
    execute: function (e) {
        var t = e.persist ? this._measurement.getNew() : this._tempmeasurement.getNew(),
            i = e.pickedPoints,
            n = this.getTypeInfo(i);
        this.setPointsAttributes(t, i, n, e.close), t._type = n[0] ? WS.Measurement.Type.SpacePoint : 1 === n[1] ? WS.Measurement.Type.ScanPoint : WS.Measurement.Type.MultiScanPoint;
        var r = this;
        return this.executeBase(e, t).then(function (e) {
            return e || !n[0] || r._pano.isRootCloud() || (e = new WS.TaskResult([], ["IM_HIDDEN_OBJECT"])), e
        })
    }
}, WS.extend("MeasurePanoTask", "MeasureTask"), WS.MeasureMapTask = function (e, t, i, n, r, o, a, s, c, l, h, d) {
    WS.MeasureTask.call(this, e, t, i, n, r, o, a, s, c, l, h, d, WS.Layer.ViewTypes.OVERVIEW_MAP)
}, WS.MeasureMapTask.prototype = {
    queryTaskLaunch: function (e, t) {
        return "default" === e && "overviewmap" === t
    },
    setup: function (e) {
        WS.MeasureTask.prototype.setup.call(this, e);
        var t = this;
        e.$watch("input.pickedPoint", function (i) {
            if (i && i._takenInView._type === WS.OverviewMap.type) {
                var n = e.input.pickedPoints;
                n.push(i), t.applyPickedPointInMap(e, n, i, e.input.close)
            }
        }), this.watchClose(e, !0)
    },
    execute: function (e) {
        var t = e.pickedPoints,
            i = e.persist ? this._measurement.getNew() : this._tempmeasurement.getNew();
        return i._parentUUID = t[0]._refSystem._UUID, i._type = WS.Measurement.Type.Map, i._displayType = WS.Measurement.DisplayType.Distance, i._pointsGlobal = [], t.forEach(function (e) {
            i._pointsGlobal.push(e._positionGlobal)
        }), e.close && this.closeArea(i._pointsGlobal), this.executeBase(e, i)
    }
}, WS.extend("MeasureMapTask", "MeasureTask"), WS.MeasureAreaTask = function (e, t, i, n, r, o, a, s, c, l, h, d) {
    WS.MeasureMapTask.call(this, e, t, i, n, r, o, a, s, c, l, h, d)
}, WS.MeasureAreaTask.prototype = {
    setup: function (e) {
        WS.MeasureMapTask.prototype.setup.call(this, e);
        e.input.close = !0, e.isForArea = !0, e.hasEnoughPoints = function () {
            return 2 < e.input.pickedPoints.length
        }, e.stillRequiredPoints = function () {
            return Math.max(0, 3 - e.input.pickedPoints.length)
        }
    },
    execute: function (e) {
        var t = e.pickedPoints,
            i = e.persist ? this._measurement.getNew() : this._tempmeasurement.getNew();
        i._parentUUID = t[0]._refSystem._UUID, i._type = WS.Measurement.Type.Map, i._displayType = WS.Measurement.DisplayType.Area, i._pointsGlobal = [], t.forEach(function (e) {
            i._pointsGlobal.push(e._positionGlobal)
        });
        this.closeArea(i._pointsGlobal);
        return this.executeBase(e, i)
    }
}, WS.extend("MeasureAreaTask", "MeasureMapTask"), WS.AlertService = function (e) {
    this._locale = e, this._iconWarning = this.createIconMarkup("warning.png"), this._iconInfo = this.createIconMarkup("info.png"), this._iconTip = this.createIconMarkup("tip.png"), this._iconMessage = this.createIconMarkup("message.png"), this._iconClose = '<img align="right" class="f_icon24 ws_alertifyIconClose f_unselectable" unselectable="on" src="' + WS.imgUrl("icons/im/alerts/close.png") + '" />'
}, WS.AlertService.prototype = {
    createIconMarkup: function (e) {
        return '<img align="left" class="f_icon32 f_unselectable" unselectable="on" src="' + WS.imgUrl("icons/im/alerts/" + e) + '" />'
    },
    createMessageMarkup: function (e) {
        return '<div class="f_unselectable" unselectable="on" style="display:inline;"><p style="margin-left:32px; margin-top:5px;" unselectable="on">' + e + "</p></div>"
    },
    error: function (e, t, i, n) {
        var r = this._locale.translateAndCompose(e, n);
        i && (r += i), alertify.error(this._iconClose + this._iconWarning + this.createMessageMarkup(r), t || F.AlertServiceBase.DELAY_FOREVER)
    },
    errorObj: function (e, t) {
        var i, n = e.message,
            r = e._infos;
        if ("EM_LOCK" === n) {
            var o = r.Holder || "n/a",
                a = r.Locked || "n/a";
            i = r.Operation, "Create" === i ? this.error("EM_LOCK_C", t, void 0, [o, a]) : "Update" === i ? this.error("EM_LOCK_U", t, void 0, [a, o]) : "Delete" === i ? this.error("EM_LOCK_D", t, void 0, [a, o]) : this.error("EM_LOCK", t, void 0, [a])
        } else if ("EM_INVALID_STATE" === n) {
            var s = r.ObjectName || "n/a",
                c = r.Data || "n/a";
            i = r.Operation, "Update" === i ? this.error("EM_STATE_U", t, void 0, [s]) : "Delete" === i ? this.error("EM_STATE_D", t, void 0, [s]) : "CreateData" === i ? this.error("EM_STATE_CD", t, void 0, [c]) : "DeleteData" === i ? this.error("EM_STATE_DD", t, void 0, [c]) : this.error("EM_STATE", t, void 0, [s])
        } else this.error(n, t)
    },
    message: function (e, t, i) {
        var n = this._locale.translateAndCompose(e, i);
        alertify.success(this._iconClose + this._iconInfo + this.createMessageMarkup(n), void 0 === t ? F.AlertServiceBase.DELAY_SHORT : t)
    },
    debugMessage: function (e, t) {
        alertify.success(this._iconClose + this._iconInfo + this.createMessageMarkup(e), void 0 === t ? F.AlertServiceBase.DELAY_FOREVER : t)
    },
    tip: function (e, t, i) {
        var n = this._locale.translateAndCompose(e, i);
        alertify.success(this._iconClose + this._iconTip + this.createMessageMarkup(n), void 0 === t ? F.AlertServiceBase.DELAY_SHORT : t)
    }
}, WS.extend("AlertService", "AlertServiceBase"), F.DI().redefineService("alert", WS.AlertService, "@locale"), WS.Headerbar = function (e, t, i, n, r, o, a, s) {
    WS.PlugController.call(this, e, n);
    var c = this;
    this._login = t, this._locale = i, this._alert = r, this._jobQueue = o, this._project = s, e.userDirectory = window.F_USER_DIRECTORY, e.activeLanguage = function () {
        return c._locale.getActiveLanguage()
    }, e.availableLanguages = function () {
        return c._locale.getLanguages()
    }, e.setLanguage = function (t) {
        c._locale.setLanguage(t.id), e.closeMenus()
    }, e.setToolTipTaskPanel = function (e) {
        return c._locale.translate(e ? "FE_MAXIMIZE_TASKPANEL" : "FE_MINIMIZE_TASKPANEL")
    }, e.loginState = "Login", e.taskpanelCollapsed = !1, e.username = void 0, e.panel = "default", e.toggleTaskPanel = function () {
        "default" !== c.$scope.panel && "workbench" !== c.$scope.panel || !c.$scope.hasProjectManagerorDomainAdminRights ? c.trigger("launchTask", ["default"]) : c.trigger("launchTask", ["admin"]), e.closeMenus()
    }, e.toggleLoginState = function () {
        "Login" === e.loginState ? c.trigger("selectPageClass", ["login", {
            nextURL: c.getRedirectUrl()
        }]) : t.logout().fail(function (e) {
            c._alert.errorObj(e, F.AlertServiceBase.DELAY_SHORT)
        }).done(), e.closeMenus()
    }, e.toggleMaximizePage = function () {
		e.$root.$broadcast("collapseTaskPanel", !e.taskpanelCollapsed), e.closeMenus()
    }, e.$on("collapseTaskPanel", function (t, i) {
        e.taskpanelCollapsed = i
    }), e.$on("launchTask", function (t, i, n) {
        e.panel = i, e.category = n
    }), this.$scope.createAccount = function () {
        c.trigger("selectPageClass", ["createaccount"]), e.closeMenus()
    }, this.$scope.openJobQueue = function () {
        c.trigger("launchTask", ["default", "jobqueue"]), e.closeMenus()
    }, this.$scope.selectProjectSelector = function () {
        c.trigger("launchTask", ["default"])
    }, e.menuState = {
        language: !1,
        help: !1,
        login: !1,
        share: !1
    }, e.closeMenus = function () {
        e.menuState.language = !1, e.menuState.help = !1, e.menuState.login = !1, e.menuState.share = !1, void 0 !== e.killListener && (e.killListener(), e.killListener = void 0)
    }, e.toggleMenu = function (t) {
        var i = e.menuState[t];
        e.closeMenus(), e.menuState[t] = !i, e.menuState.share === !0 && (e.killListener = e.$root.$on("$locationChangeSuccess", function () {
            e.updateShareUrl()
        }))
    }, e.openInNewTab = function (e) {
        var t = window.open(e, "_blank");
        t.focus()
    }, e.iframe = {
        code: "",
        width: 800,
        height: 600
    }, e.share = function () {
        e.updateShareUrl(), e.toggleMenu("share")
    }, e.updateShareUrl = function () {
        e.currenturl = F.DI().get("$location").absUrl(), e.emailurl = e.encodeEmailUrl(e.currenturl), e.iframe.code = '<iframe src="' + e.currenturl + '" width="' + e.iframe.width + '" height="' + e.iframe.height + '" frameborder="0"></iframe>'
    }, e.hasProjectManagerorDomainAdminRights = !1, e.numJobs = {
        running: 0,
        pending: 0
    }, o && e.$watch('numJobs.pending + "|" + numJobs.running', function () {
        o.updateJobStatus()
    }), e.encodeEmailUrl = function (e) {
        return e.replace(/&/g, "%26")
    }, a.setInterval(function () {
        e.numJobs.running + e.numJobs.pending > 0 && c.updateQueueState()
    }, WS.Headerbar.QUEUE_POLL_INTERVAL), this.provideMalePlug("TaskLaunch", ["launchTask"]), this.provideMalePlug("PageSelect", ["selectPage", "selectPageClass"]), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.provideFemalePlug("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"]), this.provideFemalePlug("ProjectChange", ["changeProject"]), this.connect(this, t), this.connect(this.getFemalePlug("ProjectChange"), s), o && this.connect(this, o), t.isLoggedIn()
}, WS.Headerbar.prototype = {
    getRedirectUrl: function () {
        var e = F.DI().get("$location").search(),
            t = e.v,
            i = "lp" === t || "lg" === t || "ca" === t ? "?v=ps&t=p:default,c:projectselector,m:t&ps=ps1&ps1=" : F.DI().get("$location").url();
        return i
    },
    login: function () {
        var e = this;
        this.$scope.$apply('loginState = "Logout"'), this._login.getUsername().then(function (t) {
            e.$scope.$apply('username = "' + t + '"')
        }).done(), this._login.isProjectManagerorDomainAdmin().then(function (t) {
            e.$scope.$apply(function (e) {
                e.hasProjectManagerorDomainAdminRights = t
            })
        }).done(), this.updateQueueState()
    },
    logout: function () {
        this.$scope.$apply(function (e) {
            e.loginState = "Login", e.hasProjectManagerorDomainAdminRights = !1, e.username = void 0, e.panel = "default", e.numJobs.running = e.numJobs.pending = 0, e.projectName = void 0, e.$root.htmltitle = void 0
        })
    },
    addObjects: function () {
        this.updateQueueState()
    },
    updateObjects: function () {
        this.updateQueueState()
    },
    removeObjects: function () {
        this.updateQueueState()
    },
    updateQueueState: function () {
        if (this._jobQueue) {
            var e = this,
                t = this.$scope;
            e._jobQueue.getAggregated([WS.Job.State.RUNNING, WS.Job.State.PENDING], !0).then(function (i) {
                var n = i._amount;
                0 === n ? t.$apply(function () {
                    t.numJobs.running = t.numJobs.pending = 0
                }) : e._jobQueue.getAggregated([WS.Job.State.RUNNING], !0).then(function (e) {
                    t.$apply(function () {
                        t.numJobs.running = e._amount, t.numJobs.pending = Math.max(0, n - e._amount)
                    })
                })
            })
        }
    },
    updateAccount: function () {
        var e = this;
        this._login.isProjectManagerorDomainAdmin().then(function (t) {
            e.$scope.$apply(function (e) {
                e.hasProjectManagerorDomainAdminRights = t
            })
        }).done()
    },
    changeProject: function (e) {
        var t = this;
        e && this._project.getCurrentProject().then(function (e) {
            t.$scope.$root.htmltitle = e._displayName, t.$scope.projectName = e._displayName
        }, function () {
            t.$scope.$root.htmltitle = void 0, t.$scope.projectName = void 0
        }).done()
    }
}, WS.extend("Headerbar", "PlugController"), WS.Headerbar.QUEUE_POLL_INTERVAL = 3e4, angular.module("ws.headerbar", []), F.DI().registerController("headerbar", WS.Headerbar, "@login", "@locale", "@plug", "@alert", "?@jobqueue", "$window", "@project"), angular.module("ws.headerbar").directive("headerbar", function () {
    var e = WS.PlugController.createDirective({
        controllerClass: F.DI().getController("headerbar"),
        scope: {
            linkToMainPage: "@",
            showDatafilter: "@",
            showLoginMenu: "@",
            showTaskpanelBtn: "@"
        },
        templateUrl: WS.partialUrl("headerbar.html")
    });
    return e.replace = !0, e
}), angular.module("ws.component", []), angular.module("ws.component").directive("markdownhint", function () {
    return {
        restrict: "E",
        template: '<p style="margin-bottom:0px;">{{"FE_MARKDOWN_HINT" | i18n}}</p><a href="http://daringfireball.net/projects/markdown/syntax" target=_blank"><img class="f_icon16 f_textInline" static-src="icons/extlink.png"/><p class="f_textInline">{{"FE_LEARN_MORE"|i18n}}</p></a>'
    }
}), angular.module("ws.component").directive("betahint", function () {
    return F.DI().inject("%linkRepository%", "%previewGuide%", "%devSupportMail%", function (e, t, i) {
        return {
            restrict: "E",
            transclude: !0,
            link: function (n) {
                n.extLink = e + t;
                var r = "WebShare Cloud v2.3 - Preview Feedback",
                    o = "I tried this:%0D%0A%0D%0AThis worked well:%0D%0A%0D%0AThis did not work:%0D%0A%0D%0ASuggestions/comments:%0D%0A%0D%0A-------%0D%0A%0D%0AI used this browser: " + navigator.userAgent + "%0D%0A%0D%0A";
                n.mailLink = "mailto:" + i + "?subject=" + r + "&body=" + o
            },
            templateUrl: F.partialUrl("betahint.html")
        }
    })
}), angular.module("ws.component").directive("resolutionpicker", function () {
    return {
        require: "?^actionbar",
        scope: {
            settings: "=",
            refresh: "&"
        },
        replace: !0,
        restrict: "E",
        transclude: !0,
        link: function (e) {
            e.setIndex = function (t) {
                e.settings.index = t
            }
        },
        template: '<div class="btn-group" role="group"><div ng-if="settings.showResolutions" class="btn-group" role="group"><button type="button" class="btn btn-default dropdown-toggle f_btnDropdown" data-toggle="dropdown" aria-expanded="false" style="min-width: 130px;">{{settings.widths[settings.index]}} x {{settings.heights[settings.index]}}&nbsp;&nbsp;<span class="caret"></span></button><ul class="dropdown-menu" role="menu"><li ng-repeat="res in settings.widths track by $index"><a class="f_cursorPointer" ng-click="setIndex($index)">{{settings.widths[$index]}} x {{settings.heights[$index]}}</a></li></ul></div><a ng-if="settings.showOpen" role="button" class="btn btn-default f_btnDropdown" href="{{settings.paths[0]}}" target="_blank" style="padding-top: 0px; padding-bottom: 0px; padding-left: 2px; padding-right: 8px;"><img class="f_icon32" static-src="icons/im/taskbar/projectselector/download.png"/>{{\'FE_OPEN_IN_TAB\'|i18n}}</a><button ng-if="settings.showRefresh" type="button" class="btn btn-default f_btnDropdown" ng-click="refresh()" title="{{\'FE_REFRESH\'|i18n}}"><img style="display: inline;" class="f_icon24" static-src="icons/im/refresh.png"/></button></div>'
    }
}), angular.module("ws.component").directive("wscolorpicker", function () {
    return {
        scope: {
            color: "="
        },
        restrict: "E",
        link: function (e) {
            e.colors = ["#ffffff", "#808080", "#000000", "#ff0000", "#ff8000", "#ffff00", "#00e500", "#00e5e5", "#007fff", "#0000ff", "#8000ff", "#ff00d4", "#990000", "#7f5f00", "#007f00", "#009999"], e.color = F.ColorGenerator.isHexColor(e.color, !0) ? e.color.toLowerCase() : e.colors[6], e.picked = e.color;
            var t = document.createElement("input");
            t.setAttribute("type", "color"), e.showAdvanced = "text" !== t.type, e.pick = function (t) {
                e.picked !== t && (e.picked = t)
            }, e.changeHex = function () {
                e.color = e.color.toLowerCase(), F.ColorGenerator.isHexColor(e.color, !0) && e.pick(e.color)
            }, e.isColorValid = function () {
                return F.ColorGenerator.isHexColor(e.color, !0)
            }, e.$watch("picked", function (t) {
                e.color !== t && (e.color = t)
            })
        },
        templateUrl: WS.partialUrl("wscolorpicker.html")
    }
}), angular.module("ws.component").directive("copybtnsmall", function () {
    return {
        restrict: "E",
        scope: {
            copy: "@"
        },
        link: function (e) {
            e.copyToClipboard = function (e) {
                WS.copyToClipboard(e.replace(/[ \t]/g, ""))
            }
        },
        template: '<button class="btn btn-default ws_copyBtnS" ng-click="copyToClipboard(copy)" title="{{\'FE_COPY_CB\'|i18n}}"><img static-src="icons/copy-tiny.png" class="ws_copyBtnImgS" /></button>'
    }
}), angular.module("ws.component").directive("copybtnlarge", function () {
    return {
        restrict: "E",
        scope: {
            copy: "@",
            caption: "@"
        },
        link: function (e) {
            e.copyToClipboard = function (e) {
                WS.copyToClipboard(e.replace(/[ \t]/g, ""))
            }
        },
        template: '<button class="btn btn-default" ng-click="copyToClipboard(copy)" title="{{\'FE_COPY_CB\'|i18n}}">{{caption}}&nbsp;&nbsp;<img static-src="icons/copy-tiny.png" class="ws_copyBtnImgL" /></button>'
    }
}), WS.copyToClipboard = function (e) {
    var t = document.createElement("textarea");
    t.value = e, document.body.appendChild(t), t.select();
    try {
        document.execCommand("copy")
    } catch (i) {
    }
    document.body.removeChild(t)
}, angular.module("ws.component.radialmenu", []), angular.module("ws.component.radialmenu").directive("radialmenubackground", function () {
    return {
        restrict: "E",
        scope: {
            object: "=",
            resolution: "@",
            colormode: "@"
        },
        link: function (e) {
            e.visibleFlg = !1, e.defaultResolution = 512, e.defaultColorMode = "color", e.$watch("object", function () {
                e.visibleFlg = !1, setTimeout(function () {
                    e.$apply(function () {
                        e.visibleFlg = !0
                    })
                }, 300)
            }), e.getBackgroundImageUrl = function () {
                if (e.object && e.object.instanceOf(WS.Scan)) {
                    var t = void 0 === e.resolution ? e.defaultResolution : e.resolution,
                        i = void 0 === e.colormode ? e.defaultColorMode : e.colormode;
                    return "color" !== i && "gray" !== i && (i = e.defaultColorMode), e.object.getBestFittingImage(parseInt(t), i)
                }
                return ""
            }
        },
        template: '<div ng-if="object._class === \'Scan\'"><div ng-if="visibleFlg" class="f_rmImage" back-img="{{getBackgroundImageUrl()}}"></div><div ng-if="!visibleFlg" class="f_rmImageInvisible" style="opacity:0;"></div></div>'
    }
}), WS.VisibilityActionbar = function (e, t, i) {
    WS.PlugController.call(this, e, t), this.$scope = e;
    var n = this;
    this._layerService = i, this._viewType = WS.Layer.ViewTypes[e.viewtype], e.layerVisibility = this.updateLayerVisibilityInternal(), e.toggleVisibility = function (e) {
        var t = WS.Layer.LayerIDs[e];
        void 0 !== t && "" !== t && n._layerService.setLayerVisibility(t, n._viewType, !n._layerService.isLayerVisible(t, n._viewType))
    }, this.provideFemalePlug("ObjectUpdate", ["updateObjects"]), this._connectorService.connect(this, this._layerService)
}, WS.VisibilityActionbar.prototype = {
    updateObjects: function (e) {
        var t = this;
        e.forEach(function (e) {
            if (e._viewType === t._viewType) switch (e._id) {
                case WS.Layer.LayerIDs.SCANS:
                    t.$scope.$apply(function () {
                        t.$scope.layerVisibility.SCANS = e._visible
                    });
                    break;
                case WS.Layer.LayerIDs.ANNOTATIONS:
                    t.$scope.$apply(function () {
                        t.$scope.layerVisibility.ANNOTATIONS = e._visible
                    });
                    break;
                case WS.Layer.LayerIDs.MEASUREMENTS:
                    t.$scope.$apply(function () {
                        t.$scope.layerVisibility.MEASUREMENTS = e._visible
                    });
                    break;
                case WS.Layer.LayerIDs.ORTHOPHOTOS:
                    t.$scope.$apply(function () {
                        t.$scope.layerVisibility.ORTHOPHOTOS = e._visible
                    })
            }
        })
    },
    updateLayerVisibilityInternal: function () {
        return {
            SCANS: this._layerService.isLayerVisible(WS.Layer.LayerIDs.SCANS, this._viewType),
            ANNOTATIONS: this._layerService.isLayerVisible(WS.Layer.LayerIDs.ANNOTATIONS, this._viewType),
            MEASUREMENTS: this._layerService.isLayerVisible(WS.Layer.LayerIDs.MEASUREMENTS, this._viewType),
            ORTHOPHOTOS: this._layerService.isLayerVisible(WS.Layer.LayerIDs.ORTHOPHOTOS, this._viewType)
        }
    }
}, WS.extend("VisibilityActionbar", "PlugController"), F.DI().registerController("visibilityactionbar", WS.VisibilityActionbar, "@plug", "@layer"), angular.module("ws.component").directive("visibilityactionbar", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("visibilityactionbar"),
        require: "?^actionbar",
        scope: {
            viewtype: "@"
        },
        restrict: "E",
        transclude: !1,
        link: function () {
        },
        template: '<actionbarextension class="ws_abSubMenu" style="top: 0px;"><div class="btn-toolbar" role="toolbar"><div class="btn-group"><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.SCANS}" ng-click="toggleVisibility(\'SCANS\')" title="{{ \'FE_SCANPOSITION\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/scanpos.png" /></button><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.MEASUREMENTS}" ng-click="toggleVisibility(\'MEASUREMENTS\')" title="{{ \'FE_MEASUREMENTS\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/measure.png" /></button><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.ANNOTATIONS}" ng-click="toggleVisibility(\'ANNOTATIONS\')" title="{{ \'FE_ANNOTATIONS\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/annotation.png" /></button><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.ORTHOPHOTOS}" ng-click="toggleVisibility(\'ORTHOPHOTOS\')" title="{{ \'FE_ORTHOPHOTOS\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/orthophoto.png" /></button></div></div></actionbarextension>'
    })
}), WS.ImageGallery = function (e, t, i, n, r) {
    WS.Embeddable.call(this, e, t, i);
    var o = this;
    o.scope = e, e.objlist = void 0, e.currentobj = void 0, e.colormode = void 0, e.imgindex = void 0, e.canShowIn3d = {}, this._plug = t, this._pointCloud = n, this._panoSettings = r, e.resetGallery = function () {
        o.resetGallery()
    }, e.toggleColorMode = function () {
        "color" === o.scope.colormode ? o.scope.colormode = "gray" : "gray" === o.scope.colormode && (o.scope.colormode = "color")
    }, e.setImg = function (e) {
        return void 0 === e ? void(o.scope.currentObj = void 0) : (o.scope.imgindex = e >= o.scope.objlist.length ? 0 : 0 > e ? o.scope.objlist.length - 1 : e, void(o.scope.currentobj = o.scope.objlist[o.scope.imgindex]))
    }, e.nextImage = function () {
        o.scope.setImg(o.scope.imgindex + 1)
    }, e.prevImage = function () {
        o.scope.setImg(o.scope.imgindex - 1)
    }, e.showObjects = function (e, t) {
        o.trigger("showObjects", [e, t]), o.resetGallery()
    }, e.focusObject = function (e, t) {
        o.trigger("focusOn", [{
            object: e
        }, t]), o.resetGallery()
    }, this.provideFemalePlug("ObjectShow", ["showObjects"]), this.provideMalePlug("ObjectShow", ["showObjects"]), this.provideMalePlug("ViewFocus", ["focusOn"]), this._plug.connectWithAll(this.getMalePlug("ObjectShow")), this._plug.connectWithAll(this.getMalePlug("ViewFocus")), this.connect(this, r)
}, WS.ImageGallery.prototype = {
    showObjects: function (e, t, i) {
        "gallery" === t && (this.scope.objlist = e, this.scope.currentobj = i.object, this.scope.colormode = i.colormode, this.scope.imgindex = e.indexOf(i.object), this.update3d(e), this.scope.$apply())
    },
    resetGallery: function () {
        this.scope.objlist = void 0, this.scope.currentobj = void 0, this.scope.colormode = void 0, this.scope.imgindex = void 0, this.scope.canShowIn3d = {}
    },
    update3d: function (e) {
        var t = this;
        if (this._panoSettings.isWebGlEnabled()) {
            var i = e.map(function (e) {
                return t._pointCloud.canShowObjectIn3d(e).then(function (i) {
                    t.$scope.canShowIn3d[e._UUID] = i
                })
            });
            Q.allSettled(i).then(function () {
                t.$scope.$apply()
            })
        } else e.forEach(function (e) {
            t.$scope.canShowIn3d[e._UUID] = !1
        }), this.$scope.$apply()
    }
}, WS.extend("ImageGallery", "Embeddable"), angular.module("ws.component.imagegallery", []), F.DI().registerController("imagegallery", WS.ImageGallery, "@plug", "@url", "@pointcloud", "@panosettings"), angular.module("ws.component").directive("imagegallery", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("imagegallery"),
        scope: {},
        link: function () {
        },
        templateUrl: WS.partialUrl("imagegallery.html")
    })
}), WS.MapBase = function (e) {
    F.Transformation.call(this, e), this._backgroundColor = void 0, this._clearView = void 0, this._geoReferenced = void 0, this._globalBottomRightX = void 0, this._globalBottomRightY = void 0, this._globalTopLeftX = void 0, this._globalTopLeftY = void 0, this._heightInMeters = void 0, this._maxLevel = void 0, this._minLevel = void 0, this._pixelsPerMeterMax = void 0, this._tileBottomRightX = void 0, this._tileBottomRightY = void 0, this._tileSizeInMeters = void 0, this._tileTopLeftX = void 0, this._tileTopLeftY = void 0, this._widthInMeters = void 0, this._numMapLevels = void 0, this._pixelsPerMeterMin = void 0
}, WS.MapBase.prototype = {
    readJson: function (e) {
        F.Transformation.prototype.readJson.call(this, e), this._backgroundColor = e.BackgroundColor, this._clearView = e.ClearView, this._geoReferenced = e.GeoReferenced, this._globalBottomRightX = e.GlobalBottomRightX, this._globalBottomRightY = e.GlobalBottomRightY, this._globalTopLeftX = e.GlobalTopLeftX, this._globalTopLeftY = e.GlobalTopLeftY, this._heightInMeters = e.HeightInMeters, this._maxLevel = e.MaxLevel, this._minLevel = e.MinLevel, this._pixelsPerMeterMax = e.PixelsPerMeter, this._tileBottomRightX = e.TileBottomRightX, this._tileBottomRightY = e.TileBottomRightY, this._tileSizeInMeters = e.TileSizeInMeters, this._tileTopLeftX = e.TileTopLeftX, this._tileTopLeftY = e.TileTopLeftY, this._widthInMeters = e.WidthInMeters, this._numMapLevels = this._maxLevel - this._minLevel + 1, this._pixelsPerMeterMin = this._pixelsPerMeterMax / Math.pow(2, this._numMapLevels - 1)
    },
    writeJson: function () {
        var e = F.Transformation.prototype.writeJson.call(this);
        return e.BackgroundColor = this._backgroundColor, e.ClearView = this._clearView, e.GeoReferenced = this._geoReferenced, e.GlobalBottomRightX = this._globalBottomRightX, e.GlobalBottomRightY = this._globalBottomRightY, e.GlobalTopLeftX = this._globalTopLeftX, e.GlobalTopLeftY = this._globalTopLeftY, e.HeightInMeters = this._heightInMeters, e.MaxLevel = this._maxLevel, e.MinLevel = this._minLevel, e.PixelsPerMeter = this._pixelsPerMeter, e.TileBottomRightX = this._tileBottomRightX, e.TileBottomRightY = this._tileBottomRightY, e.TileSizeInMeters = this._tileSizeInMeters, e.TileTopLeftX = this._tileTopLeftX, e.TileTopLeftY = this._tileTopLeftY, e.WidthInMeters = this._widthInMeters, e
    }
}, WS.extend("MapBase", "Transformation"), WS.MapLayer = function (e) {
    WS.MapBase.call(this, e), this._class = "MapLayer", this._objectUUID = void 0, this._opacity = void 0, this._shortID = void 0, this._type = void 0, this._maxScanElevation = void 0, this._minScanElevation = void 0, this._scanNames = void 0, this._scanUUIDs = void 0, this._zBottom = void 0, this._zTop = void 0
}, WS.MapLayer.prototype = {
    readJson: function (e) {
        WS.MapBase.prototype.readJson.call(this, e), this._objectUUID = e.ObjectUUID, this._opacity = e.Opacity, this._shortID = e.ShortID, this._type = e.Type, this._maxScanElevation = e.MaxScanElevation, this._minScanElevation = e.MinScanElevation, this._scanNames = e.ScanNames, this._scanUUIDs = e.ScanUUIDs, this._zBottom = e.ZBottom, this._zTop = e.ZTop
    },
    writeJson: function () {
        var e = WS.MapBase.prototype.writeJson.call(this);
        return e.Class = "MapLayer", e.ObjectUUID = this._objectUUID, e.Opacity = this._opacity, e.ShortID = this._shortID, e.Type = this._type, e.MaxScanElevation = this._maxScanElevation, e.MinScanElevation = this._minScanElevation, e.ScanNames = this._scanNames, e.ScanUUIDs = this._scanUUIDs, e.ZBottom = this._zBottom, e.ZTop = this._zTop, e
    }
}, WS.extend("MapLayer", "MapBase"), WS.MapLayer.Type = {
    SCAN: "Scan",
    LAYOUT_PLAN: "LayoutPlan",
    CLIPPING_BOX: "ClippingBox",
    WORKSPACE: "Workspace"
}, WS.MapObject = function (e) {
    WS.MapBase.call(this, e), this._class = "Map", this._clippingBoxes = void 0, this._hasLayoutLayers = void 0, this._hasMapLayers = void 0, this._hasScanLayers = void 0, this._layerOrder = void 0, this._layoutLayersMaxLevel = void 0, this._layoutLayersMinLevel = void 0, this._maxScanElevation = void 0, this._minScanElevation = void 0, this._scanLayersMaxLevel = void 0, this._scanLayersMinLevel = void 0, this._zBottom = void 0, this._zTop = void 0
}, WS.MapObject.prototype = {
    readJson: function (e) {
        WS.MapBase.prototype.readJson.call(this, e), this._clippingBoxes = e.ClippingBoxes, this._hasLayoutLayers = e.HasLayoutLayers, this._hasMapLayers = e.HasMapLayers, this._hasScanLayers = e.HasScanLayers, this._layerOrder = e.LayerOrder, this._layoutLayersMaxLevel = e.LayoutLayersMaxLevel, this._layoutLayersMinLevel = e.LayoutLayersMinLevel, this._maxScanElevation = e.MaxScanElevation, this._minScanElevation = e.MinScanElevation, this._scanLayersMaxLevel = e.ScanLayersMaxLevel, this._scanLayersMinLevel = e.ScanLayersMinLevel, this._zBottom = e.ZBottom, this._zTop = e.ZTop
    },
    writeJson: function () {
        var e = WS.Transformation.prototype.writeJson.call(this);
        return e.Class = "Map", e.ClippingBoxes = this._clippingBoxes, e.HasLayoutLayers = this._hasLayoutLayers, e.HasMapLayers = this._hasMapLayers, e.HasScanLayers = this._hasScanLayers, e.LayerOrder = this._layerOrder, e.LayoutLayersMaxLevel = this._layoutLayersMaxLevel, e.LayoutLayersMinLevel = this._layoutLayersMinLevel, e.MaxScanElevation = this._maxScanElevation, e.MinScanElevation = this._minScanElevation, e.ScanLayersMaxLevel = this._scanLayersMaxLevel, e.ScanLayersMinLevel = this._scanLayersMinLevel, e.ZBottom = this._zBottom, e.ZTop = this._zTop, e
    },
    getOrderOfLayer: function (e, t) {
        for (var i = t ? this._changes._layerOrder : this._layerOrder, n = 0, r = i.length; r > n; ++n)
            if (i[n] === e) return n;
        return 0
    },
    getLeafletCRS: function () {
        return WS.MapObject.getLeafletCRS(this)
    }
}, WS.extend("MapObject", "MapBase"), WS.MapObject.getLeafletCRS = function (e) {
    var t = L.extend({}, L.CRS, {
        projection: L.Projection.LonLat,
        transformation: new L.Transformation(1, -e._globalTopLeftX, -1, e._globalTopLeftY),
        scale: function (t) {
            return Math.pow(2, t - e._maxLevel) * e._pixelsPerMeterMax
        },
        getSize: function (t) {
            var i = e._maxLevel - t,
                n = Math.ceil(e._tileBottomRightX / Math.pow(2, i)),
                r = Math.ceil(e._tileBottomRightY / Math.pow(2, i));
            return L.point(256 * (n + 1), 256 * (r + 1))
        }
    });
    return t
}, WS.Blender = function () {
    this._objs = void 0, this._durations = void 0, this._endTimes = void 0, this._targetAlphas = void 0, this._diffAlphas = void 0
}, WS.Blender.prototype = {
    reset: function () {
        this._objs = void 0, this._durations = void 0, this._endTimes = void 0, this._targetAlphas = void 0, this._diffAlphas = void 0
    },
    getNowMillis: function () {
        return Date.now()
    },
    startBlending: function (e, t, i) {
        this._objs = [], this._durations = [], this._endTimes = [], this._targetAlphas = [], this._diffAlphas = [];
        for (var n = this.getNowMillis(), r = 0, o = e.length; o > r; ++r) {
            var a = e[r],
                s = t[r],
                c = i[r],
                l = n + s,
                h = c - a.getAlpha();
            this._objs.push(a), this._durations.push(s), this._endTimes.push(l), this._targetAlphas.push(c), this._diffAlphas.push(h)
        }
    },
    blend: function () {
        for (var e = !0, t = this.getNowMillis(), i = 0, n = this._objs.length; n > i; ++i) {
            var r = this._objs[i],
                o = this._durations[i],
                a = this._endTimes[i],
                s = this._targetAlphas[i],
                c = this._diffAlphas[i],
                l = Math.max(0, a - t),
                h = l / o,
                d = s - h * c;
            r.setAlpha(d), e = e && 0 === l
        }
        return e
    }
}, WS.extend("Blender"), WS.Point3dService = function (e, t) {
    WS.PlugModule.call(this, e), this._distance = t, this._point3d = void 0, this.provideMalePlug("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"])
}, WS.Point3dService.prototype = {
    getPoint: function () {
        return this._point3d
    },
    setPoint: function (e) {
        var t = this._point3d;
        this._point3d = e, e !== t ? (t && this.trigger("removeObjects", [
            [t]
        ]), e && this.trigger("addObjects", [
            [e]
        ])) : e && this.trigger("updateObjects", [
            [e]
        ]), e && e._pointState === WS.Point3d.PointState.Unknown && this.determineDistance()
    },
    determineDistance: function () {
        var e = this,
            t = this._point3d;
        this.determine3DCoords(this._point3d).then(function () {
            e._point3d === t && e.trigger("updateObjects", [
                [t]
            ])
        })
    },
    determine3DCoords: function (e) {
        if (e._pointState === WS.Point3d.PointState.Unknown) {
            var t = e._refSystem,
                i = e._takenInView instanceof WS.PanoramaView ? e._takenInView.getImageWidth() : -1;
            return this._distance.get(t._project, t._UUID, e._localAngles[0], e._localAngles[1], i).then(function (t) {
                return e._pointState = t.PointState, e._positionLocal = t.PositionLocal, e._positionGlobal = t.PositionGlobal, e
            })
        }
        return Q.resolve(e)
    }
}, WS.extend("Point3dService", "PlugModule"), WS.Graphics2d = function () {
}, WS.Graphics2d.prototype = {
    draw: function () {
    }
}, WS.extend("Graphics2d"), WS.ImageGraphics2d = function (e) {
    this._image = e, this._image.loadImage(), WS.Graphics2d.call(this)
}, WS.ImageGraphics2d.prototype = {
    draw: function (e, t, i, n, r) {
        this._image.isLoaded() && e.drawImage(this._image.getRawImage(), t, i, r, n)
    }
}, WS.extend("ImageGraphics2d", "Graphics2d"), WS.ViewBase = function (e, t, i) {
    WS.Embeddable.call(this, e, t, i), this._objects = {}, this._mode = void 0, this._modeToHandlerStack = void 0, this.provideFemalePlug("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"])
}, WS.ViewBase.prototype = {
    objectFilter: function () {
        return !1
    },
    addObject: function (e) {
        if (!this.objectFilter(e)) return 0;
        var t = e._class.toLowerCase();
        if (!this._objects[t]) return 0;
        var i = F.addUnique(this._objects[t].entities, e);
        return i ? 2 : 1
    },
    addObjects: function (e) {
        var t = this;
        e.forEach(function (e) {
            t.addObject(e)
        })
    },
    updateObjects: function () {
    },
    removeObject: function (e) {
        var t = e._class.toLowerCase();
        this._objects[t] && F.removeFirst(this._objects[t].entities, e)
    },
    removeObjects: function (e) {
        var t = this;
        e.forEach(function (e) {
            t.removeObject(e)
        })
    },
    activateHandlerStack: function () {
    },
    setMode: function (e) {
        this._mode = e;
        var t = this._modeToHandlerStack ? this._modeToHandlerStack[e] : void 0;
        t && this.activateHandlerStack(t)
    },
    getMode: function () {
        return this._mode
    }
}, WS.extend("ViewBase", "Embeddable"), WS.ViewBase.Mode = {
    Move: 1,
    PickPoint: 2,
    SelectObject: 3,
    PickPolygon: 4,
    SelectObjects: 5,
    PickAll: 6,
    SelectObjectsRectAdd: 7,
    SelectObjectsRectSub: 8,
    PickPointOpenScans: 9
}, WS.CameraObject = function (e) {
    this._globalTransform = e
}, WS.CameraObject.prototype = {
    getGlobalPosition: function () {
        return mat4.getTranslation(this._globalTransform)
    },
    getRightGlobal: function () {
        var e = new MatrixArray(4);
        return mat4.getColumn(this._globalTransform, 0, e), vec3.create(e)
    },
    getUpGlobal: function () {
        var e = new MatrixArray(4);
        return mat4.getColumn(this._globalTransform, 1, e), vec3.create(e)
    },
    getAxisGlobal: function () {
        var e = new MatrixArray(4);
        return mat4.getColumn(this._globalTransform, 2, e), vec3.create(e)
    },
    calcDistToPoint: function (e) {
        var t = this.getGlobalPosition();
        return vec3.dist(t, e)
    }
}, WS.CategoryGraphics2d = function (e) {
    this._color = e, this._color[3] = WS.CategoryGraphics2d._alpha, WS.Graphics2d.call(this)
}, WS.CategoryGraphics2d.prototype = {
    draw: function (e, t, i, n, r) {
        var o = n / 2,
            a = r / 2;
        e.fillStyle = WS.Renderer2D.colorToStyle(this._color), e.lineWidth = 1, e.beginPath(), e.moveTo(t + o, i + WS.CategoryGraphics2d._margin), e.lineTo(t + n - WS.CategoryGraphics2d._margin, i + a), e.lineTo(t + o, i + r - WS.CategoryGraphics2d._margin), e.lineTo(t + WS.CategoryGraphics2d._margin, i + a), e.lineTo(t + o, i + WS.CategoryGraphics2d._margin), e.closePath(), e.fill(), e.stroke()
    }
}, WS.extend("CategoryGraphics2d", "Graphics2d"), WS.CategoryGraphics2d._margin = 5, WS.CategoryGraphics2d._alpha = 1, WS.PerspectiveCameraObject = function (e, t, i) {
    WS.CameraObject.call(this, e), this._aspectRatio = t, this._fovY = i
}, WS.extend("PerspectiveCameraObject", "CameraObject"), WS.View3d = function (e, t, i) {
    WS.ViewBase.call(this, e, t, i), this._page = void 0, this._canvasList = void 0, this._camera = void 0, this._scene = void 0, this._renderMode = void 0, this._activeHandlerStack = void 0, this._mouseAdapter = void 0, this._keyboardAdapter = void 0, this._renderableMap = {}, this._selectionRenderable = new WS.SelectionRenderable, this._type = void 0, this._width = void 0, this._height = void 0, this._renderer = [], this._cameraIdleCount = 0, this._isMoving = 0, this._trafoView = void 0, this._init = !1, this._render = !1, this._isRendering = !1, this._animationProxy = F.proxy(this.animloop, this), this._hlObject = void 0, this._viewModeCtrl = void 0, this._viewModeCtrlD = Q.defer(), this._dbgFpsTimes = [0, 0, 0, 0], this._dbgFps = 0, this.provideMalePlug("CameraChanged", ["onCameraChange"])
}, WS.View3d.prototype = {
    startRendering: function () {
        this._render = !0, this._isRendering || this.animloop()
    },
    stopRendering: function () {
        this._render = !1
    },
    isRendering: function () {
        return this._render
    },
    forceRerender: function () {
        this._camera && (this._camera._dirty = !0, this._camera._changesToTrigger = !0, this._cameraIdleCount = 0)
    },
    setCanvas: function (e) {
        this._canvasList = e
    },
    destroyRenderers: function () {
        this.stopRendering(), this._renderer.forEach(function (e) {
            e.clearStorage()
        }), this._renderer.length = 0
    },
    initRenderers: function () {
    },
    getGLExtension: function () {
    },
    initScene: function () {
    },
    initHandlers: function () {
    },
    initCamera: function () {
    },
    init: function () {
        this.initRenderers(), this.initScene(), this.initCamera(), this.initHandlers(), this.onUpdateViewDimensions(), this._init = !0
    },
    render: function () {
    },
    pick3d: function (e, t, i, n, r, o) {
        o = void 0 === o ? 5 : o;
        var a = this._renderer[0],
            s = new WS.ObjectLabeler,
            c = this.getAllRenderables();
        c.forEach(function (e) {
            e._pickable3d && e.assignPickColors(s)
        });
        var l = a._frameBufferStorage.get("pick_post_gf_color");
        r ? a.drawSceneIncremental(this._camera, this._scene, void 0, void 0, {
            colorMode: WS.RendererBase.RenderMode.PICK_3D,
            bufferPrefix: "pick_"
        }) : a.drawScene(this._camera, this._scene, !1, void 0, {
            destFB: l,
            colorMode: WS.RendererBase.RenderMode.PICK_3D
        });
        var h, d;
        d = !i != !n, d && (h = function (e) {
            var t = s.lookupRenderable(e);
            if (t) {
                var n = t.memberRenderable || t.renderable,
                    r = n instanceof WS.DynamicPointRenderable;
                return i ? !r : r
            }
            return !0
        });
        var u, _ = l.readClosestOpaquePixel(e, t, o, h),
            p = s.lookupRenderable(_);
        if (p) {
            var g = p.memberRenderable || p.renderable;
            if (n && g instanceof WS.DynamicPointRenderable) {
                var f = a._pickColorBuffer,
                    m = new WS.ObjectLabeler,
                    v = g._geometry._positionBuffer;
                f.getCountItems() !== v.getCountItems() && m.fillPickColorBuffer(f, v.getCountItems());
                var S = function (e) {
                    return e === g
                };
                r ? a.drawSceneIncremental(this._camera, this._scene, void 0, S, {
                    colorMode: WS.RendererBase.RenderMode.PICK_3D_POINT,
                    bufferPrefix: "pick_",
                    reuseDepth: !0
                }) : a.drawScene(this._camera, this._scene, !1, S, {
                    destFB: l,
                    colorMode: WS.RendererBase.RenderMode.PICK_3D_POINT
                });
                var b = l.readClosestOpaquePixel(e, t, o),
                    y = m.lookupIndex(b);
                if (void 0 !== y) {
                    var P = vec3.create();
                    v.getItem(y, P), mat4.multiplyVec3(p.renderable._transform, P), u = mat4.multiplyVec3(this._trafoView, P)
                }
            } else !i || g instanceof WS.DynamicPointRenderable || (u = new WS.PickInfo(g))
        }
        return u
    },
    animloop: function () {
        if (this._init) {
            if (!this._render) return void(this._isRendering = !1);
            this._isRendering = !0, this.onUpdateViewDimensions(), this._moveHandler instanceof WS.PointCloudMoveHandler && this._moveHandler.update();
            var e = this._cameraAnimator && this._cameraAnimator.isAnimating();
            this._camera._dirty = this._camera._dirty || e, this._camera._dirty ? this._cameraIdleCount = 0 : this._cameraIdleCount++, this.render(), this._camera._dirty = !1, this._perfNumFrames++;
            for (var t = this._dbgFpsTimes, i = t.length, n = i - 2; n >= 0; n--) t[n + 1] = t[n];
            t[0] = Date.now(), this._dbgFps = 1e3 * (i - 1) / (t[0] - t[i - 1])
        }
        requestAnimationFrame(this._animationProxy)
    },
    perf: function (e) {
        var t = console;
        this._perfNumFrames = 0, this._perfT0 = Date.now(), this._perfProfile = e, e && t.profile()
    },
    perfEnd: function () {
        var e = console;
        this._perfProfile && e.profileEnd();
        var t = Date.now() - this._perfT0,
            i = this._perfNumFrames / (t / 1e3);
        e.log("#frames: ", this._perfNumFrames, "fps: ", i, "    @", this._width, "x", this._height)
    },
    activateHandlerStack: function (e) {
        if (this.deactivateHandlerStack(), this._activeHandlerStack = e, this._mouseAdapter) this._mouseAdapter.setHandlerStack(this._activeHandlerStack);
        else {
            var t = this._canvasList[this._canvasList.length - 1];
            this._mouseAdapter = new WS.MouseAdapterExt(t, this._activeHandlerStack, WS.MouseAdapter.Capture.DragOnly)
        }
        this._keyboardAdapter ? this._keyboardAdapter.setHandlerStack(this._activeHandlerStack) : this._keyboardAdapter = new F.KeyboardAdapter(window, this._activeHandlerStack), this._activeHandlerStack.forEach(function (e) {
            e.activate()
        })
    },
    deactivateHandlerStack: function () {
        this._activeHandlerStack && this._activeHandlerStack.forEach(function (e) {
            e.deactivate()
        }), this._mouseAdapter && this._mouseAdapter.setHandlerStack([]), this._keyboardAdapter && this._keyboardAdapter.setHandlerStack([])
    },
    updateDimensionsForRenderer: function (e, t) {
        for (var i = 0, n = this._renderer.length; n > i; i++) this._renderer[i].setCanvasDimensions(e, t), this._renderer[i].setViewPortDimensions(e, t), this._renderer[i].clear()
    },
    onUpdateViewDimensions: function (e, t) {
        var i = this._canvasList;
        return (void 0 === e || void 0 === t) && (e = $(i[0]).width(), t = $(i[0]).height()), e && t && (e !== this._width || t !== this._height) ? (this.updateDimensionsForRenderer(e, t), this._camera.setDimensions(e, t), this._width = e, this._height = t, !0) : !1
    },
    addObject: function (e, t) {
        var i = WS.ViewBase.prototype.addObject.call(this, e);
        if (2 === i && e.createRenderable && !this.hasRenderableOfType(e._UUID, WS.View3d.RenderableType.DEFAULT)) {
            var n = e.createRenderable(this),
                r = this;
            Q.isPromise(n) ? n.then(function (i) {
                i && r.addRenderable(i, WS.View3d.RenderableType.DEFAULT, e, t)
            }) : n && this.addRenderable(n, WS.View3d.RenderableType.DEFAULT, e, t)
        }
        return i
    },
    addRenderable: function (e, t, i, n) {
        t = t || WS.View3d.RenderableType.DEFAULT, n && e.addToLayer(n._id, !0);
        var r = e.getUuid();
        void 0 === this._renderableMap[r] && (this._renderableMap[r] = {}), this._renderableMap[r][t] = e, this._scene.add(e)
    },
    updateAddedRenderable: function (e, t) {
        e._dataObject && e._dataObject === this._hlObject ? this.highlight(e._dataObject) : this.updateViewingMode(e);
        var i = void 0 !== e.redraw;
        e.update && e.update(i), e.setIconMode && e.setIconMode(t, i), i && e.redraw()
    },
    updateViewingMode: function (e) {
        var t = e._dataObject;
        e.setViewingMode(t && t._selected ? WS.Renderable.ViewingMode.Selected : t && this._hlObject === t ? WS.Renderable.ViewingMode.Highlighted : WS.Renderable.ViewingMode.Normal)
    },
    hasRenderableOfType: function (e, t) {
        for (var i in this._renderableMap[e])
            if (this._renderableMap[e].hasOwnProperty(i) && i === t) return !0;
        return !1
    },
    removeRenderables: function (e) {
        for (var t in this._renderableMap[e]) this._renderableMap[e].hasOwnProperty(t) && this.removeRenderable(this._renderableMap[e][t], e)
    },
    removeRenderable: function (e, t) {
        t = t || e._UUID || e._dataObject._UUID, this._scene.remove(e, !0);
        for (var i in this._renderableMap[t]) this._renderableMap[t].hasOwnProperty(i) && this._renderableMap[t][i] === e && delete this._renderableMap[t][i];
        0 === this._renderableMap[t].length && delete this._renderableMap[t], this.deleteStorageForRenderableAndMembers(e)
    },
    deleteStorageForRenderableAndMembers: function (e) {
        for (var t = 0, i = this._renderer.length; i > t; ++t) this._renderer[t].deleteStorageForRenderableAndMembers(e)
    },
    getRenderable: function (e, t) {
        return e && e._UUID && this._renderableMap[e._UUID] ? (t = t || WS.View3d.RenderableType.DEFAULT, this._renderableMap[e._UUID][t]) : void 0
    },
    getRenderables: function (e) {
        if (!e || !e._UUID) return [];
        var t = e._UUID,
            i = [];
        for (var n in this._renderableMap[t]) this._renderableMap[t].hasOwnProperty(n) && i.push(this._renderableMap[t][n]);
        return i
    },
    getAllRenderables: function () {
        var e = [];
        for (var t in this._renderableMap)
            if (this._renderableMap.hasOwnProperty(t))
                for (var i in this._renderableMap[t]) this._renderableMap[t].hasOwnProperty(i) && e.push(this._renderableMap[t][i]);
        return e
    },
    removeObject: function (e) {
        WS.ViewBase.prototype.removeObject.call(this, e), this.removeRenderables(e._UUID), this._fsm && "highlight" === this._fsm._state && this._fsm._meta.focus && this._fsm._meta.focus.object && this._fsm._meta.focus.object._UUID === e._UUID && (this._fsm.read("move"), this.updateURL()), this.$scope.menu && this.$scope.menu.object === e && this.hideRadialMenu()
    },
    removeAllObjects: function () {
        var e = this._objects,
            t = this,
            i = [];
        for (var n in e) e.hasOwnProperty(n) && e[n].entities.forEach(function (e) {
            i.push(e)
        });
        i.forEach(function (e) {
            t.removeObject(e)
        })
    },
    filterObjects: function () {
        var e = this._objects,
            t = this,
            i = [];
        for (var n in e) e.hasOwnProperty(n) && e[n].entities.forEach(function (e) {
            t.objectFilter(e) || i.push(e)
        });
        i.forEach(function (e) {
            t.removeObject(e)
        })
    },
    updateObject: function (e) {
        if (e && e._UUID)
            for (var t = this.getRenderables(e), i = 0, n = t.length; n > i; ++i) {
                var r = t[i];
                r._dataObject && r._dataObject === this._hlObject ? this.highlight(r._dataObject) : this.updateViewingMode(r), r.update()
            }
    },
    select: function (e) {
        for (var t = 0, i = e.length; i > t; ++t)
            for (var n = this.getRenderables(e[t]), r = 0, o = n.length; o > r; ++r) n[r].setViewingMode(WS.Renderable.ViewingMode.Selected)
    },
    unselect: function (e) {
        for (var t = 0, i = e.length; i > t; ++t)
            for (var n = this.getRenderables(e[t]), r = 0, o = n.length; o > r; ++r) n[r].setViewingMode(WS.Renderable.ViewingMode.Normal)
    },
    highlight: function (e) {
        e !== this._hlObject && this.unhighlight(this._hlObject), this._hlObject = e;
        for (var t = this.getRenderables(e), i = 0, n = t.length; n > i; ++i) this.updateViewingMode(t[i])
    },
    unhighlight: function (e) {
        this._hlObject === e && (this._hlObject = void 0);
        for (var t = this.getRenderables(e), i = 0, n = t.length; n > i; ++i) this.updateViewingMode(t[i])
    },
    getCamGlobalPos: function () {
        return this._camera ? this._camera.getGlobalPos(this._trafoView) : vec3.create([0, 0, 0])
    },
    getCameraObject: function () {
        return this._camera ? this._camera.createCameraObject(this._trafoView) : void 0
    },
    triggerCameraChange: function () {
        var e = this._camera;
        e && e._changesToTrigger && (this.trigger("onCameraChange", [this.getCameraObject(), this]), e._changesToTrigger = !1)
    },
    showRadialMenu: function (e, t, i) {
        if (this.$scope.menu.object !== e) {
            var n = e.instanceOf(WS.Scan) ? 240 : 220,
                r = n + 10,
                o = Math.max(t, r-10);
            o = Math.min(o, this._width - r);
            var a = Math.max(i, r + 50);
            this.highlight(e), this.$scope.$apply(function (t) {
                t.menu.object = e, t.menu.visible = !0, t.menu.x = o + "px", t.menu.y = a + "px"
            })
        }
    },
    hideRadialMenu: function () {
        this.$scope.menu && (this.$scope.menu.object && (this.unhighlight(this.$scope.menu.object), this.$scope.menu.object = void 0), this.$scope.$apply(function (e) {
            e.menu.visible = !1
        }))
    },
    removeLines: function () {
        this._linesRenderable && (this._scene && this._scene.removeChild(this._linesRenderable), this.deleteStorageForRenderableAndMembers(this._linesRenderable)), this._linesRenderable = void 0
    },
    removeLineEnd: function () {
        this._lineAreaEnd && (this._scene && this._scene.removeChild(this._lineAreaEnd), this.deleteStorageForRenderableAndMembers(this._lineAreaEnd)), this._lineAreaEnd = void 0
    },
    createLine: function (e, t, i, n, r, o) {
        var a = t ? new WS.ArrayBuffer(t, 4) : void 0,
            s = i ? new WS.ArrayBuffer(i, 4) : void 0,
            c = n ? new WS.ArrayBuffer(n, 4) : void 0,
            l = 1 / this._unit.getExactLength(1);
        this._linesRenderable = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), s, c, a, WS.LineMaterial.Dash.Adaptive, r, o, t, l), this._linesRenderable.addToLayer(WS.Layer.LayerIDs.TEMP, !0), this._linesRenderable.setCornerPointsFrom2dArray(e), this._linesRenderable.setViewingMode(WS.Renderable.ViewingMode.Normal), this._scene.add(this._linesRenderable)
    },
    createLineEnd: function (e, t, i) {
        var n = e.length;
        if (!(3 > n)) {
            var r = [e[e.length - 1], e[0]],
                o = this._linesRenderable.getCurrentDashLength(),
                a = t ? new WS.ArrayBuffer(t, 4) : void 0,
                s = i ? new WS.ArrayBuffer(i, 4) : void 0;
            this._lineAreaEnd = new WS.DottedLinesRenderable(new WS.ArrayBuffer([], 3), a, s, new WS.ArrayBuffer([.5, .5, .5, 1], 4), WS.LineMaterial.Dash.Fixed, 4, 6, [1, 1, 1, 1], o), this._lineAreaEnd.addToLayer(WS.Layer.LayerIDs.TEMP, !0), this._lineAreaEnd.setCornerPointsFrom2dArray(r), this._lineAreaEnd.setViewingMode(WS.Renderable.ViewingMode.Normal), this._scene.add(this._lineAreaEnd)
        }
    }
}, WS.extend("View3d", "ViewBase"), WS.View3d.RenderMode = {
    WebGl: 1,
    Canvas: 2
}, WS.View3d.RenderableType = {
    DEFAULT: "d",
    PANORAMA: "p",
    SCAN_CLOUD: "s"
}, F.DI().registerService("point3d", WS.Point3dService, "@plug", "@distance"), F.DI().config("@plug", WS.viewConfigPlug = function (e) {
    e.describe("ViewMode", ["setMode"]), e.describe("CameraChanged", ["onCameraChange"]), e.describe("SceneRootChange", ["sceneRootChange"]), e.describe("PointPick3D", ["pickPoint"]), e.describe("PointPick3DControl", ["setPickedPoints"]), e.describe("ViewFocus", ["focusOn"])
}), F.DI().registerParameter("viewselectiontoolbar", {
    tools: [{
        showDefault: !0,
        icon: "select_48.png",
        id: WS.ViewBase.Mode.SelectObjects
    }, {
        showDefault: !0,
        icon: "rectangle_light_plus_76.png",
        id: WS.ViewBase.Mode.SelectObjectsRectAdd
    }, {
        showDefault: !0,
        icon: "rectangle_light_minus_76.png",
        id: WS.ViewBase.Mode.SelectObjectsRectSub
    }],
    text: F.isTouch() ? "FE_VIEW_NAVIGATE_TOUCH" : "FE_VIEW_NAVIGATE_MOUSE"
}), WS.PanoSettings = function (e, t, i, n, r, o, a, s, c, l, h, d) {
    WS.CRUDObject.call(this, d), this._movementSpeed = void 0 !== e ? e : 10, this._imageResolutionIndex = void 0 !== t ? t : 2, this._imageResolutionIndex = Math.min(this._imageResolutionIndex, WS.Scan.DeviceMaxResolutionIdx), this._colorMode = void 0 !== i ? i : "color", this._iconMode = void 0 !== n ? n : WS.PanoSettings.IconModes.Category, this._blendFactor = void 0 !== r ? r : .6, this._enableWebGl = void 0 !== o ? o : !0, this._showCompass = void 0 !== a ? a : !0, this._showScanLabelsInPano = void 0 !== s ? s : !0, this._showOrthoVolumes = c || !1, this._details3d = void 0 !== l ? l : WS.PanoSettings.Detail3d.AUTOMATIC, this._showPolylines = void 0 !== h ? h : !0
}, WS.PanoSettings.prototype = {
    clone: function () {
        return new WS.PanoSettings(this._movementSpeed, this._imageResolutionIndex, this._colorMode, this._iconMode, this._blendFactor, this._enableWebGl, this._showCompass, this._showScanLabelsInPano, this._showOrthoVolumes, this._details3d, this._showPolylines, this._service)
    },
    getPanoImageResolution: function () {
        return WS.PanoSettings.Resolutions[this._imageResolutionIndex]
    },
    getColorMode: function () {
        return WS.PanoSettings.ColorModes[this._colorMode]
    },
    writeToLocalStorage: function () {
        this._service.writeToLocalStorage(this)
    },
    details3d: function () {
        var e = this._details3d;
        return e === WS.PanoSettings.Detail3d.AUTOMATIC ? WS.PanoSettings.autoDetails3d() : e
    }
}, WS.extend("PanoSettings", "CRUDObject"), WS.PanoSettings.ColorModes = WS.Scan.PanoImageColorModes, WS.PanoSettings.Resolutions = WS.Scan.PanoImageResolutions, WS.PanoSettings.MinMovementSpeed = 1, WS.PanoSettings.MaxMovementSpeed = 20, WS.PanoSettings.IconModes = WS.LabelRenderable.ICON_MODES, WS.PanoSettings.IconModeNames = ["FE_NO_ICONS", "FE_ICON_CATEGORY", "FE_ICON_READWRITE"], WS.PanoSettings.Detail3d = {
    AUTOMATIC: "Automatic",
    VERY_LOW: "VeryLow",
    LOW: "Low",
    MEDIUM: "Medium",
    HIGH: "High",
    VERY_HIGH: "VeryHigh"
}, WS.PanoSettings.autoDetails3d = function () {
    return F.isMobile() || 11 === F.ieVersion() ? WS.PanoSettings.Detail3d.MEDIUM : WS._2GO ? WS.PanoSettings.Detail3d.HIGH : WS.PanoSettings.Detail3d.VERY_HIGH
}, WS.PanoSettings.details3dStringID = function (e) {
    switch (e) {
        case WS.PanoSettings.Detail3d.VERY_LOW:
            return "FE_RESOLUTION_VERYLOW";
        case WS.PanoSettings.Detail3d.LOW:
            return "FE_RESOLUTION_LOW";
        case WS.PanoSettings.Detail3d.MEDIUM:
            return "FE_RESOLUTION_MEDIUM";
        case WS.PanoSettings.Detail3d.HIGH:
            return "FE_RESOLUTION_HIGH";
        case WS.PanoSettings.Detail3d.VERY_HIGH:
            return "FE_RESOLUTION_VERYHIGH";
        default:
            return "FE_AUTOMATIC"
    }
}, L.TileLayer.Canvas.WithZoomOffset = L.TileLayer.Canvas.extend({
    options: {},
    initialize: function (e) {
        this._map = void 0, L.TileLayer.Canvas.prototype.initialize.call(this, e), L.setOptions(this, e)
    },
    onAdd: function (e) {
        this._map = e, this.calcLayerZoom(), L.TileLayer.Canvas.prototype.onAdd.call(this, e)
    },
    calcLayerZoom: function () {
        var e = this.options._wsZoomOffset,
            t = this._map.getZoom(),
            i = this.options._wsNativeTileSize,
            n = this.options.minZoom,
            r = this.options.maxNativeZoom;
        "number" != typeof r && (r = this.options.maxZoom);
        var o = t + e;
        o = Math.max(o, n), o = Math.min(o, r), e = o - t, this.options.tileSize = i * Math.pow(2, -e), this.options.zoomOffset = e, this.options._wsLayerZoom = o
    },
    _reset: function () {
        this.calcLayerZoom(), L.TileLayer.Canvas.prototype._reset.apply(this, Array.prototype.slice.call(arguments, 1))
    },
    _createTile: function () {
        var e = L.TileLayer.Canvas.prototype._createTile.call(this);
        return e.width = e.height = this.options._wsNativeTileSize, e.style.width = e.style.height = this._getTileSize() + "px", e.className += " f_pixelated", e
    },
    _loadTile: function (e, t) {
        this._adjustTilePoint(t), L.TileLayer.Canvas.prototype._loadTile.call(this, e, t)
    }
}), WS.ScanTilesLayer = L.TileLayer.Canvas.WithZoomOffset.extend({
    initialize: function (e, t, i, n, r, o, a, s, c) {
        a = void 0 !== a ? a : WS.ScanTilesLayer.ZOOM_OFFSET, s = void 0 !== s ? s : WS.ScanTilesLayer.MAX_PARALLEL_IMG_LOADS, c = c || function () {
            return new Image
        }, L.TileLayer.Canvas.WithZoomOffset.prototype.initialize.call(this, {
            async: !1,
            minZoom: e._scanLayersMinLevel,
            maxZoom: e._scanLayersMaxLevel + WS.OverviewMap.ADDITIONAL_ZOOM_LEVELS,
            maxNativeZoom: e._scanLayersMaxLevel,
            _wsZoomOffset: a,
            _wsNativeTileSize: 256,
            continuousWorld: !0,
            noWrap: !0,
            opacity: 1,
            zIndex: WS.ScanTilesLayer.Z_INDEX_START_SCANS
        }), this._projectId = o, this._scanLayerData = i, this._highlightedScanIds = {
            mouseover: [],
            menu: [],
            selection: [],
            all: []
        }, this._timeouts = {
            mouseover: void 0
        }, this._clustersByScanId = {}, this._scanColors = {}, this._pendingTiles = {}, this._loadedTiles = {}, this._tileQueue = [], this._numLoadingTiles = 0, this._canvasMap = {}, this._enableLoadingTiles = !0, this._scanColorizer = n, this._scanList = t, this._maxParallelImgLoads = s, this._imgFactory = c, this._CDN = r
    },
    onAdd: function (e) {
        L.TileLayer.Canvas.WithZoomOffset.prototype.onAdd.call(this, e), e.on("moveend", this.loadFromQueue, this), e.on("zoomend", this.resetAfterZoom, this), this.resetAfterZoom()
    },
    onRemove: function (e) {
        L.TileLayer.Canvas.WithZoomOffset.prototype.onRemove.call(this, e), e.off("moveend", this.loadFromQueue, this), e.off("zoomend", this.resetAfterZoom, this)
    },
    resetAfterZoom: function () {
        this.calcLayerZoom(), this.options._wsLayerZoom !== this._currentZoom && this.discardAllTiles(), this._currentZoom = this.options._wsLayerZoom, this.setScanList("mouseover", []), this.cleanupCanvasMap(this._currentZoom), this.redraw()
    },
    redraw: function () {
        this.calcColors(), this._map && L.TileLayer.Canvas.WithZoomOffset.prototype.redraw.call(this)
    },
    setScanList: function (e, t) {
        var i = "mouseover" === e ? WS.ScanTilesLayer.TIMEOUT_MOUSEOVER : 0;
        this.setScanListInternal(e, t, i)
    },
    setScanListInternal: function (e, t, i, n) {
        var r = this;
        if (i > 0) {
            var o = function () {
                r.setScanListInternal(e, t, 0, !0)
            };
            "number" == typeof this._timeouts[e] && clearTimeout(this._timeouts[e]), this._timeouts[e] = setTimeout(o, i)
        } else {
            n && "number" == typeof this._timeouts[e] && (this._timeouts[e] = void 0);
            var a = this._highlightedScanIds[e];
            if (a.length = 0, t.forEach(function (e) {
                    a.push(e)
                }), "mouseover" === e) {
                this._clustersByScanId = {};
                var s = this._clustersByScanId;
                t.forEach(function (e) {
                    s[e] = t
                })
            }
            this.onUpdateScanSet()
        }
    },
    addToScanList: function (e, t) {
        var i = this._highlightedScanIds[e];
        t.forEach(function (e) {
            F.addUnique(i, e)
        }), this.onUpdateScanSet()
    },
    removeFromScanList: function (e, t) {
        var i = this._highlightedScanIds[e];
        t.forEach(function (e) {
            F.removeFirst(i, e)
        }), this.onUpdateScanSet()
    },
    removeFromAllScanLists: function (e) {
        var t = ["selection", "menu", "mouseover"];
        t.forEach(F.proxy(function (t) {
            "number" == typeof this._timeouts[t] && (clearTimeout(this._timeouts[t]), this._timeouts[t] = void 0);
            var i = this._highlightedScanIds[t];
            e.forEach(function (e) {
                F.removeFirst(i, e)
            })
        }, this)), this.onUpdateScanSet()
    },
    onUpdateScanSet: function () {
        var e = this._highlightedScanIds,
            t = e.all,
            i = [];
        [].concat(e.mouseover, e.selection, e.menu).forEach(function (e) {
            F.addUnique(i, e)
        }), this.sortScanList(i);
        var n = [],
            r = [];
        i.forEach(function (e) {
            t.indexOf(e) < 0 && n.push(e)
        }), t.forEach(function (e) {
            i.indexOf(e) < 0 && r.push(e)
        });
        var o = !1;
        n.length > 0 && (this.onHighlightScans(n), o = !0), r.length > 0 && (this.onUnhighlightScans(r), o = !0), o && (e.all = i, this.redraw())
    },
    sortScanList: function (e) {
        var t = {};
        this._scanList.forEach(function (e) {
            t[e._UUID] = e
        });
        var i = function (e, i) {
            var n = t[e],
                r = t[i];
            return n.getGlobalZ() !== r.getGlobalZ() ? n.getGlobalZ() - r.getGlobalZ() : n._UUID > r._UUID ? 1 : n._UUID < r._UUID ? -1 : 0
        };
        e.sort(i)
    },
    onHighlightScans: function () {
    },
    onUnhighlightScans: function (e) {
        this.abortPendingTilesForScans(e)
    },
    abortPendingTilesForScans: function (e) {
        if (0 !== e.length) {
            var t, i, n, r = this,
                o = this._pendingTiles;
            for (var a in o)
                if (o.hasOwnProperty(a) && o[a]) {
                    t = o[a];
                    for (var s in t)
                        if (t.hasOwnProperty(s) && t[s]) {
                            i = t[s];
                            for (var c in i) i.hasOwnProperty(c) && i[c] && (n = i[c], e.forEach(function (e) {
                                n[e] && (r.abortPendingTile(n[e]), delete n[e])
                            }))
                        }
                }
            this._tileQueue = this._tileQueue.filter(function (t) {
                return e.indexOf(t.scanid) < 0
            })
        }
    },
    abortAllPendingTiles: function () {
        var e, t, i, n = this._pendingTiles;
        for (var r in n)
            if (n.hasOwnProperty(r) && n[r]) {
                e = n[r];
                for (var o in e)
                    if (e.hasOwnProperty(o) && e[o]) {
                        t = e[o];
                        for (var a in t)
                            if (t.hasOwnProperty(a) && t[a]) {
                                i = t[a];
                                for (var s in i) i.hasOwnProperty(s) && i[s] && this.abortPendingTile(i[s])
                            }
                    }
                delete n[r]
            }
        this._tileQueue.length = 0, this._numLoadingTiles = 0
    },
    isImage: function (e) {
        return "object" == typeof e && e instanceof Image
    },
    abortPendingTile: function (e) {
        if (this.isImage(e)) {
            this._numLoadingTiles--;
            var t = WS.ScanTilesLayer.falseFn;
            e.onload = t, e.onerror = t, e.onabort = t, e.src = WS.MapLeaflet.EMPTY_IMG_URL
        }
    },
    discardAllTiles: function () {
        this.abortAllPendingTiles();
        var e = this._loadedTiles;
        for (var t in e) e.hasOwnProperty(t) && delete e[t]
    },
    enableLoadingTiles: function (e) {
        this._enableLoadingTiles = e, this.loadFromQueue()
    },
    loadOrQueueScanTile: function (e, t, i, n) {
        if (this._enableLoadingTiles) {
            var r = this._pendingTiles;
            r[e] && r[e][t] && r[e][t][i] && r[e][t][i][n] || (this._numLoadingTiles >= this._maxParallelImgLoads ? (this._tileQueue.push({
                zoom: e,
                x: t,
                y: i,
                scanid: n
            }), this.addTileToStorage(r, WS.ScanTilesLayer.ImgStatus.QUEUED, e, t, i, n)) : this.loadScanTile(e, t, i, n))
        }
    },
    loadScanTile: function (e, t, i, n) {
        var r, o = this,
            a = this._imgFactory();
        if (WS._2GO) r = "ws2go-data/project/" + this._projectId + "/map/scan-layers/" + n + "/tiles/" + e + "/" + t + "/" + i + ".png";
        else {
            var s;
            if (F.isImgCrossOriginAvailable() && this._CDN.hasCDN() && (s = this._CDN.getSignature(this._projectId, !0)), !s || Q.isPromise(s)) r = "/data/project/" + this._projectId + "/scan-tile/" + n + "/" + e + "/" + t + "/" + i;
            else {
                var c = this._CDN.getSource(s, Math.abs(e + t + i));
                r = c.BaseURL + this._projectId + "/map/scan-layers/" + n + "/tiles/" + e + "/" + t + "/" + i + ".png" + c.Query, a.crossOrigin = "anonymous"
            }
        }
        var l = function () {
                o.onScanTileLoad(a, e, t, i, n)
            },
            h = function () {
                o.onScanTileError(e, t, i, n)
            };
        a.onload = l, a.onerror = h, a.onabort = h, a.src = r, this._numLoadingTiles++, this.addTileToStorage(this._pendingTiles, a, e, t, i, n)
    },
    loadFromQueue: function () {
        if (this._enableLoadingTiles)
            for (var e = this._map.getPixelBounds(), t = this._getTileSize(), i = L.bounds(e.min.divideBy(t).floor(), e.max.divideBy(t).floor()), n = 0; this._numLoadingTiles < this._maxParallelImgLoads && n < this._tileQueue.length;) {
                var r = this._tileQueue[n];
                i.contains(L.point(r.x, r.y)) ? (this._tileQueue.splice(n, 1), this.loadScanTile(r.zoom, r.x, r.y, r.scanid)) : n++
            }
    },
    onScanTileLoad: function (e, t, i, n, r) {
        this._numLoadingTiles--;
        var o = {
            orig: e,
            colorized: void 0,
            color: void 0
        };
        this.removeTileFromStorage(this._pendingTiles, t, i, n, r), this.addTileToStorage(this._loadedTiles, o, t, i, n, r), this.drawTileForCoords(t, i, n, !1), this.loadFromQueue()
    },
    onScanTileError: function (e, t, i, n) {
        this._numLoadingTiles--;
        var r = {
            orig: WS.ScanTilesLayer.ImgStatus.NOT_FOUND,
            colorized: void 0,
            color: void 0
        };
        this.removeTileFromStorage(this._pendingTiles, e, t, i, n), this.addTileToStorage(this._loadedTiles, r, e, t, i, n), this.loadFromQueue()
    },
    removeTileFromStorage: function (e, t, i, n, r) {
        e[t] && e[t][i] && e[t][i][n] && e[t][i][n][r] && delete e[t][i][n][r]
    },
    addTileToStorage: function (e, t, i, n, r, o) {
        e[i] = e[i] || {}, e[i][n] = e[i][n] || {}, e[i][n][r] = e[i][n][r] || {}, e[i][n][r][o] = t
    },
    drawTile: function (e, t) {
        var i = t.z,
            n = t.x,
            r = t.y,
            o = this._canvasMap;
        o[i] = o[i] || {}, o[i][n] = o[i][n] || {}, o[i][n][r] = e, this.drawTileForCoords(i, n, r, !0)
    },
    drawTileForCoords: function (e, t, i, n) {
        var r = this._canvasMap;
        if (!r[e] || !r[e][t] || !r[e][t][i]) return !1;
        var o = r[e][t][i],
            a = this.getScansRequiredForTile(e, t, i),
            s = this,
            c = a.map(function (r) {
                var o = s.getLoadedScanTile(e, t, i, r);
                return !o && n && s.loadOrQueueScanTile(e, t, i, r), o
            });
        return this.doDrawTile(o, a, c), !0
    },
    doDrawTile: function (e, t, i) {
        var n = this,
            r = e.getContext("2d"),
            o = e.width,
            a = e.height,
            s = document.createElement("canvas");
        s.width = o, s.height = a;
        for (var c, l = s.getContext("2d"), h = 0, d = t.length; d > h; h++) {
            var u = i[h];
            if (u) {
                var _ = u.orig,
                    p = u.color;
                if (this.isImage(_)) {
                    var g, f = t[h],
                        m = n._scanColors[f];
                    if (u.colorized && p && p.r === m.r && p.g === m.g && p.b === m.b) g = u.colorized;
                    else {
                        g = document.createElement("canvas"), g.width = o, g.height = a;
                        var v = g.getContext("2d");
                        v.drawImage(_, 0, 0), c = v.getImageData(0, 0, o, a), n._scanColorizer.colorizePixels(c, m), v.putImageData(c, 0, 0), u.colorized = g, u.color = {
                            r: m.r,
                            g: m.g,
                            b: m.b
                        }
                    }
                    l.drawImage(g, 0, 0)
                }
            }
        }
        c = l.getImageData(0, 0, o, a), r.putImageData(c, 0, 0)
    },
    calcColors: function () {
        var e = this,
            t = this._highlightedScanIds.all;
        this._scanColors = {}, t.forEach(function (t) {
            var i = e._clustersByScanId[t] || [t],
                n = e._scanColorizer.getScanTileColor(t, i);
            e._scanColors[t] = n
        })
    },
    getLoadedScanTile: function (e, t, i, n) {
        var r = this._loadedTiles;
        return r[e] && r[e][t] && r[e][t][i] && r[e][t][i][n]
    },
    getScansRequiredForTile: function (e, t, i) {
        var n = this._highlightedScanIds.all,
            r = this._scanLayerData._layers,
            o = n.filter(function (n) {
                return r && r[n] && r[n]._tiles && r[n]._tiles[e] && r[n]._tiles[e][t] && r[n]._tiles[e][t][i]
            });
        return o
    },
    cleanupCanvasMap: function (e) {
        var t = this._canvasMap;
        for (var i in t) i !== e && t.hasOwnProperty(i) && t[i] && delete t[i]
    },
    isInQueue: function (e, t, i, n) {
        var r = F.findFirst(this._tileQueue, function (r) {
            return r.zoom === e && r.x === t && r.y === i && r.scanid === n
        });
        return !!r
    },
    consistencyCheck: function () {
        var e, t, i, n = this._pendingTiles,
            r = 0,
            o = 0;
        for (var a in n)
            if (n.hasOwnProperty(a) && n[a]) {
                e = n[a];
                {
                    parseInt(a)
                }
                for (var s in e)
                    if (e.hasOwnProperty(s) && e[s]) {
                        t = e[s];
                        {
                            parseInt(s)
                        }
                        for (var c in t)
                            if (t.hasOwnProperty(c) && t[c]) {
                                i = t[c];
                                {
                                    parseInt(c)
                                }
                                for (var l in i) i.hasOwnProperty(l) && i[l] && (i[l] === WS.ScanTilesLayer.ImgStatus.QUEUED ? o++ : r++)
                            }
                    }
            }
        return !0
    }
}), WS.ScanTilesLayer.falseFn = function () {
    return !1
}, WS.ScanTilesLayer.ImgStatus = {
    LOADED: 1,
    LOADING: 2,
    QUEUED: 3,
    NOT_FOUND: 4
}, WS.ScanTilesLayer.MAX_PARALLEL_IMG_LOADS = F.isMobile() ? 10 : 20, WS.ScanTilesLayer.TIMEOUT_MOUSEOVER = 300, WS.ScanTilesLayer.ZOOM_OFFSET = -2, WS.ScanTilesLayer.Z_INDEX_START_LAYERS = 0, WS.ScanTilesLayer.Z_INDEX_MAP = 1e3, WS.ScanTilesLayer.Z_INDEX_START_SCANS = 1001, WS.ColorGradient = function (e) {
    this._colorPalette = e
}, WS.ColorGradient.prototype = {
    getInterpolatedColor: function (e) {
        var t = this._colorPalette.length,
            i = Math.floor(e * (t - 1)),
            n = e * (t - 1) - i,
            r = 1 - n;
        if (0 > i) return this._colorPalette[0];
        if (i >= t - 1) return this._colorPalette[t - 1];
        var o = this._colorPalette[i],
            a = this._colorPalette[i + 1];
        return {
            r: Math.round(r * o.r + n * a.r),
            g: Math.round(r * o.g + n * a.g),
            b: Math.round(r * o.b + n * a.b)
        }
    },
    getCanvasGradient: function (e, t, i, n, r) {
        for (var o = e.createLinearGradient(t, i, n, r), a = this._colorPalette.length, s = 1 / (a - 1), c = 1, l = 0; a > l; l++) {
            var h = this._colorPalette[l];
            o.addColorStop(c, "rgb(" + h.r + "," + h.g + "," + h.b + ")"), c = Math.max(0, c - s)
        }
        return o
    }
}, WS.extend("ColorGradient"), WS.MapMarker = function (e, t, i, n) {
    this._parent = t, this._visible = !1, this._marker = L.marker(i, n), this._marker._wsObject = e
}, WS.MapMarker.prototype = {
    getObject: function () {
        return this._marker._wsObject
    },
    getMarker: function () {
        return this._marker
    },
    getLatLng: function () {
        return this._marker.getLatLng()
    },
    setLatLng: function (e) {
        this._marker.setLatLng(e)
    },
    setVisible: function (e) {
        e && !this._visible ? this.add() : !e && this._visible && this.remove()
    },
    add: function () {
        this._parent._wsBulkAdd ? this._parent._wsBulkAdd.push(this._marker) : this._parent.addLayer(this._marker), this._visible = !0
    },
    remove: function () {
        this._parent._wsBulkRemove ? this._parent._wsBulkRemove.push(this._marker) : this._parent.removeLayer(this._marker), this._visible = !1
    },
    setParent: function (e) {
        return this._visible ? void(e !== this._parent && (this._parent.removeLayer(this._marker), e.addLayer(this._marker), this._parent = e)) : void(this._parent = e)
    },
    setWorldIcon: function () {
        this._marker.setIcon(WS.MapMarker.ICON_WORLD)
    },
    setIconByUrl: function (e) {
        var t = L.icon({
            iconUrl: e,
            iconSize: WS.MapMarker.SIZE,
            iconAnchor: WS.MapMarker.ICON_ANCHOR,
            popupAnchor: WS.MapMarker.POPUP_ANCHOR,
            shadowUrl: WS.MapMarker.SHADOW_URL,
            shadowSize: WS.MapMarker.SHADOW_SIZE,
            shadowAnchor: WS.MapMarker.SHADOW_ANCHOR
        });
        this._marker.setIcon(t)
    },
    setTitle: function (e) {
        this._marker.options.title = e, this._marker._icon && (this._marker._icon.title = e)
    },
    on: function (e, t, i) {
        this._marker.on(e, t, i)
    },
    off: function (e, t, i) {
        this._marker.off(e, t, i)
    }
}, WS.extend("MapMarker"), WS.MapMarker.SIZE = [32, 45], WS.MapMarker.ICON_ANCHOR = [16, 43], WS.MapMarker.POPUP_ANCHOR = [0, -45], WS.MapMarker.SHADOW_URL = WS.imgUrl("icons/im/map_marker_shadow.png"), WS.MapMarker.SHADOW_SIZE = [40, 50], WS.MapMarker.SHADOW_ANCHOR = [20, 46], WS.MapMarker.ICON_WORLD = L.icon({
    iconUrl: WS.imgUrl("icons/im/old_map_marker_or.png"),
    iconSize: WS.MapMarker.SIZE,
    iconAnchor: WS.MapMarker.ICON_ANCHOR,
    popupAnchor: WS.MapMarker.POPUP_ANCHOR,
    shadowUrl: WS.MapMarker.SHADOW_URL,
    shadowSize: WS.MapMarker.SHADOW_SIZE,
    shadowAnchor: WS.MapMarker.SHADOW_ANCHOR
}), WS.MapMarker.prefetchIcons = function () {
    var e = document.createElement("img");
    e.src = WS.MapMarker.ICON_WORLD.options.iconUrl;
    var t = document.createElement("img");
    t.src = WS.MapMarker.ICON_WORLD.options.shadowUrl
}, WS.MapMarker.bulkBegin = function (e) {
    e._wsBulkAdd = [], e._wsBulkRemove = []
}, WS.MapMarker.bulkEnd = function (e) {
    e._wsBulkAdd.length && e.addLayers(e._wsBulkAdd), e._wsBulkRemove.length && e.removeLayers(e._wsBulkRemove), e._wsBulkAdd = void 0, e._wsBulkRemove = void 0
}, WS.MapImageControl = L.Control.extend({
    options: {},
    initialize: function (e, t) {
        L.Util.setOptions(this, t), e = e || WS.MapLeaflet.EMPTY_IMG_URL;
        var i = "";
        this.options.cssClass && (i = 'class="' + this.options.cssClass + '"');
        var n = $('<img src="' + e + '" ' + i + ">");
        this._img = n[0]
    },
    onAdd: function () {
        return this._img
    },
    onRemove: function () {
    },
    setUrl: function (e) {
        this._img.src = e || WS.MapLeaflet.EMPTY_IMG_URL
    },
    setOpacity: function (e) {
        this._img.style.opacity = e
    },
    setVisible: function (e) {
        this._img.style.display = e ? "inline" : "none"
    }
}), WS.MapLeafletViewAllControl = L.Control.extend({
    options: {
        position: "topleft",
        tooltip: ""
    },
    initialize: function (e, t, i) {
        this._mapLeaflet = t, L.Util.setOptions(this, i), this.options.tooltip && (this.options.tooltip = e.translate(this.options.tooltip))
    },
    onAdd: function () {
        {
            var e = L.DomUtil.create("div", "ws_overviewmap_ViewAllControl leaflet-control-zoom leaflet-bar leaflet-control");
            this.createButton("", this.options.tooltip, "ws_overviewmap_ViewAllControl f_cursorPointer", e, this.onClick, this)
        }
        return e
    },
    createButton: function (e, t, i, n, r, o) {
        var a = L.DomUtil.create("a", i, n);
        a.innerHTML = e, a.title = t;
        var s = L.DomEvent.stopPropagation;
        return L.DomEvent.on(a, "click", s).on(a, "mousedown", s).on(a, "dblclick", s).on(a, "click", L.DomEvent.preventDefault).on(a, "click", r, o), a
    },
    onClick: function () {
        this._mapLeaflet.zoomFit()
    }
}), WS.MapLeaflet = function (e, t, i, n, r) {
    WS.View3d.call(this, e, t, r), this._locale = i, this._unit = n, this._targetDomElement = void 0, this._overlayContainer = void 0, this._markerMap = {}, this._fitMarkersMargin = 0, this._map = void 0
}, WS.MapLeaflet.prototype = {
    initMap: function () {
        this._markerMap = {}
    },
    setContainerDiv: function (e) {
        this._targetDomElement = e
    },
    addViewAllControl: function (e) {
        var t = new WS.MapLeafletViewAllControl(this._locale, this, e);
        this._map.addControl(t)
    },
    addMarker: function (e, t) {
        this._markerMap[e] = t
    },
    removeMarker: function (e) {
        this._markerMap[e] && (this._markerMap[e].setVisible(!1), delete this._markerMap[e])
    },
    getMarkerArray: function () {
        var e = [];
        for (var t in this._markerMap) this._markerMap.hasOwnProperty(t) && e.push(this._markerMap[t]);
        return e
    },
    getMarkerBounds: function () {
        var e = this.getMarkerArray(),
            t = e.map(function (e) {
                return e.getLatLng()
            }),
            i = L.latLngBounds(t);
        return i
    },
    fitMarkers: function () {
        this.invalidateSize();
        var e = this.getMarkerBounds();
        this.fitBounds(e, this._fitMarkersMargin)
    },
    zoomFit: function () {
    },
    getCenterOfMarkers: function () {
        return this.getMarkerBounds().getCenter()
    },
    containerPointToXYZ: function (e, t) {
        var i = this._map.containerPointToLatLng(new L.Point(e, t, !1));
        return [i.lng, i.lat, 0]
    },
    latLngToPixel: function (e) {
        return this._map.project(e)
    },
    latLngToLayerPoint: function (e) {
        return this._map.latLngToLayerPoint(e)
    },
    layerPointToLatLng: function (e) {
        return this._map.layerPointToLatLng(e)
    },
    layerPointToContainerPoint: function (e) {
        return this._map.layerPointToContainerPoint(e)
    },
    containerPointToLayerPoint: function (e) {
        return this._map.containerPointToLayerPoint(e)
    },
    latLngToContainerPoint: function (e) {
        return this._map.latLngToContainerPoint(e)
    },
    isContainerVisible: function () {
        var e = this._targetDomElement;
        return e && e.offsetWidth > 0 && e.offsetHeight > 0
    },
    setAnimOptions: function (e) {
        var t = this.isContainerVisible() ? {} : {
            animate: !1
        };
        return L.extend({
            animate: !0
        }, e, t)
    },
    setZoom: function (e, t) {
        this._map.setZoom(e, this.setAnimOptions(t))
    },
    zoomIn: function (e, t) {
        this._map.zoomIn(e, this.setAnimOptions(t))
    },
    zoomOut: function (e, t) {
        this._map.zoomOut(e, this.setAnimOptions(t))
    },
    setView: function (e, t, i) {
        this._map.setView(e, t, this.setAnimOptions(i))
    },
    fitBounds: function (e, t, i) {
        void 0 === t && (t = 0);
        var n = L.latLng(e.getSouth() - t, e.getWest() - t),
            r = L.latLng(e.getNorth() + t, e.getEast() + t);
        e = L.latLngBounds(n, r), this._map.fitBounds(e, this.setAnimOptions(i))
    },
    invalidateSize: function () {
        this._map && this._map.invalidateSize()
    },
    clickDebugMode: function (e) {
        this._map.on("click", F.proxy(this.onClickPosInfo, this)), e && this._map.on("click", F.proxy(this.onClickMapInfo, this))
    },
    locationDebugMode: function () {
        this._map.locate({
            setView: !0,
            maxZoom: 2
        }), this._map.on("locationfound", F.proxy(this.onLocationFound, this)), this._map.on("locationerror", F.proxy(this.onLocationError, this))
    },
    onLocationFound: function (e) {
        var t = e.accuracy / 2;
        L.marker(e.latlng).addTo(this._map).bindPopup("You are within " + t + " meters from this point"), L.circle(e.latlng, t).addTo(this._map)
    },
    onLocationError: function (e) {
        alert(e.message)
    },
    onClickPosInfo: function () {
    },
    onClickMapInfo: function () {
    }
}, WS.extend("MapLeaflet", "View3d"), WS.MapLeaflet.EMPTY_IMG_URL = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7", WS.WSTilesLayer = L.TileLayer.extend({
    initialize: function (e, t, i, n, r, o) {
        this._tilesData = e, this._cdn = t, this._cdnPrefix = i, this._urlLocal = n, this._urlCDN = r, L.TileLayer.prototype.initialize.call(this, n, o)
    },
    getTileUrl: function (e) {
        var t;
        if (this._urlCDN && (t = this._cdn.getSignature(this._cdnPrefix, !0)), t && !Q.isPromise(t)) {
            var i = this._cdn.getSource(t, Math.abs(e.z + e.x + e.y));
            return i.BaseURL + L.Util.template(this._urlCDN, {
                z: e.z,
                x: e.x,
                y: e.y
            }) + i.Query
        }
        return L.Util.template(this._urlLocal, {
            z: e.z,
            x: e.x,
            y: e.y
        })
    },
    _tileShouldBeLoaded: function (e) {
        var t = this._tilesData;
        if (t) {
            var i = e.x,
                n = e.y,
                r = this._map.getZoom();
            if ("number" == typeof this.options.maxNativeZoom && (r = Math.min(r, this.options.maxNativeZoom)), void 0 === t[r] || void 0 === t[r][i] || void 0 === t[r][i][n]) return !1
        }
        return L.TileLayer.prototype._tileShouldBeLoaded.call(this, e)
    },
    _createTile: function () {
        var e = L.TileLayer.prototype._createTile.call(this);
        return e.className += " f_pixelated", e
    }
}), WS.OverviewMapSettings = function (e, t, i, n, r, o, a, s, c, l, h) {
    WS.CRUDObject.call(this, h), this._scanOrBaseTiles = void 0 !== e ? e : WS.OverviewMapSettings.COLORIZE_SCAN_TILES, this._scanTilesColorizeBy = void 0 !== t ? t : WS.OverviewMapSettings.COLORIZE_BY_HEIGHT, this._baseTilesColorizeBy = void 0 !== i ? i : WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE, this._baseTilesColorizeWhat = void 0 !== n ? n : WS.OverviewMapSettings.COLORIZE_TILE_BACKGROUND, this._colorPaletteIdx = void 0 !== r ? r : 1, this._aggregation = void 0 !== o ? o : WS.OverviewMapSettings.AGG_AVG, this._iconMode = void 0 !== a ? a : WS.OverviewMapSettings.IconModes.Category, this._showScanLabelsInMap = void 0 !== s ? s : !0, this._showOrthoVolumes = c || !1, this._showPolylines = void 0 !== l ? l : !0;
    var d;
    switch (this._colorPaletteIdx) {
        case 0:
            d = [{
                r: 254,
                g: 178,
                b: 76
            }, {
                r: 253,
                g: 141,
                b: 60
            }, {
                r: 252,
                g: 78,
                b: 42
            }, {
                r: 227,
                g: 26,
                b: 28
            }, {
                r: 189,
                g: 0,
                b: 38
            }, {
                r: 128,
                g: 0,
                b: 38
            }];
            break;
        case 1:
            d = [{
                r: 0,
                g: 0,
                b: 255
            }, {
                r: 255,
                g: 0,
                b: 0
            }]
    }
    this._colorGradient = new WS.ColorGradient(d)
}, WS.OverviewMapSettings.prototype = {
    clone: function () {
        return new WS.OverviewMapSettings(this._scanOrBaseTiles, this._scanTilesColorizeBy, this._baseTilesColorizeBy, this._baseTilesColorizeWhat, this._colorPaletteIdx, this._aggregation, this._iconMode, this._showScanLabelsInMap, this._showOrthoVolumes, this._showPolylines, this._service)
    },
    writeToLocalStorage: function () {
        this._service.writeToLocalStorage(this)
    }
}, WS.extend("OverviewMapSettings", "CRUDObject"), WS.OverviewMapSettings.COLORIZE_BY_HEIGHT = "elevation", WS.OverviewMapSettings.COLORIZE_BY_AGE = "age", WS.OverviewMapSettings.AGG_AVG = "aggAvg", WS.OverviewMapSettings.AGG_MIN = "aggMin", WS.OverviewMapSettings.AGG_MAX = "aggMax", WS.OverviewMapSettings.AGG_INDIVIDUAL = "aggIndiv", WS.OverviewMapSettings.COLORIZE_SCAN_TILES = "scanTiles", WS.OverviewMapSettings.COLORIZE_BASE_TILES = "baseTiles", WS.OverviewMapSettings.COLORIZE_TILE_BACKGROUND = "background", WS.OverviewMapSettings.COLORIZE_TILE_POINTS = "points", WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE = "avgAge", WS.OverviewMapSettings.COLORIZE_BY_MIN_AGE = "minAge", WS.OverviewMapSettings.COLORIZE_BY_MAX_AGE = "maxAge", WS.OverviewMapSettings.IconModes = WS.PanoSettings.IconModes, WS.OverviewMapSettings.IconModeNames = WS.PanoSettings.IconModeNames, WS.ScanColorizer = function (e, t, i, n) {
    F.PlugModule.call(this, e), this._settingsService = t, this._scanService = n, this._nowMsec = (new Date).getTime(), this._scanList = [], this._scansById = {}, this._minAge = void 0, this._maxAge = void 0, this._ageGranularity = void 0, this._minGlobalZ = void 0, this._maxGlobalZ = void 0, this._colorGradient = void 0, this.provideFemalePlug("SettingsUpdate", ["updateSettings"]), this.provideFemalePlug("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"]), this.provideMalePlug("SettingsUpdate", ["updateSettings"]), this._connectorService.connect(this.getFemalePlug("SettingsUpdate"), this._settingsService), this._connectorService.connect(this.getFemalePlug("SettingsUpdate"), i), this._connectorService.connect(this, this._scanService)
}, WS.ScanColorizer.prototype = {
    addObjects: function (e) {
        for (var t = !1, i = 0, n = e.length; n > i; i++) {
            var r = e[i];
            t = F.addUnique(this._scanList, r) || t
        }
        t && this.update()
    },
    updateObjects: function () {
    },
    removeObjects: function (e) {
        for (var t, i = 0, n = e.length; n > i; i++) {
            var r = e[i];
            t = F.removeFirst(this._scanList, r) || t
        }
        t && this.update()
    },
    updateSettings: function (e) {
        switch (e) {
            case "overviewmap":
            case "unit":
                this.update()
        }
    },
    update: function () {
        var e = this;
        this._scanList.forEach(function (t) {
            e._scansById[t._UUID] = t
        }), this._colorGradient = this._settingsService.getColorGradient(), this.calcMinMaxAge(), this.calcMinMaxHeight(), this.trigger("updateSettings", ["colorizer", this])
    },
    calcMinMaxAge: function () {
        var e = this;
        if (0 === this._scanList.length) return void(this._minAge = this._maxAge = this._ageGranularity = void 0);
        if (this._minAge = Number.MAX_VALUE, this._maxAge = -Number.MAX_VALUE, this._scanList.forEach(function (t) {
                var i = e.getScanAge(t);
                i !== WS.ScanColorizer.DEFAULT_AGE && (e._minAge = Math.min(e._minAge, i), e._maxAge = Math.max(e._maxAge, i))
            }), this._minAge === Number.MAX_VALUE) return void(this._minAge = this._maxAge = this._ageGranularity = void 0);
        var t, i = this._maxAge - this._minAge;
        i > 3650 ? (this._ageGranularity = "y", t = 365) : i > 10 ? (this._ageGranularity = "d", t = 1) : (this._ageGranularity = "h", t = 1 / 24), this._maxAge - this._minAge < t && (this._maxAge = this._minAge + t)
    },
    calcMinMaxHeight: function () {
        var e = this;
        return 0 === this._scanList.length ? void(this._minGlobalZ = this._maxGlobalZ = void 0) : (this._minGlobalZ = Number.MAX_VALUE, this._maxGlobalZ = -Number.MAX_VALUE, this._scanList.forEach(function (t) {
            var i = t.getGlobalZ();
            e._minGlobalZ = Math.min(e._minGlobalZ, i), e._maxGlobalZ = Math.max(e._maxGlobalZ, i)
        }), void(this._maxGlobalZ - this._minGlobalZ < .001 && (this._maxGlobalZ = this._minGlobalZ + .001)))
    },
    hasAgeInfo: function () {
        return void 0 !== this._minAge
    },
    hasHeightInfo: function () {
        return void 0 !== this._minGlobalZ
    },
    getScanTileColor: function (e, t) {
        var i = this;
        void 0 === t && (t = [e]);
        var n = t.map(function (e) {
                return i._scansById[e]
            }),
            r = this._scansById[e];
        if (!r) return WS.ScanColorizer.DEFAULT_COLOR;
        if (this._settingsService.scanTilesColorizeBy() === WS.OverviewMapSettings.COLORIZE_BY_AGE) {
            var o = this.getAggregatedAge(n, r);
            return this.getColorByAge(o)
        }
        var a = this.getAggregatedHeight(n, r);
        return this.getColorByHeight(a)
    },
    getClusterColor: function (e) {
        var t = this,
            i = e.map(function (e) {
                return t._scansById[e]
            });
        if (this._settingsService.scanTilesColorizeBy() === WS.OverviewMapSettings.COLORIZE_BY_AGE) {
            if (!this.hasAgeInfo()) return WS.ScanColorizer.DEFAULT_COLOR;
            var n = this.getAggregatedAge(i);
            return this.getColorByAge(n)
        }
        if (!this.hasHeightInfo()) return WS.ScanColorizer.DEFAULT_COLOR;
        var r = this.getAggregatedHeight(i);
        return this.getColorByHeight(r)
    },
    colorizeBaseTilePoints: function (e, t) {
        this.colorizePixels(e, this.getBaseTileColor(t))
    },
    colorizeBaseTileBackground: function (e, t) {
        var i = e.getContext("2d"),
            n = this.getBaseTileColor(t);
        i.fillStyle = "rgb(" + n.r + "," + n.g + "," + n.b + ")", i.fillRect(0, 0, e.width, e.height)
    },
    getBaseTileColor: function (e) {
        var t;
        switch (this._colorizeBy) {
            case WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE:
                t = e.Mean;
                break;
            case WS.OverviewMapSettings.COLORIZE_BY_MIN_AGE:
                t = e.Newest;
                break;
            case WS.OverviewMapSettings.COLORIZE_BY_MAX_AGE:
                t = e.Oldest;
                break;
            default:
                return WS.ScanColorizer.DEFAULT_COLOR
        }
        return this.getColorByDate(t)
    },
    colorizePixels: function (e, t) {
        for (var i = t.r, n = t.g, r = t.b, o = e.data, a = 0, s = o.length; s > a; a += 4) o[a] = i, o[a + 1] = n, o[a + 2] = r
    },
    getAggregatedAge: function (e, t) {
        var i = this._settingsService.getAggregation();
        if (t && i === WS.OverviewMapSettings.AGG_INDIVIDUAL) return this.getScanAge(t);
        for (var n = e.length, r = i == WS.OverviewMapSettings.AGG_MIN ? Number.MAX_VALUE : 0, o = 0, a = 0; n > a; a++) {
            var s = this.getScanAge(e[a]);
            if (s !== WS.ScanColorizer.DEFAULT_AGE) switch (o++, i) {
                case WS.OverviewMapSettings.AGG_AVG:
                    r += s;
                    break;
                case WS.OverviewMapSettings.AGG_MIN:
                    r = Math.min(r, s);
                    break;
                case WS.OverviewMapSettings.AGG_MAX:
                    r = Math.max(r, s);
                    break;
                case WS.OverviewMapSettings.AGG_INDIVIDUAL:
                    r += s
            }
        }
        return o > 0 ? ((i === WS.OverviewMapSettings.AGG_AVG || i === WS.OverviewMapSettings.AGG_INDIVIDUAL) && (r /= o), r) : WS.ScanColorizer.DEFAULT_AGE
    },
    getScanAge: function (e) {
        return F.isDefaultDate(e._recordingTime) ? WS.ScanColorizer.DEFAULT_AGE : F.ageInDays(e._recordingTime, this._nowMsec)
    },
    getColorByAge: function (e) {
        if (e === WS.ScanColorizer.DEFAULT_AGE) return WS.ScanColorizer.DEFAULT_COLOR;
        if (!this._minAge) return this._colorGradient.getInterpolatedColor(0);
        var t = (e - this._minAge) / (this._maxAge - this._minAge);
        return this._colorGradient.getInterpolatedColor(t)
    },
    getColorByDate: function (e) {
        if (F.isDefaultDate(e)) return WS.ScanColorizer.DEFAULT_COLOR;
        var t = F.ageInDays(e, this._nowMsec);
        return this.getColorByAge(t)
    },
    formatAge: function (e) {
        return e === WS.ScanColorizer.DEFAULT_AGE ? "?" : WS.ScanColorizer.formatAge(e, {
            granularity: this._ageGranularity
        })
    },
    formatAgeFromDate: function (e) {
        if (F.isDefaultDate(e)) return "?";
        var t = F.ageInDays(e, this._nowMsec);
        return WS.ScanColorizer.formatAge(t, {
            granularity: this._ageGranularity
        })
    },
    getAggregatedHeight: function (e, t) {
        var i = this._settingsService.getAggregation();
        if (t && i === WS.OverviewMapSettings.AGG_INDIVIDUAL) return t.getGlobalZ();
        for (var n = e.length, r = e[0].getGlobalZ(), o = 1; n > o; o++) {
            var a = e[o].getGlobalZ();
            switch (i) {
                case WS.OverviewMapSettings.AGG_AVG:
                    r += a;
                    break;
                case WS.OverviewMapSettings.AGG_MIN:
                    r = Math.min(r, a);
                    break;
                case WS.OverviewMapSettings.AGG_MAX:
                    r = Math.max(r, a);
                    break;
                case WS.OverviewMapSettings.AGG_INDIVIDUAL:
                    r += a
            }
        }
        return (i === WS.OverviewMapSettings.AGG_AVG || i === WS.OverviewMapSettings.AGG_INDIVIDUAL) && (r /= n), r
    },
    getColorByHeight: function (e) {
        var t = (e - this._minGlobalZ) / (this._maxGlobalZ - this._minGlobalZ);
        return this._colorGradient.getInterpolatedColor(t)
    }
}, WS.extend("ScanColorizer", "PlugModule"), WS.ScanColorizer.formatAge = function (e, t) {
    t || (t = {});
    var i = t.years,
        n = t.days,
        r = t.hours,
        o = t.separator,
        a = t.granularity;
    void 0 === i && (i = "y"), void 0 === n && (n = "d"), void 0 === r && (r = "h"), void 0 === o && (o = " "), void 0 === a && (a = "h");
    var s = 24 * e,
        c = Math.floor(s / 24);
    s = Math.floor(s % 24);
    var l = Math.floor(c / 365);
    c = Math.floor(c % 365);
    var h = [];
    switch (a) {
        case "y":
            h.push(l + i);
            break;
        case "d":
            l > 0 && h.push(l + i), h.push(c + n);
            break;
        default:
            l > 0 ? (h.push(l + i), h.push(c + n)) : c > 0 && h.push(c + n), h.push(s + r)
    }
    return h.join(o)
}, WS.ScanColorizer.MSEC_PER_DAY = 864e5, WS.ScanColorizer.DEFAULT_AGE = -1, WS.ScanColorizer.DEFAULT_COLOR = {
    r: 128,
    g: 128,
    b: 128
}, WS.MapScale = function (e, t, i, n, r) {
    WS.PlugController.call(this, e, t), this.$scope = e;
    var o = this;
    this._settings = i, this._unit = n, this._scanColorizer = r, e.titleAggFunc = "", e.titleAggBy = "", e.min = "", e.max = "", e.width = WS.MapScale.DefaultSize, e.drawGradient = function () {
        o.drawGradient()
    }, this.provideFemalePlug("SettingsUpdate", ["updateSettings"]), this._connectorService.connect(this.getFemalePlug("SettingsUpdate"), this._settings), this._connectorService.connect(this.getFemalePlug("SettingsUpdate"), this._scanColorizer)
}, WS.MapScale.prototype = {
    drawGradient: function () {
        var e = $("#mapScaleCanvas").get(0);
        if (e) {
            var t = e.getContext("2d"),
                i = this._settings.getColorGradient();
            t.fillStyle = i.getCanvasGradient(t, e.width, 0, 0, 0), t.fillRect(0, 0, e.width, e.height)
        }
    },
    updateCaptions: function () {
        var e = this._settings.scanTilesColorizeBy() === WS.OverviewMapSettings.COLORIZE_BY_AGE,
            t = this._settings.scanTilesColorizeBy() === WS.OverviewMapSettings.COLORIZE_BY_HEIGHT,
            i = this._scanColorizer,
            n = "?",
            r = "?";
        i && (e && i.hasAgeInfo() ? (n = i.formatAge(i._minAge), r = i.formatAge(i._maxAge)) : t && i.hasHeightInfo() && (n = this._unit.getLengthAndUnit(i._minGlobalZ, 3), r = this._unit.getLengthAndUnit(i._maxGlobalZ, 3)));
        var o = "";
        switch (this._settings.getAggregation()) {
            case WS.OverviewMapSettings.AGG_AVG:
                o = "FE_AVG";
                break;
            case WS.OverviewMapSettings.AGG_MIN:
                o = "FE_MIN";
                break;
            case WS.OverviewMapSettings.AGG_MAX:
                o = "FE_MAX";
                break;
            case WS.OverviewMapSettings.AGG_INDIVIDUAL:
                o = "FE_INDV"
        }
        this.$scope.$apply(function (t) {
            t.titleAggFunc = o, t.titleAggBy = e ? "FE_AGE" : "FE_ELEVATION", t.min = n, t.max = r
        })
    },
    updateSettings: function (e) {
        "overviewmap" === e ? this.drawGradient() : "colorizer" === e && this.updateCaptions()
    }
}, WS.extend("MapScale", "PlugController"), WS.MapScale.DefaultSize = 160, WS.OverviewMap = function (e, t, i, n, r, o, a, s, c, l, h, d, u, _, p, g, f, m, v, S, b, y, P, M) {
    var w = this;
    WS.MapLeaflet.call(this, e, t, i, n, p), window.om = this, this._type = WS.OverviewMap.type, this._unit = n, this._selection = r, this._layer = o, this._projectService = a, this._scanService = s, this._annotation = m, this._measurement = v, this._tempmeasurement = S, this._orthophoto = b, this._tempOrthophoto = y, this._point3d = P, this._mapObjectService = u, this._mapLayerService = _, this._mapService = c, this._settingService = l, this._login = h, this._alert = d, this._domainSettings = g, this._scanColorizer = f, this._CDN = M, this._mapObject = void 0, this._mapMetadata = void 0, this._commonMetadata = void 0, this._mapLayersByObjUuid = {}, this._trafoView = mat4.identity(), this._fsm = new F.FiniteStateMachine(WS.OverviewMap.FSM, "void"), this._dScans = Q.defer(), this._promiseScans = this._dScans.promise, this._dPositioned = Q.defer(), this._promisePositioned = this._dPositioned.promise, this._panoviewScanId = void 0, this._logoLoaded = !1, this._numTileLayers = 0, this._fadeByDefault = !0, this._objects = {
        scan: {
            service: s,
            selection: r.getSelection("Scan"),
            entities: []
        },
        annotation: {
            service: m,
            selection: r.getSelection("Annotation"),
            entities: []
        },
        measurement: {
            service: v,
            selection: r.getSelection("Measurement"),
            entities: []
        },
        tempmeasurement: {
            service: S,
            selection: r.getSelection("TempMeasurement"),
            entities: []
        },
        orthophoto: {
            service: b,
            selection: r.getSelection("Orthophoto"),
            entities: []
        },
        temporthophoto: {
            service: y,
            entities: []
        },
        point3d: {
            entities: []
        }
    }, this._linesRenderable = void 0, this._lineAreaEnd = void 0, this._layers = {
        scanTiles: void 0,
        baseTiles: void 0
    }, this._frustumLayer = void 0, this._frustumPoly = L.polygon([]), this._camPosCircle = L.circleMarker(L.latLng(0, 0), {
        opacity: 0,
        fillOpacity: 0
    }), this._markerSelectionGroup = void 0, this._markerClusterGroup = void 0, this._fitMarkersMargin = 1.5, this._settingsSet = !1, this._logoCtrl = new WS.MapImageControl(void 0, {
        cssClass: "ws_customerLogo",
        position: "bottomright"
    }), this.provideFemalePlug("ViewMode", ["setMode"]), this.provideMalePlug("ObjectShow", ["showObjects"]), this.provideFemalePlug("ObjectShow", ["showObjects"]), this.provideFemalePlug("ViewFocus", ["focusOn"]), this.provideFemalePlug("ObjectUpdate", ["updateObjects"]), this.provideFemalePlug("SettingsUpdate", ["updateSettings"]), this.provideFemalePlug("ScanPointsShow", ["showScanPoints", "hideScanPoints"]), this.provideFemalePlug("ScanSelect", ["select", "unselect"]), this.provideFemalePlug("AnnotationSelect", ["select", "unselect"]), this.provideFemalePlug("MeasurementSelect", ["select", "unselect"]), this.provideFemalePlug("TempMeasurementSelect", ["select", "unselect"]), this.provideFemalePlug("OrthophotoSelect", ["select", "unselect"]), this.provideFemalePlug("PointPick3DControl", ["setPickedPoints"]), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.provideFemalePlug("CameraChanged", ["onCameraChange"]), this.provideFemalePlug("SceneRootChange", ["sceneRootChange"]), this.provideMalePlug("TaskLaunch", ["launchTask"]), this.provideFemalePlug("URLChange", ["setFragment", "applyURL"]), this.provideMalePlug("PointPick3D", ["pickPoint"]), t.connect(this, l), t.connect(this.getFemalePlug("ObjectUpdate"), o), t.connect(this, n), t.connect(this, i), t.connect(this.getFemalePlug("Login"), h), t.connect(this.getFemalePlug("SettingsUpdate"), f), ["Scan", "Annotation", "Measurement", "TempMeasurement", "Orthophoto"].forEach(function (e) {
        t.connect(w, r.getSelection(e))
    }), [s, m, v, S, b, y, P, g, u, _].forEach(function (e) {
        t.connect(w, e)
    }), this.autoConnect(e), a.subscribe("change", this.changeProjectSync.bind(this)), this.initScope(e), this.setCanvas([this.createOverlayCanvas(100, 100), this.createOverlayCanvas(100, 100)]), this.loadSettings()
}, WS.OverviewMap.prototype = {
    initScope: function (e) {
        var t = this;
        e._2GO = WS._2GO, e.error = void 0, e.message = "", e.page = {
            actionBarActive: !1
        }, e.changeViewMode = function (e) {
            "3d" === e.view && (e.pointCloud ? t.trigger("showObjects", [
                [e.pointCloud], "3d"
            ]) : t.trigger("showObjects", [
                [], "3d"
            ]))
        }, e.pickScan = F.proxy(this.pickScan, this), e.project = void 0, e.leafletLayers = [], e.zoomIn = function () {
            t.zoomIn(1)
        }, e.zoomOut = function () {
            t.zoomOut(1)
        }, e.zoomFit = function () {
            t.zoomFit()
        }, e.toggleTileLayer = function (e) {
            e.options.opacityIsInitial && 0 === e.options.opacity && (e.options.opacity = 1, e.options.opacityIsInitial = !1), e.options.visible ? t._map.removeLayer(e) : e.addTo(t._map), e.options.visible = !e.options.visible
        }, e.changeLayerOpacity = function (e, t) {
            var i = e.options.opacity + t;
            i = Math.max(0, i), i = Math.min(1, i), e.setOpacity(i)
        }, e.scale = {
            width: WS.MapScale.DefaultSize
        }, e.pickedPoint = void 0, e.flashPicker = !1, e.showPanoView = function () {
            var e = t._map ? t._map.getCenter() : void 0;
            t._scanService.getNearestScan(e ? [e.lng, e.lat] : [0, 0]).then(function (e) {
                t.trigger("showObjects", [
                    [e], "panorama", {
                        miniView: !0
                    }
                ])
            }, function (e) {
                t._alert.errorObj(e)
            })
        }, e.getPosInCS = function (i) {
            return e.project._trafo && t._unit.isCustomCS() ? mat4.posInRefSystem(i, e.project._trafo) : i
        }
    },
    setViewModeCtrl: function (e) {
        this._viewModeCtrl = e, this._viewModeCtrlD.resolve(e), F.async(function () {
            e.viewMode(WS.OverviewMap.ViewMode.MAP)
        })
    },
    initLogo: function () {
        var e = this;
        this._domainSettings.get().done(function (t) {
            e.updateDomainSettings(t)
        }, F.NOP)
    },
    loadSettings: function () {
        var e = this;
        this._settingService.getAll().then(function (t) {
            e.updateSettings("overviewmap", t[0])
        }, function (t) {
            e._alert.errorObj(t)
        }).done()
    },
    updateSettings: function (e, t) {
        switch (e) {
            case "overviewmap":
                this.updateSettingsInternal(t);
                break;
            case "unit":
                this._scene && this._scene.traverse(new WS.UpdateUnitVisitor);
                break;
            case "language":
                this._scene && this._scene.traverse(new WS.UpdateLanguageVisitor);
                break;
            case "domain":
                this.updateDomainSettings(t);
                break;
            case "colorizer":
                this.updateScanColors(), this._markerClusterGroup && this._markerClusterGroup._topClusterLevel && this._markerClusterGroup.refreshClusters()
        }
    },
    updateSettingsInternal: function (e) {
        this._settingsSet = !0, this._scene && (this._scene.traverse(new WS.SetIconModeVisitor(e._iconMode)), this._scene.traverse(new WS.ScanLabelsVisitor(e._showScanLabelsInMap)), this._scene.traverse(new WS.ShowBoxVisitor(e._showOrthoVolumes)), this._scene.traverse(new WS.ShowPolylineVisitor(e._showPolylines)));
        var t = this._markerClusterGroup;
        if (t) {
            var i = t.options.maxClusterRadius,
                n = e._showScanLabelsInMap && i !== WS.OverviewMap.CLUSTER_DIST_WITH_LABELS || !e._showScanLabelsInMap && i !== WS.OverviewMap.CLUSTER_DIST_NO_LABELS;
            if (n) {
                this._map.removeLayer(t), this.createClusterGroup();
                for (var r in this._markerMap) this.updateMarkerIcon(this._markerMap[r])
            }
        }
    },
    updateDomainSettings: function (e) {
        this._logoCtrl.setUrl(this._domainSettings.getCustomerLogoUrl(e)), this._logoCtrl.setOpacity(e._customerLogoOpacity / 100)
    },
    reset: function () {
        this._mapObject = void 0, this._mapMetadata = void 0, this._commonMetadata = void 0, this._mapLayersByObjUuid = {}, this._numTileLayers = 0, this._hlObject = void 0, this.$scope.project = void 0, this.$scope.pickedPoint = void 0, this.$scope.leafletLayers = [], this._viewModeCtrl && this._viewModeCtrl.reset(), this.init()
    },
    init: function () {
        var e = this;
        WS.View3d.prototype.init.call(this), this.mapReady() && this._promisePositioned && this._promisePositioned.then(function () {
            e.initMapEventListeners(), e.onUpdateViewDimensions(), e.updateOverlayPosition()
        }, F.NOP).done()
    },
    initCamera: function () {
        this._camera || (this._camera = new WS.OrthoCamera(void 0, void 0, -Number.MAX_VALUE, Number.MAX_VALUE))
    },
    initRenderers: function () {
        var e, t = this._canvasList;
        this._renderer.length > 0 ? this._renderer.forEach(function (e) {
            e.clearStorage()
        }) : (this._renderMode = WS.View3d.RenderMode.Canvas, e = t[0].getContext("2d"), this._renderer[0] = new WS.Renderer2D(e, [0, 1, 2, 3, 4], this), e = t[1].getContext("2d"), this._renderer[1] = new WS.Renderer2D(e, [5], this), this._renderer[0].setClearColor([0, 0, 0, 0]), this._renderer[1].setClearColor([0, 0, 0, 0]))
    },
    initScene: function () {
        this._renderableMap = {}, this._scene ? (this.unloadObjects(), this._scene.removeAll()) : this._scene = new WS.Scene, this.loadObjects()
    },
    initHandlers: function () {
        if (!this._modeToHandlerStack) {
            var e = this._modeToHandlerStack = {};
            e[WS.ViewBase.Mode.Move] = [new WS.PickObjectHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.PickPoint] = [new WS.PickPointHandler(this._camera, this)], e[WS.ViewBase.Mode.PickPolygon] = [new WS.PickPointsHandler(this._camera, this)], e[WS.ViewBase.Mode.SelectObject] = [new WS.PickObjectHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.SelectObjects] = [new WS.PickObjectHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.SelectObjectsRectAdd] = [new WS.SelectRegionHandler(this._camera, this._scene, this, this._selectionRenderable, !0)], e[WS.ViewBase.Mode.SelectObjectsRectSub] = [new WS.SelectRegionHandler(this._camera, this._scene, this, this._selectionRenderable, !1)], e[WS.ViewBase.Mode.PickAll] = [new WS.PickAllHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.PickPointOpenScans] = [new WS.PickObjectHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.Move][0].addListener(new WS.PickObjectListener(this, WS.PickObjectListener.SelectionMode.None, this._selection, this._alert)), e[WS.ViewBase.Mode.PickPoint][0].addListener(new WS.PickPointListener(this)), e[WS.ViewBase.Mode.PickPolygon][0].addListener(new WS.PickPointListener(this)), e[WS.ViewBase.Mode.SelectObject][0].addListener(new WS.PickObjectListener(this, WS.PickObjectListener.SelectionMode.Single, this._selection, this._alert));
            var t = new WS.PickObjectListener(this, WS.PickObjectListener.SelectionMode.Multi, this._selection, this._alert);
            e[WS.ViewBase.Mode.SelectObjects][0].addListener(t), e[WS.ViewBase.Mode.SelectObjectsRectAdd][0].addListener(t), e[WS.ViewBase.Mode.SelectObjectsRectSub][0].addListener(t), e[WS.ViewBase.Mode.PickAll][0].addListener(new WS.PickAllListener(this, this._selection, this._alert, this._point3d)), e[WS.ViewBase.Mode.PickPointOpenScans][0].addListener(new WS.PickObjectListener(this, WS.PickObjectListener.SelectionMode.Menu, this._selection, this._alert)), this.setMode(WS.OverviewMap.defaultMode)
        }
    },
    dispatchScanClick: function (e, t) {
        if (this._activeHandlerStack) {
            var i = t.getTranslationGlobal(),
                n = this.globalToLatLng(i),
                r = this.latLngToContainerPoint(n);
            this._activeHandlerStack[0].informListener(e, [t, r.x, r.y])
        }
    },
    setMode: function (e) {
        this._mode !== e && e !== WS.ViewBase.Mode.PickAll && F.async(this.hideRadialMenu, this);
        var t = this.isAllowedToSelectScan();
        if (WS.View3d.prototype.setMode.call(this, e), this._allowedToSelectScan = this.isAllowedToSelectScan(), this._allowedToSelectScan !== t)
            for (var i in this._markerMap) this.updateMarkerIcon(this._markerMap[i]);
        (e === WS.ViewBase.Mode.SelectObjectsRectAdd || e === WS.ViewBase.Mode.SelectObjectsRectSub) && this._selectionRenderable.setAppearance(e === WS.ViewBase.Mode.SelectObjectsRectAdd)
    },
    render: function () {
        this._width > 0 && this._height > 0 && this._renderer.forEach(F.proxy(function (e) {
            e.drawScene(this._camera, this._scene)
        }, this));
        var e = this._renderer[this._renderer.length - 1];
        this._selectionRenderable.draw2d(e, function () {
            return !0
        }, !1)
    },
    addRenderable: function (e, t, i, n) {
        WS.View3d.prototype.addRenderable.call(this, e, t, i, n);
        var r, o = this._settingService._settings;
        if (e.instanceOf(WS.ScanMapRenderable)) {
            e.setHideLabelBySetting(!o._showScanLabelsInMap);
            var a = e._dataObject,
                s = a._UUID;
            if (!this._markerMap[s]) {
                var c = this.globalToLatLng(a.getTranslationGlobal());
                this.addMarker(a, c)
            }
            r = this._markerMap[s], e.setMarker(r)
        } else e.instanceOf(WS.OrthoBox3dRenderable) ? e.setShowBox(o._showOrthoVolumes) : e instanceof WS.PolylineAnnotationRenderable && e.setShowPolyline(o._showPolylines);
        this.updateAddedRenderable(e, o._iconMode), r && r.setVisible(!0)
    },
    onUpdateViewDimensions: function () {
        if (this.isOverlayVisible() && this._map && this._promisePositioned && Q.isFulfilled(this._promisePositioned)) {
            this.invalidateSize();
            var e = this._map.getSize();
            if (WS.View3d.prototype.onUpdateViewDimensions.call(this, e.x, e.y)) {
                this.updateOverlayPosition();
                var t = e.x > 630 ? WS.MapScale.DefaultSize : e.x > 540 ? 110 : 40,
                    i = this.$scope;
                return i.scale.width !== t && i.$apply(function () {
                    i.scale.width = t
                }), !0
            }
        }
        return !1
    },
    createOverlayCanvas: function (e, t) {
        var i = document.createElement("canvas");
        return i.className = WS.OverviewMap.OVERLAY_CANVAS_CLASS, i.width = e, i.height = t, i
    },
    initOverlayDOM: function () {
        var e = this._targetDomElement,
            t = $(e).width(),
            i = $(e).height(),
            n = $(this._map.getPanes().markerPane),
            r = document.createElement("div");
        r.className = "ws_mapCanvasOverlayContainer", this._canvasList.forEach(function (e) {
            e.width = t, e.height = i, r.appendChild(e)
        }), n.after(r), this._overlayContainer = r
    },
    initMapEventListeners: function () {
        var e = this._map;
        e.on("movestart", F.proxy(this.onMapMoveStart, this)), e.on("moveend", F.proxy(this.onMapMoveEnd, this)), e.on("zoomstart", F.proxy(this.onMapZoomStart, this))
    },
    overlayHideTemp: function () {
        this._overlayContainer.style.display = "none", this._overlayTempHidden = !0, this.stopRendering()
    },
    overlayUnhideTemp: function () {
        this._overlayContainer.style.display = "block", this._overlayTempHidden = !1, this.isOverlayVisible() && this.startRendering()
    },
    isOverlayVisible: function () {
        return this._visible && !this._overlayTempHidden
    },
    onMapMoveStart: function () {
        this.stopRendering(), F.async(this.hideRadialMenu, this)
    },
    onMapMoveEnd: function () {
        if (this.updateOverlayPosition(), this.isOverlayVisible() && this.startRendering(), this.isContainerVisible()) {
            if ("highlight" === this._fsm._state) {
                var e = this._fsm._meta.focus;
                this.isViewpointApprox(e) || this._fsm.read("move")
            }
            this.updateURL(!0)
        }
    },
    isViewpointApprox: function (e) {
        var t = this._map.getZoom();
        if (t !== e.zoom) return !1;
        var i = 1 / this._map.options.crs.scale(t),
            n = WS.OverviewMap.VIEWPOINT_EPS_PX * i,
            r = this._map.getCenter();
        return Math.abs(r.lat - e.lat) <= n && Math.abs(r.lng - e.lng) <= n
    },
    onMapZoomStart: function () {
        this.overlayHideTemp(), F.async(this.hideRadialMenu, this)
    },
    updateCamera: function () {
        var e = this._map.getBounds();
        this._camera.setLeftRightBottomTop(e.getWest(), e.getEast(), e.getSouth(), e.getNorth())
    },
    compensateLayerTranslation: function () {
        var e = this.containerPointToLayerPoint(L.point(0, 0));
        L.DomUtil.setPosition(this._overlayContainer, e)
    },
    updateOverlayPosition: function () {
        this.compensateLayerTranslation(), this.updateCamera()
    },
    focusInternal: function (e) {
        var t, i;
        if (e instanceof Array) t = this.globalToLatLng(e), i = this._commonMetadata._maxLevel - 1, this.setView(t, i);
        else if (e instanceof WS.Transformation) {
            var n = this._settingService._settings;
            if (e instanceof WS.Measurement || e instanceof WS.Orthophoto || e instanceof WS.Annotation && e.isPolyline() && n._showPolylines) {
                var r = e instanceof WS.Orthophoto ? e.getImageCornersGlobal() : e._pointsGlobal,
                    o = r.map(F.proxy(this.globalToLatLng, this)),
                    a = L.latLngBounds(o);
                this.fitBounds(a), t = this._map.getCenter(), i = this._map.getZoom()
            } else {
                var s = e.getTranslationGlobal();
                t = this.globalToLatLng(s);
                var c = this._map.getZoom();
                i = this._page.$scope.visible && "number" == typeof c ? c : this._commonMetadata._maxLevel - 1, this.setView(t, i)
            }
            this._fsm._meta.focus = {
                object: e,
                lat: t.lat,
                lng: t.lng,
                zoom: i
            }, this.highlight(e)
        }
    },
    focusOn: function (e, t) {
        if ("map" === t) {
            var i = void 0 !== e.miniView ? e.miniView : this.miniView() || !1,
                n = this.getPageBox();
            n && n.isCollecting() && this.changePage({
                miniView: i
            }), i || this.trigger("launchTask", ["default", "overviewmap"]);
            var r = e.object,
                o = e.lookAt,
                a = this._commonMetadata ? Math.max(this._commonMetadata._maxLevel - 1, this._commonMetadata._minLevel) : "focusOn",
                s = r ? {
                    object: r,
                    history: !0
                } : {
                    x: o[0],
                    y: o[1],
                    zoom: a,
                    history: !0
                };
            switch (this._fsm._state) {
                case "free":
                case "highlight":
                    this.focusInternal(r || o), this._fsm.read(r ? "focusobject" : "move"), this.updateURL();
                    break;
                case "void":
                    this._fsm._meta.pending = s, this._visible && this.loadProjectInitViewpoint();
                    break;
                case "loading":
                    this._fsm._meta.pending = s
            }
        }
    },
    pickScan: function (e) {
        e && this.trigger("showObjects", [
            [e]
        ])
    },
    loadObjects: function () {
        if (this.mapReady()) {
            var e = this;
            this._scanService.getAll().then(function (t) {
                e._scanColorizer.addObjects(t), e.addObjects(t), t.forEach(function (e) {
                    e.hideScanPoints()
                }), e._dScans.resolve(t)
            }, function (t) {
                e.handleError(t)
            }).done();
            var t = [this._tempmeasurement, this._annotation, this._measurement, this._orthophoto, this._tempOrthophoto];
            t.forEach(function (t) {
                t.getAll().then(function (t) {
                    e.addObjects(t)
                }, function (t) {
                    e._alert.errorObj(t)
                }).done()
            })
        }
    },
    loadObject: function (e, t) {
        return F.DI().getService(t).getByID(e, void 0, !0)
    },
    unloadObjects: function () {
        var e = this;
        ["scan", "annotation", "measurement", "orthophoto", "temporthophoto", "tempmeasurement"].forEach(function (t) {
            F.clearArray(e._objects[t].entities)
        })
    },
    objectFilter: function (e) {
        return e instanceof WS.Point3d || e instanceof WS.Scan || e instanceof WS.Annotation || e instanceof WS.Measurement && e._type === WS.Measurement.Type.Map || e instanceof WS.Orthophoto
    },
    addObjects: function (e) {
        var t = !1;
        if (this.mapReady()) {
            var i = this._markerClusterGroup;
            i && WS.MapMarker.bulkBegin(i);
            for (var n = 0, r = e.length; r > n; n++) {
                var o = e[n];
                if (o instanceof WS.ProjectCRUDObject) {
                    var a = 2 === this.addObject(o);
					t = t || a && o instanceof WS.Scan
                } else o instanceof WS.Point3d && (this.addObject(o), this.flashPickerCoords(), this.$scope.$apply(function (e) {
                    e.pickedPoint = o
                }))
            }
            if (i && WS.MapMarker.bulkEnd(i), t) {
                var s = this._settingService._settings;
                this.updateSettingsInternal(s)
            }
        }
    },
    removeObjects: function (e) {
        var t = [],
            i = this._markerClusterGroup;
        i && WS.MapMarker.bulkBegin(i);
        for (var n = 0; n < e.length; n++) {
            var r = e[n];
            r instanceof WS.ProjectCRUDObject ? WS.View3d.prototype.removeObject.call(this, r) : r instanceof WS.Point3d && (WS.View3d.prototype.removeObject.call(this, r), this.$scope.$apply(function (e) {
                e.pickedPoint = void 0, e.flashPicker = !1
            })), r instanceof WS.Scan && (t.push(r.getID()), this.removeMarker(r.getID()))
        }
        i && WS.MapMarker.bulkEnd(i), t.length > 0 && this._layers.scanTiles && (this._layers.scanTiles.removeFromAllScanLists(t), this._layers.scanTiles.redraw())
    },
    updateObjects: function (e) {
        for (var t = !1, i = 0, n = e.length; n > i; i++) {
            var r = e[i];
            if (r)
                if (r instanceof WS.Scan) {
                    var o = this._markerMap[r.getID()];
                    o && (o.setTitle(r._displayName), WS.View3d.prototype.updateObject.call(this, r))
                } else r instanceof WS.Layer && r._viewType === this._type ? r._id === WS.Layer.LayerIDs.SCANS ? this.setScansVisible(r._visible) : r._id === WS.Layer.LayerIDs.VIEW_CAM && this.setCamVisible(r._visible) : r instanceof WS.MapObject ? this.updateLayerOrder(r) : r instanceof WS.MapLayer ? this.updateLayer(r) : r instanceof WS.ProjectCRUDObject ? WS.View3d.prototype.updateObject.call(this, r) : r instanceof WS.Point3d && (WS.View3d.prototype.updateObject.call(this, r), this.flashPickerCoords(), t = !0)
        }
        t && this.$scope.$apply()
    },
    select: function (e) {
        for (var t = 0, i = e.length; i > t; t++) {
            var n = e[t];
            n instanceof WS.Scan && this.updateMarkerIconForScan(n), n.instanceOf(WS.ProjectCRUDObject) && WS.View3d.prototype.select.call(this, [n])
        }
    },
    unselect: function (e) {
        for (var t = 0, i = e.length; i > t; t++) {
            var n = e[t];
            n instanceof WS.Scan && this.updateMarkerIconForScan(n), n.instanceOf(WS.ProjectCRUDObject) && WS.View3d.prototype.unselect.call(this, [n])
        }
    },
    isAllowedToSelectScan: function () {
        switch (this._mode) {
            case WS.ViewBase.Mode.SelectObject:
            case WS.ViewBase.Mode.SelectObjects:
            case WS.ViewBase.Mode.SelectObjectsRectAdd:
            case WS.ViewBase.Mode.SelectObjectsRectSub:
                return this._allowedSelections && this._allowedSelections.indexOf("scan") >= 0;
            default:
                return !1
        }
    },
    highlight: function (e) {
        e instanceof WS.ProjectCRUDObject && WS.View3d.prototype.highlight.call(this, e), e instanceof WS.Scan && (this.updateMarkerIconForScan(e), this._layers.scanTiles && F.async(function () {
            this._layers.scanTiles.setScanList("menu", [e._UUID])
        }, this))
    },
    unhighlight: function (e) {
        e && (e instanceof WS.ProjectCRUDObject && WS.View3d.prototype.unhighlight.call(this, e), e instanceof WS.Scan && (this.updateMarkerIconForScan(e), this._layers.scanTiles && F.async(function () {
            this._layers.scanTiles.removeFromScanList("menu", [e._UUID]), this._layers.scanTiles.removeFromScanList("mouseover", [e._UUID])
        }, this)))
    },
    setPickedPoints: function (e, t, i, n, r, o, a) {
        var s = this;
        this.removeLineEnd(), this.removeLines();
        var c = e.some(function (e) {
            return e._takenInView !== s
        });
        if (0 !== e.length && !c && this._scene) {
            var l = e.map(function (e) {
                return e._estimatedPosition
            });
            this.createLine(l, i, n, r, o, a), t && this.createLineEnd(l, n, r)
        }
    },
    flashPickerCoords: function () {
        var e = this.$scope,
            t = this._point3d.getPoint();
        e.flashPicker = !1, t && t._pointState !== WS.Point3d.PointState.Unknown && setTimeout(function () {
            e.$apply(e.flashPicker = !0)
        }, 50)
    },
    showObjects: function (e, t) {
        if ("map" === t && e.length) {
            var i = e[0];
            this._projectService.isCurrent(i) || this._projectService.changeProject(i);
            var n = this.getPageBox();
            n && n.isCollecting() && this.changePage(), this.trigger("launchTask", ["default", "overviewmap"]), delete this._fsm._meta.pending, this._visible ? this.loadProjectInitViewpoint() : (this._fsm.read("reset"), this.destroyMap()), this._url.collect(), this._promisePositioned.fin(F.proxy(this._url.commit, this._url)), this._frustumPoly.setLatLngs([]), this._camPosCircle.setStyle({
                opacity: 0,
                fillOpacity: 0
            })
        }
    },
    changeProjectSync: function () {
        this._projectService.getCurrent();
        delete this._fsm._meta.pending, this._fsm.read("reset"), this.destroyMap(), this._frustumPoly.setLatLngs([]), this._camPosCircle.setStyle({
            opacity: 0,
            fillOpacity: 0
        })
    },
    loadProjectInitViewpoint: function () {
        var e = this;
        return this._viewModeCtrl ? (this._fsm.read("startload"), void this._projectService.getCurrentProject().then(function (t) {
            e.initMap(t), e._promiseScans.then(function () {
                if (e._fsm._meta.pending) {
                    var t = e._fsm._meta.pending.history;
                    e.applyViewpoint().then(function (i) {
                        e._fsm.read("loaddone"), i && e._fsm.read("focusobject"), t && e.updateURL(), e._dPositioned.resolve(!0)
                    })
                } else e.zoomFit(), e._fsm.read("loaddone"), e.updateURL(), e._dPositioned.resolve(!0)
            })
        }, function (t) {
            e.handleError(t)
        })) : void this._viewModeCtrlD.promise.then(this.loadProjectInitViewpoint.bind(this))
    },
    login: function () {
        if (this._projectService.hasCurrent()) switch (this._fsm._state) {
            case "void":
            case "free":
            case "highlight":
                this.$scope.$apply("error=undefined"), this._fsm.read("reset"), this.destroyMap(), this._visible && this.loadProjectInitViewpoint()
        }
    },
    logout: function () {
        this._fsm.read("reset"), this.destroyMap()
    },
    updateAccount: function () {
        this._fsm._meta.pending && this.login()
    },
    onShow: function () {
        switch (this._visible = !0, WS.MapLeaflet.prototype.onShow.call(this), this.startRendering(), this._fsm._state) {
            case "void":
                this._projectService.hasCurrent() && this.loadProjectInitViewpoint();
                break;
            case "free":
            case "highlight":
                this._fsm._meta.pending && this.applyViewpoint()
        }
        this._layers.scanTiles && (this._layers.scanTiles.enableLoadingTiles(!0), this._layers.scanTiles.redraw()), this._logoLoaded || (this._logoLoaded = !0, this.initLogo())
    },
    preparePageChange: function (e) {
        var t = e.state,
            i = F.PageBox.Action;
        return this.$scope.pvMiniView = !!t.pv.miniView, !this.miniView() || !t.pv.visible || t.om.visible || e.action !== i.SelectPage && e.action !== i.SelectPageClass && e.action !== i.ConfigurePage && e.action !== i.ChangeRequest ? void 0 : (t.om.visible = !0, t.om.miniView = !0, !0)
    },
    onHide: function () {
        this._visible = !1, WS.MapLeaflet.prototype.onHide.call(this), this.stopRendering(), F.async(this.hideRadialMenu, this), this._layers.scanTiles && (this._layers.scanTiles.abortAllPendingTiles(), this._layers.scanTiles.enableLoadingTiles(!1))
    },
    setMiniView: function (e, t) {
        var i = this;
        return Q.try(function () {
            return i._logoCtrl.setVisible(!e), e || t !== F.PageBox.MiniViewTransition.Main ? void 0 : i.trigger("launchTask", ["default", "overviewmap", void 0, void 0, {
                noNavigation: !0
            }])
        }).then(WS.MapLeaflet.prototype.setMiniView.bind(this, e, t))
    },
    onConfigure: function (e) {
        if (!e || !e.noReconfigure) {
            var t = WS.ViewBase.Mode.PickAll;
            this._allowedSelections = "annotation,scan,measurement,tempmeasurement,orthophoto", this._changeScanAllowed = !0, e && (void 0 !== e.changeScanAllowed && (this._changeScanAllowed = e.changeScanAllowed), e.mode ? t = e.mode : e.selection && (t = WS.ViewBase.Mode.SelectObjects), e.selection && (this._allowedSelections = e.selection)), this.setMode(t)
        }
    },
    updateURL: function (e) {
        var t;
        switch (this._fsm._state) {
            case "free":
                var i = this._url.getFragment(this._id),
                    n = i && this._url.decode(i);
                if (n && n.x && n.y && n.zoom) {
                    var r = {
                        lat: parseFloat(n.y),
                        lng: parseFloat(n.x),
                        zoom: parseFloat(n.zoom)
                    };
                    if (this.isViewpointApprox(r)) return
                }
                var o = this._map.getCenter(),
                    a = this._map.getZoom();
                t = {
                    x: o.lng.toFixed(3),
                    y: o.lat.toFixed(3),
                    zoom: a
                }, this._url.setFragment(this._id, this._url.encode(t), ["p"], e);
                break;
            case "highlight":
                var s = this._fsm._meta.focus.object;
                t = {
                    t: (s.instanceOf(WS.TempMeasurement) ? "temp" : "") + s._class.toLowerCase(),
                    o: s._UUID.toLowerCase()
                }, this._url.setFragment(this._id, this._url.encode(t), ["p"], e)
        }
    },
    setFragment: function (e) {
        e.isUnresolved(this._id) && e.resolve(this._id, e.get(this._id).query, ["p"])
    },
    applyURL: function (e, t) {
        var i = this;
        if (e === this._id) {
            var n = t.get(this._id),
                r = this._url.decode(n.query);
            !this._projectService.hasCurrent() || this.$scope.project && this._projectService.isCurrentProject(this.$scope.project) || (this._fsm.read("reset"), this.destroyMap()), this._visible ? (this._fsm._meta.pending = r, this._map ? this.applyViewpoint().then(function (e) {
                e && i._fsm.read("focusobject")
            }) : this.loadProjectInitViewpoint()) : this._fsm._meta.pending = r
        }
    },
    applyViewpoint: function () {
        var e = this,
            t = this._fsm._meta.pending,
            i = Q.defer();
        if (delete this._fsm._meta.pending, t.auto) this.zoomFit(), i.resolve(!1);
        else if (t.x && t.y) {
            var n;
            n = t.zoom ? "focusOn" === t.zoom ? Math.max(this._commonMetadata._maxLevel - 1, this._commonMetadata._minLevel) : parseInt(t.zoom) : Math.floor(.5 * (this._commonMetadata._minLevel + this._commonMetadata._maxLevel)), this.setView(L.latLng(parseFloat(t.y), parseFloat(t.x)), n), i.resolve(!1)
        } else t.object ? (this.focusInternal(t.object), i.resolve(!0)) : t.o && t.t && this.loadObject(t.o, t.t).then(function (t) {
            e.focusInternal(t), i.resolve(!0)
        }, function (n) {
            e.handleError(n), e._fsm._meta.pending = t, i.reject(n)
        }).done();
        return i.promise
    },
    updateScanColors: function () {
        this._scene && this._scene.traverse(new WS.ScanColorVisitor), this._layers.scanTiles && this._layers.scanTiles.redraw()
    },
    showScanPoints: function (e) {
        this.updateMarkerIconForScan(e), this._layers.scanTiles && this._layers.scanTiles.addToScanList("selection", [e._UUID])
    },
    hideScanPoints: function (e) {
        this.updateMarkerIconForScan(e), this._layers.scanTiles && this._layers.scanTiles.removeFromScanList("selection", [e._UUID])
    },
    handleError: function (e) {
        this._dPositioned.reject(), this._dScans.reject(), this.destroyMap(), this._fsm.read("reset"), F.handled(e), this.$scope.$apply(function (t) {
            t.error = e
        })
    },
    destroyMap: function () {
        Q.isPending(this._promisePositioned) || (this._dPositioned = Q.defer(), this._promisePositioned = this._dPositioned.promise), this._dScans = Q.defer(), this._promiseScans = this._dScans.promise, WS.MapLeaflet.prototype.initMap.call(this), this.$scope.error = void 0, this.reset(), $(this._canvasList).detach();
        var e = this._targetDomElement.parentElement;
        $(this._targetDomElement).replaceWith('<div class="f_centeredContainer overviewmapdiv" style="z-index: 0;"></div>'), this._targetDomElement = $(e).find(".overviewmapdiv")[0], this._map && (this._map.remove(), this._map = void 0), this.unloadObjects(), this._layers = {}
    },
    initMap: function (e) {
		document.getElementById("welcome").style.display = "none";
		//
        var t = this;
        this.destroyMap(), e && (this._viewModeCtrl.update(), this._mapObjectService.getAll().then(function (i) {
            if (t._mapObject = i[0], !t._mapObject) throw new Error("EM_RESOURCE_NOT_FOUND");
            t._mapObject._exportVersion < 3 ? t._mapService.getMapMetadata(e._name).then(function (i) {
                t._mapMetadata = i, t._commonMetadata = t._mapMetadata, t.initMapPart2(e)
            }) : (t._commonMetadata = t._mapObject, t._mapLayerService.getAll().then(function (i) {
                for (var n = 0, r = i.length; r > n; ++n) t._mapLayersByObjUuid[i[n]._objectUUID] = i[n];
                t.initMapPart2(e)
            }))
        }).fail(function (e) {
            t.handleError(e)
        }));
    },
    initMapPart2: function (e) {
        var t = this._commonMetadata._backgroundColor;
        !t || 255 === t[0] && 255 === t[1] && 255 === t[2] || $(this._targetDomElement).css("background-color", "rgb(" + t[0] + "," + t[1] + "," + t[2] + ")"), this.$scope.project = e, this.prepareMap(), this._mapObject._hasMapLayers ? this.initMapLayers() : this.initWorkspaceLayer(), this.initLayoutLayers(), this.initScanLayers()
    },
    prepareMap: function () {
		
        var e = this;
        this._frustumPoly = L.polygon(this._frustumPoly.getLatLngs(), {
            weight: 1,
            opacity: .8,
            clickable: !1
        }), this._camPosCircle = L.circleMarker(this._camPosCircle.getLatLng(), {
            weight: 1.5,
            opacity: this._camPosCircle.options.opacity,
            fillOpacity: this._camPosCircle.options.fillOpacity,
            fillColor: "#fab502",
            radius: 4,
            clickable: !1
        }), this._frustumLayer = L.layerGroup([this._frustumPoly, this._camPosCircle]), this._map = L.map(this._targetDomElement, {
            maxZoom: 7,
            zoomControl: !1,
            doubleClickZoom: !1,
            scrollWheelZom: !0,
            touchZoom: !0,
            trackResize: !0,
            layers: [],
            attributionControl: !1,
            crs: this._commonMetadata.getLeafletCRS()
        }), this._fadeByDefault = this._map.options.fadeAnimation, this._map.on("layeradd", function (t) {
            var i = t.layer;
            if (e.turnOffFading(i), i instanceof L.Marker && !(i instanceof L.MarkerCluster)) {
                var n = e.getRenderable(i._wsObject);
                n && n.setHideLabelByCluster(!1)
            }
        }), this._map.on("layerremove", function (t) {
            var i = t.layer;
            if (e.turnOnFading(i), i instanceof L.Marker && !(i instanceof L.MarkerCluster)) {
                var n = e.getRenderable(i._wsObject);
                n && n.setHideLabelByCluster(!0)
            }
        }), this._layer.isLayerVisible(WS.Layer.LayerIDs.VIEW_CAM, WS.Layer.ViewTypes.OVERVIEW_MAP) && this._frustumLayer.addTo(this._map), this._markerSelectionGroup = L.layerGroup([]), this._map.addLayer(this._markerSelectionGroup), this.createClusterGroup(), this.setScansVisible(this._layer.isLayerVisible(WS.Layer.LayerIDs.SCANS, WS.Layer.ViewTypes.OVERVIEW_MAP)), this.setCamVisible(this._layer.isLayerVisible(WS.Layer.LayerIDs.VIEW_CAM, WS.Layer.ViewTypes.OVERVIEW_MAP)), this._map.addControl(this._logoCtrl), this.initOverlayDOM(), this.init();
		//chen ban do
L.tileLayer( 'https://{s}.tile.openstreetmap.org/{z1}/{x1}/{y1}.png',{noWrap:true}).addTo( this._map );
      //var googleLayer = new L.Google('ROADMAP');
      //map.addLayer(googleLayer);

    },
    createClusterGroup: function (e) {
        e = void 0 === e ? !0 : e;
        var t = this;
        this._markerClusterGroup = e ? new L.MarkerClusterGroup({
            //disableClusteringAtZoom: this._commonMetadata._maxLevel,
			disableClusteringAtZoom: this._commonMetadata._maxLevel+5,
            maxClusterRadius: this._settingService._settings._showScanLabelsInMap ? WS.OverviewMap.CLUSTER_DIST_WITH_LABELS : WS.OverviewMap.CLUSTER_DIST_NO_LABELS,
            iconCreateFunction: function (e) {
                var i = e.getAllChildMarkers(),
                    n = i.map(function (e) {
                        return e._wsObject._UUID
                    }),
                    r = t._scanColorizer.getClusterColor(n),
                    o = "rgba(" + r.r + ", " + r.g + ", " + r.b + ", 0.45)",
                    a = 'style="border-color: ' + o + "; background-color: " + o + ';"',
                    s = L.divIcon({
                        html: '<div class="ws_cluster" ' + a + "><span>" + e.getChildCount() + "</span></div>",
                        className: "marker-cluster",
                        iconSize: new L.Point(40, 40)
                    });
                return s
            }
        }) : void 0, this._markerClusterGroup && (this._map.addLayer(this._markerClusterGroup), this._markerClusterGroup.on("clustermouseover", function () {
            return function (e) {
                var i = e.layer.getAllChildMarkers();
                if (t._layers.scanTiles && i.length <= WS.OverviewMap.MAX_CLUSTER_SIZE_MOUSEOVER) {
                    var n = i.map(function (e) {
                        return e._wsObject._UUID
                    });
                    t._layers.scanTiles.setScanList("mouseover", n)
                }
            }
        }()), this._markerClusterGroup.on("clustermouseout", function () {
            return function () {
                t._layers.scanTiles && t._layers.scanTiles.setScanList("mouseover", [])
            }
        }()), this._markerClusterGroup.on("animationend", function () {
            return function () {
                t.overlayUnhideTemp()
            }
        }()))
    },
    turnOffFading: function (e) {
        if (e instanceof WS.WSTilesLayer) {
            this._numTileLayers++;
            var t = F.isMobile() ? 2 : 4;
            t < this._numTileLayers && (this._map.options.fadeAnimation = !1, L.DomUtil.removeClass(this._map._container, "leaflet-fade-anim"))
        }
    },
    turnOnFading: function (e) {
        if (e instanceof WS.WSTilesLayer) {
            if (this._numTileLayers--, !this._fadeByDefault) return;
            var t = F.isMobile() ? 2 : 4;
            this._numTileLayers <= t && (this._map.options.fadeAnimation = !0, L.DomUtil.addClass(this._map._container, "leaflet-fade-anim"))
        }
    },
    initMapLayers: function () {
        if (this._mapObject._hasMapLayers) {
            var e = this,
                t = this.getProjectId();
            this._mapService.getMapLayersMetadata(t).then(function (i) {
                if (e._map && e.getProjectId() === t)
                    for (var n in i._layers) {
                        var r = i._layers[n];
                        e.initMapLayer(r)
                    }
            }, function (t) {
                e._alert.errorObj(t)
            })
        };
    },
    initLayoutLayers: function () {
		//chen tile
        if (this._commonMetadata._hasLayoutLayers) {
            var e = this,
                t = this.getProjectId();
            this._mapService.getLayoutLayersMetadata(t).then(function (i) {
                if (e._map && e.getProjectId() === t) {
                    var n = 0;
                    for (var r in i._layers) {
                        var o = i._layers[r];
                        e.initLayoutLayer(o, n), n++
                    }
                }
            }, function (t) {
                e._alert.errorObj(t)
            })
        }
    },
    initScanLayers: function () {
        if (this._commonMetadata._hasScanLayers) {
            var e = this,
                t = this.getProjectId();
            this._mapService.getScanLayersMetadata(t).then(function (i) {
                e._map && e.getProjectId() === t && e.initScanTilesLayer(i)
            }, function (t) {
                "EM_RESOURCE_NOT_FOUND" === t.message ? e._alert.tip("FE_MAP_MISSING_SCAN_LAYERS", 1e4) : e._alert.errorObj(t)
            })
        }
    },
    initMapLayer: function (e) {
        if (e._tiles) {
            var t, i, n = this.getProjectId(),
                r = e._objectUuid;
            WS._2GO ? t = "ws2go-data/project/" + n + "/map/map-layers/" + r + "/tiles/{z}/{x}/{y}.png" : (t = "/data/project/" + n + "/layer-tile/" + r + "/{z}/{x}/{y}", this._CDN.hasCDN() && (i = n + "/map/map-layers/" + r + "/tiles/{z}/{x}/{y}.png")), this.createLayer(e, r, n, t, i)
        }
    },
    initLayoutLayer: function (e, t) {
        if (!e._tiles) return void 0;
        var i, n, r = this.getProjectId(),
            o = e._layoutUuid;
        WS._2GO ? i = "ws2go-data/project/" + r + "/map/layout-layers/" + o + "/tiles/{z}/{x}/{y}.png" : (i = "/data/project/" + r + "/layout-tile/" + o + "/{z}/{x}/{y}", this._CDN.hasCDN() && (n = r + "/map/layout-layers/" + o + "/tiles/{z}/{x}/{y}.png")), this.createLayer(e, o, r, i, n, t)
    },
    initWorkspaceLayer: function () {
		// chen tile
       var e = this.getProjectId(),
            t = this,
            i = this._mapMetadata && 4 <= this._mapMetadata._exportVersion || 3 <= this._mapObject._exportVersion;
        i ? this._mapService.getTilesSimpleMetadata(e).then(function (i) {
            t.initWorkspaceLayerPart2(e, i)
        }, function (i) {
            t._alert.errorObj(i), t.initWorkspaceLayerPart2(e)
        }) : this.initWorkspaceLayerPart2(e)
    },
    initWorkspaceLayerPart2: function (e, t) {
        if (this._map && this.getProjectId() === e) {
            var i, n, r = t && 2 <= t._exportVersion ? t._objectUuid : void 0;
            WS._2GO ? i = "ws2go-data/project/" + e + "/map/tiles/{z}/{x}/{y}.png" : (i = "/data/project/" + e + "/tile/{z}/{x}/{y}", this._CDN.hasCDN() && (n = e + "/map/tiles/{z}/{x}/{y}.png")), this.createLayer(t, r, e, i, n)
        }
    },
    initScanTilesLayer: function (e) {
        this._layers.scanTiles = new WS.ScanTilesLayer(this._commonMetadata, this._objects.scan.entities, e, this._scanColorizer, this._CDN, this.getProjectId()), this._layers.scanTiles.addTo(this._map);
        var t = [];
        this._objects.scan.entities.forEach(function (e) {
            e._scanPointsShown && t.push(e._UUID)
        }), this._layers.scanTiles.setScanList("selection", t)
    },
    createLayer: function (e, t, i, n, r, o) {
        var a, s, c, l, h, d, u = t ? this._mapLayersByObjUuid[t] : void 0;
        u ? (a = u._type === WS.MapLayer.Type.WORKSPACE && "Workspace" === u._displayName ? this._locale.translate("FE_SCAN_DATA") : u._displayName, s = WS.ScanTilesLayer.Z_INDEX_START_LAYERS + this._mapObject._layerOrder.length - this._mapObject.getOrderOfLayer(u._UUID, !1), h = u._type, c = u._opacity / 100, l = 0 < u._opacity, d = u._UUID) : (e instanceof WS.LayoutTiles ? (a = e._layoutName, s = WS.ScanTilesLayer.Z_INDEX_START_LAYERS + o, h = WS.MapLayer.Type.LAYOUT_PLAN) : (a = this._locale.translate("FE_SCAN_DATA"), s = WS.ScanTilesLayer.Z_INDEX_MAP, h = WS.MapLayer.Type.WORKSPACE), c = 1, l = !0);
        var _ = e ? e._tiles : void 0,
            p = new WS.WSTilesLayer(_, this._CDN, i, n, r, {
                minZoom: this._commonMetadata._minLevel,
                maxZoom: this._commonMetadata._maxLevel + WS.OverviewMap.ADDITIONAL_ZOOM_LEVELS,
                maxNativeZoom: this._commonMetadata._maxLevel,
                zoomOffset: 0,
                noWrap: !1,
                continuousWorld: !0,
                opacity: c,
                zIndex: s,
                visible: l,
                displayName: a,
                type: h,
                opacityIsInitial: !0,
                uuid: d
            });
        p.options.visible && p.addTo(this._map), this.$scope.leafletLayers.push(p), this.$scope.leafletLayers.sort(function (e, t) {
            return t.options.zIndex - e.options.zIndex
        }), this.$scope.$apply()
    },
    updateLayerOrder: function (e) {
        if (e._project === this.getProjectId() && this._mapObject._layerOrder) {
            for (var t = WS.ScanTilesLayer.Z_INDEX_START_LAYERS + this._mapObject._layerOrder.length, i = 0, n = this.$scope.leafletLayers.length; n > i; ++i) {
                var r = this.$scope.leafletLayers[i],
                    o = t - this._mapObject.getOrderOfLayer(r.options.uuid, !1);
                r.setZIndex(o)
            }
            this.$scope.leafletLayers.sort(function (e, t) {
                return t.options.zIndex - e.options.zIndex
            })
        }
    },
    updateLayer: function (e) {
        if (e._project === this.getProjectId())
            for (var t = 0, i = this.$scope.leafletLayers.length; i > t; ++t) {
                var n = this.$scope.leafletLayers[t];
                if (n.options.uuid === e._UUID) {
                    n.setOpacity(e._opacity / 100);
                    var r = 0 < e._opacity;
                    return r !== n.options.visible && (r ? n.addTo(this._map) : this._map.removeLayer(n), n.options.visible = r), void(n.options.displayName = e._displayName)
                }
            }
    },
    mapReady: function () {
        return this.$scope.project && this._map;
    },
    getProjectId: function () {
        return this.$scope.project ? this.$scope.project._name : void 0
    },
    fitBounds: function (e, t, i) {
        this._commonMetadata && (i = i || {}, i.maxZoom = this._commonMetadata._maxLevel), WS.MapLeaflet.prototype.fitBounds.call(this, e, t, i)
    },
    zoomFit: function () {
        if (this._objects.scan.entities.length > 0) this.fitMarkers();
        else {
            this.invalidateSize();
            var e = this._commonMetadata,
                t = this.globalToLatLng([e._globalTopLeftX, e._globalBottomRightY, 0]),
                i = this.globalToLatLng([e._globalBottomRightX, e._globalTopLeftY, 0]),
                n = L.latLngBounds(t, i);
            this.fitBounds(n)
        }
    },
    addMarker: function (e, t) {
        var i = this,
            n = new WS.MapMarker(e, this._markerClusterGroup, t, {
                title: e._displayName
            });
        this.updateMarkerIcon(n), n.on("click", function () {
            (i._mode === WS.ViewBase.Mode.SelectObject || i._mode === WS.ViewBase.Mode.SelectObjects || i._mode === WS.ViewBase.Mode.PickAll || i._mode === WS.ViewBase.Mode.PickPointOpenScans) && i.dispatchScanClick("onDataObjectClick", e);
			//i.dispatchScanClick("onDataObjectDblClick", e)

        }), n.on("dblclick", function () {
            return function () {
                i.dispatchScanClick("onDataObjectDblClick", e)
            }
        }()), n.on("mouseover", function () {
            return function () {
				i.dispatchScanClick("onDataObjectClick", e)
              				//var _uid = e._UUID;
                //var popupimage = "ws2go-data/project/lhc-full-revision/scans/" + _uid + "-color-512.jpg";
                //var   _link = "ws2go.html?v=pv&t=p:default,c:panoramaview,m:t&pv=pv1&pv1=vt:p,u:" + _uid + ",p:6.28319,t:0.00000&p=lhc-full-revision";
                 //   $("._t_description").html(e._displayName);
                 //   $(".myimage").attr("src", popupimage);
                 //   $(".mlink").attr("href", _link);
					//this._view.showRadialMenu(e, t, i);
				//	document.getElementById("overviewpopup").style.display = "block";


                //openPopup(evt);
               // this._view.showRadialMenu(e, t, i);
               // i._layers.scanTiles && i._layers.scanTiles.setScanList("mouseover", [e._UUID])
            }
        }()), n.on("mouseout", function () {
            return function () {
                //closePopup();
                i._layers.scanTiles && i._layers.scanTiles.setScanList("mouseover", [])
            }
        }()), WS.MapLeaflet.prototype.addMarker.call(this, e._UUID, n)
    },
    updateMarkerIconForScan: function (e) {
        var t = this._markerMap[e._UUID];
        t && this.updateMarkerIcon(t)
    },
    updateMarkerIcon: function (e) {
        var t = e ? e.getObject() : void 0;
        if (t instanceof WS.Scan) {
            var i = t._UUID === this._panoviewScanId,
                n = this._hlObject === t,
                r = i || n || t._scanPointsShown || t._selected || this._allowedToSelectScan,
                o = r ? this._markerSelectionGroup : this._markerClusterGroup;
            e.setParent(o);
            var a = this.getRenderable(t);
            a && this.updateViewingMode(a)
        }
    },
    updateViewingMode: function (e) {
        var t = e._dataObject;
        e.setViewingMode(t && t._selected ? WS.Renderable.ViewingMode.Selected : t && this._hlObject === t ? WS.Renderable.ViewingMode.Highlighted : e instanceof WS.ScanMapRenderable && t && t._UUID === this._panoviewScanId ? WS.Renderable.ViewingMode.Displayed : WS.Renderable.ViewingMode.Normal)
    },
    setLayerVisible: function (e, t) {
        e && (t && !this._map.hasLayer(e) ? this._map.addLayer(e) : !t && this._map.hasLayer(e) && this._map.removeLayer(e))
    },
    setCamVisible: function (e) {
        this.setLayerVisible(this._frustumLayer, e)
    },
    setScansVisible: function (e) {
        this.setLayerVisible(this._markerClusterGroup, e), this.setLayerVisible(this._markerSelectionGroup, e);
        var t = this._layers.scanTiles;
        if (t) {
            var i = [];
            e && this._objects.scan.entities.forEach(function (e) {
                e._scanPointsShown && i.push(e._UUID)
            }), t.setScanList("selection", i)
        }
    },
    globalToLatLng: function (e) {

        return L.latLng(e[1], e[0]);
		
    },
    setPanoScan: function (e) {
        var t = e instanceof WS.Scan ? e._UUID : e._sourceUUIDs[0],
            i = this._markerMap[this._panoviewScanId],
            n = this._markerMap[t];
        this._panoviewScanId = t, i && this.updateMarkerIcon(i), n && this.updateMarkerIcon(n), this._frustumPoly.setLatLngs([]), this._camPosCircle.setStyle({
            opacity: 0,
            fillOpacity: 0
        })
    },
    clearPanoScan: function () {
        var e = this._markerMap[this._panoviewScanId];
        this._panoviewScanId = void 0, e && this.updateMarkerIcon(e), this._frustumPoly.setLatLngs([]), this._camPosCircle.setStyle({
            opacity: 0,
            fillOpacity: 0
        })
    },
    sceneRootChange: function (e, t) {
        var i = this;
        t instanceof WS.PanoramaView && (e instanceof WS.Scan || e instanceof WS.PointCloud && "Scan" === e._type ? this.setPanoScan(e) : this.clearPanoScan(), this._viewModeCtrlD.promise.then(function () {
            i._viewModeCtrl.currentRoot(e)
        }))
    },
    onCameraChange: function (e, t) {
        if (e && e.instanceOf && e.instanceOf(WS.PerspectiveCameraObject) && t && t.instanceOf && t.instanceOf(WS.PanoramaView)) {
            var i = e.getAxisGlobal(),
                n = e.getRightGlobal(),
                r = WS.OverviewMap.FRUSTUM_SIZE,
                o = e._fovY / 180 * Math.PI,
                a = r * Math.tan(.5 * o),
                s = a * e._aspectRatio;
            vec3.scale(i, -r), vec3.scale(n, -s);
            var c = e.getGlobalPosition(),
                l = c,
                h = vec3.create();
            vec3.add(c, i, h), vec3.add(h, n, h);
            var d = vec3.create();
            vec3.add(c, i, d), vec3.subtract(d, n, d);
            var u = [l, h, d].map(F.proxy(this.globalToLatLng, this));
            this._frustumPoly.setLatLngs(u), this._camPosCircle.setLatLng(u[0]), this._camPosCircle.setStyle({
                opacity: 1,
                fillOpacity: 1
            })
        }
    }
}, WS.extend("OverviewMap", "MapLeaflet"), WS.OverviewMap.type = WS.Layer.ViewTypes.OVERVIEW_MAP, WS.OverviewMap.defaultMode = WS.ViewBase.Mode.PickAll, WS.OverviewMap.MAX_CLUSTER_SIZE_MOUSEOVER = 5, WS.OverviewMap.FRUSTUM_SIZE = 5, WS.OverviewMap.TIMEOUT_SET_ICON = 10, WS.OverviewMap.OVERLAY_CANVAS_CLASS = "ws_mapOverlayCanvas", WS.OverviewMap.ADDITIONAL_ZOOM_LEVELS = 4, WS.OverviewMap.CLUSTER_DIST_WITH_LABELS = 90, WS.OverviewMap.CLUSTER_DIST_NO_LABELS = 50, WS.OverviewMap.VIEWPOINT_EPS_PX = 25, WS.OverviewMap.FSM = {
    "void": {
        startload: "loading",
        reset: "void"
    },
    loading: {
        loaddone: "free",
        focusobject: "highlight",
        reset: "void"
    },
    free: {
        move: "free",
        focusobject: "highlight",
        reset: "void"
    },
    highlight: {
        move: "free",
        focusobject: "highlight",
        reset: "void"
    }
}, WS.OverviewMap.ViewMode = {
    MAP: "map"
}, WS.OverviewMapSettingService = function (e, t) {
    F.PlugModule.call(this, e), this._cookie = t, this._cookieId = "overviewmap", this._settings = new WS.OverviewMapSettings(WS.OverviewMapSettings.COLORIZE_SCAN_TILES, WS.OverviewMapSettings.COLORIZE_BY_HEIGHT, WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE, WS.OverviewMapSettings.COLORIZE_TILE_BACKGROUND, 1, WS.OverviewMapSettings.AGG_AVG, WS.OverviewMapSettings.IconModes.Category, !0, !1, !0, this), this.getFromLocalStorage(this._settings), this.provideMalePlug("SettingsUpdate", ["updateSettings"])
}, WS.OverviewMapSettingService.prototype = {
    getNew: function (e, t, i, n, r, o, a, s) {
        return new WS.OverviewMapSettings(e, t, i, n, r, o, a, s, this)
    },
    getAll: function () {
        var e = this._settings.clone(),
            t = Q.defer();
        return t.resolve([e]), t.promise
    },
    getByPrimaryKey: function () {
        var e = this._settings.clone(),
            t = Q.defer();
        return t.resolve(e), t.promise
    },
    update: function (e) {
        var t = Q.defer();
        e.applyUpdate();
        var i = e.clone();
        return this._settings = i, this._settings.writeToLocalStorage(), t.resolve(), this.trigger("updateSettings", ["overviewmap", e]), t.promise
    },
    writeToLocalStorage: function (e) {
        var t = {
            scanOrBaseTiles: e._scanOrBaseTiles,
            scanTilesColorizeBy: e._scanTilesColorizeBy,
            baseTilesColorizeBy: e._baseTilesColorizeBy,
            baseTilesColorizeWhat: e._baseTilesColorizeWhat,
            colorPaletteIdx: e._colorPaletteIdx,
            aggregation: e._aggregation,
            iconMode: e._iconMode,
            showScanLabelsInMap: e._showScanLabelsInMap,
            showOrthoVolumes: e._showOrthoVolumes,
            showPolylines: e._showPolylines
        };
        this._cookie.setLocalStorageItem(this._cookieId, JSON.stringify(t))
    },
    getFromLocalStorage: function (e) {
        var t = JSON.parse(this._cookie.getLocalStorageItem(this._cookieId));
        t && (e._scanOrBaseTiles = t.scanOrBaseTiles, e._scanTilesColorizeBy = t.scanTilesColorizeBy, e._baseTilesColorizeBy = t.baseTilesColorizeBy, e._baseTilesColorizeWhat = t.baseTilesColorizeWhat, e._colorPaletteIdx = t.colorPaletteIdx, e._aggregation = t.aggregation, e._iconMode = t.iconMode, "boolean" == typeof t.showScanLabelsInMap && (e._showScanLabelsInMap = t.showScanLabelsInMap), "boolean" == typeof t.showOrthoVolumes && (e._showOrthoVolumes = t.showOrthoVolumes), "boolean" == typeof t.showPolylines && (e._showPolylines = t.showPolylines))
    },
    scanTilesColorizeBy: function () {
        return this._settings._scanTilesColorizeBy
    },
    getColorGradient: function () {
        return this._settings._colorGradient
    },
    getAggregation: function () {
        return this._settings._aggregation
    }
}, WS.extend("OverviewMapSettingService", "PlugModule"), WS.MapMetadata = function () {
    this._backgroundColor = void 0, this._class = void 0, this._exportVersion = void 0, this._geoReferenced = void 0, this._globalBottomRightX = void 0, this._globalBottomRightY = void 0, this._globalTopLeftX = void 0, this._globalTopLeftY = void 0, this._hasLayoutLayers = void 0, this._hasScanLayers = void 0, this._heightInMeters = void 0, this._layoutLayersMaxLevel = void 0, this._layoutLayersMinLevel = void 0, this._maxLevel = void 0, this._maxScanElevation = void 0, this._minLevel = void 0, this._minScanElevation = void 0, this._pixelsPerMeterMax = void 0, this._scanLayersMaxLevel = void 0, this._scanLayersMinLevel = void 0, this._tileBottomRightX = void 0, this._tileBottomRightY = void 0, this._tileSizeInMeters = void 0, this._tileTopLeftX = void 0, this._tileTopLeftY = void 0, this._widthInMeters = void 0, this._numMapLevels = void 0, this._pixelsPerMeterMin = void 0
}, WS.MapMetadata.prototype = {
    readJson: function (e) {
        this._backgroundColor = e.BackgroundColor, this._class = e.Class, this._exportVersion = e.ExportVersion, this._geoReferenced = e.GeoReferenced, this._globalBottomRightX = e.GlobalBottomRightX, this._globalBottomRightY = e.GlobalBottomRightY, this._globalTopLeftX = e.GlobalTopLeftX, this._globalTopLeftY = e.GlobalTopLeftY, this._hasScanLayers = e.HasScanLayers, this._heightInMeters = e.HeightInMeters, this._maxLevel = e.MaxLevel, this._minLevel = e.MinLevel, this._pixelsPerMeterMax = e.PixelsPerMeter, this._scanLayersMaxLevel = e.ScanLayersMaxLevel, this._scanLayersMinLevel = e.ScanLayersMinLevel, this._tileBottomRightX = e.TileBottomRightX, this._tileBottomRightY = e.TileBottomRightY, this._tileSizeInMeters = e.TileSizeInMeters, this._tileTopLeftX = e.TileTopLeftX, this._tileTopLeftY = e.TileTopLeftY, this._widthInMeters = e.WidthInMeters, this._hasLayoutLayers = e.HasLayoutLayers, this._layoutLayersMaxLevel = e.LayoutLayersMaxLevel, this._layoutLayersMinLevel = e.LayoutLayersMinLevel, this._maxScanElevation = e.MaxScanElevation, this._minScanElevation = e.MinScanElevation, this._numMapLevels = this._maxLevel - this._minLevel + 1, this._pixelsPerMeterMin = this._pixelsPerMeterMax / Math.pow(2, this._numMapLevels - 1)
    },
    getLeafletCRS: function () {
        return WS.MapObject.getLeafletCRS(this)
    }
}, WS.extend("MapMetadata"), WS.ScanTiles = function () {
    this._class = void 0, this._exportVersion = void 0, this._scan = void 0, this._tiles = void 0, this._scanName = void 0, this._metadataUuid = void 0
}, WS.ScanTiles.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._exportVersion = e.ExportVersion, this._scan = e.Scan, this._tiles = e.Tiles, this._scanName = e.ScanName, this._metadataUuid = e.MetadataUUID
    }
}, WS.extend("ScanTiles"), WS.MapTilesSimple = function () {
    this._class = void 0, this._exportVersion = void 0, this._tiles = void 0, this._objectUuid = void 0, this._metadataUuid = void 0
}, WS.MapTilesSimple.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._exportVersion = e.ExportVersion, this._tiles = e.Tiles, this._metadataUuid = e.MetadataUUID, this._objectUuid = e.ObjectUUID
    }
}, WS.extend("MapTilesSimple"), WS.LayoutTiles = function () {
    this._class = void 0, this._exportVersion = void 0, this._layoutUuid = void 0, this._layoutName = void 0, this._tiles = void 0, this._metadataUuid = void 0
}, WS.LayoutTiles.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._exportVersion = e.ExportVersion, this._layoutUuid = e.LayoutUuid, this._layoutName = e.LayoutName, this._tiles = e.Tiles, this._metadataUuid = e.MetadataUUID
    }
}, WS.extend("LayoutTiles"), WS.MapLayerTiles = function () {
    this._class = void 0, this._exportVersion = void 0, this._metadataUuid = void 0, this._objectUuid = void 0, this._tiles = void 0
}, WS.MapLayerTiles.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._exportVersion = e.ExportVersion, this._metadataUuid = e.MetadataUUID, this._objectUuid = e.ObjectUUID, this._tiles = e.Tiles
    }
}, WS.extend("MapLayerTiles"), WS.ScanLayers = function () {
    this._class = void 0, this._exportVersion = void 0, this._layers = void 0
}, WS.ScanLayers.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._exportVersion = e.ExportVersion, this._layers = {};
        var t = e.Layers;
        for (var i in t) t.hasOwnProperty(i) && (this._layers[i] = new WS.ScanTiles, this._layers[i].readJson(t[i]))
    }
}, WS.extend("ScanLayers"), WS.LayoutLayers = function () {
    this._class = void 0, this._exportVersion = void 0, this._layers = void 0
}, WS.LayoutLayers.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._exportVersion = e.ExportVersion, this._layers = {};
        var t = e.Layers;
        for (var i in t) t.hasOwnProperty(i) && (this._layers[i] = new WS.LayoutTiles, this._layers[i].readJson(t[i]))
    }
}, WS.extend("LayoutLayers"), WS.MapLayers = function () {
    this._class = void 0, this._exportVersion = void 0, this._layers = void 0
}, WS.MapLayers.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._exportVersion = e.ExportVersion, this._layers = {};
        var t = e.Layers;
        for (var i in t) t.hasOwnProperty(i) && (this._layers[i] = new WS.MapLayerTiles, this._layers[i].readJson(t[i]))
    }
}, WS.extend("MapLayers"), WS.OverviewMapService = function (e, t, i) {
    WS.PlugModule.call(this, e), this._error = t, this._resource = i, this._restClientMapData = this._resource(WS._2GO ? "ws2go-data/project/:project/map/metadata.json" : "/data/project/:project/map-data", {}, {
        read: {
            method: "GET",
            params: {}
        }
    }), this._restClientTileSimpleData = this._resource(WS._2GO ? "ws2go-data/project/:project/map/tiles-simple.json" : "/data/project/:project/tile-simple-data", {}, {
        read: {
            method: "GET",
            params: {}
        }
    }), this._restClientScanLayerData = this._resource(WS._2GO ? "ws2go-data/project/:project/map/scan-layers/scan-layers.json" : "/data/project/:project/scan-layer-data", {}, {
        read: {
            method: "GET",
            params: {}
        }
    }), this._restClientLayoutLayerData = this._resource(WS._2GO ? "ws2go-data/project/:project/map/layout-layers/layout-layers.json" : "/data/project/:project/layout-layer-data", {}, {
        read: {
            method: "GET",
            params: {}
        }
    }), this._restClientMapLayerData = this._resource(WS._2GO ? "ws2go-data/project/:project/map/map-layers/map-layers.json" : "/data/project/:project/map-layer-data", {}, {
        read: {
            method: "GET",
            params: {}
        }
    })
}, WS.OverviewMapService.prototype = {
    getMapMetadata: function (e) {
        var t = Q.defer();
        return this._restClientMapData.read({
            project: e
        }, function (e) {
            var i = new WS.MapMetadata;
            i.readJson(e), t.resolve(i)
        }, this._error.restHandler(t)), t.promise
    },
    getTilesSimpleMetadata: function (e) {
        var t = Q.defer();
        return this._restClientTileSimpleData.read({
            project: e
        }, function (e) {
            var i = new WS.MapTilesSimple;
            i.readJson(e), t.resolve(i)
        }, this._error.restHandler(t)), t.promise
    },
    getScanLayersMetadata: function (e) {
        var t = Q.defer();
        return this._restClientScanLayerData.read({
            project: e
        }, function (e) {
            var i = new WS.ScanLayers;
            i.readJson(e), t.resolve(i)
        }, this._error.restHandler(t)), t.promise
    },
    getLayoutLayersMetadata: function (e) {
        var t = Q.defer();
        return this._restClientLayoutLayerData.read({
            project: e
        }, function (e) {
            var i = new WS.LayoutLayers;
            i.readJson(e), t.resolve(i)
        }, this._error.restHandler(t)), t.promise
    },
    getMapLayersMetadata: function (e) {
        var t = Q.defer();
        return this._restClientMapLayerData.read({
            project: e
        }, function (e) {
            var i = new WS.MapLayers;
            i.readJson(e), t.resolve(i)
        }, this._error.restHandler(t)), t.promise
    }
}, WS.extend("OverviewMapService", "PlugModule"), WS.MapLayerService = function (e, t, i, n, r, o, a, s, c) {
    F.ProjectCRUDService.call(this, "MapLayer", WS.MapLayer, "/maplayer", {}, e, t, i, n, r, o, a, s, c)
}, WS.MapLayerService.prototype = {
    getNew: function () {
        var e = F.CRUDService.prototype.getNew.call(this);
        return e._project = this._project.hasCurrent() ? this._project.getCurrent() : void 0, e
    },
    handleSingleEntity: function (e) {
        e._ancestors = []
    },
    handleEntityChanges: function (e, t, i) {
        var n = function (e) {
            e._ancestors = []
        };
        return e.forEach(n), t.forEach(n), F.CRUDService.prototype.handleEntityChanges.bind(this, e, t, i)
    }
}, WS.extend("MapLayerService", "ProjectCRUDService"), WS.MapObjectService = function (e, t, i, n, r, o, a, s, c) {
    F.ProjectCRUDService.call(this, "Map", WS.MapObject, "/map", {}, e, t, i, n, r, o, a, s, c)
}, WS.MapObjectService.prototype = {
    getNew: function () {
        var e = F.CRUDService.prototype.getNew.call(this);
        return e._project = this._project.hasCurrent() ? this._project.getCurrent() : void 0, e
    },
    handleSingleEntity: function (e) {
        e._ancestors = []
    },
    handleEntityChanges: function (e, t, i) {
        var n = function (e) {
            e._ancestors = []
        };
        return e.forEach(n), t.forEach(n), F.CRUDService.prototype.handleEntityChanges.bind(this, e, t, i)
    }
}, WS.extend("MapObjectService", "ProjectCRUDService"), WS.WorldMap = function (e, t, i, n, r, o, a, s) {
    WS.MapLeaflet.call(this, e, i, n, r, a), this._project = o, this._login = s, this._projectSelector = void 0, this._fitMarkersMargin = .5, this._minZoom = 0, this._maxZoom = 19, this._urlTerrainLayer = "https://{s}.tiles.mapbox.com/v3/websharecloud.i0ffdl62/{z}/{x}/{y}.png", this._tileSubdomains = "abcd", this._attributionShort = "<a href='https://www.mapbox.com/about/maps/' target='_blank' title='About Mapbox'>&copy; Mapbox &copy; OpenStreetMap</a>", this._datePeriodFilter = t("dateperiod"), this._dateFilter = t("date")
}, WS.WorldMap.prototype = {
    zoomFit: function () {
        var e = this.getMarkerArray();
        1 === e.length ? (this.invalidateSize(), this.setView(e[0].getLatLng(), 7)) : e.length > 1 && this.fitMarkers()
    },
    setProjectSelector: function (e) {
        this._projectSelector = e
    },
    openproject: function (e) {
        this._projectSelector.pickProject(e)
    },
    showdetails: function (e) {
        this._projectSelector.openProjectDetails(e)
    },
    addMarker: function (e, t) {
        var i = this,
            n = e._latitude,
            r = e._longitude,
            o = new WS.MapMarker(e, this._map, [n, r], {
                title: e.getID()
            });
        return o.setWorldIcon(), o.setVisible(!0), o.getMarker().bindPopup(t, {
            closeButton: !0
        }), o.on("dblclick", function () {
            var t = e;
            return function () {
                i.openproject(t)
            }
        }()), WS.MapLeaflet.prototype.addMarker.call(i, e.getID(), o), o
    },
    addMarkerCluster: function () {
        var e = this,
            t = new L.MarkerClusterGroup({
                disableClusteringAtZoom: !1,
                maxClusterRadius: 50
            });
        this._map.addLayer(t), this._login.isProjectManager().then(function (i) {
            var n = e._project.getAllWithStates(i ? ["Completed", "Draft", "Published"] : ["Completed", "Published"]);
            n.then(function (i) {
                for (var n = i.length, r = 0; n > r; r++) {
                    var o = i[r],
                        a = o._latitude,
                        s = o._longitude,
                        c = new WS.MapMarker(o, t, [a, s]);
                    c.setWorldIcon(), c.setVisible(!0), c.on("dblclick", function () {
                        return function () {
                            e.openproject(o)
                        }
                    }()), e.addMarkerPopup(c, o), WS.MapLeaflet.prototype.addMarker.call(e, o.getID(), c)
                }
                e.zoomFit(), e._map.on("popupopen", function (t) {
                    e.setPopupContent(t.popup)
                })
            }).done()
        }).done()
    },
    addMarkerPopup: function (e, t) {
        var i = document.createElement("div");
        e.getMarker().bindPopup(i, {
            closeButton: !0,
            ws_project: t
        })
    },
    setPopupContent: function (e) {
        var t = this,
            i = e.options.ws_project,
            n = function () {
                t.openproject(i)
            },
            r = function () {
                t.showdetails(i)
            },
            o = document.createElement("div");
        o.innerHTML = '<p class="f_textML f_textBold"></p><table class="f_textSM">    <tr> <td class="f_textBold" style="padding-right:10px; max-width: 160px;"></td> <td></td></tr>    <tr> <td class="f_textBold" style="padding-right:10px"></td> <td></td></tr>    <tr> <td class="f_textBold" style="padding-right:10px"></td> <td><a target="_blank"></a></td></tr></table><table style="width:100%; margin-top:15px">    <tr>        <td>            <div class="projectImageWrapperSmall"                 style="vertical-align:middle;  background-image:url(' + i.getImage() + ')">            </div>        </td>        <td style="vertical-align:top; text-align:right">            <div class="btn-group">               <button class="btn btn-default" ng-click="openProjectDetails(featured)" title="Details">                  <img class="f_icon24" src="' + WS.imgUrl("icons/im/details.png") + '">               </button>               <button class="btn btn-warning" ng-click="pickProject(featured)" title="Load">                  <img class="f_icon24" src="' + WS.imgUrl("icons/im/open.png") + '">               </button>            </div>        </td>    </tr></table>', $(o).attr("style", "min-width:240px;"), $(o.getElementsByTagName("p")[0]).text(i._displayName);
        var a = o.getElementsByTagName("table")[0],
            s = a.getElementsByTagName("tr")[0];
        if (i._type === WS.Project.Type.WSC) {
            $(s.getElementsByTagName("td")[0]).text(t._locale.translate("FE_NO_OF_SCANS") + ":"), $(s.getElementsByTagName("td")[1]).text(i._numberOfScans);
            var c = a.getElementsByTagName("tr")[1];
            $(c.getElementsByTagName("td")[0]).text(t._locale.translate("FE_REC_PERIOND_PRPJ") + ":");
            var l = this._datePeriodFilter([i._oldestScanRecordingTime, i._newestScanRecordingTime], !0);
            $(c.getElementsByTagName("td")[1]).html(l)
        } else {
            $(s.getElementsByTagName("td")[0]).text(t._locale.translate("FE_PROJECT_CREATION_TIME") + ":");
            var h = this._dateFilter(i._creationDate, !0);
            $(s.getElementsByTagName("td")[1]).html(h)
        }
        var d = a.getElementsByTagName("tr")[2];
        $(d.getElementsByTagName("td")[0]).text(t._locale.translate("FE_LOCATION") + ":");
        var u = d.getElementsByTagName("td")[1].getElementsByTagName("a")[0];
        $(u).text(i._latitude + ", " + i._longitude), $(u).attr("title", t._locale.translate("FE_OPEN_GMAPS")), $(u).attr("href", "https://www.google.com/maps/place//" + i._latitude + "," + i._longitude + "/@" + i._latitude + "," + i._longitude + ",15z");
        var _ = o.getElementsByTagName("table")[1].getElementsByTagName("tr")[0],
            p = _.getElementsByTagName("td")[1].getElementsByTagName("button")[1];
        $(p).attr("title", t._locale.translate("FE_LOAD_PROJECT")), $(p).click(n);
        var g = _.getElementsByTagName("td")[1].getElementsByTagName("button")[0];
        $(g).attr("title", t._locale.translate("FE_DETAILS")), $(g).click(r), e.setContent(o)
    },
    prepareMap: function () {
        var e = L.tileLayer(this._urlTerrainLayer, {
                subdomains: this._tileSubdomains,
                attribution: this._attributionShort,
                minZoom: this._minZoom,
                maxZoom: this._maxZoom
            }),
            t = [e],
            i = {
                minZoom: this._minZoom,
                maxZoom: this._maxZoom,
                zoomControl: !0,
                doubleClickZoom: !1,
                scrollWheelZoom: !1,
                touchZoom: !0,
                trackResize: !0,
                layers: t
            };
        F.isIE() && F.ieVersion() < 11 && (i.fadeAnimation = !1, i.zoomAnimation = !1, i.markerZoomAnimation = !1);
        var n = this._map = L.map(this._targetDomElement, i);
        this._map.on("focus", function () {
            n.scrollWheelZoom.enable()
        }), this._map.on("blur", function () {
            n.scrollWheelZoom.disable()
        }), L.control.scale().addTo(this._map), this.addViewAllControl({
            tooltip: "FE_VIEW_ALL"
        })
    }
}, WS.extend("WorldMap", "MapLeaflet"), angular.module("ws.map", []), F.DI().config("@task", "@alert", "@project", "@pointcloud", "@panosettings", function (e, t, i, n, r) {
    this.registerParameter("ommenu", {
        evaluate: {
            edit: function (t) {
                return !t._writeLock && !t._temporary && ("Annotation" === t._class || "Measurement" === t._class || "Scan" === t._class || "Orthophoto" === t._class) && e.taskExists("default", "overviewmap", "edit")
            },
            remove: function (t) {
                return !t._writeLock && ("Annotation" === t._class || "Measurement" === t._class || "Orthophoto" === t._class) && e.taskExists("default", "overviewmap", "remove")
            },
            showproperties: function (e) {
                return "Annotation" === e._class || "Measurement" === e._class || "Scan" === e._class || "Orthophoto" === e._class
            },
            panorama: function (e) {
                return i.canShowObjectInPano(e)
            },
            view3d: function (e) {
                return r.isWebGlEnabled() ? n.canShowObjectIn3d(e) : !1
            },
            switchsegments: function (e) {
                return "Measurement" === e._class && "Distance" === e._displayType
            },
            share: function (t) {
                return !t._writeLock && !t._temporary && ("Annotation" === t._class || "Measurement" === t._class || "Scan" === t._class || "Orthophoto" === t._class) && e.taskExists("default", "overviewmap", "share")
            },
            showscanpoints: function (e) {
                return "Scan" === e._class && !!window.om._layers.scanTiles
            },
            showdistancelabels: function (e) {
                return "Measurement" === e._class && "Area" === e._displayType
            }
        },
        options: {
            showscanpoints: function (e) {
                return {
                    checkbox: {
                        show: e._scanPointsShown,
                        checked: !0,
                        x: -1,
                        y: 1
                    },
                    title: e._scanPointsShown ? "FE_HIDE_SCAN_COLORIZATION" : "FE_SHOW_SCAN_COLORIZATION"
                }
            },
            showdistancelabels: function (e) {
                var t = window.om.getRenderable(e);
                return {
                    checkbox: {
                        show: t && t.isShowingDistanceLabels(),
                        checked: !0,
                        x: -1,
                        y: 1
                    },
                    title: t && t.isShowingDistanceLabels() ? "FE_HIDE_DISTANCE_LABELS" : "FE_SHOW_DISTANCE_LABELS"
                }
            }
        },
        execute: {
            edit: function (e) {
                e.select(), window.om.trigger("launchTask", ["default", "overviewmap", "edit"])
            },
            remove: function (e) {
                return e.remove()
            },
            showproperties: function (e) {
                window.om.trigger("showObjects", [
                    [e], "properties"
                ])
            },
            panorama: function (e) {
                switch (e._class) {
                    case "Scan":
                        window.pv.trigger("showObjects", [
                            [e], "panorama"
                        ]);
                        break;
                    case "Annotation":
                    case "Measurement":
                    case "Orthophoto":
                        window.pv.trigger("focusOn", [{
                            object: e
                        }, "panorama"])
                }
            },
            view3d: function (e) {
                switch (e._class) {
                    case "Scan":
                        window.pv.trigger("showObjects", [
                            [e], "3d"
                        ]);
                        break;
                    case "Annotation":
                    case "Measurement":
                    case "Orthophoto":
                        window.pv.trigger("focusOn", [{
                            object: e
                        }, "3d"])
                }
            },
            switchsegments: function (e) {
                var t = window.om.getRenderable(e);
                t && t.switchSegmentMode()
            },
            share: function (e) {
                e.select(), window.om.trigger("launchTask", ["default", "overviewmap", "share"])
            },
            unhighlight: function (e) {
                window.om.unhighlight(e)
            },
            showscanpoints: function (e) {
                e._scanPointsShown ? e.hideScanPoints() : e.showScanPoints()
            },
            showdistancelabels: function (e) {
                var t = window.om.getRenderable(e);
                t && t.switchSegmentMode()
            }
        },
        error: function (e) {
            t.errorObj(e)
        }
    })
}), F.DI().registerController("overviewmap", WS.OverviewMap, "@plug", "@locale", "@unit", "@selection", "@layer", "@project", "@scan", "@overviewmapservice", "@overviewmapsettings", "@login", "@alert", "@mapobject", "@maplayer", "@url", "@domainsettings", "@scancolorizer", "@annotation", "@measurement", "@tempmeasurement", "@orthophoto", "@temporthophoto", "@point3d", "@projectdatacdn"), F.DI().registerController("worldmap", WS.WorldMap, "$filter", "@plug", "@locale", "@unit", "@project", "@url", "@login"), F.DI().registerController("mapscale", WS.MapScale, "@plug", "@overviewmapsettings", "@unit", "@scancolorizer"), F.DI().registerService("overviewmapservice", WS.OverviewMapService, "@plug", "@error", "$resource"), F.DI().registerService("overviewmapsettings", WS.OverviewMapSettingService, "@plug", "@cookie"), F.DI().registerService("mapobject", WS.MapObjectService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), F.DI().registerService("maplayer", WS.MapLayerService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), F.DI().registerService("scancolorizer", WS.ScanColorizer, "@plug", "@overviewmapsettings", "@unit", "@scan"), F.DI().config("@serializer", "@mapobject", function (e, t) {
    e.registerClass("Map", function () {
        return t.getNew()
    })
}), F.DI().config("@serializer", "@maplayer", function (e, t) {
    e.registerClass("MapLayer", function () {
        return t.getNew()
    })
}), F.DI().config("@task", WS.overviewConfigTask = function (e) {
    e.registerTaskFactory("default", "settings", "editoverviewmapsettings", WS.EditOverviewMapSettingsTask, "@plug", "@locale")
}), angular.module("ws.map").directive("overviewmap", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("overviewmap"),
        link: function (e, t) {
            var i = e.ctrl,
                n = t.find(".overviewmapdiv")[0];
            i.setContainerDiv(n), e.$on("ws_connect", function (e, t) {
                e.stopPropagation(), i.setViewModeCtrl(t)
            }), i.init()
        },
        templateUrl: WS.partialUrl("overviewmap.html")
    })
}), angular.module("ws.map").directive("mapscale", function () {
    return WS.PlugController.createDirective({
        link: function (e) {
            e.drawGradient(), e.$watch("width", function () {
                e.drawGradient()
            })
        },
        controllerClass: F.DI().getController("mapscale"),
        restrict: "E",
        scope: {
            width: "="
        },
        transclude: !0,
        template: '<div class="ws_mapScale"><span class="hidden-xs hidden-sm">{{titleAggFunc | i18n}} {{titleAggBy | i18n}}:&nbsp;&nbsp;</span><span>{{min}} </span><canvas id="mapScaleCanvas" style="vertical-align:bottom;" width="{{width}}" height="14"></canvas><span> {{max}}</span></div>'
    })
}), angular.module("ws.component").directive("wsworldmap", function () {
    var e = '<div class="worldmapdiv" style="position: relative;" tabindex="0"></div>';
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("worldmap"),
        scope: {
            display: "="
        },
        restrict: "E",
        require: "?^projectselector",
        link: function (t, i, n, r) {
            if (r && r.$scope) {
                var o = r.$scope,
                    a = t.ctrl,
                    s = i.find(".worldmapdiv");
                s.replaceWith(e), s = i.find(".worldmapdiv"), o.setWorldmap(a), a.setProjectSelector(o), a.setContainerDiv(s[0]), F.async(function () {
                    a.prepareMap(), a.addMarkerCluster()
                })
            }
        },
        template: '<a name="worldMap"></a><div class="f_box mapBox">' + e + "</div>"
    })
}), angular.module("ws.component").directive("wsworldmapdetail", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("worldmap"),
        scope: {
            display: "=",
            getProject: "&"
        },
        restrict: "E",
        require: "?^projectdetails",
        link: function (e, t, i, n) {
            if (n && n.$scope) {
                var r = e.ctrl;
                F.async(function () {
                    var i = t.find("#detailmapdiv");
                    r.setContainerDiv(i[0]), r.prepareMap(), e.$watch("getProject()", function (e) {
                        e && Q.isPromise(e) && e.then(function (e) {
                            r.getMarkerArray().forEach(function (e) {
                                r.removeMarker(e)
                            });
                            var t = document.createElement("div");
                            t.innerHTML = '<p class="f_textM f_textBold"></p>', $(t.getElementsByTagName("p")[0]).text(e._displayName);
                            var i = r.addMarker(e, t);
                            i && (i.getMarker().openPopup(), r.zoomFit())
                        })
                    }), e.$apply()
                }, this)
            }
        },
        template: '<div id="detailmapdiv" tabindex="0"></div>'
    })
}), WS.EditOverviewMapSettingsTask = function (e, t) {
    WS.Task.call(this, e), this._locale = t, this._description = [{
        caption: "TC_OVERVIEWMAP_SETTINGS",
        optional: !0,
        description: "TD_OVERVIEW_SETTINGS",
        selectPageClass: "overviewmapsettings",
        female: "ObjectEdit",
        pinBinding: "editObject(input.data)",
        widget: '<p ng-show="anyUnsavedChanges()"><b>{{"TD_CHANGES"|i18n}}:</b></p><ul><li ng-show="input.data.settings._changes._aggregation != input.data.settings._aggregation || input.data.settings._changes._scanTilesColorizeBy != input.data.settings._scanTilesColorizeBy">{{ formatColorizationChanges(input.data.settings._changes._aggregation, input.data.settings._changes._scanTilesColorizeBy) }}</li><li ng-show="input.data.settings._changes._iconMode != input.data.settings._iconMode">{{formatIconMode(input.data.settings._changes._iconMode)}}</li></li><li ng-show="input.data.settings._changes._showScanLabelsInMap !== input.data.settings._showScanLabelsInMap">{{ formatShowScanLabels(input.data.settings._changes._showScanLabelsInMap)}}</li><li ng-show="input.data.settings._changes._showPolylines !== input.data.settings._showPolylines">{{"FE_ANNOTATION" | i18n}} {{ formatShowPolylines(input.data.settings._changes._showPolylines)}}</li><li ng-show="input.data.settings._changes._showOrthoVolumes !== input.data.settings._showOrthoVolumes">{{"FE_ORTHOPHOTO" | i18n}} {{ formatShowOrthoVolumes(input.data.settings._changes._showOrthoVolumes)}}</li><li ng-repeat="layer in input.data.layers" ng-show="layer.hasUnsavedChanges()">{{layer.getName() | i18n}}<ul><li ng-show="layer._changes._visible != layer._visible">{{formatLayerVisibilityOutput(layer._changes._visible)}}</li></ul></li></ul>',
        icon: WS.Icons.TaskSection.configure
    }]
}, WS.EditOverviewMapSettingsTask.prototype = {
    setup: function (e) {
        var t = this;
        e.anyUnsavedChanges = function () {
            var t = e.input ? e.input.data : void 0,
                i = t ? t.layers : void 0,
                n = t ? t.settings : void 0;
            if (i)
                for (var r = 0, o = i.length; o > r; r++)
                    if (i[r].hasUnsavedChanges()) return !0;
            return n && n.hasUnsavedChanges() ? !0 : !1
        }, e.formatColorizationChanges = function (e, i) {
            if (void 0 === e && void 0 === i) return "";
            var n = "";
            switch (i + " " + e) {
                case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT + " " + WS.OverviewMapSettings.AGG_AVG:
                    n = t._locale.translate("FE_COLOR_HEIGHT_AVG");
                    break;
                case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT + " " + WS.OverviewMapSettings.AGG_MAX:
                    n = t._locale.translate("FE_COLOR_HEIGHT_MAX");
                    break;
                case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT + " " + WS.OverviewMapSettings.AGG_MIN:
                    n = t._locale.translate("FE_COLOR_HEIGHT_MIN");
                    break;
                case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT + " " + WS.OverviewMapSettings.AGG_INDIVIDUAL:
                    n = t._locale.translate("FE_COLOR_HEIGHT_INDIV");
                    break;
                case WS.OverviewMapSettings.COLORIZE_BY_AGE + " " + WS.OverviewMapSettings.AGG_AVG:
                    n = t._locale.translate("FE_COLOR_AGE_AVG");
                    break;
                case WS.OverviewMapSettings.COLORIZE_BY_AGE + " " + WS.OverviewMapSettings.AGG_MAX:
                    n = t._locale.translate("FE_COLOR_AGE_MAX");
                    break;
                case WS.OverviewMapSettings.COLORIZE_BY_AGE + " " + WS.OverviewMapSettings.AGG_MIN:
                    n = t._locale.translate("FE_COLOR_AGE_MIN");
                    break;
                case WS.OverviewMapSettings.COLORIZE_BY_AGE + " " + WS.OverviewMapSettings.AGG_INDIVIDUAL:
                    n = t._locale.translate("FE_COLOR_AGE_INDIV")
            }
            return t._locale.translate("FE_SCAN_COLORIZATION") + ": " + n
        }, e.formatLayerVisibilityOutput = function (e) {
            return void 0 === e ? "" : t._locale.translate(e ? "FE_VISBLE" : "FE_INVISBLE")
        }, e.formatIconMode = function (e) {
            return void 0 === e ? "" : t._locale.translateAndCompose("FE_ICONMODE_CHANGE", [t._locale.translate(WS.OverviewMapSettings.IconModeNames[e])])
        }, e.formatShowScanLabels = function (e) {
            if (void 0 === e) return "";
            var i = t._locale.translate("FE_SCAN_NAME"),
                n = t._locale.translate(e ? "FE_ENABLED" : "FE_DISABLED");
            return i + ": " + n
        }, e.formatShowOrthoVolumes = function (e) {
            var i = t._locale.translate("FE_VOLUME"),
                n = t._locale.translate(e ? "FE_VISBLE" : "FE_INVISBLE");
            return i + ": " + n
        }, e.formatShowPolylines = function (e) {
            var i = t._locale.translate("AN_AREA"),
                n = t._locale.translate(e ? "FE_VISBLE" : "FE_INVISBLE");
            return i + ": " + n
        }
    },
    execute: function (e) {
        var t = Q.defer(),
            i = e ? e.data : void 0,
            n = i ? i.layers : void 0,
            r = i ? i.settings : void 0;
        if (n)
            for (var o = 0, a = n.length; a > o; o++) n[o].update();
        return r && (r._changes && r._changes._iconMode && (r._changes._iconMode = parseInt(r._changes._iconMode)), r.update()), t.resolve(), t.promise
    },
    teardown: function () {
        this._result._navigateTo = this._argument._lastPage
    },
    queryTaskLaunch: function (e, t, i) {
        return e == this._panel && t == this._category.id && i == this._id
    }
}, WS.extend("EditOverviewMapSettingsTask", "Task"), WS.ScannerCircleImageRenderable = function () {
    var e = new WS.Geometry;
    e._positionBuffer = WS.ScannerCircleImageRenderable.PositionBuffer, e._primitiveType = WS.Geometry.PrimitiveType.TriangleStrip;
    var t = WS.ScannerCircleImageRenderable.CoordBuffer,
        i = new WS.TextureMaterial(WS.ScannerCircleImageRenderable.Image, t);
    WS.Mesh.call(this, e, i), this.addToLayer(WS.Layer.LayerIDs.PANO)
}, WS.ScannerCircleImageRenderable.prototype = {
    draw2d: function () {
    },
    onViewingModeChange: function () {
        switch (this._viewingMode) {
            case WS.Renderable.ViewingMode.Selected:
                this._material.setTextureImages([WS.ScannerCircleImageRenderable.ImageActive]);
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
            case WS.Renderable.ViewingMode.Normal:
            case WS.Renderable.ViewingMode.Highlighted:
                this._material.setTextureImages([WS.ScannerCircleImageRenderable.Image])
        }
    }
}, WS.extend("ScannerCircleImageRenderable", "Mesh"), WS.ScannerCircleImageRenderable.Image = new WS.Image(WS.imgUrlCanvasSafe("assets/websharecloud.png")), WS.ScannerCircleImageRenderable.ImageActive = new WS.Image(WS.imgUrlCanvasSafe("assets/websharecloud_active.jpg")), WS.ScannerCircleImageRenderable.PositionBuffer = new WS.ArrayBuffer([-1, -1, -1.5, -1, 1, -1.5, 1, -1, -1.5, 1, 1, -1.5], 3), WS.ScannerCircleImageRenderable.CoordBuffer = new WS.ArrayBuffer([0, 0, 0, 1, 1, 0, 1, 1], 2), WS.ViewModeCtrl = function (e, t, i, n) {
    F.PlugController.call(this, e, n), this.$scope = e, this._pointCloud = t, this._panoSettings = i, e.config = {
        menu: !1
    }, e.ViewMode = WS.PanoramaView.ViewMode, e.pointClouds = [], e.viewMode = void 0, e.current = void 0, e.targetViewMode = e.viewMode, e.viewModeTransition = WS.PanoramaView.Transition.NONE, e.isSimple3dEnabled = !1, e.webGLEnabled = i.isWebGlEnabled(), e.hasPano = !1, e.toggle = function () {
        switch (e.viewMode) {
            case WS.OverviewMap.ViewMode.MAP:
                e.changeViewMode({
                    newMode: {
                        view: "3d"
                    }
                });
                break;
            case WS.PanoramaView.ViewMode.PANO:
                e.changeViewMode({
                    newMode: {
                        view: "3d"
                    }
                });
                break;
            case WS.PanoramaView.ViewMode.POINTS:
                e.hasPano ? e.changeViewMode({
                    newMode: {
                        view: "pano"
                    }
                }) : e.config.menu = !0
        }
    }, e.pick = function (t) {
        e.changeViewMode("pano" === t ? {
            newMode: {
                view: "pano"
            }
        } : {
            newMode: {
                view: "3d",
                pointCloud: t
            }
        })
    }, e.hasAlternative = function () {
        switch (e.viewMode) {
            case WS.OverviewMap.ViewMode.MAP:
                return e.webGLEnabled && e.pointClouds.length > 0;
            case WS.PanoramaView.ViewMode.PANO:
                return e.webGLEnabled && (e.pointClouds.length > 0 || e.isSimple3dEnabled);
            case WS.PanoramaView.ViewMode.POINTS:
                return e.hasPano || e.pointClouds.length > 1
        }
    }, e.toggleTitle = function () {
        if (!e.webGLEnabled) return "FE_NEED_WEBGL_FOR_3D";
        if (e.viewModeTransition) return "EM_3D_LOAD";
        switch (e.viewMode) {
            case WS.OverviewMap.ViewMode.MAP:
                return e.pointClouds.length > 0 ? "FE_GO_3D" : "EM_3D_NA";
            case WS.PanoramaView.ViewMode.PANO:
                return e.pointClouds.length > 0 ? "FE_GO_3D" : "EM_3D_NA";
            case WS.PanoramaView.ViewMode.POINTS:
                return e.hasPano ? "FE_GO_PANO" : "EM_PANO_NA"
        }
    }, e.is3d = function () {
        return e.viewMode === WS.PanoramaView.ViewMode.POINTS
    }, this.provideFemalePlug("SettingsUpdate", ["updateSettings"]), this.connect(this, i)
}, WS.ViewModeCtrl.prototype = {
    update: function (e) {
        this.currentRoot(e);
        var t = this;
        this.reset(), this._pointCloud.getAllEnabledCompleted().then(function (e) {
            t.pointClouds(e)
        }), this._pointCloud.isSimple3dEnabled().then(function (e) {
            t.simple3dEnabled(e)
        })
    },
    updateSettings: function () {
        this.$scope.webGLEnabled = this._panoSettings.isWebGlEnabled()
    },
    simple3dEnabled: function (e, t) {
        return void 0 !== e && (this.$scope.isSimple3dEnabled = e, t !== !1 && this.$scope.$apply()), this.$scope.isSimple3dEnabled
    },
    hasPano: function (e, t) {
        return void 0 !== e && (this.$scope.hasPano = e, t !== !1 && this.$scope.$apply()), this.$scope.hasPano
    },
    pointClouds: function (e, t) {
        return void 0 !== e && (this.$scope.pointClouds = e.sort(function (e, t) {
            var i = e._creationTime,
                n = t._creationTime;
            return n > i ? 1 : i > n ? -1 : 0
        }), t !== !1 && this.$scope.$apply()), this.$scope.pointClouds
    },
    viewMode: function (e, t) {
        return void 0 !== e && (this.$scope.viewMode = e, t !== !1 && this.$scope.$apply()), this.$scope.viewMode
    },
    targetViewMode: function (e, t) {
        return void 0 !== e && (this.$scope.targetViewMode = e, t !== !1 && this.$scope.$apply()), this.$scope.targetViewMode
    },
    viewModeTransition: function (e, t) {
        return void 0 !== e && (this.$scope.viewModeTransition = e, t !== !1 && this.$scope.$apply()), this.$scope.viewModeTransition
    },
    currentRoot: function (e) {
        return void 0 !== e && (this.$scope.currentRoot = e), this.$scope.currentRoot
    },
    reset: function () {
        this.$scope.pointClouds = [], this.$scope.isSimple3dEnabled = !1
    },
    $apply: function () {
        this.$scope.$apply()
    }
}, WS.extend("ViewModeCtrl", "PlugController"), WS.PanoramaView = function (e, t, i, n, r, o, a, s, c, l, h, d, u, _, p, g, f, m, v, S, b, y) {
    WS.View3d.call(this, e, t, i);
    var P = this;
    window.pv = this, this._type = WS.PanoramaView.type, this._selection = n, this._alert = r, this._project = o, this._scanService = a, this._annotationService = s, this._measurementService = c, this._tempMeasurementService = l, this._orthophoto = h, this._tempOrthophoto = d, this._settingService = u, this._domainSettings = _, this._loginService = p, this._unit = g, this._distance = f, this._locale = m, this._point3dService = v, this._layer = S, this._mapObjectService = b, this._pointCloudService = y, this._cameraAnimator = new WS.CameraAnimator, this._blender = new WS.Blender, this._inScanOrigin = void 0, this._root = void 0, this._promise = void 0, this._promiseTransitionD = void 0, this._promiseCamAnimD = void 0, this._settingsLoaded = !1, this.createScope(e), this._fsm = e.fsm = this.createFiniteStateMachine(), this._scene = new WS.Scene, this._renderObjects = !0, this._panoRenderable = void 0, this._skybox = void 0, this._pointsRenderable = void 0, this._rootRenderable = void 0, this._prevRenderable = void 0, this._prevPanoRenderable = void 0, this._prevScanCloudRenderable = void 0, this._prevPointCloudRenderable = void 0, this._rootIsScanCloud = !1, this._rootIsSameObject = !1, this._linesRenderable = void 0, this._lineAreaEnd = void 0, this._progressSpinner = new WS.SpinnerRenderable("loading", [200, 200]), this._bearingVisualizer = new WS.CompassRenderable, this._moveHandler = void 0, this._camera = new WS.PerspectiveCamera, this._prevCameraValuesForUrl = {
        angles: this._camera.getAnglesForCenter(),
        pos: this.getCamGlobalPos(),
        fovY: this._camera._fovY
    }, this._cameraIsInitialized = !1, this._replaceURL = void 0, this._isCollecting = !1, this._objects = {
        scan: {
            service: this._scanService,
            selection: n.getSelection("Scan"),
            entities: []
        },
        annotation: {
            service: this._annotationService,
            selection: n.getSelection("Annotation"),
            entities: []
        },
        measurement: {
            service: this._measurementService,
            selection: n.getSelection("Measurement"),
            entities: []
        },
        tempmeasurement: {
            service: this._tempMeasurementService,
            selection: n.getSelection("TempMeasurement"),
            entities: []
        },
        orthophoto: {
            service: this._orthophoto,
            selection: n.getSelection("Orthophoto"),
            entities: []
        },
        temporthophoto: {
            service: this._tempOrthophoto,
            entities: []
        },
        point3d: {
            entities: []
        },
        wspointcloud: {
            service: this._pointCloudService,
            entities: []
        }
    }, this.provideMalePlug("ObjectShow", ["showObjects"]), this.provideMalePlug("ViewFocus", ["focusOn"]), this.provideMalePlug("PointPick3D", ["pickPoint"]), this.provideMalePlug("SceneRootChange", ["sceneRootChange"]), this.provideMalePlug("TaskLaunch", ["launchTask"]), this.provideFemalePlug("ViewMode", ["setMode"]), this.provideFemalePlug("ObjectShow", ["showObjects"]), this.provideFemalePlug("ViewFocus", ["focusOn"]), this.provideFemalePlug("ObjectUpdate", ["updateObjects"]), this.provideFemalePlug("SettingsUpdate", ["updateSettings"]), this.provideFemalePlug("CameraChanged", ["onCameraChange"]), this.provideFemalePlug("MeasurementSelect", ["select", "unselect"]), this.provideFemalePlug("TempMeasurementSelect", ["select", "unselect"]), this.provideFemalePlug("OrthophotoSelect", ["select", "unselect"]), this.provideFemalePlug("AnnotationSelect", ["select", "unselect"]), this.provideFemalePlug("ScanSelect", ["select", "unselect"]), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.provideFemalePlug("PointPick3DControl", ["setPickedPoints"]), [this._annotationService, this._measurementService, this._scanService, this._tempMeasurementService, this._orthophoto, this._tempOrthophoto, this._domainSettings, this._pointCloudService].forEach(function (e) {
        P._connectorService.connect(P, e)
    }), ["Scan", "Annotation", "Measurement", "TempMeasurement", "Orthophoto"].forEach(function (e) {
        P._connectorService.connect(P, n.getSelection(e))
    }), this._connectorService.connect(this, this._point3dService), this._connectorService.connect(this, this._unit), this._connectorService.connect(this, this._locale), this._connectorService.connect(this, this._settingService), this._connectorService.connect(this, this._loginService), o.subscribe("change", this.changeProjectSync.bind(this)), this.loadSettings()
},
WS.PanoramaView.prototype = {
    createScope: function (e) {
        var t = this;
        e.root = void 0, e.error = void 0, e.loadStarted = !1, e.getPromise = function () {
            return t._promise
        }, e.changeViewMode = function (e) {
            "3d" === e.view ? e.pointCloud ? t.load({
                root: e.pointCloud,
                rootType: "pointcloud",
                camPos: "keep"
            }, "3d") : t.load({
                root: t._root,
                rootType: void 0,
                camPos: "keep"
            }, "3d") : "pano" === e.view && t.load({
                closestTo: t.getCamGlobalPos()
            }, "panorama")
        }, e.hasMap = void 0, e.panoImageResolution = "", e.panoImagePaths = void 0, e.pickedPoint = void 0, e.pickedDistance = void 0, e.flashPicker = !1, e.pointStates = WS.Point3d.PointState, e.menu = {
            object: void 0,
            visible: !1,
            x: "0px",
            y: "0px"
        }, e.page = {
            actionBarActive: !1,
            visibilityCtrlActive: !1,
            select3dCtrlActive: !1,
            loading: !1
        }, e.joystick = {
            visible: !1,
            wasVisible: !1,
            hUpper: 0,
            hLower: 0,
            xButton: 0,
            yButton: 0,
            xTop: 0,
            yTop: 0,
            xUpper: 0,
            yUpper: 0,
            xMiddle: 0,
            yMiddle: 0,
            xLower: 0,
            yLower: 0,
            xBottom: 0,
            yBottom: 0
        }, e.settings = void 0, e.logoUrl = void 0, e.logoOpacity = void 0, e.toggleColorMode = function () {
            if ((t.isRootScan() || t.isRootScanCloud()) && t._viewModeCtrl.viewModeTransition() === WS.PanoramaView.Transition.NONE) {
                var e = t.$scope.settings;
                switch (e._colorMode) {
                    case "blend":
                        t._root.arePanoImagesAvailableForMode("color") || t._alert.tip("FE_NO_SUCH_COLORMODE"), e._colorMode = "color";
                        break;
                    case "color":
                        t._root.arePanoImagesAvailableForMode("gray") || t._alert.tip("FE_NO_SUCH_COLORMODE"), e._colorMode = "gray";
                        break;
                    case "gray":
                        t._root.arePanoImagesAvailableForMode("blend") || t._alert.tip("FE_NO_SUCH_COLORMODE"), e._colorMode = "blend"
                }
                t._settingService.update(e)
            }
        }, e.changeBlendFactor = function (e) {
            var i = t.$scope.settings,
                n = i._blendFactor,
                r = n + e;
            r = Math.round(10 * r) / 10, r.toFixed(1), r > .9 ? r = .9 : .1 > r && (r = .1), i._blendFactor = r, t._settingService.update(i)
        }, e.toggleCompassOnOff = function () {
            var e = t.$scope.settings;
            e._showCompass = !e._showCompass, t._settingService.update(e)
        }, e.isRootPointCloud = function () {
            return t.isRootPointCloud()
        }, e.isRootProjectPointCloud = function () {
            return t.isRootProjectPointCloud()
        }, e.rootName = "", e.scanRecordingTime = "1970-01-01 00:00:00", e.project = void 0, e.showMap = function () {
            var e = {
                lookAt: t.getCamGlobalPos(),
                miniView: !0
            };
            t.trigger("focusOn", [e, "map"])
        }, e.showProperties = function () {
            t.isRootScanOrScanCloud() ? t.trigger("showObjects", [
                [t._root], "properties"
            ]) : t.isRootScanPointCloud() ? t._scanService.getByID(t._root._sourceUUIDs[0]).then(function (e) {
                t.trigger("showObjects", [
                    [e], "properties"
                ])
            }) : t.isRootProjectPointCloud() && t._project.getCurrentProject().then(function (e) {
                t.trigger("showObjects", [
                    [e], "projectdetails"
                ])
            })
        }, e.getPosInCS = function (i) {
            return e.project && e.project._trafo && t._unit.isCustomCS() ? mat4.posInRefSystem(i, e.project._trafo) : i
        }, e.dbgStats = {
            show: !1
        }
    },
    setViewModeCtrl: function (e) {
        this._viewModeCtrl = e, this._viewModeCtrlD.resolve(e)
    },
    createFiniteStateMachine: function () {
        return new F.FiniteStateMachine({
            "void": {
                load: "loading",
                delay: "pending",
                reset: "void"
            },
            loading: {
                show: "free",
                focusobject: "highlight",
                focusxyz: "xyz",
                delay: "pending",
                reset: "void"
            },
            pending: {
                load: "loading",
                reset: "void"
            },
            free: {
                load: "loading",
                delay: "pending",
                reset: "void"
            },
            highlight: {
                load: "loading",
                delay: "pending",
                move: "free",
                reset: "void"
            },
            xyz: {
                load: "loading",
                move: "free",
                reset: "void"
            }
        }, "void")
    },
    isCameraInitialized: function () {
        return this._cameraIsInitialized
    },
    createRenderers: function () {
        var e, t = this._canvasList;
        if (this._settingService.isWebGlEnabled()) {
            var i = !1,
                n = F.proxy(function () {
                    i || (i = !0, this.disableWebGL())
                }, this);
            e = F.getGLContext(t[0]), this._renderer[0] = new WS.Renderer3D(e, [0, 1, 2, 3], this, n), this._renderer[0].updateDetailLevel(this._settingService.details3d()), e = t[2].getContext("2d"), this._renderer[1] = new WS.Renderer2D(e, [4], this), this._renderer[0].setClearColor([0, 0, 0, 0]), this._renderer[1].setClearColor([0, 0, 0, 0]), this._renderMode = WS.View3d.RenderMode.WebGl
        } else e = t[0].getContext("2d"), this._renderer[0] = new WS.Renderer2D(e, [0, 1], this), e = t[1].getContext("2d"), this._renderer[1] = new WS.Renderer2D(e, [2, 3], this), e = t[2].getContext("2d"), this._renderer[2] = new WS.Renderer2D(e, [4], this), this._renderer[0].setClearColor([1, 1, 1, 1]), this._renderer[1].setClearColor([0, 0, 0, 0]), this._renderer[2].setClearColor([0, 0, 0, 0]), this._renderMode = WS.View3d.RenderMode.Canvas
    },
    getGLExtension: function (e) {
        var t = this._renderer[0]._ctx;
        return !!F.getGLExtension(t, e)
    },
    init: function () {
    },
    changeProjectSync: function () {
        var e = this,
            t = this.$scope;
        this.reset(), this._viewModeCtrlD.promise.then(function () {
            e.getViewTrafo(), e._project.getCurrentProject().then(function (i) {
                t.project = i, e._viewModeCtrl.hasPano(i.hasScan()), t.hasMap = i.hasOverviewMap()
            }, function () {
                t.project = void 0, t.hasMap = !1
            })
        })
    },
    reset: function () {
        this.deactivateHandlerStack(), this.unloadPreviousRenderables(), this.unloadRootRenderable(), this.unloadAndRemoveSkybox(), this.removeAllObjects(), this.resetRenderers(), this.resetScope(), this.resetMembers(), this._fsm.read("reset"), this._fsm._meta.rollback = "reset", this.trigger("sceneRootChange", [void 0, this])
    },
    unloadPreviousRenderables: function () {
        this._prevScanCloudRenderable && (this.deactivateSpecialRenderable(this._prevScanCloudRenderable), this.unloadSpecialRenderable(this._prevScanCloudRenderable)), this._prevPointCloudRenderable && (this.deactivateSpecialRenderable(this._prevPointCloudRenderable), this.unloadSpecialRenderable(this._prevPointCloudRenderable)), this._prevPanoRenderable && (this.deactivateSpecialRenderable(this._prevPanoRenderable), this.unloadSpecialRenderable(this._prevPanoRenderable))
    },
    unloadRootRenderable: function () {
        this._rootRenderable && (this.deactivateSpecialRenderable(this._rootRenderable), this.unloadSpecialRenderable(this._rootRenderable))
    },
    unloadAndRemoveSkybox: function () {
        this._skybox && (this.deactivateSpecialRenderable(this._skybox), this.unloadSpecialRenderable(this._skybox), this.removeRenderable(this._skybox, this._skybox._UUID))
    },
    resetRenderers: function () {
        this._renderer && this._renderer.forEach(function (e) {
            e.clearStorage()
        })
    },
    resetScope: function () {
        var e = this.$scope;
        e.root = void 0, e.error = void 0, e.loadStarted = !1, e.panoImagePaths = void 0, e.panoImageResolution = "", e.pickedPoint = void 0, e.pickedDistance = void 0, e.menu.object = void 0, e.menu.visible = !1, e.menu.x = "0px", e.menu.y = "0px", e.page.actionBarActive = !1, e.page.visibilityCtrlActive = !1, e.page.select3dCtrlActive = !1, e.page.loading = !1, e.joystick.visible = !1, e.hasMap = void 0, e.rootName = "", e.scanRecordingTime = "1970-01-01 00:00:00";
        var t = this._viewModeCtrl;
        t && (t.reset(), t.viewModeTransition(WS.PanoramaView.Transition.NONE, !1), t.viewMode(WS.PanoramaView.ViewMode.PANO, !1), t.targetViewMode(t.viewMode(), !1), t.hasPano(!1, !1), F.async(t.$apply, t)), F.async(e.$apply, e)
    },
    resetMembers: function () {
        this._mode = void 0, this._modeToHandlerStack = void 0, this._activeHandlerStack = void 0, this._renderableMap = {}, this._width = void 0, this._height = void 0, this._cameraIdleCount = 0, this._isMoving = 0, this._trafoView = void 0, this._init = !1, this._render = !1, this._isRendering = !1, this._hlObject = void 0, this._cameraAnimator.reset(), this._blender.reset(), this._inScanOrigin = void 0, this._root = void 0, this._promise = void 0, this._promiseTransitionD = void 0, this._promiseCamAnimD = void 0, this._settingsLoaded = !1, this._panoRenderable = void 0, this._skybox = void 0, this._pointsRenderable = void 0, this._rootRenderable = void 0, this._prevRenderable = void 0, this._prevPanoRenderable = void 0, this._prevScanCloudRenderable = void 0, this._prevPointCloudRenderable = void 0, this._rootIsScanCloud = !1, this._rootIsSameObject = !1, this._linesRenderable = void 0, this._lineAreaEnd = void 0, this._renderObjects = !0, this._moveHandler = void 0, this._point3dService._point3d = void 0, this._replaceURL = void 0, this._scanService._rootScan = void 0
    },
    getViewTrafo: function () {
        var e = this;
        return this._trafoView && !this._trafoView._isFallback ? Q.resolve(!0) : this._project.getCurrentProject().then(function (t) {
            return t._type === WS.Project.Type.INC ? e._pointCloudService.getAll().then(function (t) {
                var i = mat4.identity();
                return t[0] && mat4.setTranslation(i, t[0].getTranslationGlobal()), i._isFallback = !t[0], e._trafoView = i, !0
            }) : e._mapObjectService.getAll().then(function (t) {
                if (!(t && t[0] instanceof WS.MapObject)) throw new Error("EXCEPTION_MESSAGE_FIND_OBJECT");
                var i = mat4.identity();
                return mat4.setTranslation(i, t[0].getTranslationGlobal()), i._isFallback = !1, e._trafoView = i, !0
            })
        })
    },
    showObjects: function (e, t, i) {
        if (("panorama" === t || "3d" === t || "pano/3d" === t) && (!(e.length > 0) || e[0] instanceof WS.Scan || e[0] instanceof WS.PointCloud)) {
            var n = this;
            this._tempOrthophoto.getAll().then(function (r) {
                var o = r[0] && r[0]._focusable ? r[0] : void 0;
                n.load({
                    root: e[0],
                    focus: o,
                    miniView: i && i.miniView
                }, t)
            }, function () {
                n.load({
                    root: e[0],
                    miniView: i && i.miniView
                }, t)
            }).done()
        }
    },
    focusOn: function (e, t) {
        if ("pano/3d" === t && (t = this.isRootCloud() ? "3d" : "panorama"), "panorama" === t || "3d" === t) {
            var i = {
                root: e.root,
                rootType: e.rootType,
                focus: e.object,
                lookAt: e.lookAt,
                camPos: e.camPos,
                camFov: e.camFov,
                picker: e.picker,
                miniView: e.miniView
            };
            this.load(i, t)
        }
    },
    load: function (e, t) {

        var i = this;
        if ("panorama" === t || "3d" === t || "pano/3d" === t) {
            if (!this._viewModeCtrl) return void this._viewModeCtrlD.promise.then(this.load.bind(this, e, t));
            var n = void 0 !== e.miniView ? e.miniView : this.miniView() || !1,
                r = this.getPageBox();
            if (r && r.isCollecting() && this.changePage({
                    miniView: n
                }), n || this.launchTask("default", "panoramaview", void 0, void 0, {
                    noNavigation: !0
                }), "loading" === this._fsm._state || this._viewModeCtrl.viewModeTransition() !== WS.PanoramaView.Transition.NONE) return void this._alert.error(this._viewModeCtrl.targetViewMode() === WS.PanoramaView.ViewMode.POINTS ? "EM_3D_LOAD" : "EM_SCAN_LOAD");
            this.$scope.loadStarted = !0, this._project.getCurrentProject().then(function (n) {
                var r;
                if ("pano/3d" === t && (i._root ? t = i._viewModeCtrl.targetViewMode() === WS.PanoramaView.ViewMode.POINTS ? "3d" : "panorama" : F.isMobile() && n.hasScan() ? t = "panorama" : n._enable3D && n.hasPointCloud() ? i._settingService.isWebGlEnabled() ? t = "3d" : n.hasScan() ? t = "panorama" : r = "FE_NEED_WEBGL_FOR_3D" : n.hasScan() ? t = "panorama" : r = "EM_3D_NA"), "3d" === t && (n._enable3D ? i._settingService.isWebGlEnabled() || (r = "FE_NEED_WEBGL_FOR_3D") : r = "EM_3D_NA_EXTENDED"), r) {
                    var o = new Error(r);
                    return i._promise = Q.reject(o), i.$scope.error = o, void F.handled(o)
                }
                i._replaceURL = !!e.replaceURL, i._isCollecting = !0, i._url.collect(), i._fsm.read("load"), i._fsm._meta.rollback = "reset";
                var a = !i._init;
                i._promiseTransitionD = Q.defer(), i.setLoadPromise(t, e), i._promiseTransitionD.promise.then(function () {
                    i._cameraAnimator.isAnimating() && i._cameraAnimator.reset(), e.updateSettings instanceof WS.PanoSettings && i.updateSceneForUpdateSettings(e.updateSettings);
                    var n = i.determineCameraLookPosOrAngle(e, t),
                        r = i.determineCameraTargetPos(e, t, n),
                        o = i.setCameraAfterLoad(e, t, r, n, a);
                    i.setCoordinatePickerAfterLoad(e, n), i._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.ANIMATING), i.updateFSMAfterLoad(e, n, o)
                }, function (e) {
                    i._fsm.read(i._fsm._meta.rollback), i._isCollecting && (i._url.commit(), i._isCollecting = !1), i._promise = Q.reject(e), i.$scope.$apply(function (t) {
                        t.error = e
                    }), F.handled(e)
                }).done()
            }, function (e) {
                i._fsm.read("reset"), i._isCollecting && (i._url.commit(), i._isCollecting = !1), i._promise = Q.reject(e), i.$scope.$apply(function (t) {
                    t.error = e
                }), F.handled(e)
            })
        }
    },
    determineCameraLookPosOrAngle: function (e) {
        var t = {
            lookPos: e.lookAt,
            angle: e.angle
        };
        if (!t.lookPos) {
            var i = e.focus;
            if (i)
                if (i instanceof WS.TempOrthophoto) t.lookPos = i.getVolumeCenterGlobal();
                else if (i instanceof WS.Orthophoto) t.lookPos = this.$scope.settings._showOrthoVolumes ? i.getVolumeCenterGlobal() : i.getImageCenterGlobal();
                else if (i instanceof WS.Measurement || i instanceof WS.Annotation && i.isPolyline() && this.$scope.settings._showPolylines) {
                    var n = i.getBoundingBox();
                    t.lookPos = n.getCenter()
                } else i instanceof WS.Scan ? i instanceof WS.Scan && void 0 === e.angle && 0 !== this._camera.isLookingAtPole() && (t.angle = [this._camera.getPhi(), 0]) : t.lookPos = i.getTranslationGlobal();
            else this.isRootBasedOnScan() && void 0 === e.angle && 0 !== this._camera.isLookingAtPole() && (t.angle = [this._camera.getPhi(), 0])
        }
        return t
    },
    determineCameraTargetPos: function (e, t, i) {
        var n = e.focus,
            r = e.camPos;
        if ("keep" === r ? r = this.getCamGlobalPos() : "panorama" === t && (r = this._root.getTranslationGlobal()), !r) {
            var o, a, s, c;
            if (i.lookPos)
                if (n instanceof WS.Measurement || n instanceof WS.Annotation && n.isPolyline() && this.$scope.settings._showPolylines) {
                    c = n.getBoundingBox(), o = Math.max(2.5, this._camera.calcViewingDistance(.75 * c.getLongestLength(), .75 * c.getLongestLength()));
                    var l = n.determineOrientation();
                    r = "y-" === l ? vec3.add(c.getCenter(), [-o, -o, o], vec3.create()) : vec3.add(c.getCenter(), [o, -o, o], vec3.create())
                } else if (n instanceof WS.TempOrthophoto) {
                    var h;
                    n.isHorizontal() ? (o = n.getHeightInMeter() / 2 + this._camera.calcViewingDistance(n.getWidthInMeter(), n.getDepthInMeter()) + 5, h = [0, o, 0]) : (o = n.getDepthInMeter() / 2 + this._camera.calcViewingDistance(n.getWidthInMeter(), n.getHeightInMeter()) + 5, h = [0, 0, -o]), a = mat4.toMat3(n._trafoGlobal), s = mat3.multiplyVec3(a, h, vec3.create()), r = vec3.add(i.lookPos, s, vec3.create())
                } else if (n instanceof WS.Orthophoto) {
                    var d = this.$scope.settings._showOrthoVolumes ? n.getDepthInMeter() : 0;
                    if (o = d / 2 + this._camera.calcViewingDistance(n.getWidthInMeter(), n.getHeightInMeter()) + 5, a = mat4.toMat3(n._trafoGlobal), s = mat3.multiplyVec3(a, [0, 0, -o], vec3.create()), n.isHorizontal()) {
                        var u, _, p = n.getImageCornersGlobal(),
                            g = (p[1][1] - p[0][1]) / (p[1][0] - p[0][0]),
                            f = Math.abs(Math.atan(g));
                        p[1][0] <= p[0][0] && g >= 0 ? (u = -1, _ = 1) : p[1][0] <= p[0][0] && 0 > g ? (u = 1, _ = 1) : p[0][0] < p[1][0] && g >= 0 ? (u = 1, _ = -1) : (u = -1, _ = -1), s[0] += .001 * u * Math.sin(f), s[1] += .001 * _ * Math.cos(f)
                    }
                    r = vec3.add(i.lookPos, s, vec3.create())
                } else r = vec3.add(i.lookPos, [2.5, -2.5, 2.5], vec3.create());
            else {
                var m = e.root;
                if (m instanceof WS.Scan || m instanceof WS.PointCloud && "Scan" === m._type) r = m.getTranslationGlobal();
                else {
                    var v = this._root.calcDefaultCamera();
                    r = v.camPos, i.lookPos = v.lookAt, i.angle = void 0
                }
            }
        }
        return r
    },
    setCameraAfterLoad: function (e, t, i, n, r) {
        if ("panorama" !== t || vec3.equal(this.getCamGlobalPos(), i) || this._camera.setFromGlobalPos(i, this._trafoView), this._cameraIsInitialized = !0, r) return e.camFov && this._camera.setFOVY(e.camFov), "panorama" !== t && this._camera.setFromGlobalPos(i, this._trafoView), e.lookAt ? this._camera.lookAt(n.lookPos, this._trafoView) : e.angle ? (this._camera.setPhi(n.angle[0]), this._camera.setTheta(n.angle[1])) : n.lookPos ? this._camera.lookAt(n.lookPos, this._trafoView) : n.angle && (this._camera.setPhi(n.angle[0]), this._camera.setTheta(n.angle[1])), this._camera;
        var o = new WS.PerspectiveCamera;
        return o.copyFrom(this._camera), e.camFov && o.setFOVY(e.camFov), "panorama" !== t && o.setFromGlobalPos(i, this._trafoView), e.lookAt ? o.lookAt(n.lookPos, this._trafoView) : e.angle ? (o.setPhi(n.angle[0]), o.setTheta(n.angle[1])) : n.lookPos ? o.lookAt(n.lookPos, this._trafoView) : n.angle && (o.setPhi(n.angle[0]), o.setTheta(n.angle[1])), this.setCameraByTargetCam(e, o), o
    },
    setCameraByTargetCam: function (e, t) {
        var i = this,
            n = this.getCamGlobalPos(),
            r = this._camera.getPhi(),
            o = this._camera.getTheta(),
            a = this._camera._fovY,
            s = t.getGlobalPos(this._trafoView),
            c = t.getPhi(),
            l = t.getTheta(),
            h = t._fovY;
        if (!vec3.equal(n, s) || r !== c || o !== l || a !== h) {
            var d = this._cameraAnimator.calcGoodDuration(n, s, r, c, o, l, a, h);
            if (e.doNotAnimate || 0 === d) {
                var u = this._camera._dirty;
                this._camera.setFromGlobalPos(s, this._trafoView), this._camera.setPhi(c), this._camera.setTheta(l), this._camera.setFOVY(h), this._camera._dirty = u
            } else if (this.isRendering()) this._cameraAnimator.startAnimation(this._camera, d, this._trafoView, s, c, l, h);
            else {
                this._promiseCamAnimD = Q.defer();
                var _ = this._promiseCamAnimD.promise;
                _.then(function () {
                    i._cameraAnimator.startAnimation(i._camera, d, i._trafoView, s, c, l, h), i._promiseCamAnimD = void 0
                })
            }
        }
    },
    setCoordinatePickerAfterLoad: function (e, t) {
        if (e.lookAt && !e.focus && e.picker !== !1) {
            var i = new WS.Point3d([0, 0, 0], [0, 0], this._root, this);
            i._positionGlobal = vec3.create(t.lookPos);
            var n = i.calcPositionInRefSystem(this._trafoView);
            i._estimatedPosition = vec3.create(n), i._positionLocal = vec3.create(n), i._pointState = WS.Point3d.PointState.Free, this._point3dService.setPoint(i)
        }
    },
    updateFSMAfterLoad: function (e, t) {
        var i = e.focus,
            n = e.lookAt;
        i ? (this.highlight(i), this._fsm.read("focusobject"), this._fsm._meta.focus = {
            object: i,
            lookPos: void 0 !== n ? t.lookPos : void 0
        }) : n ? (this._fsm.read("focusxyz"), this._fsm._meta.focus = {
            lookPos: t.lookPos
        }) : this._fsm.read("show")
    },
    setLoadPromise: function (e, t) {
        var i = this;
        i.getViewTrafo().then(function () {
            var n;
            n = "string" == typeof t.focus ? i.getObject(t.focus, t.focusType) : Q.resolve(t.focus instanceof F.CRUDObject ? t.focus : void 0), n.then(function (n) {
                n instanceof F.CRUDObject && (t.focus = n);
                {
                    var r, o, a, s, c, l = !1;
                    t.pointCloudType
                }
                "object" == typeof t.root ? (o = t.root instanceof WS.Scan ? t.root : void 0, a = t.root instanceof WS.PointCloud ? t.root : void 0) : "string" == typeof t.root && (s = "scan" === t.rootType ? t.root : void 0, c = "pointcloud" === t.rootType ? t.root : void 0);
                var h = t.closestTo || t.lookAt || t.camPos;
                if ("panorama" === e) r = o ? Q.resolve(o) : s ? i._scanService.getByID(s, void 0, !1) : n ? i.loadParentScan(n, !1) : h ? i.getBestFittingScan(h) : i._scanService.getNearestScan("center");
                else if ("3d" === e) {
                    {
                        s || (o ? o._UUID : void 0)
                    }
                    i.isRootPointCloud() ? r = Q.resolve(i._root) : i._prevRenderable && i._prevRenderable._dataObject instanceof WS.PointCloud ? r = Q.resolve(i._prevRenderable._dataObject) : (r = i._pointCloudService.getDefaultPointCloud(), l = !0), a ? r = Q.resolve(a) : n || c && (r = i._pointCloudService.getByID(c, void 0, !0))
                }
                i._promise = r.then(function (e) {
                    if (!(e instanceof WS.PointCloud && "Scan" !== e._type) || o || s || h || t.angle || t.focus) return e;
                    var i;
                    return e.getTreeStructureAsync().then(function () {
                        return i = e.getFirstNonEmptyNode(), e._pointLoader.addAsListener(), e._pointLoader.loadNodeBinaryAsync(i)
                    }).then(function () {
                        return e
                    }).fail(function () {
                        return e
                    })
                }).then(function (t) {
                    i.$scope.error = void 0;
                    var r = i._rootIsScanCloud;
                    if (!t && l) {
                        var a = i._pointCloudService.isSimple3dEnabled().then(function (e) {
                            return e ? o ? o : s ? i._scanService.getByID(s, void 0, !0) : n ? i.loadParentScan(n, !0) : i.getBestFittingScan(h) : Q.reject(new Error("EM_3D_NA_EXTENDED"))
                        });
                        return a.then(function (e) {
                            return i.processLoadedRoot(e, r, !0)
                        }, function (e) {
                            return Q.reject(e)
                        })
                    }
                    return t ? i.processLoadedRoot(t, r, !1) : Q.reject(new Error("panorama" === e ? "EM_PANO_NA_EXTENDED" : "EM_3D_NA_EXTENDED"))
                }, function () {
                    return Q.reject(new Error("panorama" === e ? "EM_PANO_NA_EXTENDED" : "EM_3D_NA_EXTENDED"))
                }), i._promise.then(function (t) {
                    return t ? (F.async(i.hideRadialMenu, i), i._viewModeCtrl.update(i._root), i.resolveRootName(), i.resolveScanRecordingTime(), void(i._rootIsSameObject ? i.startAndUpdateChangeViewModeForSameRoot() : (i._scanService._rootScan = t instanceof WS.Scan ? t : void 0, i.setPreviousRenderable(), i.filterObjects(), i.updateMSMs(), i.updateDisplayOfAllScans(), i.updateOcclusionOfAllRenderables(), i.createAndAddSkybox(), i.updatePickerRootChanged(), i.isRootPointCloud() ? i.exchangePointCloudRootRenderable() : i.exchangeScanRootRenderable(), i.loadObjects(), i.trigger("sceneRootChange", [t, i])))) : void i._promiseTransitionD.reject(new Error("panorama" === e ? "EM_PANO_NA_EXTENDED" : "EM_3D_NA_EXTENDED"))
                }, function (e) {
                    i._promiseTransitionD.reject(e)
                })
            }, function (e) {
                ("FindObjectException" === e._type || "ResourceNotFoundException" === e._type) && (e.message = "EM_3D_FOCUS"), i._promiseTransitionD.reject(e)
            })
        }, function (e) {
            i._promiseTransitionD.reject(e)
        })
    },
    processLoadedRoot: function (e, t, i) {
        if (this._root && e && this._root._UUID === e._UUID) this._root = e, this._rootIsScanCloud = i, this._rootIsSameObject = t && i || !t && !i;
        else {
            this._root = e, this._rootIsScanCloud = i, this._rootIsSameObject = !1;
            var n = this;
            this.$scope.$apply(function (t) {
                t.root = n._root, n.isRootScan() ? (t.panoImagePaths = n.getPanoImagePaths(), t.panoImageResolution = e.getImageResolutionByPath(t.panoImagePaths[0])) : (t.panoImagePaths = void 0, t.panoImageResolution = "")
            })
        }
        return this._root
    },
    updateMSMs: function () {
        var e = this,
            t = this.getRelatedScanUUIDs();
        this._objects.measurement.entities.forEach(function (i) {
            if (i._type === WS.Measurement.Type.MultiScanPoint) {
                var n = e.getRenderable(i);
                n && (n.setViewScanUuids(t), n.updateMSMPoints())
            }
        })
    },
    updateDisplayOfAllScans: function () {
        var e = this;
        this._objects.scan.entities.forEach(function (t) {
            e.updateDisplayOfScan(t)
        })
    },
    updateDisplayOfScan: function (e) {
        for (var t = this.getRenderables(e), i = 0, n = t.length; n > i; ++i) this.updateViewingMode(t[i])
    },
    updateOcclusionOfAllRenderables: function () {
        for (var e = this.getAllRenderables(), t = 0, i = e.length; i > t; ++t) this.setOcclusion(e[t])
    },
    getRelatedScanUUIDs: function () {
        return this.isRootScanOrScanCloud() ? [this._root._UUID] : this.isRootPointCloud() ? this._root._sourceUUIDs : void 0
    },
    resolveRootName: function () {
		//chiso = chiso + 1;
		var e = this,
            t = this.$scope;
        this.isRootProjectPointCloud() || this.isRootScanOrScanCloud() ? t.rootName = this._root._displayName : this.isRootScanPointCloud() ? this._scanService.getByID(e._root._sourceUUIDs[0]).then(function (e) {
            t.rootName = e._displayName;
        }, function () {
            t.rootName = e._locale.translate("FE_SCAN")
        }) : t.rootName = this._root && this._root._displayName ? this._root._displayName : "";
        rootUUID = this._root._UUID;
		if (rootUUID == '957f7efb-d8e9-473c-89cb-5a9626d065c6'){
						document.getElementById("welcome").style.display = "block";
						var first_instructor = sessionStorage.getItem("firstInstructor");
						sessionStorage.setItem("firstInstructor", "daxem")
						if (first_instructor != "daxem"){
						document.getElementById("instructor").style.display = "block"

						} 


		}else{
						document.getElementById("welcome").style.display = "none";

		}
		//if (chiso > 1){
			
			debugger;
			this.removeAllObjects();
			//window.location.reload();
		//};
	},
	
    resolveScanRecordingTime: function () {
        var e = this.$scope;
        this.isRootScanOrScanCloud() ? e.scanRecordingTime = this._root._recordingTime : this.isRootScanPointCloud() ? this._scanService.getByID(this._root._sourceUUIDs[0]).then(function (t) {
            e.scanRecordingTime = t._recordingTime
        }, function () {
            e.scanRecordingTime = "1970-01-01 00:00:00"
        }) : e.scanRecordingTime = "1970-01-01 00:00:00"
    },
    loadParentScan: function (e, t) {
		
        var i, n, r;
        if (e._scanUUIDs && 0 < e._scanUUIDs.length) r = e._scanUUIDs, i = !0;
        else if (e._pointScans && 0 < e._pointScans.length) r = e._pointScans, i = e instanceof WS.Annotation;
        else {
            for (var o = e._ancestors, a = o.length - 1; a >= 0; a--)
                if ("Scan" === o[a].Class) {
                    n = o[a].UUID;
                    break
                }
            i = e instanceof WS.Annotation && (!F.isIE() || F.ieVersion() > 9)
        }
        if (t && (i = !0), this._root && (n && this._root._UUID === n || r && r.indexOf(this._root._UUID) >= 0)) return Q.resolve(this._root);
        var s = this._scanService;
        return n ? s.getByID(n, void 0, !1).fail(function () {
            if (!i) throw new Error("EM_NO_SCAN_AVAILABLE");
            return s.getNearestScan(e._trafoGlobal)
        }) : r || i ? s.getNearestScan(e._trafoGlobal, void 0, r, i) : Q.reject(new Error("EM_NO_SCAN_AVAILABLE"))
    },
    	
	loadObjects: function () {
		var e = this,
            t = [this._scanService];
        t.forEach(function (t) {
            t.getAll().then(function (t) {
                e.addObjects(t);
		}, function (t) {
                e._alert.errorObj(t)
            }).done()
        });
		
		t = [this._annotationService];
		t.forEach(function (t) {
            t.getAll().then(function (t) {
                e.addObjects(t);
				//lay so luong annotation
				numberofannotation = t.length;
            }, function (t) {
                e._alert.errorObj(t)
            }).done()
        });
		
		t = [this._pointCloudService, this._measurementService, this._orthophoto, this._tempMeasurementService, this._tempOrthophoto];
        t.forEach(function (t) {
            t.getAll().then(function (t) {
                e.addObjects(t);
		}, function (t) {
                e._alert.errorObj(t)
            }).done()
        });
		

    },
    addObject: function (e, t) {
        return this._root && this._trafoView ? (e instanceof WS.Point3d && (this.flashPickerCoords(), this.updatePickerDistance(), this.$scope.$apply(function (t) {
            t.pickedPoint = e
        })), WS.View3d.prototype.addObject.call(this, e, t)) : 0
    },
    objectFilter: function (e) {
        if (e.instanceOf(WS.Point3d) || e.instanceOf(WS.Orthophoto) || e.instanceOf(WS.Scan)) return !0;
        if (e.instanceOf(WS.PointCloud)) return "complete" === e._state && this._settingService.isWebGlEnabled();
        var t = this.getRootUuid();
        if (e.instanceOf(WS.Annotation)) return e.hasMapType() ? !1 : !F.isIE() || F.ieVersion() > 9 ? !0 : e._ancestors.some(function (e) {
            return e.UUID === t
        });
        if (e.instanceOf(WS.Measurement)) {
            var i = WS.Measurement.Type;
            if (e._type === i.Map) return !1;
            if (this.isRootCloud()) return !0;
            if (e._ancestors.some(function (e) {
                    return e.UUID === t
                })) return !0;
            if (e._type === i.MultiScanPoint) return -1 !== e._pointScans.indexOf(t)
        }
        return !1
    },
    isObjectRoot: function (e) {
        return this._root === e
    },
    isRootBasedOnScan: function (e) {
        return this.isRootScanOrScanCloud() && (!e || this.isObjectRoot(e)) || this.isRootScanPointCloud() && (!e || this._root._sourceUUIDs[0] === e._UUID)
    },
    isRootScan: function () {
        return this._root && this._root.instanceOf(WS.Scan) && !this._rootIsScanCloud
    },
    isRootScanCloud: function () {
        return this._root instanceof WS.Scan && this._rootIsScanCloud
    },
    isRootScanOrScanCloud: function () {
        return this.isRootScan() || this.isRootScanCloud()
    },
    isRootPointCloud: function () {
        return this._root instanceof WS.PointCloud
    },
    isRootProjectPointCloud: function () {
        return this._root instanceof WS.PointCloud && (this._root._type === WS.PointCloud.Type.PROJECT || this._root._type === WS.PointCloud.Type.ENTITYPC)
    },
    isRootScanPointCloud: function () {
        return this._root instanceof WS.PointCloud && "Scan" === this._root._type
    },
    isRootCloud: function () {
        return this.isRootPointCloud() || this.isRootScanCloud()
    },
    getRootUuid: function () {
        return void 0 !== this._root ? this._root._UUID : ""
    },
    isRootRenderablePano: function () {
        return this._rootRenderable instanceof WS.PanoramaRenderable
    },
    isRootRenderableScanCloud: function () {
        return this._rootRenderable instanceof WS.ScanCloudRenderable
    },
    isRootRenderablePointCloud: function () {
        return this._rootRenderable instanceof WS.PointCloudRenderable
    },
    isRootRenderableCloud: function () {
        return this.isRootRenderableScanCloud() || this.isRootRenderablePointCloud()
    },
    isPreviousRenderablePano: function () {
        return this._prevRenderable instanceof WS.PanoramaRenderable
    },
    isPreviousRenderableScanCloud: function () {
        return this._prevRenderable instanceof WS.ScanCloudRenderable
    },
    isPreviousRenderablePointCloud: function () {
        return this._prevRenderable instanceof WS.PointCloudRenderable
    },
    isPreviousRenderableCloud: function () {
        return this.isPreviousRenderableScanCloud() || this.isPreviousRenderablePointCloud()
    },
    hasPreviousRenderableSameType: function () {
        return this.isPreviousRenderableCloud() && this.isRootRenderableCloud() || this.isPreviousRenderablePano() && this.isRootRenderablePano()
    },
    isPanoRenderableLoaded: function () {
        return this._panoRenderable && this._renderer[0].areAllTexturesUploaded(this._panoRenderable._material)
    },
    loadSkyBox: function () {
        return this._skybox && this._renderer[0].areAllTexturesUploaded(this._skybox._material)
    },
    isPointsRenderableLoaded: function () {
        return this._pointsRenderable && this._pointsRenderable.isLoaded()
    },
    setPreviousRenderable: function () {
        this.isRootRenderablePano() ? (this._prevPanoRenderable && this._prevPanoRenderable._dataObject !== this._root && this._prevPanoRenderable.unload(this), this._prevPanoRenderable = this._rootRenderable) : this.isRootRenderableScanCloud() ? (this._prevScanCloudRenderable && this._prevScanCloudRenderable._dataObject !== this._root && this._prevScanCloudRenderable.unload(this), this._prevScanCloudRenderable = this._rootRenderable) : this.isRootRenderablePointCloud() && (this._prevPointCloudRenderable && this._prevPointCloudRenderable._dataObject !== this._root && this._prevPointCloudRenderable.unload(this), this._prevPointCloudRenderable = this._rootRenderable), this._prevRenderable = this._rootRenderable, this._rootRenderable = void 0, this._pointsRenderable = void 0, this._panoRenderable = void 0
    },
    exchangeScanRootRenderable: function () {
        var e;
        this.isRootScan() ? (e = this.getRenderable(this._root, WS.View3d.RenderableType.PANORAMA), e && e.getUuid() === this._root._UUID ? (this.setPanoRenderable(e), this.startChangeViewMode(WS.PanoramaView.ViewMode.PANO)) : this._prevPanoRenderable && this._prevPanoRenderable.getUuid() === this._root._UUID ? this.addRenderable(this._prevPanoRenderable, WS.View3d.RenderableType.PANORAMA, this._root) : (e = this.createPanoRenderable(this._root), this.addRenderable(e, WS.View3d.RenderableType.PANORAMA, this._root))) : this.isRootScanCloud() && (e = this.getRenderable(this._root, WS.View3d.RenderableType.SCAN_CLOUD) || this._prevScanCloudRenderable, e && e.getUuid() === this._root._UUID ? (this.setPointsRenderable(e), this.startChangeViewMode(WS.PanoramaView.ViewMode.POINTS)) : (e = this._root.createScanCloudRenderable(this, this._settingService), this.addRenderable(e, WS.View3d.RenderableType.SCAN_CLOUD, this._root)))
    },
    exchangePointCloudRootRenderable: function () {
        var e = this.getRenderable(this._root, WS.View3d.RenderableType.DEFAULT);
        e || (e = this._root.createRenderable(this), this.addRenderable(e, WS.View3d.RenderableType.DEFAULT, this._root)), this.setPointsRenderable(e), this.startChangeViewMode(WS.PanoramaView.ViewMode.POINTS)
    },
    createAndAddSkybox: function () {
        if (!this._skybox) {
            var e = this._settingService.isWebGlEnabled(),
                t = e && 4096 <= WS.GlTexture.getMaxWidth() ? "assets/skybox.jpg" : "assets/skybox-small.jpg";
            this._skybox = new WS.SkyboxRenderable(WS.imgUrlCanvasSafe(t)), WS.View3d.prototype.addRenderable.call(this, this._skybox)
        }
    },
    addRenderable: function (e, t, i, n) {
		WS.View3d.prototype.addRenderable.call(this, e, t, i, n), this.isObjectRoot(i) && (i instanceof WS.PointCloud || t === WS.View3d.RenderableType.SCAN_CLOUD ? (this.setPointsRenderable(e), this.startChangeViewMode(WS.PanoramaView.ViewMode.POINTS)) : t === WS.View3d.RenderableType.PANORAMA && (this.setPanoRenderable(e), this.startChangeViewMode(WS.PanoramaView.ViewMode.PANO)));
        var r = this.$scope.settings;
        e.instanceOf(WS.ScanPanoRenderable) ? e.setHideLabelBySetting(!r._showScanLabelsInPano) : e.instanceOf(WS.OrthoBox3dRenderable) ? e.setShowBox(r._showOrthoVolumes) : e instanceof WS.PolylineAnnotationRenderable && e.setShowPolyline(r._showPolylines), this.updateAddedRenderable(e, r._iconMode), this.setOcclusion(e)
    },
    setOcclusion: function (e) {
        var t = e._dataObject;
        if (t && e.setOcclusion && !(F.isIE() && F.ieVersion() <= 9)) {
            if (this.isRootCloud()) return void e.setOcclusion(!1);
            var i = this.getRootUuid();
            if (t._ancestors.some(function (e) {
                    return e.UUID === i
                })) e.setOcclusion(!1);
            else {
                var n = t.calcPositionInRefSystem(this._root._trafoGlobal);
                this.isOccluded(n).then(function (t) {
                    e.setOcclusion(t)
                }).done()
            }
        }
    },
    isOccluded: function (e) {
        if (!this.isRootScan()) return Q.reject();
        var t = [e[0], e[1], e[2]];
        return vec3.fromCartesianToSpherical(t, t), this._root.getWeightedDistance(t[0], t[1], 512).then(function (t) {
            var i = .5,
                n = vec3.length(e);
            return 0 !== t && n > t + i
        })
    },
    deactivateSpecialRenderable: function (e) {
        e.deactivate()
    },
    unloadSpecialRenderable: function (e) {
        e.unload(this)
    },
    createPanoRenderable: function (e) {
        var t = this.getPanoImagePaths(),
            i = new WS.PanoramaRenderable(t, this.$scope.settings._blendFactor, e);
        return i._transform = this._root.calcTrafoInRefSystem(this._trafoView), i
    },
    setPanoRenderable: function (e, t) {
        e.setAlpha(t ? 0 : 1), this._panoRenderable = e, this._pointsRenderable = void 0, this._rootRenderable = e
    },
    activatePanoRenderable: function (e, t) {
        var i = this.getPanoImagePaths();
        e.activate(i, this.$scope.settings._blendFactor), e.setAlpha(t ? 0 : 1)
    },
    getPanoImagePaths: function () {
        var e = this._settingService.getPrefferedImageWidth(),
            t = this._settingService.getPrefferedColorMode(),
            i = this._root;
        if (e = Math.min(this.getMaxPanoramaImageWidth(), e), "blend" === t._id && i.arePanoImagesAvailableForMode(t._id)) {
            var n = i.getSimilarAvailableImagesForBlending(e),
                r = [];
            return r[0] = i.getImagePath(n[0]), r[1] = i.getImagePath(n[1]), r
        }
        return [i.getImagePath(i.getSimilarAvailablePanoImage(e, t._id))]
    },
    getMaxPanoramaImageWidth: function () {
        return this._renderMode === WS.View3d.RenderMode.Canvas ? WS.CanvasTexture.getMaxWidth() : this._renderMode === WS.View3d.RenderMode.WebGl ? WS.GlTexture.getMaxWidth() : 0
    },
    setPointsRenderable: function (e, t) {
        e.setAlpha(t ? 0 : 1), this._panoRenderable = void 0, this._pointsRenderable = e, this._rootRenderable = e
    },
    activatePointsRenderable: function (e, t) {
        e.setAlpha(t ? 0 : 1), e.activate()
    },
    activateSkybox: function () {
        this._skybox && (this._skybox.activate(), this._skybox.setAlpha(1), this.loadSkyBox())
    },
    finishPreviousRenderable: function () {
        this._prevRenderable && this._prevRenderable !== this._rootRenderable && this.deactivateSpecialRenderable(this._prevRenderable), this.isRootRenderablePano() && this._skybox && this.deactivateSpecialRenderable(this._skybox), this._prevPanoRenderable === this._rootRenderable ? this._prevPanoRenderable = void 0 : this._prevScanCloudRenderable === this._rootRenderable ? this._prevScanCloudRenderable = void 0 : this._prevPointCloudRenderable === this._rootRenderable && (this._prevPointCloudRenderable = void 0)
    },
    startChangeViewMode: function (e) {
        this.deactivateHandlerStack(), this._modeToHandlerStack = void 0, this._viewModeCtrl.targetViewMode(e), this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.LOADING);
        var t = e === WS.PanoramaView.ViewMode.POINTS;
        this.updateCameraSettings(this._prevRenderable && !this.hasPreviousRenderableSameType() || t);
        var i = this.isRendering() && this._prevRenderable && !this.hasPreviousRenderableSameType();
        t ? (this.activatePointsRenderable(this._pointsRenderable, i), this.activateSkybox()) : this.activatePanoRenderable(this._panoRenderable, i), this._init = !0, this.$scope.$apply()
    },
    updateChangeViewModeAfterLoad: function () {
        this._inScanOrigin = void 0, this.finishPreviousRenderable(), this.onUpdateViewDimensions(), this._promiseTransitionD.resolve(!0)
    },
    startAndUpdateChangeViewModeForSameRoot: function () {
        this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.LOADING), this._init = !0, this.onUpdateViewDimensions(), this._promiseTransitionD.resolve(!0), this.$scope.$apply()
    },
    finishChangeViewMode: function () {
        this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.NONE), this._viewModeCtrl.viewMode(this._viewModeCtrl.targetViewMode()), this._modeToHandlerStack = void 0, this.initHandlers(), this.updateURL(this._replaceURL), this._isCollecting && (this._url.commit(), this._isCollecting = !1), this.updatePickerDistance(), this.isRootRenderablePointCloud() && (this._rootRenderable._panoTo3d = !1), this.updateCameraSettings(), F.async(this.$scope.$apply, this.$scope)
    },
    updatePickerRootChanged: function () {
        var e = this._point3dService.getPoint();
        if (e) switch (e._pointState) {
            case WS.Point3d.PointState.Invalid:
            case WS.Point3d.PointState.Unknown:
                this._point3dService.setPoint(void 0)
        }
    },
    updatePickerDistance: function () {
        var e = this._point3dService.getPoint();
        this.$scope.pickedDistance = e && e._positionGlobal ? vec3.dist(e._positionGlobal, this.getCamGlobalPos()) : void 0
    },
    flashPickerCoords: function () {
        var e = this.$scope,
            t = this._point3dService.getPoint();
        e.flashPicker = !1, t && t._pointState !== WS.Point3d.PointState.Unknown && setTimeout(function () {
            e.$apply(e.flashPicker = !0)
        }, 50)
    },
    initHandlers: function () {
        this.isRootCloud() ? this._camera.set3dMode() : this._camera.setPanoMode();
        var e = this._modeToHandlerStack = {},
            t = this._moveHandler = this.isRootCloud() ? new WS.PointCloudMoveHandler(this._camera, this, this._settingService) : new WS.PanoMoveHandler(this._camera, this, this._settingService);
        e[WS.ViewBase.Mode.Move] = [t, new WS.PickObjectHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.PickPoint] = [t, new WS.PickPointHandler(this._camera, this)], e[WS.ViewBase.Mode.PickPolygon] = [t, new WS.PickPointsHandler(this._camera, this)], e[WS.ViewBase.Mode.SelectObject] = [t, new WS.PickObjectHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.SelectObjects] = [t, new WS.PickObjectHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.SelectObjectsRectAdd] = [t, new WS.SelectRegionHandler(this._camera, this._scene, this, this._selectionRenderable, !0)], e[WS.ViewBase.Mode.SelectObjectsRectSub] = [t, new WS.SelectRegionHandler(this._camera, this._scene, this, this._selectionRenderable, !1)], e[WS.ViewBase.Mode.PickAll] = [t, new WS.PickAllHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.PickPointOpenScans] = [t, new WS.PickAllHandler(this._camera, this._scene, this)], e[WS.ViewBase.Mode.Move][1].addListener(new WS.PickObjectListener(this, WS.PickObjectListener.SelectionMode.None, this._selection, this._alert)), e[WS.ViewBase.Mode.PickPoint][1].addListener(new WS.PickPointListener(this)), e[WS.ViewBase.Mode.PickPolygon][1].addListener(new WS.PickPointListener(this)), e[WS.ViewBase.Mode.SelectObject][1].addListener(new WS.PickObjectListener(this, WS.PickObjectListener.SelectionMode.Single, this._selection, this._alert));
        var i = new WS.PickObjectListener(this, WS.PickObjectListener.SelectionMode.Multi, this._selection, this._alert);
        e[WS.ViewBase.Mode.SelectObjects][1].addListener(i), e[WS.ViewBase.Mode.SelectObjectsRectAdd][1].addListener(i), e[WS.ViewBase.Mode.SelectObjectsRectSub][1].addListener(i), e[WS.ViewBase.Mode.PickAll][1].addListener(new WS.PickAllListener(this, this._selection, this._alert, this._point3dService)), e[WS.ViewBase.Mode.PickPointOpenScans][1].addListener(new WS.PickPointOpenScansListener(this, this._selection, this._alert)), this.setMode(this._mode || WS.PanoramaView.defaultMode)
    },
    setMode: function (e) {
        var t = WS.ViewBase.Mode;
        this._mode !== e && e !== t.PickAll && F.async(this.hideRadialMenu, this), WS.View3d.prototype.setMode.call(this, e);
        var i = this._panoRenderable ? this._panoRenderable._material : void 0;
        i && i.setTextureImgFilter(e === t.PickPoint || e === t.PickPolygon || e === t.PickPointOpenScans ? WS.Image.Filter.Nearest : WS.Image.Filter.Linear), (e === t.SelectObjectsRectAdd || e === t.SelectObjectsRectSub) && this._selectionRenderable.setAppearance(e === t.SelectObjectsRectAdd)
    },
    updateViewingMode: function (e) {
        var t = e._dataObject;
        e.setViewingMode(t && t._selected ? WS.Renderable.ViewingMode.Selected : t && this._hlObject === t ? WS.Renderable.ViewingMode.Highlighted : e instanceof WS.ScanPanoRenderable && this.isRootBasedOnScan(t) ? WS.Renderable.ViewingMode.Displayed : WS.Renderable.ViewingMode.Normal)
    },
    pick3d: function (e, t, i, n, r) {
        var o = this._pointsRenderable,
            a = o && o.isActive() && o.useIncrRendering();
        return WS.View3d.prototype.pick3d.call(this, e, t, i, n, a, r)
    },
    render: function () {
        var e = WS.PointCloudRenderable.Draw,
            t = WS.PointCloudRenderable.State,
            i = function () {
                return !0
            },
            n = this.$scope,
            r = this._renderer[this._renderer.length - 1],
            o = this._viewModeCtrl.targetViewMode() === WS.PanoramaView.ViewMode.POINTS,
            a = this.isPointsRenderableLoaded(),
            s = this.isPanoRenderableLoaded();
        if (n.dbgStats.show && this.dbgUpdateStats(), !s && !a) return r.clear(), this._progressSpinner._position = [this._width / 2, this._height / 2], this._progressSpinner.draw2d(r, i, !1), void(this._cameraIdleCount = 0);
        if (this._isMoving || this._viewModeCtrl.viewModeTransition() !== WS.PanoramaView.Transition.NONE || this.triggerCameraChange(), this._viewModeCtrl.viewModeTransition() === WS.PanoramaView.Transition.LOADING) s ? this._prevRenderable ? this.isPreviousRenderablePano() ? this.updateChangeViewModeAfterLoad() : this.animToPanoStart() : this.updateChangeViewModeAfterLoad() : this._prevRenderable && this.isPreviousRenderablePano() ? this.blendTo3dStart() : this.updateChangeViewModeAfterLoad();
        else if (this._viewModeCtrl.viewModeTransition() === WS.PanoramaView.Transition.SWITCHING_PANO_3D) o ? this.blend() : this._inScanOrigin ? this.blend() : this.animToPano();
        else if (this._viewModeCtrl.viewModeTransition() === WS.PanoramaView.Transition.ANIMATING)
            if (this._cameraAnimator.isAnimating()) {
                var c = this._cameraAnimator.animate();
                c && this.finishChangeViewMode()
            } else this._promiseCamAnimD || this.finishChangeViewMode();
        else this._cameraAnimator.isAnimating() && this._cameraAnimator.animate();
        var l = e.ALL,
            h = !1;
        if (this._renderMode === WS.View3d.RenderMode.Canvas) this.updateMaxVisDistance(!1), this._panoRenderable && (this._cameraIdleCount === WS.PanoramaView.idleToFullResFrame && this._panoRenderable.requestFullResolutionFrame(), (this._camera._dirty || !this._panoRenderable._fullResolutionFrameRendered) && this._renderer[0].drawScene(this._camera, this._scene, !0)), this._renderer[1].setSubdivQuality(this._cameraIdleCount > 1 ? WS.Renderer2D.SubdivQuality.HIGH : WS.Renderer2D.SubdivQuality.LOW), this._renderer[1].drawScene(this._camera, this._scene);
        else {
            var d, u, _, p, g;
            this._pointsRenderable && this._pointsRenderable.isActive() && (d = this._pointsRenderable.update(), _ = this._pointsRenderable.useIncrRendering(), g = this._pointsRenderable._state === t.MOVE, h = this._pointsRenderable.shouldShowLoading()), this._prevRenderable && this.isPreviousRenderableCloud() && this._prevRenderable.isActive() && (u = this._prevRenderable.update(), p = this._prevRenderable.useIncrRendering(), void 0 === g && (g = this._prevRenderable._state === t.MOVE), h = h || this._prevRenderable.shouldShowLoading()), this.updateMaxVisDistance(void 0 !== g, g), void 0 !== d && void 0 !== u ? l = WS.PointCloudRenderable.combineDrawStates(d, u) : void 0 !== d ? l = d : void 0 !== u && (l = u);
            var f = !1;
            if (void 0 !== _ && void 0 !== p ? f = _ && p : void 0 !== _ ? f = _ : void 0 !== p && (f = p), l !== e.ABORT)
                if (f) this._renderer[0].drawSceneIncremental(this._camera, this._scene, l);
                else {
                    var m = this._renderObjects ? void 0 : {
                        zIndices: [0, 1]
                    };
                    this._renderer[0].drawScene(this._camera, this._scene, !0, void 0, m)
                }
        }
        if (h !== n.page.loading && F.async(function () {
                n.$apply(function () {
                    n.page.loading = h
                })
            }), l !== e.ABORT) {
            if (r.drawScene(this._camera, this._scene), this._bearingVisualizer) {
                var v = this,
                    S = function () {
                        return v._settingService._settings._showCompass && !v.miniView()
                    };
                this._bearingVisualizer.draw2d(r, S, !1, this._trafoView)
            }
            this._selectionRenderable.draw2d(r, i, !1)
        }
    },
    dbgUpdateStats: function () {
        var e = this.$scope,
            t = e.dbgStats;
        t.fps = this._dbgFps.toFixed(1);
        var i = this.isRootRenderablePointCloud() ? this._pointsRenderable : this.isPreviousRenderablePointCloud() ? this._prevRenderable : void 0,
            n = i ? i._pointLoader : void 0,
            r = function (e) {
                return (1e-6 * e).toFixed(3)
            };
        t.points = r(i ? n._pointsInMemory : 0), t.nodes = i ? n._nodesInMemory : 0;
        var o, a = 0,
            s = 0,
            c = 0,
            l = i ? i._visibleNodes : [];
        for (o = l.length - 1; o >= 0; o--) {
            var h = l[o];
            a += h._points, h._nodeInfo.positionArray && (s += h._points, c++)
        }
        t.pointsVis = r(a), t.nodesVis = i ? i._visibleNodes.length : 0, t.pointsRdr = r(s), t.nodesRdr = c, t.pointsLoad = r(n ? n._requestedPoints : 0), t.nodesLoad = n ? n._requestedNodes.length : 0, n && (t.maxPoints = r(n._maxPointsInMemory), t.pointBudgetMove = r(i._pointBudgetMove), t.pointBudgetStill = r(i._pointBudgetStill)), F.async(function () {
            e.$digest()
        })
    },
    blendTo3dStart: function () {
        this.isRootRenderableCloud() && (this._rootRenderable._inTransition = !0, this.isRootRenderablePointCloud() && (this._rootRenderable._panoTo3d = !0)), this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.SWITCHING_PANO_3D), this._blender.startBlending([this._rootRenderable, this._prevRenderable], [1e3, 1e3], [1, 0])
    },
    blendToPanoStart: function () {
        this._blender.startBlending([this._rootRenderable, this._prevRenderable], [1e3, 1e3], [1, 0])
    },
    blend: function () {
        var e = this._blender.blend();
        e && (this.isPreviousRenderableCloud() && (this._prevRenderable._inTransition = !1), this.isRootRenderableCloud() && (this._rootRenderable._inTransition = !1), this.updateChangeViewModeAfterLoad())
    },
    animToPanoStart: function () {
        this.isPreviousRenderableCloud() && (this._prevRenderable._inTransition = !0), this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.SWITCHING_PANO_3D);
        var e = this.getCamGlobalPos(),
            t = this._root.getTranslationGlobal(),
            i = this._cameraAnimator.calcGoodDuration(e, t);
        0 === i ? (this._camera.setFromGlobalPos(t, this._trafoView), this._camera._dirty = !1, 0 === this._cameraIdleCount && (this._cameraIdleCount = 1), this._inScanOrigin = !0, this.blendToPanoStart()) : this._cameraAnimator.startAnimation(this._camera, i, this._trafoView, t)
    },
    animToPano: function () {
        var e = this._cameraAnimator.animate();
        e && (this._inScanOrigin = !0, this.blendToPanoStart())
    },
    loadSettings: function () {
        var e = this;
        this._settingService.getAll().then(function (t) {
            t && 0 < t.length && t[0] instanceof WS.PanoSettings && e.$scope.$apply(function () {
                e.$scope.settings = t[0]
            })
        }, function (t) {
            e._alert.errorObj(t)
        }).done()
    },
    updateSettings: function (e, t) {
        switch (e) {
            case "panorama":
                this.updateSettingsInternal(t);
                break;
            case "unit":
                this.updateUnitSettings(t);
                break;
            case "language":
                this._scene && this._scene.traverse(new WS.UpdateLanguageVisitor);
                break;
            case "domain":
                this.updateDomainSettings(t)
        }
        this.forceRerender()
    },
    updateSettingsInternal: function (e) {
        var t = this,
            i = !1,
            n = this._renderMode === WS.View3d.RenderMode.WebGl,
            r = this._settingService.isWebGlEnabled(),
            o = this.$scope;
        if (o.settings = e, r !== n) {
            if (this.destroyRenderers(), this.replaceCanvases(), this.createRenderers(), this._width = this._height = void 0, this.onUpdateViewDimensions(), r || (this._prevPointCloudRenderable && (this.deactivateSpecialRenderable(this._prevPointCloudRenderable), this.unloadSpecialRenderable(this._prevPointCloudRenderable)), this._prevScanCloudRenderable && (this.deactivateSpecialRenderable(this._prevScanCloudRenderable), this.unloadSpecialRenderable(this._prevScanCloudRenderable)), this._pointsRenderable && (this.deactivateSpecialRenderable(this._pointsRenderable), this.unloadSpecialRenderable(this._pointsRenderable))), this._mouseAdapter) {
                var a = this._canvasList[this._canvasList.length - 1];
                this._mouseAdapter.setNode(a)
            }
            var s = WS.PanoramaView.ViewMode.PANO;
            if (!r && (this._viewModeCtrl.viewMode() !== s || this._viewModeCtrl.targetViewMode() !== s)) {
                var c;
                c = "loading" === this._fsm._state ? this._promise : this._viewModeCtrl.viewModeTransition() !== WS.PanoramaView.Transition.NONE ? this._promiseTransitionD.promise : Q.resolve(), c.fin(function () {
                    t.getBestFittingScan().then(function (i) {
                        t._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.NONE), t._cameraAnimator.reset(), t._fsm.read("reset"), t.load({
                            root: i,
                            updateSettings: e
                        }, "panorama")
                    }, function (e) {
                        t.reset(), t._alert.errorObj(e)
                    })
                }), i = !0
            }
            o.visible && this.startRendering()
        }
        r && this._renderer[0].updateDetailLevel(e.details3d()), this.updateCameraSettings(), i || (this.isRootScan() && (o.panoImagePaths = this.getPanoImagePaths(), o.panoImageResolution = this._root.getImageResolutionByPath(o.panoImagePaths[0])), this.updateSceneForUpdateSettings(e)), o.$apply()
    },
    updateUnitSettings: function (e) {
        var t = e[2]._unit === F.AngleUnit.gon ? WS.CompassRenderable.CompassModes.Gon : WS.CompassRenderable.CompassModes.Degree;
        this._bearingVisualizer.setCompassMode(t), this._scene && this._scene.traverse(new WS.UpdateUnitVisitor)
    },
    disableWebGL: function () {
        var e = this.$scope.settings;
        e && (e._changes._enableWebGl = !1, e.update(), this._alert.error("EM_WEBGL_BROKEN"))
    },
    updateCameraSettings: function (e) {
        e = void 0 === e ? this.isRootCloud() : e;
        var t = e ? this._settingService.details3d() : "Pano",
            i = WS.PanoramaView.FAR_DIST[t],
            n = this._camera;
        i !== n._far && n.setNearAndFarPlane(void 0, i)
    },
    updateMaxVisDistance: function (e, t) {
        var i;
        if (e) {
            var n = this._settingService.details3d();
            i = WS.PanoramaView.MAX_VISIBILITY[t ? "Move" : "Still"][n]
        }
        this._renderObjects = 0 !== i;
        var r = this,
            o = WS.Layer.LayerIDs;
        [o.ORTHOPHOTOS, o.SCANS, o.ANNOTATIONS].forEach(function (e) {
            r._layer.forceMaxDistance(e, r, i)
        });
        var a = 0 === i ? 0 : void 0;
        r._layer.forceMaxDistance(o.MEASUREMENTS, r, a)
    },
    updateSceneForUpdateSettings: function (e) {
        if (this._scene && (this._scene.traverse(new WS.SetIconModeVisitor(e._iconMode)), this._scene.traverse(new WS.ScanLabelsVisitor(e._showScanLabelsInPano)), this._scene.traverse(new WS.ShowBoxVisitor(e._showOrthoVolumes)), this._scene.traverse(new WS.ShowPolylineVisitor(e._showPolylines))), this._panoRenderable) {
            var t = this.getPanoImagePaths();
            this._panoRenderable.activate(t, e._blendFactor)
        }
        var i = WS.ScanCloudRenderable.DetailWidth[e.details3d()];
        this._pointsRenderable instanceof WS.ScanCloudRenderable && this._pointsRenderable.updateWidthAndMode(i, e.getColorMode()._id, this), this._prevRenderable instanceof WS.ScanCloudRenderable && this._prevRenderable.updateWidthAndMode(i, e.getColorMode()._id, this);
        var n = e.details3d();
        this._pointsRenderable instanceof WS.PointCloudRenderable && this._pointsRenderable.updateDetailLevel(n), this._prevRenderable instanceof WS.PointCloudRenderable && this._prevRenderable.updateDetailLevel(n)
    },
    getBestFittingScan: function (e) {
        if (this.isRootScanOrScanCloud()) return Q.resolve(this._root);
        if (this.isRootScanPointCloud()) return this._scanService.getByID(this._root._sourceUUIDs[0], void 0, !0);
        var t = e ? e : this.getCamGlobalPos();
        return this._scanService.getNearestScan(t)
    },
    replaceCanvases: function () {
        var e = this._canvasList,
            t = $(e[0]).parent();
        e.each(function (e, t) {
            var i = t.outerHTML;
            $(t).replaceWith(i)
        }), e = t.find("canvas"), this.setCanvas(e)
    },
    loadDomainSettings: function () {
        var e = this;
        this._domainSettings.get().done(function (t) {
            e.updateDomainSettings(t)
        }, F.NOP)
    },
    updateDomainSettings: function (e) {
        var t = this,
            i = this.$scope;
        i.$apply(function () {
            i.logoUrl = t._domainSettings.getCustomerLogoUrl(e), i.logoOpacity = e._customerLogoOpacity
        })
    },
    onCameraChange: function (e, t) {
        if (t === this && this._viewModeCtrl.viewModeTransition() === WS.PanoramaView.Transition.NONE && !this._cameraAnimator.isAnimating()) {
            var i = this.hasCameraChanged();
            i > 0 && ("highlight" !== this._fsm._state && "xyz" !== this._fsm._state || 2 !== i || this._fsm.read("move"), this.updateURL(!0), this.updatePickerDistance(), this.$scope.$apply())
        }
    },
    hasCameraChanged: function () {
        var e = this._prevCameraValuesForUrl;
        if (!F.closeToArray(this.getCamGlobalPos(), e.pos, WS.PanoramaView.EPS_POS) || !F.closeToAngles(this._camera.getAnglesForCenter(), e.angles, WS.PanoramaView.EPS_ANGLES)) return 2;
        var t = this._camera._fovY;
        return F.closeTo(t, e.fovY, .1) ? 0 : 1
    },
    getGlobalTrafoOfRoot: function () {
        return this._root ? this._root._trafoGlobal : mat4.identity()
    },
    unselect: function (e) {
        for (var t = 0, i = e.length; i > t; t++) {
            var n = e[t];
            n instanceof WS.Scan ? this.updateDisplayOfScan(n) : WS.View3d.prototype.unselect.call(this, [n])
        }
    },
    loadPending: function (e) {
        if ("pending" === this._fsm._state) {
            var t = this._fsm._meta.pending,
                i = t.s || t.u,
                n = {
                    root: i
                };
            void 0 !== t.o ? (n.focus = t.o, n.focusType = t.t) : void 0 !== t.p && void 0 !== t.t && (n.angle = [parseFloat(t.p), parseFloat(t.t)]);
            var r = t.x || t.lx,
                o = t.y || t.ly,
                a = t.z || t.lz;
            n.lookAt = void 0 !== r && void 0 !== o && void 0 !== a ? [parseFloat(r), parseFloat(o), parseFloat(a)] : void 0, n.camPos = void 0 !== t.cx && void 0 !== t.cy && void 0 !== t.cz ? [parseFloat(t.cx), parseFloat(t.cy), parseFloat(t.cz)] : void 0, n.camFov = void 0 !== t.cf ? parseFloat(t.cf) : void 0, "3d" === t.vt ? n.rootType = "pointcloud" : "3dsc" === t.vt ? (n.rootType = "scan", n.pointCloudType = "ScanCloud") : n.rootType = "scan", n.replaceURL = !0, n.miniView = e || !1;
            var s = "3d" === t.vt || "3dsc" === t.vt ? "3d" : "panorama";
            this.load(n, s)
        }
    },
    getObject: function (e, t) {
        return F.DI().getService(t).getByID(e, void 0, !0)
    },
    getImageWidth: function () {
        var e = this.isRootScan() && this.$scope.panoImagePaths ? this._root.getPanoImageDescByPath(this.$scope.panoImagePaths) : void 0;
        return e ? e.width : -1
    },
    setPickedPoints: function (e, t, i, n, r, o, a) {
        var s = this;
        this.removeLineEnd(), this.removeLines();
        var c = e.some(function (e) {
            return e._takenInView !== s
        });
        if (0 !== e.length && !c && this._scene) {
            var l = e.map(function (e) {
                var t = e.calcPositionInRefSystem(s._trafoView, !0);
                return [t[0], t[1], t[2]]
            });
            this.createLine(l, i, n, r, o, a), t && this.createLineEnd(l, n, r)
        }
    },
    updateObjects: function (e) {
		
        for (var t = !1, i = 0, n = e.length; n > i; i++) {
            var r = e[i];
            WS.View3d.prototype.updateObject.call(this, r), r instanceof WS.Point3d && (this.flashPickerCoords(), this.updatePickerDistance(), t = !0)
        }
        t && this.$scope.$apply()
    },
    removeObjects: function (e) {
        for (var t = 0, i = e.length; i > t; t++) {
            var n = e[t];
            n.instanceOf && n.instanceOf(WS.Point3d) && this.$scope.$apply(function (e) {
                e.pickedPoint = void 0, e.pickedDistance = void 0, e.flashPicker = !1
            }), this.removeObject(n)
        }
    },
    startRendering: function () {
		WS.View3d.prototype.startRendering.call(this), this._promiseCamAnimD && this._promiseCamAnimD.resolve(!0)
    },
    showJoystick: function (e, t, i) {
        var n = WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF,
            r = 10,
            o = Math.floor(i / 2),
            a = e - 5;
        this.$scope.$apply(function (i) {
            var s = i.joystick;
            s.hUpper = o - r, s.hLower = s.hUpper, s.xTop = a, s.yTop = t - o - 6, s.xUpper = a, s.yUpper = t - o, s.xMiddle = a, s.yMiddle = t - r, s.xLower = a, s.yLower = t + r + 1, s.xBottom = a, s.yBottom = t + o + 1, s.xButton = e - n, s.yButton = t - n, s.visible = !0, s.wasVisible = !0
        })
    },
    updateJoystick: function (e, t) {
        var i = WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF;
        this.$scope.$apply(function (e) {
            var n = e.joystick;
            n.yButton = Math.min(n.yBottom - 1 - i, Math.max(n.yUpper - i, t - i))
        })
    },
    hideJoystick: function () {
        this.$scope.$apply(function (e) {
            e.joystick.visible = !1
        })
    },
    login: function () {
        "loading" === this._fsm._state || "pending" === this._fsm._state || (this._visible ? (this._fsm.read("delay"), this.loadPending(this.miniView())) : this.reset())
    },
    logout: function () {
        this.reset(), this.$scope.project = void 0
    },
    updateAccount: function () {
        if ("loading" === this._fsm._state || "pending" === this._fsm._state) ;
        else if (this._visible) {
            var e = this._url.getFragment(this._id);
            this._fsm._meta.pending = this._url.decode(e), this._fsm.read("delay"), this.loadPending(this.miniView())
        }
    },
    onConfigure: function (e) {
        if (!e || !e.noReconfigure) {
            var t = WS.ViewBase.Mode.PickAll;
            this._allowedSelections = "annotation,scan,measurement,tempmeasurement,orthophoto", this._changeScanAllowed = !0, e && (void 0 !== e.changeScanAllowed && (this._changeScanAllowed = e.changeScanAllowed), e.mode ? t = e.mode : e.selection && (t = WS.ViewBase.Mode.SelectObjects), e.selection && (this._allowedSelections = e.selection)), this.setMode(t)
        }
    },
    setMiniView: function (e, t) {
        var i = this;
        return Q.try(function () {
            return e || t !== F.PageBox.MiniViewTransition.Main ? void 0 : i.trigger("launchTask", ["default", "panoramaview", void 0, void 0, {
                noNavigation: !0
            }])
        }).then(WS.View3d.prototype.setMiniView.bind(this, e, t))
    },
    onShow: function () {
        WS.View3d.prototype.onShow.call(this), this.onUpdateViewDimensions(), this.startRendering(), this._settingsLoaded || (this._settingsLoaded = !0, this.loadDomainSettings()), "void" === this._fsm._state ? this.load({}, "pano/3d") : this.loadPending()
    },
    preparePageChange: function (e) {
        var t = e.state,
            i = F.PageBox.Action;
        return !this.miniView() || !t.om.visible || t.pv.visible || e.action !== i.SelectPage && e.action !== i.SelectPageClass && e.action !== i.ConfigurePage && e.action !== i.ChangeRequest ? void 0 : (t.pv.visible = !0, t.pv.miniView = !0, !0)
    },
    onHide: function () {
        WS.View3d.prototype.onHide.call(this), this.stopRendering(), this._isCollecting && (this._url.commit(), this._isCollecting = !1), F.async(this.hideRadialMenu, this), this._root && this.triggerCameraChange()
    },
    updateURL: function (e) {
        var t = this.getCamGlobalPos(),
            i = this._camera.getAnglesForCenter(),
            n = i[0],
            r = i[1],
            o = this._camera._fovY,
            a = this._fsm._state;
        if (this._prevCameraValuesForUrl = {
                angles: i,
                pos: t,
                fovY: o
            }, "void" === a) this._url.setFragment(this._id, "", ["p"], e);
        else if ("free" === a || "xyz" === a || "highlight" === a) {
            var s = this.isRootScanCloud() ? "3dsc" : this.isRootPointCloud() ? "3d" : "p",
                c = this._root._UUID,
                l = this._fsm._meta.focus,
                h = l && l.lookPos,
                d = {
                    vt: s,
                    u: c,
                    cf: o.toFixed(2)
                };
            this.$scope.dbgStats.show && (d.stats = "t");
            var u = this._url.getFragment(this._id),
                _ = u && this._url.decode(u) || {},
                p = d.vt === _.vt && d.u === _.u && d.stats === _.stats && F.closeTo(o, parseFloat(_.cf), .1);
            switch ("free" !== a && "xyz" !== a || "p" === s || (p = p && F.closeToArray(t, [parseFloat(_.cx), parseFloat(_.cy), parseFloat(_.cz)], WS.PanoramaView.EPS_POS)), "xyz" !== a && "highlight" !== a || !h || (p = p && F.closeToArray(h, [parseFloat(_.lx), parseFloat(_.ly), parseFloat(_.lz)], WS.PanoramaView.EPS_POS)), a) {
                case "free":
                    if ("p" !== s && (d.cx = t[0].toFixed(5), d.cy = t[1].toFixed(5), d.cz = t[2].toFixed(5)), d.p = n.toFixed(5), d.t = r.toFixed(5), p = p && F.closeToAngles(i, [parseFloat(_.p), parseFloat(_.t)], WS.PanoramaView.EPS_ANGLES)) return;
                    this._url.setFragment(this._id, this._url.encode(d), ["p"], e);
                    break;
                case "xyz":
                    if (p) return;
                    "p" !== s && (d.cx = t[0].toFixed(5), d.cy = t[1].toFixed(5), d.cz = t[2].toFixed(5)), d.lx = h[0].toFixed(5), d.ly = h[1].toFixed(5), d.lz = h[2].toFixed(5), this._url.setFragment(this._id, this._url.encode(d), ["p"], e);
                    break;
                case "highlight":
                    var g = l.object;
                    if (d.t = (g.instanceOf(WS.TempMeasurement) ? "temp" : "") + g._class.toLowerCase(), d.o = g._UUID.toLowerCase(), p = p && d.t === _.t && d.o === _.o) return;
                    h && (d.lx = h[0].toFixed(5), d.ly = h[1].toFixed(5), d.lz = h[2].toFixed(5)), this._url.setFragment(this._id, this._url.encode(d), ["p"], e)
            }
        }
    },
    setFragment: function (e) {
        e.isUnresolved(this._id) && e.resolve(this._id, e.get(this._id).query, ["p"])
    },
    applyURL: function (e, t) {
        if (e === this._id) {
            var i = t.get(e),
                n = this._url.decode(i.query);
            if ("loading" === this._fsm._state || "pending" === this._fsm._state) return void(this._settingService.isWebGlEnabled() && this._alert.error(this._viewModeCtrl.targetViewMode() === WS.PanoramaView.ViewMode.POINTS ? "EM_3D_LOAD" : "EM_SCAN_LOAD"));
            this._fsm.read("reset"), this._fsm._meta.pending = n, this._fsm._meta.rollback = "delay", this._visible ? (this._fsm.read("delay"), this.loadPending()) : this._fsm.read("delay"), this.$scope.dbgStats.show = !!n.stats
        }
    }
}, WS.extend("PanoramaView", "View3d"), WS.PanoramaView.defaultMode = WS.ViewBase.Mode.PickAll, WS.PanoramaView.type = WS.Layer.ViewTypes.PANO_VIEW, WS.PanoramaView.idleToFullResFrame = 10, WS.PanoramaView.ViewMode = {
    PANO: "pano",
    POINTS: "points"
}, WS.PanoramaView.Transition = {
    NONE: !1,
    LOADING: "loading",
    SWITCHING_PANO_3D: "switch",
    ANIMATING: "animating"
}, WS.PanoramaView.EPS_POS = .005, WS.PanoramaView.EPS_ANGLES = .01, WS.PanoramaView.FAR_DIST = {
    VeryLow: 100,
    Low: 200,
    Medium: 300,
    High: 400,
    VeryHigh: 500,
    Pano: 500
}, WS.PanoramaView.MAX_VISIBILITY = {
    Move: {
        VeryLow: 0,
        Low: 0,
        Medium: 20,
        High: 30,
        VeryHigh: 50
    },
    Still: {
        VeryLow: 40,
        Low: 60,
        Medium: 80,
        High: void 0,
        VeryHigh: void 0
    }
}, WS.PanoShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.pano_vs, WS.shaderSrc.pano_fs)
}, WS.extend("PanoShaderDesc", "BasicShaderDesc"), WS.PanoShaderDesc.ID = "PanoShader", WS.SkyboxShaderDesc = function () {
    WS.BasicShaderDesc.call(this, WS.shaderSrc.pano_vs, WS.shaderSrc.skybox_fs)
}, WS.extend("SkyboxShaderDesc", "BasicShaderDesc"), WS.SkyboxShaderDesc.ID = "SkyboxShader", WS.PanoramaMaterial = function (e, t) {
    WS.BlendMaterial.call(this, WS.PanoShaderDesc, !0, !1, !1, [], t), this.setTextureImgUrls(e), this._projMatrix = mat4.create(), this._inverseProjMatrix = mat4.create(), this._alpha = 1, this._circleVisible = !0
}, WS.PanoramaMaterial.prototype = {
    configureShader: function (e) {
        var t = e.getTexture(this.getImage(0));
        if (!t || !t.isImageUploaded()) return !1;
        var i = e.getTexture(this.getImage(1));
        if (i && !i.isImageUploaded()) return !1;
        var n = e.getShaderProgram(this);
        return n.setAttributeValue("aVertexPosition", e.getGlBuffer(e._geometry._positionBuffer)), n.setUniformValue("uTex0", new WS.TextureValue(t, 0)), n.setUniformValue("uTex1", new WS.TextureValue(i ? i : t, 1)), mat4.multiply(e._camera._camMatrix, e.getModelMatrix(), this._projMatrix), mat4.inverse(this._projMatrix, this._inverseProjMatrix), n.setUniformValue("uBlendFactor0", this._alpha * this._blendFactor), n.setUniformValue("uBlendFactor1", this._alpha * (1 - this._blendFactor)), n.setUniformValue("uViewport", e._viewport._dimensions), n.setUniformValue("uProjMatrix", this._inverseProjMatrix), n.setUniformValue("uCircleVisible", this._circleVisible), !0
    },
    setPanoramaImages: function (e, t) {
        this.setTextureImgUrls(e), this.setBlendFactor(t)
    }
}, WS.extend("PanoramaMaterial", "BlendMaterial"), WS.SkyboxMaterial = function (e) {
    WS.ShaderMaterial.call(this, WS.SkyboxShaderDesc, !0, !1, !1, []), this.setTextureImgUrls([e]), this._inverseProjMatrix = mat4.create(), this._alpha = 1
}, WS.SkyboxMaterial.prototype = {
    configureShader: function (e) {
        var t = e.getTexture(this.getImage(0));
        if (!t || !t.isImageUploaded()) return !1;
        var i = e.getShaderProgram(this);
        return i.setAttributeValue("aVertexPosition", e.getGlBuffer(e._geometry._positionBuffer)), i.setUniformValue("uTex", new WS.TextureValue(t, 0)), mat4.inverse(e._camera._camMatrixOrigin, this._inverseProjMatrix), i.setUniformValue("uAlpha", this._alpha), i.setUniformValue("uViewport", e._viewport._dimensions), i.setUniformValue("uProjMatrix", this._inverseProjMatrix), !0
    }
}, WS.extend("SkyboxMaterial", "ShaderMaterial"), WS.GlobeRenderable = function (e) {
    WS.Mesh.call(this, new WS.CenteredQuadGeometry, e), this._activated = !1
}, WS.GlobeRenderable.prototype = {
    activate: function () {
        this._activated = !0
    },
    deactivate: function () {
        this._activated = !1
    },
    isActive: function () {
        return this._activated
    },
    unload: function (e) {
        e.deleteStorageForRenderableAndMembers(this), this._material.clearTextureImages()
    },
    isLoaded: function () {
        return this._material.hasImages() && this._material.areImagesLoaded()
    },
    setAlpha: function (e) {
        this._material._alpha = e
    },
    getAlpha: function () {
        return this._material._alpha
    },
    draw3d: function (e, t) {
        this._activated && t(this) && (this.drawMemberRenderables3d(e, t, !0), WS.Mesh.prototype.draw3d.call(this, e, t, !0))
    }
}, WS.extend("GlobeRenderable", "Mesh"), WS.PanoramaRenderable = function (e, t, i) {
    var n = new WS.PanoramaMaterial(e, t);
    WS.GlobeRenderable.call(this, n), this._circleImageRenderable = new WS.ScannerCircleImageRenderable, this._circleVisible = !0, this._fullResRenderWorker = void 0, this._renderFullResolutionFrame = !1, this._fullResolutionFrameRendered = !1, this._isRenderingFullResolutionFrame = !1, this._targetFramesPerSecond = WS.PanoramaRenderable.TargetFrameCount, this._circleColor = WS.PanoramaRenderable.CircleColorNormal, this._fullResolutionFrame = {
        cameraMatrix: void 0,
        width: void 0,
        height: void 0,
        data: void 0
    }, this.setDataObject(i), this.showLogo(!i.isVirtual()), this.addToLayer(WS.Layer.LayerIDs.PANO, !0)
}, WS.PanoramaRenderable.prototype = {
    activate: function (e, t) {
        WS.GlobeRenderable.prototype.activate.call(this), this._fullResolutionFrameRendered = !1, this._material.setPanoramaImages(e, t)
    },
    unload: function (e) {
        WS.GlobeRenderable.prototype.unload.call(this, e), this._fullResolutionFrameRendered = !1
    },
    calculateRenderTimePerPixel: function (e) {
        var t = e._camera,
            i = 300,
            n = 150,
            r = mat4.create(t._camMatrix);
        mat4.inverse(r);
        var o = e.getMaterialTextures(this._material);
        if (o && 0 !== o.length) {
            var a = {
                    widthPanoTexture: o[0].getWidth(),
                    heightPanoTexture: o[0].getHeight(),
                    dataPanoTexture: o[0]._canvasData
                },
                s = o.length > 1 ? {
                    widthPanoTexture: o[1].getWidth(),
                    heightPanoTexture: o[1].getHeight(),
                    dataPanoTexture: o[1]._canvasData
                } : void 0,
                c = {
                    frameX: i,
                    frameY: n,
                    panoTexture0: a,
                    panoTexture1: s,
                    blendFactor: this._material._blendFactor,
                    cameraMatrix: r,
                    dataOut: new Array(i * n * 4),
                    circleColor: this._circleColor
                },
                l = PanoramaShader.perform(c);
            return l.time / (i * n)
        }
    },
    calculateNeededScale: function (e, t, i, n) {
        var r = e * t,
            o = 1e3 / n,
            a = i * r,
            s = Math.sqrt(a / o);
        return s = Math.ceil(s), (Math.round(e / s) < 10 || Math.round(t / s) < 10) && s++, s
    },
    onViewingModeChange: function () {
        switch (this._circleImageRenderable.setViewingMode(this._viewingMode), this._viewingMode) {
            case WS.Renderable.ViewingMode.Selected:
                this._circleColor = WS.PanoramaRenderable.CircleColorActive;
                break;
            case WS.Renderable.ViewingMode.Inconsiderable:
            case WS.Renderable.ViewingMode.Normal:
            case WS.Renderable.ViewingMode.Highlighted:
                this._circleColor = WS.PanoramaRenderable.CircleColorNormal
        }
    },
    requestFullResolutionFrame: function () {
        this._renderFullResolutionFrame = !0, this._fullResolutionFrameRendered = !1
    },
    getFullResRenderWorker: function () {
        if (!this._fullResRenderWorker && "undefined" != typeof Worker) {
            var e = this;
            this._fullResRenderWorker = new Worker(workerPath + "/panoramashaderworker.js"), this._fullResRenderWorker.addEventListener("message", function (t) {
                var i = e._fullResolutionFrame,
                    n = t.data;
                e._isRenderingFullResolutionFrame = !1, i.data = n.data
            }, !1)
        }
        return this._fullResRenderWorker
    },
    draw2d: function (e, t) {
        if (this._activated && t(this)) {
            this.drawMemberRenderables2d(e, t, !0);
            var i = e._camera,
                n = e._ctx,
                r = mat4.multiply(i._camMatrix, e.getModelMatrix(), mat4.create());
            mat4.inverse(r);
            var o, a, s = e._viewport;
            if (!e.areAllTexturesUploaded(this._material) || s.getWidth() <= 0 || s.getHeight() <= 0) return void(this._fullResolutionFrameRendered = !1);
            this._renderTimePerPixel || (this._renderTimePerPixel = this.calculateRenderTimePerPixel(e));
            var c = e.getMaterialTextures(this._material);
            if (c && 0 !== c.length) {
                var l = {
                        widthPanoTexture: c[0].getWidth(),
                        heightPanoTexture: c[0].getHeight(),
                        dataPanoTexture: c[0]._canvasData
                    },
                    h = c.length > 1 ? {
                        widthPanoTexture: c[1].getWidth(),
                        heightPanoTexture: c[1].getHeight(),
                        dataPanoTexture: c[1]._canvasData
                    } : void 0,
                    d = this._fullResolutionFrame;
                if (this._renderFullResolutionFrame && !this._isRenderingFullResolutionFrame) {
                    d.cameraMatrix = mat4.create(i._camMatrix), d.height = e._canvasHeight, d.width = e._canvasWidth, this._isRenderingFullResolutionFrame = !0, this._fullResolutionFrameRendered = !1;
                    var u = {
                            frameX: d.width,
                            frameY: d.height,
                            panoTexture0: l,
                            panoTexture1: h,
                            blendFactor: this._material._blendFactor,
                            cameraMatrix: r,
                            circleColor: this._circleColor
                        },
                        _ = this.getFullResRenderWorker();
                    if (_) _.postMessage(u);
                    else {
                        e.setCanvasScaleFactor(1), e.setViewPortDimensions(e._canvasWidth, e._canvasHeight), o = n.getImageData(0, 0, s.getWidth(), s.getHeight()), u.dataOut = o.data;
                        var p = PanoramaShader.perform(u);
                        d.data = p.data, this._isRenderingFullResolutionFrame = !1
                    }
                    this._renderFullResolutionFrame = !1
                }
                if (d && d.data && !this._isRenderingFullResolutionFrame && mat4.equal(d.cameraMatrix, i._camMatrix) && d.width === e._canvasWidth && d.height === e._canvasHeight && !i._dirty) this._fullResolutionFrameRendered = !0, a = d.data, e.setCanvasScaleFactor(1), e.setViewPortDimensions(e._canvasWidth, e._canvasHeight), o = n.getImageData(0, 0, s.getWidth(), s.getHeight());
                else {
                    var g = this.calculateNeededScale(e._canvasWidth, e._canvasHeight, this._renderTimePerPixel, this._targetFramesPerSecond);
                    e.setCanvasScaleFactor(g), e.setViewPortDimensions(Math.floor(e._canvasWidth / g), Math.floor(e._canvasHeight / g)), o = n.getImageData(0, 0, s.getWidth(), s.getHeight()), this._fullResolutionFrameRendered = !1;
                    var f = {
                            frameX: e._viewport.getWidth(),
                            frameY: e._viewport.getHeight(),
                            panoTexture0: l,
                            panoTexture1: h,
                            blendFactor: this._material._blendFactor,
                            cameraMatrix: r,
                            dataOut: o.data,
                            circleColor: this._circleColor
                        },
                        m = PanoramaShader.perform(f);
                    a = m.data
                }
                if (o.data !== a)
                    if (o.data.set) o.data.set(a);
                    else {
                        var v = 0,
                            S = o.data,
                            b = S.length;
                        for (v = 0; b > v; v++) S[v] = a[v]
                    }
                n.putImageData(o, 0, 0)
            }
        }
    },
    getVisibleMemberRenderables: function () {
        return this._circleVisible ? [this._circleImageRenderable] : []
    },
    getMemberRenderables: function () {
        return [this._circleImageRenderable]
    },
    setBlendFactor: function (e) {
        this._material._blendFactor = e
    },
    showLogo: function (e) {
        this._circleVisible = e, this._material._circleVisible = e
    }
}, WS.extend("PanoramaRenderable", "GlobeRenderable"), WS.PanoramaRenderable.TargetFrameCount = 30, WS.PanoramaRenderable.CircleColorNormal = [255, 255, 255], WS.PanoramaRenderable.CircleColorActive = [160, 220, 246], WS.SkyboxRenderable = function (e) {
    var t = new WS.SkyboxMaterial(e);
    WS.GlobeRenderable.call(this, t), this._UUID = F.generateUUID(), this.addToLayer(WS.Layer.LayerIDs.PANO, !0)
}, WS.SkyboxRenderable.prototype = {
    draw2d: function () {
    }
}, WS.extend("SkyboxRenderable", "GlobeRenderable"), WS.PanoSettingService = function (e, t) {
    WS.PlugModule.call(this, e), this._cookie = t, this._cookieId = "panosettings", this._settings = new WS.PanoSettings(10, 2, "color", WS.PanoSettings.IconModes.Category, .6, !0, !0, !0, !1, WS.PanoSettings.Detail3d.AUTOMATIC, !0, this), this.getFromLocalStorage(this._settings), this.provideMalePlug("SettingsUpdate", ["updateSettings"])
}, WS.PanoSettingService.prototype = {
    getNew: function (e, t, i, n, r, o, a, s, c, l) {
        return new WS.PanoSettings(e, t, i, n, r, o, a, s, c, l, this)
    },
    getAll: function () {
        var e = this._settings.clone(),
            t = Q.defer();
        return t.resolve([e]), t.promise
    },
    getByPrimaryKey: function () {
        var e = this._settings.clone(),
            t = Q.defer();
        return t.resolve(e), t.promise
    },
    update: function (e) {
        var t = Q.defer();
        e.applyUpdate();
        var i = e.clone();
        return this._settings = i, this._settings.writeToLocalStorage(), t.resolve(), this.trigger("updateSettings", ["panorama", e]), t.promise
    },
    writeToLocalStorage: function (e) {
        var t = {
            movementSpeed: e._movementSpeed,
            imageResolutionIndex: e._imageResolutionIndex,
            colorMode: e._colorMode,
            iconMode: e._iconMode,
            blendFactor: e._blendFactor,
            enableWebGl: e._enableWebGl,
            showCompass: e._showCompass,
            showScanLabelsInPano: e._showScanLabelsInPano,
            showOrthoVolumes: e._showOrthoVolumes,
            details3d: e._details3d,
            showPolylines: e._showPolylines
        };
        this._cookie.setLocalStorageItem(this._cookieId, JSON.stringify(t))
    },
    getFromLocalStorage: function (e) {
        var t = JSON.parse(this._cookie.getLocalStorageItem(this._cookieId));
        //t && (e._movementSpeed = t.movementSpeed, e._imageResolutionIndex = Math.min(t.imageResolutionIndex, WS.Scan.DeviceMaxResolutionIdx), e._colorMode = t.colorMode, e._iconMode = t.iconMode, e._blendFactor = t.blendFactor, "boolean" == typeof t.enableWebGl && (e._enableWebGl = t.enableWebGl), "boolean" == typeof t.showCompass && (e._showCompass = t.showCompass), "boolean" == typeof t.showScanLabelsInPano && (e._showScanLabelsInPano = t.showScanLabelsInPano), "boolean" == typeof t.showOrthoVolumes && (e._showOrthoVolumes = t.showOrthoVolumes), "string" == typeof t.details3d && (e._details3d = t.details3d), "boolean" == typeof t.showPolylines && (e._showPolylines = t.showPolylines))
		t && (e._movementSpeed = t.movementSpeed, e._imageResolutionIndex = Math.min(t.imageResolutionIndex, WS.Scan.DeviceMaxResolutionIdx), e._colorMode = t.colorMode, e._iconMode = t.iconMode, e._blendFactor = t.blendFactor, "boolean" == typeof t.enableWebGl && (e._enableWebGl = t.enableWebGl), "boolean" == typeof t.showCompass && (e._showCompass = false), "boolean" == typeof t.showScanLabelsInPano && (e._showScanLabelsInPano = t.showScanLabelsInPano), "boolean" == typeof t.showOrthoVolumes && (e._showOrthoVolumes = t.showOrthoVolumes), "string" == typeof t.details3d && (e._details3d = t.details3d), "boolean" == typeof t.showPolylines && (e._showPolylines = t.showPolylines))
    },
    getPrefferedImageWidth: function () {
        return this._settings.getPanoImageResolution()._width
    },
    getPrefferedColorMode: function () {
        return this._settings.getColorMode()
    },
    getMovementSpeed: function () {
        return this._settings._movementSpeed
    },
    isWebGlEnabled: function () {
        return F.isWebGlAvailable() && this._settings._enableWebGl
    },
    invertX: function (e) {
        return e.isIn3dMode() ? 1 : -1
    },
    invertY: function (e) {
        return e.isIn3dMode() ? 1 : -1
    },
    details3d: function () {
        return this._settings.details3d()
    }
}, WS.extend("PanoSettingService", "PlugModule"), WS.PickAllListener = function (e, t, i, n) {
    WS.PickObjectListener.call(this, e, WS.PickObjectListener.SelectionMode.Menu, t, i), this._point3dService = n
}, WS.PickAllListener.prototype = {
    onPickPoint: function (e, t, i, n) {
        this._view.hideRadialMenu();
        var r = new WS.Point3d(i, [e, t], this.getRefSystem(), this._view, n);
        this._point3dService.setPoint(r)
    }
}, WS.extend("PickAllListener", "PickObjectListener"), WS.PickPointOpenScansListener = function (e, t, i) {
    WS.PickObjectListener.call(this, e, WS.PickObjectListener.SelectionMode.Menu, t, i)
}, WS.PickPointOpenScansListener.prototype = {
    onPickPoint: function (e, t, i, n) {
        var r = new WS.Point3d(i, [e, t], this.getRefSystem(), this._view, n);
        this._view.trigger("pickPoint", [r])
    }
}, WS.extend("PickPointOpenScansListener", "PickObjectListener"), WS.PanoMoveHandler = function (e, t, i) {
    WS.MoveHandler.call(this, e, t, i)
}, WS.PanoMoveHandler.prototype = {
	onDragStart: function(){
		//pause rotation 3s
		clearInterval(myVar);
		clearInterval(myVar3);
	},
    onDragMove: function (e, t, i, n) {
	    

        var r = i - e,
            o = n - t,
            a = this.determineRotationDeltas(r, o);
        if (0 !== a[0]) {
            var s = this._settingService.invertX(this._camera);
            this._camera.rotateHorizontally(s * a[0])
        }
        if (0 !== a[1]) {
            var c = this._settingService.invertY(this._camera);
            this._camera.rotateVertically(c * a[1])
        }
        return !0
    },
	onDragStop: function(){
		//pause rotation 3s
			myVar3 = setInterval("exitpause()",3000);

	}
}, WS.extend("PanoMoveHandler", "MoveHandler"), angular.module("ws.panoramaview", []), F.DI().config("@task", "@alert", "@project", "@pointcloud", "@panosettings", function (e, t, i, n, r) {
    this.registerParameter("panomenu", {
        evaluate: {
            edit: function (t) {
                return !t._writeLock && !t._temporary && ("Annotation" === t._class || "Measurement" === t._class || "Scan" === t._class || "Orthophoto" === t._class) && e.taskExists("default", "panoramaview", "edit")
            },
            remove: function (t) {
                return !t._writeLock && ("Annotation" === t._class || "Measurement" === t._class || "Orthophoto" === t._class) && e.taskExists("default", "panoramaview", "remove")
            },
            showproperties: function (e) {
                return "Annotation" === e._class || "Measurement" === e._class || "Scan" === e._class || "Orthophoto" === e._class
            },
            panorama: function (e) {
                return i.canShowObjectInPano(e)
            },
            view3d: function (e) {
                return r.isWebGlEnabled() ? n.canShowObjectIn3d(e) : !1
            },
            map: function (e) {
                return i.canShowObjectInMap(e)
            },
            switchsegments: function (e) {
                return "Measurement" === e._class && "Distance" === e._displayType
            },
            share: function (t) {
                return !t._writeLock && !t._temporary && ("Annotation" === t._class || "Measurement" === t._class || "Scan" === t._class || "Orthophoto" === t._class) && e.taskExists("default", "panoramaview", "share")
            }
        },
        execute: {
            edit: function (e) {
                e.select(), window.pv.trigger("launchTask", ["default", "panoramaview", "edit"])
            },
            remove: function (e) {
                return e.remove()
            },
            showproperties: function (e) {
                window.pv.trigger("showObjects", [
                    [e], "properties"
                ])
            },
            panorama: function (e) {
                switch (e._class) {
                    case "Scan":
                        window.pv.trigger("showObjects", [
                            [e], "panorama"
                        ]);
                        break;
                    case "Annotation":
                    case "Measurement":
                    case "Orthophoto":
                        window.pv.trigger("focusOn", [{
                            object: e
                        }, "panorama"])
                }
            },
            view3d: function (e) {
                switch (e._class) {
                    case "Scan":
                        window.pv.trigger("showObjects", [
                            [e], "3d"
                        ]);
                        break;
                    case "Annotation":
                    case "Measurement":
                    case "Orthophoto":
                        window.pv.trigger("focusOn", [{
                            object: e
                        }, "3d"])
                }
            },
            map: function (e) {
                window.pv.trigger("focusOn", [{
                    object: e
                }, "map"])
            },
            switchsegments: function (e) {
                var t = window.pv.getRenderable(e);
                t && t.switchSegmentMode()
            },
            share: function (e) {
                e.select(), window.pv.trigger("launchTask", ["default", "panoramaview", "share"])
            },
            unhighlight: function (e) {
                window.pv.unhighlight(e)
            }
        },
        error: function (e) {
            t.errorObj(e)
        }
    })
}), F.DI().registerController("panoramaview", WS.PanoramaView, "@plug", "@url", "@selection", "@alert", "@project", "@scan", "@annotation", "@measurement", "@tempmeasurement", "@orthophoto", "@temporthophoto", "@panosettings", "@domainsettings", "@login", "@unit", "@distance", "@locale", "@point3d", "@layer", "@mapobject", "@pointcloud"), F.DI().registerController("viewmodectrl", WS.ViewModeCtrl, "@pointcloud", "@panosettings", "@plug"), F.DI().registerService("panosettings", WS.PanoSettingService, "@plug", "@cookie"), F.DI().config("@task", WS.panoramaConfigTask = function (e) {
    e.registerTaskFactory("default", "settings", "editpanosettings", WS.EditPanoSettingsTask, "@plug", "@unit", "@locale")
}), F.DI().config(function () {
    var e = !1,
        t = !1,
        i = function () {
            return window.pv._pointsRenderable
        },
        n = function () {
            window.pv._camera._dirty = !0
        };
    window.LOD = {
        object: function () {
            var e = i();
            return e ? e._dataObject : void 0
        },
        renderable: function () {
            return i()
        },
        visLOD: function () {
            t ? e ? t = !1 : e = !0 : e ? e = !1 : t = !0;
            var r = i();
            r && r.instanceOf(WS.PointCloudRenderable) && (r.dbgShowLod(e), r.dbgShowBBoxes(t), n())
        },
        stats: function () {
            var e = window.pv.$scope.dbgStats;
            window.pv.$scope.$apply(function () {
                e.show = !e.show
            })
        },
        camFreeze: function () {
            var e = i();
            if (e) {
                var t = window.pv,
                    n = t._camera;
                e._dbgFreezeCam = new WS.PerspectiveCamera, e._dbgFreezeCam.copyFrom(t._camera), t.addRenderable(new WS.CameraRenderable(t)), n.setNearAndFarPlane(void 0, n._far + 1e3)
            }
        },
        camUnfreeze: function () {
            var e = i();
            if (e) {
                var t = window.pv,
                    n = t._camera;
                n.setNearAndFarPlane(void 0, n._far - 1e3);
                for (var r = t.getAllRenderables(), o = 0, a = r.length; a > o; ++o)
                    if (r[o] instanceof WS.CameraRenderable) {
                        t.removeRenderable(r[o]);
                        break
                    }
                e._dbgFreezeCam = void 0
            }
        },
        camReset: function () {
            var e = i();
            if (e) {
                var t = window.pv,
                    n = t._camera,
                    r = n._far;
                n.copyFrom(e._dbgFreezeCam), n.setNearAndFarPlane(void 0, r)
            }
        },
        moveNormal: function () {
            var e = i();
            e && (e._dbgMove = 0)
        },
        moveAlways: function () {
            var e = i();
            e && (e._dbgMove = 1)
        },
        moveNever: function () {
            var e = i();
            e && (e._dbgMove = 2)
        },
        printNodes: function () {
            var e = i();
            e && (e._debugDlVisNodes = !0)
        },
        setDepthRange: function (e, t) {
            var r = i();
            r && (r._minDepth = e, r._maxDepth = t, n())
        },
        setBestNodes: function (e) {
            var t = i();
            t && (t._bestNodes = e, n())
        },
        setSubTree: function (e) {
            var t = i();
            t && (t._dbgSubtree = e, n())
        },
        showFrameBuffer: function (e) {
            var t = i();
            t && (t._occlusionFrameBuffer._dbgImage = void 0 !== e ? e : !0)
        },
        gapFiller: function (e) {
            var t = i();
            t && (t.useIncrRendering = e ? WS.PointCloudRenderable.prototype.useIncrRendering : function () {
                return !1
            }, window.pv._renderer[0]._dbgGapFillAll = 2 === e, n())
        }
    }
}), angular.module("ws.panoramaview").directive("panoramaview", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("panoramaview"),
        link: function (e, t) {
            var i = e.ctrl,
                n = t.find("canvas");
            i.setCanvas(n), i.createRenderers(), e.$on("ws_connect", function (e, t) {
                e.stopPropagation(), i.setViewModeCtrl(t)
            })
        },
        templateUrl: WS.partialUrl("panoramaview.html")
    })
}), angular.module("ws.panoramaview").directive("viewmodectrl", function () {
    return {
        restrict: "E",
        replace: !1,
        controller: F.DI().getAngularController("viewmodectrl"),
        link: function (e) {
            e.$emit("ws_connect", e._ctrl)
        },
        scope: {
            changeViewMode: "&",
            small: "="
        },
        templateUrl: WS.partialUrl("viewmodectrl.html")
    }
}), WS.EditPanoSettingsTask = function (e, t, i) {
    WS.Task.call(this, e), this._unit = t, this._locale = i, this._description = [{
        caption: "TC_PANO_SETTINGS",
        optional: !0,
        description: "TD_PANO_SETTINGS",
        selectPageClass: "panosettings",
        completeCondition: "areLayerVisibilityThresholdsValid()",
        female: "ObjectEdit",
        pinBinding: "editObject(input.data)",
        widget: '<p ng-show="anyUnsavedChanges()"><b>{{"TD_CHANGES"|i18n}}:</b></p><ul><li ng-show="input.data.settings._changes._imageResolutionIndex != input.data.settings._imageResolutionIndex">{{formatImageResolutionOutput( input.data.settings._changes._imageResolutionIndex)}}</li><li ng-show="input.data.settings._changes._colorMode != input.data.settings._colorMode">{{formatColorMode(input.data.settings._changes._colorMode)}}</li><li ng-show="input.data.settings._changes._iconMode != input.data.settings._iconMode">{{formatIconMode(input.data.settings._changes._iconMode)}}</li><li ng-show="input.data.settings._changes._movementSpeed!= input.data.settings._movementSpeed">{{ formatMovementSpeed(input.data.settings._changes._movementSpeed)}}</li><li ng-show="input.data.settings._changes._blendFactor!= input.data.settings._blendFactor">{{ formatBlendFactor(input.data.settings._changes._blendFactor)}}</li><li ng-show="input.data.settings._changes._showCompass!= input.data.settings._showCompass">{{ formatShowCompass(input.data.settings._changes._showCompass)}}</li><li ng-show="input.data.settings._changes._showScanLabelsInPano !== input.data.settings._showScanLabelsInPano">{{ formatShowScanLabels(input.data.settings._changes._showScanLabelsInPano)}}</li><li ng-show="input.data.settings._changes._showPolylines !== input.data.settings._showPolylines">{{"FE_ANNOTATION" | i18n}} {{ formatShowPolylines(input.data.settings._changes._showPolylines)}}</li><li ng-show="input.data.settings._changes._showOrthoVolumes !== input.data.settings._showOrthoVolumes">{{"FE_ORTHOPHOTO" | i18n}} {{ formatShowOrthoVolumes(input.data.settings._changes._showOrthoVolumes)}}</li><li ng-show="input.data.settings._changes._details3d !== input.data.settings._details3d">{{"FE_3D_DETAILS" | i18n}}: {{ formatDetails3d(input.data.settings._changes._details3d)}}</li><li ng-repeat="layer in input.data.layers" ng-show="layer.hasUnsavedChanges()">{{layer.getName() | i18n}}<ul><li ng-show="layer._changes._visible != layer._visible">{{formatLayerVisibilityOutput(layer._changes._visible)}}</li><li ng-show="(layer._changes._visibleDistanceThresEnabled != layer._visibleDistanceThresEnabled) ||(layer._changes._visibleDistanceThres != layer._visibleDistanceThres)">{{formatLayerVisibilityThresOutput(layer._changes._visibleDistanceThresEnabled, layer._changes._visibleDistanceThres)}}</li></ul></li><li ng-show="input.data.settings._changes._enableWebGl != input.data.settings._enableWebGl">{{formatWebGlEnabled(input.data.settings._changes._enableWebGl)}}</li></ul>',
        icon: WS.Icons.TaskSection.configure
    }]
}, WS.EditPanoSettingsTask.prototype = {
    setup: function (e) {
        var t = this._unit,
            i = this._locale;
        e.formatLayerVisibilityOutput = function (e) {
            return void 0 === e ? "" : i.translate(e ? "FE_VISBLE" : "FE_INVISBLE")
        }, e.formatLayerVisibilityThresOutput = function (e, n) {
            if (void 0 === e && void 0 === n) return "";
            var r = t.getLengthAndUnit(n, 0);
            return e ? i.translateAndCompose("FE_PANO_SET_LIMIT_VIS_CHNG", [r]) : i.translate("FE_PANO_SET_NOLIMIT_VIS_CHNG")
        }, e.formatImageResolutionOutput = function (e) {
            if (void 0 === e) return "";
            var t = WS.PanoSettings.Resolutions[e];
            return i.translateAndCompose("FE_PANO_SET_IMAGE_CHANGE", [i.translate(t.getName())])
        }, e.formatColorMode = function (e) {
            if (void 0 === e) return "";
            var t = WS.PanoSettings.ColorModes[e];
            return i.translateAndCompose("FE_PANO_SET_CMODE_CHANGE", [i.translate(t.getName())])
        }, e.formatIconMode = function (e) {
            return void 0 === e ? "" : i.translateAndCompose("FE_ICONMODE_CHANGE", [i.translate(WS.PanoSettings.IconModeNames[e])])
        }, e.formatMovementSpeed = function (e) {
            return void 0 === e ? "" : (e = 5 * e + "%", i.translateAndCompose("FE_PANO_SET_MSPD_CHANGE", [e]))
        }, e.formatBlendFactor = function (e) {
            if (void 0 === e) return "";
            e = 100 * e;
            var t = i.translate("FE_COLOR"),
                n = i.translate("FE_GRAY");
            return e + "% " + t + " | " + (100 - e) + "% " + n
        }, e.formatWebGlEnabled = function (e) {
            if (void 0 === e) return "";
            var t = i.translate(e ? "FE_ENABLED" : "FE_DISABLED"),
                n = i.translateAndCompose("FE_PANO_SET_WEBGL_CHANGE", [t]);
            return n
        }, e.formatShowCompass = function (e) {
            if (void 0 === e) return "";
            var t = i.translate(e ? "FE_ENABLED" : "FE_DISABLED"),
                n = i.translateAndCompose("FE_PANO_SET_COMPASS_CHANGE", [t]);
            return n
        }, e.formatShowScanLabels = function (e) {
            if (void 0 === e) return "";
            var t = i.translate("FE_SCAN_NAME"),
                n = i.translate(e ? "FE_ENABLED" : "FE_DISABLED");
            return t + ": " + n
        }, e.formatShowOrthoVolumes = function (e) {
            var t = i.translate("FE_VOLUME"),
                n = i.translate(e ? "FE_VISBLE" : "FE_INVISBLE");
            return t + ": " + n
        }, e.formatShowPolylines = function (e) {
            var t = i.translate("AN_AREA"),
                n = i.translate(e ? "FE_VISBLE" : "FE_INVISBLE");
            return t + ": " + n
        }, e.formatDetails3d = function (e) {
            var t, n;
            return e && (t = WS.PanoSettings.details3dStringID(e), n = i.translate(t), e === WS.PanoSettings.Detail3d.AUTOMATIC && (t = WS.PanoSettings.details3dStringID(WS.PanoSettings.autoDetails3d()), n += " (" + i.translate(t) + ")")), n
        }, e.anyUnsavedChanges = function () {
            var t = e.input ? e.input.data : void 0,
                i = t ? t.layers : void 0,
                n = t ? t.settings : void 0;
            if (i)
                for (var r = 0, o = i.length; o > r; r++)
                    if (i[r].hasUnsavedChanges()) return !0;
            return n && n.hasUnsavedChanges() ? !0 : !1
        }, e.areLayerVisibilityThresholdsValid = function () {
            var t = e.input ? e.input.data : void 0,
                i = t ? t.layers : void 0,
                n = 0;
            if (i)
                for (var r = 0, o = i.length; o > r; r++)
                    if (n = i[r]._changes._visibleDistanceThres, n && F.validateNumber(n)) return !1;
            return !0
        }
    },
    execute: function (e) {
        var t = Q.defer(),
            i = e ? e.data : void 0,
            n = i ? i.layers : void 0,
            r = i ? i.settings : void 0;
        if (n)
            for (var o = 0, a = n.length; a > o; o++) n[o].update();
        return r && (r._changes && r._changes._iconMode && (r._changes._iconMode = parseInt(r._changes._iconMode)), r.update()), t.resolve(), t.promise
    },
    teardown: function () {
        this._result._navigateTo = this._argument._lastPage
    },
    queryTaskLaunch: function (e, t, i) {
        return e == this._panel && t == this._category.id && i == this._id
    }
}, WS.extend("EditPanoSettingsTask", "Task"), WS.PointCloud = function (e) {
    F.Transformation.call(this, e), this._pointCloudService = e, this._pointLoader = new WS.PointLoader(e, this), this._treeStructure = void 0, this._treeStructurePromise = void 0, this._treeStructureRequested = !1, this._class = "WSPointCloud", this._description = void 0, this._hyperlinks = [], this._creationTime = void 0, this._type = void 0, this._sourceUUIDs = void 0, this._sourceTypes = void 0, this._sourceRevisions = void 0, this._inputMin = void 0, this._inputMax = void 0, this._colorRatio = void 0, this._homogenization = void 0, this._resolution = void 0, this._state = void 0, this._dataMin = void 0, this._dataMax = void 0, this._points = void 0, this._depth = void 0, this._lodDepth = void 0, this._splitFactor = void 0, this._formatVersion = void 0, this._builderVersion = void 0, this._entityUUIDs = void 0
}, WS.PointCloud.prototype = {
    readJson: function (e) {
        F.Transformation.prototype.readJson.call(this, e), this.readHyperlinksJson(e), this._description = e.Description, this._creationTime = e.CreationTime, this._type = e.Type, this._sourceUUIDs = e.SourceUUIDs, this._sourceTypes = e.SourceTypes, this._sourceRevisions = e.SourceRevisions, this._inputMin = e.InputMin, this._inputMax = e.InputMax, this._colorRatio = e.ColorRatio, this._homogenization = e.Homogenization, this._resolution = e.Resolution, this._state = e.State, this._dataMin = e.DataMin, this._dataMax = e.DataMax, this._points = e.Points, this._depth = e.Depth, this._lodDepth = e.LodDepth, this._splitFactor = e.SplitFactor, this._formatVersion = e.FormatVersion, this._builderVersion = e.BuilderVersion, this._entityUUIDs = e.EntityUUIDs || void 0
    },
    writeJson: function () {
        var e = F.Transformation.prototype.writeJson.call(this);
        return this.writeHyperlinksJson(e), e.Class = this._class, e.Description = this._description, e.CreationTime = this._creationTime, e.Type = this._type, e.SourceUUIDs = this._sourceUUIDs, e.SourceTypes = this._sourceTypes, e.SourceRevisions = this._sourceRevisions, e.InputMin = this._inputMin, e.InputMax = this._inputMax, e.ColorRatio = this._colorRatio, e.Homogenization = this._homogenization, e.Resolution = this._resolution, e
    },
    writeChanges: function () {
        var e = F.Transformation.prototype.writeChanges.call(this);
        return this.writeHyperlinksChanges(e)
    },
    createRenderable: function (e) {
        return new WS.PointCloudRenderable(this, e, e._settingService.details3d())
    },
    canBeShownInView: function (e) {
        return "panorama" === e || "3d" === e
    },
    processNodes: function (e) {
        for (var t = {}, i = 0, n = e.length; n > i; i++) t[e[i]._shortID] = e[i];
        return t
    },
    getTreeStructure: function () {
        return this._treeStructure ? this._treeStructure : void(this._treeStructureRequested || this.getTreeStructureAsync())
    },
    getTreeStructureAsync: function () {
        if (!this._treeStructurePromise) {
            this._treeStructureRequested = !0;
            var e = this;
            this._treeStructurePromise = this._pointCloudService.getPointCloudNodes(this._UUID).then(function (t) {
                e._treeStructure = e.processNodes(t)
            })
        }
        return this._treeStructurePromise
    },
    unloadTreeStructure: function () {
        this._treeStructure = void 0, this._treeStructurePromise = void 0, this._treeStructureRequested = !1
    },
    getFirstNonEmptyNode: function () {
        for (var e = this._treeStructure, t = "r", i = e[t]; !i._points;) t += "0", i = e[t];
        return i
    },
    calcDefaultCamera: function () {
        var e, t = .5,
            i = .8,
            n = 1.25,
            r = 10,
            o = 130;
        if (this._treeStructure) {
            var a = this.getFirstNonEmptyNode();
            a && a._nodeInfo.positionArray && (e = a.calcCoordQuantiles([t, i]))
        }
        if (!e) {
            var s = this.getTranslationGlobal(),
                c = vec3.scale([.667, -.667, .333], r),
                l = vec3.add(s, c, vec3.create());
            return {
                camPos: l,
                lookAt: s
            }
        }
        var h = vec3.create(e[0]),
            d = vec3.create(e[1]),
            u = n * vec3.dist(h, d);
        u = Math.max(Math.min(u, o), r);
        var _ = .667 * u,
            p = vec3.create([_, -_, .5 * _]);
        return vec3.add(p, h, d), mat4.multiplyVec3(this._trafoGlobal, d), mat4.multiplyVec3(this._trafoGlobal, h), {
            camPos: d,
            lookAt: h
        }
    }
}, WS.extend("PointCloud", "Transformation"), WS.mixin("PointCloud", "HyperlinkedObject"), WS.PointCloud.State = {
    COMPLETE: "complete",
    PENDING: "pending"
}, WS.PointCloud.Type = {
    ENTITYPC: "EntityPC",
    PROJECT: "Project",
    SCAN: "Scan"
}, WS.PointCloud.ScanType = {
    SCAN: "Scan",
    VIRTUAL: "Virtual",
    PHOTO: "Photo"
}, WS.PointCloud.ColorRatio = {
    DEFAULT: 100,
    MIN: 0,
    MAX: 100
}, WS.PointCloud.Homogenization = {
    DEFAULT: .001,
    MIN: 1e-4,
    MAX: 1
}, WS.PointCloudNode = function () {
    this._class = "PointCloudNode", this._ID = void 0, this._points = void 0, this._min = void 0, this._max = void 0, this._q = void 0, this._version, this._builderVersion, this._compression, this._homogenization, this._depth, this._lodDepth, this._splitFactor, this._trafoGlobal, this._shortID = void 0, this._nodeInfo = new WS.NodeInfo
}, WS.PointCloudNode.prototype = {
    readJson: function (e) {
        this._class = e.Class, this._ID = e.ID, this._shortID = WS.PointCloudNode.getShortID(e.ID), this._points = e.Points, this._min = e.Min, this._max = e.Max, this._q = e.Q, "rt" === this._ID && (this._version = e.Version, this._builderVersion = e.BuilderVersion, this._compression = e.Compression, this._homogenization = e.Homogenization, this._depth = e.Depth, this._lodDepth = e.LodDepth, this._splitFactor = e.SplitFactor, this._trafoGlobal = e.TransformationGlobal)
    },
    writeJson: function () {
    },
    getCenter: function () {
        return [(this._min[0] + this._max[0]) / 2, (this._min[1] + this._max[1]) / 2, (this._min[2] + this._max[2]) / 2]
    },
    calcCoordQuantiles: function (e) {
        return F.calcQuantilesKd(this._nodeInfo.positionArray, e, 3)
    }
}, WS.extend("PointCloudNode"), WS.PointCloudNode.getShortID = function (e) {
    for (var t = "", i = 0; i < e.length; i += 2) {
        var n = i > 0 ? i + 1 : i;
        t += e.charAt(n)
    }
    return t
}, WS.PointCloudNode.MIN_PTS = 3e4, WS.PointCloudNode.MAX_PTS = 6e4, WS.PointCloudService = function (e, t, i, n, r, o, a, s, c, l) {
    F.ProjectCRUDService.call(this, "PointCloud", WS.PointCloud, "/pointcloud", {}, e, t, i, n, r, o, a, s, c);
    this._nodesClient = this._resource("/pointcloudnode/:project/:uuid", {}, {
        readAll: {
            method: "GET",
            params: {},
            isArray: !0
        }
    }), this._workerLauncher = new WS.WorkerLauncher(window.workerPath + "/pointloaderworker.js"), this._binaryBaseUrl = "", this._CDN = l, l.hasCDN() && i.subscribe("change", function () {
        var e = i.getCurrent();
        l.loadSignature(e)
    })
}, WS.PointCloudService.prototype = {
    getAll: function (e, t, i) {
        return WS._2GO ? Q.resolve([]) : WS.ProjectCRUDService.prototype.getAll.call(this, e, t, i)
    },
    getAllEnabled: function (e) {
        var t = this;
        return this._project.getCurrentProject().then(function (i) {
            return i._enable3D ? t.getAll(void 0, void 0, e) : []
        })
    },
    getAllEnabledCompleted: function (e) {
        return this.getAllEnabled(e).then(function (e) {
            return e.filter(function (e) {
                return "complete" === e._state
            })
        })
    },
    getByIDEnabled: function (e, t) {
        if (void 0 === e) return Q.resolve(void 0);
        var i = this;
        return this._project.getCurrentProject().then(function (n) {
            return n._enable3D ? i.getByID(e, t, !0) : void 0
        })
    },
    getByID: function (e, t, i) {
        return void 0 === e || WS._2GO ? Q.resolve(void 0) : F.ProjectCRUDService.prototype.getByID.call(this, e, t, i)
    },
    getAllForScan: function (e) {
        return this.getAllEnabled().then(function (t) {
            return t.filter(function (t) {
                return -1 !== t._sourceUUIDs.indexOf(e)
            })
        })
    },
    getBestForScan: function (e, t) {
        return this.getAll().then(function (i) {
            var n = function (e, t) {
                    return t._sourceUUIDs.length - e._sourceUUIDs.length
                },
                r = i.filter(function (i) {
                    return "complete" === i._state && (!t || i._type === t) && -1 !== i._sourceUUIDs.indexOf(e)
                });
            return r.length > 0 ? r.sort(n)[0] : i.filter(function (e) {
                return "complete" === e._state
            }).sort(n)[0]
        })
    },
    getBestForCoords: function (e, t) {
        return this.getAllEnabled().then(function (i) {
            var n = {},
                r = {},
                o = i.filter(function (e) {
                    return "complete" === e._state && (!t || e._type === t)
                });
            i = o[0] ? o : i.filter(function (e) {
                return "complete" === e._state
            }), i.forEach(function (t) {
                var i = mat4.invertOrtho(t._trafoGlobal, mat4.create()),
                    o = mat4.multiplyVec3(i, e, vec3.create()),
                    a = t._UUID,
                    s = t._dataMin,
                    c = t._dataMax,
                    l = vec3.lerp(s, c, .5, vec3.create());
                n[a] = o[0] > s[0] && o[0] < c[0] && o[1] > s[1] && o[1] < c[1] && o[2] > s[2] && o[2] < c[2] ? 1 : 0, r[a] = vec3.dist(l, o)
            });
            var a = function (e, t) {
                return n[e._UUID] !== n[t._UUID] ? n[t._UUID] - n[e._UUID] : r[e._UUID] - r[t._UUID]
            };
            return i.sort(a)[0]
        })
    },
    getBestForObject: function (e, t) {
        var i;
        if (e.instanceOf(WS.Scan)) return this.getBestForScan(e._UUID, t);
        if (e.instanceOf(WS.Annotation)) i = e._pointScans || [e._parentUUID];
        else if (e.instanceOf(WS.Measurement)) i = e._pointScans || [e._parentUUID];
        else {
            if (!e.instanceOf(WS.Orthophoto)) return Q.resolve(void 0);
            i = e._scanUUIDs
        }
        var n = this.compareByMatchAndSize(i);
        return this.getAllEnabled().then(function (e) {
            var i = e.filter(function (e) {
                return "complete" === e._state && (!t || e._type === t)
            }).sort(n);
            return i[0] ? i[0] : e.filter(function (e) {
                return "complete" === e._state
            }).sort(n)[0]
        })
    },
    compareByMatchAndSize: function (e) {
        return function (t, i) {
            var n = 0,
                r = 0;
            return e.forEach(function (e) {
                n += t._sourceUUIDs.indexOf(e) >= 0 ? 1 : 0, r += i._sourceUUIDs.indexOf(e) >= 0 ? 1 : 0
            }), n !== r ? r - n : i._sourceUUIDs.length - t._sourceUUIDs.length
        }
    },
    canShowObjectIn3d: function (e) {
        var t = this;
        return e.canBeShownInView("3d") ? this.getDefaultPointCloud().then(function (e) {
            return e ? !0 : t.isSimple3dEnabled()
        }) : Q.resolve(!1)
    },
    getProjectPointCloud: function (e) {
        var t = this;
        return this.getAllEnabled().then(function (i) {
            var n = i.filter(function (e) {
                return "complete" === e._state && (e._type === WS.PointCloud.Type.PROJECT || e._type === WS.PointCloud.Type.ENTITYPC)
            });
            return 0 < n.length ? n[0] : e ? t.getBestForScan(e) : void 0
        })
    },
    getLatestPointCloud: function (e) {
        var t = this;
        return this.getAllEnabled().then(function (i) {
            var n = i.filter(function (e) {
                return "complete" === e._state
            }).sort(function (e, t) {
                var i = e._creationTime,
                    n = t._creationTime;
                return n > i ? 1 : i > n ? -1 : 0
            });
            return 0 < n.length ? n[0] : e ? t.getBestForScan(e) : void 0
        })
    },
    getDefaultPointCloud: function (e) {
        return this.getLatestPointCloud(e)
    },
    getScanPointCloud: function (e, t) {
        var i = this;
        return this.getAllForScan(e).then(function (n) {
            var r = n.filter(function (e) {
                return "complete" === e._state && "Scan" === e._type
            });
            return 0 < r.length ? r[0] : t ? i.getBestForScan(e) : void 0
        })
    },
    getForScan: function (e, t, i) {
        return "Project" === t || "EntityPC" === t ? this.getProjectPointCloud(e) : "Scan" === t ? this.getScanPointCloud(e, !0) : "ScanCloud" === t ? Q.resolve(void 0) : this.getBestForScan(e, i)
    },
    getForFocusedObject: function (e, t, i, n, r) {
        var o = this;
        return this.getByIDEnabled(t).then(function (e) {
            return e
        }, function () {
            return void 0
        }).then(function (e) {
            return e ? e : i ? o.getForScan(i, n, r) : void 0
        }).then(function (t) {
            return t ? t : o.getBestForObject(e, r)
        })
    },
    hasProjectPointCloud: function () {
        return this.getProjectPointCloud().then(function (e) {
            return !!e
        }, function () {
            return !1
        })
    },
    hasScanPointCloud: function (e) {
        return this.getScanPointCloud(e).then(function (e) {
            return !!e
        }, function () {
            return !1
        })
    },
    isSimple3dEnabled: function () {
        return this._project.getCurrentProject().then(function (e) {
            return !(!e._simple3DEnabled || !e._enable3D)
        }, function () {
            return !1
        })
    },
    getPointCloudNodes: function (e) {
        var t = this,
            i = Q.defer(),
            n = {
                project: this._project.getCurrent(),
                uuid: e
            };
        return this._nodesClient.readAll(n, function (e) {
            i.resolve(e.map(F.proxy(t._serializer.read, t._serializer)))
        }, this._error.restHandler(i)), i.promise
    },
    getNodeBinary: function (e, t) {
        var i, n = e._UUID,
            r = e._entityUUIDs && e._entityUUIDs[0],
            o = this._project.getCurrent();
        this._CDN.hasCDN() && (i = this._CDN.getSignature(o, !0));
        var a;
        if (i && !Q.isPromise(i)) {
            var s = this._CDN.getSource(i, F.crc32(t));
            a = r ? s.BaseURL + o + "/entity/" + r + "/" + t + ".ptu" + s.Query : s.BaseURL + o + "/wspointclouds/" + n + "/" + t + ".ptu" + s.Query
        } else a = r ? this._binaryBaseUrl + "/entity/" + o + "/" + r + "/data/blob/" + t + ".ptu" : this._binaryBaseUrl + "/data/project/" + o + "/pointcloud/" + n + "/" + t;
        var c = {
            pointCloud: n,
            nodeName: t,
            url: a
        };
        this._workerLauncher.runWorker(c)
    }
}, WS.extend("PointCloudService", "ProjectCRUDService"), WS.PointLoader = function (e, t) {
    this._service = e, this._pc = t, this._addedNodes = !1, this._nodesInMemory = 0, this._pointsInMemory = 0, this._loadedNodes = {}, this._deferredNodes = {}, this._maxPointsInMemory = WS.PointLoader.MAX_POINTS_IN_MEMORY[WS.PanoSettings.Detail3d.VERY_HIGH], this._requestedNodes = [], this._requestedPoints = 0;
    var i = this;
    this._func = function (e) {
        i.completeRequest(e.data)
    }, this.addAsListener()
}, WS.PointLoader.prototype = {
    loadNodeBinary: function (e) {
        var t = this._requestedNodes;
        if (!(WS.PointLoader.MAX_PARALLEL_REQUESTS <= t.length || -1 < t.indexOf(e) || e._nodeInfo.failed)) {
            t.push(e), this._requestedPoints += e._points;
            try {
                this._service.getNodeBinary(this._pc, e._ID)
            } catch (i) {
                t.pop(), this._requestedPoints -= e._points
            }
        }
    },
    loadNodeBinaryAsync: function (e) {
        var t = e._shortID,
            i = this._deferredNodes[t];
        return i || (i = this._deferredNodes[t] = Q.defer(), this._loadedNodes[t] ? i.resolve() : e._nodeInfo.failed ? i.reject() : this.loadNodeBinary(e)), i.promise
    },
    completeRequest: function (e) {
        if (e.request.pointCloud === this._pc._UUID) {
            var t = F.removeFirst(this._requestedNodes, function (t) {
                    return t._ID === e.request.nodeName
                }),
                i = t && t._shortID;
            if (!e.loaded) return void(t && (t._nodeInfo.failed = !0, this._requestedPoints -= t._points, this._deferredNodes[i] && this._deferredNodes[i].reject()));
            if (t) {
                var n = t._nodeInfo;
                for (var r in e) "request" !== r && (n[r] = e[r]);
                this._nodesInMemory++, this._pointsInMemory += t._points, this._requestedPoints -= t._points, this._loadedNodes[i] = t, this._deferredNodes[i] && this._deferredNodes[i].resolve(), this._addedNodes = !0
            }
        }
    },
    unloadNode: function (e) {
        this._nodesInMemory--, this._pointsInMemory -= e._nodeInfo.numPoints, delete this._loadedNodes[e._shortID]
    },
    unloadAll: function () {
        for (var e in this._deferredNodes) this._deferredNodes[e].promise.isPending() && this._deferredNodes[e].reject(), delete this._deferredNodes[e];
        this.cancelRequests(), this._nodesInMemory = 0, this._pointsInMemory = 0, this._addedNodes = !1, this._loadedNodes = {}
    },
    addAsListener: function () {
        this._service._workerLauncher.addListener(this._func)
    },
    removeAsListener: function () {
        this._service._workerLauncher.removeListener(this._func)
    },
    cancelRequests: function () {
        for (var e in this._deferredNodes) this._deferredNodes[e].promise.isPending() && (this._deferredNodes[e].reject(), delete this._deferredNodes[e]);
        this._requestedPoints = 0, this._requestedNodes = []
    }
}, WS.extend("PointLoader"), WS.PointLoader.MAX_PARALLEL_REQUESTS = 10, WS.PointLoader.MAX_POINTS_IN_MEMORY = {
    VeryLow: 3e6,
    Low: 8e6,
    Medium: 1e7,
    High: 15e6,
    VeryHigh: 2e7
}, WS.PointCloudMoveHandler = function (e, t, i) {
    WS.MoveHandler.call(this, e, t, i), this._forwardSpeed = 0, this._backwardSpeed = 0, this._leftSpeed = 0, this._rightSpeed = 0, this._upSpeed = 0, this._downSpeed = 0, this._rotLeftSpeed = 0, this._rotRightSpeed = 0, this._rotUpSpeed = 0, this._rotDownSpeed = 0, this._zoomPlusSpeed = 0, this._zoomMinusSpeed = 0, this._forwardTargetSpeed = 0, this._backwardTargetSpeed = 0, this._leftTargetSpeed = 0, this._rightTargetSpeed = 0, this._upTargetSpeed = 0, this._downTargetSpeed = 0, this._rotLeftTargetSpeed = 0, this._rotRightTargetSpeed = 0, this._rotUpTargetSpeed = 0, this._rotDownTargetSpeed = 0, this._zoomPlusTargetSpeed = 0, this._zoomMinusTargetSpeed = 0, this._turbo = 1, this._lastUpdate = void 0, this._isMovingByKey = !1, this._holdDiffY = 0, this._joystickVisible = !1, this._joystickHeight = 0
}, WS.PointCloudMoveHandler.prototype = {
    onDragMove: function (e, t, i, n, r) {
        var o = i - e,
            a = n - t;
        if (r === WS.MouseAdapter.Button.Left) {
            var s = this.determineRotationDeltas(o, a);
            if (0 !== s[0]) {
                var c = this._settingService.invertX(this._camera);
                this._camera.rotateHorizontally(c * s[0])
            }
            if (0 !== s[1]) {
                var l = this._settingService.invertY(this._camera);
                this._camera.rotateVertically(l * s[1])
            }
        } else r === WS.MouseAdapter.Button.Middle ? (0 !== o && this._camera.moveSideways(o * WS.PointCloudMoveHandler.PAN_SPEED), 0 !== a && this._camera.moveVertical(a * WS.PointCloudMoveHandler.PAN_SPEED)) : r === WS.MouseAdapter.Button.Right && 0 !== a && this._camera.moveForward(a * WS.PointCloudMoveHandler.MOVE_SPEED);
        return !0
    },
    getNowMillis: function () {
        return Date.now()
    },
    update: function () {
        if (void 0 === this._lastUpdate) return this._lastUpdate = this.getNowMillis(), void(this._isMovingByKey = !1);
        var e = (this.getNowMillis() - this._lastUpdate) / 1e3;
        this.updateKeys(e), this.updateJoystick(e), this._lastUpdate = this.getNowMillis()
    },
    updateKeys: function (e) {
        var t, i, n, r = WS.PointCloudMoveHandler.ACCELERATION * e,
            o = 1 - r,
            a = WS.PointCloudMoveHandler.METERS_PER_SECOND * e * this._turbo,
            s = 2 * r,
            c = 1 - s;
        this._forwardTargetSpeed !== this._forwardSpeed && (this._forwardSpeed = this._forwardSpeed * o + this._forwardTargetSpeed * r, this._forwardSpeed < .01 && (this._forwardSpeed = 0)), 0 !== this._forwardSpeed && this._camera.moveForward(this._forwardSpeed * a), this._backwardTargetSpeed !== this._backwardSpeed && (this._backwardSpeed = this._backwardSpeed * o + this._backwardTargetSpeed * r, this._backwardSpeed < .01 && (this._backwardSpeed = 0)), 0 !== this._backwardSpeed && this._camera.moveForward(-this._backwardSpeed * a), this._leftTargetSpeed !== this._leftSpeed && (this._leftSpeed = this._leftSpeed * o + this._leftTargetSpeed * r, this._leftSpeed < .01 && (this._leftSpeed = 0)), 0 !== this._leftSpeed && this._camera.moveSideways(-this._leftSpeed * a), this._rightTargetSpeed !== this._rightSpeed && (this._rightSpeed = this._rightSpeed * o + this._rightTargetSpeed * r, this._rightSpeed < .01 && (this._rightSpeed = 0)), 0 !== this._rightSpeed && this._camera.moveSideways(this._rightSpeed * a), this._upTargetSpeed !== this._upSpeed && (this._upSpeed = this._upSpeed * o + this._upTargetSpeed * r, this._upSpeed < .01 && (this._upSpeed = 0)), 0 !== this._upSpeed && this._camera.moveVertical(-this._upSpeed * a), this._downTargetSpeed !== this._downSpeed && (this._downSpeed = this._downSpeed * o + this._downTargetSpeed * r, this._downSpeed < .01 && (this._downSpeed = 0)), 0 !== this._downSpeed && this._camera.moveVertical(this._downSpeed * a), this._rotLeftTargetSpeed !== this._rotLeftSpeed && (this._rotLeftSpeed = this._rotLeftSpeed * c + this._rotLeftTargetSpeed * s, this._rotLeftSpeed < .01 && (this._rotLeftSpeed = 0)), 0 !== this._rotLeftSpeed && (t = this.determineRotationDeltas(WS.PointCloudMoveHandler.ROTATION_SPEED, 0), i = this._settingService.invertX(this._camera), this._camera.rotateHorizontally(i * this._rotLeftSpeed * e * t[0])), this._rotRightTargetSpeed !== this._rotRightSpeed && (this._rotRightSpeed = this._rotRightSpeed * c + this._rotRightTargetSpeed * s, this._rotRightSpeed < .01 && (this._rotRightSpeed = 0)), 0 !== this._rotRightSpeed && (t = this.determineRotationDeltas(WS.PointCloudMoveHandler.ROTATION_SPEED, 0), i = this._settingService.invertX(this._camera), this._camera.rotateHorizontally(i * -this._rotRightSpeed * e * t[0])), this._rotUpTargetSpeed !== this._rotUpSpeed && (this._rotUpSpeed = this._rotUpSpeed * c + this._rotUpTargetSpeed * s, this._rotUpSpeed < .01 && (this._rotUpSpeed = 0)), 0 !== this._rotUpSpeed && (t = this.determineRotationDeltas(0, WS.PointCloudMoveHandler.ROTATION_SPEED), n = this._settingService.invertY(this._camera), this._camera.rotateVertically(n * this._rotUpSpeed * e * t[1])), this._rotDownTargetSpeed !== this._rotDownSpeed && (this._rotDownSpeed = this._rotDownSpeed * c + this._rotDownTargetSpeed * s, this._rotDownSpeed < .01 && (this._rotDownSpeed = 0)), 0 !== this._rotDownSpeed && (t = this.determineRotationDeltas(0, WS.PointCloudMoveHandler.ROTATION_SPEED), n = this._settingService.invertY(this._camera), this._camera.rotateVertically(n * -this._rotDownSpeed * e * t[1])), this._zoomPlusTargetSpeed !== this._zoomPlusSpeed && (this._zoomPlusSpeed = this._zoomPlusSpeed * c + this._zoomPlusTargetSpeed * s, this._zoomPlusSpeed < .01 && (this._zoomPlusSpeed = 0)), 0 !== this._zoomPlusSpeed && this._camera.changeFOVY(-this._zoomPlusSpeed * e, 2), this._zoomMinusTargetSpeed !== this._zoomMinusSpeed && (this._zoomMinusSpeed = this._zoomMinusSpeed * c + this._zoomMinusTargetSpeed * s, this._zoomMinusSpeed < .01 && (this._zoomMinusSpeed = 0)), 0 !== this._zoomMinusSpeed && this._camera.changeFOVY(this._zoomMinusSpeed * e, 2);
        var l = 0 !== this._forwardSpeed || 0 !== this._backwardSpeed || 0 !== this._leftSpeed || 0 !== this._rightSpeed || 0 !== this._upSpeed || 0 !== this._downSpeed || 0 !== this._rotLeftSpeed || 0 !== this._rotRightSpeed || 0 !== this._rotUpSpeed || 0 !== this._rotDownSpeed || 0 !== this._zoomPlusSpeed || 0 !== this._zoomMinusSpeed;
        !this._isMovingByKey && l ? this.startMove() : this._isMovingByKey && !l && this.endMove(), this._isMovingByKey = l
    },
    onForwardPress: function () {
        return this._forwardTargetSpeed = 1, !0
    },
    onBackwardPress: function () {
        return this._backwardTargetSpeed = 1, !0
    },
    onLeftPress: function () {
        return this._leftTargetSpeed = 1, !0
    },
    onRightPress: function () {
        return this._rightTargetSpeed = 1, !0
    },
    onUpPress: function () {
        return this._upTargetSpeed = 1, !0
    },
    onDownPress: function () {
        return this._downTargetSpeed = 1, !0
    },
    onJPress: function () {
        return this._rotLeftTargetSpeed = 1, !0
    },
    onLPress: function () {
        return this._rotRightTargetSpeed = 1, !0
    },
    onIPress: function () {
        return this._rotUpTargetSpeed = 1, !0
    },
    onKPress: function () {
        return this._rotDownTargetSpeed = 1, !0
    },
    onPlusPress: function () {
        return this._zoomPlusTargetSpeed = WS.PointCloudMoveHandler.ZOOM_SPEED, !0
    },
    onMinusPress: function () {
        return this._zoomMinusTargetSpeed = WS.PointCloudMoveHandler.ZOOM_SPEED, !0
    },
    onShiftPress: function () {
        return this._turbo = WS.PointCloudMoveHandler.TURBO_SPEED, !0
    },
    onForwardRelease: function () {
        return this._forwardTargetSpeed = 0, !0
    },
    onBackwardRelease: function () {
        return this._backwardTargetSpeed = 0, !0
    },
    onLeftRelease: function () {
        return this._leftTargetSpeed = 0, !0
    },
    onRightRelease: function () {
        return this._rightTargetSpeed = 0, !0
    },
    onUpRelease: function () {
        return this._upTargetSpeed = 0, !0
    },
    onDownRelease: function () {
        return this._downTargetSpeed = 0, !0
    },
    onJRelease: function () {
        return this._rotLeftTargetSpeed = 0, !0
    },
    onLRelease: function () {
        return this._rotRightTargetSpeed = 0, !0
    },
    onIRelease: function () {
        return this._rotUpTargetSpeed = 0, !0
    },
    onKRelease: function () {
        return this._rotDownTargetSpeed = 0, !0
    },
    onPlusRelease: function () {
        return this._zoomPlusTargetSpeed = 0, !0
    },
    onMinusRelease: function () {
        return this._zoomMinusTargetSpeed = 0, !0
    },
    onShiftRelease: function () {
        return this._turbo = 1, !0
    },
    onDblClick: function (e, t, i, n) {
        if (i !== F.MouseAdapter.Button.Left) return !1;
        var r = this.pickPoint(e, t, n ? 9 : 5);
        if (!r || !r[3]) return !1;
        var o = r[2];
        return this.flyToTarget(o), !0
    },
    flyToTarget: function (e) {
        var t = this._view._cameraAnimator;
        if (!t.isAnimating()) {
            var i = this._view._trafoView,
                n = this._camera,
                r = n.getGlobalPos(i),
                o = n.getPhi(),
                a = n.getTheta(),
                s = this.calcGoodDistToCam(r, e),
                c = vec3.subtract(r, e, vec3.create());
            vec3.normalize(c), vec3.scale(c, s), vec3.add(c, e);
            var l = new WS.PerspectiveCamera;
            l.copyFrom(n), l.setFromGlobalPos(c, i), l.lookAt(e, i);
            var h = l.getPhi(),
                d = l.getTheta(),
                u = 2 * t.calcGoodDuration(r, c, o, h, a, d);
            u > 0 && (t.startAnimation(n, u, i, c, h, d), this._view.hideRadialMenu())
        }
    },
    calcGoodDistToCam: function (e, t) {
        var i = vec3.dist(e, t);
        return 8 >= i ? Math.max(this._camera._near + .01, i / 4) : 32 >= i ? 2 + (i - 8) / 24 : 3 + (i - 32) / 50
    },
    onHoldStart: function (e, t) {
        this._holdDiffY = 0;
        var i = this.calculateJoystick(e, t);
        return this._joystickVisible = i[0], this._joystickHeight = i[3], this._joystickVisible && (this._view.showJoystick(i[1], i[2], this._joystickHeight), this.startMove()), !0
    },
    onHoldMove: function (e, t, i, n, r, o) {
        return this._joystickVisible && (this._holdDiffY = o - t, this._view.updateJoystick(e, t)), !0
    },
    onHoldStop: function () {
        return this._joystickVisible && (this.endMove(), this._view.hideJoystick()), this._holdDiffY = 0, this._joystickVisible = !1, this._joystickHeight = 0, !0
    },
    updateJoystick: function (e) {
        if (this._joystickVisible && WS.PointCloudMoveHandler.JOYSTICK_DEAD_ZONE < Math.abs(this._holdDiffY)) {
            var t = Math.floor(this._joystickHeight / 2),
                i = Math.max(-t, Math.min(t, this._holdDiffY)) / t,
                n = (i > 0 ? 1 : -1) * Math.pow(Math.abs(i), WS.PointCloudMoveHandler.JOYSTICK_POWER);
            if (this._joystickHeight < WS.PointCloudMoveHandler.JOYSTICK_MEDIUM_HEIGHT) {
                var r = WS.PointCloudMoveHandler.JOYSTICK_MEDIUM_HEIGHT - WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT,
                    o = this._joystickHeight - WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT,
                    a = 1 - o / r,
                    s = .4,
                    c = 1 - a * s;
                n = Math.max(-c, Math.min(c, n))
            }
            var l = n * WS.PointCloudMoveHandler.JOYSTICK_METERS_PER_SECOND * e;
            this._camera.moveForward(l)
        }
    },
    calculateJoystick: function (e, t) {
        var i = WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF,
            n = WS.PointCloudMoveHandler.JOYSTICK_DIST_TO_BORDER;
        e = Math.max(i + n, Math.min(this._view._width - 1 - i - n, e));
        var r = Math.floor(WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT / 2),
            o = r + i + n;
        if (o > t || this._view._height - o < t) return [!1, e, t, 0];
        var a = WS.PointCloudMoveHandler.JOYSTICK_MAX_HEIGHT,
            s = Math.floor(a / 2),
            c = s + i;
        if (c > t) a = 2 * (t + 1 - i) - 1 - 2 * n;
        else if (this._view._height - 1 - c < t) {
            var l = this._view._height - t;
            a = 2 * (l + 1 - i) - 1 - 2 * n
        }
        return [!0, e, t, a]
    }
}, WS.extend("PointCloudMoveHandler", "MoveHandler"), WS.PointCloudMoveHandler.ACCELERATION = 5, WS.PointCloudMoveHandler.METERS_PER_SECOND = 4, WS.PointCloudMoveHandler.PAN_SPEED = .01, WS.PointCloudMoveHandler.MOVE_SPEED = .025, WS.PointCloudMoveHandler.ROTATION_SPEED = 667, WS.PointCloudMoveHandler.ZOOM_SPEED = 50, WS.PointCloudMoveHandler.TURBO_SPEED = 5, WS.PointCloudMoveHandler.JOYSTICK_POWER = 1.4, WS.PointCloudMoveHandler.JOYSTICK_METERS_PER_SECOND = 15, WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT = 101, WS.PointCloudMoveHandler.JOYSTICK_MEDIUM_HEIGHT = 251, WS.PointCloudMoveHandler.JOYSTICK_MAX_HEIGHT = 401, WS.PointCloudMoveHandler.JOYSTICK_DIST_TO_BORDER = 5, WS.PointCloudMoveHandler.JOYSTICK_DEAD_ZONE = 9, WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF = 34, WS.NodeInfo = function () {
    this.loaded = !1, this.failed = !1, this.numPoints = 0, this.lastUse = null, this.visible = !1, this.hq = !1, this.positionArray = null, this.colorArray = null, this.depth = null, this.camDistance = null, this.centerDistance = null, this.centerBonus = null, this.rating = null, this.lod = null
}, WS.NodeInfo.prototype = {
    unload: function () {
        this.positionArray = null, this.colorArray = null, this.loaded = !1, this.numPoints = 0
    }
}, WS.extend("NodeInfo"), WS.OcclusionFrameBuffer = function (e) {
    WS.FrameBuffer.call(this, e), this._countColorsBuf = void 0, this._dbgImage = !1
}, WS.OcclusionFrameBuffer.prototype = {
    readTextureIntoBuffer: function () {
        if (this._countColorsBuf = this.readTexture(0, 0, this._width, this._height), this._dbgImage) {
            this._dbgImage !== !0 && this._dbgImage--;
            var e = this._width,
                t = this._height,
                i = document.createElement("canvas");
            i.width = e, i.height = t;
            var n = i.getContext("2d");
            n.fillStyle = "rgba(0,0,0,0)", n.clearRect(0, 0, e, t);
            for (var r = n.getImageData(0, 0, e, t), o = this._countColorsBuf.length, a = 0; o > a; a++) r.data[a] = this._countColorsBuf[a];
            n.putImageData(r, 0, 0);
            var s = i.toDataURL(),
                c = console;
            c.log(s)
        }
    },
    countColorsForStartFrame: function (e, t, i) {
        for (var n = this._countColorsBuf, r = 0; i > r; r += 4)
            for (var o = r * t, a = 0; t > a; a += 4) {
                var s = 4 * (o + a);
                255 === n[s + 3] && (e[(n[s + 1] << 8) + n[s + 2]] += 16)
            }
        this._countColorsBuf = void 0
    },
    countColors: function (e) {
        for (var t = this._countColorsBuf, i = t.length - 3 + 1, n = 1; i > n; n += 4) 255 === t[n + 2] && e[(t[n] << 8) + t[n + 1]]++;
        this._countColorsBuf = void 0
    },
    abortCountColors: function () {
        this._countColorsBuf = void 0
    }
}, WS.extend("OcclusionFrameBuffer", "FrameBuffer"), WS.OcclusionRenderable = function (e, t, i, n, r) {
    var o = this.determineBufferData(e, t, i),
        a = new WS.Geometry;
    a._primitiveType = WS.Geometry.PrimitiveType.Triangles, a._indexBuffer = new WS.IndexBuffer(o[0]), a._positionBuffer = new WS.ArrayBuffer(o[1], 3);
    var s = new WS.ColorMaterial(new WS.ArrayBuffer(o[2], 4));
    s._depthTest = !0, s._depthWrite = !0, WS.Mesh.call(this, a, s), this.addToLayer(n), this._transform = r
}, WS.OcclusionRenderable.prototype = {
    updateBuffers: function (e, t, i) {
        var n = this.determineBufferData(e, t, i);
        this._geometry._indexBuffer.setBufferData(n[0]), this._geometry._positionBuffer.setBufferData(n[1]), this._material._colorBuffer.setBufferData(n[2])
    },
    determineBufferData: function (e, t, i) {
        for (var n = [], r = e.length, o = 8, a = WS.OcclusionRenderable.INDEX_ARRAY_FOR_BOX, s = 36, c = new Uint16Array(r * s), l = 0, h = 0; r > h; ++h)
            for (var d = h * o, u = 0; s > u; ++u) c[l++] = a[u] + d;
        n[0] = c;
        for (var _ = new Float32Array(r * o * 3), p = 0; r > p; p++)
            for (var g = e[p], f = .01 - g._shortID.length / i * .01, m = [g._min[0] - f, g._min[1] - f, g._min[2] - f], v = [g._max[0] + f, g._max[1] + f, g._max[2] + f], S = o - 1; S >= 0; --S) {
                var b = S % 2 >= 1 ? v[0] : m[0],
                    y = S % 4 >= 2 ? v[1] : m[1],
                    P = S % 8 >= 4 ? v[2] : m[2],
                    M = 3 * (8 * p + S);
                _[M] = b, _[M + 1] = y, _[M + 2] = P
            }
        n[1] = _;
        var w = new Float32Array(r * o * 4);
        l = 0;
        for (var C = 0; r > C; ++C)
            for (var T = t[C], W = 0; o > W; ++W) w[l++] = T[0], w[l++] = T[1], w[l++] = T[2], w[l++] = T[3];
        return n[2] = w, n
    }
}, WS.extend("OcclusionRenderable", "Mesh"), WS.OcclusionRenderable.INDEX_ARRAY_FOR_BOX = [0, 1, 3, 0, 3, 2, 5, 4, 6, 5, 6, 7, 4, 5, 1, 4, 1, 0, 2, 3, 7, 2, 7, 6, 4, 0, 2, 4, 2, 6, 1, 5, 7, 1, 7, 3], WS.PointCloudRenderable = function (e, t, i) {
    this.setDataObject(e), this._details3d = void 0, this._transform = e.calcTrafoInRefSystem(t._trafoView), this._transformInverse = mat4.invertOrtho(this._transform, mat4.create()), this._activated = !1, this._pointLoader = e._pointLoader, this._homogenization = e._homogenization, this._lodThreshMoving = void 0, this._moveHomogenization = void 0, this._view = t, this._alpha = 1, this._prIndex = {}, this._vrIndex = {}, this._prs = [], this._visiblePrs = [], this._pointBudgetMove = void 0, this._pointBudgetStill = void 0, this._nodeBudgetMove = void 0, this._nodeBudgetStill = 7054, this._minPixelStill = void 0, this._physicalFactorGF = void 0, this.updateDetailLevel(i, !0);
    var n = this._view._renderer[0],
        r = n._shaderProgramStorage;
    this._voronoi = n instanceof WS.Renderer3D && t.getGLExtension("EXT_frag_depth") && r.inquireShaderProgram(WS.VoronoiPointShaderDesc)._compiled;
    var o = this._voronoi ? WS.PointCloudRenderable.VORONOI_FACTOR : WS.PointCloudRenderable.SIZE_FACTOR;
    this._pointSize = {
        physical: this._homogenization * o,
        minPixel: 2,
        maxPixel: 40
    }, this._minDepth = void 0, this._maxDepth = void 0, this._lodLookupTable = [], this._hqMaxDistance = void 0, this._pickable3d = !0, this._visibleNodes = [], this._mvMatrix = mat4.create(), this._camPos = void 0, this._frustum = void 0, this._colorCountFrame = 0, this._colorArray = new Uint32Array(65536), this._shortIDToColor = {}, this._ratedAfterStart = !1, this._framesAfterStart = 0, this._ratedAndEnoughFrames = !1, this._panoTo3d = !1, this._inTransition = !1, this._inNewRestCycle = !1, this._ratingsContainingCamera = {}, this._occlusionRenderable = void 0, this._occlusionFrameBuffer = void 0, this._state = void 0, this._prevState = void 0, this._initializedTree = !1, this._now = void 0, this._last = void 0, this._numberOfScans = e._sourceTypes.length, this.addToLayer(WS.Layer.LayerIDs.POINT_CLOUD, !0), this._dbgShowLod = !1, this._dbgShowBBoxes = !1, this._dbgBBoxRenderables = {}, this._debugDlVisNodes = !1, this._dbgMove = 0, this._dbgSubtree = void 0, this._dbgFreezeCam = void 0, this._dbgLodColors = this.dbgGetLodColors()
}, WS.PointCloudRenderable.prototype = {
    assignPickColors: function (e) {
        for (var t = this, i = 0, n = this._visiblePrs.length; n > i; ++i) {
            var r = this._visiblePrs[i],
                o = e.assignColorToRenderable(t, r),
                a = [o[0] / 255, o[1] / 255, o[2] / 255, o[3] / 255];
            r.setPickColor(a)
        }
    },
    setPickColor: function () {
    },
    updateDetailLevel: function (e, t) {
        this._details3d = e, this._pointLoader._maxPointsInMemory = WS.PointLoader.MAX_POINTS_IN_MEMORY[e], this._pointBudgetMove = WS.PointCloudRenderable.BUDGET_MOVE[e], this._pointBudgetStill = WS.PointCloudRenderable.BUDGET_STILL[e], this._nodeBudgetMove = Math.ceil(.8 * this._pointBudgetMove / WS.PointCloudNode.MIN_PTS), t || this.unloadNodes(this._dbgFreezeCam || this._view._camera, !0);
        var i = !1,
            n = this._view._renderer[0];
        n instanceof WS.Renderer3D && (i = n.gapFillerEnabled()), this._minPixelStill = i ? 2 : 3, this._physicalFactorGF = i ? 1 : 2
    },
    activate: function () {
        if (this._activated = !0, this._pointLoader.addAsListener(), !this._occlusionFrameBuffer) {
            var e = this._view._renderer[0];
            this._occlusionFrameBuffer = e._frameBufferStorage.get("occlusion_" + this._id, WS.OcclusionFrameBuffer)
        }
        this.update()
    },
    deactivate: function () {
        var e = WS.PointCloudRenderable.State;
        if (this.abortRateResting(), this._panoTo3d = !1, this._inTransition = !1, this._inNewRestCycle = !1, (this._state === e.MOVE || this._state === e.REST_DRAW || this._state === e.REST_READ || this._state === e.REST_COUNT || this._state === e.REST_IDLE) && (this._state = e.START_IDLE), this._occlusionFrameBuffer) {
            var t = this._view._renderer[0];
            t instanceof WS.Renderer3D && t._frameBufferStorage.destroy("occlusion_" + this._id), this._occlusionFrameBuffer = void 0
        }
        this._pointLoader.cancelRequests(), this._pointLoader.removeAsListener(), this._pointLoader._addedNodes = !1, this._activated = !1
    },
    isActive: function () {
        return this._activated
    },
    unload: function (e) {
        e.deleteStorageForRenderableAndMembers(this), this._initializedTree = !1, this._prIndex = {}, this._vrIndex = {}, this._prs = [], this._visiblePrs = [], this._dbgBBoxRenderables = {}, this._lodLookupTable = [], this._visibleNodes = [], this._panoTo3d = !1, this._inTransition = !1, this._inNewRestCycle = !1, this._ratedAfterStart = !1, this._ratedAndEnoughFrames = !1, this._state = void 0, this._dataObject.unloadTreeStructure(), this._pointLoader.unloadAll()
    },
    isLoaded: function () {
        return !!this._dataObject._treeStructure
    },
    update: function () {
        var e = WS.PointCloudRenderable.Draw,
            t = WS.PointCloudRenderable.State;
        if (!this._activated) return e.NO;
        var i = this._dataObject.getTreeStructure();
        if (!this._view.isCameraInitialized() || !i) return e.NO;
        this._now = this.getNow(), this._now = Math.max(this._now, (this._last || 0) + .1), this._initializedTree || (this._initializedTree = !0, this.determineLodMoving());
        var n, r = this._dbgFreezeCam || this._view._camera;
        return this.updateState(r), this._state === t.REST_IDLE ? n = e.KEEP : this._state === t.MOVE || this._state === t.START ? (this.updateCamera(r), this.updateLODLookupTable(r), this.collectVisibleNodes(), this.rateAndSortNodes(), this.processRatedNodes(r), this.updateRenderables(), this.unloadNodes(r), n = e.ALL) : this._state === t.REST_DRAW ? (this.updateCamera(r), this.updateLODLookupTable(r), this.collectVisibleNodes(), this.rateAndSortNodes(), n = e.ABORT) : this._state === t.REST_READ ? (this.rateAndSortNodes(), n = e.ABORT) : this._state === t.REST_COUNT ? (this.rateAndSortNodes(), this.processRatedNodes(r), this.updateRenderables(), this.unloadNodes(r), n = this._inNewRestCycle ? e.ALL : e.ADD) : n = e.KEEP, (this._inTransition || 2 === this._dbgMove && r._dirty) && (n = e.ALL), this._last = this._now, n
    },
    determineLodMoving: function () {
        500 < this._numberOfScans || 625e7 < this._dataObject._points ? (this._lodThreshMoving = 6, this._moveHomogenization = .064) : 50 < this._numberOfScans || 625e6 < this._dataObject._points ? (this._lodThreshMoving = 5, this._moveHomogenization = .032) : 5 < this._numberOfScans || 375e5 < this._dataObject._points ? (this._lodThreshMoving = 4, this._moveHomogenization = .016) : (this._lodThreshMoving = 3, this._moveHomogenization = .008)
    },
    updateState: function (e) {
        var t = WS.PointCloudRenderable.State,
            i = t.START,
            n = t.START_IDLE,
            r = t.REST_DRAW,
            o = t.REST_READ,
            a = t.REST_COUNT,
            s = t.REST_IDLE,
            c = t.MOVE,
            l = WS.PointCloudRenderable.MIN_CAMERA_IDLE_COUNT,
            h = this._prevState = this._state;
        this._ratedAfterStart ? this._ratedAndEnoughFrames ? 2 === this._dbgMove || !e._dirty && 1 !== this._dbgMove ? l <= this._view._cameraIdleCount || h === n || 2 === this._dbgMove ? 0 === this._colorCountFrame ? this._pointLoader._addedNodes || this._panoTo3d || h === c || h === n ? (this._state = r, this._inNewRestCycle = h === c || h === n || this._panoTo3d, this._panoTo3d = !1, this._pointLoader._addedNodes = !1) : this._state = s : this._state = 1 === this._colorCountFrame ? o : a : h === r ? this._state = o : h === o ? this._state = a : h === a ? this._panoTo3d ? (this._state = r, this._inNewRestCycle = !1, this._panoTo3d = !1, this._pointLoader._addedNodes = !1) : this._state = s : h === s && this._panoTo3d && (this._state = r, this._inNewRestCycle = !1, this._panoTo3d = !1, this._pointLoader._addedNodes = !1) : this._state = c : this._state = n : this._state = i, this._state === c && (this._pointLoader._addedNodes = !1, this._panoTo3d = !1), this._framesAfterStart++, this._ratedAndEnoughFrames = this._ratedAndEnoughFrames || this._ratedAfterStart && l <= this._framesAfterStart
    },
    useIncrRendering: function () {
        var e = WS.PointCloudRenderable.State;
        switch (this._state) {
            case e.REST_DRAW:
            case e.REST_READ:
            case e.REST_COUNT:
            case e.REST_IDLE:
                return !0;
            default:
                return !1
        }
    },
    shouldShowLoading: function () {
        return this._state !== WS.PointCloudRenderable.State.MOVE && 0 < this._pointLoader._requestedNodes.length
    },
    updateCamera: function (e) {
        this._camPos = e.getGlobalPos(this._transformInverse);
        var t = this._state === WS.PointCloudRenderable.State.MOVE;
        this._frustum = e.calcFrustum(this._transform, t ? .5 * e._far : void 0)
    },
    updateLODLookupTable: function (e) {
        for (var t = this._dataObject.getTreeStructure(), i = this._state === WS.PointCloudRenderable.State.MOVE, n = i ? 4 : this._minPixelStill, r = Math.tan(e._fovY * Math.PI / 360), o = this._homogenization * e._height / (2 * n * r), a = t.r, s = a._q, c = Math.floor(s), l = F.log2(c), h = this._dataObject._lodDepth + l, d = 0; h > d; d++) this._lodLookupTable[d] = o, o *= 2;
        this._lodLookupTable[h] = Number.MAX_VALUE;
        var u = i ? .032 : .008;
        this._hqMaxDistance = u * (e._height / (2 * n * r))
    },
    collectVisibleNodes: function () {
        var e = this._camPos,
            t = this._frustum;
        this._visibleNodes = [];
        var i = this._dataObject.getTreeStructure(),
            n = [],
            r = 0,
            o = i.r,
            a = vec3.intersectAABoxWithFrustum(o._min, o._max, t);
        if (a !== WS.PerspectiveCamera.FrustumBoxIntersection.OUTSIDE) {
            var s = o._nodeInfo;
            s.depth = 1;
            var c = this.calcNearestDistance(e, o._min, o._max);
            s.camDistance = c, s.centerDistance = vec3.dist(e, o.getCenter()), s.hq = c < this._hqMaxDistance;
            var l = WS.PerspectiveCamera.FrustumBoxIntersection.INSIDE,
                h = WS.PerspectiveCamera.FrustumBoxIntersection.INTERSECT,
                d = WS.PerspectiveCamera.FrustumBoxIntersection.OUTSIDE,
                u = this._dataObject._lodDepth,
                _ = this._lodLookupTable,
                p = _.length - 1,
                g = this._lodThreshMoving,
                f = this._state,
                m = this._visibleNodes,
                v = this._hqMaxDistance;
            for (n.push([o, a, "r"]); r < n.length;) {
                var S = n[r],
                    b = S[0],
                    y = b._nodeInfo,
                    P = S[1],
                    M = S[2],
                    w = M.length,
                    C = 0 < b._points;
                if (null === y.lod) {
                    var T;
                    if (C) {
                        var W = Math.min(u, w),
                            I = Math.floor(b._q),
                            L = F.log2(I);
                        T = u - W + L
                    } else if (w > 1) {
                        var R = M.slice(0, -1),
                            O = i[R];
                        T = O._nodeInfo.lod
                    } else T = p;
                    y.lod = T
                }
                var D = y.lod;
                if (f === WS.PointCloudRenderable.State.MOVE && g > D) r++;
                else {
                    C && m.push(b);
                    for (var A = 0; i[M + A];) {
                        var E = M + A,
                            x = i[E],
                            k = this.calcNearestDistance(e, x._min, x._max);
                        if (k < _[D]) {
                            var U = P === h ? vec3.intersectAABoxWithFrustum(x._min, x._max, t) : l;
                            if (U !== d) {
                                var N = x._nodeInfo;
                                N.depth = w + 1, N.camDistance = k, N.centerDistance = vec3.dist(e, x.getCenter()), N.hq = v > k, n.push([x, U, E])
                            }
                        }
                        A++
                    }
                    r++
                }
            }
        }
    },
    processRatedNodes: function () {
        var e = this._visibleNodes,
            t = e.length;
        if (0 !== t) {
            this._debugDlVisNodes && (this.dbgDlVisibleNodes(), this._debugDlVisNodes = !1);
            for (var i = this._state === WS.PointCloudRenderable.State.MOVE, n = i ? this._pointBudgetMove : this._pointBudgetStill, r = i ? this._nodeBudgetMove : this._nodeBudgetStill, o = 0, a = 0, s = this._minDepth, c = this._maxDepth, l = this._dbgSubtree, h = this._bestNodes, d = this._now, u = this._pointLoader, _ = 0; t > _; _++) {
                var p = e[_],
                    g = p._nodeInfo;
                if (!(0 < g.rating)) {
                    e.length = _;
                    break
                }
                var f = p._shortID,
                    m = f.length;
                if (!(n > o && r > a)) {
                    e.length = _;
                    break
                }
                if (g.loaded) {
                    o += g.numPoints, a += 1;
                    var v = void 0 !== s && s > m,
                        S = void 0 !== c && m > c,
                        b = void 0 !== l && f !== l,
                        y = void 0 !== h && _ + 1 > h;
                    g.visible = !(v || S || b || y), g.lastUse = d
                } else g.visible = !1, u.loadNodeBinary(p)
            }
        }
    },
    updateRenderables: function () {
        var e = this._visibleNodes.length;
        if (0 !== e) {
            var t = this._visibleNodes,
                i = this._prs,
                n = this._visiblePrs = [],
                r = this._vrIndex = {},
                o = this._prIndex,
                a = this._voronoi,
                s = this._state === WS.PointCloudRenderable.State.MOVE,
                c = s ? this._moveHomogenization / this._homogenization : 1,
                l = s ? 1 : this._physicalFactorGF,
                h = a ? WS.PointCloudRenderable.VORONOI_FACTOR : WS.PointCloudRenderable.SIZE_FACTOR,
                d = this._pointSize;
            d.physical = Math.max(.003, this._homogenization * c * l * h), d.minPixel = s ? 4 : this._minPixelStill;
            for (var u = 0; e > u; u++) {
                var _ = t[u],
                    p = _._nodeInfo;
                if (p.visible) {
                    var g = a && p.hq,
                        f = _._shortID,
                        m = i[o[f]];
                    m ? (m.enableVoronoi(g), n.push(m), r[f] = n.length - 1) : p.positionArray && (m = this.addPointRenderable(_, g, d), n.push(m), r[f] = n.length - 1)
                }
            }
        }
    },
    unloadNodes: function (e, t) {
        var i = this.determineNodesToUnload(e, t);
        if (i)
            for (var n = this._pointLoader, r = this._prs, o = this._prIndex, a = 0, s = i.length; s > a; ++a) {
                var c = i[a],
                    l = c._shortID,
                    h = r[o[l]];
                h && this.removePointRenderable(h, l), n.unloadNode(c), c._nodeInfo.unload()
            }
    },
    calcNearestDistance: function (e, t, i) {
        var n = e[0],
            r = e[1],
            o = e[2],
            a = t[0],
            s = t[1],
            c = t[2],
            l = i[0],
            h = i[1],
            d = i[2];
        a > n ? n = a : n > l && (n = l), s > r ? r = s : r > h && (r = h), c > o ? o = c : o > d && (o = d);
        var u = n - e[0],
            _ = r - e[1],
            p = o - e[2];
        return Math.sqrt(u * u + _ * _ + p * p)
    },
    determineNodesToUnload: function (e) {
        var t = this._pointLoader,
            i = t._requestedNodes.length * WS.PointCloudNode.MAX_PTS,
            n = t._pointsInMemory + i;
        if (n <= t._maxPointsInMemory) return void 0;
        var r, o, a = t._pointsInMemory - this._pointBudgetStill - WS.PointCloudNode.MAX_PTS,
            s = [],
            c = (this._dataObject.getTreeStructure(), this._now),
            l = this._pointLoader._loadedNodes;
        for (var h in l) {
            var d = l[h];
            o = d._nodeInfo, (o.lastUse < c || !o.lastUse) && o.loaded && s.push(d)
        }
        var u = s.length,
            _ = Number.MAX_VALUE,
            p = Number.MIN_VALUE;
        for (r = 0; u > r; ++r) o = s[r]._nodeInfo, _ = Math.min(_, o.lastUse), p = Math.max(p, o.lastUse);
        var g = Math.max(1, p - _),
            f = e.unprojectPoint([e._width / 2, e._height / 2, .99]);
        for (vec3.subtract(f, this._camPos), vec3.normalize(f), r = 0; u > r; ++r) this.rateUnloading(s[r], _, g, e, f);
        s.sort(function (e, t) {
            return t._nodeInfo.rating - e._nodeInfo.rating
        });
        var m = 0;
        for (r = 0; u > r && a > m; ++r) m += s[r]._nodeInfo.numPoints;
        return s.length = r, s
    },
    addPointRenderable: function (e, t, i) {
        var n = e._nodeInfo,
            r = e._shortID,
            o = new WS.DynamicPointRenderable(new WS.ArrayBuffer(n.positionArray, 3), new WS.ArrayBuffer(n.colorArray, 4, WS.Buffer.ItemDataType.UBYTE), i, void 0, t, r),
            a = o._material;
        return n.colorArray = null, o.setAlpha(this._alpha), o.addToLayer(this._layerId), a._useFixedColor = this._dbgShowLod, a._fixedColor = this._dbgLodColors[r.length]._bufferData, a._mvMatrix = this._mvMatrix, this._prs.push(o), this._prIndex[r] = this._prs.length - 1, this._dbgShowBBoxes && !this._dbgBBoxRenderables[r] && this.dbgAddBBoxRenderable(e), o
    },
    removePointRenderable: function (e, t) {
        var i = this._prIndex,
            n = this._vrIndex;
        this._view.deleteStorageForRenderableAndMembers(e);
        var r = i[t];
        delete i[t], this._prs.splice(r, 1);
        for (var o in i) r < i[o] && i[o]--;
        var a = n[t];
        if (a >= 0) {
            delete n[t], this._visiblePrs.splice(a, 1);
            for (var s in n) a < n[s] && n[s]--
        }
        this._dbgBBoxRenderables[t] && this.dbgRemoveBBoxRenderable(t)
    },
    getNow: function () {
        return Date.now()
    },
    rateAndSortNodes: function () {
        var e = WS.PointCloudRenderable.State,
            t = this._dbgFreezeCam || this._view._camera,
            i = this._state,
            n = this._visibleNodes;
        i === e.START ? (this.rateRestingDraw(t), this.rateRestingRead() && this.rateRestingCount(t, !0)) : i === e.MOVE ? (this._prevState !== e.MOVE && this.abortRateResting(), n.length > 0 && this.rateMoving(t)) : i === e.REST_DRAW ? this.rateRestingDraw(t) : i === e.REST_READ ? this.rateRestingRead() : i === e.REST_COUNT && this.rateRestingCount(t, !1), n.sort(function (e, t) {
            return t._nodeInfo.rating - e._nodeInfo.rating
        })
    },
    rateMoving: function (e) {
        for (var t = 49.9, i = 35.1, n = 5.1, r = 5, o = 4.9, a = this._visibleNodes, s = this.getNodesContainingCamera(e, !0), c = 250, l = .5 * e._far, h = n / 10, d = WS.PointCloudNode.MIN_PTS, u = this._lodThreshMoving, _ = this._dataObject._lodDepth, p = 0, g = a.length; g > p; ++p) {
            var f = a[p],
                m = f._nodeInfo,
                v = m.camDistance * (c / l),
                S = 0,
                b = m.lod;
            S = b === u + 1 ? 1 : b === _ - 2 ? .95 : b === u ? .85 : b >= _ - 1 ? .8 : b === u + 2 ? .65 : b === _ - 3 ? .6 : b === u + 3 ? .4 : b === _ - 4 ? .35 : b === u + 4 ? .1 : b === _ - 5 ? .05 : 0;
            var y, P = S * t;
            y = 50 >= v ? Math.max(.1, .0001674720747 * v * v - .02669879092 * v + .9984014448) * i : c > v ? h - (v - 50) / (c - 50) * h : 0;
            var M = s[f._shortID] ? r : 0,
                w = Math.min(o, o * (f._points - d) / d),
                C = 0;
            if (m.lastUse)
                if (m.lastUse === this._last) C = n;
                else {
                    var T = this._last - m.lastUse;
                    2e3 > T && (C = (-5 + 2 * T / 1e3) * n)
                }
            m.rating = Math.max(0, P + y + M + w + C)
        }
    },
    rateRestingDraw: function (e) {
        var t = this._view,
            i = t._renderer[0],
            n = i._shaderProgramStorage,
            r = this._visibleNodes,
            o = this._colorArray,
            a = this._shortIDToColor = {},
            s = new WS.Scene,
            c = new WS.ObjectLabeler(WS.ObjectLabeler.DEFAULT_INTERVAL, 3),
            l = [],
            h = [],
            d = this._prs,
            u = this._prIndex,
            _ = this._pointLoader._requestedNodes,
            p = !1;
        if (!this._inNewRestCycle && this.useIncrRendering() && !n.inquireShaderProgram(WS.ColorShaderDesc)._failSafe) {
            var g = i._frameBufferStorage.get("post_gf_depth"),
                f = g._camMatrix && mat4.equal(g._camMatrix, e._camMatrix);
            f && (p = !0)
        }
        this.determineRatingForNodesContainingCamera(e);
        for (var m = this._ratingsContainingCamera, v = 0, S = r.length; S > v; ++v) {
            var b, y, P = r[v],
                M = P._shortID,
                w = P._nodeInfo.loaded,
                C = d[u[M]];
            w && C && !p ? (b = c.getColor().rgb, C.setPickColor([b[0] / 255, b[1] / 255, b[2] / 255, 1]), y = (b[1] << 8) + b[2], o[y] = 0, a[M] = y, s.add(C)) : w || m[M] || -1 !== _.indexOf(P) || (b = c.getColor().rgb, l.push([b[0] / 255, b[1] / 255, b[2] / 255, 1]), h.push(P), y = (b[1] << 8) + b[2], o[y] = 0, a[M] = y)
        }
        0 < h.length && (this._occlusionRenderable ? this._occlusionRenderable.updateBuffers(h, l, this._dataObject._depth) : this._occlusionRenderable = new WS.OcclusionRenderable(h, l, this._dataObject._depth, this._layerId, this._transform), s.add(this._occlusionRenderable)), i.drawScene(e, s, !1, void 0, {
            destFB: this._occlusionFrameBuffer,
            colorMode: WS.RendererBase.RenderMode.NODE,
            rgbDepthTest: p
        }), this._colorCountFrame = 1
    },
    rateRestingRead: function () {
        return this._view._width && this._view._height ? (this._occlusionFrameBuffer.readTextureIntoBuffer(), this._colorCountFrame = 2, !0) : (this._colorCountFrame = 0, !1)
    },
    rateRestingCount: function (e, t) {
        var i = this._view,
            n = i._width,
            r = i._height;
        if (!n || !r) return this._occlusionFrameBuffer.abortCountColors(), void(this._colorCountFrame = 0);
        var o = this._colorArray;
        t ? this._occlusionFrameBuffer.countColorsForStartFrame(o, n, r) : this._occlusionFrameBuffer.countColors(o);
        for (var a, s = this._visibleNodes, c = s.length, l = n / 2, h = r / 2, d = n > r ? h : l, u = n * r, _ = [this._transform[12], this._transform[13], this._transform[14]], p = this._ratingsContainingCamera, g = this._shortIDToColor, f = 0, m = 0; c > m; ++m) a = s[m]._nodeInfo, a.loaded && (a.rating = 200 + 1 / (a.camDistance + 1), f++);
        for (var v = WS.PointCloudRenderable.MIN_PIXELS, S = 0; c > S; ++S) {
            var b = s[S];
            a = b._nodeInfo;
            var y = b._shortID;
            if (!a.loaded) {
                var P = p[y];
                if (P) a.rating = P;
                else {
                    var M = g[y];
                    if (M > -1) {
                        var w = o[M],
                            C = w / u * 100;
                        a.centerBonus = this.calculateCenterBonus(e, b, l, h, d, _), a.rating = w > v ? Math.min(100, 10 + C + a.centerBonus) : 0
                    }
                }
            }
        }
        this._ratedAfterStart = !0, this._colorCountFrame = 0
    },
    rateUnloading: function (e, t, i, n, r) {
        var o = e._nodeInfo,
            a = 100 - 100 * (o.lastUse - t) / i,
            s = this._camPos,
            c = this.calcNearestDistance(s, e._min, e._max),
            l = 500;
        c *= l / n._far;
        var h;
        h = 20 >= c ? .5 * c : 50 >= c ? 10 + 4 / 3 * (c - 20) : 100 >= c ? 50 + .7 * (c - 50) : Math.min(100, 85 + 15 / (l - 100) * (c - 100));
        var d;
        if (0 === c) d = 0;
        else {
            var u = e.getCenter();
            vec3.subtract(u, this._camPos), vec3.normalize(u);
            var _ = vec3.angle(r, u),
                p = _ / Math.PI;
            d = p * p * 100
        }
        var g = o.lod,
            f = 0;
        0 === g ? f = 100 : 1 === g && (f = 50), o.rating = Math.min(100, .25 * a + .4 * h + .3 * d + .05 * f)
    },
    calculateCenterBonus: function (e, t, i, n, r, o) {
        var a = t.getCenter(),
            s = [o[0] + a[0], o[1] + a[1], o[2] + a[2], 1],
            c = e.projectPoint(s);
        if (c) {
            var l = i - s[0],
                h = n - s[1],
                d = Math.sqrt(l * l + h * h),
                u = Math.max(0, 1 - d / r),
                _ = t._nodeInfo.centerDistance,
                p = 50 > _ ? Math.max(.1, .0001674720747 * _ * _ - .02669879092 * _ + .9984014448) : .1;
            return Math.max(.1, u * p * WS.PointCloudRenderable.MAX_CENTER_BONUS)
        }
        return .05
    },
    abortRateResting: function () {
        this._colorCountFrame = 0, this._occlusionRenderable && this._view.deleteStorageForRenderableAndMembers(this._occlusionRenderable), this._occlusionFrameBuffer && this._occlusionFrameBuffer.abortCountColors()
    },
    determineRatingForNodesContainingCamera: function (e) {
        var t = this.getNodesContainingCamera(e),
            i = this._ratingsContainingCamera = {},
            n = t.length;
        this._ratingWithCamera = {};
        for (var r, o, a = WS.PointCloudRenderable.RATINGS_WITHIN_CAMERA, s = 0; n > s && 10 > s; ++s) r = t[s], o = r._points ? a[s] : 0, i[r._shortID] = o;
        for (var c = 10; n > c; ++c) r = t[c], o = r._points ? 11 - .01 * c : 0, i[r._shortID] = o
    },
    getNodesContainingCamera: function (e, t) {
        var i = this._dataObject.getTreeStructure(),
            n = i.r,
            r = t ? {} : [];
        return 0 === this.calcNearestDistance(this._camPos, n._min, n._max) && (this.getNodesContainingCameraHelper(r, i, n, t), t ? r[n._shortID] = n : r.push(n)), r
    },
    getNodesContainingCameraHelper: function (e, t, i, n) {
        for (var r = i._shortID, o = 0, a = t[r + o], s = this._camPos; a;) {
            if (0 === this.calcNearestDistance(s, a._min, a._max)) {
                this.getNodesContainingCameraHelper(e, t, a, n), n ? e[a._shortID] = a : e.push(a);
                break
            }
            o++, a = t[r + o]
        }
    },
    setAlpha: function (e) {
        if (this._alpha !== e) {
            this._alpha = e;
            for (var t = 0, i = this._prs.length; i > t; ++t) this._prs[t].setAlpha(e)
        }
    },
    getAlpha: function () {
        return this._alpha
    },
    getMemberRenderables: function () {
        return this._dbgShowBBoxes ? this.dbgGetRenderables(!1) : this._prs
    },
    getVisibleMemberRenderables: function () {
        return this._dbgShowBBoxes ? this.dbgGetRenderables(!0) : this._visiblePrs
    },
    draw3d: function (e, t) {
        var i = e._renderColorMode === WS.RendererBase.RenderMode.PICK_3D_POINT || e._renderColorMode === WS.RendererBase.RenderMode.PICK_3D;
        if (this._activated) {
            if (i || t(this)) {
                mat4.multiply(e._camera._transform, e.getModelMatrix(), this._mvMatrix);
                var n = i ? t : void 0;
                this.drawMemberRenderables3d(e, WS.PointCloudRenderable.getIsPointsAndVisible(WS.DynamicPointShaderDesc, n), !1), this.drawMemberRenderables3d(e, WS.PointCloudRenderable.getIsPointsAndVisible(WS.VoronoiPointShaderDesc, n), !1)
            }
            this._dbgShowBBoxes && !i && this.drawMemberRenderables3d(e, WS.PointCloudRenderable.getIsNoPointsAndVisible(t), !1)
        }
    },
    drawMemberRenderables3d: function (e, t) {
        for (var i = this.getVisibleMemberRenderables(), n = 0, r = i.length; r > n; n++) {
            var o = i[n];
            o.draw3d(e, t, !1)
        }
    },
    draw2d: function () {
    },
    dbgDlVisibleNodes: function () {
        var e = {},
            t = console,
            i = this._visibleNodes;
        t.log(i.length, "visible nodes");
        for (var n = 0; n < i.length; n++) e[i[n]._shortID] = n + 1;
        var r = "digraph {\ngraph [nodesep=0.02 ranksep=0.25];\nnode [margin=0 fontsize=9 width=0.3 height=0.3];\n",
            o = this._dataObject.getTreeStructure();
        for (var a in o) r += e[a] ? a + ' [label="' + e[a] + '",style=filled,color=".7 .3 1.0"];\n' : a + ' [label=""];\n', a.length > 1 && (r += a.substring(0, a.length - 1) + " -> " + a + ";\n");
        r += "}";
        var s = document.createElement("a");
        s.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(r)), s.setAttribute("download", "nodelist.txt"), s.style.display = "none", document.body.appendChild(s), s.click(), document.body.removeChild(s)
    },
    dbgAddBBoxRenderable: function (e) {
        for (var t = new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(72), 3), this._dbgLodColors[e._shortID.length]), i = t._geometry._positionBuffer, n = WS.Box3dRenderable.WIREFRAME_INDICES, r = e._min, o = e._max, a = n.length - 1; a >= 0; a--) {
            var s = n[a],
                c = s % 2 >= 1 ? o[0] : r[0],
                l = s % 4 >= 2 ? o[1] : r[1],
                h = s % 8 >= 4 ? o[2] : r[2],
                d = a > 0;
            i.setItem(a, [c, l, h], d)
        }
        t._material._depthTest = !0, t.addToLayer(WS.Layer.LayerIDs.TEMP), this._dbgBBoxRenderables[e._shortID] = t
    },
    dbgRemoveBBoxRenderable: function (e) {
        this._view.deleteStorageForRenderableAndMembers(this._dbgBBoxRenderables[e]), delete this._dbgBBoxRenderables[e]
    },
    dbgShowLod: function (e) {
        this._dbgShowLod = e, this._prs.forEach(function (t) {
            t._material._useFixedColor = e
        })
    },
    dbgShowBBoxes: function (e) {
        if (this._dbgShowBBoxes = e, e) {
            var t = this._dataObject.getTreeStructure();
            if (t)
                for (var i in this._prIndex) this._dbgBBoxRenderables[i] || this.dbgAddBBoxRenderable(t[i])
        } else
            for (var n in this._dbgBBoxRenderables) this.dbgRemoveBBoxRenderable(n)
    },
    dbgGetLodColors: function () {
        for (var e = Math.max(2, this._dataObject._depth), t = [], i = 1; e >= i; i++) {
            var n = 1 - (i - 1) / (e - 1);
            t[i] = new WS.ArrayBuffer([Math.max(0, Math.min(1, .25 >= n ? 1 : 2 - 4 * n)), Math.max(0, Math.min(1, .5 >= n ? 4 * n : 4 - 4 * n)), Math.max(0, Math.min(1, .75 >= n ? -2 + 4 * n : 1)), 1], 4)
        }
        return t
    },
    dbgGetRenderables: function (e) {
        var t = F.cloneArray(e ? this._visiblePrs : this._prs);
        for (var i in this._dbgBBoxRenderables) this._visiblePrs[this._vrIndex[i]] && t.push(this._dbgBBoxRenderables[i]);
        return t
    }
}, WS.extend("PointCloudRenderable", "Renderable"), WS.PointCloudRenderable.SIZE_FACTOR = 1.25, WS.PointCloudRenderable.VORONOI_FACTOR = 2, WS.PointCloudRenderable.MIN_CAMERA_IDLE_COUNT = 6, WS.PointCloudRenderable.MIN_PIXELS = 64, WS.PointCloudRenderable.RATINGS_WITHIN_CAMERA = [100, 60, 30, 22.5, 17.5, 15, 13.5, 12.5, 11.75, 11.25], WS.PointCloudRenderable.MAX_CENTER_BONUS = 10, WS.PointCloudRenderable.State = {
    START: 0,
    START_IDLE: 1,
    REST_DRAW: 2,
    REST_READ: 3,
    REST_COUNT: 4,
    REST_IDLE: 5,
    MOVE: 6
}, WS.PointCloudRenderable.Draw = {
    ABORT: 0,
    NO: 1,
    KEEP: 2,
    ADD: 3,
    ALL: 4
}, WS.PointCloudRenderable.BUDGET_MOVE = {
    VeryLow: 12e5,
    Low: 14e5,
    Medium: 15e5,
    High: 18e5,
    VeryHigh: 18e5
}, WS.PointCloudRenderable.BUDGET_STILL = {
    VeryLow: 2e6,
    Low: 65e5,
    Medium: 85e5,
    High: 13e6,
    VeryHigh: 18e6
}, WS.PointCloudRenderable.combineDrawStates = function (e, t) {
    return t >= e ? t : e
}, WS.PointCloudRenderable.getIsPointsAndVisible = function (e, t) {
    return function (i) {
        return i instanceof WS.DynamicPointRenderable && i._material._shaderProgramDesc === e && (!t || t(i))
    }
}, WS.PointCloudRenderable.getIsNoPointsAndVisible = function (e) {
    return function (t) {
        return !(t instanceof WS.DynamicPointRenderable || e && !e(t))
    }
}, WS.ScanCloudRenderable = function (e, t, i, n, r) {
    WS.DynamicPointRenderable.call(this, new WS.ArrayBuffer([], 3), new WS.ArrayBuffer([], 4, WS.Buffer.ItemDataType.UBYTE), 1, void 0, !1), this.setDataObject(e), this._transform = e.calcTrafoInRefSystem(r._trafoView), this._view = r, this._activated = !1, this._scanService = t, this._width = i, this._candidates = void 0, this._colorMode = n, this._lowZ = void 0, this._highZ = void 0, this._pickable3d = !0, this._state = void 0, this._inTransition = !1, this.determineModeAndWidth(), this.addToLayer(WS.Layer.LayerIDs.POINT_CLOUD, !0)
}, WS.ScanCloudRenderable.prototype = {
    activate: function () {
        var e = this,
            t = this._dataObject,
            i = this._width,
            n = this._colorMode;
        this._activated = !0;
        var r, o, a = this._scanService.loadDistanceImage(t, i);
        if ("elevation" !== n) {
            var s = t.getSimilarAvailablePanoImage(i, n),
                c = new WS.Image(t.getImagePath(s), WS.Image.Filter.Nearest);
            r = new WS.CanvasTexture(c), o = r.getPromise()
        } else o = Q.resolve();
        Q.all([a, o]).spread(function (o) {
            e._dataObject === t && e._colorMode === n && e._width === i && (e.updatePoints(o, r ? r._canvasData : void 0), r && r.destroy())
        }).done()
    },
    deactivate: function () {
        this._activated = !1, this._inTransition = !1
    },
    isActive: function () {
        return this._activated
    },
    unload: function (e) {
        e.deleteStorageForRenderableAndMembers(this), this._geometry._positionBuffer.setBufferData([]), this._material._colorBuffer.setBufferData([]), this._lowZ = void 0, this._highZ = void 0, this._inTransition = !1
    },
    update: function () {
        if (!this._activated || !this._view.isCameraInitialized()) return WS.PointCloudRenderable.Draw.NO;
        this.updateState(), this.setPointSize({
            physical: this._state === WS.ScanCloudRenderable.State.MOVE ? .064 : .002,
            minPixel: 2,
            maxPixel: 20
        });
        var e;
        return e = this._state === WS.ScanCloudRenderable.State.REST_IDLE ? WS.PointCloudRenderable.Draw.KEEP : WS.PointCloudRenderable.Draw.ALL, this._inTransition && (e = WS.PointCloudRenderable.Draw.ALL), this._geometry._positionItemsToUse = this._state === WS.ScanCloudRenderable.State.MOVE ? this._candidates : void 0, e
    },
    updateState: function () {
        var e = this._view._cameraIdleCount,
            t = WS.PointCloudRenderable.MIN_CAMERA_IDLE_COUNT;
        this._state = 1 === this._dbgMove || t > e ? WS.ScanCloudRenderable.State.MOVE : e === t ? WS.ScanCloudRenderable.State.REST_DRAW : WS.ScanCloudRenderable.State.REST_IDLE
    },
    useIncrRendering: function () {
        return this._state === WS.ScanCloudRenderable.State.REST_DRAW || this._state === WS.ScanCloudRenderable.State.REST_IDLE
    },
    shouldShowLoading: function () {
        return !1
    },
    updateWidthAndMode: function (e, t, i) {
        var n = this._width,
            r = this._colorMode;
        this._width = e, this._colorMode = t, this.determineModeAndWidth(), (this._width !== n || this._colorMode !== r) && (this.deactivate(), this.unload(i), this.activate())
    },
    isLoaded: function () {
        return this._geometry._positionBuffer.hasData()
    },
    determineModeAndWidth: function () {
        if ("blend" === this._colorMode && (this._colorMode = "color"), "elevation" === this._colorMode) this._width = this._dataObject.getSimilarAvailableDistanceImage(this._width);
        else {
            var e = this._dataObject.getSimilarAvailablePanoImage(this._width, this._colorMode),
                t = this._dataObject.getSimilarAvailableDistanceImage(this._width);
            this._width = Math.min(e.width, t), this._colorMode = e.colorModeId
        }
    },
    updatePoints: function (e, t) {
        var i = this._width,
            n = i / 2,
            r = 0,
            o = 0,
            a = new Float32Array(3 * i * n),
            s = new Uint8Array(4 * i * n),
            c = 0,
            l = 0,
            h = 0,
            d = 0,
            u = 3 * i * n - 1,
            _ = 4 * i * n - 1,
            p = 1 / n,
            g = 1 / i * 2 * Math.PI,
            f = .9;
        i > 2048 && (f = 1.01), i > 4096 && (f = 3.01);
        for (var m = Math.ceil(f), v = 0; n > v; ++v)
            for (var S = (v + .5) * p * Math.PI, b = Math.sin(S), y = Math.cos(S), P = Math.ceil(f / Math.cos(S - Math.PI / 2)), M = 0; i > M; ++M) {
                var w = e[c];
                if (0 !== w) {
                    var C = (M + .5) * g;
                    v % m === 0 && M % P === 0 ? (r++, a[h++] = w * Math.cos(-C) * b, a[h++] = w * Math.sin(-C) * b, a[h++] = w * y, t && (s[d++] = t[l], s[d++] = t[l + 1], s[d++] = t[l + 2], s[d++] = 255)) : (o++, a[u--] = w * y, a[u--] = w * Math.sin(-C) * b, a[u--] = w * Math.cos(-C) * b, t && (s[_--] = 255, s[_--] = t[l + 2], s[_--] = t[l + 1], s[_--] = t[l]))
                }
                l += 4, c += 1
            }
        var T = new Float32Array(3 * (r + o)),
            W = new Uint8Array(4 * (r + o));
        T.set(a.subarray(0, 3 * r)), W.set(s.subarray(0, 4 * r)), o > 0 && (T.set(a.subarray(u + 1), 3 * r), W.set(s.subarray(_ + 1), 4 * r)), this._candidates = r, this._geometry._positionBuffer.setBufferData(T), this._material._colorBuffer.setBufferData(W), this.setPointSize({
            physical: 8.192 / i,
            minPixel: 2,
            maxPixel: 40
        })
    },
    onViewingModeChange: function () {
    },
    draw3d: function (e, t) {
        this._activated && WS.DynamicPointRenderable.prototype.draw3d.call(this, e, t, !1)
    }
}, WS.extend("ScanCloudRenderable", "DynamicPointRenderable"), WS.ScanCloudRenderable.DetailWidth = {
    VeryLow: 512,
    Low: 1024,
    Medium: 2048,
    High: 4096,
    VeryHigh: 8192
}, WS.ScanCloudRenderable.State = {
    REST_DRAW: WS.PointCloudRenderable.State.REST_DRAW,
    REST_IDLE: WS.PointCloudRenderable.State.REST_IDLE,
    MOVE: WS.PointCloudRenderable.State.MOVE
}, WS.WorkerLauncher = function (e) {
    this._workerUrl = e, this._listeners = [], this._pool = [], this._running = 0
}, WS.WorkerLauncher.prototype = {
    addListener: function (e) {
        F.addUnique(this._listeners, e)
    },
    removeListener: function (e) {
        F.removeFirst(this._listeners, function (t) {
            return t === e
        })
    },
    runWorker: function (e) {
        var t, i = this;
        0 === this._pool.length ? (t = new Worker(this._workerUrl), t.addEventListener("message", function (e) {
            i._pool.push(t), i._running--, i._listeners.forEach(function (t) {
                t(e)
            })
        })) : t = this._pool.pop(), t.postMessage(e), this._running++
    }
}, F.DI().registerService("pointcloud", WS.PointCloudService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource", "@projectdatacdn"), F.DI().config("@serializer", "@pointcloud", function (e, t) {
    e.registerClass("WSPointCloud", function () {
        return t.getNew()
    }), e.registerClass("PointCloudNode", function () {
        return new WS.PointCloudNode
    }), e.registerClass("PointCloudRootNode", function () {
        return new WS.PointCloudNode
    })
}), WS.Orthophoto = function (e) {
    WS.Transformation.call(this, e), this._class = "Orthophoto", this._description = void 0, this._hyperlinks = [], this._width = void 0, this._height = void 0, this._scale = void 0, this._minDepth = void 0, this._maxDepth = void 0, this._scanUUIDs = void 0, this._colorMode = void 0, this._gapFiller = void 0, this._previewSizes = void 0, this._previewSizesSquare = void 0, this._temporary = !1, this._imageSizes = void 0, this._imageWidths = void 0, this._imageHeights = void 0, this._hideImage = !1
}, WS.Orthophoto.prototype = {
    readJson: function (e) {
        WS.Transformation.prototype.readJson.call(this, e), this.readHyperlinksJson(e), this._description = e.Description, this._width = e.Width, this._height = e.Height, this._scale = e.Scale, this._minDepth = e.MinDepth, this._maxDepth = e.MaxDepth, this._scanUUIDs = e.ScanUUIDs, this._colorMode = e.ColorMode, this._gapFiller = e.GapFiller, this._previewSizes = e.PreviewSizes, this._previewSizesSquare = e.PreviewSizesSquare, this.setImageSizes()
    },
    writeJson: function () {
        var e = WS.Transformation.prototype.writeJson.call(this);
        return this.writeHyperlinksJson(e), e.Class = this._class, e.Description = this._description, e.Width = this._width, e.Height = this._height, e.Scale = this._scale, e.MinDepth = this._minDepth, e.MaxDepth = this._maxDepth, e.ScanUUIDs = this._scanUUIDs, e.ColorMode = this._colorMode, e.GapFiller = this._gapFiller, e.PreviewSizes = this._previewSizes, e.PreviewSizesSquare = this._previewSizesSquare, e
    },
    writeChanges: function () {
        var e = WS.Transformation.prototype.writeChanges.call(this);
        return this.writeHyperlinksChanges(e)
    },
    setImageSizes: function () {
        this._previewSizes || (this._previewSizes = []), this._previewSizesSquare || (this._previewSizesSquare = []);
        var e = this._height <= this._width,
            t = this.getAspectRatio();
        this._imageSizes = e ? [this._width].concat(this._previewSizes) : [this._height].concat(this._previewSizes), this._imageWidths = [this._width], this._imageHeights = [this._height];
        for (var i = 0, n = this._previewSizes.length; n > i; ++i) e ? (this._imageWidths.push(this._previewSizes[i]), this._imageHeights.push(Math.max(Math.round(this._previewSizes[i] / t), 1))) : (this._imageWidths.push(Math.max(Math.round(this._previewSizes[i] * t), 1)), this._imageHeights.push(this._previewSizes[i]))
    },
    getImagePathByIndex: function (e) {
        return "/data/project/" + this._project + "/orthophoto/" + this._UUID + (void 0 !== e && 0 !== e ? "/" + this._imageSizes[e] : "")
    },
    getSquareImagePathBySize: function (e) {
        return "/data/project/" + this._project + "/orthophoto/" + this._UUID + "/" + e + "/square"
    },
    getImagePaths: function () {
        for (var e = [], t = this._imageSizes.length, i = 0; t > i; ++i) e.push(this.getImagePathByIndex(i));
        return e
    },
    getWidthInMeter: function () {
        return this._width / this._scale
    },
    getHeightInMeter: function () {
        return this._height / this._scale
    },
    getAspectRatio: function () {
        return this._width / this._height
    },
    getDepthInMeter: function () {
        return this._maxDepth - this._minDepth
    },
    getIndexOfBestFit: function (e) {
        if (this._imageSizes[0] <= e) return 0;
        for (var t = this._imageSizes.length, i = 1; t > i; ++i)
            if (this._imageSizes[i] <= e) return i;
        return t - 1
    },
    getImageCenterGlobal: function () {
        var e = vec3.create([.5 * this.getWidthInMeter(), .5 * this.getHeightInMeter(), 0]);
        return mat4.multiplyVec3(this._trafoGlobal, e, vec3.create())
    },
    getVolumeCenterGlobal: function () {
        var e = vec3.create([.5 * this.getWidthInMeter(), .5 * this.getHeightInMeter(), (this._minDepth + this._maxDepth) / 2]);
        return mat4.multiplyVec3(this._trafoGlobal, e, vec3.create())
    },
    getImageCornersGlobal: function () {
        var e = this,
            t = this.getWidthInMeter(),
            i = this.getHeightInMeter(),
            n = [vec3.create([0, 0, 0]), vec3.create([t, 0, 0]), vec3.create([t, i, 0]), vec3.create([0, i, 0])];
        return n.map(function (t) {
            return mat4.multiplyVec3(e._trafoGlobal, t, vec3.create())
        })
    },
    createRenderable: function (e) {
        var t, i = this._temporary && e._type === WS.Layer.ViewTypes.OVERVIEW_MAP,
            n = !this._temporary,
            r = this._temporary,
            o = this._temporary;
        this._hideImage && (t = {}, t.imagePlaneAlphas = {}, t.imagePlaneAlphas[WS.Renderable.ViewingMode.Normal] = 0, t.imagePlaneAlphas[WS.Renderable.ViewingMode.Selected] = 0);
        var a = new WS.OrthoBox3dRenderable(o, t, i, n, r),
            s = this._temporary ? WS.Layer.LayerIDs.TEMP : WS.Layer.LayerIDs.ORTHOPHOTOS;
        a.addToLayer(s, !0), a.setDataObject(this);
        var c = this;
        return a.update = function (t) {
            if (!(c._trafoGlobal && c._scale && c._width && c._height && void 0 !== c._maxDepth && void 0 !== c._minDepth)) return void a.setSize(t, void 0);
            var i = c._width / c._scale,
                n = c._height / c._scale,
                r = c._minDepth - c._maxDepth,
                o = c._maxDepth;
            a._transform = c.calcTrafoInRefSystem(e._trafoView), a.setSize(t, i, n, r, o), a.updateAppearance(t)
        }, a.update(), a
    },
    canBeShownInView: function () {
        return !0
    },
    areOrthoImagesAvailable: function () {
        return this._service.areOrthoImagesAvailable(this._UUID)
    },
    isHorizontal: function () {
        var e = this.getImageCornersGlobal(),
            t = Math.abs(e[2][2] - e[0][2]);
        return .01 >= t
    }
}, WS.extend("Orthophoto", "Transformation"), WS.mixin("Orthophoto", "HyperlinkedObject"), WS.OrthophotoService = function (e, t, i, n, r, o, a, s, c) {
    F.ProjectCRUDService.call(this, "Orthophoto", WS.Orthophoto, "/orthophoto", {}, e, t, i, n, r, o, a, s, c), this._restImage = this._resource("/data/project/:project/orthophoto/:uuid/:size/:square", {}, {
        read: {
            method: "GET",
            params: {}
        }
    })
}, WS.OrthophotoService.prototype = {
    areOrthoImagesAvailable: function (e) {
        var t = Q.defer();
        return this._restImage.read({
            project: this._project.getCurrent(),
            uuid: e,
            size: "64",
            square: "square"
        }, function () {
            t.resolve(!0)
        }, function () {
            t.resolve(!1)
        }), t.promise
    },
    remove: function (e, t) {
        return F.ProjectCRUDService.prototype.remove.call(this, e, t).fail(function (e) {
            throw "IntegrityViolationException" === e._type && (e.message = "EM_JOB_DEL_OBJ"), e
        })
    }
}, WS.extend("OrthophotoService", "ProjectCRUDService"), WS.TempOrthophoto = function (e) {
    WS.Orthophoto.call(this, e), this._class = "TempOrthophoto", this._UUID = F.generateUUID(), this._temporary = !0, this._isFocusable = !1
}, WS.extend("TempOrthophoto", "Orthophoto"), WS.TempOrthophotoService = function (e, t, i, n, r, o, a, s, c) {
    WS.ProjectCRUDService.call(this, "TempOrthophoto", WS.TempOrthophoto, "/orthodummy", {}, e, t, i, n, r, o, a, s, c)
}, WS.TempOrthophotoService.prototype = {
    getAll: function () {
        return Q.resolve(F.cloneArray(this._entities))
    },
    getByID: function (e) {
        var t = F.findFirst(this._entities, function (t) {
            return t.getID() === e
        });
        return t ? Q.resolve(t) : Q.reject(new Error("EXCEPTION_MESSAGE_FIND_OBJECT"))
    },
    create: function (e) {
        var t = F.addUnique(this._entities, e);
        return t && this.trigger("addObjects", [
            [e]
        ]), Q.resolve()
    },
    update: function (e) {
        var t = this._entities.indexOf(e) >= 0;
        return t && this.trigger("updateObjects", [
            [e]
        ]), Q.resolve()
    },
    remove: function (e) {
        var t = F.removeFirst(this._entities, e);
        return t && (e.unselect(), this.trigger("removeObjects", [
            [e]
        ])), Q.resolve()
    }
}, WS.extend("TempOrthophotoService", "ProjectCRUDService"), F.DI().config("@task", function (e) {
    this.registerParameter("orthophotoselection", "Orthophoto"), this.registerParameter("orthophotocolumnconfig", {
        name: !0,
        position: !1,
        category: !0,
        tags: !0,
        view: !0,
        writeAccess: !0,
        preview: !0
    }), this.registerController("orthophoto", WS.ObjectList, "$filter", "@plug", "@url", "@orthophoto", "@project", "@pointcloud", "@selection", "@alert", "@login", "@panosettings", "%orthophotoselection%", "%orthophotocolumnconfig%"), this.registerService("orthophoto", WS.OrthophotoService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), this.registerService("temporthophoto", WS.TempOrthophotoService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "$resource"), WS._2GO || e.registerTaskFactory("default", "overviewmap", "orthophoto", WS.OrthoPhotoMapTask, "@plug", "@point3d", "@orthophoto", "@temporthophoto", "@jobqueue", "@category", "@tag", "@layer", "@project", "@unit")
}), F.DI().config("@serializer", "@orthophoto", function (e, t) {
    e.registerClass("Orthophoto", function () {
        return t.getNew()
    })
}), angular.module("ws.widget").directive("orthophotolist", function () {
    return WS.PlugController.createDirective({
        scope: {
            caption: "@",
            collapsed: "="
        },
        link: function (e, t, i) {
            e.galleryid = i.id + "ig"
        },
        controllerClass: F.DI().getController("orthophoto"),
        template: '<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'
    })
}), WS.ProjectPageBase = function (e, t, i, n, r, o, a, s) {
    var c = this;
    F.Embeddable.call(this, e, t, i), this._project = n, this._pointCloud = r, this._panoSettings = o, this._alert = a, this._login = s, e.pickProject = F.proxy(this.pickProject, this), e.openMap = function (e) {
        c.trigger("showObjects", [
            [e._name], "map"
        ])
    }, e.openScanView = function () {
        c.trigger("showObjects", [
            [], "pano/3d"
        ])
    }, e.openWorkbench = function (e) {
        c.trigger("showObjects", [
            [e], "workbench"
        ])
    }, this.provideFemalePlug("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"]), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.connect(this, this._project), this.connect(this, this._login)
}, WS.ProjectPageBase.prototype = {
    pickProject: function (e) {
        var t = this;
        if (e._type === WS.Project.Type.WSC) this.trigger("showObjects", [
            [e._name], "map"
        ]);
        else {
            var i = this._project.isCurrent(e._name) ? Q.resolve() : this._project.changeProject(e._name);
            i.then(function () {
                t._pointCloud.getLatestPointCloud().then(function (e) {
                    e && t._panoSettings.isWebGlEnabled() ? t.trigger("showObjects", [
                        [e], "3d"
                    ]) : (t._alert.message(e ? "FE_NEED_WEBGL_FOR_3D" : "EM_3D_NA"), t.launchTask("default", "object"))
                }, function (e) {
                    t._alert.errorObj(e), t.launchTask("default", "object")
                })
            })
        }
    },
    login: function () {
        var e = this;
        this._login.isProjectManager().then(function (t) {
            e.$scope.$apply(function (e) {
                e.isPM = t
            })
        }).done()
    },
    logout: function () {
        this.$scope.$apply(function (e) {
            e.isPM = !1
        })
    },
    updateAccount: function () {
    }
}, WS.extend("ProjectPageBase", "Embeddable"), WS.ProjectSelector = function (e, t, i, n, r, o, a, s, c, l) {
    WS.ProjectPageBase.call(this, e, n, a, t, s, c, l, r);
    var h = this;
    this._cookie = o, this._worldmap = void 0, e.page = {
        query: ""
    }, e.projects = [], e.projectNames = [], e.featuredProjects = [], e.setWorldmap = F.proxy(this.setWorldmap, this), e.showProjectOnMap = F.proxy(this.showProjectOnMap, this), e.openProjectDetails = F.proxy(this.openProjectDetails, this), e.pageconfig = {
        mode: "thumbnails",
        showmap: !F.isMobile(),
        showfeatured: !F.isMobile()
    }, e.page = {
        predicate: "_displayName",
        sortby: "FE_PROJECT_NAME",
        reverse: !1,
        query: ""
    }, this._projectsPromise = void 0, e.getProjects = function () {
        return h._projectsPromise
    }, e.error = void 0, e.errormap = void 0, e.setPredicate = function (t, i) {
        e.page.reverse = e.page.predicate === t ? !e.page.reverse : !1, e.page.predicate = t, e.page.sortby = i
    }, e.setToolTipFTBox = function (e) {
        return e ? "FE_HIDE_FT_BOX" : "FE_SHOW_FT_BOX"
    }, e.setToolTipMap = function (e) {
        return e ? "FE_HIDE_MAP" : "FE_SHOW_MAP"
    }, e.storePageConfig = function () {
        h.storePageConfig()
    }, e.$watch("page.query", function () {
        h.updateURL(!0)
    }), e.toggleFeatSlide = function (e) {
        var t = $(".carousel");
        t.carousel(e)
    }, e.initCarousel = function () {
        var e = $(".carousel");
        e.carousel({
            interval: 7500
        })
    }, this._cookieId = "projectselector", this.provideMalePlug("ObjectShow", ["showObjects"]), this.provideFemalePlug("ProjectSelect", ["select", "unselect"]), this.connect(this.getFemalePlug("ProjectSelect"), i.getSelection("Project"))
}, WS.ProjectSelector.prototype = {
    updateProjects: function () {
        var e = this;
        this._login.isProjectManager().then(function (t) {
            e._projectsPromise = e._project.getAllWithStates(t ? ["Completed", "Draft", "Published"] : ["Completed", "Published"]), e._projectsPromise.then(function (t) {
                e.$scope.$apply(function (e) {
                    e.projects = t, e.featuredProjects = t.filter(function (e) {
                        return e._featured
                    })
                })
            }).done()
        }).done()
    },
    setWorldmap: function (e) {
        this._worldmap = e
    },
    showProjectOnMap: function (e) {
        this._worldmap && (this._worldmap.setView([e._latitude, e._longitude], 16), this.$scope.scrollToMap())
    },
    openProjectDetails: function (e) {
        this.trigger("showObjects", [
            [e], "projectdetails"
        ])
    },
    select: function () {
        this.$scope.$apply()
    },
    unselect: function () {
        this.$scope.$apply()
    },
    addObjects: function (e) {
        this.$scope.$apply(function (t) {
            for (var i = 0; i < e.length; i++) {
                var n = e[i];
                "Completed" === n._uploadState && (F.addUnique(t.projects, n), n._featured && F.addUnique(t.featuredProjects, n))
            }
        })
    },
    updateObjects: function () {
        this.$scope.$apply()
    },
    removeObjects: function (e) {
        this.$scope.$apply(function (t) {
            e.forEach(function (e) {
                F.removeFirst(t.projects, e), F.removeFirst(t.featuredProjects, e)
            })
        })
    },
    onShow: function () {
        F.Embeddable.prototype.onShow.call(this), this.updateProjects()
    },
    onConfigure: function (e) {
        if (!e || !e.noReconfigure) {
            var t = JSON.parse(this._cookie.getLocalStorageItem(this._cookieId));
            t && (this.$scope.pageconfig = t)
        }
    },
    login: function () {
        WS.ProjectPageBase.prototype.login.call(this), this._visible && this.updateProjects()
    },
    logout: function () {
        WS.ProjectPageBase.prototype.logout.call(this), this._visible && this.updateProjects()
    },
    storePageConfig: function () {
        this._cookie.setLocalStorageItem(this._cookieId, JSON.stringify(this.$scope.pageconfig))
    },
    updateURL: function (e) {
        var t = {};
        this.$scope.page.query && (t.q = encodeURIComponent(this.$scope.page.query).replace(/%/gi, "$")), this._url.setFragment(this._id, this._url.encode(t), [], e)
    },
    setFragment: function (e) {
        if (e.isUnresolved(this._id)) {
            var t = e.get(this._id);
            e.resolve(this._id, t.query)
        }
    },
    applyURL: function (e, t) {
        if (e == this._id) {
            var i = t.get(this._id),
                n = this._url.decode(i.query);
            this.$scope.$apply(function (e) {
                e.page.query = decodeURIComponent((n.q || "").replace(/\$/gi, "%"))
            })
        }
    }
}, WS.extend("ProjectSelector", "ProjectPageBase"), WS.ProjectDetails = function (e, t, i, n, r, o, a, s) {
    WS.ProjectPageBase.call(this, e, i, n, t, o, a, s, r);
    var c = this;
    this._promise = void 0, e.getProject = function () {
        return c._promise
    }, e.overview = !1, e.$on("launchTask", function (t, i) {
        e.panel = i
    }), this.provideFemalePlug("ObjectShow", ["showObjects"]), this.provideMalePlug("ObjectShow", ["showObjects"])
}, WS.ProjectDetails.prototype = {
    showObjects: function (e, t) {
        var i = e[0];
        "projectdetails" == t ? (this._project.changeProject(i._name), this.changePage()) : "workbench" === t && (this._project.changeProject(i._name), this.launchTask("workbench", "projectselector", void 0, void 0, {
            noNavigation: !0
        }), this.changePage())
    },
    loadProject: function (e) {
        this._promise = this._project.getCurrentProject(), e && (this._promise = this._promise.then(function (e) {
            return e
        })), this.$scope.$apply()
    },
    addObjects: function () {
    },
    updateObjects: function (e) {
        if (this._project.hasCurrent() && 0 !== e.length) {
            var t = this._project.getCurrent();
            e.some(function (e) {
                return e._name === t
            }) && this.loadProject(!0)
        }
    },
    removeObjects: function () {
    },
    login: function () {
        WS.ProjectPageBase.prototype.login.call(this), this._visible && this.loadProject()
    },
    logout: function () {
        WS.ProjectPageBase.prototype.logout.call(this), this._promise = void 0
    },
    updateAccount: function () {
        WS.ProjectPageBase.prototype.updateAccount.call(this), this._visible && this.loadProject()
    },
    onShow: function () {
        WS.ProjectPageBase.prototype.onShow.call(this), this.loadProject()
    },
    onConfigure: function (e) {
        e && (this.$scope.overview = e.task)
    },
    updateURL: function () {
        this._url.setFragment(this._id, "", ["p"])
    },
    setFragment: function (e) {
        if (e.isUnresolved(this._id)) {
            var t = e.get(this._id);
            e.resolve(this._id, t.query, ["p"])
        }
    },
    applyURL: function (e) {
        e == this._id && this._visible && this.loadProject()
    }
}, WS.extend("ProjectDetails", "ProjectPageBase"), WS.ObjectList = function (e, t, i, n, r, o, a, s, c, l, h, d, u) {
    var _ = this;
    this._service = r, this._project = o, this._pointCloud = a, this._alert = c, this._panoSettings = h, this._selectionName = d, this._promise = void 0, e.Math = window.Math, e.getObjects = function () {
        return _._promise
    }, e.page = {
        objects: [],
        index: 0,
        limit: 20,
        predicate: "_displayName",
        reverse: !1,
        sortby: "FE_NAME",
        query: ""
    }, e.selection = !0, e.taskName = void 0, e.columnconfig = u, e.canShowInMap = {}, e.canShowInPano = {}, e.canShowIn3d = {}, e.showObjects = function (e, t) {
        _.trigger("showObjects", [e, t])
    }, e.focusObject = function (e, t) {
        _.trigger("focusOn", [{
            object: e
        }, t])
    }, e.imagegallerySetup = function (t, i) {
        _.trigger("showObjects", [e.getOrdered(), "gallery", {
            object: t,
            colormode: i
        }])
    }, e.setPredicate = function (t, i) {
        e.page.reverse = e.page.predicate === t ? !e.page.reverse : !1, e.page.predicate = t, e.page.sortby = i, e.page.index = 0
    }, this._objectSelection = s.getSelection(d), this._objectFilter = t("objectfilter"), this._orderFilter = t("orderBy"), this._paginateFilter = t("paginate"), e.getFiltered = function () {
        return _._objectFilter(e.page.objects, e.page.query, e.columnconfig)
    }, e.getOrdered = function () {
        return _._orderFilter(e.getFiltered(), e.page.predicate, e.page.reverse)
    }, e.getVisible = function () {
        return _._paginateFilter(e.getOrdered(), e.page.index, e.page.limit)
    }, e.$watch("getFiltered().length", function (t) {
        e.filteredlength = t
    }), e.changeSelection = function (t) {
        e.task && e.selection ? t.toggleSelection() : !e.task || "Scan" === t._class && "RemoveTask" === e.taskName || _._alert.message("IM_NOT_IN_SELECTIONMODE")
    }, e.changeSelectionAll = function (t) {
        switch (t) {
            case "all":
                _._objectSelection.selectMulti(e.getOrdered());
                break;
            case "visible":
                _._objectSelection.selectMulti(e.getVisible());
                break;
            case "none":
                _._objectSelection.clear()
        }
    }, WS.Embeddable.call(this, e, i, n), this.provideMalePlug("ObjectShow", ["showObjects"]), this.provideMalePlug("ViewFocus", ["focusOn"]), this.provideFemalePlug("ObjectCRUD", ["addObjects", "updateObjects", "removeObjects"]), this.provideFemalePlug(d + "Select", ["select", "unselect"]), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.provideFemalePlug("SettingsUpdate", ["updateSettings"]), this.connect(this, this._service), this.connect(this._objectSelection, this), this.connect(this, l), this.connect(this, h), this.autoConnect(e)
}, WS.ObjectList.prototype = {
    addModule: function (e) {
        WS.Embeddable.prototype.addModule.call(this, e), this.connect(this, e)
    },
    addObjects: function (e) {
        var t = this.$scope;
        F.addObjectsByID(t.page.objects, e), this.updateButtons(e), t.$apply("page.index = 0"), t.$emit("objectsLength", this, t.page.objects.length)
    },
    updateObjects: function () {
        this.$scope.$apply()
    },
    removeObjects: function (e) {
        var t = this.$scope;
        F.removeObjectsByID(t.page.objects, e), e.forEach(function (e) {
            delete t.canShowInMap[e._UUID], delete t.canShowInPano[e._UUID], delete t.canShowIn3d[e._UUID]
        }), t.$apply("page.index = 0"), t.$emit("objectsLength", this, t.page.objects.length)
    },
    select: function () {
        this.$scope.$apply()
    },
    unselect: function () {
        this.$scope.$apply()
    },
    refresh: function () {
        this._promise = this._visible ? this.getAll() : void 0
    },
    onShow: function () {
        WS.Embeddable.prototype.onShow.call(this), this.refresh()
    },
    onConfigure: function (e) {
        e && e.noReconfigure || (this.$scope.selection = !1, this.$scope.task = !1, e && (e.selection && -1 != e.selection.split(",").indexOf(this._selectionName.toLowerCase()) && (this.$scope.selection = !0), this.$scope.task = e.task, this.$scope.taskName = e.name))
    },
    updateURL: function (e) {
        this._url.setFragment(this._id, "", ["p"], e)
    },
    setFragment: function (e) {
        if (e.isUnresolved(this._id)) {
            var t = e.get(this._id);
            e.resolve(this._id, t.query, ["p"])
        }
    },
    getAll: function () {
        var e = this;
        if (this._project.hasCurrent()) {
            var t = {
                project: this._project.getCurrent()
            };
            return this._service.getAll(t).then(function (t) {
                return e.$scope.$emit("objectsLength", e, t.length), t
            })
        }
        return Q.resolve([])
    },
    login: function () {
        this.refresh(), this.updateButtons(this.$scope.page.objects)
    },
    logout: function () {
        this._promise = void 0
    },
    updateAccount: function () {
    },
    updateSettings: function (e) {
        "panorama" === e && this.updateButtons(this.$scope.page.objects)
    },
    updateButtons: function (e) {
        var t = this,
            i = this.$scope;
        if (this._project.getCurrentProject().then(function (t) {
                var n = t.hasOverviewMap(),
                    r = t.hasScan();
                e.forEach(function (e) {
                    i.canShowInMap[e._UUID] = n && e.canBeShownInView("map"), i.canShowInPano[e._UUID] = r && e.canBeShownInView("panorama")
                }), i.$apply()
            }), this._panoSettings.isWebGlEnabled()) {
            var n = e.map(function (e) {
                return e instanceof WS.PointCloud ? Q.resolve(!1) : t._pointCloud.canShowObjectIn3d(e).then(function (t) {
                    i.canShowIn3d[e._UUID] = t
                })
            });
            Q.allSettled(n).then(i.$apply.bind(i))
        } else e.forEach(function (e) {
            i.canShowIn3d[e._UUID] = !1
        }), i.$apply()
    }
}, WS.extend("ObjectList", "Embeddable"), WS.ObjectPropertiesPage = function (e, t, i, n, r, o, a, s, c) {
    WS.Embeddable.call(this, e, t, n);
    var l = this;
    this._login = i, this._projectService = r, this._pointCloud = o, this._panoSettings = a, this._locale = s, this._unit = c, this._project = void 0, e.cs = WS.UnitService.CS.GLOBAL, e.customCaption = "", e.hasCustom = !1, e.setGlobal = function () {
        e.cs = WS.UnitService.CS.GLOBAL
    }, e.setCustom = function () {
        e.cs = WS.UnitService.CS.PROJECT
    }, e.setLocal = function () {
        e.cs = WS.UnitService.CS.LOCAL
    }, e.isGlobal = function () {
        return e.cs === WS.UnitService.CS.GLOBAL
    }, e.isCustom = function () {
        return e.cs === WS.UnitService.CS.PROJECT
    }, e.isLocal = function () {
        return e.cs === WS.UnitService.CS.LOCAL
    }, e.getPos = function (e) {
        return l.getPos(e.getTranslationGlobal(), e.getTranslationLocal())
    }, e.getCentroid = function (e) {
        return l.getPos(e._centroidGlobal, e._centroidLocal)
    }, e.getPosInCSSpecial = function (t) {
        return e.isCustom() ? mat4.posInRefSystem(t, l._project._trafo) : t
    }, e.getPositionsInCS = function (t) {
        return e.isLocal() ? t._pointsLocal : e.isCustom() ? mat4.positionsInRefSystem(t._pointsGlobal, l._project._trafo) : t._pointsGlobal
    }, e.obj = void 0, e.canShowInMap = void 0, e.canShowInPano = void 0, e.canShowIn3d = void 0, e.canShowInAny = void 0, e.picker = {
        index: void 0,
        widths: void 0,
        heights: void 0,
        paths: void 0,
        showResolutions: void 0,
        showOpen: void 0,
        showRefresh: void 0
    }, this._objectClass = void 0, this._objectUUID = void 0, this._promise = void 0, e.getPromise = function () {
        return l._promise
    }, e.showObjects = function (e, t) {
        l.trigger("showObjects", [e, t])
    }, e.focusObject = function (e, t, i) {
        var n = {
            object: e,
            root: i,
            rootType: i ? "scan" : void 0
        };
        l.trigger("focusOn", [n, t])
    }, e.refresh = function () {
        l._visible && l._objectClass && l._objectUUID && l.loadObject(l._objectUUID, l._objectClass)
    }, this.provideMalePlug("PageSelect", ["selectPage", "selectPageClass"]), this.provideMalePlug("ObjectShow", ["showObjects"]), this.provideMalePlug("ViewFocus", ["focusOn"]), this.provideFemalePlug("ObjectShow", ["showObjects"]), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.connect(this, i), this.connect(this, a)
}, WS.ObjectPropertiesPage.prototype = {
    getPos: function (e, t) {
        return this.$scope.isLocal() ? t : this.$scope.isCustom() ? mat4.posInRefSystem(e, this._project._trafo) : e
    },
    loadObject: function (e, t) {
        var i = this;
        this._promise = Q.all([F.DI().getService(t).getByID(e), this._projectService.getCurrentProject()]).spread(function (e, t) {
            return i._project = t, i.initByObject(e), e
        }, function (e) {
            throw F.handled(e), e
        }), this._promise.done()
    },
    showObjects: function (e, t) {
        var i = this;
        if (e.length && "properties" === t) {
            var n = e[0];
            this._objectClass = (n.instanceOf(WS.TempMeasurement) ? "temp" : "") + n._class.toLowerCase(), this._objectUUID = n._UUID, this._promise = Q.all([Q.resolve(n), this._projectService.getCurrentProject()]).spread(function (e, t) {
                return i._project = t, i.initByObject(e), e
            }, function (e) {
                throw F.handled(e), e
            }), this._promise.done(), this.updateURL(), this.updateUserAndRights(), this.changePage()
        }
    },
    initByObject: function (e) {
        this.$scope.obj = e, this.initCS(), this.initPickerForOrthophoto(e), this.checkOrthoImage(e), this.updateButtons(e)
    },
    initCS: function () {
        var e = this.$scope;
        e.hasCustom = void 0 !== this._project._trafo, e.hasCustom && this._unit.isCustomCS() ? (e.customCaption = this._project._trafoName || this._locale.translate("FE_PROJECT"), e.setCustom()) : (e.customCaption = "", e.setGlobal())
    },
    initPickerForOrthophoto: function (e) {
        if (e instanceof WS.Orthophoto) {
            var t = this.$scope.picker;
            this.$scope.$apply(function () {
                t.widths = e._imageWidths, t.heights = e._imageHeights, t.paths = e.getImagePaths(), t.index = e.getIndexOfBestFit(1024), t.showResolutions = void 0, t.showOpen = void 0, t.showRefresh = void 0
            })
        }
    },
    checkOrthoImage: function (e) {
        if (e instanceof WS.Orthophoto) {
            var t = this.$scope,
                i = this.$scope.picker;
            e.areOrthoImagesAvailable().then(function (e) {
                t.$apply(function () {
                    i.showResolutions = e, i.showOpen = e, i.showRefresh = !e
                })
            }).done()
        }
    },
    updateUserAndRights: function () {
        var e = this;
        this._login.getUsername().then(function (t) {
            e.$scope.$apply('username = "' + t + '"')
        }).done(), this._login.isUser().then(function (t) {
            e.$scope.$apply("isUser = " + t)
        }).done(), this._login.isProjectManager().then(function (t) {
            e.$scope.$apply("isProjectManager = " + t)
        }).done(), this._login.isLoggedIn().then(function (t) {
            e.$scope.$apply("isLoggedIn = " + t)
        }).done()
    },
    updateSettings: function (e) {
        switch (e) {
            case "panorama":
                this.$scope.obj && this.updateButtons(this.$scope.obj);
                break;
            case "unit":
                this.$scope.obj && this.initCS()
        }
    },
    updateButtons: function (e) {
        var t = this.$scope;
        t.canShowInMap = void 0, t.canShowInPano = void 0, t.canShowIn3d = void 0, t.canShowInAny = void 0, t.canShowInMap = this._project.hasOverviewMap() && e.canBeShownInView("map"), t.canShowInPano = this._project.hasScan() && e.canBeShownInView("panorama"), t.canShowInAny = t.canShowInAny || t.canShowInMap || t.canShowInPano, t.$apply();
        var i = this._panoSettings.isWebGlEnabled() ? this._pointCloud.canShowObjectIn3d(e) : Q.resolve(!1);
        i.then(function (e) {
            t.canShowIn3d = e, t.canShowInAny = t.canShowInAny || e, t.$apply()
        })
    },
    updateURL: function () {
        if (this._objectClass && this._objectUUID) {
            var e = {
                t: this._objectClass,
                u: this._objectUUID
            };
            this._url.setFragment(this._id, this._url.encode(e), ["p"])
        }
    },
    setFragment: function (e) {
        if (e.isUnresolved(this._id)) {
            var t = e.get(this._id);
            e.resolve(this._id, t.query, ["p"])
        }
    },
    applyURL: function (e, t) {
        if (e === this._id) {
            var i = t.get(this._id),
                n = this._url.decode(i.query);
            this._objectClass = n.t, this._objectUUID = n.u, n.t && n.u && (this.loadObject(n.u, n.t), this.updateUserAndRights())
        }
    },
    login: function () {
        this._visible && this._objectClass && this._objectUUID && (this.loadObject(this._objectUUID, this._objectClass), this.updateUserAndRights())
    },
    logout: function () {
        this._promise = Q.reject(WS.authenticationException)
    },
    updateAccount: function () {
        this.login()
    }
}, WS.extend("ObjectPropertiesPage", "Embeddable"), WS.ProjectContentPage = function (e, t, i, n, r) {
    F.Page.call(this, e, t, i, n);
    var o = this;
    this._project = r, this._promise = void 0, this._objectAmounts = {}, e.page = {
        hasObjects: void 0
    }, e.getProject = function () {
        return o._promise
    }, e.$on("objectsLength", function (t, i, n) {
        t.stopPropagation(), o._objectAmounts[i._id] = n;
        var r = !1;
        for (var a in o._objectAmounts)
            if (o._objectAmounts.hasOwnProperty(a) && 0 < o._objectAmounts[a]) {
                r = !0;
                break
            }
        e.page.hasObjects = r
    }), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.connect(this, n)
}, WS.ProjectContentPage.prototype = {
    updateURL: function () {
        this._id && this._url.setFragment(this._id, "", ["p"])
    },
    setFragment: function (e) {
        if (e.isUnresolved(this._id)) {
            var t = e.get(this._id);
            e.resolve(this._id, t.query, ["p"])
        }
    },
    loadProject: function () {
        var e = this._project.getCurrent();
        this.$scope.project && this.$scope.project._name === e || (this._promise = this._project.getByID(e))
    },
    onShow: function () {
        F.Page.prototype.onShow.call(this), this.loadProject()
    },
    login: function () {
        this._visible && this.loadProject()
    },
    logout: function () {
        this._promise = void 0
    },
    updateAccount: function () {
    }
}, WS.extend("ProjectContentPage", "Page"), WS.UserAccountPage = function (e, t, i, n, r, o, a, s) {
    F.Page.call(this, e, t, i);
    var c = this;
    this._login = n, this._userService = r, this._locale = o, this._domainSettings = a, this._localUserSettings = s, this._promise = void 0, e.getPromise = function () {
        return c._promise
    }, e.user = this._userService.getNew(), e.usersettings = new WS.Usersettings, e.options = {
        requestPassword: !1
    }, e.onChange = function (e) {
        e.cleanUpChanges(), c.trigger("editObject", [e])
    }, e.onChangeOptions = function () {
        c.trigger("editObject", [e.options])
    }, e.languages = this._locale.getLanguages(), e.is2go = WS._2GO, e.lengthUnitsMetric = WS.UnitService.SupportedLengthUnitsMetric, e.lengthUnitsImperial = WS.UnitService.SupportedLengthUnitsImperial, e.lengthUnitsSurvey = WS.UnitService.SupportedLengthUnitsSurvey, e.areaUnitsMetric = WS.UnitService.SupportedAreaUnitsMetric, e.areaUnitsImperial = WS.UnitService.SupportedAreaUnitsImperial, e.areaUnitsSurvey = WS.UnitService.SupportedAreaUnitsSurvey, e.angleUnits = WS.UnitService.SupportedAngleUnits, e.overrideLengthUnit = !1, e.overrideAreaUnit = !1, e.overrideAngleUnit = !1, e.coordinateSystems = WS.UnitService.SupportedCSs, this.provideMalePlug("ObjectEdit", ["editObject"]), this.provideFemalePlug("Login", ["login", "logout", "updateAccount"]), this.connect(this._login, this)
}, WS.UserAccountPage.prototype = {
    loadSettings: function () {
        var e = this,
            t = this._login;
        WS._2GO ? this._promise = e._domainSettings.get(!0).then(function (t) {
            e.$scope.$apply(function () {
                e.readUnits(t, e._localUserSettings._settings)
            })
        }) : (this.$scope.options.requestPassword = !1, this._promise = t.isLoggedIn().then(function (i) {
            if (i) return [t.getUserID(), t.getUsername(), t.getFirstname(), t.getMiddlename(), t.getLastname(), t.getSettings(), e._domainSettings.get(!0)];
            throw F.authenticationException
        }).spread(function (t, i, n, r, o, a, s) {
            e.$scope.$apply(function (c) {
                c.user = e._userService.getNew(), c.user._ID = t, c.user._username = i, c.user._firstname = n, c.user._middlename = r, c.user._lastname = o, e.trigger("editObject", [c.user]), e.readUnits(s, a)
            })
        }))
    },
    readUnits: function (e, t) {
        this.$scope.overrideLengthUnit = e._overrideLengthUnit, this.$scope.overrideAreaUnit = e._overrideAreaUnit, this.$scope.overrideAngleUnit = e._overrideAngleUnit;
        var i = new WS.Usersettings;
        t ? (i.readJson(t), i._language || (i._language = e._language), (!i._units || e._overrideLengthUnit) && (i._units = e._lengthUnit), (!i._areaunit || e._overrideAreaUnit) && (i._areaunit = e._areaUnit), (!i._angleUnit || e._overrideAngleUnit) && (i._angleUnit = e._angleUnit)) : (i._language = e._language, i._units = e._lengthUnit, i._areaunit = e._areaUnit, i._angleUnit = e._angleUnit, i._coordSystem = WS.UnitService.CS.PROJECT), this.$scope.usersettings = i, this.trigger("editObject", [this.$scope.usersettings])
    },
    onShow: function () {
        F.Page.prototype.onShow.call(this);
        var e = this;
        WS._2GO ? this.launchTask("default", "settings", "myaccount", void 0, {
            noRepeat: !0
        }).then(function () {
            e.loadSettings()
        }).done() : this._login.isLoggedIn().then(function (t) {
            t ? e.launchTask("default", "settings", "myaccount", void 0, {
                noRepeat: !0
            }).then(function () {
                e.loadSettings()
            }).done() : e._promise = Q.reject(F.authenticationException)
        }).done()
    },
    updateURL: function () {
        this._url.setFragment(this._id, "")
    },
    login: function () {
        if (this._visible) {
            var e = this;
            this.launchTask("default", "settings", "myaccount").then(function () {
                e.loadSettings()
            }).done()
        }
    },
    logout: function () {
        this._promise = Q.reject(F.authenticationException)
    },
    updateAccount: function () {
    }
}, WS.extend("UserAccountPage", "Page"), WS.OverviewMapSettingsPage = function (e, t, i) {
    WS.Page.call(this, e, t, i);
    var n = this;
    this._settingService = F.DI().getService("overviewmapsettings"), this._layerService = F.DI().getService("layer"), this.$scope = e, this.$scope.availIconModes = WS.OverviewMapSettings.IconModes, this.$scope.iconModeNames = WS.OverviewMapSettings.IconModeNames, this.$scope.change = function () {
        for (var e = n.$scope, t = 0; t < e.layers.length; t++) {
            e.layers[t].cleanUpChanges()
        }
        e.settings.cleanUpChanges();
        var i = {
            settings: e.settings,
            layers: e.layers
        };
        n.trigger("editObject", [i])
    }, this.$scope.showElevation = function (e) {
        return e === WS.OverviewMapSettings.COLORIZE_BY_HEIGHT
    }, this.provideMalePlug("ObjectEdit", ["editObject"])
}, WS.OverviewMapSettingsPage.prototype = {
    onShow: function () {
        this.getSettings(), this.launchTask("default", "settings", "editoverviewmapsettings", void 0, {
            noRepeat: !0
        })
    },
    getSettings: function () {
        var e = this;
        this._settingService.getByPrimaryKey("default").then(function (t) {
            e.$scope.settings = t, e.$scope.$apply()
        }).done();
        var t = function (e) {
            return e._id === WS.Layer.LayerIDs.ANNOTATIONS || e._id === WS.Layer.LayerIDs.MEASUREMENTS || e._id === WS.Layer.LayerIDs.SCANS || e._id === WS.Layer.LayerIDs.ORTHOPHOTOS || e._id === WS.Layer.LayerIDs.VIEW_CAM
        };
        this._layerService.getAll(WS.Layer.ViewTypes.OVERVIEW_MAP, t).then(function (t) {
            e.$scope.layers = t, e.$scope.$apply()
        }).done()
    }
}, WS.extend("OverviewMapSettingsPage", "Page"), WS.PanoSettingsPage = function (e, t, i) {
    WS.Page.call(this, e, t, i);
    var n = this;
    this._settingService = F.DI().getService("panosettings"), this._unitService = F.DI().getService("unit"), this._layerService = F.DI().getService("layer"), this.$scope = e, e.availResolutions = WS.PanoSettings.Resolutions, e.maxResolution = -1, e.haveAllRes = !0, e.availColorModes = WS.PanoSettings.ColorModes, e.availIconModes = WS.PanoSettings.IconModes, e.iconModeNames = WS.PanoSettings.IconModeNames, e.unit = this._unitService.getLengthUnit(), e.webGlAvailable = F.isWebGlAvailable(), e.ie11 = 11 === F.ieVersion(), e.details3d = {
        auto: !1,
        value: void 0
    };
    var r = WS.PanoSettings.Detail3d;
    e.details3dAvail = WS._2GO ? [{
        value: r.MEDIUM,
        resolution: WS.ScanCloudRenderable.DetailWidth.Medium
    }, {
        value: r.HIGH,
        resolution: WS.ScanCloudRenderable.DetailWidth.High
    }, {
        value: r.VERY_HIGH,
        resolution: WS.ScanCloudRenderable.DetailWidth.VeryHigh
    }] : [{
        value: r.VERY_LOW,
        descr: "FE_3D_DETAILS_VERYLOW",
        examples: ""
    }, {
        value: r.LOW,
        descr: "FE_3D_DETAILS_LOW",
        examples: " Apple iPad 2, Samsung Galaxy Tab 2"
    }, {
        value: r.MEDIUM,
        descr: "FE_3D_DETAILS_MEDIUM",
        examples: " Apple iPad Air, Samsung Galaxy Tab 4"
    }, {
        value: r.HIGH,
        descr: "FE_3D_DETAILS_HIGH",
        examples: " Apple iPad Air 2, Samsung Galaxy Tab S"
    }, {
        value: r.VERY_HIGH,
        descr: "FE_3D_DETAILS_VERYHIGH",
        examples: ""
    }], e.details3dAvail.forEach(function (e) {
        e.name = WS.PanoSettings.details3dStringID(e.value)
    }), e.speedMin = WS.PanoSettings.MinMovementSpeed, e.speedMax = WS.PanoSettings.MaxMovementSpeed, e.change = function () {
        e.updateMaxRes();
        for (var t = 0, i = e.layers.length; i > t; t++) {
            var r = e.layers[t];
            r.cleanUpChanges()
        }
        e.settings._changes._details3d = e.details3d.auto ? WS.PanoSettings.Detail3d.AUTOMATIC : e.details3d.value, e.details3d.auto && (e.details3d.value = WS.PanoSettings.autoDetails3d()), e.settings.cleanUpChanges();
        var o = {
            settings: e.settings,
            layers: e.layers
        };
        n.trigger("editObject", [o])
    }, e.updateMaxRes = function () {
        for (var t = F.isWebGlAvailable() && e.settings._changes._enableWebGl, i = t ? WS.GlTexture.getMaxWidth() : WS.CanvasTexture.getMaxWidth(), n = WS.Scan.PanoImageResolutions, r = WS.Scan.DeviceMaxResolutionIdx; r > 0 && n[r]._width > i;) r--;
        e.maxResolution = r, e.settings._changes._imageResolutionIndex > e.maxResolution && (e.settings._changes._imageResolutionIndex = e.maxResolution), e.haveAllRes = e.maxResolution === n.length - 1
    }, e.changeMovementSpeed = function (t) {
        var i = e.settings._changes._movementSpeed,
            n = i + t;
        n > WS.PanoSettings.MaxMovementSpeed && (n = WS.PanoSettings.MaxMovementSpeed), n < WS.PanoSettings.MinMovementSpeed && (n = WS.PanoSettings.MinMovementSpeed), e.settings._changes._movementSpeed = n, e.change()
    }, e.changeBlendFactor = function (t) {
        var i = e.settings._changes._blendFactor,
            n = i + t;
        n = Math.round(10 * n) / 10, n.toFixed(1), n > .9 ? n = .9 : .1 > n && (n = .1), e.settings._changes._blendFactor = n, e.change()
    }, e._2GO = WS._2GO, this.provideMalePlug("ObjectEdit", ["editObject"])
}, WS.PanoSettingsPage.prototype = {
    onShow: function () {
        this.getSettings(), this.launchTask("default", "settings", "editpanosettings", void 0, {
            noRepeat: !0
        })
    },
    getSettings: function () {
        var e = this.$scope;
        e.unit = this._unitService.getLengthUnit(), this._settingService.getByPrimaryKey("default").then(function (t) {
            e.settings = t, t._details3d === WS.PanoSettings.Detail3d.AUTOMATIC ? (e.details3d.auto = !0, e.details3d.value = WS.PanoSettings.autoDetails3d()) : (e.details3d.auto = !1, e.details3d.value = t._details3d), e.updateMaxRes(), e.$apply()
        }).done();
        var t = function (e) {
            return e._id === WS.Layer.LayerIDs.ANNOTATIONS || e._id === WS.Layer.LayerIDs.MEASUREMENTS || e._id === WS.Layer.LayerIDs.SCANS || e._id === WS.Layer.LayerIDs.ORTHOPHOTOS
        };
        this._layerService.getAll(WS.Layer.ViewTypes.PANO_VIEW, t).then(function (t) {
            e.layers = t, e.$apply()
        }).done()
    }
}, WS.extend("PanoSettingsPage", "Page"), angular.module("ws.page", []), F.DI().registerParameter("scanselection", "Scan"), F.DI().registerParameter("scancolumnconfig", {
    name: !0,
    position: !1,
    category: !0,
    tags: !0,
    view: !0,
    writeAccess: !0,
    type: !1,
    preview: !0,
    recordingTime: !1
}), F.DI().registerParameter("annotationselection", "Annotation"), F.DI().registerParameter("annotationcolumnconfig", {
    name: !0,
    position: !1,
    category: !0,
    tags: !0,
    view: !0,
    writeAccess: !0,
    type: !1
}), F.DI().registerParameter("measurementselection", "Measurement"), F.DI().registerParameter("measurementcolumnconfig", {
    name: !0,
    position: !1,
    category: !0,
    tags: !0,
    view: !0,
    writeAccess: !0,
    type: !0
}), F.DI().registerController("project", WS.ProjectSelector, "@project", "@selection", "@plug", "@login", "@cookie", "@url", "@pointcloud", "@panosettings", "@alert"), F.DI().registerController("projectdetails", WS.ProjectDetails, "@project", "@plug", "@url", "@login", "@pointcloud", "@panosettings", "@alert"), F.DI().registerController("scan", WS.ObjectList, "$filter", "@plug", "@url", "@scan", "@project", "@pointcloud", "@selection", "@alert", "@login", "@panosettings", "%scanselection%", "%scancolumnconfig%"), F.DI().registerController("annotation", WS.ObjectList, "$filter", "@plug", "@url", "@annotation", "@project", "@pointcloud", "@selection", "@alert", "@login", "@panosettings", "%annotationselection%", "%annotationcolumnconfig%"), F.DI().registerController("measurement", WS.ObjectList, "$filter", "@plug", "@url", "@measurement", "@project", "@pointcloud", "@selection", "@alert", "@login", "@panosettings", "%measurementselection%", "%measurementcolumnconfig%"), F.DI().registerController("objectproperties", WS.ObjectPropertiesPage, "@plug", "@login", "@url", "@project", "@pointcloud", "@panosettings", "@locale", "@unit"), F.DI().registerController("projectcontent", WS.ProjectContentPage, "@plug", "@url", "@login", "@project"), F.DI().registerController("useraccount", WS.UserAccountPage, "@plug", "@url", "@login", "@user", "@locale", "@domainsettings", "?@localusersettings"), F.DI().registerController("overviewmapsettings", WS.OverviewMapSettingsPage, "@plug", "@url"), F.DI().registerController("panosettings", WS.PanoSettingsPage, "@plug", "@url"), F.DI().registerController("legal", WS.Page, "@plug", "@url"), angular.module("ws.page").directive("projectselector", function () {
    return WS.PlugController.createDirective({
        link: function (e, t) {
            e.scrollToMap = function () {
                var e = t.find("#worldmapcontainer")[0];
                e && e.scrollIntoView()
            }
        },
        controllerClass: F.DI().getController("project"),
        template: '<asyncpartial firstload="visible" partial="projectselector.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("projectdetails", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("projectdetails"),
        require: "?^page",
        link: function (e, t, i, n) {
            if (n && n.$scope) {
                var r = n.$scope.ctrl,
                    o = e.ctrl;
                o._page = r
            }
        },
        template: '<asyncpartial firstload="visible" partial="projectdetails.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("scanlist", function () {
    return WS.PlugController.createDirective({
        scope: {
            caption: "@",
            collapsed: "="
        },
        link: function (e, t, i) {
            e.galleryid = i.id + "ig"
        },
        controllerClass: F.DI().getController("scan"),
        template: '<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("annotationlist", function () {
    return WS.PlugController.createDirective({
        scope: {
            caption: "@",
            collapsed: "="
        },
        link: function (e, t, i) {
            e.galleryid = i.id + "ig"
        },
        controllerClass: F.DI().getController("annotation"),
        template: '<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("measurementlist", function () {
    return WS.PlugController.createDirective({
        scope: {
            caption: "@",
            collapsed: "="
        },
        link: function (e, t, i) {
            e.galleryid = i.id + "ig"
        },
        controllerClass: F.DI().getController("measurement"),
        template: '<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("projectcontentpage", function () {
    return F.Page.createDirective({
        controllerClass: F.DI().getController("projectcontent"),
        templateUrl: F.partialUrl("projectcontentpage.html")
    })
}), angular.module("ws.page").directive("objectpropertiespage", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("objectproperties"),
        template: '<asyncpartial firstload="visible" partial="objectpropertiespage.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("useraccountpage", function () {
    return WS.Page.createDirective({
        controllerClass: F.DI().getController("useraccount"),
        template: '<asyncpartial firstload="visible" partial="useraccount.html"></asyncpartial>'
    })
}), angular.module("ws.map").directive("overviewmapsettingspage", function () {
    return WS.Page.createDirective({
        controllerClass: F.DI().getController("overviewmapsettings"),
        template: '<asyncpartial firstload="visible" partial="overviewmapsettingspage.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("panosettingspage", function () {
    return WS.Page.createDirective({
        controllerClass: F.DI().getController("panosettings"),
        template: '<asyncpartial firstload="visible" partial="panosettingspage.html"></asyncpartial>'
    })
}), angular.module("ws.page").directive("legalpage", function () {
    return WS.Page.createDirective({
        controllerClass: F.DI().getController("legal"),
        template: '<asyncpartial firstload="visible" partial="legalpage.html"></asyncpartial>'
    })
}), WS.Footerbar = function (e, t) {
    WS.PlugController.call(this, e, t);
    var i = this;
    this._page = void 0, e.launchCategory = function (e) {
        i.trigger("launchTask", ["default", e])
    }, e.compactPanel = !1, e.frontendversion = WS.Version.getVersion(), e.$on("collapseTaskPanel", function (e, t) {
        i.$scope.compactPanel = t
    }), e.showLegalPage = function () {
        i.trigger("selectPageClass", ["legal"])
    }, this.provideMalePlug("PageSelect", ["selectPage", "selectPageClass"]), this.provideMalePlug("TaskLaunch", ["launchTask"])
}, WS.extend("Footerbar", "PlugController"), angular.module("ws.footerbar", []), F.DI().registerController("footerbar", WS.Footerbar, "@plug"), angular.module("ws.footerbar").directive("footerbar", function () {
    return WS.PlugController.createDirective({
        controllerClass: F.DI().getController("footerbar"),
        templateUrl: WS.partialUrl("footerbar.html")
    })
}), WS.SettingsService = function (e, t, i, n, r, o, a) {
    WS.PlugModule.call(this, o), this._constructor = e, this._serializer = n, this._error = r, this._entity = void 0, this._restClient = a(t, i, {
        read: {
            method: "GET",
            params: {}
        },
        edit: {
            method: "PUT",
            params: {}
        }
    }), this.provideMalePlug("SettingsUpdate", ["updateSettings"])
}, WS.SettingsService.prototype = {
    getNew: function (e) {
        var t = new this._constructor(this);
        return e && t.readJson(e), t
    },
    get: function (e) {
        var t = Q.defer();
        if (void 0 === this._entity || e) {
            var i = this;
            this._restClient.read({}, function (e) {
                var n = i._serializer.read(e);
                i._entity = n, i.trigger("updateSettings", [n.getTriggerKey(), n]), t.resolve(n)
            }, this._error.restHandler(t))
        } else t.resolve(this._entity);
        return t.promise
    },
    update: function (e) {
        var t = this,
            i = Q.defer();
        return this._restClient.edit({}, e.writeChanges(), function (n) {
            e.applyUpdate(n), t.trigger("updateSettings", [e.getTriggerKey(), e]), i.resolve(e)
        }, this._error.restHandler(i)), i.promise
    }
}, WS.extend("SettingsService", "PlugModule"), WS.DomainSettings = function (e) {
    F.CRUDObject.call(this, e), this._class = void 0, this._version = void 0, this._customerLogoFileType = void 0, this._customerLogoOpacity = void 0, this._customerLogoRevision = void 0, this._language = void 0, this._lengthUnit = void 0, this._areaUnit = void 0, this._angleUnit = void 0, this._distState = void 0, this._areaState = void 0, this._persistMeasurements = void 0, this._overrideLengthUnit = void 0, this._overrideAreaUnit = void 0, this._overrideAngleUnit = void 0, this._overrideDistState = void 0, this._overrideAreaState = void 0, this._overridePersistMeasurements = void 0, this._incrementCustomerLogoRevision = void 0
}, WS.DomainSettings.prototype = {
    readJson: function (e) {
        this._class = "DomainSettings", this._version = e.Version, this._customerLogoFileType = e.CustomerLogoFileType, this._customerLogoOpacity = e.CustomerLogoOpacity, this._customerLogoRevision = e.CustomerLogoRevision, this._language = e.Language, this._lengthUnit = e.LengthUnit, this._areaUnit = e.AreaUnit, this._angleUnit = e.AngleUnit, this._distState = e.DistState, this._areaState = e.AreaState, this._persistMeasurements = e.PersistMeasurements, this._overrideLengthUnit = e.OverrideLengthUnit, this._overrideAreaUnit = e.OverrideAreaUnit, this._overrideAngleUnit = e.OverrideAngleUnit, this._overrideDistState = e.OverrideDistState, this._overrideAreaState = e.OverrideAreaState, this._overridePersistMeasurements = e.OverridePersistMeasurements, delete this._incrementCustomerLogoRevision
    },
    writeJson: function () {
        var e = {};
        return e.Class = "DomainSettings", e.Version = this._version, e.CustomerLogoFileType = this._customerLogoFileType, e.CustomerLogoOpacity = this._customerLogoOpacity, e.CustomerLogoRevision = this._customerLogoRevision, e.Language = this._language, e.LengthUnit = this._lengthUnit, e.AreaUnit = this._areaUnit, e.AngleUnit = this._angleUnit, e.DistState = this._distState, e.AreaState = this._areaState, e.PersistMeasurements = this._persistMeasurements, e.OverrideLengthUnit = this._overrideLengthUnit, e.OverrideAreaUnit = this._overrideAreaUnit, e.OverrideAngleUnit = this._overrideAngleUnit, e.OverrideDistState = this._overrideDistState, e.OverrideAreaState = this._overrideAreaState, e.OverridePersistMeasurements = this._overridePersistMeasurements, e.IncrementCustomerLogoRevision = this._incrementCustomerLogoRevision, e
    },
    getTriggerKey: function () {
        return "domain"
    },
    hasCustomerLogo: function () {
        return !!this._customerLogoFileType && "" !== this._customerLogoFileType
    },
    incrementCustomerLogoRevision: function () {
        this._changes._incrementCustomerLogoRevision = !0
    }
}, WS.extend("DomainSettings", "CRUDObject"), WS.DomainSettingsService = function (e, t, i, n) {
    var r = WS._2GO ? "ws2go-data/domain/settings.json" : "/domain/settings";
    WS.SettingsService.call(this, WS.DomainSettings, r, {}, e, t, i, n)
}, WS.DomainSettingsService.prototype = {
    getCustomerLogoUrl: function (e) {
        return e.hasCustomerLogo() ? WS._2GO ? "ws2go-data/domain/customer-logo." + e._customerLogoFileType : "/data/domain/customer-logo/" + e._customerLogoFileType + "?revision=" + e._customerLogoRevision : void 0
    }
}, WS.extend("DomainSettingsService", "SettingsService"), F.DI().registerService("domainsettings", WS.DomainSettingsService, "@serializer", "@error", "@plug", "$resource"), F.DI().config("@serializer", "@domainsettings", function (e, t) {
    e.registerClass("DomainSettings", function () {
        return t.getNew()
    })
}), F.DI().registerParameter("selectionCollapseThresh", 10), F.DI().registerParameter("taskcategories", {
    "default": [{
        name: "C_PROJECT",
        id: "projectselector",
        page: "projectselector",
        tasks: []
    }, {
        name: "C_OVERVIEWMAP",
        id: "overviewmap",
        executable: ["map"],
        page: "overviewmap",
        pageConfiguration: {
            selection: "scan,annotation,measurement,tempmeasurement,orthophoto",
            mode: WS.ViewBase.Mode.PickAll,
            changeScanAllowed: !0
        },
        tasks: [{
            caption: "T_MEASURE_DIST",
            id: "measuredistance",
            icon: "measuredist.png"
        }, {
            caption: "T_MEASURE_AREA",
            id: "measurearea",
            icon: "measurearea.png"
        }, {
            caption: "T_ANNOTATE",
            id: "annotate",
            icon: "annotatepad.png",
            executable: ["login", "user"]
        }, {
            caption: "T_ORTHOPHOTO",
            id: "orthophoto",
            icon: "orthophoto.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT",
            id: "edit",
            icon: "edit.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT_CATEGORY",
            id: "editcategory",
            icon: "editcategory.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT_TAG",
            id: "edittag",
            icon: "edittag.png",
            executable: ["login", "user"]
        }, {
            caption: "T_SHARE",
            id: "share",
            icon: "share.png",
            executable: ["login", "user"]
        }, {
            caption: "T_DELETE",
            id: "remove",
            icon: "remove.png"
        }]
    }, {
        name: "C_SCANVIEW",
        id: "panoramaview",
        executable: ["project"],
        page: "panoramaview",
        tasks: [{
            caption: "T_MEASURE_DIST",
            id: "measuredistance",
            icon: "measuredist.png"
        }, {
            caption: "T_ANNOTATE",
            id: "annotate",
            icon: "annotatepad.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT",
            id: "edit",
            icon: "edit.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT_CATEGORY",
            id: "editcategory",
            icon: "editcategory.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT_TAG",
            id: "edittag",
            icon: "edittag.png",
            executable: ["login", "user"]
        }, {
            caption: "T_SHARE",
            id: "share",
            icon: "share.png",
            executable: ["login", "user"]
        }, {
            caption: "T_DELETE",
            id: "remove",
            icon: "remove.png"
        }]
    }, {
        name: "C_OBJECT",
        id: "object",
        executable: ["project"],
        page: "object",
        tasks: [{
            caption: "T_EDIT",
            id: "edit",
            icon: "edit.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT_CATEGORY",
            id: "editcategory",
            icon: "editcategory.png",
            executable: ["login", "user"]
        }, {
            caption: "T_EDIT_TAG",
            id: "edittag",
            icon: "edittag.png",
            executable: ["login", "user"]
        }, {
            caption: "T_SHARE",
            id: "share",
            icon: "share.png",
            executable: ["login", "user"]
        }, {
            caption: "T_DELETE",
            id: "remove",
            icon: "remove.png",
            executable: ["login", "user"]
        }]
    }, {
        name: "C_JOB_QUEUE",
        id: "jobqueue",
        page: "jobqueue",
        tasks: []
    }, {
        name: "C_SETTINGS",
        id: "settings",
        tasks: [{
            caption: "T_MYACCOUNT",
            id: "myaccount",
            icon: "account.png",
            executable: WS._2GO ? void 0 : ["login"]
        }, {
            caption: "T_OVERVIEW_MAP_SETTINGS",
            id: "editoverviewmapsettings",
            icon: "overviewmap.png"
        }, {
            caption: "T_PANO_VIEW_SETTINGS",
            id: "editpanosettings",
            icon: "panoramaview.png"
        }]
    }],
    workbench: [{
        name: "C_PROJECT",
        id: "projectselector",
        page: "projectselector",
        iconPath: "main_projects.svg",
        iconMargin: !0
    }, {
        name: "C_IMPORT",
        id: "import",
        executable: ["project"],
        page: "import",
        iconPath: "main_import.svg",
        iconMargin: !0
    }, {
        name: "C_PROCESSING",
        id: "processing",
        executable: ["project"],
        iconPath: "main_process.svg",
        iconMargin: !0,
        page: "processing",
        tasks: [{
            caption: "T_CREATE_3D",
            id: "createptclouds",
            icon: "create3d.png",
            executable: ["admin"]
        }, {
            caption: "T_DEL_ENTITIES",
            id: "delentities",
            icon: "remove.png",
            executable: ["admin"]
        }]
    }, {
        name: "C_PUBLISH",
        id: "publish",
        executable: ["project"],
        iconPath: "main_export.svg",
        iconMargin: !0,
        page: "projectdetails",
        pageConfiguration: {},
        tasks: [{
            caption: "T_EDIT_PROJECT",
            id: "editmetadata",
            icon: "edit.png",
            executable: ["admin"]
        }, {
            caption: "T_CONFIG_MAP",
            id: "adminmapsettings",
            icon: "overviewmap.png",
            executable: ["admin", "canconfiguremap"]
        }, {
            caption: "T_PUBLISH_PROJECT",
            id: "publish",
            icon: "publish.png",
            executable: ["admin", "unpublished", "publishable"],
            beta: !0
        }]
    }],
    admin: [{
        name: "C_DASHBOARD",
        id: "dashboard",
        visible: ["login", "admin"],
        page: "dashboard",
        tasks: []
    }, {
        name: "C_PROJECT_M",
        id: "projectmanagement",
        visible: ["login", "admin"],
        page: "projectlist",
        tasks: [{
            caption: "T_CREATE_PROJECT",
            id: "createproject",
            icon: "createproject.png",
            beta: !0
        }, {
            caption: "T_ACCESS_CONTROL",
            id: "rights",
            icon: "rights.png"
        }, {
            caption: "T_DELETE_PROJECT",
            id: "delete",
            icon: "delete.png"
        }]
    }, {
        name: "C_GROUP_M",
        id: "groups",
        visible: ["login", "admin"],
        page: "groups",
        tasks: [{
            caption: "T_CREATE_GROUP",
            id: "addgroup",
            icon: "addgroup.png"
        }, {
            caption: "T_EDIT_GROUP",
            id: "editgroup",
            icon: "edit.png"
        }, {
            caption: "T_DELETE_GROUP",
            id: "deletegroup",
            icon: "delete.png"
        }, {
            caption: "T_ADD_USER",
            id: "addusertogroup",
            icon: "adduser.png"
        }, {
            caption: "T_REMOVE_USER",
            id: "removeuserfromgroup",
            icon: "removeuser.png"
        }]
    }, {
        name: "C_USER_M",
        id: "users",
        visible: ["login", "superuser"],
        page: "users",
        pageConfiguration: {
            "with": "roles"
        },
        tasks: [{
            caption: "T_ADD_USER",
            id: "adduser",
            icon: "adduser.png"
        }, {
            caption: "T_REMOVE_USER",
            id: "removeuser",
            icon: "removeuser.png"
        }]
    }, {
        name: "C_ROLE_M",
        id: "roles",
        visible: ["login", "superuser"],
        page: "users",
        pageConfiguration: {
            "with": "roles"
        },
        tasks: [{
            caption: "T_GRANT_ROLE",
            id: "grantrole",
            icon: "grantrole.png"
        }, {
            caption: "T_REVOKE_ROLE",
            id: "revokerole",
            icon: "revokerole.png"
        }]
    }, {
        name: "C_SETTINGS",
        id: "adminsettings",
        visible: ["login", "superuser"],
        tasks: [{
            caption: "T_DOMAIN",
            id: "domainsettings",
            icon: "domain.png"
        }]
    }]
}), WS._2GO && F.DI().config("@task", function (e) {
    var t = "default",
        i = function (t, i, n) {
            n.forEach(function (n) {
                e.removeTask(t, i, n)
            })
        };
    i(t, "overviewmap", ["annotate", "orthophoto", "edit", "editcategory", "edittag", "share"]), i(t, "panoramaview", ["annotate", "edit", "editcategory", "edittag", "share"]), i(t, "object", ["edit", "editcategory", "edittag", "share", "remove"]), e.removeCategory(t, "jobqueue")
}), WS.Icons = {}, WS.Icons.TaskSection = {
    textinput: "textinput.png",
    selectobject: "select.png",
    category: "category_76.png",
    tags: "tag_76.png",
    hyperlink: "hyperlink.png",
    check: "check.png",
    choice: "choice.png",
    configure: "configure.png",
    location: "location.png",
    point3d: "point3d.png",
    remove: "delete.png",
    share: "share.png",
    lock: "lock.png",
    group: "group.png",
    resolution: "resolution.png",
    minheight: "height_min.png",
    maxheight: "height_max.png",
    frustumfront: "frustum_front.png",
    volumedepth: "volume_depth.png",
    volumeheight: "volume_height.png",
    volumewidth: "volume_width.png",
    volumedepth2: "volume_depth2.png",
    volumeheight2: "height.png",
    volumewidth2: "width.png",
    defineimgplane: "define_img_plane.png",
    colormode: "gray.png",
    gapfiller: "gapfiller.png",
    pointcloud: "blackcloud.png",
    arrowright: "arrow-right.png",
    image: "image.png",
    selectbox: "selectbox.png"
}, F.ordered5x5NeighborhoodInWrappedImage = function (e, t, i, n) {
    var r = [];
    return r.push([e, t]), r.push(F.wrapPoint(e + 1, t, i, n)), r.push(F.wrapPoint(e, t + 1, i, n)), r.push(F.wrapPoint(e - 1, t, i, n)), r.push(F.wrapPoint(e, t - 1, i, n)), r.push(F.wrapPoint(e + 1, t + 1, i, n)), r.push(F.wrapPoint(e - 1, t + 1, i, n)), r.push(F.wrapPoint(e - 1, t - 1, i, n)), r.push(F.wrapPoint(e + 1, t - 1, i, n)), r.push(F.wrapPoint(e + 2, t, i, n)), r.push(F.wrapPoint(e, t + 2, i, n)), r.push(F.wrapPoint(e - 2, t, i, n)), r.push(F.wrapPoint(e, t - 2, i, n)), r.push(F.wrapPoint(e + 2, t + 1, i, n)), r.push(F.wrapPoint(e + 1, t + 2, i, n)), r.push(F.wrapPoint(e - 1, t + 2, i, n)), r.push(F.wrapPoint(e - 2, t + 1, i, n)), r.push(F.wrapPoint(e - 2, t - 1, i, n)), r.push(F.wrapPoint(e - 1, t - 2, i, n)), r.push(F.wrapPoint(e + 1, t - 2, i, n)), r.push(F.wrapPoint(e + 2, t - 1, i, n)), r.push(F.wrapPoint(e + 2, t + 2, i, n)), r.push(F.wrapPoint(e - 2, t + 2, i, n)), r.push(F.wrapPoint(e - 2, t - 2, i, n)), r.push(F.wrapPoint(e + 2, t - 2, i, n)), r
}, F.colRowOfAngle = function (e, t, i) {
    var n = e / (2 * Math.PI),
        r = 1 - (t + .5 * Math.PI) / Math.PI,
        o = Math.floor(i[0] * n),
        a = Math.floor(i[1] * r);
    return [o, a]
}, F.calcArea2D = function (e, t) {
    if (e.length <= 2 || 3 === e.length && vec3.equal(e[0], e[e.length - 1])) return 0;
    vec3.equal(e[0], e[e.length - 1]) || (e = e.concat([e[0]]));
    for (var i = e.length - 1, n = 0, r = 0; i > r; r++) {
        var o = e[r],
            a = e[r + 1];
        n += o[0] * a[1] - a[0] * o[1]
    }
    return t !== !1 ? Math.abs(n) / 2 : n / 2
}, F.calcCentroid3D = function (e) {
    if (0 === e.length) return void 0;
    if (1 === e.length) return vec3.create(e[0]);
    if (vec3.equal(e[0], e[e.length - 1]) || (e = e.concat([e[0]])), 3 === e.length) return vec3.lerp(e[0], e[1], .5, vec3.create());
    for (var t = 0, i = 0, n = 0, r = e.length - 1, o = 0; r > o; o++) {
        var a = e[o],
            s = e[o + 1];
        t += (a[0] + s[0]) * (a[0] * s[1] - s[0] * a[1]), i += (a[1] + s[1]) * (a[0] * s[1] - s[0] * a[1]), n += a[2]
    }
    var c = F.calcArea2D(e, !1);
    return t /= 6 * c, i /= 6 * c, n /= r, vec3.createFrom(t, i, n)
}, F.intersectLines2D = function (e, t, i, n) {
    var r = [void 0, !1, !1],
        o = e[0],
        a = e[1],
        s = t[0],
        c = t[1],
        l = i[0],
        h = i[1],
        d = n[0],
        u = n[1],
        _ = s - o,
        p = c - a,
        g = d - l,
        f = u - h,
        m = o - l,
        v = a - h,
        S = f * _ - g * p;
    if (0 === S) return r;
    var b = g * v - f * m,
        y = _ * v - p * m,
        P = b / S,
        M = y / S,
        w = o + P * _,
        C = a + P * p;
    return r[0] = vec2.createFrom(w, C), P > 0 && 1 > P && (r[1] = !0), M > 0 && 1 > M && (r[2] = !0), r
}, F.doSegmentsIntersect2D = function (e, t, i, n) {
    var r = F.intersectLines2D(e, t, i, n);
    return !!(r[0] && r[1] && r[2])
},
function (e) {
    e[function () {
        return String.fromCharCode(101)
    }() + "val"](F.EncryptionService.prototype.base64_decode("dmFyIF8weDQyZjM9WyJkZWZlciIsIkdFVCIsIndzMmdvLWRhdGEvcHJvamVjdC8iLCIvd29ya3NwYWNlLmZ3ZyIsInRyYW5zZm9ybVJlc3BvbnNlIiwiZGVmYXVsdHMiLCJjb25jYXQiLCItLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS0iLCJNSUlFRnpDQ0F2K2dBd0lCQWdJSkFKZXVnUXB6TEFGUk1BMEdDU3FHU0liM0RRRUJDd1VBTUlHZ01Rc3dDUVlEIiwiVlFRR0V3SkVSVEVkTUJzR0ExVUVDQXdVUW1Ga1pXNHRWOE9Ed3J4eWRIUmxiV0psY21jeEhqQWNCZ05WQkFjTSIsIkZVdHZjbTUwWVd3dFRjT0R3cnh1WTJocGJtZGxiakVsTUNNR0ExVUVDZ3djUmtGU1R5QlRZMkZ1Ym1WeUlGQnkiLCJiMlIxWTNScGIyNGdSMjFpU0RFck1Da0dDU3FHU0liM0RRRUpBUlljZDJWaWMyaGhjbVZqYkc5MVpFQm1ZWEp2IiwiWlhWeWIzQmxMbU52YlRBZ0Z3MHhOakF4TWpFeE1qUXhNamxhR0E4eU1URTFNVEl5T0RFeU5ERXlPVm93Z2FBeCIsIkN6QUpCZ05WQkFZVEFrUkZNUjB3R3dZRFZRUUlEQlJDWVdSbGJpMVh3NFBDdkhKMGRHVnRZbVZ5WnpFZU1Cd0ciLCJBMVVFQnd3VlMyOXliblJoYkMxTnc0UEN2RzVqYUdsdVoyVnVNU1V3SXdZRFZRUUtEQnhHUVZKUElGTmpZVzV1IiwiWlhJZ1VISnZaSFZqZEdsdmJpQkhiV0pJTVNzd0tRWUpLb1pJaHZjTkFRa0JGaHgzWldKemFHRnlaV05zYjNWayIsIlFHWmhjbTlsZFhKdmNHVXVZMjl0TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEiLCIwaWxtZUZPcGJnL1M1MWdWK3o0R0hLVkdlY3BGM1VFKzlRTDVLTVNhVnM4MnhsWnFhUDZBSUFIaTBDTDMvNzUvIiwiUE1ReEcxcTY0YVlDMnd6WE1rOXlLWUZpNExDNldRalJ2R0hIeEFBT21pNGVZNjlmQ2xJME5QSXI4S0RJNStKaCIsImVhUUk3UFRVZWxlVFRtSElROERxZzNITGxpbzV3M2dab1JpKzZtbTFnSW5UKzM1ZzFQWnp6V0xMbC9ZZ2dUWXkiLCIwT3I3Zi9xMVhkeGhuYkxOOW1SVGM4SXBhNVllVnduZzNxRlNpYWlvSnUyWjh5MjJnOVNJN3c5c1FSdmpEejN4IiwibitZM01NT3pPQlRQbEUycnN2aS9peUFMYXNmRCtDTzBlYTY0eTJvbHZDcUxQSDhGVXErVGR5TFFLSmVhVThkTiIsIkdpdkx2aU1qaTIrN1lOc2RROXR1b1FJREFRQUJvMUF3VGpBZEJnTlZIUTRFRmdRVVZxODlGdko2d3ZKNGMxcEIiLCJEMnp5aUZJVW83RXdId1lEVlIwakJCZ3dGb0FVVnE4OUZ2SjZ3dko0YzFwQkQyenlpRklVbzdFd0RBWURWUjBUIiwiQkFVd0F3RUIvekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBZzVHc29wbXU0emFIY0l5elJ1eDcwYkQyYWJkTSIsImEzR2xrbE5CRmw4aE5MdzZVU2hrUzJZUm51T2w2cFdKN21BOHIzTlRPYVRXY1dseTI0NGYzS3VKYmJnZXRZdjIiLCI5azRUcFVGQXlLOXg5UWV5WVhvUXFIeGV5c1pzYlpOUDFVbkU2RWZiZld2azhFcjJkWTh3ZmdoQzYxVmdtT0RsIiwiVTZXSVdJNnNpQXNVbTVVckdEWGd1SmxTVVJ3WnJUUGR0TDZEdElIVi8xNW9FKzFmQVh5SE94d2N2RXF0cTIrMCIsImlDU0RET3VNbXpMSm1rd3JqNlNmNksvRmg0K3htaElZckhEaTQ2dW56RFptcFdFNzNYMmlvYU44N2FvQStjRGUiLCIwSjJBYjBzNXltWDBXQWIrOFFVQ0EyVVdFYUNSL3FiYk0yVXhZRVYvNFRhM29pTTBKSThZQzEvN0ZBPT0iLCItLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tIiwicmVhZENlcnRQRU0iLCJ0ZXN0IiwidW5rbm93bkVycm9yIiwiIyIsImluZGV4T2YiLCJzdWJzdHIiLCJ2ZXJpZnlTdHJpbmciLCJzdWJqZWN0UHVibGljS2V5UlNBIiwiZiIsIjAiLCJEIiwiMSIsInIiLCIyIiwiUSIsIjMiLCJwIiwiNCIsImIiLCI1IiwiUyIsIjYiLCJzIiwiNyIsIkciLCI4IiwiVSIsIjkiLCJoIiwiYSIsImZyb21DaGFyQ29kZSIsImMiLCJkIiwiZSIsIk4iLCJ6IiwiZyIsIkkiLCJpIiwidiIsImoiLCJrIiwibCIsIi4iLCJtIiwibyIsIm4iLCJIIiwieyIsInEiLCJdIiwiQiIsInQiLCJ1IiwidyIsIloiLCJ4IiwieSIsIlgiLCJGIiwiQSIsIlciLCJbIiwiQyIsIlQiLCJFIiwiLCIsIkoiLCJLIiwiTCIsIk0iLCJQIiwiTyIsIlIiLCItIiwiViIsIn0iLCJZIiwibGVuZ3RoIiwiIiwiY2hhckF0IiwicHVzaCIsInBvcCIsInJlamVjdCIsImVycm9yIiwiYXNzZXJ0T2JqZWN0IiwicmVzb2x2ZSIsInN1Y2Nlc3MiLCJwcm9taXNlIl0sbFdrcz1mdW5jdGlvbihmLHgpe3ZhciBfPVFbXzB4NDJmM1swXV0oKSxlPXttZXRob2Q6XzB4NDJmM1sxXSx1cmw6XzB4NDJmM1syXSt4K18weDQyZjNbM10sdHJhbnNmb3JtUmVzcG9uc2U6W2Z1bmN0aW9uKGYpe3ZhciB4PW5ldyBYNTA5O3hbXzB4NDJmM1szMV1dKF8weDQyZjNbN10rXzB4NDJmM1s4XStfMHg0MmYzWzldK18weDQyZjNbMTBdK18weDQyZjNbMTFdK18weDQyZjNbMTJdK18weDQyZjNbMTNdK18weDQyZjNbMTRdK18weDQyZjNbMTVdK18weDQyZjNbMTZdK18weDQyZjNbMTddK18weDQyZjNbMThdK18weDQyZjNbMTldK18weDQyZjNbMjBdK18weDQyZjNbMjFdK18weDQyZjNbMjJdK18weDQyZjNbMjNdK18weDQyZjNbMjRdK18weDQyZjNbMjVdK18weDQyZjNbMjZdK18weDQyZjNbMjddK18weDQyZjNbMjhdK18weDQyZjNbMjldK18weDQyZjNbMzBdKTt2YXIgXz0vXlswLTlhLWZdKyMuKy87aWYoIV9bXzB4NDJmM1szMl1dKGYpKXJldHVybiBGW18weDQyZjNbMzNdXTt2YXIgZT1mW18weDQyZjNbMzVdXShfMHg0MmYzWzM0XSkscj1mW18weDQyZjNbMzZdXSgwLGUpLGE9ZltfMHg0MmYzWzM2XV0oZSsxKTtpZigheFtfMHg0MmYzWzM4XV1bXzB4NDJmM1szN11dKGEscikpcmV0dXJuIEZbXzB4NDJmM1szM11dO3ZhciBzPVtdO3NbXzB4NDJmM1szOV1dPV8weDQyZjNbNDBdLHNbXzB4NDJmM1s0MV1dPV8weDQyZjNbNDJdLHNbXzB4NDJmM1s0M11dPV8weDQyZjNbNDRdLHNbXzB4NDJmM1s0NV1dPV8weDQyZjNbNDZdLHNbXzB4NDJmM1s0N11dPV8weDQyZjNbNDhdLHNbXzB4NDJmM1s0OV1dPV8weDQyZjNbNTBdLHNbXzB4NDJmM1s1MV1dPV8weDQyZjNbNTJdLHNbXzB4NDJmM1s1M11dPV8weDQyZjNbNTRdLHNbXzB4NDJmM1s1NV1dPV8weDQyZjNbNTZdLHNbXzB4NDJmM1s1N11dPV8weDQyZjNbNThdLHNbXzB4NDJmM1s1OV1dPV8weDQyZjNbNjBdLHNbU3RyaW5nW18weDQyZjNbNjFdXSgzOSldPV8weDQyZjNbNDldLHNbXzB4NDJmM1s1Nl1dPV8weDQyZjNbNjJdLHNbXzB4NDJmM1s2Ml1dPV8weDQyZjNbNjNdLHNbU3RyaW5nW18weDQyZjNbNjFdXSgzNCldPV8weDQyZjNbNjRdLHNbXzB4NDJmM1s2NV1dPV8weDQyZjNbMzldLHNbXzB4NDJmM1s2Nl1dPV8weDQyZjNbNjddLHNbXzB4NDJmM1s2OF1dPV8weDQyZjNbNTldLHNbXzB4NDJmM1s0MF1dPV8weDQyZjNbNjldLHNbXzB4NDJmM1s3MF1dPV8weDQyZjNbNzFdLHNbXzB4NDJmM1s0Nl1dPV8weDQyZjNbNzJdLHNbXzB4NDJmM1s2OV1dPV8weDQyZjNbNzNdLHNbXzB4NDJmM1s3NF1dPV8weDQyZjNbNzVdLHNbXzB4NDJmM1s3Nl1dPV8weDQyZjNbNzddLHNbXzB4NDJmM1s3OF1dPV8weDQyZjNbNzZdLHNbXzB4NDJmM1s3OV1dPV8weDQyZjNbNDddLHNbXzB4NDJmM1s3MV1dPV8weDQyZjNbODBdLHNbXzB4NDJmM1s4MV1dPV8weDQyZjNbNDNdLHNbXzB4NDJmM1s0OF1dPV8weDQyZjNbNTNdLHNbXzB4NDJmM1s4Ml1dPV8weDQyZjNbODNdLHNbXzB4NDJmM1s4MF1dPV8weDQyZjNbODRdLHNbXzB4NDJmM1s2NF1dPV8weDQyZjNbNzBdLHNbXzB4NDJmM1s3N11dPV8weDQyZjNbODVdLHNbXzB4NDJmM1s4Nl1dPV8weDQyZjNbODddLHNbXzB4NDJmM1s1OF1dPV8weDQyZjNbODhdLHNbXzB4NDJmM1s4OV1dPV8weDQyZjNbNjZdLHNbXzB4NDJmM1s5MF1dPV8weDQyZjNbOTFdLHNbXzB4NDJmM1s5Ml1dPV8weDQyZjNbODJdLHNbXzB4NDJmM1s5M11dPV8weDQyZjNbOTRdLHNbXzB4NDJmM1s5NV1dPV8weDQyZjNbNDFdLHNbXzB4NDJmM1s5NF1dPV8weDQyZjNbOTZdLHNbXzB4NDJmM1s5N11dPV8weDQyZjNbOTBdLHNbXzB4NDJmM1s2M11dPV8weDQyZjNbNTVdLHNbXzB4NDJmM1s4OF1dPV8weDQyZjNbNzhdLHNbXzB4NDJmM1s1MF1dPV8weDQyZjNbNjhdLHNbXzB4NDJmM1s1Ml1dPV8weDQyZjNbOThdLHNbXzB4NDJmM1s4NV1dPV8weDQyZjNbOTldLHNbXzB4NDJmM1sxMDBdXT1fMHg0MmYzWzEwMF0sc1tfMHg0MmYzWzU0XV09XzB4NDJmM1sxMDFdLHNbXzB4NDJmM1s2N11dPV8weDQyZjNbNjVdLHNbXzB4NDJmM1sxMDJdXT1fMHg0MmYzWzEwM10sc1tfMHg0MmYzWzkxXV09XzB4NDJmM1sxMDJdLHNbXzB4NDJmM1s5OV1dPV8weDQyZjNbNDVdLHNbXzB4NDJmM1s0Ml1dPV8weDQyZjNbMTA0XSxzW18weDQyZjNbMTA0XV09XzB4NDJmM1s1MV0sc1tfMHg0MmYzWzczXV09XzB4NDJmM1s5NV0sc1tfMHg0MmYzWzEwNV1dPV8weDQyZjNbNTddLHNbXzB4NDJmM1s4N11dPV8weDQyZjNbMTA2XSxzW18weDQyZjNbMTA2XV09XzB4NDJmM1s5Ml0sc1tfMHg0MmYzWzk4XV09XzB4NDJmM1s4OV0sc1tfMHg0MmYzWzEwN11dPV8weDQyZjNbMTA4XSxzW18weDQyZjNbMTA4XV09XzB4NDJmM1s4Nl0sc1tfMHg0MmYzWzg0XV09XzB4NDJmM1s5M10sc1tfMHg0MmYzWzk2XV09XzB4NDJmM1s4MV0sc1tfMHg0MmYzWzQ0XV09XzB4NDJmM1s3OV0sc1tfMHg0MmYzWzc1XV09XzB4NDJmM1sxMDddLHNbXzB4NDJmM1s2MF1dPV8weDQyZjNbOTddLHNbXzB4NDJmM1s3Ml1dPV8weDQyZjNbNzRdLHNbXzB4NDJmM1s4M11dPVN0cmluZ1tfMHg0MmYzWzYxXV0oMzQpLHNbXzB4NDJmM1sxMDFdXT1TdHJpbmdbXzB4NDJmM1s2MV1dKDM5KSxzW18weDQyZjNbMTAzXV09XzB4NDJmM1sxMDVdO2Zvcih2YXIgQT1bXSxjPVtdLGI9W10saT1bXSx3PVtdLHQ9W10sST1bXSxFPVtdLGc9W10sbz1bXSxuPWFbXzB4NDJmM1sxMDldXSx2PW4lMTAsUT1uLXYsaz1fMHg0MmYzWzExMF0sQz1fMHg0MmYzWzExMF0sdT0wO24+dTsrK3Upe3ZhciBsPWFbXzB4NDJmM1sxMTFdXSh1KTtpZihzW2xdJiYobD1zW2xdKSx2PnUpays9bDtlbHNlIHN3aXRjaCgodS12KSUxMCl7Y2FzZSAwOmNbXzB4NDJmM1sxMTJdXShsKTticmVhaztjYXNlIDE6SVtfMHg0MmYzWzExMl1dKGwpO2JyZWFrO2Nhc2UgMjp0W18weDQyZjNbMTEyXV0obCk7YnJlYWs7Y2FzZSAzOmdbXzB4NDJmM1sxMTJdXShsKTticmVhaztjYXNlIDQ6RVtfMHg0MmYzWzExMl1dKGwpO2JyZWFrO2Nhc2UgNTppW18weDQyZjNbMTEyXV0obCk7YnJlYWs7Y2FzZSA2Om9bXzB4NDJmM1sxMTJdXShsKTticmVhaztjYXNlIDc6QVtfMHg0MmYzWzExMl1dKGwpO2JyZWFrO2Nhc2UgODp3W18weDQyZjNbMTEyXV0obCk7YnJlYWs7Y2FzZSA5OmJbXzB4NDJmM1sxMTJdXShsKX19Zm9yKHZhciBCPTA7UT5COysrQilzd2l0Y2goQiUxMCl7Y2FzZSAwOkMrPUFbXzB4NDJmM1sxMTNdXSgpO2JyZWFrO2Nhc2UgMTpDKz1jW18weDQyZjNbMTEzXV0oKTticmVhaztjYXNlIDI6Qys9YltfMHg0MmYzWzExM11dKCk7YnJlYWs7Y2FzZSAzOkMrPWlbXzB4NDJmM1sxMTNdXSgpO2JyZWFrO2Nhc2UgNDpDKz13W18weDQyZjNbMTEzXV0oKTticmVhaztjYXNlIDU6Qys9dFtfMHg0MmYzWzExM11dKCk7YnJlYWs7Y2FzZSA2OkMrPUlbXzB4NDJmM1sxMTNdXSgpO2JyZWFrO2Nhc2UgNzpDKz1FW18weDQyZjNbMTEzXV0oKTticmVhaztjYXNlIDg6Qys9Z1tfMHg0MmYzWzExM11dKCk7YnJlYWs7Y2FzZSA5OkMrPW9bXzB4NDJmM1sxMTNdXSgpfUMrPWs7Zm9yKHZhciBEPV8weDQyZjNbMTEwXSxHPTA7bj5HO0crKyl7dmFyIFk9Q1tfMHg0MmYzWzExMV1dKEcpO2lmKFk9PT1TdHJpbmdbXzB4NDJmM1s2MV1dKDkyKSYmbi0xMT5HKXt2YXIgTT1DW18weDQyZjNbMzZdXShHLDEyKSxtPS9eXHVbMC05YS1mQS1GXXs0fVx1WzAtOWEtZkEtRl17NH0kLztpZihtW18weDQyZjNbMzJdXShNKSl7dmFyIFY9cGFyc2VJbnQoTVtfMHg0MmYzWzM2XV0oMiw0KSwxNikseT1wYXJzZUludChNW18weDQyZjNbMzZdXSg4KSwxNik7RCs9U3RyaW5nW18weDQyZjNbNjFdXShWLHkpLEcrPTExfWVsc2UgRCs9WX1lbHNlIEQrPVl9cmV0dXJuIER9XVtfMHg0MmYzWzZdXShmW18weDQyZjNbNV1dW18weDQyZjNbNF1dKX07cmV0dXJuIGYoZSlbXzB4NDJmM1sxMThdXShmdW5jdGlvbihmKXtyZXR1cm4gRltfMHg0MmYzWzExNl1dKGYpLGY9PT1GW18weDQyZjNbMzNdXT9fW18weDQyZjNbMTE0XV0oRltfMHg0MmYzWzMzXV0pOnZvaWQgX1tfMHg0MmYzWzExN11dKGYpfSlbXzB4NDJmM1sxMTVdXShmdW5jdGlvbihmKXtfW18weDQyZjNbMTE0XV0oZil9KSxfW18weDQyZjNbMTE5XV19Ow=="))
}(window), F.FileWorkspaceService = function (e, t, i, n) {
    F.WorkspaceService.call(this, e, t, i, n), this._workspacePromise = void 0;
    var r = this;
    t.subscribe("change", function () {
        r._workspacePromise = void 0
    })
}, F.FileWorkspaceService.prototype = {
    loadAncestors: function () {
        var e = this;
        return this.getWorkspace().then(function (t) {
            return e.listToAncestorMap(t._preOrder)
        })
    },
    getAll: function (e) {
        return this.getWorkspace().then(function (t) {
            return t[e] || []
        })
    },
    inquireGlobalFolder: function (e) {
        return this.getWorkspace().then(function (t) {
            var i = t.Workspace[0];
            t.Transformation = t.Transformation || [];
            var n = F.findFirst(t.Transformation, function (t) {
                return t.ParentUUID === i.UUID && t.Name === e
            });
            if (n) return n;
            var r = {
                Children: [],
                Class: "Transformation",
                CreatedBy: "",
                DisplayName: e,
                ExportVersion: 1,
                Name: e,
                ParentUUID: i.UUID,
                TransformationLocal: mat4.identity(new Array(16)),
                TransformationGlobal: F.cloneArray(i.TransformationGlobal),
                UUID: F.generateUUID()
            };
            return t.Transformation.push(r), r
        })
    },
    getWorkspace: function () {
        var e = this;
        if (!this._workspacePromise) {
            var t = Q.defer();
            this._workspacePromise = t.promise;
            var i = this._project.getCurrent();
            lWks(this._http, i, t).then(function (i) {
                var n = {},
                    r = [],
                    o = {},
                    a = {};
                e.parseWorkspace(i, n, r, o, a), n._preOrder = r, n._categories = [];
                for (var s in o) o.hasOwnProperty(s) && n._categories.push({
                    Category: s,
                    Amount: o[s]
                });
                n._tags = [];
                for (var c in a) a.hasOwnProperty(c) && n._tags.push({
                    Tag: c,
                    Amount: a[c]
                });
                delete n.Orthophoto, t.resolve(n)
            }, function (e) {
                t.reject(e)
            })
        }
        return this._workspacePromise
    },
    parseWorkspace: function (e, t, i, n, r) {
        var o = this;
        i.push({
            Class: e.Class,
            UUID: e.UUID,
            ParentUUID: e.ParentUUID
        }), e.Children && e.Children.forEach(function (e) {
            o.parseWorkspace(e, t, i, n, r)
        }), e.Children = [];
        var a = e.Class;
        t[a] || (t[a] = []);
        var s = e.Category || "";
        n[s] = (n[s] || 0) + 1, e.Tags && e.Tags.forEach(function (e) {
            r[e] = (r[e] || 0) + 1
        }), t[a].push(e)
    }
}, F.extend("FileWorkspaceService", "WorkspaceService"), F.DI().redefineService("workspace", F.FileWorkspaceService, "@error", "@project", "@plug", "$http"), WS.LocalUserSettingsService = function (e, t, i, n) {
    F.PlugModule.call(this, e), this._cookie = t, this._locale = i, this._unit = n, this._cookieId = "usersettings", this._settings = void 0, this.getFromLocalStorage(), void 0 !== this._settings && (this._locale.updateLanguageBySettings(this._settings), this._unit.updateUnitsBySettings(this._settings))
}, WS.LocalUserSettingsService.prototype = {
    update: function (e, t, i, n, r) {
        (e || t || i || n || r) && (this._settings || (this._settings = {}), e && (this._settings.Language = e), t && (this._settings.Units = t), i && (this._settings.Areaunit = i), n && (this._settings.AngleUnit = n), r && (this._settings.CoordSystem = r), this.writeToLocalStorage(), this._locale.updateLanguageBySettings(this._settings), this._unit.updateUnitsBySettings(this._settings))
    },
    writeToLocalStorage: function () {
        void 0 !== this._settings && this._cookie.setLocalStorageItem(this._cookieId, JSON.stringify(this._settings))
    },
    getFromLocalStorage: function () {
        var e = JSON.parse(this._cookie.getLocalStorageItem(this._cookieId));
        e && (this._settings = e)
    }
}, WS.extend("LocalUserSettingsService", "PlugModule"), F.DI().registerService("localusersettings", WS.LocalUserSettingsService, "@plug", "@cookie", "@locale", "@unit"), WS.LocalDistanceService = function (e) {
    this._scan = e
}, WS.LocalDistanceService.prototype = {
    get: function (e, t, i, n, r) {
        var o = this;
        return this._scan.getByID(t).then(function (t) {
            return o.getDistanceInfo(e, t, [i, n], r)
        })
    },
    getDistanceInfo: function (e, t, i, n) {
        return this.getDistanceInfos(e, t, [i], n).then(function (e) {
            return e[0]
        })
    },
    getDistanceInfos: function (e, t, i, n) {
        var r = this,
            o = this.determineSize(t, n),
            a = this.wrappedAngles(i, o),
            s = this.determineOffsetArraysByAngles(a, o);
        return this.readDistanceFile(t, s, o).then(function (e) {
            return r.constructDistanceInfos(t, e, a)
        })
    },
    determineSize: function (e, t) {
        var i = e._distanceImageWidths,
            n = i[0];
        return -1 !== t && -1 !== i.indexOf(t) && (n = t), [n, n / 2]
    },
    wrappedAngles: function (e, t) {
        return e.map(function (e) {
            var i = F.wrapTo_0_2PI(e[0]),
                n = F.wrapTo_Minus05PI_05PI(e[1]),
                r = F.colRowOfAngle(i, n, t),
                o = (r[0] + .5) * (2 * Math.PI / t[0]),
                a = Math.PI / 2 - (r[1] + .5) * Math.PI / t[1];
            return [o, a]
        })
    },
    determineOffsetArraysByAngles: function (e, t) {
        var i = this;
        return e.map(function (e) {
            var n = F.colRowOfAngle(e[0], e[1], t),
                r = F.ordered5x5NeighborhoodInWrappedImage(n[0], n[1], t[0], t[1]);
            return i.offsetsOfPoints(r, t)
        })
    },
    offsetsOfPoints: function (e, t) {
        return e.map(function (e) {
            return e[0] + e[1] * t[0]
        })
    },
    readDistanceFile: function (e, t, i) {
        return e._service.loadDistanceImage(e, i[0]).then(function (e) {
            return t.map(function (t) {
                for (var i = 0; i < t.length; i++) {
                    var n = e[t[i]];
                    if (n > 0) return n
                }
                return 0
            })
        })
    },
    constructDistanceInfos: function (e, t, i) {
        return t.map(function (t, n) {
            var r = 0 >= t ? WS.LocalDistanceService.DEFAULT_DISTANCE : t,
                o = vec3.fromPolar(r, i[n][0], i[n][1]),
                a = vec3.create();
            return mat4.multiplyVec3(e._trafoGlobal, o, a), {
                Class: "DistanceInfo",
                Version: 1,
                PointState: 0 >= t ? 1 : 0,
                Distance: r,
                PositionLocal: o,
                PositionGlobal: a
            }
        })
    }
}, WS.extend("LocalDistanceService"), WS.LocalDistanceService.DEFAULT_DISTANCE = 10, WS.LocalTempMeasurementService = function (e, t, i, n, r, o, a, s, c, l, h, d) {
    WS.TempMeasurementService.call(this, e, t, i, n, r, o, a, s, c, l), this._scan = h, this._transformation = d
}, WS.LocalTempMeasurementService.prototype = {
    create: function (e) {
        var t = WS.Measurement.Type;
        if (WS._2GO) {
            var i = this;
            e._displayType = e._displayType || WS.Measurement.DisplayType.Distance;
            var n;
            return e._type === t.ScanPoint ? n = this._scan.getByID(e._parentUUID) : e._type === t.MultiScanPoint || e._type === t.SpacePoint ? n = this._transformation.inquireGlobalFolder("Measurements") : e._type === t.Map && (n = this._mapObject.getAll().then(function (e) {
                return e[0]
            })), n.then(function (t) {
                return e._parentUUID = t._UUID, e._displayName = e._displayName || e._name, !e._pointsLocal && e._pointsGlobal && (e._pointsLocal = e._pointsGlobal.map(function (e) {
                    var i = mat4.identity();
                    mat4.setTranslation(i, e);
                    var n = mat4.create(t._trafoGlobal);
                    return mat4.inverse(n), mat4.multiply(n, i), mat4.getTranslation(n)
                })), i.updateFromPointsLocal(e, t), e._category = "", e._children = [], e._createdBy = "", e._exportVersion = 5, e._readGroups = [], e._readPublic = !1, e._revision = 0, e._tags = [], e._UUID = e._UUID || F.generateUUID(), e._writeGroups = [], e._writePublic = !1, i._workspace.addCustomAttributes([e]).then(function () {
                    i._entities.push(e), i.trigger("addObjects", [
                        [e]
                    ])
                })
            })
        }
        return WS.TempMeasurementService.prototype.create.apply(this, arguments)
    },
    updateFromPointsLocal: function (e, t) {
        var i = e._pointsLocal,
            n = i.length,
            r = i[0],
            o = i[n - 1];
        e._pointsGlobal = i.map(function (e) {
            var i = vec3.create();
            return mat4.multiplyVec3(t._trafoGlobal, e, i), i
        }), e._trafoLocal = mat4.identity(), mat4.setTranslation(e._trafoLocal, r), e._trafoGlobal = mat4.create(), mat4.multiply(t._trafoGlobal, e._trafoLocal, e._trafoGlobal), e._axisPointLocal = this.getAxisPoint(i), e._axisPointGlobal = this.getAxisPoint(e._pointsGlobal), e._distance = 0, e._distances = [];
        for (var a = 0; n - 1 > a; a++) {
            var s = vec3.dist(i[a + 1], i[a]);
            e._distance += s, e._distances.push(s)
        }
        e._distanceStartEnd = vec3.dist(r, o), e._distanceXLocal = Math.abs(o[0] - r[0]), e._distanceYLocal = Math.abs(o[1] - r[1]), e._distanceHorizontalLocal = vec3.dist([r[0], r[1], 0], [o[0], o[1], 0]), e._distanceVerticalLocal = Math.abs(o[2] - r[2]);
        var c = e._pointsGlobal[0],
            l = e._pointsGlobal[n - 1];
        e._distanceXGlobal = Math.abs(l[0] - c[0]), e._distanceYGlobal = Math.abs(l[1] - c[1]), e._distanceHorizontalGlobal = vec3.dist([c[0], c[1], 0], [l[0], l[1], 0]), e._distanceVerticalGlobal = Math.abs(l[2] - c[2]);
        var h = WS.Measurement.Type;
        e._type === h.ScanPoint || e._type === h.MultiScanPoint ? e._segmentStates = this.determineSegmentStates(e._pointStates) : e._type === h.Map && (e._area = F.calcArea2D(i), e._centroidLocal = F.calcCentroid3D(i), e._centroidGlobal = mat4.multiplyVec3(t._trafoGlobal, e._centroidLocal, vec3.create()), e._areaValid = this.isAreaMeasurementValid(i))
    },
    getAxisPoint: function (e) {
        if (0 === e.length) return [0, 0, 0];
        if (1 === e.length) return F.cloneArray(e[0]);
        var t = e[e.length - 1];
        return [t[0], t[1], e[0][2]]
    },
    determineSegmentStates: function (e) {
        for (var t = [], i = 0; i < e.length - 1; i++) t.push(this.determineSegmentState(e[i], e[i + 1]));
        return t
    },
    determineSegmentState: function (e, t) {
        var i = WS.Measurement.SegmentState;
        return e === i.INVALID || t === i.INVALID ? i.INVALID : e === i.UNLOADED || t === i.UNLOADED ? i.UNLOADED : i.VALID
    },
    isAreaMeasurementValid: function (e) {
        var t = e.length;
        if (4 > t || !vec3.equal(e[0], e[t - 1])) return !1;
        for (var i = 0; t - 2 > i; ++i)
            for (var n = e[i], r = e[i + 1], o = i + 1; t - 1 > o; ++o) {
                var a = e[o],
                    s = e[o + 1];
                if (F.doSegmentsIntersect2D(n, r, a, s)) return !1
            }
        return !0
    }
}, WS.extend("LocalTempMeasurementService", "TempMeasurementService"), F.DI().redefineService("distance", WS.LocalDistanceService, "@scan"), F.DI().redefineService("tempmeasurement", WS.LocalTempMeasurementService, "@serializer", "@error", "@project", "@selection", "@plug", "@login", "@revision", "?@workspace", "@mapobject", "$resource", "@scan", "@transformation"), angular.module("ws", ["ngResource", "ngSanitize", "angularRangeSlider", "ang-drag-drop", "f.component", "f.component.radialmenu", "f.filter", "f.widget", "f.util", "f.unit", "f.task", "f.alert", "f.user", "ws.component.radialmenu", "ws.filter", "ws.widget", "ws.annotation", "ws.scanlist", "ws.map", "ws.panoramaview", "ws.headerbar", "ws.footerbar", "ws.component", "ws.page", "ws.component.imagegallery"].concat(WS._2GO ? [] : ["ws.entity", "ws.admin", "ws.dashboard"])).config(["$sceDelegateProvider", function (e) {
    e.resourceUrlWhitelist(["self", "http://*.cloudfront.net/**", "https://*.cloudfront.net/**"])
}]).config(["$locationProvider", function (e) {
    e.html5Mode(!0)
}]).run(["$location", function (e) {
    var t = e.search();
    if (e.absUrl().match("/user/newpassword/")) t.sptoken && e.search({
        v: "rp",
        rp: t.sptoken
    }).replace();
    else if (e.absUrl().match("/user/accountvalidation/")) t.sptoken && e.search({
        v: "av",
        av: t.sptoken
    }).replace();
    else if (t.project && t.x && t.y && t.z) {
        var i = "x:" + t.x + ",y:" + t.y + ",z:" + t.z;
        e.search({
            v: "pv",
            t: "p:default,c:panoramaview,m:f",
            pv: "pv1",
            pv1: i,
            p: t.project
        }).replace()
    } else if (t.project && t.map) {
        var n;
        t.x && t.y ? (n = "x:" + t.x + ",y:" + t.y, t.zoom && (n += ",zoom:" + t.zoom)) : n = "auto:t", e.search({
            v: "om",
            t: "p:default,c:overviewmap,m:f",
            om: "om1",
            om1: n,
            p: t.project
        }).replace()
    } else t.project && e.search({
        v: "pd",
        t: "p:default,c:projectselector,m:f",
        pd: "pd1",
        pd1: "",
        p: t.project
    }).replace()
}]).run(["$http", "$resource", "$filter", "$location", "$rootScope", "$window", "$sanitize", function (e, t, i, n, r, o, a) {
    var s = F.DI();
    s.registerAuxiliary("$resource", function () {
        return t
    }), s.registerAuxiliary("$http", function () {
        return e
    }), s.registerAuxiliary("$location", function () {
        return n
    }), s.registerAuxiliary("$filter", function () {
        return i
    }), s.registerAuxiliary("$rootScope", function () {
        return r
    }), s.registerAuxiliary("$window", function () {
        return o
    }), s.registerAuxiliary("$sanitize", function () {
        return a
    }), s.registerAuxiliary("$localStorage", function () {
        var e;
        try {
            e = window.localStorage
        } catch (t) {
        }
        return e || (e = {
            getItem: function () {
                return null
            },
            setItem: function () {
            },
            removeItem: function () {
            },
            clear: function () {
            }
        }), e
    });
    var c = F.isSmallScreen() ? "f" : "t";
    s.registerParameter("defaultURL", "v=ps&t=p:default,c:projectselector,m:" + c + "&ps=ps1&ps1="), s.registerParameter("URLroots", ["v", "t"]), s.registerParameter("signedProjectRoute", "/data/signedurl/"), s.registerService("projectdatacdn", F.SignedURLService, "$http", "@error", "%signedProjectRoute%"), s.registerParameter("linkRepository", "http://farosoftwareupdate.websharecloud.com/links/ws/"), s.registerParameter("previewGuide", "preview-guide.html"), s.registerParameter("devSupportMail", "WebShareCloud@faro.com"), WS._2GO && s.registerParameter("linkifyDocsRoot", "ws2go-data/documents/"), F.DI().init()
}]);
